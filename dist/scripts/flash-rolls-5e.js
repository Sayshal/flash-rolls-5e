var vo=Object.defineProperty;var Ss=h=>{throw TypeError(h)};var Co=(h,e,t)=>e in h?vo(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var E=(h,e,t)=>Co(h,typeof e!="symbol"?e+"":e,t),Xt=(h,e,t)=>e.has(h)||Ss("Cannot "+t);var j=(h,e,t)=>(Xt(h,e,"read from private field"),t?t.call(h):e.get(h)),fe=(h,e,t)=>e.has(h)?Ss("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(h):e.set(h,t),De=(h,e,t,s)=>(Xt(h,e,"write to private field"),s?s.call(h,t):e.set(h,t),t),X=(h,e,t)=>(Xt(h,e,"access private method"),t);let Qt;const wo=new RegExp(`([^.[]+|\\[('([^'\\\\]|\\\\.)+?'|"([^"\\\\]|\\\\.)+?")\\])`,"g"),Do=new RegExp(`(^\\['|'\\]$|^\\["|"\\]$)`,"g");Hooks.once("init",()=>{if(globalThis.libWrapper){Qt=globalThis.libWrapper;return}Qt=class{static get is_fallback(){return!0}static get WRAPPER(){return"WRAPPER"}static get MIXED(){return"MIXED"}static get OVERRIDE(){return"OVERRIDE"}static register(h,e,t,s="MIXED",{chain:o=void 0,bind:a=[]}={}){var S;const i=e.endsWith("#set");e=i?e.slice(0,-4):e;const n=e.match(wo).map(y=>y.replace(/\\(.)/g,"$1").replace(Do,"")),r=n.splice(0,1)[0],l=n.pop();n.join(".");let d,u;if(n.length==0)d=globalThis,u=r;else{const y=eval;u=l,d=n.reduce((R,A)=>R[A],globalThis[r]??y(r))}let f=d,g=null;for(;f&&(g=Object.getOwnPropertyDescriptor(f,u),!g);)f=Object.getPrototypeOf(f);if(!g||(g==null?void 0:g.configurable)===!1)throw new Error(`libWrapper Shim: '${e}' does not exist, could not be found, or has a non-configurable descriptor.`);let m=null;const p=o??(((S=s.toUpperCase)==null?void 0:S.call(s))!="OVERRIDE"&&s!=3)?function(...y){return t.call(this,m.bind(this),...a,...y)}:function(...y){return t.call(this,...a,...y)};if(!i)g.value?(m=g.value,g.value=p):(m=g.get,g.get=p);else{if(!g.set)throw new Error(`libWrapper Shim: '${e}' does not have a setter`);m=g.set,g.set=p}g.configurable=!0,Object.defineProperty(d,u,g)}},globalThis.libWrapper=Qt});const Rs={MODULE_ACTIONS:"moduleActions",ACTOR_ACTIONS:"actorActions"},Ns={"lock-menu":{id:"lock-menu",icon:"fa-lock-keyhole",labelKey:"FLASH_ROLLS.ui.inputs.lockMenu",tooltipKey:"FLASH_ROLLS.ui.inputs.lockMenu",element:"flash5e-actors-lock",type:"button"},"toggle-requests":{id:"toggle-requests",icon:"fa-bolt",labelKey:"FLASH_ROLLS.ui.inputs.toggleRollRequests",tooltipKey:"FLASH_ROLLS.ui.inputs.toggleRollRequests",element:"flash-rolls-toggle",type:"checkbox"},"skip-dialogs":{id:"skip-dialogs",icon:"fa-square-question",labelKey:"FLASH_ROLLS.ui.inputs.skipRollDialog",tooltipKey:"FLASH_ROLLS.ui.inputs.skipRollDialog",element:"flash5e-skip-dialogs",type:"checkbox"},"group-rolls":{id:"group-rolls",icon:"fa-users-rectangle",labelKey:"FLASH_ROLLS.ui.inputs.groupRollsMsg",tooltipKey:"FLASH_ROLLS.ui.inputs.groupRollsMsg",element:"flash5e-group-rolls-msg",type:"checkbox"},"show-options":{id:"show-options",icon:"fa-bars-sort",labelKey:"FLASH_ROLLS.ui.inputs.showOptionsListOnHover",tooltipKey:"FLASH_ROLLS.ui.inputs.showOptionsListOnHover",element:"flash5e-toggle-list",type:"checkbox"},"open-settings":{id:"open-settings",icon:"fa-cog",labelKey:"FLASH_ROLLS.ui.inputs.openSettings",tooltipKey:"FLASH_ROLLS.ui.inputs.openSettings",element:"flash5e-open-settings",type:"button"},"premium-features":{id:"premium-features",icon:"fa-gem",labelKey:"FLASH_ROLLS.ui.inputs.premiumFeatures",tooltipKey:"FLASH_ROLLS.ui.inputs.premiumFeatures",element:"flash5e-premium-features",type:"button"}},Gs={"select-all":{id:"select-all",icon:"fa-object-group",labelKey:"FLASH_ROLLS.ui.inputs.selectAll",tooltipKey:"FLASH_ROLLS.ui.inputs.selectAll",element:"flash5e-actors-all",type:"checkbox",cssClass:"bulk-action"},"filter-actors":{id:"filter-actors",icon:"fa-filter-list",labelKey:"FLASH_ROLLS.ui.inputs.filterActors",tooltipKey:"FLASH_ROLLS.ui.inputs.filterActors",element:"flash5e-filter-actors",type:"button",cssClass:"bulk-action"},"toggle-targets":{id:"toggle-targets",icon:"fa-crosshairs",labelKey:"FLASH_ROLLS.ui.inputs.toggleTargets",tooltipKey:"FLASH_ROLLS.ui.inputs.toggleTargets",element:"flash5e-targets",type:"button",cssClass:"bulk-action"},"place-tokens":{id:"place-tokens",icon:"fa-location-dot",labelKey:"FLASH_ROLLS.ui.inputs.placeTokens",tooltipKey:"FLASH_ROLLS.ui.inputs.placeTokens",element:"flash5e-place-tokens",type:"button",cssClass:"bulk-action"},"teleport-tokens":{id:"teleport-tokens",icon:"fa-person-to-portal",labelKey:"FLASH_ROLLS.ui.inputs.teleportTokens",tooltipKey:"FLASH_ROLLS.ui.inputs.teleportTokens",element:"flash5e-teleport-tokens",type:"button",cssClass:"bulk-action"},"heal-all":{id:"heal-all",icon:"fa-heart-pulse",labelKey:"FLASH_ROLLS.ui.inputs.healAll",tooltipKey:"FLASH_ROLLS.ui.inputs.healAll",element:"flash5e-heal-selected",type:"button",cssClass:"bulk-action"},"kill-all":{id:"kill-all",icon:"fa-skull",labelKey:"FLASH_ROLLS.ui.inputs.killAll",tooltipKey:"FLASH_ROLLS.ui.inputs.killAll",element:"flash5e-kill-selected",type:"button",cssClass:"bulk-action"},"remove-status":{id:"remove-status",icon:"fa-sparkles",labelKey:"FLASH_ROLLS.ui.inputs.removeStatus",tooltipKey:"FLASH_ROLLS.ui.inputs.removeStatus",element:"flash5e-remove-effects",type:"button",cssClass:"bulk-action"},"open-sheets":{id:"open-sheets",icon:"fa-square-user",labelKey:"FLASH_ROLLS.ui.inputs.openSheets",tooltipKey:"FLASH_ROLLS.ui.inputs.openSheets",element:"flash5e-sheets",type:"button",cssClass:"bulk-action"},"group-selected":{id:"group-selected",icon:"fa-users-medical",labelKey:"FLASH_ROLLS.ui.inputs.groupSelected",tooltipKey:"FLASH_ROLLS.ui.inputs.groupSelected",element:"flash5e-group-selected",type:"button",cssClass:"bulk-action"},movement:{id:"movement",icon:"fa-person-walking",labelKey:"FLASH_ROLLS.ui.inputs.toggleMovement",tooltipKey:"FLASH_ROLLS.ui.inputs.toggleMovement",element:"flash5e-lock-movement",type:"button",cssClass:"bulk-action"},"contested-roll":{id:"contested-roll",icon:"fa-swords",labelKey:"FLASH_ROLLS.ui.inputs.contestedRoll",tooltipKey:"FLASH_ROLLS.ui.inputs.contestedRoll",element:"flash5e-contested-roll",type:"button",cssClass:"bulk-action"},transform:{id:"transform",icon:"fa-frog",labelKey:"FLASH_ROLLS.ui.inputs.transform",tooltipKey:"FLASH_ROLLS.ui.inputs.transform",element:"flash5e-transform",type:"button",cssClass:"bulk-action"}};function Io(h){switch(h){case Rs.MODULE_ACTIONS:return Ns;case Rs.ACTOR_ACTIONS:return Gs;default:return{}}}function xt(h,e){return Io(e)[h]||null}function $t(){return{moduleActions:[{id:"lock-menu",icon:"fa-lock-keyhole",enabled:!0,order:0},{id:"toggle-requests",icon:"fa-bolt",enabled:!0,order:1},{id:"skip-dialogs",icon:"fa-square-question",enabled:!0,order:2},{id:"group-rolls",icon:"fa-users-rectangle",enabled:!0,order:3},{id:"show-options",icon:"fa-bars-sort",enabled:!0,order:4},{id:"open-settings",icon:"fa-cog",enabled:!0,order:5},{id:"premium-features",icon:"fa-gem",enabled:!0,order:6}],actorActions:[{id:"filter-actors",icon:"fa-filter-list",enabled:!0,order:0},{id:"select-all",icon:"fa-object-group",enabled:!0,order:1},{id:"toggle-targets",icon:"fa-crosshairs",enabled:!0,order:2},{id:"remove-status",icon:"fa-sparkles",enabled:!0,order:3},{id:"teleport-tokens",icon:"fa-person-to-portal",enabled:!0,order:4},{id:"transform",icon:"fa-frog",enabled:!0,order:5},{id:"place-tokens",icon:"fa-location-dot",enabled:!0,order:6},{id:"contested-roll",icon:"fa-swords",enabled:!0,order:7},{id:"group-selected",icon:"fa-users-medical",enabled:!0,order:8},{id:"movement",icon:"fa-person-walking",enabled:!0,order:9},{id:"heal-all",icon:"fa-heart-pulse",enabled:!0,order:10},{id:"kill-all",icon:"fa-skull",enabled:!0,order:11},{id:"open-sheets",icon:"fa-square-user",enabled:!0,order:12}]}}const K={select:"select",checkbox:"checkbox"},G={client:"client",world:"world"},bs=$t(),I=()=>({generalSettings:{tag:"flash5e-general-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["skipRollDialog","skipRollDialogOption","skipToRollResolver","showOnlyPCsWithToken","addMacrosToFolder","templateAutoTarget","removeTemplate","tooltipAutoDismiss","templateRemovalTimeout","tokenMovementSpeed","autoBlockMovementInCombat","disableNotifications"],default:{skipRollDialog:!1,skipRollDialogOption:1,skipToRollResolver:!1,showOnlyPCsWithToken:!0,addMacrosToFolder:!0,templateAutoTarget:1,removeTemplate:!0,tooltipAutoDismiss:2,tokenMovementSpeed:6,templateRemovalTimeout:5,autoBlockMovementInCombat:!1,disableNotifications:!1},scope:G.world,config:!1,requiresReload:!1},interfaceSettings:{tag:"flash5e-interface-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["showMenuOnLoad","showTokenVisionOnHover","compactMode","actorStatsToShow","menuLayout","menuIconsLayout","maxIconsPerRow","teleportAnimationPath","lockMenuPosition"],default:{showMenuOnLoad:!0,showTokenVisionOnHover:!0,compactMode:!0,actorStatsToShow:{hp:!0,ac:!0,dc:!0,prc:!0},menuLayout:"vertical",menuIconsLayout:bs,maxIconsPerRow:5,teleportAnimationPath:"",lockMenuPosition:!1},scope:G.world,config:!1,requiresReload:!1},groupRollsSettings:{tag:"flash5e-group-rolls-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["groupRollsMsgEnabled","groupRollResultMode","groupCalculationForSaves","showGroupDCToPlayers","showGroupResultToPlayers","groupRollNPCHidden","concealNPCNames","interceptTidySheetsGroupRolls","autoSelectOnGroupRoll"],default:{groupRollsMsgEnabled:!0,groupRollResultMode:1,groupCalculationForSaves:!1,showGroupDCToPlayers:!1,showGroupResultToPlayers:!0,groupRollNPCHidden:!0,concealNPCNames:!1,interceptTidySheetsGroupRolls:!0,autoSelectOnGroupRoll:0},scope:G.world,config:!1,requiresReload:!1},rollRequestsSettings:{tag:"flash5e-roll-request-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["rollInterceptionEnabled","showRequestPrompt","useGMTargetTokens","consumptionConfigMode","placeTemplateForPlayer","showOfflineNotifications","initiateCombatOnRequest","publicPlayerRolls","useCondensedRollMessage","removeSaveMsgAfterRoll"],default:{rollInterceptionEnabled:!0,showRequestPrompt:!0,useGMTargetTokens:!0,consumptionConfigMode:2,placeTemplateForPlayer:!1,showOfflineNotifications:!0,initiateCombatOnRequest:!0,publicPlayerRolls:!1,useCondensedRollMessage:!1,removeSaveMsgAfterRoll:!1},scope:G.world,config:!1,requiresReload:!1},integrationSettings:{tag:"flash5e-integration-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["ddbRollOwnership","ddbNoAutoConsumeSpellSlot","ddbImportSourcePriority","ddbImportSpellMode"],default:{ddbRollOwnership:0,ddbNoAutoConsumeSpellSlot:!1,ddbImportSourcePriority:0,ddbImportSpellMode:0},scope:G.world,config:!1,requiresReload:!1},showGroupDCToPlayers:{tag:"show-group-dc-to-players",label:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},showGroupResultToPlayers:{tag:"show-group-result-to-players",label:game.i18n.localize("FLASH_ROLLS.settings.showGroupResultToPlayers.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showGroupResultToPlayers.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},groupRollNPCHidden:{tag:"group-roll-npc-hidden",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollNPCHidden.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollNPCHidden.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},concealNPCNames:{tag:"conceal-npc-names",label:game.i18n.localize("FLASH_ROLLS.settings.concealNPCNames.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.concealNPCNames.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},interceptTidySheetsGroupRolls:{tag:"intercept-tidy-sheets-group-rolls",label:game.i18n.localize("FLASH_ROLLS.settings.interceptTidySheetsGroupRolls.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.interceptTidySheetsGroupRolls.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},autoSelectOnGroupRoll:{tag:"auto-select-on-group-roll",label:game.i18n.localize("FLASH_ROLLS.settings.autoSelectOnGroupRoll.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.autoSelectOnGroupRoll.hint"),propType:Number,inputType:K.select,choices:{0:game.i18n.localize("FLASH_ROLLS.settings.autoSelectOnGroupRoll.choices.0"),1:game.i18n.localize("FLASH_ROLLS.settings.autoSelectOnGroupRoll.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.autoSelectOnGroupRoll.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.autoSelectOnGroupRoll.choices.3")},default:0,scope:G.world,config:!1},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!0},groupRollsMsgEnabled:{tag:"group-roll-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},groupRollResultMode:{tag:"group-roll-result-mode",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.hint"),propType:Number,inputType:K.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.4")},default:1,scope:G.world,config:!1},groupCalculationForSaves:{tag:"group-calculation-for-saves",label:game.i18n.localize("FLASH_ROLLS.settings.groupCalculationForSaves.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupCalculationForSaves.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},consumptionConfigMode:{tag:"consumption-config",label:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.hint"),propType:Number,inputType:K.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.4")},default:2,scope:G.world,config:!1},placeTemplateForPlayer:{tag:"place-template-for-player",label:game.i18n.localize("FLASH_ROLLS.settings.placeTemplateForPlayer.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.placeTemplateForPlayer.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},skipRollDialog:{tag:"skip-roll-dialog",label:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},skipRollDialogOption:{tag:"skip-roll-dialog-options",label:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.hint"),propType:Number,inputType:K.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.choices.3")},default:1,scope:G.world,config:!1},skipToRollResolver:{tag:"skip-to-roll-resolver",label:game.i18n.localize("FLASH_ROLLS.settings.skipToRollResolver.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipToRollResolver.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},rollInterceptionEnabled:{tag:"roll-interception-on",label:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},showRequestPrompt:{tag:"show-request-prompt",label:game.i18n.localize("FLASH_ROLLS.settings.showRequestPrompt.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showRequestPrompt.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},publicPlayerRolls:{tag:"public-player-roll-messages",label:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},showRequestNotifications:{tag:"show-request-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},initiateCombatOnRequest:{tag:"initiate-combat-on-request",label:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},useCondensedRollMessage:{tag:"use-condensed-roll-message",label:game.i18n.localize("FLASH_ROLLS.settings.useCondensedRollMessage.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.useCondensedRollMessage.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},removeSaveMsgAfterRoll:{tag:"remove-save-msg-after-roll",label:game.i18n.localize("FLASH_ROLLS.settings.removeSaveMsgAfterRoll.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.removeSaveMsgAfterRoll.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},showOnlyPCsWithToken:{tag:"show-only-pcs-with-token",label:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},compactMode:{tag:"compact-mode",label:game.i18n.localize("FLASH_ROLLS.settings.compactMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.compactMode.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},actorStatsToShow:{tag:"actor-stats-to-show",label:game.i18n.localize("FLASH_ROLLS.settings.actorStatsToShow.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.actorStatsToShow.hint"),propType:Object,default:{hp:!0,ac:!0,dc:!0,prc:!0},scope:G.world,config:!1},menuLayout:{tag:"menu-layout",label:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.hint"),propType:String,inputType:K.select,choices:{vertical:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.choices.vertical"),horizontal:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.choices.horizontal")},default:"vertical",scope:G.world,config:!1},lockMenuPosition:{tag:"lock-menu-position",label:game.i18n.localize("FLASH_ROLLS.settings.lockMenuPosition.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.lockMenuPosition.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},maxIconsPerRow:{tag:"max-icons-per-row",label:game.i18n.localize("FLASH_ROLLS.settings.maxIconsPerRow.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.maxIconsPerRow.hint"),propType:Number,default:5,scope:G.world,config:!1},showOptionsListOnHover:{tag:"show-list-on-hover",label:game.i18n.localize("FLASH_ROLLS.settings.showOptionsListOnHover.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOptionsListOnHover.hint"),propType:Boolean,default:!0,scope:G.world,config:!1},templateAutoTarget:{tag:"template-auto-target",label:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.hint"),propType:Number,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.all.label"),2:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.notFriendly.label"),3:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.none.label")},inputType:K.select,default:1,scope:G.world,config:!1},removeTemplate:{tag:"remove-template",label:game.i18n.localize("FLASH_ROLLS.settings.removeTemplate.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.removeTemplate.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},templateRemovalTimeout:{tag:"template-removal-timeout",label:game.i18n.localize("FLASH_ROLLS.settings.templateRemovalTimeout.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.templateRemovalTimeout.hint"),propType:Number,default:5,scope:G.world,config:!1,range:{min:0,max:30,step:1}},debugMode:{tag:"debug-mode-on",label:game.i18n.localize("FLASH_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.client,config:!0},showMenuOnLoad:{tag:"show-menu-on-load",label:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},showTokenVisionOnHover:{tag:"show-token-vision-on-hover",label:game.i18n.localize("FLASH_ROLLS.settings.showTokenVisionOnHover.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showTokenVisionOnHover.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},addMacrosToFolder:{tag:"add-macros-to-folder",label:game.i18n.localize("FLASH_ROLLS.settings.addMacrosToFolder.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.addMacrosToFolder.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},menuIconsLayout:{tag:"menu-icons-layout",label:game.i18n.localize("FLASH_ROLLS.settings.menuIconsLayout.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.menuIconsLayout.hint"),propType:Object,default:bs,scope:G.world,config:!1},autoBlockMovementInCombat:{tag:"auto-block-movement-in-combat",label:game.i18n.localize("FLASH_ROLLS.settings.autoBlockMovementInCombat.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.autoBlockMovementInCombat.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},tokenMovementSpeed:{tag:"token-movement-speed",label:game.i18n.localize("FLASH_ROLLS.settings.tokenMovementSpeed.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.tokenMovementSpeed.hint"),propType:Number,default:6,scope:G.world,config:!1,range:{min:1,max:20,step:1}},tooltipAutoDismiss:{tag:"tooltip-auto-dismiss",label:game.i18n.localize("FLASH_ROLLS.settings.tooltipAutoDismiss.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.tooltipAutoDismiss.hint"),propType:Number,default:2,scope:G.world,config:!1,range:{min:0,max:10,step:1}},teleportAnimationPath:{tag:"teleport-animation-path",label:game.i18n.localize("FLASH_ROLLS.settings.teleportAnimationPath.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.teleportAnimationPath.hint"),propType:String,inputType:"filepicker",default:"",scope:G.world,config:!1,filePicker:"video"},legacyTokenAssociationsMigrated:{tag:"legacy-token-associations-migrated",label:game.i18n.localize("FLASH_ROLLS.settings.legacyTokenAssociationsMigrated.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.legacyTokenAssociationsMigrated.hint"),propType:Boolean,default:!1,scope:G.world,config:!1},disableNotifications:{tag:"disable-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.disableNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.disableNotifications.hint"),propType:Boolean,default:!1,scope:G.world,config:!1},lastUpdateId:{tag:"last-update-id",label:"Last Update ID",hint:"Stores the ID of the last update news shown",propType:String,default:"",scope:G.client,config:!1},libWrapperNotificationShown:{tag:"libwrapper-notification-shown",label:"LibWrapper Notification Shown",hint:"Tracks whether the libWrapper recommendation notification has been shown",propType:Boolean,default:!1,scope:G.world,config:!1},transformFavorites:{tag:"transform-favorites",label:"Transformation Favorites",hint:"Stores favorite transformation targets",propType:Array,default:[],scope:G.world,config:!1},ddbCampaignId:{tag:"ddb-campaign-id",label:game.i18n.localize("FLASH_ROLLS.settings.ddbCampaignId.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.ddbCampaignId.hint"),propType:String,default:"",scope:G.world,config:!1},ddbUserId:{tag:"ddb-user-id",label:game.i18n.localize("FLASH_ROLLS.settings.ddbUserId.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.ddbUserId.hint"),propType:String,default:"",scope:G.world,config:!1},ddbCobaltCookie:{tag:"ddb-cobalt-cookie",label:game.i18n.localize("FLASH_ROLLS.settings.ddbCobaltCookie.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.ddbCobaltCookie.hint"),propType:String,default:"",scope:G.world,config:!1},proxyApiKey:{tag:"proxy-api-key",label:game.i18n.localize("FLASH_ROLLS.settings.proxyApiKey.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.proxyApiKey.hint"),propType:String,default:"",scope:G.world,config:!1},ddbCharacterMappings:{tag:"ddb-character-mappings",label:game.i18n.localize("FLASH_ROLLS.settings.ddbCharacterMappings.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.ddbCharacterMappings.hint"),propType:Object,default:{},scope:G.world,config:!1},ddbImportOwnership:{tag:"ddb-import-ownership",label:game.i18n.localize("FLASH_ROLLS.settings.ddbImportOwnership.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.ddbImportOwnership.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:G.world,config:!1},ddbRollOwnership:{tag:"ddb-roll-ownership",label:game.i18n.localize("FLASH_ROLLS.settings.ddbRollOwnership.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.ddbRollOwnership.hint"),propType:Number,inputType:K.select,choices:{0:game.i18n.localize("FLASH_ROLLS.settings.ddbRollOwnership.choices.0"),1:game.i18n.localize("FLASH_ROLLS.settings.ddbRollOwnership.choices.1")},default:0,scope:G.world,config:!1},ddbNoAutoConsumeSpellSlot:{tag:"ddb-no-auto-consume-spell-slot",label:game.i18n.localize("FLASH_ROLLS.settings.ddbNoAutoConsumeSpellSlot.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.ddbNoAutoConsumeSpellSlot.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:G.world,config:!1},ddbImportSourcePriority:{tag:"ddb-import-source-priority",label:game.i18n.localize("FLASH_ROLLS.settings.ddbImportSourcePriority.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.ddbImportSourcePriority.hint"),propType:Number,inputType:K.select,choices:{0:game.i18n.localize("FLASH_ROLLS.settings.ddbImportSourcePriority.choices.0"),1:game.i18n.localize("FLASH_ROLLS.settings.ddbImportSourcePriority.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.ddbImportSourcePriority.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.ddbImportSourcePriority.choices.3")},default:0,scope:G.world,config:!1},ddbImportSpellMode:{tag:"ddb-import-spell-mode",label:game.i18n.localize("FLASH_ROLLS.settings.ddbImportSpellMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.ddbImportSpellMode.hint"),propType:Number,inputType:K.select,choices:{0:game.i18n.localize("FLASH_ROLLS.settings.ddbImportSpellMode.choices.0"),1:game.i18n.localize("FLASH_ROLLS.settings.ddbImportSpellMode.choices.1")},default:0,scope:G.world,config:!1}}),k="flash-rolls-5e",Bt=["%cFlash Token Bar 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],Xe={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest",removeTemplate:"removeTemplate",broadcastRollComplete:"broadcastRollComplete",deleteChatMessage:"deleteChatMessage"},ce={ATTACK:"attack",DAMAGE:"damage",HEAL:"heal",SAVE:"save"},As={d4:"d4",d6:"d6",d8:"d8",d10:"d10",d12:"d12",d20:"d20",d100:"d100"},L={ABILITY:"ability",ABILITY_CHECK:"abilitycheck",ATTACK:"attack",CONCENTRATION:"concentration",CUSTOM:"custom",DEATH_SAVE:"deathsave",FORMULA:"formula",DAMAGE:"damage",HEALING:"healing",HIT_DIE:"hitdie",INITIATIVE:"initiative",INITIATIVE_DIALOG:"initiativedialog",ITEM_SAVE:"itemsave",SAVE:"save",SAVING_THROW:"savingthrow",SKILL:"skill",TOOL:"tool"},yt={ABILITY_CHECK:{name:L.ABILITY_CHECK,label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:L.SAVING_THROW,label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:L.SKILL,label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:L.TOOL,label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:L.CONCENTRATION,label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:L.INITIATIVE,label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:L.DEATH_SAVE,label:"Death Save",subList:null,actorPath:""},HIT_DIE:{name:L.HIT_DIE,label:"Hit Die",subList:null,actorPath:""},CUSTOM:{name:L.CUSTOM,label:"Custom Roll",subList:null,actorPath:""}},V={ID:k,ROLL_REQUEST_OPTIONS:yt},x={INIT:"init",READY:"ready",RENDER_CHAT_MESSAGE:"renderChatMessageHTML",RENDER_CHAT_LOG:"renderChatLog",RENDER_CHAT_INPUT:"renderChatInput",CHANGE_SIDEBAR_TAB:"changeSidebarTab",RENDER_SIDEBAR:"renderSidebar",UPDATE_SCENE:"updateScene",RENDER_ROLL_RESOLVER:"renderRollResolver",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",CREATE_CHAT_MESSAGE:"createChatMessage",COLLAPSE_SIDE_BAR:"collapseSidebar",REFRESH_MEASURED_TEMPLATE:"refreshMeasuredTemplate",CONTROL_TOKEN:"controlToken",UPDATE_TOKEN:"updateToken",PRE_UPDATE_TOKEN:"preUpdateToken",DELETE_TOKEN:"deleteToken",CREATE_TOKEN:"createToken",UPDATE_ACTOR:"updateActor",CREATE_ACTOR:"createActor",DELETE_ACTOR:"deleteActor",UPDATE_ITEM:"updateItem",CREATE_ITEM:"createItem",DELETE_ITEM:"deleteItem",UPDATE_SETTING:"updateSetting",CLIENT_SETTING_CHANGED:"clientSettingChanged",GET_ACTOR_CONTEXT_OPTIONS:"getActorContextOptions",GET_CHAT_MESSAGE_CONTEXT_OPTIONS:"getChatMessageContextOptions",RENDER_ACTOR_DIRECTORY:"renderActorDirectory",CREATE_COMBATANT:"createCombatant",DELETE_COMBATANT:"deleteCombatant",UPDATE_COMBAT:"updateCombat",DELETE_COMBAT:"deleteCombat",COMBAT_START:"combatStart",COMBAT_TURN_CHANGE:"combatTurnChange",CREATE_ACTIVE_EFFECT:"createActiveEffect",DELETE_ACTIVE_EFFECT:"deleteActiveEffect",UPDATE_ACTIVE_EFFECT:"updateActiveEffect",PRE_CREATE_TOKEN:"preCreateToken",CANVAS_READY:"canvasReady"},Eo={READY:"socketlib.ready"},Bs={READY:"midi-qol.ready",PRE_DAMAGE_ROLL:"midi-qol.preDamageRoll"},Y={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_USE_ACTIVITY:"dnd5e.preUseActivity",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE_DIALOG:"dnd5e.preRollInitiativeDialog",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",ROLL_DAMAGE_V2:"dnd5e.rollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",PRE_ROLL_ATTACK:"dnd5e.preRollAttack",PRE_ROLL_DAMAGE:"dnd5e.preRollDamage",POST_ATTACK_ROLL_CONFIGURATION:"dnd5e.postAttackRollConfiguration",POST_DAMAGE_ROLL_CONFIGURATION:"dnd5e.postDamageRollConfiguration",POST_ABILITY_CHECK_ROLL_CONFIGURATION:"dnd5e.postAbilityCheckRollConfiguration",POST_SKILL_CHECK_ROLL_CONFIGURATION:"dnd5e.postSkillCheckRollConfiguration",POST_SAVING_THROW_ROLL_CONFIGURATION:"dnd5e.postSavingThrowRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog",RENDER_SKILL_TOOL_ROLL_DIALOG:"renderSkillToolRollConfigurationDialog",RENDER_GROUP_ACTOR_SHEET:"renderGroupActorSheet",RENDER_ENCOUNTER_ACTOR_SHEET:"renderEncounterActorSheet"},ct={READY:"tidy5e-sheet.ready",PRE_PROMPT_GROUP_SKILL_ROLL:"tidy5e-sheet.prePromptGroupSkillRoll",RENDER_ACTOR_SHEET:"tidy5e-sheet.renderActorSheet",RENDER_GROUP_SHEET_QUADRONE:"renderTidy5eGroupSheetQuadrone",RENDER_GROUP_SHEET_CLASSIC:"renderTidy5eGroupSheetClassic",RENDER_ENCOUNTER_SHEET_QUADRONE:"renderTidy5eEncounterSheetQuadrone",RENDER_ENCOUNTER_SHEET_CLASSIC:"renderTidy5eEncounterSheetClassic"},Oo={READY:"ready"};var at;let c=(at=class{static log(e="",t=[],s=!1){try{const o=game.settings.get(k,"debug-mode-on")||at.debugOn;if(!(s||o))return;const i=Array.isArray(t)?t:[t];console.log(...Bt,e,...i)}catch{if(s||at.debugOn){const a=Array.isArray(t)?t:[t];console.log(...Bt,e,...a)}}}static warn(e="",t=[]){const s=Array.isArray(t)?t:[t];console.warn(...Bt,e,...s)}static error(e,t=[],s={ui:!1,console:!0,permanent:!1}){var a;const o=Array.isArray(t)?t:[t];s.ui&&((a=ui.notifications)==null||a.error(e,{localize:!0,permanent:s.permanent})),s.console&&console.error(...Bt,e,...o)}},E(at,"debugOn",!1),at);const ge=class ge{static serializeForTransport(e,t=!1){return c.log("serializeForTransport",[e,t]),e==null||t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(s=>s instanceof Roll?s.toJSON():s)),e}static deserializeFromTransport(e,t=!1){c.log("deserializeFromTransport",[e,t]);let s={...e};if(!e)return s;if(t&&e.rolls&&e.rolls.length>0){const o=s.rolls.map(a=>{let i=a;return typeof a=="string"?i=Roll.fromJSON(a):a instanceof Roll?i=a:i=Roll.fromJSON(JSON.stringify(a)),i});return s.rolls=[...o],s}return s}};E(ge,"socket"),E(ge,"_activeExecutions",new Map),E(ge,"initialize",e=>{c.log("initialize",[e]),Hooks.once(Eo.READY,()=>{if(typeof socketlib>"u"){c.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{ge.socket=socketlib.registerModule(k),e&&e()}catch(t){c.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled.",[t])}})}),E(ge,"registerCall",(e,t)=>{c.log("registerCall",[e,"hasSocket:",!!ge.socket]),ge.socket?(ge.socket.register(e,t),c.log("registerCall - Registered successfully",[e])):c.warn("registerCall - Socket not ready, registration failed!",[e])}),E(ge,"sendMessage",(e,t)=>{c.log("sendMessage",[e]),t&&t()}),E(ge,"execForGMs",async(e,...t)=>{if(c.log("execForGMs",[e,...t]),!!ge.socket)return await ge.socket.executeForAllGMs(e,...t)}),E(ge,"execForAll",async(e,...t)=>{if(ge.socket)return await ge.socket.executeForEveryone(e,...t)}),E(ge,"execForUser",async(e,t,...s)=>{if(c.log("execForUser #0",[e,t,...s]),!!ge.socket){if(c.log("execForUser #1",[t===game.user.id]),t===game.user.id)return null;try{const o=await ge.socket.executeAsUser(e,t,...s);return c.log("execForUser #2 - response",[o]),o}catch(o){return c.error("execForUser #3 - error",[o]),null}}});let me=ge;class Ye{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const e=game.settings.storage.get("client");return this.diceConfig=e["core.diceConfiguration"]||"",c.log("setDiceConfig",[this.diceConfig]),this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){me.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(e,t){var s,o;((s=game.user)!=null&&s.isGM||e===((o=game.user)==null?void 0:o.id))&&(this.playerDiceConfigs[e]=t?JSON.parse(t):{})}static getUserDiceConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?this.diceConfig:this.playerDiceConfigs[e]||{}}static requestDiceConfigFromUser(e){try{me.execForUser("getDiceConfig",e)}catch(t){c.log("Failed to request dice config from user:",[e,t.message])}}static requestDiceConfigFromAllPlayers(){var e;(e=game.user)!=null&&e.isGM&&game.users.forEach(t=>{t.active&&!t.isGM&&t.id!==game.user.id&&this.requestDiceConfigFromUser(t.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?!!this.diceConfig:!!this.playerDiceConfigs[e]}static hasNonDigitalDice(e){var a,i;let t=e?this.getUserDiceConfig(e):this.diceConfig;if(t||(this.setDiceConfig(),t=this.diceConfig,c.log("hasNonDigitalDice - config was empty, refreshed:",[t])),!t||typeof t!="object"&&typeof t!="string")return c.log("hasNonDigitalDice - no config or wrong type",[typeof t,t]),!1;let s;try{s=typeof t=="string"?JSON.parse(t):t}catch(n){return c.error("hasNonDigitalDice - failed to parse config",[t,n]),!1}const o=(i=(a=CONFIG.Dice)==null?void 0:a.fulfillment)==null?void 0:i.methods;c.log("hasNonDigitalDice - all available methods:",[o]),c.log("hasNonDigitalDice - user config:",[s]);for(const n of Object.values(s))if(n){if(c.log("hasNonDigitalDice - checking method value:",[n]),n==="manual")return c.log("hasNonDigitalDice - found manual method"),!0;if(n!=="random"){const r=o==null?void 0:o[n];return c.log("hasNonDigitalDice - found non-random method",[n,"config:",r,"interactive:",r==null?void 0:r.interactive]),r!=null&&r.interactive?(c.log("hasNonDigitalDice - method is interactive"),!0):(c.log("hasNonDigitalDice - treating non-random method as non-digital"),!0)}}return c.log("hasNonDigitalDice - no non-digital dice found"),!1}}E(Ye,"diceConfig",{}),E(Ye,"playerDiceConfigs",{});var Kt,xs;const Et=class Et{static notify(e,t){var s;try{const o=I();if((s=o==null?void 0:o.disableNotifications)!=null&&s.tag&&v.get(o.disableNotifications.tag))return}catch{}e==="info"?ui.notifications.info(t):e==="warn"?ui.notifications.warn(t):e==="error"&&ui.notifications.error(t)}static isModuleOn(e){var s;const t=(s=game.modules)==null?void 0:s.get(e);return!!(t!=null&&t.active)}static isMidiWorkflowActive(){var e,t,s,o,a;return this.isModuleOn("midi-qol")?(c.log("isMidiWorkflowActive",[(t=(e=globalThis.MidiQOL)==null?void 0:e.Workflow)==null?void 0:t.workflows]),((a=(o=(s=globalThis.MidiQOL)==null?void 0:s.Workflow)==null?void 0:o.workflows)==null?void 0:a.size)>0):!1}static html(e,t){return e.querySelector(t)}static getFullWidth(e){return window.getComputedStyle(e).width==="0px"?0:e.offsetWidth}static preventDialogFlicker(e,t=0){e&&(e.style.opacity="0",e.style.transition="opacity 0.15s ease-in",requestAnimationFrame(()=>{e&&(e.style.opacity="1")}))}static addCSSVars(e,t){let s=document.querySelector("style#flash5e-vars");if(!s){const f=document.querySelector("body.flash5e");if(!f)return;const g=f.querySelector("style#flash5e-vars");g&&g.remove(),s=document.createElement("style"),s.id="flash5e-vars",s.textContent=`body.flash5e {
}
`,f.prepend(s)}let o=s.textContent,a=o.indexOf("body.flash5e {"),i=o.indexOf("}",a);a===-1&&(o=`body.flash5e {
}
`,a=0,i=o.indexOf("}"));const r=o.substring(a+14,i).split(";").map(f=>f.trim()).filter(f=>f!==""),l={};r.forEach(f=>{const g=f.split(":");if(g.length>=2){const m=g[0].trim(),p=g.slice(1).join(":").trim();m&&(l[m]=p)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),l[e]=t;const d=Object.entries(l).map(([f,g])=>`  ${f}: ${g};`).join(`
`),u=o.substring(0,a)+`body.flash5e {
`+d+`
}`+o.substring(i+1);s.textContent=u}static getOffsetBottom(e){const t=e.offsetTop,s=e.offsetHeight;return window.innerHeight-(t+s)}static async getAllFonts(){const e=new Set(Object.keys(CONFIG.fontDefinitions)),t=game.settings.get("core","fonts")||{},s=Object.entries(t).map(([i])=>i),o=await this.processStyleSheets();return Array.from(new Set([...e,...s,...o])).filter(i=>!/FontAwesome|Font Awesome|FoundryVTT/.test(i)).map(i=>i.replace(/['"]/g,"").trim()).sort((i,n)=>i.toLowerCase().localeCompare(n.toLowerCase()))||[]}static addCustomCSS(e,t="flash5e-custom-css",s=!0){if(!e)return;let o=document.querySelector("#"+t);o||(o=document.createElement("style"),o.id=t,o.textContent="",document.head.appendChild(o));const a=/@import\s+(?:url\()?\s*['"]?[^'")]+['"]?\s*\)?\s*;/g,i=[];let n=e,r;for(;(r=a.exec(e))!==null;)i.push(r[0]);if(n=e.replace(a,"").trim(),!s){o.textContent=i.join(`
`)+(i.length?`

`:"")+n;return}if(!o.textContent.includes(n)){const l=o.textContent,d=[];let u;for(;(u=a.exec(l))!==null;)d.push(u[0]);const f=l.replace(a,"").trim(),g=i.filter(p=>!d.includes(p)),m=[...d,...g];o.textContent=m.join(`
`)+(m.length?`

`:"")+f+(f&&n?`

`:"")+n}}static smoothScrollTo(e,t,s="horizontal",o=300,a=null){const i=e.dataset.scrollAnimationId;i&&cancelAnimationFrame(Number(i));const n=s==="horizontal",r=n?e.scrollLeft:e.scrollTop,l=t-r;if(l===0)return a&&a(),null;const d=performance.now(),u=g=>{const m=g-d;if(m>=o){n?e.scrollLeft=t:e.scrollTop=t,delete e.dataset.scrollAnimationId,a&&a();return}const p=m/o,S=p<.5?2*p*p:1-Math.pow(-2*p+2,2)/2;n?e.scrollLeft=r+l*S:e.scrollTop=r+l*S;const y=requestAnimationFrame(u);return e.dataset.scrollAnimationId=y,y},f=requestAnimationFrame(u);return e.dataset.scrollAnimationId=f,f}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredLabel"),s={}){const o={window:{title:e},position:{width:420,height:"auto"},content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.reloadButton"),callback:()=>(c.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(o,s),foundry.applications.api.DialogV2.confirm(o)}static renderTemplate(e,t){return foundry.applications.handlebars.renderTemplate(e,t)}static loadTemplate(e){return foundry.applications.handlebars.loadTemplate(e)}static loadTemplates(e){return Array.isArray(e)||(e=[e]),foundry.applications.handlebars.loadTemplates(e)}static isValidCSSRule(e){if(!e||typeof e!="string")return!1;const t=e.trim();if(!t)return!1;try{const s=document.createElement("style"),o=`${t} { color: inherit; }`;s.textContent=o,document.head.appendChild(s);const a=!!(s.sheet&&s.sheet.cssRules&&s.sheet.cssRules.length>0);return document.head.removeChild(s),a}catch(s){return c.log("CSS validation error:",[s,e]),!1}}static processCSSRules(e,t){if(!e||!t)return"";const s=X(this,Kt,xs).call(this,e),o=t+` {
`+s.baseProperties.join(`
`)+`
}`,a=[],i=new Map;return s.nestedRules.forEach(n=>{const{selector:r,content:l}=n;if(r.startsWith("&")){const f=r.substring(1),g=t.split(",").map(m=>m.trim()).filter(Boolean).map(m=>m+f).join(", ");a.push(`${g} {
${l}
}`);return}i.has(l)||i.set(l,[]);const d=r.split(",").map(f=>f.trim()),u=t.split(",").map(f=>f.trim()).filter(Boolean);d.forEach(f=>{u.forEach(g=>{i.get(l).push(`${g} ${f}`)})})}),i.forEach((n,r)=>{a.push(`${n.join(", ")} {
${r}
}`)}),o+`

`+a.join(`

`)}static getActorOwner(e){const t=e.ownership||{};for(const[s,o]of Object.entries(t))if(o>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const a=game.users.get(s);if(a&&!a.isGM)return a}if((t==null?void 0:t.default)>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const s=game.users.filter(o=>!o.isGM)[0];if(s)return s}return null}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredLabel"),s={}){const o={window:{title:e},position:{width:420,height:"auto"},content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.reloadButton"),callback:()=>(c.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(o,s),foundry.applications.api.DialogV2.confirm(o)}static async removeTemplateForItem(e){const t=I(),s=v.get(t.removeTemplate.tag);if(c.log("removeTemplateForItem",[e,s]),!!s){if(!game.user.isGM){c.log("removeTemplateForItem - requesting GM to remove template",[e==null?void 0:e.uuid]),me.execForGMs("removeTemplate",e==null?void 0:e.uuid);return}try{const o=canvas.templates.objects.children.filter(a=>a.document.flags.dnd5e.item===(e==null?void 0:e.uuid));if(o.length>0){const a=o.map(n=>n.id),i=canvas.scene.templates.filter(n=>a.includes(n.id));i.length>0?(c.log("removeTemplateForItem - removing templates",[e==null?void 0:e.uuid,i.length]),await canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate",i.map(n=>n.id))):c.log("removeTemplateForItem - templates already removed",[e==null?void 0:e.uuid])}}catch(o){c.log("removeTemplateForItem - template not found or already deleted",[e==null?void 0:e.uuid,o.message])}}}static async removeTemplate(e){c.log("removeTemplate",[e]);try{const t=await fromUuid(e);if(t&&game.user.isGM)return Et.removeTemplateForItem(t)}catch(t){c.error("removeTemplate - error",[t])}}static areSkipKeysPressed(e){const{areKeysPressed:t}=game.dnd5e.utils||{};return t?t(e,"skipDialogNormal")||t(e,"skipDialogAdvantage")||t(e,"skipDialogDisadvantage"):e.shiftKey||e.altKey||e.ctrlKey||e.metaKey||!1}};Kt=new WeakSet,xs=function(e){const t=[],s=[],o=e.split(`
`);let a=null,i=0;for(let n=0;n<o.length;n++){const r=o[n].trim();if(!r)continue;const l=(r.match(/{/g)||[]).length,d=(r.match(/}/g)||[]).length;if(r.includes("{")&&!a){a={selector:r.substring(0,r.indexOf("{")).trim(),content:"",startLine:n},i=1;const f=r.substring(r.indexOf("{")+1).trim();f&&!f.includes("}")&&(a.content+=f+`
`)}else a?(i+=l-d,i>0?a.content+=r+`
`:(a.content=a.content.replace(/}\s*$/,"").trim(),s.push(a),a=null)):!r.includes("{")&&!r.includes("}")&&t.push(r)}return{baseProperties:t,nestedRules:s}},fe(Et,Kt),E(Et,"wrapFontName",e=>{const t=e.replace(/['"`]/g,"");return t.includes(" ")?`"${t}"`:t});let q=Et;function Mo(h,e){var o,a,i,n,r;let t=game.i18n.localize(`FLASH_ROLLS.rollTypes.${h}`)||h;const s=h==null?void 0:h.toLowerCase();if(e)switch(s){case L.SKILL:t+=` (${((o=CONFIG.DND5E.skills[e])==null?void 0:o.label)||e})`;break;case L.SAVE:t+=` (${((a=CONFIG.DND5E.abilities[e])==null?void 0:a.label)||e})`;break;case L.ABILITY:t+=` (${((i=CONFIG.DND5E.abilities[e])==null?void 0:i.label)||e})`;break;case L.TOOL:const l=(r=(n=CONFIG.DND5E.enrichmentLookup)==null?void 0:n.tools)==null?void 0:r[e];if(l!=null&&l.id){const d=dnd5e.documents.Trait.getBaseItem(l.id,{indexOnly:!0});t+=` (${(d==null?void 0:d.name)||e})`}else t+=` (${e})`;break;case L.CUSTOM:t=`${t}: ${e}`;break}return t}function Fo(h,e){var s,o,a,i,n;if(!e)return"";switch(h==null?void 0:h.toLowerCase()){case L.SKILL:return((s=CONFIG.DND5E.skills[e])==null?void 0:s.label)||e;case L.SAVE:case L.SAVING_THROW:return((o=CONFIG.DND5E.abilities[e])==null?void 0:o.label)||e;case L.ABILITY:case L.ABILITY_CHECK:return((a=CONFIG.DND5E.abilities[e])==null?void 0:a.label)||e;case L.TOOL:const r=(n=(i=CONFIG.DND5E.enrichmentLookup)==null?void 0:i.tools)==null?void 0:n[e];if(r!=null&&r.id){const l=dnd5e.documents.Trait.getBaseItem(r.id,{indexOnly:!0});return(l==null?void 0:l.name)||e}return e;default:return e}}function Po(h,e=Mo){if(h.length===0||!(ui!=null&&ui.notifications))return;const t={};for(const o of h){const a=`${o.rollType}_${o.rollKey||""}`;t[a]||(t[a]={rollType:o.rollType,rollKey:o.rollKey,actors:[],gm:o.gm}),t[a].actors.push(o.actor)}const s=Object.values(t);if(s.length===1&&s[0].actors.length===1){const o=s[0];D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestReceived",{gm:o.gm,rollType:e(o.rollType,o.rollKey)}))}else{const o=[];for(const a of s){const i=e(a.rollType,a.rollKey),n=a.actors.join(", ");o.push(`${i} (${n})`)}D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestsReceivedMultiple",{gm:s[0].gm,requests:o.join("; ")}))}}function Le(h){const e=game.users.find(a=>{var i;return!a.isGM&&a.active&&((i=a.character)==null?void 0:i.id)===h.id});if(e)return e;const t=game.users.find(a=>{var i;return!a.isGM&&((i=a.character)==null?void 0:i.id)===h.id});if(t)return t;const s=h.ownership||{},o=Object.entries(s).filter(([a,i])=>i>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER).map(([a])=>game.users.get(a)).filter(a=>a&&!a.isGM);return o.find(a=>a.active)||o[0]||null}function Ho(h,e=game.user){h!=null&&h.length&&h.forEach((t,s)=>{c.log("applyTargetTokens",[t,canvas.tokens.placeables.map(a=>a.id)]);const o=canvas.tokens.placeables.find(a=>a.id===t);o?o.setTarget(!0,{releaseOthers:s===0}):c.warn("applyTargetTokens - Token not found:",[t])})}function qt(){var e,t,s;const h=new Map;for(const o of game.user.targets){const{name:a}=o,{img:i,system:n,uuid:r,statuses:l}=o.actor??{};if(r){const d=(e=l==null?void 0:l.has)!=null&&e.call(l,"coverTotal")?null:(s=(t=n==null?void 0:n.attributes)==null?void 0:t.ac)==null?void 0:s.value;h.set(r,{name:a,img:i,uuid:r,ac:d??null})}}return Array.from(h.values())}function cs(h){return h.type!=="character"&&h.type!=="npc"?!1:Object.entries(h.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}function qs(h){if(h.type!=="character"&&h.type!=="npc")return!1;const e=game.scenes.current;return e&&e.tokens.some(t=>t.actorId===h.id)}function Oe(h,e,t=null){if(!game.scenes.current)return;let o;if(t){const a=canvas.tokens.placeables.find(i=>i.id===t);o=a?[a]:[]}else o=canvas.tokens.placeables.filter(a=>{var i;return((i=a.actor)==null?void 0:i.id)===h});for(const a of o)e?a.control({releaseOthers:!1}):a.release()}function zt(h){return new Promise(e=>setTimeout(e,h))}function Ts(){var h;return((h=ui==null?void 0:ui.sidebar)==null?void 0:h.expanded)||!1}function Ls(h){const e=document.querySelector("body");h?e.classList.add("flash-sidebar-expanded"):e.classList.remove("flash-sidebar-expanded"),dt()}function ks(h,e){var a,i;const t=[];if(!h)return t;const s=V.ROLL_REQUEST_OPTIONS[h];if(!s||!s.subList)return t;const o=CONFIG.DND5E[s.subList];if(o){for(const[n,r]of Object.entries(o)){let l=r.label||r.name||n;if(s.subList==="tools"&&((i=(a=CONFIG.DND5E.enrichmentLookup)==null?void 0:a.tools)!=null&&i[n])){const d=CONFIG.DND5E.enrichmentLookup.tools[n];if(d!=null&&d.id){const u=dnd5e.documents.Trait.getBaseItem(d.id,{indexOnly:!0});l=(u==null?void 0:u.name)||l}}t.push({id:n,name:l,rollable:!0})}t.sort((n,r)=>n.name.localeCompare(r.name))}return t}const Se=class Se{static notify(e,t,s={}){var o;if(!s.batch){(o=ui==null?void 0:ui.notifications)!=null&&o[e]&&ui.notifications[e](t);return}s.batchData&&(Se.pendingNotifications.push(s.batchData),Se.notificationTimer&&clearTimeout(Se.notificationTimer),Se.notificationTimer=setTimeout(()=>{Po(Se.pendingNotifications),Se.pendingNotifications=[],Se.notificationTimer=null},Se.NOTIFICATION_BATCH_DELAY))}static notifyRollRequestsSent(e,t){const s=Object.entries(e);if(s.length!==0)if(s.length===1){const o=Object.values(e)[0],a=o.actors.map(i=>i.name).join(", ");D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentSingle",{rollType:t,actors:a,player:o.player.name}))}else{const o=s.map(([a,i])=>{const n=i.actors.map(r=>r.name).join(", ");return`${i.player.name} (${n})`});D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentMultiple",{rollType:t,count:s.length,players:o.join("; ")}))}}static clearPending(){Se.notificationTimer&&(clearTimeout(Se.notificationTimer),Se.notificationTimer=null),Se.pendingNotifications=[]}};E(Se,"pendingNotifications",[]),E(Se,"notificationTimer",null),E(Se,"NOTIFICATION_BATCH_DELAY",500);let pe=Se;function No(h){var s;const e=[],t=[];for(const o of h){const a=((s=o.system.attributes.hp)==null?void 0:s.value)||0,i=o.system.attributes.death||{},n=i.success||0,r=i.failure||0;a<=0&&n<3&&r<3?e.push(o):t.push(o.name)}return t.length>0&&pe.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorsSkippingDeathSave",{actors:t.join(", ")})),e}function Go(h){const e=[],t=[];for(const s of h){const o=Le(s);o?e.push({actor:s,owner:o}):t.push(s)}return{pcActors:e,npcActors:t}}function dt(h=!0){const e=document.querySelector("#chat-notifications #roll-privacy"),t=e?q.getFullWidth(e):36,s=!!document.querySelector("body.crlngn-tabs");q.addCSSVars("--flash-rolls-menu-offset",(s?t:t+16)+"px")}function se(h){var o,a;const e=(o=game.scenes.current)==null?void 0:o.tokens.get(h);if(e!=null&&e.actor)return e.actor;const t=(a=canvas.tokens)==null?void 0:a.get(h);return t!=null&&t.actor?t.actor:game.actors.get(h)||null}function _s(){const h=I();switch(v.get(h.consumptionConfigMode.tag)){case 1:return!1;case 2:return game.user.isGM;case 3:return!game.user.isGM;default:return!0}}function At(h,e=!0){let t={...h};return game.user.isGM&&(t.action=e?h.action:!1,t.resources=e?h.resources:[],t.spellSlot=e?h.spellSlot:!1),t}function Vt(h,e=!0){var r;const t=I(),s=v.get(t.placeTemplateForPlayer.tag),o=h.measuredTemplate===!0,a=(r=game.modules.get("midi-qol"))==null?void 0:r.active,i=h._isDnDBRoll===!0;let n;return i?n=!0:game.user.isGM?n=e||s:a&&s&&o&&!e?n=!0:n=!s,c.log("getCreateConfig",[h,e,s,o,n,a]),{...h,measuredTemplate:o?n:!1}}class Ge{static extractRollInfo(e){var o,a,i,n,r,l,d;const t=((o=e.data)==null?void 0:o.rolls)||[],s=t[0]||{};return{action:((a=e.data)==null?void 0:a.action)||"Unknown",rollType:s.rollType||"check",rollKind:s.rollKind||"",total:((i=s.result)==null?void 0:i.total)||0,formula:this._buildFormula(s),diceResults:this._extractDiceResults(s),characterId:e.entityId,characterName:((r=(n=e.data)==null?void 0:n.context)==null?void 0:r.name)||"Unknown",characterAvatar:((d=(l=e.data)==null?void 0:l.context)==null?void 0:d.avatarUrl)||"",source:e.source||"web",isAdvantage:s.rollKind==="advantage",isDisadvantage:s.rollKind==="disadvantage",isCritical:s.rollKind==="critical hit",rawRolls:t,rollMode:this._determineRollMode(e)}}static _determineRollMode(e){const{messageScope:t,messageTarget:s,userId:o}=e;return t==="gameId"?CONST.DICE_ROLL_MODES.PUBLIC:t==="userId"?s===o?CONST.DICE_ROLL_MODES.PRIVATE:CONST.DICE_ROLL_MODES.BLIND:CONST.DICE_ROLL_MODES.PUBLIC}static determineRollCategory(e,t,s){const o=e.toLowerCase();if(o==="initiative"||t==="roll"&&o==="initiative")return{category:"initiative"};if(t==="save"){const a=this._getAbilityAbbrev(e);return a?{category:"save",ability:a}:{category:"save",ability:"str",original:e}}if(t==="to hit"||t==="attack")return{category:"attack",action:e};if(t==="damage")return{category:"damage",action:e};if(t==="heal"||t==="healing")return{category:"healing",action:e};if(t==="check"){const a=this._getAbilityAbbrev(e);if(a)return{category:"abilityCheck",ability:a};const i=this._getSkillAbbrev(e);if(i)return{category:"skill",skill:i,skillName:e};if(s){const n=this._findToolForAction(s,e);if(n)return{category:"tool",tool:n,toolName:e}}return{category:"customCheck",action:e}}return{category:"unknown",action:e,rollType:t}}static _getAbilityAbbrev(e){var o,a;const t=e.toLowerCase(),s=((o=CONFIG.DND5E)==null?void 0:o.abilities)||{};for(const[i,n]of Object.entries(s))if(i===t||((a=n.label)==null?void 0:a.toLowerCase())===t)return i;return null}static _getSkillAbbrev(e){var o,a;const t=e.toLowerCase(),s=((o=CONFIG.DND5E)==null?void 0:o.skills)||{};for(const[i,n]of Object.entries(s))if(i===t||((a=n.label)==null?void 0:a.toLowerCase())===t)return i;return null}static _findToolForAction(e,t){if(!e)return null;const s=t.toLowerCase();return e.items.find(o=>{if(o.type!=="tool")return!1;const a=o.name.toLowerCase();return a.includes(s)||s.includes(a)})||null}static _buildFormula(e){const t=e.diceNotation;if(!t)return"";const s=[];for(const a of t.set||[])s.push(`${a.count}${a.dieType}`);let o=s.join(" + ");if(t.constant){const a=t.constant>=0?"+":"";o+=` ${a}${t.constant}`}return o}static _extractDiceResults(e){const t=[],s=e.diceNotation;if(!s)return t;for(const o of s.set||[])for(const a of o.dice||[])t.push({type:a.dieType,value:a.dieValue});return t}static getRollTypeLabel(e){return{"to hit":game.i18n.localize("DND5E.Attack"),attack:game.i18n.localize("DND5E.Attack"),check:"Check",save:game.i18n.localize("DND5E.SavingThrow"),damage:game.i18n.localize("DND5E.Damage"),heal:game.i18n.localize("DND5E.Healing"),healing:game.i18n.localize("DND5E.Healing")}[e==null?void 0:e.toLowerCase()]||e||"Roll"}static findItemByAction(e,t){if(!e||!t)return null;const s=t.toLowerCase();return e.items.find(o=>o.name.toLowerCase()===s)||null}static getActivityFromItem(e,t){var i;if(!e)return null;const s=(i=e.system)==null?void 0:i.activities;if(!s)return null;const a={"to hit":"attack",attack:"attack",damage:null,heal:"heal",healing:"heal"}[t];return a===null?e.hasAttack?s.find(n=>n.type==="attack")||null:e.hasSave?s.find(n=>n.type==="save")||null:s.find(n=>n.type==="damage")||null:a?s.find(n=>n.type===a)||null:Array.from(s.values())[0]||null}}const vt=foundry.dice.terms.Die;class St{static replaceTerms(e,t){return!e||!t||(e.terms=t.terms,e._total=e._evaluateTotal(),e.resetFormula()),e}static replaceDie(e,t){var a;if(!t||!e)return e;if(!t.terms)return c.error("DnDBRollUtil.replaceDie - replacer.terms is undefined",[t]),e;const s=t.terms.filter(i=>i instanceof vt||i.class==="Die")||[],o=((a=e==null?void 0:e.terms)==null?void 0:a.filter(i=>!(i instanceof vt||i.class==="Die")))||[];return e.terms=[...s,...o],e._total=e._evaluateTotal(),e.resetFormula(),e}static createRollFromDnDB(e){var a;const t=e.diceNotation;if(!t)return null;const s=[];for(const i of t.set||[]){const n=parseInt(i.dieType.replace("d",""),10),r=i.dice.map((d,u)=>({result:d.dieValue,active:!0,indexThrow:u})),l=new vt({faces:n,number:i.count});l._evaluated=!0,l.results=r,s.push(l)}if(t.constant){const i=foundry.dice.terms.OperatorTerm,n=foundry.dice.terms.NumericTerm,r=t.constant>=0?"+":"-",l=new i({operator:r});l._evaluated=!0,s.push(l);const d=new n({number:Math.abs(t.constant)});d._evaluated=!0,s.push(d)}const o=Roll.fromTerms(s);return o._evaluated=!0,o._total=((a=e.result)==null?void 0:a.total)||0,o}static buildDieTermsFromDnDB(e){const t=e.diceNotation;if(!t)return[];const s=[];for(const o of t.set||[]){const a=parseInt(o.dieType.replace("d",""),10),i=o.dice.map((r,l)=>({result:r.dieValue,active:!0,indexThrow:l})),n=new vt({faces:a,number:o.count});n._evaluated=!0,n.results=i,s.push(n)}return s}static injectDnDBDiceValues(e,t){if(!e||!t)return e;const s=t.diceNotation;if(!s)return e;let o=0;const a=[];for(const i of s.set||[])for(const n of i.dice||[])a.push(n.dieValue);for(const i of e.terms)if(i instanceof vt||i.class==="Die")for(const n of i.results||[])o<a.length&&(n.result=a[o],o++);return e._total=e._evaluateTotal(),e.resetFormula(),e}}class Zt{static async ddbUse(e,t={},s={},o={}){var u,f,g,m,p,S,y,R;if(!e){ui.notifications.error("No activity found",{localize:!1});return}if(!e.item.isEmbedded||e.item.pack)return;if(!e.item.isOwner){ui.notifications.error("DND5E.DocumentUseWarn",{localize:!0});return}if(!e.canUse){ui.notifications.error("DND5E.ACTIVITY.Warning.UsageNotAllowed",{localize:!0});return}let a=e.item.clone({},{keepId:!0});const i=e._prepareUsageConfig(t);(u=t.create)!=null&&u._isDnDBRoll&&(i.create=i.create||{},i.create._isDnDBRoll=!0),c.log("DnDBActivityUtil.ddbUse - usageConfig after _prepareUsageConfig",["_isDnDBRoll:",(f=i.create)==null?void 0:f._isDnDBRoll,i.create]),(g=i.create)!=null&&g.measuredTemplate&&((m=ui.notifications)==null||m.info(game.i18n.localize("FLASH_ROLLS.notifications.clickMapToPlaceTemplate")));const n=foundry.utils.mergeObject({configure:!1,applicationClass:e.metadata.usage.dialog},s),r=foundry.utils.mergeObject({create:!0,data:{flags:{dnd5e:{...e.messageFlags,messageType:"usage",use:{effects:(p=e.applicableEffects)==null?void 0:p.map(A=>A.id)}},rsr5e:{processed:!0,quickRoll:!1}}},hasConsumption:i.hasConsumption},o);if(Hooks.call("dnd5e.preUseActivity",e,i,n,r)===!1)return;if(n.configure&&e._requiresConfigurationDialog(i))try{await n.applicationClass.create(e,i,n.options)}catch{return}await e._prepareUsageScaling(i,r,a),e=a.system.activities.get(e.id);const l=await e.consume(i,r);if(l===!1)return;const d={effects:[],templates:[],updates:l};if((S=i.concentration)!=null&&S.begin){const A=await a.actor.beginConcentrating(e,{"flags.dnd5e.scaling":i.scaling});if(A&&(d.effects??(d.effects=[]),d.effects.push(A),foundry.utils.setProperty(r.data,"flags.dnd5e.use.concentrationId",A.id)),(y=i.concentration)!=null&&y.end){const _=await a.actor.endConcentration(i.concentration.end);d.effects.push(..._)}}return r.data.rolls=(r.data.rolls??[]).concat(l.rolls),e._finalizeMessageConfig(i,r,d),d.message=await this._createUsageMessage(e,r),await e._finalizeUsage(i,d),c.log("DnDBActivityUtil.ddbUse - About to call postUseActivity hook",["_isDnDBRoll:",(R=i.create)==null?void 0:R._isDnDBRoll]),Hooks.call("dnd5e.postUseActivity",e,i,d)===!1||i.subsequentActions!==!1&&e._triggerSubsequentActions(i,d),d}static async _createUsageMessage(e,t){let s=await e._usageChatContext(t);const o=await this._buildRollData(t.data.rolls,e);s={...s,rolls:o},c.log("DnDBActivityUtil._createUsageMessage",[e.metadata.usage.chatCard,s]);const a=foundry.utils.mergeObject({rollMode:game.settings.get("core","rollMode"),data:{content:await foundry.applications.handlebars.renderTemplate(e.metadata.usage.chatCard,s),speaker:ChatMessage.getSpeaker({actor:e.item.actor}),flags:{core:{canPopout:!0},rsr5e:{processed:!0}}}},t);Hooks.callAll("dnd5e.preCreateUsageMessage",e,a),ChatMessage.applyRollMode(a.data,a.rollMode);const i=a.create===!1?a.data:await ChatMessage.create(a.data);return Hooks.callAll("dnd5e.postCreateUsageMessage",e,i),i}static async _buildRollData(e,t){return!e||e.length===0?[]:await Promise.all(e.map(async o=>{var l;const a=await o.getTooltip(),i=Number.isNumeric((l=o.options)==null?void 0:l.target),n=i&&o.total>=o.options.target,r=i&&o.total<o.options.target;return{...o,formula:o.formula,total:o.total,tooltipHtml:a,isSuccess:n,isFailure:r,hasTarget:i}}))}static getActivityByType(e,t){var a;if(!e)return null;const s=(a=e.system)==null?void 0:a.activities;return s&&s.find(i=>i.type===t)||null}static getFirstActivity(e){var s;if(!e)return null;const t=(s=e.system)==null?void 0:s.activities;return t&&Array.from(t.values())[0]||null}}class qe{static getMidiQOL(){return q.isModuleOn("midi-qol")&&typeof MidiQOL<"u"?MidiQOL:null}}E(qe,"midiTimeout",null);class re{static isActive(){return q.isModuleOn("midi-qol")}static setPendingRoll(e){this._pendingDnDBRoll=e,c.log("DnDBIntegration.setPendingRoll",[e])}static clearPendingRoll(){this._pendingDnDBRoll=null}static consumePendingRoll(){const e=this._pendingDnDBRoll;return this._pendingDnDBRoll=null,e}static hasPendingRoll(){return this._pendingDnDBRoll!==null}static registerHooks(){Hooks.on(Y.PRE_ROLL_ATTACK,this._onPreRollAttack.bind(this)),Hooks.on(Y.PRE_ROLL_DAMAGE,this._onPreRollDamage.bind(this)),Hooks.on(Y.PRE_ROLL_ABILITY_CHECK,this._onPreRollBasic.bind(this)),Hooks.on(Y.PRE_ROLL_SAVING_THROW,this._onPreRollBasic.bind(this)),Hooks.on(Y.PRE_ROLL_SKILL_V2,this._onPreRollBasic.bind(this)),Hooks.on(Y.PRE_ROLL_TOOL_V2,this._onPreRollBasic.bind(this)),Hooks.on(Y.POST_ATTACK_ROLL_CONFIGURATION,this._onPostAttackRollConfiguration.bind(this)),Hooks.on(Y.POST_DAMAGE_ROLL_CONFIGURATION,this._onPostDamageRollConfiguration.bind(this)),Hooks.on(Y.POST_ABILITY_CHECK_ROLL_CONFIGURATION,this._onPostBasicRollConfiguration.bind(this)),Hooks.on(Y.POST_SKILL_CHECK_ROLL_CONFIGURATION,this._onPostBasicRollConfiguration.bind(this)),Hooks.on(Y.POST_SAVING_THROW_ROLL_CONFIGURATION,this._onPostBasicRollConfiguration.bind(this)),Hooks.on(Bs.PRE_DAMAGE_ROLL,this._onMidiPreDamageRoll.bind(this)),c.log("DnDBIntegration: Registered roll configuration hooks")}static _onMidiPreDamageRoll(e,t,s,o,a){return this._waitingForDnDBDamage&&!this.hasPendingRoll()?(c.log("DnDBIntegration._onMidiPreDamageRoll - Blocking auto-damage, waiting for DDB damage roll"),!1):!0}static _onPreRollAttack(e,t,s){this.hasPendingRoll()&&(t.configure=!1,c.log("DnDBIntegration._onPreRollAttack - Forcing dialog.configure = false"))}static _onPreRollDamage(e,t,s){!this.hasPendingRoll()&&!_e.hasPendingDamageRoll()||(t.configure=!1,c.log("DnDBIntegration._onPreRollDamage - Forcing dialog.configure = false"))}static _onPreRollBasic(e,t,s){this.hasPendingRoll()&&(t.configure=!1,c.log("DnDBIntegration._onPreRollBasic - Forcing dialog.configure = false"))}static _onPostAttackRollConfiguration(e,t,s,o){var n;if(!this.hasPendingRoll())return;const a=this._pendingDnDBRoll,i=(n=a==null?void 0:a.rawRolls)==null?void 0:n[0];if(!(!i||!(e!=null&&e.length))){c.log("DnDBIntegration._onPostAttackRollConfiguration - Injecting DDB values",[e,i]);for(const r of e)this._injectDiceValuesPreEval(r,i);this._addDnDBFlags(o,a),this.clearPendingRoll()}}static _onPostDamageRollConfiguration(e,t,s,o){var n;if(!this.hasPendingRoll())return;const a=this._pendingDnDBRoll,i=(n=a==null?void 0:a.rawRolls)==null?void 0:n[0];if(!(!i||!(e!=null&&e.length))){c.log("DnDBIntegration._onPostDamageRollConfiguration - Injecting DDB values",[e,i]);for(const r of e)this._injectDiceValuesPreEval(r,i);this._addDnDBFlags(o,a),this.clearPendingRoll()}}static _onPostBasicRollConfiguration(e,t,s,o){var n;if(c.log("DnDBIntegration._onPostBasicRollConfiguration - Hook fired",["hasPending:",this.hasPendingRoll(),"rollCount:",e==null?void 0:e.length]),!this.hasPendingRoll())return;const a=this._pendingDnDBRoll,i=(n=a==null?void 0:a.rawRolls)==null?void 0:n[0];if(!i||!(e!=null&&e.length)){c.warn("DnDBIntegration._onPostBasicRollConfiguration - Missing ddbRoll or rolls",["ddbRoll:",!!i,"rollsLength:",e==null?void 0:e.length]);return}c.log("DnDBIntegration._onPostBasicRollConfiguration - Injecting DDB values",["action:",a==null?void 0:a.action,"rollType:",a==null?void 0:a.rollType]);for(const r of e)this._injectDiceValuesPreEval(r,i);this._addDnDBFlags(o,a),this.clearPendingRoll()}static _injectDiceValuesPreEval(e,t){const s=t.diceNotation;if(!s){c.warn("DnDBIntegration._injectDiceValuesPreEval - No diceNotation found",[t]);return}const o=[];for(const n of s.set||[])for(const r of n.dice||[])o.push(r.dieValue);if(o.length===0){c.warn("DnDBIntegration._injectDiceValuesPreEval - No dice values found",[s]);return}let a=0;const i=foundry.dice.terms.Die;for(const n of e.terms)if(n instanceof i){n.results=[];for(let r=0;r<n.number;r++)a<o.length&&(n.results.push({result:o[a],active:!0}),a++);n._evaluated=!0}c.log("DnDBIntegration._injectDiceValuesPreEval - Injected values",["formula:",e.formula,"ddbValues:",o,"rollTerms:",e.terms.map(n=>n instanceof i?{faces:n.faces,results:n.results}:n)])}static _addDnDBFlags(e,t){e!=null&&e.data||(e.data={}),e.data.flags||(e.data.flags={}),e.data.flags[k]={isDnDBRoll:!0,ddbCharacterId:t.characterId,ddbSource:t.source,rollType:t.rollType,action:t.action},e.data.flags.rsr5e={processed:!0,quickRoll:!1}}static async executeAttackWithMidi(e,t,s,o={}){const a=qe.getMidiQOL();if(!a)return c.warn("DnDBIntegration: MidiQOL not available"),!1;this.setPendingRoll(s),this._waitingForDnDBDamage=!0;const i={consume:{resources:!1,spellSlot:!1},midiOptions:{fastForwardAttack:!0,fastForwardDamage:!0,autoRollAttack:!0,autoRollDamage:"none",workflowOptions:{fastForwardAttack:!0,fastForwardDamage:!0,autoRollAttack:!0,autoRollDamage:"none"}}},n={configure:!1},r={create:!0,data:{flags:{[k]:{isDnDBRoll:!0,ddbCharacterId:s.characterId,ddbSource:s.source}}}};try{const l=await a.completeActivityUse(t,i,n,r),d=t.item,u=this._findWorkflowWaitingForDamage(a,d);return c.log("DnDBIntegration.executeAttackWithMidi - After completeActivityUse",["result:",l,"workflowFound:",!!u,"workflowState:",u==null?void 0:u.currentAction,"isGM:",game.user.isGM,"_waitingForDnDBDamage:",this._waitingForDnDBDamage]),!0}catch(l){return c.error("DnDBIntegration.executeAttackWithMidi failed",[l]),this.clearPendingRoll(),this._waitingForDnDBDamage=!1,!1}}static async executeDamageWithMidi(e,t,s,o={}){var u,f;const a=qe.getMidiQOL();if(!a)return c.warn("DnDBIntegration: MidiQOL not available"),!1;c.log("DnDBIntegration.executeDamageWithMidi - Entry",["wasWaitingForDnDBDamage:",this._waitingForDnDBDamage,"isGM:",game.user.isGM,"activityUuid:",t.uuid]),this._waitingForDnDBDamage=!1;const i=t.item,n=(i==null?void 0:i.hasAttack)??!1,r=(f=(u=a.Workflow).getWorkflowByActivityUuid)==null?void 0:f.call(u,t.uuid),l=this._findWorkflowWaitingForDamage(a,t),d=l||r||this._findRecentWorkflowForItem(a,t);return c.log("DnDBIntegration.executeDamageWithMidi - Routing decision",["itemRequiresAttack:",n,"hasWorkflowWaiting:",!!l,"hasWorkflowByActivity:",!!r,"hasRecentWorkflow:",!!d,"recentWorkflowState:",d==null?void 0:d.currentAction,"item:",i==null?void 0:i.name,"activity:",t.name]),n?l?(c.log("DnDBIntegration: Case A - Item requires attack + workflow waiting for damage, using Midi"),await this._executeDamageExistingWorkflow(t,s,l)):d?(c.log("DnDBIntegration: Case C - Item requires attack + recent workflow, attaching damage"),await this._executeDamageAttachToWorkflow(t,s,d)):(c.log("DnDBIntegration: Case D - Item requires attack but NO workflow, falling back to vanilla"),!1):(c.log("DnDBIntegration: Case B - Damage-only item, creating new Midi workflow"),await this._executeDamageNewWorkflow(e,t,s,o))}static _findWorkflowWaitingForDamage(e,t){var a,i,n,r,l,d,u,f,g;if(!t||!((a=e==null?void 0:e.Workflow)!=null&&a.workflows))return c.log("DnDBIntegration._findWorkflowWaitingForDamage - No activity or workflows",["activity:",t==null?void 0:t.name,"hasWorkflows:",!!((i=e==null?void 0:e.Workflow)!=null&&i.workflows)]),null;const s=e.Workflow.workflows,o=(n=t.item)==null?void 0:n.uuid;c.log("DnDBIntegration._findWorkflowWaitingForDamage - Searching workflows",["activityUuid:",t.uuid,"itemUuid:",o,"workflowCount:",s.size]);for(const[m,p]of s.entries()){const S=p instanceof WeakRef?p.deref():p;if(!S)continue;const y=((r=S.activity)==null?void 0:r.uuid)===t.uuid,R=((l=S.item)==null?void 0:l.uuid)===o;if(c.log("DnDBIntegration._findWorkflowWaitingForDamage - Checking workflow",[S.id,"workflowActivityUuid:",(d=S.activity)==null?void 0:d.uuid,"workflowItemUuid:",(u=S.item)==null?void 0:u.uuid,"matchesActivity:",y,"matchesItem:",R,"currentAction:",S.currentAction,"waitForDamageState:",S.WorkflowState_WaitForDamageRoll]),(y||R)&&S.currentAction===S.WorkflowState_WaitForDamageRoll)return c.log("DnDBIntegration._findWorkflowWaitingForDamage - Found workflow",[S.id,"activity:",(f=S.activity)==null?void 0:f.name,"item:",(g=S.item)==null?void 0:g.name,"state:",S.currentAction]),S}return c.log("DnDBIntegration._findWorkflowWaitingForDamage - No matching workflow found"),null}static _findRecentWorkflowForItem(e,t){var n,r,l,d,u,f,g;if(!t||!((n=e==null?void 0:e.Workflow)!=null&&n.workflows))return null;const s=e.Workflow.workflows,o=(r=t.item)==null?void 0:r.uuid;let a=null;for(const[m,p]of s.entries()){const S=p instanceof WeakRef?p.deref():p;if(!S)continue;const y=((l=S.damageRolls)==null?void 0:l.length)>0||S.damageTotal>0,R=((d=S.activity)==null?void 0:d.uuid)===t.uuid,A=((u=S.item)==null?void 0:u.uuid)===o;(R||A)&&!y&&(a=S)}return a?(c.log("DnDBIntegration._findRecentWorkflowForItem - Found workflow without damage",[a.id,"activity:",(f=a.activity)==null?void 0:f.name,"item:",(g=a.item)==null?void 0:g.name,"state:",a.currentAction]),a):this._findWorkflowFromRecentChat(e,t)}static _findWorkflowFromRecentChat(e,t){var a,i,n;if(!(t!=null&&t.item))return null;const s=t.item.uuid,o=game.messages.contents.slice(-20).reverse();for(const r of o){const l=(a=r.flags)==null?void 0:a["midi-qol"];if(!l)continue;const d=l.itemUuid;if(d!==s||((i=l.damageRolls)==null?void 0:i.length)>0||l.damageTotal>0)continue;c.log("DnDBIntegration._findWorkflowFromRecentChat - Found candidate message",[r.id,"itemUuid:",d]);const f=e.Workflow.getWorkflow(r.uuid);if(f)return c.log("DnDBIntegration._findWorkflowFromRecentChat - Reconstructed workflow from chat",[f.id,"item:",(n=f.item)==null?void 0:n.name,"suspended:",f.suspended]),f}return null}static async _executeDamageExistingWorkflow(e,t,s){this.setPendingRoll(t);const o={workflow:s,midiOptions:{fastForwardDamage:!0,isCritical:s.isCritical,workflowOptions:{fastForwardDamage:!0,autoRollDamage:"always"},...s.rollOptions}},a={configure:!1},i={create:!1};try{return await e.rollDamage(o,a,i),!0}catch(n){return c.error("DnDBIntegration._executeDamageExistingWorkflow failed",[n]),this.clearPendingRoll(),!1}}static async _executeDamageAttachToWorkflow(e,t,s){var r,l;this.setPendingRoll(t);const o=s.currentAction===s.WorkflowState_Completed||s.currentAction===s.WorkflowState_RollFinished;c.log("DnDBIntegration._executeDamageAttachToWorkflow - Entry",["workflowId:",s.id,"isWorkflowCompleted:",o,"currentAction:",(r=s.currentAction)==null?void 0:r.name,"suspended:",s.suspended]);const a=o?{}:{workflow:s,midiOptions:{fastForwardDamage:!0,isCritical:s.isCritical,workflowOptions:{fastForwardDamage:!0}}},i={configure:!1},n={create:!1};c.log("DnDBIntegration._executeDamageAttachToWorkflow - Calling rollDamage",["rollConfig:",a,"dialogConfig:",i,"messageConfig:",n]);try{const d=await e.rollDamage(a,i,n);return d!=null&&d.length?(c.log("DnDBIntegration._executeDamageAttachToWorkflow - Got damage rolls",["rollCount:",d.length,"workflowId:",s.id,"workflowSuspended:",s.suspended]),typeof s.setDamageRolls=="function"?(await s.setDamageRolls(d),c.log("DnDBIntegration._executeDamageAttachToWorkflow - Used setDamageRolls API",["damageTotal:",s.damageTotal,"hasDamageRollHTML:",!!s.damageRollHTML])):(s.damageRolls=d,s.damageRoll=d[0],s.damageTotal=d.reduce((u,f)=>u+f.total,0),c.log("DnDBIntegration._executeDamageAttachToWorkflow - Set damageRolls directly (fallback)")),await((l=s.displayDamageRolls)==null?void 0:l.call(s)),!0):(c.warn("DnDBIntegration._executeDamageAttachToWorkflow - No rolls returned"),this.clearPendingRoll(),!1)}catch(d){return c.error("DnDBIntegration._executeDamageAttachToWorkflow failed",[d]),this.clearPendingRoll(),!1}}static async _executeDamageNewWorkflow(e,t,s,o={}){var u,f,g,m;const a=qe.getMidiQOL();this.setPendingRoll(s);const i=(f=(u=t.target)==null?void 0:u.template)==null?void 0:f.type;c.log("DnDBIntegration._executeDamageNewWorkflow",["activity:",t.name,"hasTemplate:",i,"templateType:",(m=(g=t.target)==null?void 0:g.template)==null?void 0:m.type]);const r={consume:{resources:!0,spellSlot:!_e.shouldSkipSpellSlotConsumption()},create:{measuredTemplate:!!i,_isDnDBRoll:!0},midiOptions:{fastForwardAttack:!0,fastForwardDamage:!0,autoRollDamage:"always",workflowOptions:{fastForwardAttack:!0,fastForwardDamage:!0,autoRollDamage:"always"}}},l={configure:!1},d={create:!0,data:{flags:{[k]:{isDnDBRoll:!0,ddbCharacterId:s.characterId,ddbSource:s.source}}}};try{return await a.completeActivityUse(t,r,l,d),!0}catch(p){return c.error("DnDBIntegration._executeDamageNewWorkflow failed",[p]),this.clearPendingRoll(),!1}}static async executeHealingWithMidi(e,t,s){var l;const o=qe.getMidiQOL();if(!o)return c.warn("DnDBIntegration: MidiQOL not available for healing"),!1;this.setPendingRoll(s),c.log("DnDBIntegration.executeHealingWithMidi",["activity:",t.name,"item:",(l=t.item)==null?void 0:l.name]);const i={consume:{resources:!0,spellSlot:!_e.shouldSkipSpellSlotConsumption()},midiOptions:{fastForwardAttack:!0,fastForwardDamage:!0,autoRollDamage:"always",workflowOptions:{fastForwardAttack:!0,fastForwardDamage:!0,autoRollDamage:"always"}}},n={configure:!1},r={create:!0,data:{flags:{[k]:{isDnDBRoll:!0,ddbCharacterId:s.characterId,ddbSource:s.source}}}};try{return await o.completeActivityUse(t,i,n,r),!0}catch(d){return c.error("DnDBIntegration.executeHealingWithMidi failed",[d]),this.clearPendingRoll(),!1}}}E(re,"_pendingDnDBRoll",null),E(re,"_waitingForDnDBDamage",!1);class _e{static setPendingDamageRoll(e){this._pendingVanillaDamageRoll=e,c.log("DnDBRollExecutor.setPendingDamageRoll",[e==null?void 0:e.action])}static clearPendingDamageRoll(){this._pendingVanillaDamageRoll=null}static consumePendingDamageRoll(){const e=this._pendingVanillaDamageRoll;return this._pendingVanillaDamageRoll=null,this._isDnDBDamageInProgress=!0,e}static hasPendingDamageRoll(){return this._pendingVanillaDamageRoll!==null}static isDnDBDamageInProgress(){return this._isDnDBDamageInProgress}static clearDnDBDamageInProgress(){this._isDnDBDamageInProgress=!1}static shouldSkipSpellSlotConsumption(){const e=I();return v.get(e.ddbNoAutoConsumeSpellSlot.tag)===!0}static getWhisperRecipients(e,t){if(e===CONST.DICE_ROLL_MODES.PUBLIC)return null;const s=ChatMessage.getWhisperRecipients("GM").map(o=>o.id);if(e===CONST.DICE_ROLL_MODES.PRIVATE){const o=Le(t);if(o&&!s.includes(o.id))return[...s,o.id]}return s}static async execute(e,t,s){if(!e)return c.warn("DnDBRollExecutor: No actor for roll execution"),!1;c.log("DnDBRollExecutor: Executing roll",[s.category,t.action]);try{switch(s.category){case"save":return await this._executeSave(e,t,s);case"abilityCheck":return await this._executeAbilityCheck(e,t,s);case"skill":return await this._executeSkillCheck(e,t,s);case"tool":return await this._executeToolCheck(e,t,s);case"initiative":return await this._executeInitiative(e,t);case"attack":return await this._executeAttack(e,t,s);case"damage":return await this._executeDamage(e,t,s);case"healing":return await this._executeHealing(e,t,s);default:return c.log("DnDBRollExecutor: Unhandled category, creating simple message",[s]),await this._createSimpleMessage(e,t)}}catch(o){return c.error("DnDBRollExecutor: Roll execution failed",[o]),!1}}static async _executeSave(e,t,s){re.setPendingRoll(t);const o=Le(e)||game.user,a=this.getWhisperRecipients(t.rollMode,e),i={ability:s.ability,sendRequest:!1},n={configure:!1},r={create:!0,rollMode:t.rollMode,data:{speaker:ChatMessage.getSpeaker({actor:e}),author:o.id,whisper:a,blind:t.rollMode===CONST.DICE_ROLL_MODES.BLIND,flags:{...this._buildFlags(t),rsr5e:{processed:!0,quickRoll:!1}}}},l=await e.rollSavingThrow(i,n,r);return!l||l.length<1?(re.clearPendingRoll(),!1):!0}static async _executeAbilityCheck(e,t,s){re.setPendingRoll(t);const o=Le(e)||game.user,a=this.getWhisperRecipients(t.rollMode,e),i={ability:s.ability,sendRequest:!1},n={configure:!1},r={create:!0,rollMode:t.rollMode,data:{speaker:ChatMessage.getSpeaker({actor:e}),author:o.id,whisper:a,blind:t.rollMode===CONST.DICE_ROLL_MODES.BLIND,flags:{...this._buildFlags(t),rsr5e:{processed:!0,quickRoll:!1}}}},l=await e.rollAbilityCheck(i,n,r);return!l||l.length<1?(re.clearPendingRoll(),!1):!0}static async _executeSkillCheck(e,t,s){re.setPendingRoll(t);const o=Le(e)||game.user,a=this.getWhisperRecipients(t.rollMode,e),i={skill:s.skill,sendRequest:!1},n={configure:!1},r={create:!0,rollMode:t.rollMode,data:{speaker:ChatMessage.getSpeaker({actor:e}),author:o.id,whisper:a,blind:t.rollMode===CONST.DICE_ROLL_MODES.BLIND,flags:{...this._buildFlags(t),rsr5e:{processed:!0,quickRoll:!1}}}},l=await e.rollSkill(i,n,r);return!l||l.length<1?(re.clearPendingRoll(),!1):!0}static async _executeToolCheck(e,t,s){const o=s.tool;if(!o)return await this._executeAbilityCheck(e,t,{ability:"dex"});re.setPendingRoll(t);const a=Le(e)||game.user,i=this.getWhisperRecipients(t.rollMode,e),n={sendRequest:!1},r={configure:!1},l={create:!0,rollMode:t.rollMode,data:{speaker:ChatMessage.getSpeaker({actor:e}),author:a.id,whisper:i,blind:t.rollMode===CONST.DICE_ROLL_MODES.BLIND,flags:{...this._buildFlags(t),rsr5e:{processed:!0,quickRoll:!1}}}},d={...n,ability:o.system.ability,bonus:o.system.bonus,prof:o.system.prof,item:o,tool:o.system.type.baseItem},u=await e.rollToolCheck(d,r,l);return!u||u.length<1?(re.clearPendingRoll(),!1):!0}static async _executeInitiative(e,t){var g,m,p,S,y,R;const s=t.rawRolls[0],o=((g=s.result)==null?void 0:g.total)||0;let a=game.combat;if(!a)if(game.user.isGM&&canvas.scene)a=await getDocumentClass("Combat").create({scene:canvas.scene.id,active:!0});else return ui.notifications.warn("COMBAT.NoneActive",{localize:!0}),!1;let i=e,n=null;e.isToken?n=((m=e.token)==null?void 0:m.object)||canvas.tokens.get((p=e.token)==null?void 0:p.id):(n=canvas.tokens.placeables.find(A=>{var _;return((_=A.actor)==null?void 0:_.id)===e.id}),n&&(i=n.actor));let r=a.getCombatantsByActor(i);r.length===0&&n&&(await a.createEmbeddedDocuments("Combatant",[{tokenId:n.id,sceneId:((S=n.scene)==null?void 0:S.id)||((y=canvas.scene)==null?void 0:y.id),actorId:e.id,hidden:((R=n.document)==null?void 0:R.hidden)||!1}]),r=a.getCombatantsByActor(i)),r.length>0&&await r[0].update({initiative:o});const l=e.getInitiativeRoll();if(!l)return!0;await l.evaluate(),St.injectDnDBDiceValues(l,s);const d=Le(e)||game.user,u=this.getWhisperRecipients(t.rollMode,e),f={speaker:ChatMessage.getSpeaker({actor:e}),author:d.id,flavor:this._buildFlavor(t,"initiative"),whisper:u,blind:t.rollMode===CONST.DICE_ROLL_MODES.BLIND,flags:{...this._buildFlags(t),rsr5e:{processed:!0,quickRoll:!1}}};return await l.toMessage(f,{rollMode:t.rollMode}),!0}static async _executeAttack(e,t,s){const o=Ge.findItemByAction(e,s.action);if(!o)return c.warn("DnDBRollExecutor: Item not found for attack",[s.action]),await this._createSimpleMessage(e,t);const a=Ge.getActivityFromItem(o,"attack");return a?re.isActive()?(c.log("DnDBRollExecutor._executeAttack - Using Midi-QOL workflow"),await re.executeAttackWithMidi(e,a,t)):await this._executeAttackVanilla(e,o,a,t):(c.warn("DnDBRollExecutor: No attack activity found",[o.name]),await this._createSimpleMessage(e,t))}static async _executeAttackVanilla(e,t,s,o){re.setPendingRoll(o);const a=o.rawRolls[0],i={configure:!1},n=qt(),r={subsequentActions:!1,consume:{resources:!1,spellSlot:!1},target:n.length===1?n[0].ac:void 0,sendRequest:!1,flags:{...this._buildFlags(o),dnd5e:{roll:{type:"attack"}}}},l=s.metadata.usage.chatCard;s.metadata.usage.chatCard=`modules/${k}/templates/ddb-attack-card.hbs`;const d=await s.rollAttack(r,i,{create:!1,data:{speaker:ChatMessage.getSpeaker({actor:e}),targets:n,flags:{...this._buildFlags(o),dnd5e:{targets:n}}}});if(!d||d.length<1)return s.metadata.usage.chatCard=l,!1;St.injectDnDBDiceValues(d[0],a),c.log("DnDBRollExecutor._executeAttackVanilla - after inject",[d[0]]);const u={subsequentActions:!1,consume:{resources:!1,spellSlot:!1}},f=await Zt.ddbUse(s,u,i,{create:!1,data:{rolls:[d[0]],speaker:ChatMessage.getSpeaker({actor:e}),flavor:`${t.name}: ${game.i18n.localize("DND5E.Attack")}`,targets:n,flags:{...this._buildFlags(o),dnd5e:{roll:{type:"attack"},targets:n},rsr5e:{processed:!0,quickRoll:!1}}}});if(s.metadata.usage.chatCard=l,!(f!=null&&f.message))return c.warn("DnDBRollExecutor: ddbUse returned no message"),!1;const g=Le(e)||game.user,m=this.getWhisperRecipients(o.rollMode,e);f.message.flags=f.message.flags??{},f.message.author=g.id,m&&(f.message.whisper=m),o.rollMode===CONST.DICE_ROLL_MODES.BLIND&&(f.message.blind=!0);const p=await ChatMessage.implementation.create(f.message,{rollMode:o.rollMode});return c.log("DnDBRollExecutor._executeAttackVanilla - created card",[p]),!0}static async _executeDamage(e,t,s){c.log("DnDBRollExecutor._executeDamage - Entry",["action:",s.action,"isGM:",game.user.isGM]);const o=Ge.findItemByAction(e,s.action);if(!o)return c.warn("DnDBRollExecutor: Item not found for damage",[s.action]),await this._createSimpleMessage(e,t);const a=Ge.getActivityFromItem(o,"damage");if(!a)return c.warn("DnDBRollExecutor: No damage activity found",[o.name]),await this._createSimpleMessage(e,t);if(re.isActive()){if(c.log("DnDBRollExecutor._executeDamage - Checking Midi-QOL workflow routing",["isGM:",game.user.isGM]),await re.executeDamageWithMidi(e,a,t))return!0;c.log("DnDBRollExecutor._executeDamage - Midi returned false, using vanilla flow",["isGM:",game.user.isGM])}return await this._executeDamageVanilla(e,o,a,t)}static async _executeDamageVanilla(e,t,s,o){var m,p,S;const a={configure:!1},i=Le(e)||game.user,n=(p=(m=s.target)==null?void 0:m.template)==null?void 0:p.type;if(!s.attack){c.log("DnDBRollExecutor: Damage-only activity (SAVE), setting pending roll and triggering usage",["item:",t.name,"hasTemplate:",n]),this.setPendingDamageRoll(o);const y=!this.shouldSkipSpellSlotConsumption(),R=this.getWhisperRecipients(o.rollMode,e),A={subsequentActions:!1,consume:{resources:!0,spellSlot:y},create:{measuredTemplate:!!n,_isDnDBRoll:!0}};c.log("DnDBRollExecutor: About to call ddbUse (will wait for template if needed)");const _=await Zt.ddbUse(s,A,a,{create:!0,rollMode:o.rollMode,data:{rolls:[],speaker:ChatMessage.getSpeaker({actor:e}),author:i.id,whisper:R,blind:o.rollMode===CONST.DICE_ROLL_MODES.BLIND,flags:{...this._buildFlags(o),rsr5e:{processed:!0,quickRoll:!1}}}});return c.log("DnDBRollExecutor: ddbUse completed",["templates:",(S=_==null?void 0:_.templates)==null?void 0:S.length]),!0}re.setPendingRoll(o);const r=o.rawRolls[0],l=qt();c.log("DnDBRollExecutor: Rolling damage via activity (attack activity)",["targets:",l.length]);const d={sendRequest:!1},u=await s.rollDamage(d,a,{create:!1,data:{speaker:ChatMessage.getSpeaker({actor:e}),targets:l,flags:{...this._buildFlags(o),dnd5e:{targets:l}}}});if(!u||u.length<1)return c.warn("DnDBRollExecutor: rollDamage returned no rolls"),!1;St.injectDnDBDiceValues(u[0],r),c.log("DnDBRollExecutor: Creating damage message with targets");const f=this.getWhisperRecipients(o.rollMode,e),g={speaker:ChatMessage.getSpeaker({actor:e}),author:i.id,flavor:`${t.name} - ${s.damageFlavor}`,whisper:f,blind:o.rollMode===CONST.DICE_ROLL_MODES.BLIND,flags:{...this._buildFlags(o),dnd5e:{...s.messageFlags,messageType:"roll",roll:{type:"damage"},targets:l},rsr5e:{processed:!0,quickRoll:!1}}};return await u[0].toMessage(g,{rollMode:o.rollMode}),c.log("DnDBRollExecutor: Damage message created"),!0}static async _executeHealing(e,t,s){const o=Ge.findItemByAction(e,s.action);if(!o)return c.warn("DnDBRollExecutor: Item not found for healing",[s.action]),await this._createSimpleMessage(e,t);const a=Ge.getActivityFromItem(o,"heal");return a?re.isActive()?(c.log("DnDBRollExecutor._executeHealing - Using Midi-QOL workflow"),await re.executeHealingWithMidi(e,a,t)):await this._executeHealingVanilla(e,o,a,t):(c.warn("DnDBRollExecutor: No heal activity found",[o.name]),await this._createSimpleMessage(e,t))}static async _executeHealingVanilla(e,t,s,o){re.setPendingRoll(o);const a=o.rawRolls[0],i={configure:!1},n=Le(e)||game.user;c.log("DnDBRollExecutor: Healing activity (vanilla), triggering usage first",[t.name]);const r=!this.shouldSkipSpellSlotConsumption(),l=this.getWhisperRecipients(o.rollMode,e),d={subsequentActions:!1,consume:{resources:!0,spellSlot:r}};await Zt.ddbUse(s,d,i,{create:!0,rollMode:o.rollMode,data:{rolls:[],speaker:ChatMessage.getSpeaker({actor:e}),author:n.id,whisper:l,blind:o.rollMode===CONST.DICE_ROLL_MODES.BLIND,flags:{...this._buildFlags(o),rsr5e:{processed:!0,quickRoll:!1}}}});const u=qt(),f={sendRequest:!1},g=await s.rollDamage(f,i,{create:!1,data:{speaker:ChatMessage.getSpeaker({actor:e}),targets:u,flags:{...this._buildFlags(o),dnd5e:{targets:u}}}});if(!g||g.length<1)return!1;St.injectDnDBDiceValues(g[0],a);const m={speaker:ChatMessage.getSpeaker({actor:e}),author:n.id,flavor:`${t.name}: ${game.i18n.localize("DND5E.Healing")}`,whisper:l,blind:o.rollMode===CONST.DICE_ROLL_MODES.BLIND,flags:{...this._buildFlags(o),dnd5e:{roll:{type:"damage"},targets:u},rsr5e:{processed:!0,quickRoll:!1}}};return await g[0].toMessage(m,{rollMode:o.rollMode}),!0}static async createSimpleRollMessage(e){return this._createSimpleMessage(null,e)}static async _createSimpleMessage(e,t){var d;const s=e?ChatMessage.getSpeaker({actor:e}):{alias:t.characterName},o=(d=t.rawRolls)==null?void 0:d[0];if(o){const u=St.createRollFromDnDB(o);if(u){const f=e&&Le(e)||game.user,g=this.getWhisperRecipients(t.rollMode,e),m=Ge.getRollTypeLabel(t.rollType),p=m?`${t.action}: ${m}`:t.action;return await u.toMessage({speaker:s,author:f.id,flavor:p,whisper:g,blind:t.rollMode===CONST.DICE_ROLL_MODES.BLIND,flags:{...this._buildFlags(t),rsr5e:{processed:!0,quickRoll:!1}}},{rollMode:t.rollMode}),!0}}const a=t.diceResults.map(u=>`<span class="die d${u.type.replace("d","")}">${u.value}</span>`).join(" "),i=Ge.getRollTypeLabel(t.rollType),n=`
      <div class="ddb-roll flash5e-ddb-roll">
        <div class="roll-header">
          <span class="roll-action">${t.action}</span>
          ${i?`<span class="roll-type">${i}</span>`:""}
        </div>
        <div class="roll-content">
          <div class="dice-results">${a}</div>
          <div class="roll-formula">${t.formula}</div>
          <div class="roll-total">${t.total}</div>
        </div>
      </div>
    `,r=e&&Le(e)||game.user,l=this.getWhisperRecipients(t.rollMode,e);return await ChatMessage.create({speaker:s,author:r.id,content:n,whisper:l,blind:t.rollMode===CONST.DICE_ROLL_MODES.BLIND,flags:{...this._buildFlags(t),rsr5e:{processed:!0,quickRoll:!1}}},{rollMode:t.rollMode}),!0}static _buildFlavor(e,t){var i;const s=e.isAdvantage?` (${game.i18n.localize("DND5E.Advantage")})`:e.isDisadvantage?` (${game.i18n.localize("DND5E.Disadvantage")})`:"",o=e.action,a=o.toLowerCase();if(t==="save"){const n=Object.entries(CONFIG.DND5E.abilities).find(([r,l])=>{var d;return r===a||((d=l.label)==null?void 0:d.toLowerCase())===a});if(n)return`${n[1].label} ${game.i18n.localize("DND5E.ActionSave")}${s}`}if(t==="check"){const n=Object.entries(CONFIG.DND5E.abilities).find(([r,l])=>{var d;return r===a||((d=l.label)==null?void 0:d.toLowerCase())===a});if(n)return game.i18n.format("DND5E.AbilityPromptTitle",{ability:n[1].label})+s}if(t==="skill"){const n=Object.entries(CONFIG.DND5E.skills).find(([r,l])=>{var d;return r===a||((d=l.label)==null?void 0:d.toLowerCase())===a});if(n){const r=n[1].ability,l=((i=CONFIG.DND5E.abilities[r])==null?void 0:i.label)||r;return game.i18n.format("DND5E.SkillPromptTitle",{skill:n[1].label,ability:l})+s}}return t==="initiative"?game.i18n.localize("DND5E.Initiative")+s:`${o}${s}`}static _buildFlags(e){return{[k]:{isDnDBRoll:!0,ddbCharacterId:e.characterId,ddbSource:e.source,rollType:e.rollType,action:e.action},rsr5e:{processed:!0,quickRoll:!1}}}}E(_e,"_pendingVanillaDamageRoll",null),E(_e,"_isDnDBDamageInProgress",!1);const P={addSituationalBonus(h,e,t=!0){var s;return c.log("Config before adding bonus:",[e,h,t]),e&&((s=h.rolls)!=null&&s[0])&&(h.rolls[0].parts||(h.rolls[0].parts=[]),h.rolls[0].data||(h.rolls[0].data={}),h.rolls[0].data.situational=e,t&&!h.rolls[0].parts.includes("@situational")&&h.rolls[0].parts.push("@situational"),c.log("Config after adding bonus:",[h])),h},async unsetActivityFlag(h){if(!game.user.isGM||!h)return;const e=h.getFlag(k,"tempActivityConfig");e&&(c.log("updateActivityConfigFlag - cleaning up existing config",[e]),await h.unsetFlag(k,"tempActivityConfig"))},async updateActivityConfigFlag(h,e){c.log("updateActivityConfigFlag - storing new activity config",[e]),await h.setFlag(k,"tempActivityConfig",e)},buildRollConfig(h,e,t={},s=!0){var n,r,l,d,u,f,g,m,p,S,y;const o={rolls:[{parts:(e==null?void 0:e.parts)??[],data:(e==null?void 0:e.data)??{},options:{...(e==null?void 0:e.options)??{},...((n=e==null?void 0:e.options)==null?void 0:n._fromFlashRolls)&&{_fromFlashRolls:!0}}}],advantage:((r=h==null?void 0:h.config)==null?void 0:r.advantage)||!1,disadvantage:((l=h==null?void 0:h.config)==null?void 0:l.disadvantage)||!1,target:(d=h==null?void 0:h.config)==null?void 0:d.target,subject:null,chatMessage:!0,legacy:!1,sendRequest:(u=h==null?void 0:h.config)==null?void 0:u.sendRequest,skipRollDialog:(f=h==null?void 0:h.config)==null?void 0:f.skipRollDialog,...t};let a=(g=h==null?void 0:h.config)==null?void 0:g.situational;const i=(y=(S=(p=(m=h==null?void 0:h.config)==null?void 0:m.rolls)==null?void 0:p[0])==null?void 0:S.data)==null?void 0:y.situational;return game.user.isGM?(!a&&i&&(a=i),a&&this.addSituationalBonus(o,a,!s)):i?o.rolls[0].data.situational||(o.rolls[0].data.situational=i):a&&this.addSituationalBonus(o,a,!s),this.ensureRollFlags(o,h)},ensureRollFlags(h,e){return h.isRollRequest=!game.user.isGM,h._showRequestedBy=!0,h._requestedBy=e.config.requestedBy||"GM",h},validateActors(h){return!h||h.length===0?null:(typeof h[0]=="string"&&(h=h.map(e=>game.actors.get(e)).filter(e=>e)),h.length>0?h:null)},getRollClass(h){const e=h==null?void 0:h.toLowerCase();return[L.DAMAGE,L.HEALING].includes(e)?CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:[L.FORMULA,L.CUSTOM,L.HIT_DIE].includes(e)?CONFIG.Dice.BasicRoll:CONFIG.Dice.D20Roll},shouldShowDC(h){const e=h==null?void 0:h.toLowerCase();return[L.SAVE,L.SAVING_THROW,L.ABILITY,L.ABILITY_CHECK,L.CONCENTRATION,L.SKILL,L.TOOL].includes(e)},createBaseRollConfig(h,e,t){const s=e==null?void 0:e.toLowerCase(),o={data:h.getRollData(),subject:h,rolls:[{parts:[],data:h.getRollData(),options:{}}]};switch(s){case L.SKILL:o.skill=t;break;case L.TOOL:o.tool=t;break;case L.SAVE:case L.SAVING_THROW:case L.ABILITY:case L.ABILITY_CHECK:o.ability=t;break;case L.HIT_DIE:o.rolls[0].options.flavor="Hit Die";break}return o},createMessageConfig(h,e=null){const t={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:h})}};return e&&(t.rollMode=e),t},async triggerRollDialog(h,e,t,s){const o=new h(e,t,s);return await new Promise(i=>{o.addEventListener("close",()=>{i({rolls:o.rolls,config:o.config,message:o.message,sendRequest:o.sendRequest,critical:o.config.critical,isCritical:o.config.isCritical})},{once:!0}),o.render({force:!0})})},processDialogResult(h,e,t,s,o={}){var p,S,y,R,A,_,T;if(!(h!=null&&h.rolls)||h.rolls.length===0)return null;const a=t==null?void 0:t.toLowerCase(),i=h.rolls[0];let n=!1,r=!1;((p=i==null?void 0:i.options)==null?void 0:p.advantageMode)!==void 0&&(n=i.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,r=i.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const l=((S=i==null?void 0:i.data)==null?void 0:S.situational)||"",d=(y=i==null?void 0:i.options)==null?void 0:y.target,u={rolls:[{parts:((R=i==null?void 0:i.parts)==null?void 0:R.slice())||[],data:l?{situational:l}:{},options:d?{target:d}:{}}],subject:e[0],advantage:n,disadvantage:r,target:d,situationalBonus:l||"",sendRequest:h.sendRequest,isRollRequest:h.sendRequest,skipRollDialog:((A=h.config)==null?void 0:A.skipRollDialog)||o.skipRollDialog||!1,chatMessage:!0},f=I(),g=v.get(f.publicPlayerRolls.tag)===!0,m=this.determineRollMode(g,(_=h.message)==null?void 0:_.rollMode);return u.rollMode=m,(T=h.config)!=null&&T.ability&&[L.SKILL,L.TOOL].includes(a)&&(u.ability=h.config.ability),u},determineRollMode(h,e){return e||game.settings.get("core","rollMode")},isPlayerOwned(h){return Object.entries(h.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})},isPlayerOwnerActive(h){const e=Le(h);return e&&e.active},calculateStandardRule(h,e){const t=h.filter(a=>a.total>=e).length,s=h.length-t,o=Math.ceil(h.length/2);return{finalResult:t>=o,successes:t,failures:s,summary:game.i18n.format("FLASH_ROLLS.groupRoll.standardRule.summary",{successes:t,total:h.length,threshold:o}),method:"Standard Rule"}},calculateGroupAverage(h,e){const t=h.reduce((o,a)=>o+a.total,0),s=Math.floor(t/h.length);return{finalResult:s,average:s,success:s>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.groupAverage.summary",{average:s,dc:e}),method:"Group Average"}},calculateLeaderWithHelp(h,e,t,s,o){var S;let a=-999,i=-1,n=null,r=0;for(let y=0;y<h.length;y++){const R=h[y],A=t.find(T=>T.id===R.actorId);if(!A)continue;const _=this._getActorModifier(A,s,o);_>a&&(a=_,i=y,n=A.id,r=_)}if(i===-1)return{finalResult:0,error:"No leader found",method:"Leader with Help"};const l=h[i],d=h.filter((y,R)=>R!==i),u=d.filter(y=>y.total>=e).length,f=d.filter(y=>y.total<e).length,g=l.total+u-f;let m,p={leaderRoll:l.total,adjustedResult:g,dc:e};return u>0&&f>0?(m="FLASH_ROLLS.groupRoll.leaderWithHelp.summary",p.bonus=u,p.penalty=f):u>0?(m="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlySuccess",p.bonus=u,p.successWord=u===1?game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.successPlural")):f>0?(m="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlyFailure",p.penalty=f,p.failureWord=f===1?game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.failureSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.failurePlural")):m="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryNoModifiers",{finalResult:g,leaderRoll:l.total,leaderName:(S=t.find(y=>y.id===n))==null?void 0:S.name,leaderActorId:n,leaderModifier:r,bonus:u,penalty:f,success:g>=e,summary:game.i18n.format(m,p),method:"Leader with Help"}},calculateWeakestLink(h,e,t,s,o){var f;let a=999,i=null,n=0;for(const g of t){const m=this._getActorModifier(g,s,o);m<a&&(a=m,i=g.id,n=m)}const r=h.find(g=>g.actorId===i);if(!r)return{finalResult:0,error:"Weakest link actor did not roll",method:"Weakest Link"};const l=h.filter(g=>g.actorId!==i&&g.total>=e).length,d=r.total+l,u=l===1?game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successPlural");return{finalResult:d,weakestRoll:r.total,weakestName:(f=t.find(g=>g.id===i))==null?void 0:f.name,weakestActorId:i,weakestModifier:n,bonus:l,success:d>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.weakestLink.summary",{weakestRoll:r.total,bonus:l,successWord:u,adjustedResult:d,dc:e}),method:"Weakest Link"}},_getActorModifier(h,e,t){var o,a,i,n,r,l,d;switch(e==null?void 0:e.toLowerCase()){case L.SKILL:return((o=h.system.skills[t])==null?void 0:o.total)||((a=h.system.skills[t])==null?void 0:a.mod)||0;case L.SAVE:case L.SAVING_THROW:return((n=(i=h.system.abilities[t])==null?void 0:i.save)==null?void 0:n.value)||((r=h.system.abilities[t])==null?void 0:r.save)||0;case L.ABILITY:case L.ABILITY_CHECK:return((l=h.system.abilities[t])==null?void 0:l.mod)||0;case L.TOOL:if((d=h.system.tools)!=null&&d[t])return h.system.tools[t].total||h.system.tools[t].mod||0;const u=h.items.find(f=>f.type==="tool"&&f.system.toolType===t);return(u==null?void 0:u.system.bonus)||0;default:return 0}},getGroupResult(h,e,t,s,o){if(!h.every(l=>l.total!==null&&l.total!==void 0))return{complete:!1,success:!1,result:0};const i=I(),n=v.get(i.groupRollResultMode.tag)||1;let r;switch(n){case 1:return r=this.calculateStandardRule(h,e),{complete:!0,success:r.finalResult,result:r.finalResult?1:0,details:r};case 2:return r=this.calculateGroupAverage(h,e),{complete:!0,success:r.success,result:r.finalResult,details:r};case 3:return r=this.calculateLeaderWithHelp(h,e,t,s,o),{complete:!0,success:r.success,result:r.finalResult,details:r};case 4:return r=this.calculateWeakestLink(h,e,t,s,o),{complete:!0,success:r.success,result:r.finalResult,details:r};default:return r=this.calculateStandardRule(h,e),{complete:!0,success:r.finalResult,result:r.finalResult?1:0,details:r}}},consolidateRolls(h){var o,a,i,n,r,l,d,u;if(c.log("RollHelpers.consolidateRolls - BEFORE",[h]),!h||h.length<=1||h._consolidated)return h;const e=((a=(o=h[0])==null?void 0:o.options)==null?void 0:a.type)||((n=(i=h[0])==null?void 0:i.data)==null?void 0:n.damageType);if(e)for(let f=1;f<h.length;f++){const g=((l=(r=h[f])==null?void 0:r.options)==null?void 0:l.type)||((u=(d=h[f])==null?void 0:d.data)==null?void 0:u.damageType);if(g&&g!==e)return c.log("RollHelpers.consolidateRolls - Different damage types detected, skipping consolidation",[e,g]),h}const t=h[0];for(let f=1;f<h.length;f++)if(h[f]){const g=h[f];if(g.parts&&Array.isArray(g.parts)){t.parts=t.parts||[];for(const m of g.parts)t.parts.includes(m)||t.parts.push(m)}if(g.data&&typeof g.data=="object"){t.data=t.data||{};for(const[m,p]of Object.entries(g.data))m in t.data||(t.data[m]=p)}if(g.options&&typeof g.options=="object"){t.options=t.options||{};for(const[m,p]of Object.entries(g.options))m in t.options||(t.options[m]=p)}}const s=[t];return s._consolidated=!0,c.log("RollHelpers.consolidateRolls - AFTER",[s]),s},shouldDisplayChallengeForPlayer(h){var s;if(game.user.isGM)return!0;const e=h._requestedBy;if(e===game.user.name)return!0;switch(game.settings.get("dnd5e","challengeVisibility")){case"all":return!0;case"player":return e!==((s=game.users.find(o=>o.isGM))==null?void 0:s.name);default:return!1}},shouldSkipRollDialog({event:h=null,isPC:e=!1,isNPC:t=!1,sendRequest:s=null,hasNonDigitalDice:o=!1,forceSkip:a=!1,forceShow:i=!1,configSendRequest:n=void 0,configSkipRollDialog:r=void 0,isRollRequest:l=!1}={}){return i===!0?!1:a===!0||r===!0||n===!1||l===!0||this._areSkipKeysPressed(h)||o?!0:game.user.isGM?this._shouldSkipDialogGM({isPC:e,isNPC:t,sendRequest:s}):!1},_shouldSkipDialogGM({isPC:h=!1,isNPC:e=!1,sendRequest:t=null}={}){const s=I();if(!v.get(s.skipRollDialog.tag))return!1;const a=v.get(s.skipRollDialogOption.tag),i=v.get(s.rollRequestsEnabled.tag);switch(a){case 1:return c.log("_shouldSkipDialogGM case 1"),!0;case 2:return c.log("_shouldSkipDialogGM case 2"),h===!0&&t===!0||h===!0&&t!==!1&&i===!0;case 3:return c.log("_shouldSkipDialogGM case 3"),e===!0;default:return c.log("_shouldSkipDialogGM case default"),!1}},_areSkipKeysPressed(h){var t;if(!h)return!1;const{areKeysPressed:e}=((t=game.dnd5e)==null?void 0:t.utils)||{};return e?e(h,"skipDialogNormal")||e(h,"skipDialogAdvantage")||e(h,"skipDialogDisadvantage"):h.shiftKey||h.altKey||h.ctrlKey||h.metaKey||!1}};class vs{static async triggerMissingRolls(e,t,s){var i,n,r;c.log("VanillaActivityManager.triggerMissingRolls",[e,t,s]);const o=((n=(i=e.damage)==null?void 0:i.parts)==null?void 0:n.length)>0;e.type===ce.SAVE&&o&&!((r=s.damageRolls)!=null&&r.length)&&(c.log("VanillaActivityManager.triggerMissingRolls - Manually triggering damage/healing roll",[e.type]),await e.rollDamage(t,{},{}))}static async executeActivityRoll(e,t,s,o,a){var u,f,g;c.log("ActivityManager.executeActivityRoll",[e,t,s,o,a]);const i=I();game.user.isGM||v.get(i.placeTemplateForPlayer.tag);const n=e.items.get(s);if(!n){c.error("Item not found on actor",[e,s]);return}let r=(o?(u=n.system.activities)==null?void 0:u.get(o):Me.findActivityForRoll(n,t))||null;if(!r){c.error("Activity not found on item",[n,o,t]);return}const l=t==null?void 0:t.toLowerCase();let d=null;if(r){switch(l){case L.ATTACK:await this.executeAttackActivity(e,r,a);break;case L.DAMAGE:switch(c.log("executeActivityRoll - damage roll #0",[r,a]),d={critical:a.usage.critical||{},situational:a.usage.rolls[0].data.situational||"",rollMode:(f=a.message)==null?void 0:f.rollMode,create:((g=a.message)==null?void 0:g.create)!==!1,scaling:a.usage.scaling,skipRollDialog:a.usage.skipRollDialog,consume:a.usage.consume},a.usage={...a.usage,consume:At(a.usage.consume||{},!0),create:Vt(a.usage.create||{},!0)},await r.item.setFlag(k,"tempDamageConfig",d),c.log("executeActivityRoll - flag set",[d]),r.type===ce.DAMAGE||r.type===ce.SAVE||r!=null&&r.attack,r.type,ce.SAVE,r.type,ce.ATTACK,r.type){case ce.DAMAGE:await this.executeDamageActivity(e,r,a);break;case ce.SAVE:await this.executeSaveActivity(e,r,a);break;case ce.HEAL:await this.executeHealActivity(e,r,a);break;case ce.ATTACK:await this.executeDamagefromAttack(e,r,a,d);break;default:c.error("executeActivityRoll | untracked activity type",[r.type]);break}}return}throw new Error(`No suitable method found for ${l} on item ${n.name}`)}static async executeAttackActivity(e,t,s){var a,i,n,r;c.log("executeAttackActivity",[s]);const o={attackMode:s.usage.attackMode,ammunition:s.usage.ammunition,mastery:s.usage.mastery,situational:(n=(i=(a=s.usage.rolls)==null?void 0:a[0])==null?void 0:i.data)==null?void 0:n.situational,advantage:s.usage.advantage,disadvantage:s.usage.disadvantage,rollMode:(r=s.message)==null?void 0:r.rollMode,skipRollDialog:s.usage.skipRollDialog,consume:s.usage.consume,create:s.usage.create};s.message.create=!0,await t.item.setFlag(k,"tempAttackConfig",o);try{await t.use(s.usage,s.dialog,s.message)}catch(l){c.error("executeAttackActivity - attack roll error",[l])}finally{await t.item.unsetFlag(k,"tempAttackConfig")}}static async executeSaveActivity(e,t,s,o){try{c.log("executeSaveActivity - calling activity use",[t,s]),await t.use(s.usage,s.dialog,s.message)}catch(a){c.error("executeSaveActivity - save roll error",[a])}finally{await t.item.unsetFlag(k,"tempDamageConfig"),await t.item.unsetFlag(k,"tempSaveConfig")}}static async executeDamageActivity(e,t,s){try{c.log("executeDamageActivity - calling damage use",[t,s]),await t.use(s.usage,s.dialog,s.message)}catch(o){c.error("executeDamageActivity - roll error",[o])}finally{await t.item.unsetFlag(k,"tempDamageConfig")}}static async executeHealActivity(e,t,s){try{c.log("executeHealActivity - calling use",[t,s]),await t.use(s.usage,s.dialog,s.message)}catch(o){c.error("executeHealActivity - roll error",[o])}finally{await t.item.unsetFlag(k,"tempDamageConfig")}}static async executeDamagefromAttack(e,t,s,o){await t.rollDamage(o,s.dialog,s.message)}}var kt,Us,$s;class ut{static isActive(){return q.isModuleOn("midi-qol")}static shouldHandleRoll(e){return this.isActive()&&e}static shouldVanillaHandleSaveDamage(e){return!this.isActive()}static shouldPlayerTriggerSaveDamage(e,t){var i,n,r;if(!this.isActive())return!0;const s=((i=e.target)==null?void 0:i.template.count)>0,o=t.create.measuredTemplate!==!0,a=((r=(n=e.target)==null?void 0:n.template)==null?void 0:r.type)==="radius";return s&&o&&!a}static onPreRollAttackV2(e,t,s){c.log("MidiActivityManager.onPreRollAttackV2",[e,t,s])}static onPreRollDamageV2(e,t,s){c.log("MidiActivityManager.onPreRollDamageV2",[e,t,s])}static async onPostUseActivityPlayer(e,t,s){c.log("MidiActivityManager.onPostUseActivityPlayer #0",[e,t,s])}static async triggerMissingRolls(e,t,s){var g,m,p,S,y,R,A;c.log("MidiActivityManager.triggerMissingRolls",[e,t,s]);const o=qe.getMidiQOL();if(!o)return;const a=(m=(g=o.Workflow)==null?void 0:g.getWorkflowByActivityUuid)==null?void 0:m.call(g,e.uuid),i=(a==null?void 0:a.attackRoll)||((p=a==null?void 0:a.attackRolls)==null?void 0:p.length)>0,n=(a==null?void 0:a.damageRoll)||((S=a==null?void 0:a.damageRolls)==null?void 0:S.length)>0,r=X(this,kt,Us).call(this,a);e.type===ce.ATTACK&&!i&&!r&&(c.log("MidiActivityManager.triggerMissingRolls - Manually triggering attack roll"),await e.rollAttack(t,{},{}));const l=((R=(y=e.damage)==null?void 0:y.parts)==null?void 0:R.length)>0,d=(A=e.healing)==null?void 0:A.formula,u=X(this,kt,$s).call(this,a);(e.type===ce.SAVE||e.type===ce.HEAL||e.type===ce.DAMAGE)&&(l||d)&&!n&&!u&&(c.log("MidiActivityManager.triggerMissingRolls - Manually triggering damage/healing roll",[e.type]),await e.rollDamage(t,{},{}))}static async executeActivityRoll(e,t,s,o,a){var l;c.log("MidiActivityManager.executeActivityRoll",[e,t,s,o,a]);const i=e.items.get(s);if(!i){c.error("Item not found on actor",[e,s]);return}const n=o?(l=i.system.activities)==null?void 0:l.get(o):null;if(!n){c.error("Activity not found on item",[i,o]);return}switch(t==null?void 0:t.toLowerCase()){case L.ATTACK:await this.executeAttackActivity(e,n,a);break;case L.DAMAGE:await this.executeDamageActivity(e,n,a);break;case L.ITEM_SAVE:await this.executeSaveActivity(e,n,a);break;default:c.warn("MidiActivityManager: Unhandled roll type",[t]);break}}static async executeAttackActivity(e,t,s){var a,i,n,r;c.log("MidiActivityManager.executeAttackActivity",[t,s]);const o={attackMode:s.usage.attackMode,ammunition:s.usage.ammunition,mastery:s.usage.mastery,situational:(n=(i=(a=s.usage.rolls)==null?void 0:a[0])==null?void 0:i.data)==null?void 0:n.situational,advantage:s.usage.advantage,disadvantage:s.usage.disadvantage,rollMode:(r=s.message)==null?void 0:r.rollMode,skipRollDialog:s.usage.skipRollDialog,consume:s.usage.consume,create:s.usage.create};s.message.create=!0,await t.item.setFlag(k,"tempAttackConfig",o);try{s.usage.consume=At(s.usage.consume||{},!0),await this.completeActivityUse(t,s.usage,s.dialog,s.message)}catch(l){c.error("MidiActivityManager.executeAttackActivity - error",[l])}finally{await t.item.unsetFlag(k,"tempAttackConfig")}}static async executeDamageActivity(e,t,s){var i,n,r,l,d,u,f;c.log("MidiActivityManager.executeDamageActivity",[t,s]);const o=t.type===ce.ATTACK&&s.usage.rollType===L.DAMAGE,a={critical:s.usage.critical||{},situational:((r=(n=(i=s.usage.rolls)==null?void 0:i[0])==null?void 0:n.data)==null?void 0:r.situational)||"",rollMode:(l=s.message)==null?void 0:l.rollMode,create:((d=s.message)==null?void 0:d.create)!==!1,scaling:s.usage.scaling,skipRollDialog:s.usage.skipRollDialog,consume:s.usage.consume};if(o){const g=qe.getMidiQOL(),m=(f=(u=g==null?void 0:g.Workflow)==null?void 0:u.getWorkflowByActivityUuid)==null?void 0:f.call(u,t.uuid),p={...a,workflow:m,midiOptions:this.prepareDamageMidiOptions(s.usage.skipRollDialog)},S=m?{create:!1}:s.message;try{c.log("executeDamageActivity - case #1"),await t.rollDamage(p,s.dialog,S)}catch(y){c.error("MidiActivityManager.executeDamageActivity - error",[y])}}else{s.usage._rollType=L.DAMAGE,s.usage={...s.usage,consume:At(s.usage.consume||{},!0),create:Vt(s.usage.create||{},!0)},await t.item.setFlag(k,"tempDamageConfig",a);try{c.log("executeDamageActivity - case #2"),await this.completeActivityUse(t,s.usage,s.dialog,s.message)}catch(g){c.error("MidiActivityManager.executeDamageActivity - error",[g])}finally{await t.item.unsetFlag(k,"tempDamageConfig")}}}static async executeSaveActivity(e,t,s){c.log("MidiActivityManager.executeSaveActivity",[t,s]);try{s.usage.consume=At(s.usage.consume||{},!0),await this.completeActivityUse(t,s.usage,s.dialog,s.message)}catch(o){c.error("MidiActivityManager.executeSaveActivity - error",[o])}finally{await t.item.unsetFlag(k,"tempDamageConfig"),await t.item.unsetFlag(k,"tempSaveConfig")}}static async completeActivityUse(e,t={},s={},o={}){c.log("MidiActivityManager.completeActivityUse #0",[e,t,s,o]);const a=this.prepareUsageConfig(e,t);return c.log("MidiActivityManager.completeActivityUse #1",[a]),await MidiQOL.completeActivityUse(e,a,s,o)}static onPreUseActivityPlayer(e,t,s,o){var r,l;const a=I(),i=v.get(a.placeTemplateForPlayer.tag),n=(l=(r=e.target)==null?void 0:r.template)==null?void 0:l.type;if(i&&n&&t.templateUuid){const d=t.workflow;d&&(d.templateUuid=t.templateUuid,c.log("MidiActivityManager.onPreUseActivityPlayer - Template configured on workflow",[d.id,t.templateUuid]))}}static prepareDamageMidiOptions(e=!1){const t=I(),s=v.get(t.skipRollDialog.tag),o=e??s??!1;return{fastForwardDamage:!game.user.isGM?!1:o,autoRollDamage:"onHit",workflowOptions:{autoRollDamage:"onHit"}}}static prepareUsageConfig(e,t={}){var u,f;const s=I(),o=v.get(s.skipRollDialog.tag),a=t.skipRollDialog??o??!1,i=!game.user.isGM,r=t._rollType===L.DAMAGE||e.type===ce.SAVE||e.type===ce.HEAL||e.type===ce.DAMAGE||e.type===ce.ATTACK&&!e.attack;v.get(s.placeTemplateForPlayer.tag),(f=(u=e.target)==null?void 0:u.template)==null||f.type;const l={...t.midiOptions,fastForwardAttack:i?!1:a,fastForwardDamage:i&&r?!1:a,autoRollAttack:!0,workflowOptions:{autoRollAttack:!0,...r&&{autoRollDamage:"onHit"}}};return r&&(l.autoRollDamage="onHit"),{...t,...{consume:{action:!1,resources:[],spellSlot:!1},midiOptions:l}}}}kt=new WeakSet,Us=function(e){var o,a;if(e!=null&&e.systemCard)return!1;if(((o=e==null?void 0:e.workflowOptions)==null?void 0:o.autoRollAttack)!==void 0)return e.workflowOptions.autoRollAttack;const t=qe.getMidiQOL(),s=t==null?void 0:t.currentConfigSettings;return s?(a=game.user)!=null&&a.isGM?s.gmAutoAttack:s.autoRollAttack:!1},$s=function(e){var a,i;if((a=e==null?void 0:e.workflowOptions)!=null&&a.autoRollDamage)return e.workflowOptions.autoRollDamage!=="none";const t=qe.getMidiQOL(),s=t==null?void 0:t.currentConfigSettings;return s?((i=game.user)!=null&&i.isGM?s.gmAutoDamage:s.autoRollDamage)!=="none":!1},fe(ut,kt);class Me{static get isMidiActive(){return this._isMidiActive===null&&(this._isMidiActive=q.isModuleOn("midi-qol")),this._isMidiActive}static resetMidiCache(){this._isMidiActive=null}static findActivityForRoll(e,t){var a;if(!((a=e==null?void 0:e.system)!=null&&a.activities))return null;const s=e.system.activities;switch(t==null?void 0:t.toLowerCase()){case L.ATTACK:const i=s.getByType("attack");return(i==null?void 0:i[0])||null;case L.DAMAGE:const n=s.getByType("attack");if((n==null?void 0:n.length)>0)return n[0];const r=s.getByType("damage");if((r==null?void 0:r.length)>0)return r[0];const l=s.getByType("save");if((l==null?void 0:l.length)>0)return l[0];const d=s.getByType("heal");return(d==null?void 0:d.length)>0?d[0]:null;case L.ITEM_SAVE:const u=s.getByType("save");return(u==null?void 0:u[0])||null;default:return null}}static getActivitiesByType(e,t){var s;return(s=e==null?void 0:e.system)!=null&&s.activities?e.system.activities.getByType(t):[]}static hasActivityForRoll(e,t){return c.log("hasActivityForRoll",[e,t]),!!this.findActivityForRoll(e,t)}static getActivityDisplayInfo(e){return c.log("getActivityDisplayInfo",[e]),e?{name:e.name||e.constructor.metadata.label,type:e.type,icon:e.constructor.metadata.icon,canAttack:e.type==="attack",canDamage:["attack","damage","save"].includes(e.type),canSave:e.type==="save"}:null}static getDamageFormula(e){var s,o;if(c.log("getDamageFormula",[e]),!((o=(s=e==null?void 0:e.damage)==null?void 0:s.parts)!=null&&o.length))return null;const t=e.damage.parts.map(a=>a.formula).filter(a=>a);return t.length>0?t.join(" + "):null}static async executeActivityRoll(e,t,s,o,a){return c.log("BaseActivityManager.executeActivityRoll - routing",[this.isMidiActive?"Midi":"Vanilla"]),this.isMidiActive?await ut.executeActivityRoll(e,t,s,o,a):await vs.executeActivityRoll(e,t,s,o,a)}static onPreUseActivityGM(e,t,s,o){c.log("BaseActivityManager.onPreUseActivityGM #0",[e,t,s,o]);const a=I(),i=v.get(a.rollRequestsEnabled.tag),n=v.get(a.rollInterceptionEnabled.tag);if(!i||!n)return;const r=e.actor,l=q.getActorOwner(r),d=cs(r)&&l.active,u=!d||t.isRollRequest===!1;if(c.log("BaseActivityManager.onPreUseActivityGM - Roll determination",{isMidiActive:this.isMidiActive,isPlayerActor:d,isLocalRoll:u,actorName:r==null?void 0:r.name,ownerActive:l==null?void 0:l.active,isRollRequest:t.isRollRequest}),u){c.log("BaseActivityManager.onPreUseActivityGM - Local roll, returning early to let normal D&D5e flow handle it");return}if(e.item.unsetFlag(k,"tempAttackConfig"),e.item.unsetFlag(k,"tempDamageConfig"),e.item.unsetFlag(k,"tempSaveConfig"),!r)return;c.log("BaseActivityManager.onPreUseActivityGM #1",[t,u]),l&&l.active&&!l.isGM&&(t._originalConsume=structuredClone(t.consume||{}),t._originalCreate=structuredClone(t.create||{})),t.consume=At(t.consume||{},u),t.create=Vt(t.create||{},u);const f=re.hasPendingRoll();if(l&&!l.isGM&&!u&&!f)if(this.isMidiActive)c.log("BaseActivityManager.onPreUseActivityGM - Marking Midi message to suppress rendering for player-owned actor",[r.name]),o.data||(o.data={}),o.data.flags||(o.data.flags={}),o.data.flags[k]||(o.data.flags[k]={}),o.data.flags[k].preventRender=!0;else{const g=_s();s.configure=s.configure?g:!1,o.create=!1}}static onPostUseActivityGM(e,t,s){var g,m,p,S,y,R,A,_;const o=I(),a=v.get(o.rollRequestsEnabled.tag),i=v.get(o.rollInterceptionEnabled.tag),n=e.actor,r=((g=t.create)==null?void 0:g._isDnDBRoll)===!0;if(c.log("BaseActivityManager.onPostUseActivityGM #0",["activityType:",e.type,"isDnDBRoll:",r,"hasDamageParts:",((p=(m=e.damage)==null?void 0:m.parts)==null?void 0:p.length)>0,"requestsEnabled:",a,"rollInterceptionEnabled:",i,"actor:",n==null?void 0:n.name]),!a||!i||!n){c.log("BaseActivityManager.onPostUseActivityGM - Early return (settings or no actor)",["requestsEnabled:",a,"rollInterceptionEnabled:",i,"hasActor:",!!n]),r&&e.type===ce.SAVE&&((y=(S=e.damage)==null?void 0:S.parts)==null?void 0:y.length)>0&&!this.isMidiActive&&(c.log("BaseActivityManager.onPostUseActivityGM - DnDB save damage bypassing settings check"),this._handleDnDBSaveDamageRoll(e,t));return}const l=q.getActorOwner(n),d=l&&l.active&&l.id!==game.user.id,u=!d||t.isRollRequest===!1;if(c.log("BaseActivityManager.onPostUseActivityGM #1 ",[u,d,this.isMidiActive]),this.isMidiActive&&u)return;const f=P.shouldSkipRollDialog({isPC:d,isNPC:!d,sendRequest:d});if(s.configure=t.skipRollDialog!==void 0?!t.skipRollDialog:d&&!f,c.log("BaseActivityManager.onPostUseActivityGM - skipRollDialog",[f,t.skipRollDialog]),t.skipRollDialog===!1&&(!(l!=null&&l.active)||l.isGM)){c.log("BaseActivityManager.onPostUseActivityGM - Preventing usage message - no owning player for actor",[e.actor]);return}if(e.item){const T={spell:t.spell||{},scaling:t.scaling,consume:t._originalConsume||t.consume||{},create:t._originalCreate||t.create||{}},b=e.item.id,C={config:T,timestamp:Date.now()};Ie.activityConfigCache.set(b,C),c.log("BaseActivityManager.onPostUseActivityGM - storing activity config in cache",[b,T])}if(u||(this.isMidiActive?ut.triggerMissingRolls(e,t,s):vs.triggerMissingRolls(e,t,s)),e.type===ce.SAVE&&((A=(R=e.damage)==null?void 0:R.parts)==null?void 0:A.length)>0&&!this.isMidiActive&&u)if(((_=t.create)==null?void 0:_._isDnDBRoll)===!0)c.log("BaseActivityManager.onPostUseActivityGM - DnDB save damage roll detected",[e.item.name]),this._handleDnDBSaveDamageRoll(e,t);else{c.log("BaseActivityManager.onPostUseActivityGM - triggering vanilla save damage roll for local roll",[e,t]);const b=t.skipRollDialog!==void 0?!t.skipRollDialog:d&&!f;e.rollDamage(t,{configure:b},{})}}static onPreUseActivityPlayer(e,t,s,o){const a=I(),i=v.get(a.rollRequestsEnabled.tag),n=v.get(a.rollInterceptionEnabled.tag);if(!i||!n)return;c.log("BaseActivityManager.onPreUseActivityPlayer",[e,t,s,o]);const r=e.actor;if(e.item.unsetFlag(k,"tempAttackConfig"),e.item.unsetFlag(k,"tempDamageConfig"),e.item.unsetFlag(k,"tempSaveConfig"),!r)return;const l=_s();s.configure=s.configure?l:!1,t.consume=At(t.consume||{},!0),t.create=Vt(t.create||{},!0),this.isMidiActive&&ut.onPreUseActivityPlayer(e,t,s,o)}static onPostUseActivityPlayer(e,t,s){var a,i,n,r,l,d,u;const o=((a=t.create)==null?void 0:a._isDnDBRoll)===!0;if(c.log("BaseActivityManager.onPostUseActivityPlayer",["activityType:",e.type,"isDnDBRoll:",o,"hasDamageParts:",((n=(i=e.damage)==null?void 0:i.parts)==null?void 0:n.length)>0,"damagePartsCount:",(l=(r=e.damage)==null?void 0:r.parts)==null?void 0:l.length,"isMidiActive:",this.isMidiActive,"hasPendingDamageRoll:",_e.hasPendingDamageRoll()]),this.isMidiActive){ut.onPostUseActivityPlayer(e,t,s);return}if(e.type===ce.SAVE&&((u=(d=e.damage)==null?void 0:d.parts)==null?void 0:u.length)>0)if(o)this._handleDnDBSaveDamageRoll(e,t);else{c.log("BaseActivityManager.onPostUseActivityPlayer - triggering vanilla save damage roll",[e,t]);const f=t.skipRollDialog!==void 0?!t.skipRollDialog:!0;e.rollDamage(t,{configure:f},{create:!0})}}static _handleDnDBSaveDamageRoll(e,t){var r,l;c.log("BaseActivityManager._handleDnDBSaveDamageRoll - Entry",["activity:",(r=e.item)==null?void 0:r.name,"hasPending:",_e.hasPendingDamageRoll()]);const s=_e.consumePendingDamageRoll();if(!s){c.warn("BaseActivityManager._handleDnDBSaveDamageRoll - No pending DnDB roll found");return}const o=(l=s.rawRolls)==null?void 0:l[0];if(!o){c.warn("BaseActivityManager._handleDnDBSaveDamageRoll - No raw roll data found");return}c.log("BaseActivityManager._handleDnDBSaveDamageRoll - Processing DnDB damage",["item:",e.item.name,"ddbRollAction:",s.action]);const a={sendRequest:!1},i={configure:!1},n={create:!1};e.rollDamage(a,i,n).then(d=>{var S;if(!(d!=null&&d.length)){c.warn("BaseActivityManager._handleDnDBSaveDamageRoll - rollDamage returned no rolls");return}St.injectDnDBDiceValues(d[0],o);const u=qt(),f=e.actor,g=Le(f)||game.user,m=game.settings.get("core","rollMode");c.log("BaseActivityManager._handleDnDBSaveDamageRoll - Creating message",["targets:",u.length]);const p={speaker:ChatMessage.getSpeaker({actor:f}),author:g.id,flavor:`${e.item.name} - ${e.damageFlavor}`,flags:{[k]:{isDnDBRoll:!0,ddbCharacterId:s.characterId,ddbSource:s.source,rollType:s.rollType,action:s.action},dnd5e:{...e.messageFlags,messageType:"roll",roll:{type:"damage",damageOnSave:(S=e.damage)==null?void 0:S.onSave},targets:u},rsr5e:{processed:!0,quickRoll:!1}}};d[0].toMessage(p,{rollMode:m}).then(()=>{c.log("BaseActivityManager._handleDnDBSaveDamageRoll - Damage message created"),_e.clearDnDBDamageInProgress()})}).catch(d=>{c.error("BaseActivityManager._handleDnDBSaveDamageRoll - Error",[d]),_e.clearDnDBDamageInProgress()})}}E(Me,"_isMidiActive",null);const{ApplicationV2:Bo,HandlebarsApplicationMixin:xo}=foundry.applications.api;class ds extends xo(Bo){constructor(e={}){super(e),this.formula=e.formula||"",this.readonly=e.readonly||!1,this.actor=e.actor,this.callback=e.callback,this.diceCounts={},this.rollMode=e.rollMode||game.settings.get("core","rollMode")}static get DEFAULT_OPTIONS(){return foundry.utils.mergeObject(super.DEFAULT_OPTIONS,{classes:["flash5e-dialog","flash5e-custom-roll-dialog"],tag:"div",window:{title:"FLASH_ROLLS.ui.dialogs.customRollTitle",icon:"fas fa-dice-d20",resizable:!1,positioned:!0,frame:!0},position:{width:420,height:"auto"}})}get id(){var e;return`flash5e-custom-roll-dialog-${((e=this.actor)==null?void 0:e.id)||"unknown"}`}get title(){const e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.customRollTitle");return this.actor?`${e} - ${this.actor.name}`:e}_onClickAction(e,t){switch(t.dataset.action){case"rollDice":return this.rollDice(e,t);case"addDie":return this.addDie(e,t);case"cancel":return this.cancel(e,t)}}async _prepareContext(e={}){const t=await super._prepareContext(e),s=Object.entries(CONFIG.Dice.rollModes).map(([o,a])=>({value:o,labelKey:typeof a=="string"?a:(a==null?void 0:a.label)||(a==null?void 0:a.name)||o,selected:o===this.rollMode}));return{...t,formula:this.formula,readonly:this.readonly,rollMode:this.rollMode,rollModes:s}}_attachPartListeners(e,t,s){super._attachPartListeners(e,t,s);const o=t.querySelector("#custom-roll-formula"),a=t.querySelector("#formula-validation-message"),i=t.querySelector("#custom-roll-mode");o&&!this.readonly&&(o.addEventListener("input",n=>{this.formula=n.target.value.trim(),this.updateValidationMessage(a)}),this.formula&&this.updateValidationMessage(a)),i&&i.addEventListener("change",n=>{this.rollMode=n.target.value})}updateValidationMessage(e){if(!e)return;if(!this.formula){e.textContent="&nbsp;",e.classList.remove("error","success");return}this.validateFormula(this.formula)?(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaValid"),e.classList.remove("error"),e.classList.add("success")):(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaInvalid"),e.classList.remove("success"),e.classList.add("error"))}addDie(e,t){const s=t.dataset.die,o=this.element.querySelector("#custom-roll-formula");if(!o)return;const a=o.value.trim();if(a){const i=/(\d*)d(\d+)/g,n=new Map;let r=a,l;for(;(l=i.exec(a))!==null;){const f=parseInt(l[1]||"1"),g=l[2];n.set(g,(n.get(g)||0)+f),r=r.replace(l[0],"").trim()}const d=s.substring(1);n.set(d,(n.get(d)||0)+1);const u=[];for(const[f,g]of n)u.push(`${g}d${f}`);r=r.replace(/^\+\s*|\s*\+\s*$|\s*\+\s*\+/g,"").trim(),r&&r!=="+"?this.formula=`${u.join(" + ")} + ${r}`:this.formula=u.join(" + ")}else this.formula=`1${s}`;o.value=this.formula,o.dispatchEvent(new Event("input"))}validateFormula(e){var t;if(!e||e.trim()==="")return!1;try{return Roll.validate(e)}catch{try{return new Roll(e,((t=this.actor)==null?void 0:t.getRollData())||{}),!0}catch{return!1}}}async rollDice(){if(c.log("rollDice"),!this.validateFormula(this.formula)){ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.invalidFormula",{formula:this.formula||"empty"}));return}this.callback&&await this.callback({formula:this.formula,rollMode:this.rollMode}),this.close()}cancel(){this.close()}static async prompt(e={}){return new Promise(t=>{const s=new this({...e,callback:o=>t(o)});s.addEventListener("close",()=>{s._resolved||t(null)}),s.render(!0)})}async close(e={}){return this._resolved=!0,super.close(e)}}E(ds,"PARTS",{main:{template:`modules/${V.ID}/templates/custom-roll-dialog.hbs`},footer:{template:`modules/${V.ID}/templates/custom-roll-dialog-footer.hbs`}});class We{static async handleRequest(e){var o,a;const t=q.isModuleOn("midi-qol");if(c.log("handleRequest",[e]),game.user.isGM)return;let s;if(e.isTokenActor){const i=(o=game.scenes.active)==null?void 0:o.tokens.get(e.actorId);if(s=i==null?void 0:i.actor,!s){c.warn("Token actor not found:",e.actorId);return}}else s=game.actors.get(e.actorId);!s||!s.isOwner||(e.preserveTargets&&((a=e.targetTokenIds)==null?void 0:a.length)>0&&(c.log("handleRequest - applyTargetTokens",[e]),Ho(e.targetTokenIds)),t&&e.rollProcessConfig.midiOptions&&(e.rollProcessConfig.midiOptions={...e.rollProcessConfig.midiOptions,fastForward:!1,fastForwardAttack:!1,dialogOptions:{...e.rollProcessConfig.midiOptions.dialogOptions,fastForward:!1,fastForwardAttack:!1},workflowOptions:{...e.rollProcessConfig.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1}}),pe.notify("info","",{batch:!0,batchData:{actor:s.name,rollType:e.rollType,rollKey:e.rollKey,gm:e.rollProcessConfig._requestedBy||"GM"}}),this.rollQueue.push({actor:s,requestData:e}),this.isProcessingRoll||(this.isProcessingRoll=!0,this.processNextRoll()))}static async processNextRoll(){var a;if(c.log("processNextRoll - called",[this.rollQueue.length,"in queue",this.isProcessingRoll]),this.rollQueue.length===0){this.isProcessingRoll=!1,c.log("processNextRoll - queue empty, stopping");return}const{actor:e,requestData:t}=this.rollQueue.shift();c.log("processNextRoll - Processing",[e.name,t.rollType,this.rollQueue.length,"remaining"]);const s=(a=t.rollType)==null?void 0:a.toLowerCase();if(s===L.DAMAGE||s===L.ATTACK||s===L.ITEM){this.executePlayerRollRequest(e,t).catch(i=>{c.error("Error processing roll request:",[i])}),this.processNextRoll();return}try{await this.executePlayerRollRequest(e,t)}catch(i){c.error("Error processing roll request:",[i])}this.processNextRoll()}static onRollCompleted(e){this.pendingRollResolver&&(this.pendingRollResolver(),this.pendingRollResolver=null,this.pendingRollActorId=null),e&&this.cancelAutoRollTimeout(e)}static async executePlayerRollRequest(e,t){var o,a,i,n,r;const s=I();v.get(s.publicPlayerRolls.tag);try{const l=(o=t.rollType)==null?void 0:o.toLowerCase();c.log("executePlayerRollRequest - normalized roll type",[l]);const d=v.get(s.showRequestPrompt.tag),u=[L.ATTACK,L.DAMAGE,L.ITEM].includes(l);if(!d&&!game.user.isGM){if(u){c.log("executePlayerRollRequest - Activity roll with showRequestPrompt disabled, showing item card only",[e.name,l]),await this.showItemCardOnly(e,t);return}c.log("executePlayerRollRequest - Skipping prompt (showRequestPrompt disabled)",[e.name]),t.groupRollId&&(await e.setFlag(k,"tempGroupRollId",t.groupRollId),e.isToken&&e.actor&&await e.actor.setFlag(k,"tempGroupRollId",t.groupRollId),c.log("executePlayerRollRequest - Set tempGroupRollId for manual roll interception",[t.groupRollId,e.name]));const M=t.isTokenActor?t.actorId:e.id,O=this.getMidiPlayerSaveTimeout(),F=t.fromMidiWorkflow||((i=(a=t.rollProcessConfig)==null?void 0:a.midiOptions)==null?void 0:i.workflowId);if(l===L.SAVE&&O>0&&F){c.log("executePlayerRollRequest - Setting up auto-roll for showRequestPrompt disabled",[e.name,O]);const N=((n=t.rollProcessConfig.rolls)==null?void 0:n[0])||{parts:[],data:{},options:{}},W=t.rollProcessConfig.rollMode,B=game.settings.get("core","rollMode"),U=W||B,le={[k]:{isFlashRollRequest:!0,rollType:t.rollType,rollKey:t.rollKey,actorUniqueId:M,fromMidiWorkflow:t.fromMidiWorkflow||!1}},de=ChatMessage.getSpeaker({actor:e}),ue={rollMode:U,create:t.rollProcessConfig.chatMessage!==!1,flags:le,data:{speaker:de},messageData:{speaker:de,flags:le}},Ee={rollKey:t.rollKey,activityId:t.activityId,config:t.rollProcessConfig,groupRollId:t.groupRollId};this.setupAutoRollTimeout(e,t,M,Ee,N,ue)}return}const f=((r=t.rollProcessConfig.rolls)==null?void 0:r[0])||{parts:[],data:{},options:{}},p={configure:!(v.get(s.skipToRollResolver.tag)&&Ye.hasNonDigitalDice())},S=t.rollProcessConfig.rollMode,y=game.settings.get("core","rollMode"),R=S||y,A=t.isTokenActor?t.actorId:e.id,_={[k]:{isFlashRollRequest:!0,rollType:t.rollType,rollKey:t.rollKey,actorUniqueId:A,fromMidiWorkflow:t.fromMidiWorkflow||!1}},T=ChatMessage.getSpeaker({actor:e}),b={rollMode:R,create:t.rollProcessConfig.chatMessage!==!1,flags:_,data:{speaker:T},messageData:{speaker:T,flags:_}},C={rollKey:t.rollKey,activityId:t.activityId,config:t.rollProcessConfig,groupRollId:t.groupRollId},w=ke[l];w?(c.log("executePlayerRollRequest - calling handler",[l,"dialogConfig.configure:",p.configure]),this.setupAutoRollTimeout(e,t,A,C,f,b),await w(e,C,f,p,b),this.cancelAutoRollTimeout(A),c.log("executePlayerRollRequest - handler completed",[l])):(c.warn(`No handler found for roll type: ${l}`),pe.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"})))}catch(l){c.error("Error executing roll request:",[l]),pe.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"}))}}static getMidiPlayerSaveTimeout(){const e=qe.getMidiQOL();if(!(e!=null&&e.currentConfigSettings))return c.log("getMidiPlayerSaveTimeout - no MidiQOL config",[!!e]),0;const t=e.currentConfigSettings.playerRollSaves,s=e.currentConfigSettings.playerSaveTimeout;return c.log("getMidiPlayerSaveTimeout - midi settings",[t,s]),t!=="ftb"?0:s||0}static setupAutoRollTimeout(e,t,s,o,a,i){var f,g,m,p,S;const n=(f=t.rollType)==null?void 0:f.toLowerCase();if(c.log("setupAutoRollTimeout - checking",[n,L.SAVE,n===L.SAVE]),n!==L.SAVE)return;const r=t.fromMidiWorkflow||((m=(g=t.rollProcessConfig)==null?void 0:g.midiOptions)==null?void 0:m.workflowId);if(c.log("setupAutoRollTimeout - workflow check",[r,t.fromMidiWorkflow,(S=(p=t.rollProcessConfig)==null?void 0:p.midiOptions)==null?void 0:S.workflowId]),!r)return;const l=this.getMidiPlayerSaveTimeout();if(c.log("setupAutoRollTimeout - timeout value",[l]),l<=0)return;const d=ke[n];if(!d)return;c.log("setupAutoRollTimeout - Setting up auto-roll",[e.name,l,"seconds"]);const u=setTimeout(async()=>{if(!this.pendingAutoRollTimeouts.has(s)){c.log("setupAutoRollTimeout - Timeout cancelled (roll already completed)",[e.name]);return}c.log("setupAutoRollTimeout - Auto-rolling after timeout",[e.name,l]),this.pendingAutoRollTimeouts.delete(s),this.autoRolledActors.add(s),pe.notify("info",game.i18n.format("FLASH_ROLLS.notifications.autoRollTimeout",{actor:e.name}));const y={configure:!1};try{await d(e,o,a,y,i),c.log("setupAutoRollTimeout - Auto-roll completed",[e.name])}catch(R){c.error("setupAutoRollTimeout - Auto-roll error",[R])}finally{this.autoRolledActors.delete(s)}},l*1e3);this.pendingAutoRollTimeouts.set(s,{timeoutId:u,requestData:t})}static cancelAutoRollTimeout(e){const t=this.pendingAutoRollTimeouts.get(e);t&&(c.log("cancelAutoRollTimeout - Cancelling timeout",[e]),clearTimeout(t.timeoutId),this.pendingAutoRollTimeouts.delete(e))}static wasAutoRolled(e){return this.autoRolledActors.has(e)}static async showItemCardOnly(e,t){var a,i,n;const s=e.items.get(t.rollKey);if(!s){c.warn("showItemCardOnly - Item not found",[t.rollKey]);return}const o=t.activityId?(a=s.system.activities)==null?void 0:a.get(t.activityId):(n=(i=s.system.activities)==null?void 0:i.contents)==null?void 0:n[0];if(!o){c.warn("showItemCardOnly - Activity not found",[s.name,t.activityId]);return}c.log("showItemCardOnly - Displaying item card",[s.name,o.name]),await o.use({consume:{resources:!1,spellSlot:!1,action:!1},create:{measuredTemplate:!1}},{configure:!1},{create:!0})}}E(We,"rollQueue",[]),E(We,"isProcessingRoll",!1),E(We,"pendingRollResolver",null),E(We,"pendingRollActorId",null),E(We,"pendingAutoRollTimeouts",new Map),E(We,"autoRolledActors",new Set);const be=class be{static async initialize(){c.log("ChatMessageManager.initialize"),await this.preloadTemplate()}static onCreateChatMessage(e,t,s,o){c.log("ChatMessageManager.onCreateChatMessage",[e,t,s,o])}static onPreCreateChatMessage(e,t,s,o){var a,i,n,r,l,d,u,f,g,m,p,S,y;if(c.log("ChatMessageManager.onPreCreateChatMessage",[e,t,s,o]),t._showRequestedBy&&((a=t.rolls)==null?void 0:a.length)>0){const R=t._requestedBy||"GM",A=game.i18n.format("FLASH_ROLLS.chat.requestedBy",{gm:R}),_=t.flavor||"";t.flavor=_?`${_} ${A}`:A}if((n=(i=t.flags)==null?void 0:i[k])!=null&&n.groupRollId&&c.log("ChatMessageManager.onPreCreateChatMessage - Found groupRollId in data flags",[t]),((r=t.rolls)==null?void 0:r.length)>0||(d=(l=t.flags)==null?void 0:l.core)!=null&&d.initiativeRoll){const R=t.speaker,A=R==null?void 0:R.actor;if(A){let _=game.actors.get(A);if(!_&&(R!=null&&R.token)){const T=canvas.tokens.get(R.token);T!=null&&T.actor&&(_=T.actor,c.log("ChatMessageManager.onPreCreateChatMessage - Using token actor from speaker",[_.name,_.id]))}if(!_){c.log("ChatMessageManager.onPreCreateChatMessage - No actor found",[A,R]);return}if(game.user.isGM){const T=_.isToken?(u=_.actor)==null?void 0:u.id:_.id,b=[A,T].filter(C=>C);for(const[C,w]of be.pendingRolls.entries()){const M=w.actorEntries||(w.actors?w.actors.map(O=>({actorId:O})):[]);if(b.some(O=>M.some(F=>F.actorId===O))){t.flags=t.flags||{},t.flags[k]=t.flags[k]||{},t.flags[k].groupRollId=C,t.flags.rsr5e={processed:!0,quickRoll:!1},c.log("ChatMessageManager.onPreCreateChatMessage - Added groupRollId flag (GM)",[C,A]);break}}}else{let T=_.getFlag(k,"tempGroupRollId");if(c.log("ChatMessageManager.onPreCreateChatMessage - Player side check",[_.name,"storedGroupRollId:",T,"isToken:",_.isToken]),!T&&_.isToken){const C=game.actors.get((f=_.actor)==null?void 0:f.id);C&&(T=C.getFlag(k,"tempGroupRollId"),c.log("ChatMessageManager.onPreCreateChatMessage - Checking base actor for tempGroupRollId",[C.id,T]))}let b=_.getFlag(k,"tempInitiativeConfig");if(!b&&_.isToken){const C=game.actors.get((g=_.actor)==null?void 0:g.id);C&&(b=C.getFlag(k,"tempInitiativeConfig"))}if((b!=null&&b.groupRollId||T)&&(t.flags=t.flags||{},t.flags[k]=t.flags[k]||{},t.flags[k].groupRollId=T||(b==null?void 0:b.groupRollId)||"",t.flags.rsr5e={processed:!0,quickRoll:!1},T&&(_.unsetFlag(k,"tempGroupRollId"),_.isToken))){const C=game.actors.get((m=_.actor)==null?void 0:m.id);C&&C.unsetFlag(k,"tempGroupRollId")}}}}if(((p=t.rolls)==null?void 0:p.length)>0&&t.rolls[0])try{const R=t.rolls[0];(S=R.options)!=null&&S._customFlavor&&(t.flavor=R.options._customFlavor)}catch(R){c.error("ChatMessageManager.onPreCreateChatMessage - flavor error",[R])}!game.user.isGM&&((y=t.rolls)==null?void 0:y.length)>0&&We.pendingRollResolver&&We.onRollCompleted()}static onRenderChatMessage(e,t,s){var r,l,d,u,f,g,m,p,S,y,R,A,_;const a=q.isModuleOn("midi-qol")?e.getFlag("midi-qol","requestId"):null,i=(d=(l=(r=e.flags)==null?void 0:r.dnd5e)==null?void 0:l.roll)==null?void 0:d.type;c.log("ChatMessageManager.onRenderChatMessage #0",[e.id,"speaker:",(u=e.speaker)==null?void 0:u.alias,"midiRequestId:",a,"dnd5eRollType:",i]);const n=t instanceof jQuery?t[0]:t[0]||t;if(e.getFlag(k,"preventRender")){c.log("ChatMessageManager.onRenderChatMessage - Hiding message for roll request",[e.id]),n&&(n.style.display="none");return}if(be.interceptRollMessage(e,t,s),e.getFlag(k,"isGroupRoll")){const T=I(),b=v.get(T.groupRollNPCHidden.tag),C=e.getFlag(k,"npcHiddenOverride"),w=game.user.isGM,M=e.getFlag(k,"showAllResultsToPlayers"),O=(C!==void 0?C:b)&&!w,F=e.getFlag(k,"rollData");F&&F.results&&n.querySelectorAll(".actor-result").forEach((W,B)=>{const U=F.results[B];if(U){const le=game.actors.get(U.actorId),de=O&&le&&!le.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);de?W.classList.add("npc-hidden"):W.classList.remove("npc-hidden");const ue=U.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,Ee=le==null?void 0:le.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER);let ve;w||M?ve=!1:ue===CONST.DICE_ROLL_MODES.BLIND?ve=!0:ue===CONST.DICE_ROLL_MODES.PRIVATE||ue===CONST.DICE_ROLL_MODES.SELF?ve=!Ee:ve=!1,c.log("onRenderChatMessage - Roll visibility",[U.actorName,"rollMode:",ue,"isGM:",w,"showAllResultsToPlayers:",M,"hasPermission:",Ee,"shouldHideRoll:",ve]),ve?W.classList.add("roll-hidden"):W.classList.remove("roll-hidden");const Ne=v.get(T.concealNPCNames.tag),ze=!w&&U.isNPC&&Ne&&!de;c.log("onRenderChatMessage - Name concealment",[U.actorName,"isNPC:",U.isNPC,"concealNPCNames:",Ne,"shouldHide:",de,"shouldConcealName:",ze]),ze?W.classList.add("npc-name-concealed"):W.classList.remove("npc-name-concealed")}}),be._attachGroupRollListeners(n,e),be._attachDCAndSelectionListeners(n,e)}if(this._addSelectTargetsButton(e,n),game.user.isGM){let T=(f=s.subject)==null?void 0:f.item;!T&&((p=(m=(g=e.flags)==null?void 0:g.dnd5e)==null?void 0:m.item)!=null&&p.uuid)&&(T=fromUuidSync(e.flags.dnd5e.item.uuid)),T&&setTimeout(()=>{Ie.activityConfigCache.delete(T.id),c.log("ChatMessageManager.onRenderChatMessage - cleared activity config cache",[T.id])},1e3)}if(!game.user.isGM&&(((y=(S=e.flags)==null?void 0:S[k])==null?void 0:y.isFlashRollRequest)||((A=(R=e.flags)==null?void 0:R[k])==null?void 0:A.groupRollId)||((_=e.getFlag("dnd5e","roll"))==null?void 0:_._requestedBy))){const b=game.settings.get("dnd5e","challengeVisibility");let C=!0;switch(b){case"none":C=!1;break;case"all":C=!0;break;case"player":C=e.author.id===game.user.id||!e.author.isGM;break;default:C=!0;break}if(C===!1){t.querySelectorAll("[data-display-challenge]").forEach(O=>delete O.dataset.displayChallenge);const M=t.querySelectorAll(".success, .failure, .critical, .fumble");M==null||M.forEach(O=>{O.classList.remove("success","failure","critical","fumble")}),M==null||M.forEach(O=>{var F;return(F=O.querySelector(".icons"))==null?void 0:F.remove()}),t.querySelectorAll(".save-dc, .dc, .target-dc").forEach(O=>{const F=O.textContent;F&&F.includes("DC")&&(O.textContent=F.replace(/DC\s*\d+/gi,""))})}}return!1}static onRenderChatLog(e,t){c.log("ChatMessageManager.onRenderChatLog",[]),t.querySelectorAll(".chat-message").forEach(o=>{var n,r,l,d,u,f;const a=o.dataset.messageId,i=game.messages.get(a);if(((l=(r=(n=i==null?void 0:i.flags)==null?void 0:n.dnd5e)==null?void 0:r.roll)==null?void 0:l.type)==="damage"&&((f=(u=(d=i.flags)==null?void 0:d.dnd5e)==null?void 0:u.item)!=null&&f.uuid)){const g=i.flags.dnd5e.item.uuid,m=fromUuidSync(g);if(m&&!Ie.templateRemovalTimers.has(g)){Ie.templateRemovalTimers.add(g);const p=I(),y=v.get(p.templateRemovalTimeout.tag)*1e3;setTimeout(()=>{q.removeTemplateForItem(m),Ie.templateRemovalTimers.delete(g)},y)}}})}static _addSelectTargetsButton(e,t){var o,a,i;if(!game.user.isGM||(t=t[0]||t,c.log("ChatMessageManager._addSelectTargetsButton #0",[e,t]),((i=(a=(o=e.flags)==null?void 0:o.dnd5e)==null?void 0:a.roll)==null?void 0:i.type)!=="damage"||t.querySelector(".select-targeted")))return;const s=document.createElement("button");s.className="select-targeted",s.type="button",s.setAttribute("data-tooltip-direction","LEFT"),s.setAttribute("data-tooltip","Select Targeted"),s.innerHTML='<i class="fas fa-crosshairs"></i>',s.addEventListener("click",n=>{n.preventDefault(),this._selectTargetedTokens(n)}),t.querySelector(".message-content").appendChild(s),e.update({content:t})}static _selectTargetedTokens(e){const s=e.currentTarget.closest(".chat-message").querySelectorAll("[data-target-uuid]");if(s.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTargetedTokens"));return}for(let o=0;o<s.length;o++){const i=s[o].dataset.targetUuid.split("Actor.")[1];canvas.tokens.placeables.filter(r=>{var l,d;return((l=r.document.actor)==null?void 0:l.id)===i||((d=r.document.baseActor)==null?void 0:d.id)===i}).forEach((r,l)=>{r&&r.control&&r.control({releaseOthers:o===0})})}}static _showTokenVision(e){var a,i;if(!(canvas!=null&&canvas.tokens)||!((a=canvas.scene)!=null&&a.tokenVision)||!game.user.isGM)return;const t=e.dataset.tokenId,s=e.dataset.actorId;let o=t?canvas.tokens.get(t):null;!o&&s&&(o=canvas.tokens.placeables.find(n=>{var r;return((r=n.actor)==null?void 0:r.id)===s})),!(!o||!((i=o.document.sight)!=null&&i.enabled))&&(this._previouslyControlled=[...canvas.tokens.controlled],this._previewToken=o,this._originalControlledGetter=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(o),"controlled"),Object.defineProperty(o,"controlled",{get:()=>!0,configurable:!0}),o.initializeVisionSource(),canvas.perception.update({initializeVision:!0,refreshVision:!0}))}static _hideTokenVision(e){!this._previewToken||!game.user.isGM||(delete this._previewToken.controlled,this._originalControlledGetter&&(Object.defineProperty(this._previewToken,"controlled",this._originalControlledGetter),this._originalControlledGetter=null),this._previewToken.initializeVisionSource(),this._previouslyControlled.forEach(t=>{t.scene===canvas.scene&&t.initializeVisionSource()}),canvas.perception.update({initializeVision:!0,refreshVision:!0}),this._previewToken=null,this._previouslyControlled=[])}static _attachGroupRollListeners(e,t){const s=e.querySelectorAll(".actor-result");c.log("_attachGroupRollListeners - found actor results",[s.length]),s.forEach(o=>{o.addEventListener("click",i=>{if(i.target.closest(".dice-btn.rollable")||i.target.closest(".adv-btn"))return;i.preventDefault(),i.stopPropagation();const n=o;c.log("actor-result click",[o]),n.classList.contains("expanded")?n.classList.remove("expanded"):n.classList.add("expanded")});const a=o.querySelector(".actor-image");a&&(a.addEventListener("mouseenter",i=>{i.stopPropagation(),this._showTokenVision(o)}),a.addEventListener("mouseleave",i=>{i.stopPropagation(),this._hideTokenVision(o)}))}),e.querySelectorAll(".adv-btn").forEach(o=>{o.addEventListener("click",async a=>{a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation();const i=parseInt(o.dataset.advantageMode);this._handleGroupRollClick(o,t,!0,i===1,i===-1)})}),e.querySelectorAll(".dice-btn.rollable").forEach(o=>{o.addEventListener("click",async a=>{var u;a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation();const{areKeysPressed:i}=game.dnd5e.utils||{};let n=!1,r=!1,l=!1;i?(l=i(a,"skipDialogNormal"),n=i(a,"skipDialogAdvantage"),r=i(a,"skipDialogDisadvantage")):(l=a.shiftKey,n=a.altKey,r=a.ctrlKey||a.metaKey);let d=l||n||r;if(game.user.isGM&&!d){const f=o.dataset.actorId,g=o.dataset.tokenId;let m;if(g){const y=(u=game.scenes.current)==null?void 0:u.tokens.get(g);m=y==null?void 0:y.actor}m||(m=game.actors.get(f));const p=(m==null?void 0:m.type)==="npc",S=(m==null?void 0:m.type)==="character";d=P.shouldSkipRollDialog({event:a,isPC:S,isNPC:p,sendRequest:S})}this._handleGroupRollClick(o,t,d,n,r)})})}static async _handleGroupRollClick(e,t,s,o,a){var w,M;const i=e.dataset,n=i.actorId,r=i.tokenId;let l;if(r){const O=(w=game.scenes.current)==null?void 0:w.tokens.get(r);l=O==null?void 0:O.actor}if(l||(l=game.actors.get(n)),!l){D.notify("warn","Actor not found");return}if(!(game.user.isGM||l.isOwner)){D.notify("warn",`You don't have permission to roll for ${l.name}`);return}const u=(M=i.type)==null?void 0:M.toLowerCase(),f=i.rollKey,g=i.groupRollId,m=i.dc?parseInt(i.dc):null,p=i.gmAdvantage==="true",S=i.gmDisadvantage==="true",y=i.situationalBonus||"",R=o||p,A=a||S;c.log("Group roll click",[u,f,n,g,{shouldSkipDialog:s,hasAdvantage:o,hasDisadvantage:a,gmAdvantage:p,gmDisadvantage:S,situationalBonus:y}]);const _={rollKey:f,groupRollId:g,config:{advantage:R&&!A,disadvantage:A&&!R,target:m,rollMode:game.settings.get("core","rollMode"),situational:y||void 0}},T={configure:!s,isRollRequest:!0},b={rollMode:game.settings.get("core","rollMode"),create:!0,isRollRequest:!0},C={parts:[],data:{},options:{}};try{const O=ke[u];if(O)await O(l,_,C,T,b);else{let F;switch(u){case L.SKILL:F="rollSkill";break;case L.ABILITY:case L.ABILITY_CHECK:F="rollAbilityTest";break;case L.SAVE:case L.SAVING_THROW:F="rollAbilitySave";break;case L.TOOL:F="rollToolCheck";break;default:D.notify("warn",`Unknown roll type: ${u}`);return}if(F&&l[F]){const N={..._.config,configure:!s,messageOptions:{"flags.flash-rolls-5e.groupRollId":g}};y&&(N.rolls=[{data:{situational:y},...s?{parts:["@situational"]}:{}}]),await l[F](f,N)}}}catch(O){c.error("Error executing roll from chat",O),ui.notifications.error(`Failed to execute roll: ${O.message}`)}}static _attachDCAndSelectionListeners(e,t){const s=e.querySelector(".group-roll-dc-control"),o=e.querySelector(".dc-input");if(s){const n=s.dataset.showToPlayers==="true";if(game.user.isGM||(s.style.display="none"),!game.user.isGM&&!n){const r=e.querySelector(".group-roll-footer .group-result-details");r&&(r.style.display="none")}}const a=e.querySelector(".group-roll-footer");if(a){const n=a.dataset.showToPlayers==="true",r=t.getFlag(k,"showAllResultsToPlayers");!game.user.isGM&&!n&&!r&&(a.style.display="none")}if(o)if(!game.user.isGM)o.readOnly=!0,o.style.cursor="not-allowed";else{let n=null;const r=async()=>{const l=parseInt(o.value);if(!o.value)return;if(isNaN(l)||l<1||l>99){o.value="";return}const d=o.dataset.messageId,u=game.messages.get(d);u&&await be.updateGroupRollDC(u,l)};o.addEventListener("input",l=>{n&&clearTimeout(n),n=setTimeout(()=>{r()},750)}),o.addEventListener("keypress",l=>{l.key==="Enter"&&(n&&clearTimeout(n),r())})}const i=e.querySelector(".group-roll-selection-buttons");i&&(game.user.isGM&&i.classList.remove("gm-only"),i.querySelectorAll(".select-actors-btn").forEach(n=>{n.addEventListener("click",async r=>{r.preventDefault(),r.stopPropagation();const l=n.dataset.selectType,d=i.dataset.messageId,u=game.messages.get(d);u&&await be.selectActorsFromGroupRoll(u,l)})}))}static async selectActorsFromGroupRoll(e,t){if(!game.user.isGM)return;const s=e.getFlag(k,"rollData");if(!(s!=null&&s.results))return;const o=[];for(const a of s.results){if(!a.rolled)continue;let i=!1;switch(t){case"failed":i=a.failure===!0;break;case"passed":i=a.success===!0;break;case"all":i=!0;break}if(i){let n=null;if(a.tokenId&&(n=canvas.tokens.get(a.tokenId)),!n&&a.uniqueId&&a.uniqueId!==a.actorId&&(n=canvas.tokens.get(a.uniqueId)),!n&&a.actorId){const r=canvas.tokens.placeables.filter(l=>{var d;return((d=l.actor)==null?void 0:d.id)===a.actorId});r.length===1&&(n=r[0])}n&&o.push(n)}}canvas.tokens.releaseAll(),o.length>0?(o.forEach((a,i)=>{a.control({releaseOthers:i===0})}),c.log("selectActorsFromGroupRoll - Selected tokens",[t,o.length])):c.log("selectActorsFromGroupRoll - No matching tokens, deselected all",[t])}static async preloadTemplate(){c.log("ChatMessageManager.preloadTemplate");try{await q.loadTemplates([this.templatePath])}catch(e){c.error("Failed to preload template",e)}}static async createGroupRollMessage(e,t,s,o,a){var f;c.log("ChatMessageManager.createGroupRollMessage",[e.length,t,s,a]);const i=e.filter(g=>g&&g.actor);let n=this.groupRollMessages.get(a);if(n||(n=game.messages.contents.find(m=>m.getFlag(k,"groupRollId")===a&&m.getFlag(k,"isGroupRoll")),n&&this.groupRollMessages.set(a,n)),n){c.log("createGroupRollMessage - Found existing message, merging actors",[a]);const g=this.pendingRolls.get(a),m=new Set((g==null?void 0:g.actorEntries.map(M=>M.actorId))||[]),p=i.filter(M=>!m.has(M.actor.id));if(p.length===0)return c.log("createGroupRollMessage - All actors already in group, skipping"),n;const S=p.map(M=>({actorId:M.actor.id,uniqueId:M.uniqueId,tokenId:M.tokenId})),y=[...(g==null?void 0:g.actorEntries)||[],...S];g&&(g.actorEntries=y);const R=n.getFlag(k,"rollData"),A=I(),_=v.get(A.groupRollNPCHidden.tag),T=((f=game.user)==null?void 0:f.isGM)===!0,b=p.map(M=>{var N,W,B,U;const O={actorId:M.actor.id,actorUuid:M.actor.uuid,uniqueId:M.uniqueId,tokenId:M.tokenId,actorImg:M.actor.img||((W=(N=M.actor.prototypeToken)==null?void 0:N.texture)==null?void 0:W.src)||"icons/svg/mystery-man.svg",actorName:M.tokenId&&((U=(B=canvas.tokens)==null?void 0:B.get(M.tokenId))==null?void 0:U.name)||M.actor.name,isNPC:M.actor.type==="npc"||!M.actor.hasPlayerOwner,rolled:!1,showDice:!0,total:null,success:!1,failure:!1,rollTypeFlavor:(R==null?void 0:R.flavor)||""};O.shouldHide=O.isNPC&&_&&!T,O.rollMode=CONST.DICE_ROLL_MODES.PUBLIC;const F=M.actor.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);return T?O.shouldHideRoll=!1:O.rollMode===CONST.DICE_ROLL_MODES.BLIND?O.shouldHideRoll=!0:O.rollMode===CONST.DICE_ROLL_MODES.PRIVATE||O.rollMode===CONST.DICE_ROLL_MODES.SELF?O.shouldHideRoll=!F:O.shouldHideRoll=!1,O}),C={...R,results:[...R.results,...b]},w=C.isContestedRoll?"modules/flash-rolls-5e/templates/chat-msg-contested-roll.hbs":this.templatePath;return await n.update({content:await q.renderTemplate(w,C),flags:{[k]:{rollData:C,isGroupRoll:!0,groupRollId:a}}}),n}const r=this.buildGroupRollData(e,t,s,o,null);if(!r)return c.error("createGroupRollMessage - Failed to build group roll data"),null;r.groupRollId=a,r.isContestedRoll=o.isContestedRoll||!1,this.pendingRolls.set(a,{actorEntries:i.map(g=>({actorId:g.actor.id,uniqueId:g.uniqueId,tokenId:g.tokenId})),rollType:t,rollKey:s,config:o,results:new Map});const d=i.some(g=>g.actor.hasPlayerOwner)?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode");return await this.postGroupMessage(r,d)}static buildGroupRollData(e,t,s,o,a=null){var _,T,b,C;const i=e.filter(w=>w&&w.actor);if(i.length===0)return c.error("buildGroupRollData - No valid actor entries found",[e]),null;let n=this._buildFlavorText(t,s,o);const r=(o==null?void 0:o.dc)||(o==null?void 0:o.target),l=i.map(w=>{var N,W,B,U;const M=w.rollType||t,O=w.rollKey||s,F=o!=null&&o.isContestedRoll?this._buildFlavorText(M,O,o):n;return{actorId:w.actor.id,actorUuid:w.actor.uuid,uniqueId:w.uniqueId,tokenId:w.tokenId,actorImg:w.actor.img||((W=(N=w.actor.prototypeToken)==null?void 0:N.texture)==null?void 0:W.src)||"icons/svg/mystery-man.svg",actorName:w.tokenId&&((U=(B=canvas.tokens)==null?void 0:B.get(w.tokenId))==null?void 0:U.name)||w.actor.name,isNPC:w.actor.type==="npc"||!w.actor.hasPlayerOwner,rolled:!1,showDice:!0,total:null,success:!1,failure:!1,rollTypeFlavor:F}}),d=P.shouldShowDC(t),u=I(),f=v.get(u.showGroupDCToPlayers.tag),g=v.get(u.showGroupResultToPlayers.tag),m=v.get(u.groupRollNPCHidden.tag),p=v.get(u.groupCalculationForSaves.tag),y=t===L.SAVE||t===L.SAVING_THROW?p:!0,R=(o==null?void 0:o.fromMidiWorkflow)??!1,A=((_=game.user)==null?void 0:_.isGM)===!0;return c.log("buildGroupRollData - fromMidiWorkflow",[R,"config.fromMidiWorkflow:",o==null?void 0:o.fromMidiWorkflow,"rollType:",t]),l.forEach(w=>{var O;w.shouldHide=w.isNPC&&m&&!A,w.rollMode=a||CONST.DICE_ROLL_MODES.PUBLIC;const M=(O=i.find(F=>F.uniqueId===w.uniqueId))==null?void 0:O.actor.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);A?w.shouldHideRoll=!1:w.rollMode===CONST.DICE_ROLL_MODES.BLIND?w.shouldHideRoll=!0:w.rollMode===CONST.DICE_ROLL_MODES.PRIVATE||w.rollMode===CONST.DICE_ROLL_MODES.SELF?w.shouldHideRoll=!M:w.shouldHideRoll=!1,c.log("buildGroupRollData - Roll visibility",[w.actorName,"rollMode:",w.rollMode,"isGM:",A,"hasPermission:",M,"shouldHideRoll:",w.shouldHideRoll])}),{flavor:n,results:l,showDC:r!=null,dc:r,rollType:t,rollKey:s,supportsDC:d,showDCToPlayers:f,showResultToPlayers:g,showGroupCalculation:y,groupRollNPCHidden:m,fromMidiWorkflow:R,isGM:A,isSingleActor:i.length===1,actorEntries:i.map(w=>({actorId:w.actor.id,uniqueId:w.uniqueId,tokenId:w.tokenId})),moduleId:k,gmAdvantage:(o==null?void 0:o.advantage)===!0,gmDisadvantage:(o==null?void 0:o.disadvantage)===!0,gmSituationalBonus:(o==null?void 0:o.situationalBonus)||((C=(b=(T=o==null?void 0:o.rolls)==null?void 0:T[0])==null?void 0:b.data)==null?void 0:C.situational)||""}}static _calculateContestedResult(e){const t=e.filter(r=>r.rolled&&r.total!==null);if(t.length<2)return{complete:!1};const[s,o]=t,a=s.total>o.total?s:o,i=s.total>o.total?o:s,n=r=>r.tokenId||r.uniqueId||r.actorId;return c.log("_calculateContestedResult - Results",["result1:",{tokenId:s.tokenId,uniqueId:s.uniqueId,actorId:s.actorId,total:s.total},"result2:",{tokenId:o.tokenId,uniqueId:o.uniqueId,actorId:o.actorId,total:o.total},"winnerId:",n(a),"loserId:",n(i)]),{complete:!0,winnerId:n(a),winnerName:a.actorName,winnerTotal:a.total,loserId:n(i),loserName:i.actorName,loserTotal:i.total,isTie:s.total===o.total}}static _buildFlavorText(e,t,s){var a,i,n,r,l,d,u,f;let o="";switch(e==null?void 0:e.toLowerCase()){case L.ABILITY:case L.ABILITY_CHECK:const g=((a=CONFIG.DND5E.abilities[t])==null?void 0:a.label)||t;o=game.i18n.format("DND5E.AbilityPromptTitle",{ability:g});break;case L.SAVE:case L.SAVING_THROW:const m=((i=CONFIG.DND5E.abilities[t])==null?void 0:i.label)||t;o=game.i18n.format("DND5E.SavePromptTitle",{ability:m});break;case L.SKILL:const p=((n=CONFIG.DND5E.skills[t])==null?void 0:n.label)||t,S=(s==null?void 0:s.ability)||((r=CONFIG.DND5E.skills[t])==null?void 0:r.ability)||"int",y=((l=CONFIG.DND5E.abilities[S])==null?void 0:l.label)||S;c.log("buildFlavorText - skill",[s==null?void 0:s.ability,p,S,y]),o=game.i18n.format("DND5E.SkillPromptTitle",{skill:p,ability:y});break;case L.TOOL:const R=(u=(d=CONFIG.DND5E.enrichmentLookup)==null?void 0:d.tools)==null?void 0:u[t];let A=t;if(R!=null&&R.id){const b=dnd5e.documents.Trait.getBaseItem(R.id,{indexOnly:!0});A=(b==null?void 0:b.name)||t}const _=(s==null?void 0:s.ability)||(R==null?void 0:R.ability)||"int",T=((f=CONFIG.DND5E.abilities[_])==null?void 0:f.label)||_;o=game.i18n.format("DND5E.ToolPromptTitle",{tool:A,ability:T});break;case L.CONCENTRATION:o=game.i18n.localize("DND5E.Concentration")||"Concentration";break;case L.DEATH_SAVE:o=game.i18n.localize("DND5E.DeathSave")||"Death Saving Throw";break;case L.HIT_DIE:case"hitdice":o=game.i18n.localize("DND5E.HitDice")||"Hit Dice";break;case L.HEALING:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Healing")||"Healing";break;case L.CUSTOM:o=(s==null?void 0:s.flavor)||t||game.i18n.localize("DND5E.Roll")||"Custom Roll";break;case L.FORMULA:o=(s==null?void 0:s.flavor)||t||game.i18n.localize("DND5E.Roll")||"Custom Formula";break;case L.ITEM_SAVE:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.SavingThrow")||"Saving Throw";break;case L.INITIATIVE:o=game.i18n.localize("DND5E.Initiative");break;case L.ATTACK:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Attack")||"Attack Roll";break;case L.DAMAGE:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Damage")||"Damage Roll";break;default:o=(s==null?void 0:s.flavor)||"Roll"}return o}static async postGroupMessage(e,t=null){c.log("postGroupMessage - groupRollId",[e.groupRollId,t]);try{const s=e.isContestedRoll?"modules/flash-rolls-5e/templates/chat-msg-contested-roll.hbs":this.templatePath,o=await q.renderTemplate(s,e);let a=game.i18n.localize("FLASH_ROLLS.chat.groupRoll");e.isContestedRoll?a=game.i18n.localize("FLASH_ROLLS.chat.contestedRoll"):e.isSingleActor&&(a=game.i18n.localize("FLASH_ROLLS.chat.rollRequest"));const i={content:o,speaker:{alias:a},flags:{[k]:{isGroupRoll:!0,isContestedRoll:e.isContestedRoll||!1,groupRollId:e.groupRollId,rollData:e},rsr5e:{processed:!0,quickRoll:!1}}};t&&ChatMessage.applyRollMode(i,t);const n=await ChatMessage.create(i);return this.groupRollMessages.set(e.groupRollId,n),n}catch(s){return c.error("Failed to post group message",s),null}}static async updateGroupRollMessage(e,t,s,o=CONST.DICE_ROLL_MODES.PUBLIC){if(game.user.isGM)return c.log("ChatMessageManager.updateGroupRollMessage #0",[e,t,s,o]),await this._performGroupRollUpdate(e,t,s,o)}static async _performGroupRollUpdate(e,t,s,o=CONST.DICE_ROLL_MODES.PUBLIC){var m,p,S,y,R,A,_;let a=this.groupRollMessages.get(e),i=this.pendingRolls.get(e);if(!a&&(a=game.messages.contents.find(b=>b.getFlag(k,"groupRollId")===e&&b.getFlag(k,"isGroupRoll")),a&&(this.groupRollMessages.set(e,a),c.log("_performGroupRollUpdate - Found and registered group message",[e]),!i))){const b=a.getFlag(k,"rollData");i={actorEntries:b.actorEntries||b.results.map(C=>({actorId:C.actorId,uniqueId:C.uniqueId,tokenId:C.tokenId})),results:new Map},this.pendingRolls.set(e,i)}if(!a){c.log("No group message found for groupRollId",e);return}i&&i.results&&i.results.set(t,{total:s.total,roll:s});const n=a.getFlag(k,"rollData");c.log("_performGroupRollUpdate - Searching for uniqueId",[t,"in results:",n.results.map(T=>({uniqueId:T.uniqueId,actorId:T.actorId,tokenId:T.tokenId}))]);let r=n.results.findIndex(T=>T.uniqueId===t);if(r===-1){if(r=n.results.findIndex(T=>T.tokenId===t),r!==-1&&c.log("_performGroupRollUpdate - Found by tokenId",[r]),r===-1){const T=((m=canvas.tokens)==null?void 0:m.get(t))||((S=(p=game.scenes.active)==null?void 0:p.tokens)==null?void 0:S.get(t));if(T&&T.actor){const b=T.actor.id;c.log("_performGroupRollUpdate - Trying token actor match",[t,"token actor:",b]),T.actorLink===!1&&(r=n.results.findIndex(C=>C.tokenId===t)),r===-1&&(r=n.results.findIndex(C=>C.actorId===b&&!C.rolled),r===-1&&(r=n.results.findIndex(C=>C.actorId===b))),r!==-1&&c.log("_performGroupRollUpdate - Found by token lookup",[r])}}if(r===-1&&(r=n.results.findIndex(T=>T.actorId===t),r!==-1&&c.log("_performGroupRollUpdate - Found by actorId",[r])),r===-1&&((y=a.speaker)!=null&&y.actor)){const T=a.speaker.actor;r=n.results.findIndex(b=>b.actorId===T),r!==-1&&c.log("_performGroupRollUpdate - Found by speaker actorId",[r])}r===-1&&n.isContestedRoll&&(r=n.results.findIndex(T=>T.actorId===t&&!T.rolled),r!==-1&&c.log("_performGroupRollUpdate - Found first unrolled result for actor in contested roll",[r]))}if(r!==-1){n.results[r].rolled=!0,n.results[r].showDice=!1,n.results[r].total=s.total,n.results[r].roll=s.toJSON(),n.results[r].rollMode=o,c.log("_performGroupRollUpdate - Set roll mode for result",[n.results[r].actorName,"rollMode:",o]);try{let b=await s.render();n.results[r].rollBreakdown=b}catch(b){c.error("Error rendering roll breakdown",[b]),n.results[r].rollBreakdown=null}n.showDC&&n.dc&&(n.results[r].success=s.total>=n.dc,n.results[r].failure=s.total<n.dc);const T={actorUuid:n.results[r].actorUuid,actorId:n.results[r].actorId,tokenId:n.results[r].tokenId,roll:s.toJSON(),total:s.total,rollType:n.rollType,rollKey:n.rollKey,groupRollId:e,dc:n.dc||null,success:n.dc?s.total>=n.dc:null};me.execForAll(Xe.broadcastRollComplete,T)}else{c.error("Group message id not found");return}n.allRolled=n.results.every(T=>T.rolled),n.messageId=a.id,n.supportsDC=P.shouldShowDC(n.rollType);const l=I();n.showDCToPlayers=v.get(l.showGroupDCToPlayers.tag),n.showResultToPlayers=v.get(l.showGroupResultToPlayers.tag),n.groupRollNPCHidden=v.get(l.groupRollNPCHidden.tag);const d=v.get(l.groupCalculationForSaves.tag),u=n.rollType===L.SAVE||n.rollType===L.SAVING_THROW;if(n.showGroupCalculation=u?d:!0,n.isGM=((R=game.user)==null?void 0:R.isGM)===!0,n.results&&n.results.forEach(T=>{if(T.isNPC===void 0){const w=game.actors.get(T.actorId);T.isNPC=w?w.type==="npc"||!w.hasPlayerOwner:!1}T.shouldHide=T.isNPC&&n.groupRollNPCHidden&&!n.isGM,T.rollMode===void 0&&(T.rollMode=CONST.DICE_ROLL_MODES.PUBLIC);const b=game.actors.get(T.actorId),C=b==null?void 0:b.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);n.isGM?T.shouldHideRoll=!1:T.rollMode===CONST.DICE_ROLL_MODES.BLIND?T.shouldHideRoll=!0:T.rollMode===CONST.DICE_ROLL_MODES.PRIVATE||T.rollMode===CONST.DICE_ROLL_MODES.SELF?T.shouldHideRoll=!C:T.shouldHideRoll=!1,c.log("_performGroupRollUpdate - Result visibility calculated",[T.actorName,"rollMode:",T.rollMode,"isGM:",n.isGM,"hasPermission:",C,"shouldHideRoll:",T.shouldHideRoll])}),n.isContestedRoll){const T=this._calculateContestedResult(n.results);n.contestedResult=T,T.complete&&T.winnerId&&!T.isTie&&n.results.forEach(b=>{const C=b.tokenId||b.uniqueId||b.actorId;b.isWinner=C===T.winnerId,b.isLoser=C===T.loserId,c.log("updateGroupRollMessage - Setting winner/loser",["resultId:",C,"winnerId:",T.winnerId,"loserId:",T.loserId,"isWinner:",b.isWinner,"isLoser:",b.isLoser])}),c.log("updateGroupRollMessage - Contested Result",[T])}else if(n.supportsDC&&n.showDC&&n.dc){const T=((A=n.actorEntries)==null?void 0:A.map(C=>game.actors.get(C.actorId)).filter(C=>C))||((_=n.actors)==null?void 0:_.map(C=>game.actors.get(C)).filter(C=>C))||[],b=P.getGroupResult(n.results,n.dc,T,n.rollType,n.rollKey);n.groupResult=b,c.log("updateGroupRollMessage - COMPLETE?",[b.complete]),b.complete&&b.details&&(n.groupSummary=b.details.summary)}const f=n.isContestedRoll?"modules/flash-rolls-5e/templates/chat-msg-contested-roll.hbs":this.templatePath,g=await q.renderTemplate(f,n);await a.update({content:g,flags:{[k]:{rollData:n},rsr5e:{processed:!0,quickRoll:!1}}}),i!=null&&i.results&&(i!=null&&i.actorEntries)&&i.results.size===i.actorEntries.length&&(this.pendingRolls.delete(e),this._scheduleMessageRemoval(a),n.supportsDC&&n.dc&&!n.isContestedRoll&&this._handleAutoSelectOnComplete(a,n),setTimeout(()=>{this.groupRollMessages.delete(e),this.updateQueue.delete(e)},6e4))}static _handleAutoSelectOnComplete(e,t){if(!game.user.isGM)return;const s=I(),o=v.get(s.autoSelectOnGroupRoll.tag);if(o===0)return;let a;switch(o){case 1:a="failed";break;case 2:a="passed";break;case 3:a="all";break;default:return}setTimeout(()=>{this.selectActorsFromGroupRoll(e,a)},100)}static async updateGroupRollDC(e,t){var d,u,f;const s=e.getFlag(k,"rollData");if(!s||(s.supportsDC=P.shouldShowDC(s.rollType),!s.supportsDC))return;s.dc=t,s.showDC=!0,s.results.forEach(g=>{g.rolled&&g.total!==null&&(g.success=g.total>=t,g.failure=g.total<t)});const o=((d=s.actorEntries)==null?void 0:d.map(g=>game.actors.get(g.actorId)).filter(g=>g))||((u=s.actors)==null?void 0:u.map(g=>game.actors.get(g)).filter(g=>g))||[],a=P.getGroupResult(s.results,t,o,s.rollType,s.rollKey);s.groupResult=a,a.complete&&a.details&&(s.groupSummary=a.details.summary),s.allRolled=s.results.every(g=>g.rolled),s.messageId=e.id;const i=I();s.showDCToPlayers=v.get(i.showGroupDCToPlayers.tag),s.showResultToPlayers=v.get(i.showGroupResultToPlayers.tag),s.groupRollNPCHidden=v.get(i.groupRollNPCHidden.tag);const n=v.get(i.groupCalculationForSaves.tag),r=s.rollType===L.SAVE||s.rollType===L.SAVING_THROW;s.showGroupCalculation=r?n:!0,s.isGM=((f=game.user)==null?void 0:f.isGM)===!0,s.results&&s.results.forEach(g=>{if(g.isNPC===void 0){const m=game.actors.get(g.actorId);g.isNPC=m?!m.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED):!1}g.shouldHide=g.isNPC&&s.groupRollNPCHidden&&!s.isGM});const l=await q.renderTemplate(this.templatePath,s);await e.update({content:l,flags:{[k]:{rollData:s},rsr5e:{processed:!0,quickRoll:!1}}})}static interceptRollMessage(e,t,s){var y,R,A,_,T,b,C,w,M,O,F;const o=I(),a=v.get(o.groupRollsMsgEnabled.tag),i=e.getFlag(k,"actorUniqueId"),n=(y=e.speaker)==null?void 0:y.actor,r=(R=e.speaker)==null?void 0:R.token;c.log("interceptRollMessage - speaker info",["actorUniqueId from flag:",i,e]);let l,d;if(i){const N=(A=game.scenes.active)==null?void 0:A.tokens.get(i);N!=null&&N.actor?(l=N.actor,d=i):(l=game.actors.get(i),d=i)}if(!l){if(r){const N=((_=canvas.tokens)==null?void 0:_.get(r))||((b=(T=game.scenes.active)==null?void 0:T.tokens)==null?void 0:b.get(r));l=N==null?void 0:N.actor}l||(l=game.actors.get(n)),d=r||n}if(!l)return;c.log("interceptRollMessage - using uniqueId:",[d,"for actor:",l.name]);const u=e.getFlag(k,"isFlashRollRequest"),f=e.getFlag(k,"rollType"),g=e.getFlag(k,"rollKey"),m=(C=e.rolls)==null?void 0:C[0];if(!a){u&&m&&(this._broadcastIndividualRollComplete(l,m,f,g,r),this._scheduleIndividualMessageRemoval(e,f));return}const p=e.getFlag(k,"groupRollId")||l.getFlag(k,"tempGroupRollId")||((w=l.getFlag(k,"tempInitiativeConfig"))==null?void 0:w.groupRollId);if(!p){if(c.log("interceptRollMessage #2 - no groupRollId in flag",[l.name]),game.user.isGM&&m&&a){const N=this._findMatchingPendingRoll(l,d,e);if(N)return c.log("interceptRollMessage - Found matching pending roll for external roll",[l.name,N]),this._processMatchedExternalRoll(e,t,l,d,N,m,r)}if(u&&m&&this._broadcastIndividualRollComplete(l,m,f,g,r),q.isModuleOn("midi-qol")){const N=e.getFlag("midi-qol","requestId");N&&game.user.isGM&&((F=(O=(M=e.flags)==null?void 0:M.dnd5e)==null?void 0:O.roll)==null?void 0:F.type)==="save"&&(c.log("interceptRollMessage - Midi-QOL save roll detected, scheduling removal",[l.name,N]),this._scheduleMidiSaveRemoval(e))}return}if(!game.user.isGM&&!this.groupRollMessages.has(p)){const W=game.messages.contents.find(B=>B.getFlag(k,"groupRollId")===p&&B.getFlag(k,"isGroupRoll"));W&&(this.groupRollMessages.set(p,W),c.log("interceptRollMessage - Registered group roll message",[l.name,p]))}if(!this.groupRollMessages.has(p)){const W=game.messages.contents.find(B=>B.getFlag(k,"groupRollId")===p&&B.getFlag(k,"isGroupRoll"));if(W)c.log("interceptRollMessage - Found group message in chat log, registering",[p]),this.groupRollMessages.set(p,W);else{c.log("interceptRollMessage - No group message found in chat log either",[p]);return}}if(!m)return;let S=CONST.DICE_ROLL_MODES.PUBLIC;if(e.blind)S=CONST.DICE_ROLL_MODES.BLIND;else if(e.whisper&&e.whisper.length>0){const N=game.users.filter(B=>B.isGM).map(B=>B.id);e.whisper.every(B=>N.includes(B))&&(S=CONST.DICE_ROLL_MODES.PRIVATE)}c.log("interceptRollMessage - Message details",["message.rollMode:",e.rollMode,"message.blind:",e.blind,"message.whisper:",e.whisper,"determined rollMode:",S]),t&&t instanceof HTMLElement&&t.style&&(t.style.display="none"),game.user.isGM?(c.log("interceptRollMessage - Updating group message",[p,d,l.name,m.total,"rollMode:",S]),this.updateGroupRollMessage(p,d,m,S),this._scheduleMessageDeletion(e.id,"interceptRollMessage")):c.log("interceptRollMessage - Player roll intercepted, GM will handle update",[p])}static isGroupRoll(e){return this.pendingRolls.has(e)||this.groupRollMessages.has(e)}static _scheduleMessageDeletion(e,t="scheduleMessageDeletion"){if(!e||this.messagesScheduledForDeletion.has(e))return;this.messagesScheduledForDeletion.add(e);const s=()=>{const a=document.querySelector(`[data-message-id="${e}"]`);a?(a.style.display="none !important",c.log(`${t} - Hidden message element`,[e])):c.log(`${t} - Message element not found in DOM`,[e])};s(),requestAnimationFrame(s),setTimeout(s,100);const o=Hooks.once("flash-rolls-5e.rollComplete",async()=>{c.log(`${t} - rollComplete hook fired, deleting message`,[e]);try{const a=game.messages.get(e);a?(await a.delete(),c.log(`${t} - Deleted individual message`,[e])):c.log(`${t} - Message already deleted or not found`,[e])}catch(a){c.error(`${t} - Error deleting message`,[e,a])}finally{this.messagesScheduledForDeletion.delete(e)}});setTimeout(()=>{if(this.messagesScheduledForDeletion.has(e)){Hooks.off("flash-rolls-5e.rollComplete",o),this.messagesScheduledForDeletion.delete(e),c.log(`${t} - Fallback timeout, hook didn't fire`,[e]);const a=game.messages.get(e);a&&a.delete().catch(()=>{})}},5e3)}static _findMatchingPendingRoll(e,t,s){var r,l,d,u,f,g,m,p;const o=(l=(r=s.flags)==null?void 0:r.dnd5e)==null?void 0:l.roll,a=(u=(d=s.flags)==null?void 0:d.core)==null?void 0:u.initiativeRoll;if(!(o!=null&&o.type)&&!a)return null;const i=a?"initiative":o.type,n=(o==null?void 0:o.skillId)||(o==null?void 0:o.toolId)||(o==null?void 0:o.ability);c.log("_findMatchingPendingRoll - searching",[e.name,"dndRollType:",i,"rollKey:",n,"isInitiativeRoll:",a,"pendingRolls count:",this.pendingRolls.size]);for(const[S,y]of this.pendingRolls.entries()){if(!((f=y.actorEntries)==null?void 0:f.find(b=>b.actorId===e.id||b.uniqueId===t||b.tokenId===t)))continue;const A=(g=y.rollType)==null?void 0:g.toLowerCase();let _=!1;if((i==="skill"&&A===L.SKILL||i==="tool"&&A===L.TOOL||i==="ability"&&(A===L.ABILITY||A===L.ABILITY_CHECK)||i==="save"&&(A===L.SAVE||A===L.SAVING_THROW)||i==="attack"&&A===L.ATTACK||i==="damage"&&(A===L.DAMAGE||A===L.HEALING)||i==="death"&&A===L.DEATH_SAVE||i==="initiative"&&A===L.INITIATIVE)&&(_=!0),!_){c.log("_findMatchingPendingRoll - type mismatch",[S,"pending:",A,"dnd5e:",i]);continue}if(n&&y.rollKey&&n!==y.rollKey){c.log("_findMatchingPendingRoll - key mismatch",[S,"pending:",y.rollKey,"dnd5e:",n]);continue}if(((m=y.results)==null?void 0:m.get(t))||((p=y.results)==null?void 0:p.get(e.id))){c.log("_findMatchingPendingRoll - already rolled",[S,e.name]);continue}return c.log("_findMatchingPendingRoll - found match!",[S,e.name]),S}return null}static _processMatchedExternalRoll(e,t,s,o,a,i,n){if(!this.groupRollMessages.has(a)){const u=game.messages.contents.find(f=>f.getFlag(k,"groupRollId")===a&&f.getFlag(k,"isGroupRoll"));if(u)this.groupRollMessages.set(a,u),c.log("_processMatchedExternalRoll - Registered group message",[a]);else{c.log("_processMatchedExternalRoll - No group message found",[a]);return}}let r=CONST.DICE_ROLL_MODES.PUBLIC;if(e.blind)r=CONST.DICE_ROLL_MODES.BLIND;else if(e.whisper&&e.whisper.length>0){const d=game.users.filter(f=>f.isGM).map(f=>f.id);e.whisper.every(f=>d.includes(f))&&(r=CONST.DICE_ROLL_MODES.PRIVATE)}const l=t instanceof jQuery?t[0]:(t==null?void 0:t[0])||t;l&&l.style&&(l.style.display="none"),c.log("_processMatchedExternalRoll - Updating group message",[a,o,s.name,i.total,"rollMode:",r]),this.updateGroupRollMessage(a,o,i,r),this._scheduleMessageDeletion(e.id,"_processMatchedExternalRoll")}static async addGroupRollFlag(e,t,s=null,o=null){const a=I(),i=v.get(a.groupRollsMsgEnabled.tag);if(c.log("addGroupRollFlag called",[e,t.groupRollId,this.isGroupRoll(t.groupRollId),o]),!game.user.isGM&&t.groupRollId&&s&&(await s.setFlag(k,"tempGroupRollId",t.groupRollId),s.isToken&&s.actor&&(await s.actor.setFlag(k,"tempGroupRollId",t.groupRollId),c.log("addGroupRollFlag - Also stored tempGroupRollId on base actor for player",[t.groupRollId,s.actor.id])),!this.groupRollMessages.has(t.groupRollId))){const r=game.messages.contents.find(l=>l.getFlag(k,"groupRollId")===t.groupRollId&&l.getFlag(k,"isGroupRoll"));r&&(this.groupRollMessages.set(t.groupRollId,r),c.log("addGroupRollFlag - Registered group roll message on player side",[t.groupRollId]))}e.data=e.data||{},e.data.flags=e.data.flags||{},e.data.flags[k]=e.data.flags[k]||{},e.data.flags[k].isFlashRollRequest=!0,o&&(e.data.flags[k].rollType=o),t.rollKey&&(e.data.flags[k].rollKey=t.rollKey),i&&t.groupRollId&&(!game.user.isGM||this.isGroupRoll(t.groupRollId))&&(e.data.flags[k].groupRollId=t.groupRollId,e.data.flags.rsr5e={...e.data.flags.rsr5e,processed:!0,quickRoll:!1},c.log("addGroupRollFlag - Added groupRollId flag to messageConfig",[e]))}static _broadcastIndividualRollComplete(e,t,s,o,a){if(!e||!t)return;const i={actorUuid:e.uuid,actorId:e.id,tokenId:a||null,roll:t.toJSON(),total:t.total,rollType:s||null,rollKey:o||null,groupRollId:null,dc:null,success:null};c.log("_broadcastIndividualRollComplete - Broadcasting hook",[e.name,s,o,t.total]),me.execForAll(Xe.broadcastRollComplete,i)}static _scheduleMessageRemoval(e){if(!game.user.isGM)return;const t=I();if(!v.get(t.removeSaveMsgAfterRoll.tag)){c.log("_scheduleMessageRemoval - removeSaveMsgAfterRoll disabled, skipping");return}const o=e.getFlag(k,"rollData"),a=q.isModuleOn("midi-qol")?e.getFlag("midi-qol","requestId"):null,i=(o==null?void 0:o.fromMidiWorkflow)||!!a;c.log("_scheduleMessageRemoval - checking",[e.id,"rollType:",o==null?void 0:o.rollType,"fromMidiWorkflow:",i,"flagData.fromMidiWorkflow:",o==null?void 0:o.fromMidiWorkflow,"midiRequestId:",a,"full flagData:",o]),!(!i||!((o==null?void 0:o.rollType)===L.SAVE||(o==null?void 0:o.rollType)===L.SAVING_THROW))&&(c.log("_scheduleMessageRemoval - Scheduling hide/delete for save message",[e.id]),this._scheduleDelayedMessageRemoval(e.id,"_scheduleMessageRemoval"))}static _scheduleMidiSaveRemoval(e){const t=I();v.get(t.removeSaveMsgAfterRoll.tag)&&(c.log("_scheduleMidiSaveRemoval - Scheduling hide/delete for Midi-QOL save message",[e.id]),this._scheduleDelayedMessageRemoval(e.id,"_scheduleMidiSaveRemoval"))}static _scheduleIndividualMessageRemoval(e,t){if(!game.user.isGM)return;const s=I();if(!v.get(s.removeSaveMsgAfterRoll.tag))return;const a=q.isModuleOn("midi-qol")?e.getFlag("midi-qol","requestId"):null;!(e.getFlag(k,"fromMidiWorkflow")||a)||!(t===L.SAVE||t===L.SAVING_THROW)||(c.log("_scheduleIndividualMessageRemoval - Scheduling hide/delete for individual save message",[e.id,"midiRequestId:",a]),this._scheduleDelayedMessageRemoval(e.id,"_scheduleIndividualMessageRemoval"))}static _scheduleDelayedMessageRemoval(e,t="scheduleDelayedMessageRemoval"){!e||this.messagesScheduledForDeletion.has(e)||(this.messagesScheduledForDeletion.add(e),setTimeout(()=>{const s=document.querySelector(`[data-message-id="${e}"]`);s&&(s.style.display="none",c.log(`${t} - Hidden message element after 1s`,[e]))},1e3),setTimeout(async()=>{c.log(`${t} - Deleting message after 2s`,[e]);try{const s=game.messages.get(e);s&&(await s.delete(),c.log(`${t} - Deleted message`,[e]))}catch(s){c.error(`${t} - Error deleting message`,[e,s])}finally{this.messagesScheduledForDeletion.delete(e)}},2e3))}static cleanup(){const e=Date.now()-3e5;for(const[t,s]of this.groupRollMessages.entries())s.timestamp<e&&(this.groupRollMessages.delete(t),this.pendingRolls.delete(t))}};E(be,"groupRollMessages",new Map),E(be,"pendingRolls",new Map),E(be,"messagesScheduledForDeletion",new Set),E(be,"updateQueue",new Map),E(be,"templatePath","modules/flash-rolls-5e/templates/chat-msg-group-roll.hbs"),E(be,"_previewToken",null),E(be,"_previouslyControlled",[]),E(be,"_originalControlledGetter",null);let ne=be;const ke={ability:async(h,e,t,s,o)=>{const a=s.configure!==!1,i=P.buildRollConfig(e,t,{ability:e.rollKey},a);await ne.addGroupRollFlag(o,e,h,L.ABILITY),await h.rollAbilityCheck(i,s,o)},abilitycheck:async(h,e,t,s,o)=>ke.ability(h,e,t,s,o),save:async(h,e,t,s,o)=>{var n;const a=s.configure!==!1,i=P.buildRollConfig(e,t,{ability:((n=e.config)==null?void 0:n.ability)||e.rollKey},a);await ne.addGroupRollFlag(o,e,h,L.SAVE),await h.rollSavingThrow(i,s,o)},savingthrow:async(h,e,t,s,o)=>ke.save(h,e,t,s,o),skill:async(h,e,t,s,o)=>{var r,l,d,u;const a=s.configure!==!1,i=((l=(r=h.system.skills)==null?void 0:r[e.rollKey])==null?void 0:l.ability)||((u=(d=CONFIG.DND5E.skills)==null?void 0:d[e.rollKey])==null?void 0:u.ability)||void 0,n=P.buildRollConfig(e,t,{skill:e.rollKey,chooseAbility:a,ability:e.config.ability||i},a);await ne.addGroupRollFlag(o,e,h,L.SKILL),await h.rollSkill(n,s,o)},tool:async(h,e,t,s,o)=>{var l,d,u,f;const a=s.configure!==!1,i=(l=h.system.tools)==null?void 0:l[e.rollKey],n=(i==null?void 0:i.ability)||((f=(u=(d=CONFIG.DND5E.enrichmentLookup)==null?void 0:d.tools)==null?void 0:u[e.rollKey])==null?void 0:f.ability)||"int",r=P.buildRollConfig(e,t,{tool:e.rollKey,chooseAbility:a,ability:e.config.ability||n},a);c.log("RollHandlers.tool #2",[r,s,o]),await ne.addGroupRollFlag(o,e,h,L.TOOL),await h.rollToolCheck(r,s,o)},concentration:async(h,e,t,s,o)=>{const a=s.configure!==!1,i=P.buildRollConfig(e,t,{},a);await ne.addGroupRollFlag(o,e,h,L.CONCENTRATION),await h.rollConcentration(i,s,o)},attack:async(h,e,t,s,o)=>{await ke.handleActivityRoll(h,L.ATTACK,e,t,s,o)},damage:async(h,e,t,s,o)=>{await ke.handleActivityRoll(h,L.DAMAGE,e,t,s,o)},itemsave:async(h,e,t,s,o)=>{await ke.handleActivityRoll(h,L.ITEM_SAVE,e,t,s,o)},initiative:async(h,e,t,s,o)=>{var i,n,r;if(!game.combat){D.notify("warn",game.i18n.localize("COMBAT.NoneActive"));return}e.config.situational||(i=t.data)!=null&&i.situational,e.groupRollId;let a=h;if(!h.isToken){const l=canvas.tokens.placeables.find(d=>{var u;return((u=d.actor)==null?void 0:u.id)===h.id});if(l)a=l.actor;else{D.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.noTokensForInitiative"));return}}await ne.addGroupRollFlag(o,e,h,L.INITIATIVE);try{if(s.configure){if(c.log("RollHandlers.initiative - Dialog",[]),e.config){const l=P.buildRollConfig(e,t,{ability:((r=(n=h.system.attributes)==null?void 0:n.init)==null?void 0:r.ability)||"dex"},!0),d={advantage:e.config.advantage||!1,disadvantage:e.config.disadvantage||!1,rollMode:e.config.rollMode||game.settings.get("core","rollMode"),rolls:l.rolls,groupRollId:e.groupRollId};await h.setFlag(k,"tempInitiativeConfig",d),await a.setFlag(k,"tempInitiativeConfig",d)}await a.rollInitiativeDialog(),await a.unsetFlag(k,"tempInitiativeConfig"),await h.unsetFlag(k,"tempInitiativeConfig")}else{const l={rollMode:e.config.rollMode||game.settings.get("core","rollMode"),groupRollId:e.groupRollId};await h.setFlag(k,"tempInitiativeConfig",l),await a.setFlag(k,"tempInitiativeConfig",l);const d={createCombatants:!0,rerollInitiative:!0};await a.rollInitiative(d),await a.unsetFlag(k,"tempInitiativeConfig"),await h.unsetFlag(k,"tempInitiativeConfig")}}catch(l){c.error("RollHandlers.initiative - Error",[l]),pe.notify("error",`Initiative roll failed: ${l.message}`)}},initiativedialog:async(h,e,t,s,o)=>ke.initiative(h,e,t,s,o),deathsave:async(h,e,t,s,o)=>{const a=s.configure!==!1,i=P.buildRollConfig(e,t,{},a);await ne.addGroupRollFlag(o,e,h,L.DEATH_SAVE),await h.rollDeathSave(i,s,o)},hitdie:async(h,e,t,s,o)=>{s.configure=game.user.isGM?s.configure:!0;const a=s.configure!==!1,i=P.buildRollConfig(e,t,{denomination:e.rollKey},a);c.log("RollHandlers.hitdie",[i,s,o]),await ne.addGroupRollFlag(o,e,h,L.HIT_DIE),await h.rollHitDie(i,s,o)},custom:async(h,e,t,s,o)=>{await ke.handleCustomRoll(h,e,s,o)},async handleActivityRoll(h,e,t,s,o,a){var i,n;if(c.log("RollHandlers.handleActivityRoll",[e,t,s]),t.rollKey){const r=game.user.isGM&&t.config.skipRollDialog!==void 0?!t.config.skipRollDialog:o.configure,l=r!==!1,d=P.buildRollConfig(t,s,{},l),u=((n=(i=d.rolls)==null?void 0:i[0])==null?void 0:n.options)||{},f={usage:{...t.config,rollType:e,rolls:d.rolls,...u.attackMode&&{attackMode:u.attackMode},...u.ammunition&&{ammunition:u.ammunition},...u.mastery!==void 0&&{mastery:u.mastery},...t.config.spell&&{spell:t.config.spell},...t.config.scaling!==void 0&&{scaling:t.config.scaling},...t.config.consume&&{consume:t.config.consume},...t.config.create&&{create:t.config.create}},dialog:{...o,configure:r},message:a};c.log("handleActivityRoll - final activity config",[f]),await Me.executeActivityRoll(h,e,t.rollKey,t.activityId,f)}},async handleCustomRoll(h,e,t,s){var i,n,r,l;const o=e.rollKey;if(c.log("handleCustomRoll",[h.name,"formula:",o,"requestData:",e,"dialogConfig:",t]),(t==null?void 0:t.configure)===!1){try{const d=new Roll(o,h.getRollData());d.options=d.options||{},d.options.isRollRequest=((i=e.config)==null?void 0:i.isRollRequest)!==!1,await d.evaluate(),await ne.addGroupRollFlag(s,e,h),await d.toMessage({speaker:ChatMessage.getSpeaker({actor:h}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${L.CUSTOM}`),rollMode:(s==null?void 0:s.rollMode)||((n=e.config)==null?void 0:n.rollMode)||game.settings.get("core","rollMode"),isRollRequest:((r=e.config)==null?void 0:r.isRollRequest)!==!1,create:(s==null?void 0:s.create)!==!1,flags:(l=s==null?void 0:s.data)==null?void 0:l.flags})}catch(d){c.error("handleCustomRoll - Roll evaluation failed",[d,"formula:",o]),D.notify("error",game.i18n.format("FLASH_ROLLS.notifications.invalidFormula",{formula:o}))}return}new ds({formula:o,readonly:!0,actor:h,callback:async d=>{var g;const u=typeof d=="string"?d:d.formula,f=typeof d=="string"?e.config.rollMode:d.rollMode||e.config.rollMode;try{const m=new Roll(u,h.getRollData());m.options=m.options||{},m.options.isRollRequest=!0,await m.evaluate(),await ne.addGroupRollFlag(s,e,h),await m.toMessage({speaker:ChatMessage.getSpeaker({actor:h}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${L.CUSTOM}`),rollMode:f,isRollRequest:!0,_showRequestedBy:!0,_requestedBy:e.config.requestedBy||"GM",flags:(g=s==null?void 0:s.data)==null?void 0:g.flags})}catch(m){c.error("handleCustomRoll callback - Roll failed",[m,"formula:",u]),D.notify("error",game.i18n.format("FLASH_ROLLS.notifications.invalidFormula",{formula:u}))}}}).render(!0)},async handleHitDieRecovery(h){const e=foundry.utils.mergeObject({type:"long",deltas:{hitDice:0},newDay:!1,rolls:[],updateData:{},updateItems:[]},{});"dhd"in e&&(e.deltas.hitDice=e.dhd),h._getRestHitDiceRecovery({maxHitDice:h.system.attributes.hd.max,type:"long"},e),e.dhd=e.deltas.hitDice,e.longRest=!0;try{if(e.updateData&&Object.keys(e.updateData).length>0){const t=await h.update(e.updateData,{isRest:!1})}else c.log("No actor updates to perform",[]);if(e.updateItems&&e.updateItems.length>0){const t=await h.updateEmbeddedDocuments("Item",e.updateItems,{isRest:!1})}else c.log("No item updates to perform",[])}catch(t){throw c.error("Error during updates in handleHitDieRecovery:",[t]),t}return c.log("handleHitDieRecovery #3",[e]),e}};async function zs(){return game.combat||(await(await Combat.create({scene:game.scenes.active.id})).activate(),pe.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.combatCreated"))),game.combat}async function Vs(h,e){if(!e.combat)return h;const t=h.map(a=>e.actors.get(a)).filter(a=>a),s=[],o=new Set;for(const a of t)e.combat.getCombatantsByActor(a.id).some(r=>r.initiative!==null)&&(s.push(a.name),o.add(a.id));if(c.log("filterActorsForInitiative",[s]),s.length>0)if(await foundry.applications.api.DialogV2.confirm({window:{title:e.i18n.localize("FLASH_ROLLS.ui.dialogs.rerollInitiativeTitle"),classes:["flash5e-dialog"]},position:{width:420,height:"auto"},content:"<p>"+e.i18n.format("FLASH_ROLLS.ui.dialogs.rerollInitiative",{actors:s.join(", ")})+"</p>",rejectClose:!1,modal:!0})){if(e.user.isGM)for(const i of o){const n=e.combat.getCombatantsByActor(i);c.log("filterActorsForInitiative - resetting initiative for combatants",[n]);for(const r of n)await r.update({initiative:null})}else c.log("filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll");return h}else{const i=h.filter(n=>!o.has(n));return i.length===0&&pe.notify("info",e.i18n.localize("FLASH_ROLLS.notifications.allActorsHaveInitiative")),i}return h}Hooks.once(x.READY,()=>{dnd5e.applications.dice.DamageRollConfigurationDialog||c.warn("DamageRollConfigurationDialog not found in dnd5e.applications.dice")});function Ht(h){return class extends h{constructor(e={},t={},s={}){var o,a;super(e,t,s),this.actors=s.actors||[],this.sendRequest=s.sendRequest??s.isRollRequest??!1,this.showDC=s.showDC||!1,this.dcValue=s.dcValue??s.dc??null,this.rollKey=s.rollKey||e.skill||e.ability||null,this.rollTypeString=s.rollTypeString||null,this.windowTitle=((o=s.window)==null?void 0:o.title)||"",this.windowSubtitle=((a=s.window)==null?void 0:a.subtitle)||""}_buildConfig(e,t,s){const o=t==null?void 0:t.get("ability"),a=t==null?void 0:t.get("dc");o&&(e.ability=o,this.config.ability=o);const i=super._buildConfig(e,t,s);if(a){const n=parseInt(a);isNaN(n)||(i.options=i.options||{},i.options.target=n)}else this.dcValue!==void 0&&this.dcValue!==null&&(i.options=i.options||{},i.options.target=this.dcValue);return c.log(`${this.constructor.name}._buildConfig`,[this.config,t,i]),i}_onChangeForm(e,t){var a;c.log("_onChangeForm",[(a=t.target)==null?void 0:a.value]),super._onChangeForm(e,t);const s=this.element.querySelector('input[name="flash5e-send-request"]');s&&(this.sendRequest=s.checked);const o=this.element.querySelector('input[name="dc"]');o&&o.value&&(this.dcValue=parseInt(o.value)||null)}_finalizeRolls(e){var a,i;const t=super._finalizeRolls(e);if(c.log("_finalizeRolls #1",[t,this.sendRequest]),this.dcValue!==void 0&&this.dcValue!==null)for(const n of t)n.options.target=this.dcValue;this.config.sendRequest=this.sendRequest;const s=(a=this.actors)==null?void 0:a.some(n=>P.isPlayerOwned(n)),o=(i=this.actors)==null?void 0:i.some(n=>!P.isPlayerOwned(n));return this.config.skipRollDialog=P.shouldSkipRollDialog({isPC:s,isNPC:o,sendRequest:this.sendRequest}),t}async _onCreateMacroClick(e){var d;if(e.preventDefault(),e.stopPropagation(),c.log("_onCreateMacroClick",[this]),!this.rollTypeString){ui.notifications.error("Cannot create macro: roll type not defined");return}const t=new foundry.applications.ux.FormDataExtended(this.form),s=t.get("roll.0.situational")||t.get("rolls.0.situational")||"",o=t.get("dc"),a=t.get("flash5e-send-request"),i=t.get("rollMode")||game.settings.get("core","rollMode"),n=t.get("ability"),r=((d=this.actors)==null?void 0:d.map(u=>u.id))||[],l={requestType:this.rollTypeString,rollKey:this.rollKey,actorIds:r,config:{...s&&{situationalBonus:s},...o&&{dc:parseInt(o)},...i!==game.settings.get("core","rollMode")&&{rollMode:i},...n&&{ability:n},sendAsRequest:!!a,skipRollDialog:!0,advantage:!1,disadvantage:!1}};try{await D.createMacro(l),this.close()}catch(u){c.error("Failed to create macro:",[u]),ui.notifications.error(`Failed to create macro: ${u.message}`)}}async _onRender(e,t){var s,o,a;await super._onRender(e,t),((a=(o=(s=this.config.rolls)==null?void 0:s[0])==null?void 0:o.data)!=null&&a.situational||this.config.situational)&&(c.log(`${this.constructor.name}._onRender`,["Triggering rebuild for initial situational bonus"]),this.element&&(this.element.style.transition="none",this.element.style.opacity="1"),requestAnimationFrame(()=>{this.rebuild(),this.element&&requestAnimationFrame(()=>{this.element.style.transition=""})}))}}}class $e extends Ht(dnd5e.applications.dice.D20RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(e,t,s),c.log("constructor - initializing GM Dialog",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}get title(){return this.windowTitle||super.title}_prepareConfigurationData(e,t,s,o){c.log("_prepareConfigurationData",[e,t,s,o]);const a=super._prepareConfigurationData(e,t,s,o);return a.showDC=this.showDC,a.dcValue=this.dcValue,a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,s){return c.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(c.log("_onRender",[e,t]),super._onRender(e,t),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},a=await q.renderTemplate(`modules/${k}/templates/gm-roll-config-fields.hbs`,o),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,s.parentNode.insertBefore(i,s)}this._attachButtonListeners()}_attachButtonListeners(){c.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,s,o={}){var R,A,_,T,b,C,w,M,O;if(e=P.validateActors(e),!e)return null;const a=e[0];c.log("GMRollConfigDialog.initConfiguration",[t,s,o]);const i=t==null?void 0:t.toLowerCase(),n=I(),r=v.get(n.publicPlayerRolls.tag)===!0,l=P.determineRollMode(r,o.rollMode),d=P.shouldShowDC(i),u=P.getRollClass(i),f=P.createBaseRollConfig(a,t,s),g=P.createMessageConfig(a,l);o.situationalBonus&&(f.rolls[0].data.situational=o.situationalBonus),o.advantage===!0?f.rolls[0].options.advantage=!0:o.disadvantage===!0&&(f.rolls[0].options.disadvantage=!0);const m={options:{actors:e,sendRequest:e.some(F=>P.isPlayerOwned(F)),showDC:d,rollKey:s,rollType:u,rollTypeString:i,window:{title:$e._getRollTitle(i,s,a),subtitle:$e._getSubtitle(e)},position:{width:420,height:"auto"},...o}},p=await P.triggerRollDialog(this,f,g,m.options),S=P.processDialogResult(p,e,t,s,o);if(!S)return null;if((R=p.config)!=null&&R.ability&&[L.SKILL,L.TOOL].includes(i)){const F=((_=(A=a.system.skills)==null?void 0:A[s])==null?void 0:_.ability)||((b=(T=CONFIG.DND5E.skills)==null?void 0:T[s])==null?void 0:b.ability);p.config.ability!==F&&(S.ability=p.config.ability)}let y=m.options.window.title;if(p.config.ability&&[L.SKILL,L.TOOL].includes(i)){const F=((C=CONFIG.DND5E.abilities[p.config.ability])==null?void 0:C.label)||p.config.ability;if(i===L.SKILL){const N=((w=CONFIG.DND5E.skills[s])==null?void 0:w.label)||s;y=game.i18n.format("DND5E.SkillPromptTitle",{skill:N,ability:F})}else if(i===L.TOOL){const N=(O=(M=CONFIG.DND5E.enrichmentLookup)==null?void 0:M.tools)==null?void 0:O[s];let W=s;if(N!=null&&N.id){const B=dnd5e.documents.Trait.getBaseItem(N.id,{indexOnly:!0});W=(B==null?void 0:B.name)||s}y=game.i18n.format("DND5E.ToolPromptTitle",{tool:W,ability:F})}}return S.rollTitle=y,S.rollType=i,S.rollKey=s,S}static _getRollTitle(e,t,s){var i,n,r,l,d,u,f,g,m,p,S,y,R;let o="";const a=e==null?void 0:e.toLowerCase();switch([L.SAVE,L.ABILITY,L.ABILITY_CHECK].includes(a)&&!t&&c.warn("Missing rollKey for roll type",[a,t]),a){case L.SKILL:const A=((i=CONFIG.DND5E.skills[t])==null?void 0:i.label)||t,_=(n=s==null?void 0:s.system.skills)==null?void 0:n[t],T=(_==null?void 0:_.ability)||((r=CONFIG.DND5E.skills[t])==null?void 0:r.ability)||"int",b=((l=CONFIG.DND5E.abilities[T])==null?void 0:l.label)||T;o=game.i18n.format("DND5E.SkillPromptTitle",{skill:A,ability:b});break;case L.SAVE:case L.SAVING_THROW:const C=((d=CONFIG.DND5E.abilities[t])==null?void 0:d.label)||t;o=game.i18n.format("DND5E.SavePromptTitle",{ability:C});break;case L.ABILITY:case L.ABILITY_CHECK:const w=((u=CONFIG.DND5E.abilities[t])==null?void 0:u.label)||t;o=game.i18n.format("DND5E.AbilityPromptTitle",{ability:w});break;case L.CONCENTRATION:o=game.i18n.localize("DND5E.Concentration");break;case L.TOOL:const M=(g=(f=CONFIG.DND5E.enrichmentLookup)==null?void 0:f.tools)==null?void 0:g[t];let O=t;if(M!=null&&M.id){const B=dnd5e.documents.Trait.getBaseItem(M.id,{indexOnly:!0});O=(B==null?void 0:B.name)||t}const F=(m=s==null?void 0:s.system.tools)==null?void 0:m[t],N=(F==null?void 0:F.ability)||((y=(S=(p=CONFIG.DND5E.enrichmentLookup)==null?void 0:p.tools)==null?void 0:S[t])==null?void 0:y.ability)||"int",W=((R=CONFIG.DND5E.abilities[N])==null?void 0:R.label)||N;o=game.i18n.format("DND5E.ToolPromptTitle",{tool:O,ability:W});break;case L.DEATH_SAVE:o=game.i18n.localize("DND5E.DeathSave");break;case L.INITIATIVE:case L.INITIATIVE_DIALOG:o=game.i18n.localize("DND5E.Initiative");break;default:o=game.i18n.localize("DND5E.Roll")}return c.log("_getRollTitle",[a,o]),o}static _getSubtitle(e=[]){return e.length===1?e[0].name:e.length>1?game.i18n.localize("FLASH_ROLLS.ui.dialogs.multipleActors"):""}}class js extends Ht(dnd5e.applications.dice.RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=CONFIG.Dice.BasicRoll||Roll,s.showDC=!1,super(e,t,s),c.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config","hit-die-config"]})}_prepareConfigurationData(e,t,s,o){const a=super._prepareConfigurationData(e,t,s,o);return c.log("GMHitDieConfigDialog._prepareConfigurationData",[a]),a.formula="Hit Die (varies by actor)",a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length,t.formula="Hit Die (varies by actor)"),t}async _onRender(e,t){if(super._onRender(e,t),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},a=await q.renderTemplate(`modules/${k}/templates/gm-roll-config-fields.hbs`,o),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,s.parentNode.insertBefore(i,s)}this._attachButtonListeners()}_attachButtonListeners(){c.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}async _processSubmitData(e,t,s){await super._processSubmitData(e,t,s),this.sendRequest=s.get("flash5e-send-request")!=="false",c.log("_processSubmitData",[s,this.config])}_finalizeRolls(e){const t=super._finalizeRolls(e);return this.config.sendRequest=this.sendRequest,t}static async initConfiguration(e,t,s,o={}){var m;if(e=P.validateActors(e),!e)return null;const a=e[0];c.log("GMHitDieConfigDialog, initConfiguration",[]);const i=I(),n=v.get(i.publicPlayerRolls.tag)===!0,r=P.determineRollMode(n,o.rollMode),l={data:a.getRollData(),subject:a,rolls:[{parts:[],data:a.getRollData(),options:{flavor:"Hit Die Roll"}}]};o.situationalBonus&&(l.rolls[0].data.situational=o.situationalBonus);const d=P.createMessageConfig(a,r),u={options:{actors:e,sendRequest:e.some(p=>P.isPlayerOwned(p)),rollKey:s,rollType:CONFIG.Dice.BasicRoll||Roll,window:{title:game.i18n.localize("DND5E.HitDice"),subtitle:$e._getSubtitle(e)},position:{width:420,height:"auto"},...o}},f=await P.triggerRollDialog(this,l,d,u.options);if(!(f!=null&&f.rolls)||f.rolls.length===0)return null;c.log("GMHitDieConfigDialog - dialog result",[f.rolls]);const g=P.processDialogResult(f,e,t,s,o);return g?((m=f.config)!=null&&m.ability&&(g.ability=f.config.ability),g):null}}class Ws extends Ht(dnd5e.applications.dice.SkillToolRollConfigurationDialog){constructor(e={},t={},s={}){const o=foundry.utils.mergeObject(e,{chooseAbility:!0});s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(o,t,s),c.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){c.log("_prepareConfigurationData",[e,t,s,o]);const a=super._prepareConfigurationData(e,t,s,o);return a.showDC=this.showDC,a.dcValue=this.dcValue,a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,s){return c.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(c.log("_onRender",[e,t]),super._onRender(e,t),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},a=await q.renderTemplate(`modules/${k}/templates/gm-roll-config-fields.hbs`,o),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,s.parentNode.insertBefore(i,s)}this._attachButtonListeners()}_attachButtonListeners(){c.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,s,o={}){var R,A,_,T,b,C;if(e=P.validateActors(e),!e)return null;const a=e[0];c.log("GMSkillToolConfigDialog.initConfiguration",[t,s,o]);const i=t==null?void 0:t.toLowerCase(),n=I(),r=v.get(n.publicPlayerRolls.tag)===!0,l=P.determineRollMode(r,o.rollMode),d=P.shouldShowDC(i),u=CONFIG.Dice.D20Roll;let f=null;if(i===L.SKILL){const w=a.system.skills[s];f=(w==null?void 0:w.ability)||((R=CONFIG.DND5E.skills[s])==null?void 0:R.ability)||"int"}else if(i===L.TOOL){const w=(A=a.system.tools)==null?void 0:A[s];f=(w==null?void 0:w.ability)||((b=(T=(_=CONFIG.DND5E.enrichmentLookup)==null?void 0:_.tools)==null?void 0:T[s])==null?void 0:b.ability)||"int"}const g={data:a.getRollData(),subject:a,ability:f,chooseAbility:!0,rolls:[{parts:[],data:a.getRollData(),options:{}}]};o.situationalBonus&&(g.rolls[0].data.situational=o.situationalBonus),o.advantage===!0?g.rolls[0].options.advantage=!0:o.disadvantage===!0&&(g.rolls[0].options.disadvantage=!0),i===L.SKILL?g.skill=s:i===L.TOOL&&(g.tool=s);const m=P.createMessageConfig(a,l),p={options:{actors:e,sendRequest:e.some(w=>P.isPlayerOwned(w)),showDC:d,rollKey:s,rollType:u,rollTypeString:i,window:{title:$e._getRollTitle(i,s,a),subtitle:$e._getSubtitle(e)},position:{width:420,height:"auto"},...o}},S=await P.triggerRollDialog(this,g,m,p.options),y=P.processDialogResult(S,e,t,s,o);return y?((C=S.config)!=null&&C.ability&&[L.SKILL,L.TOOL].includes(i)&&(y.ability=S.config.ability),y.rollTitle=p.options.window.title,y.rollType=i,y.rollKey=s,y):null}}class qo extends Ht(dnd5e.applications.dice.DamageRollConfigurationDialog){constructor(e={},t={},s={}){const o=foundry.utils.mergeObject({configure:!0},e);super(o,t,s),c.log("GMDamageConfigDialog.constructor",[o,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","damage-roll","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){c.log("GMDamageConfigDialog._prepareConfigurationData",[e,t,s,o]);const a=super._prepareConfigurationData(e,t,s,o);return a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _onRender(e,t){if(await super._onRender(e,t),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields")||(q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields")))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!1},a=await q.renderTemplate(`modules/${k}/templates/gm-roll-config-fields.hbs`,o),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,s.parentNode.insertBefore(i,s)}this._attachButtonListeners()}_attachButtonListeners(){c.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,s,o={},a={},i={}){var F,N,W,B,U,le,de;if(e=P.validateActors(e),c.log("GMDamageConfigDialog, initConfiguration",[e,a,i]),!e)return null;const n=e[0],r=(F=a.subject)==null?void 0:F.item,l=n.items.get(s),d=(l==null?void 0:l.id)||(r==null?void 0:r.id);let u={};d&&(u=Ie.getActivityConfigFromCache(d)||{}),c.log("GMDamageConfigDialog - retrieved activity config from cache",[d,u]);const f=I(),g=v.get(f.publicPlayerRolls.tag)===!0,m=P.determineRollMode(g,o.rollMode||a.rollMode),p=t==null?void 0:t.toLowerCase(),S={subject:a.subject||n,data:n.getRollData(),critical:a.critical||{},rolls:a.rolls||[{parts:[],data:n.getRollData(),options:{}}]};o.situationalBonus&&(S.rolls[0].data.situational=o.situationalBonus),c.log("GMDamageConfigDialog, initConfiguration #1",[S]);const y=P.createMessageConfig(n,m);c.log("GMDamageConfigDialog, initConfiguration #2",[y]);const{position:R,...A}=(i==null?void 0:i.options)||{},_={options:{actors:e,sendRequest:e.some(ue=>P.isPlayerOwned(ue)),rollKey:s,rollType:CONFIG.Dice.DamageRoll,rollTypeString:p,window:{title:game.i18n.localize("DND5E.DamageRoll"),subtitle:$e._getSubtitle(e)},...A,...o}},T=await P.triggerRollDialog(this,S,y,_.options);if(!(T!=null&&T.rolls)||T.rolls.length===0)return null;const b=T.rolls[0],C=((N=b==null?void 0:b.data)==null?void 0:N.situational)||"",w=(W=b==null?void 0:b.options)==null?void 0:W.target,M={rolls:[{parts:[],data:C?{situational:C}:{},options:{...w&&{target:w},isCritical:((B=b==null?void 0:b.options)==null?void 0:B.isCritical)||(b==null?void 0:b.isCritical)||!1}}],subject:a.subject||n,target:w,isCritical:((U=b==null?void 0:b.options)==null?void 0:U.isCritical)||(b==null?void 0:b.isCritical)||!1,sendRequest:T.sendRequest,isRollRequest:T.sendRequest,skipRollDialog:((le=T.config)==null?void 0:le.skipRollDialog)??!T.sendRequest,chatMessage:!0,spell:u.spell||a.spell||{},scaling:u.scaling!==void 0?u.scaling:a.scaling,consume:u.consume||a.consume||{},create:u.create||a.create||{}};c.log("GMDamageConfigDialog, initConfiguration #6",[M]);const O=P.determineRollMode(g,(de=T.message)==null?void 0:de.rollMode);return M.rollMode=O,M.rollTitle=_.options.window.title,M.rollType=p,M.rollKey=s,c.log("GMDamageConfigDialog, initConfiguration - result",[M]),M}}class Uo extends Ht(dnd5e.applications.dice.AttackRollConfigurationDialog){constructor(e={},t={},s={}){super(e,t,s),c.log("GMAttackConfigDialog.constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){c.log("GMAttackConfigDialog._prepareConfigurationData",[e,t,s,o]);const a=super._prepareConfigurationData(e,t,s,o);return a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(await super._onRender(e,t),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!1},a=await q.renderTemplate(`modules/${k}/templates/gm-roll-config-fields.hbs`,o),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,s.parentNode.insertBefore(i,s)}this._attachButtonListeners()}_attachButtonListeners(){c.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}_finalizeRolls(e){return this.config.sendRequest=this.sendRequest,!this.sendRequest&&this.config.isRollRequest&&(this.config.isRollRequest=!1),super._finalizeRolls(e)}static async initConfiguration(e,t,s,o={},a={},i={}){var W,B,U,le,de,ue,Ee,ve,Ne;if(e=P.validateActors(e),!e)return null;const n=e[0];c.log("GMAttackConfigDialog, initConfiguration",[]);const r=(W=a.subject)==null?void 0:W.item,l=n.items.get(s),d=(l==null?void 0:l.id)||(r==null?void 0:r.id);let u={};d&&(u=Ie.getActivityConfigFromCache(d)||{}),c.log("GMAttackConfigDialog - retrieved activity config from cache",[d,u]);const f=I(),g=v.get(f.publicPlayerRolls.tag)===!0,m=t==null?void 0:t.toLowerCase(),p={subject:a.subject||n,data:n.getRollData(),rolls:[{parts:[],data:n.getRollData(),options:{}}]};o.situationalBonus&&(p.rolls[0].data.situational=o.situationalBonus);const S=P.determineRollMode(g,o.rollMode),y=P.createMessageConfig(n,S),{position:R,...A}=(i==null?void 0:i.options)||{},_={options:{actors:e,sendRequest:e.some(ze=>P.isPlayerOwned(ze)),rollKey:s,rollType:CONFIG.Dice.D20Roll,rollTypeString:m,window:{title:game.i18n.localize("DND5E.Attack"),subtitle:$e._getSubtitle(e)},...A,...o}},T=await P.triggerRollDialog(this,p,y,_.options);if(c.log("GMAttackConfigDialog, initConfiguration",[T==null?void 0:T.sendRequest]),!(T!=null&&T.rolls)||T.rolls.length===0)return null;const b=T.rolls[0];let C=!1,w=!1;((B=b==null?void 0:b.options)==null?void 0:B.advantageMode)!==void 0&&(C=b.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,w=b.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const M=((U=b==null?void 0:b.data)==null?void 0:U.situational)||"",O=(le=b==null?void 0:b.options)==null?void 0:le.target,F={rolls:[{parts:[],data:M?{situational:M}:{},options:{...O&&{target:O},...((de=b==null?void 0:b.options)==null?void 0:de.ammunition)&&{ammunition:b.options.ammunition},...((ue=b==null?void 0:b.options)==null?void 0:ue.attackMode)&&{attackMode:b.options.attackMode},...((Ee=b==null?void 0:b.options)==null?void 0:Ee.mastery)!==void 0&&{mastery:b.options.mastery}}}],subject:a.subject||n,advantage:C,disadvantage:w,target:O,sendRequest:T.sendRequest,isRollRequest:T.sendRequest,skipRollDialog:((ve=T.config)==null?void 0:ve.skipRollDialog)??!T.sendRequest,chatMessage:!q.isModuleOn("midi-qol")||!0,spell:(u==null?void 0:u.spell)||(a==null?void 0:a.spell)||{},scaling:(u==null?void 0:u.scaling)!==void 0?u==null?void 0:u.scaling:a==null?void 0:a.scaling,consume:(u==null?void 0:u.consume)||(a==null?void 0:a.consume)||{},create:(u==null?void 0:u.create)||(a==null?void 0:a.create)||{}},N=P.determineRollMode(g,(Ne=T.message)==null?void 0:Ne.rollMode);return F.rollMode=N,F.rollTitle=_.options.window.title,F.rollType=m,F.rollKey=s,c.log("GMAttackConfigDialog, initConfiguration - SIMPLIFIED result",[F]),F}}class us{static initialize(){c.log("RollInterceptor.initialize"),game.user.isGM&&this.registerHooks()}static registerHooks(){c.log("RollInterceptor.registerHooks"),this._registerHook(Y.PRE_ROLL_ABILITY_CHECK,this._onPreRollIntercept.bind(this,L.ABILITY)),this._registerHook(Y.PRE_ROLL_SAVING_THROW,this._onPreRollIntercept.bind(this,L.SAVE)),this._registerHook(Y.PRE_ROLL_SKILL_V2,this._onPreRollIntercept.bind(this,L.SKILL)),this._registerHook(Y.PRE_ROLL_TOOL_V2,this._onPreRollIntercept.bind(this,L.TOOL)),this._registerHook(Y.PRE_ROLL_ATTACK_V2,this._onPreRollIntercept.bind(this,L.ATTACK)),this._registerHook(Y.PRE_ROLL_DAMAGE_V2,this._onPreRollIntercept.bind(this,L.DAMAGE)),this._registerHook(Y.PRE_ROLL_DEATH_SAVE_V2,this._onPreRollIntercept.bind(this,L.DEATH_SAVE)),this._registerHook(Y.PRE_ROLL_HIT_DIE_V2,this._onPreRollIntercept.bind(this,L.HIT_DIE)),this._registerHook(Y.PRE_ROLL_INITIATIVE,this._onPreRollInterceptInitiative.bind(this,L.INITIATIVE)),this._registerHook(Y.PRE_ROLL_INITIATIVE_DIALOG,this._onPreRollInterceptInitiative.bind(this,L.INITIATIVE))}static _registerHook(e,t){c.log("RollInterceptor._registerHook");const s=Hooks.on(e,t);this.registeredHooks.add({hookName:e,hookId:s})}static unregisterHooks(){c.log("RollInterceptor.unregisterHooks");for(const{hookName:e,hookId:t}of this.registeredHooks)Hooks.off(e,t);this.registeredHooks.clear()}static _onPreRollInterceptInitiative(e,t,s){}static _onPreRollIntercept(e,t,s,o){var C,w,M,O,F,N,W,B,U,le,de,ue,Ee,ve,Ne,ze,Nt,Gt,pt,gs,fs,ms,ps,hs;c.log("_onPreRollIntercept #0",[e,t,s,o]);const a=I(),i=v.get(a.rollRequestsEnabled.tag),n=v.get(a.rollInterceptionEnabled.tag),r=q.isModuleOn("midi-qol");let l;e===L.INITIATIVE&&t instanceof Actor?l=t:e===L.HIT_DIE?l=((C=s==null?void 0:s.subject)==null?void 0:C.actor)||(s==null?void 0:s.subject)||(s==null?void 0:s.actor):e===L.ATTACK||e===L.DAMAGE?l=(w=t.subject)==null?void 0:w.actor:l=((M=t.subject)==null?void 0:M.actor)||t.subject||t.actor;const d=(F=(O=o==null?void 0:o.data)==null?void 0:O.flags)==null?void 0:F["ddb-game-log"];if(d!=null&&d.cls){c.log("_onPreRollIntercept - skipping roll with ddb-game-log.cls flag (DDB roll)",[d]);return}const u=(W=(N=o==null?void 0:o.data)==null?void 0:N.flags)==null?void 0:W[k];if(u!=null&&u.isDnDBRoll)return;const f=(U=(B=o==null?void 0:o.data)==null?void 0:B.flags)==null?void 0:U["monks-tokenbar"],g=(le=t.event)==null?void 0:le.target,m=((de=g==null?void 0:g.closest)==null?void 0:de.call(g,'[data-action="requestRollPlusRoll"]'))||((ue=g==null?void 0:g.closest)==null?void 0:ue.call(g,".monks-tokenbar"))||((Ee=g==null?void 0:g.closest)==null?void 0:Ee.call(g,".request-card"));if(f||(ve=t==null?void 0:t.options)!=null&&ve["monks-tokenbar"]||(Ne=s==null?void 0:s.options)!=null&&Ne["monks-tokenbar"]||m){c.log("_onPreRollIntercept - skipping roll from Monk's Token Bar",[f,m]);return}if(re.hasPendingRoll()){c.log("_onPreRollIntercept - skipping interception: pending DnDB roll"),s.configure=!1;return}const p=q.getActorOwner(l),S=p&&(p==null?void 0:p.active)&&!(p!=null&&p.isGM),R=v.get(a.skipToRollResolver.tag)&&Ye.hasNonDigitalDice(),A=(t==null?void 0:t.isRollRequest)||(s==null?void 0:s.isRollRequest)||(o==null?void 0:o.isRollRequest),_=P.shouldSkipRollDialog({event:t.event,isPC:S,isNPC:!S,hasNonDigitalDice:R,configSendRequest:t.sendRequest,configSkipRollDialog:t.skipRollDialog,isRollRequest:A});if(!i||!n){s.configure=!_,c.log("_onPreRollIntercept - interception disabled, dialog.configure:",[!_]);return}if(!game.user.isGM)return;if(_){s.configure=!1,c.log("_onPreRollIntercept - skipping interception (shouldSkipDialog)",[_]);return}if(r&&(p!=null&&p.isGM||!(p!=null&&p.active))||!l||l.documentName!=="Actor")return;if(e===L.ATTACK||e===L.DAMAGE){const ys=((Nt=(ze=t.subject)==null?void 0:ze.item)==null?void 0:Nt.getFlag(k,"tempAttackConfig"))||((pt=(Gt=t.subject)==null?void 0:Gt.item)==null?void 0:pt.getFlag(k,"tempDamageConfig"));if(ys){c.log("_onPreRollIntercept - found module flags, skipping interception",[ys]);return}if(((gs=t.subject)!=null&&gs.activity||(fs=t.subject)!=null&&fs.item)&&!(p!=null&&p.active)){c.log("_onPreRollIntercept - activity-based attack/damage roll with offline owner, skip interception",[t.subject,p]);return}}const T=(t==null?void 0:t.hookNames)||(s==null?void 0:s.hookNames)||(o==null?void 0:o.hookNames)||[];return(T.includes("initiativeDialog")||T.includes("initiative"))&&e===L.ABILITY&&(c.log("RollInterceptor._onPreRollIntercept - Overriding ability to initiative",[T]),e=L.INITIATIVE),e===L.ATTACK&&(o={...o,rollMode:CONST.DICE_ROLL_MODES.PUBLIC}),o!=null&&o.data&&(o.data={...o.data,flags:{...(ms=o.data)==null?void 0:ms.flags,rsr5e:{...(hs=(ps=o.data)==null?void 0:ps.flags)==null?void 0:hs.rsr5e,processed:!0,quickRoll:!1}}}),c.log("_onPreRollIntercept - showing GM config dialog",[e,t,s,o]),this._showGMConfigDialog(l,p,e,t,s,o),!1}static async _handleInitiativePreChecks(e){return!game.combat&&!await zs()?!1:(await Vs([e.id],game)).length>0}static _getDialogClass(e){const t=e==null?void 0:e.toLowerCase();return[L.SKILL,L.TOOL].includes(t)?Ws:t===L.HIT_DIE?js:t===L.ATTACK?Uo:t===L.DAMAGE?qo:$e}static _extractRollConfiguration(e,t,s,o){var r,l,d,u,f,g,m,p,S,y,R;const a=e==null?void 0:e.toLowerCase();let i=null;const n={rolls:[{parts:[],data:{},options:{}}]};switch(a){case L.SKILL:n.skill=t.skill,n.ability=t.ability||((r=t.subject)==null?void 0:r.ability),i=n.skill;break;case L.TOOL:n.tool=t.tool,n.ability=t.ability||((l=t.subject)==null?void 0:l.ability),i=n.tool;break;case L.ABILITY:case L.SAVE:n.ability=t.ability||((d=t.subject)==null?void 0:d.ability),i=n.ability,n.ability==="con"&&t.targetValue!==void 0&&(e=L.CONCENTRATION);break;case L.CONCENTRATION:n.ability="con",i="con";break;case L.INITIATIVE:case L.INITIATIVE_DIALOG:i=((f=(u=o.system.attributes)==null?void 0:u.init)==null?void 0:f.ability)||"dex";break;case L.HIT_DIE:n.denomination=typeof t=="string"?t:t.denomination||((g=t.subject)==null?void 0:g.denomination),i=n.denomination;break;case L.ATTACK:s!=null&&s.options&&(n.ammunition=s.options.ammunition,n.attackMode=s.options.attackMode,n.mastery=s.options.mastery),i=(p=(m=t.subject)==null?void 0:m.item)==null?void 0:p.id;break;case L.DAMAGE:n.item=(S=t.subject)==null?void 0:S.item,n.subject=t.subject,n.critical=t.critical||{},i=(R=(y=t.subject)==null?void 0:y.item)==null?void 0:R.id;break}return{rollKey:i,rollConfig:n}}static async _getDialogResult(e,t,s,o,a,i,n,r){const l=s==null?void 0:s.toLowerCase();if(c.log("_getDialogResult",[t,s,o,n,r]),a)return{sendRequest:!0,advantage:!1,disadvantage:!1,skipRollDialog:!1,situational:"",rollMode:game.settings.get("core","rollMode")};if(!e.initConfiguration)throw c.error("DialogClass.initConfiguration not found",[e,e.name]),new Error(`DialogClass ${e.name} does not have initConfiguration method`);const d={skipRollDialog:!1,sendRequest:i&&n.isRollRequest!==!1};return c.log("_getDialogResult - normalizedRollType",[l,L.DAMAGE,L.ATTACK]),l===L.ATTACK||l===L.DAMAGE?(c.log("DialogClass.initConfiguration A",[t,l,o,d,n,r]),await e.initConfiguration([t],l,o,d,n,r)):(c.log("DialogClass.initConfiguration B",[t,l,o,d,n,r]),await e.initConfiguration([t],l,o,d,n,r))}static async _showGMConfigDialog(e,t,s,o,a,i){c.log("_showGMConfigDialog - config",[s,a,o,i]);const n=I(),r=v.get(n.rollRequestsEnabled.tag);try{if((s==null?void 0:s.toLowerCase())===L.INITIATIVE&&!await this._handleInitiativePreChecks(e))return;const d=this._getDialogClass(s),{rollKey:u,rollConfig:f}=this._extractRollConfiguration(s,o,a,e),g=t&&(t==null?void 0:t.active)&&!(t!=null&&t.isGM);let m;const p=P.shouldSkipRollDialog({event:o.event,isPC:g,isNPC:!g,sendRequest:g?r:!1});if(c.log("_showGMConfigDialog - rollConfig",[f,u,p,g,t]),p?m={sendRequest:g?r:!1,advantage:!1,disadvantage:!1,skipRollDialog:!0,situational:"",rollMode:game.settings.get("core","rollMode")}:(m=await this._getDialogResult(d,e,s,u,p,r,o,a),c.log("_showGMConfigDialog - _getDialogResult",[m])),!m){c.log("_showGMConfigDialog - Dialog cancelled");return}if(!m.sendRequest||!r){c.log("_showGMConfigDialog - triggering _executeInterceptedRoll",[s,o,m]),await this._executeInterceptedRoll(e,s,o,m);return}delete o.event;const S=o.subject,y={...o,...m,subject:S,rolls:m.rolls,requestedBy:game.user.name,...s===L.ATTACK&&{chatMessage:!1}};c.log("_showGMConfigDialog - triggering _sendRollRequest",[s,y]),this._sendRollRequest(e,t,s,y)}catch(l){c.error("RollInterceptor._showGMConfigDialog - Error",[l])}}static async _executeInterceptedRoll(e,t,s,o){var f,g,m,p,S,y,R,A,_,T,b,C,w,M;c.log("RollInterceptor._executeInterceptedRoll",[e,t,s,o]);const a=t==null?void 0:t.toLowerCase(),i=((f=o.rolls)==null?void 0:f[0])||{parts:[],data:{},options:{}},n=((g=i.data)==null?void 0:g.situational)||o.situational||"";let r;switch(a){case L.SKILL:r=s.skill;break;case L.TOOL:r=s.tool;break;case L.ABILITY:case L.SAVE:r=s.ability||((m=s.subject)==null?void 0:m.ability);break;case L.HIT_DIE:r=s.denomination;break;default:r=s.ability||s.skill||s.tool||s.denomination}const l={rollKey:r,config:{advantage:o.advantage||s.advantage,disadvantage:o.disadvantage||s.disadvantage,target:o.target||o.dc||s.target,rollMode:o.rollMode||s.rollMode,situational:n,isRollRequest:!1,skipRollDialog:o.skipRollDialog,ability:s.ability}};if(a===L.SKILL&&!l.config.ability)l.config.ability=((S=(p=e.system.skills)==null?void 0:p[l.rollKey])==null?void 0:S.ability)||((R=(y=CONFIG.DND5E.skills)==null?void 0:y[l.rollKey])==null?void 0:R.ability);else if(a===L.TOOL&&!l.config.ability){const O=(A=e.system.tools)==null?void 0:A[l.rollKey];l.config.ability=(O==null?void 0:O.ability)||((b=(T=(_=CONFIG.DND5E.enrichmentLookup)==null?void 0:_.tools)==null?void 0:T[l.rollKey])==null?void 0:b.ability)||"int"}else(a===L.ABILITY||a===L.SAVE)&&!l.config.ability&&(l.config.ability=l.rollKey);c.log("RollInterceptor._executeInterceptedRoll - requestData",[l,s,o]);const d={configure:!1,isRollRequest:!1},u={rollMode:l.config.rollMode,create:!0,isRollRequest:!1};try{const O=L,F=ke[a];F?((a===L.ATTACK||a===L.DAMAGE||a===L.SAVE)&&(l.rollKey=(w=(C=s.subject)==null?void 0:C.item)==null?void 0:w.id,l.activityId=(M=s.subject)==null?void 0:M.id,l.config.skipRollDialog=!0),await F(e,l,i,d,u)):c.warn(`No handler found for roll type: ${a}`)}catch(O){c.error("RollInterceptor._executeInterceptedRoll",[O])}}static async _sendRollRequest(e,t,s,o){var y,R,A,_,T,b,C;c.log("_sendRollRequest",[e,t,s,o]);const a=I();let i=s==null?void 0:s.toLowerCase();const n=t&&t.active&&t.id!==game.user.id;i===L.INITIATIVE&&(i=L.INITIATIVE_DIALOG);let r=null,l=null;switch(i){case L.ABILITY:case L.SAVE:r=o.ability;break;case L.SKILL:r=o.skill;break;case L.TOOL:r=o.tool;break;case L.ATTACK:case L.DAMAGE:c.log("_sendRollRequest - Attack/Damage roll config",[s,o]),r=(y=o.subject.item)==null?void 0:y.id,l=o.subject.id,c.log("_sendRollRequest - resolved rollKey and activityId",[r,l]);break;case L.HIT_DIE:r=typeof o=="string"?o:o.denomination;break;case L.INITIATIVE_DIALOG:case L.INITIATIVE:r=null;break;case L.DEATH_SAVE:r=null;break;default:c.warn(`Unknown roll type: ${s}`);return}const d={...o};if(d.midiOptions&&d.activity&&d.activity.type===ce.DAMAGE&&(c.log("_sendRollRequest - Damage activity",[d]),d.midiOptions={...d.midiOptions,workflowOptions:{...d.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1,fastForwardDamage:!1}}),r&&(i===L.ATTACK||i===L.DAMAGE)){const w=o.subject,M=(R=game.modules.get("midi-qol"))==null?void 0:R.api;if(M&&w){const O=(_=(A=M.Workflow)==null?void 0:A.getWorkflowByActivityUuid)==null?void 0:_.call(A,w.uuid);O!=null&&O.templateUuid&&(d.templateUuid=O.templateUuid,c.log("_sendRollRequest - Added templateUuid from GM workflow",[O.templateUuid]))}}delete d.subject,delete d.workflow,delete d.item,delete d.activity;const u=v.get(a.groupRollsMsgEnabled.tag),f=v.get(a.useCondensedRollMessage.tag),g=[L.ATTACK,L.DAMAGE,L.ITEM].includes(i);let m=null;if(u&&f&&!g){m=foundry.utils.randomID();const w=((T=e.token)==null?void 0:T.id)||((C=(b=canvas.tokens)==null?void 0:b.placeables.find(O=>{var F;return((F=O.actor)==null?void 0:F.id)===e.id}))==null?void 0:C.id),M={actor:e,uniqueId:w||e.id,tokenId:w||null};await ne.createGroupRollMessage([M],i,r,{...d,dc:d.target},m),c.log("_sendRollRequest - Created condensed group message",[m,e.name])}const p={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:e.id,rollType:i,rollKey:r,activityId:l,groupRollId:m,rollProcessConfig:{...d,_requestedBy:game.user.name},skipRollDialog:!1,targetTokenIds:Array.from(game.user.targets).map(w=>w.id),preserveTargets:v.get(a.useGMTargetTokens.tag),fromMidiWorkflow:q.isMidiWorkflowActive()};if(c.log("_sendRollRequest - requestData",[t,p,"groupRollId:",m]),!n){c.log("_sendRollRequest - No valid active owner, executing locally",[t==null?void 0:t.name,t==null?void 0:t.active]);const w={...d,rollMode:o.rollMode||game.settings.get("core","rollMode"),skipRollDialog:P.shouldSkipRollDialog({isPC:!1,isNPC:!0,sendRequest:!1})};await this._executeInterceptedRoll(e,s,o,w);return}await jt.handleOfflinePlayer(t,e,s,o,{...o,sendRequest:!1})||(me.execForUser("handleRollRequest",t.id,p),D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:(t==null?void 0:t.name)||"Unknown",actor:e.name||"Unknown"})))}}E(us,"registeredHooks",new Set);class jt{static async handleOfflinePlayer(e,t,s,o,a=null){if(c.log("OfflinePlayerManager.handleOfflinePlayer",[e==null?void 0:e.name,t==null?void 0:t.name,s]),!e||!o)return D.notify("warn","Flash Token Bar: No owner found for actor "+t.name),!0;if(!e.active){const i=I();return v.get(i.showOfflineNotifications.tag)&&D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:e.name})),await us._executeInterceptedRoll(t,s,o,a||{...o,sendRequest:!1}),!0}return!1}static categorizeActorsByOnlineStatus(e){const t=[],s=[],o=new Map;for(const{actor:a,owner:i}of e)o.has(a.id)||o.set(a.id,{actor:a,owners:[]}),o.get(a.id).owners.push(i);for(const{actor:a,owners:i}of o.values()){const n=i.find(r=>r.active&&!r.isGM);n?t.push({actor:a,owner:n}):s.push(a)}return{onlinePlayerActors:t,offlinePlayerActors:s}}static async processOfflineActors(e,t,s,o){for(const a of e){const i=a.ownership||{};let n=null;for(const[g,m]of Object.entries(i))if(m>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER&&g!=="default"){const p=game.users.get(g);if(p&&!p.isGM){n=p;break}}if(!n){c.warn("OfflinePlayerManager.processOfflineActors - No owner found for actor",[a.name]);continue}const r={rollKey:s,groupRollId:o.groupRollId,config:{...o,...t==="ability"||t==="abilitycheck"||t==="save"||t==="savingthrow"?{ability:s}:{},sendRequest:!1,isGroupRoll:!!o.groupRollId}},l={parts:[],data:o.situational?{situational:o.situational}:{},options:o.dc?{target:o.dc}:{}},d={configure:!1,isRollRequest:!0},u={rollMode:o.rollMode||game.settings.get("core","rollMode"),create:!0,isRollRequest:!0,groupRollId:o.groupRollId},f=ke[t.toLowerCase()];f&&await f(a,r,l,d,u),await new Promise(g=>setTimeout(g,200))}}}class Cs{static async getRollConfiguration(e,t,s,o,a,i={}){const n=I(),r=v.get(n.rollRequestsEnabled.tag),l=i.hasOwnProperty("sendAsRequest")?i.sendAsRequest:void 0,d=e.filter(p=>!a.some(S=>S.actor.id===p.id)),{onlinePlayerActors:u}=jt.categorizeActorsByOnlineStatus(a),f=u.length>0,g=!f;let m;if(i.hasOwnProperty("skipRollDialog")?m=i.skipRollDialog:m=P.shouldSkipRollDialog({isPC:f,isNPC:d.length>0||g,sendRequest:g?!1:l}),c.log("getRollConfiguration",[i]),!m&&t!==L.CUSTOM){let p;[L.SKILL,L.TOOL].includes(t)?p=Ws:t===L.HIT_DIE?p=js:p=$e;const S=await p.initConfiguration(e,t,s,{confirmedSkipDialog:m,sendRequest:r&&(l===!0||l===void 0&&f),...i,advantage:i.advantage===!0,disadvantage:i.disadvantage===!0,situationalBonus:i.situationalBonus});return c.log("getRollConfiguration B",[S]),S&&i.groupRollId&&(S.groupRollId=i.groupRollId,S.isContestedRoll=i.isContestedRoll||!1),S&&i.fromMidiWorkflow&&(S.fromMidiWorkflow=!0),S}else{const p={rolls:[{parts:[],data:i.situationalBonus?{situational:i.situationalBonus}:{},options:i.dc?{target:i.dc}:{}}],advantage:i.advantage===!0,disadvantage:i.disadvantage===!0,situationalBonus:i.situationalBonus,rollMode:i.rollMode||game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:m,sendRequest:r&&(i.hasOwnProperty("sendAsRequest")?i.sendAsRequest:f)};return i.dc&&(p.target=i.dc),t===L.DEATH_SAVE&&(p.target=10),i.groupRollId&&(p.groupRollId=i.groupRollId,p.isContestedRoll=i.isContestedRoll||!1),i.fromMidiWorkflow&&(p.fromMidiWorkflow=!0),p}}static async handleCustomRoll(e={}){return await this.showCustomRollDialog(e)}static async showCustomRollDialog(e={}){return c.log("showCustomRollDialog"),ds.prompt({formula:"",readonly:!1,rollMode:e.rollMode})}}class wt{static async handleGMRolls(e,t,s,o){c.log("RollMenuExecutor.handleGMRolls",[e,t,s,o]);for(const a of e)await this.initiateRoll(a,t,s,o),await zt(100)}static async handleGMRollsWithTokens(e,t,s,o){var a,i;c.log("RollMenuExecutor.handleGMRollsWithTokens",[e,t,s,o]);for(const n of e){if(n.tokenId){const r=((a=canvas.tokens)==null?void 0:a.get(n.tokenId))||((i=game.scenes.active)==null?void 0:i.tokens.get(n.tokenId));r?await this.initiateRollForToken(n.actor,r,t,s,o):await this.initiateRoll(n.actor,t,s,o)}else await this.initiateRoll(n.actor,t,s,o);await zt(100)}}static async initiateRollForToken(e,t,s,o,a){c.log("RollMenuExecutor.initiateRollForToken",[e.name,t.name,s,o,a]);const i=t.controlled;i||t.control({releaseOthers:!1});try{await this.initiateRoll(e,s,o,a)}finally{i||t.release()}}static async initiateRoll(e,t,s,o){var a;c.log("RollMenuExecutor.initiateRoll",[e,t,s,o]);try{const i=t.toLowerCase();let n=s;if(i===L.HIT_DIE){const y=e.system.attributes.hd;if(y.value>0&&(n=y.largestAvailable),!n){c.warn("RollMenuExecutor.initiateRoll - No hit dice available after orchestration refill",[e.name]),pe.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.noHitDice",{actor:e.name})||`No hit dice available for ${e.name}`);return}}const r={rollKey:n,groupRollId:o.groupRollId,config:{...o,rollMode:o.rollMode||game.settings.get("core","rollMode"),advantage:o.advantage||!1,disadvantage:o.disadvantage||!1,target:o.target}},l={configure:!o.fastForward&&!o.skipRollDialog,isRollRequest:!0};let d=o.rollMode||game.settings.get("core","rollMode");const u=I(),f=v.get(u.publicPlayerRolls.tag)===!0;(!(v.get(u.groupRollsMsgEnabled.tag)===!0)||!o.groupRollId)&&!o.rollMode&&f&&e&&P.isPlayerOwned(e)&&(d=CONST.DICE_ROLL_MODES.PUBLIC);const m={rollMode:d,create:o.chatMessage!==!1,isRollRequest:!0},p=((a=o.rolls)==null?void 0:a[0])||{};c.log("RollMenuExecutor.initiateRoll - rollConfig before handler",["parts:",p.parts,"data:",p.data,"rollProcessConfig:",o]);const S=ke[i];S?await S(e,r,p,l,m):pe.notify("warn",`Unknown roll type: ${t}`)}catch(i){c.error("RollMenuExecutor.initiateRoll error",[i]),pe.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name}))}}}class Rt{static async orchestrateRollsForActors(e,t,s,o,a,i){const n=I(),r=[],l=[],d=[];let u=e.groupRollId||foundry.utils.randomID();c.log("RollMenuOrchestrator.orchestrateRollsForActors",["groupRollId:",u,"config.groupRollId:",e.groupRollId,"config.isContestedRoll:",e.isContestedRoll,"config.sendRequest:",e.sendRequest,"pcActors:",t.map(_=>{var T;return`${_.actor.name}(${(T=_.owner)==null?void 0:T.name})`}),"npcActors:",s.map(_=>_.name)]);const f=[],g=[];if(e.sendRequest){const{onlinePlayerActors:_,offlinePlayerActors:T}=jt.categorizeActorsByOnlineStatus(t);if(d.push(..._),l.push(...T),T.length>0){const b=I();v.get(b.showOfflineNotifications.tag)&&T.forEach(C=>{var M;const w=(M=t.find(O=>O.actor.id===C.id))==null?void 0:M.owner;w&&pe.notify("info",game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:w.name}))})}g.push(...d.map(({actor:b})=>b))}else s.push(...t.map(({actor:_})=>_));g.push(...l,...s);const m=g.map(_=>_.id);f.push(...i.filter(_=>_&&_.actor&&m.includes(_.actor.id)));const p=v.get(n.groupRollsMsgEnabled.tag),S=v.get(n.useCondensedRollMessage.tag),y=g.length>1,R=u&&ne.groupRollMessages.has(u);if(p&&!R&&(y||S||e.groupRollId)&&(await ne.createGroupRollMessage(f,o,a,e,u),await zt(100)),l.length>0&&(e.skipRollDialog=!0,e.groupRollId=u,await jt.processOfflineActors(l,o,a,e)),o===L.HIT_DIE){const _=[];if(d.forEach(({actor:b})=>_.push(b)),l.forEach(b=>_.push(b)),s.forEach(b=>_.push(b)),!await this.handleHitDieRefill(_))return}for(const{actor:_,owner:T}of d){const b=p&&(y||S||e.isContestedRoll)?u:null;c.log("orchestrateRollsForActors - Sending to player",{actor:_.name,owner:T.name,useGroupId:b,groupRollId:u});let C=a;o===L.HIT_DIE&&(C=_.system.attributes.hd.largestAvailable,!C)||(await this.sendRollRequestToPlayer(_,T,o,C,e,!0,b),r.push({actor:_,owner:T}),await zt(100))}if(r.length>0&&this.showConsolidatedNotification(r,o,a),s.length>0){e.skipRollDialog=!0,e.groupRollId=p&&(y||S||e.isContestedRoll)?u:null;const _=s.map(b=>b.id),T=i.filter(b=>b&&b.actor&&_.includes(b.actor.id));await wt.handleGMRollsWithTokens(T,o,a,e)}}static async handleHitDieRefill(e){const s=(Array.isArray(e)?e:[e]).filter(i=>i.system.attributes.hd.value===0);if(s.length===0)return!0;const o=s.map(i=>i.name).join(", ");if(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessage",{actors:o})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){for(const i of s)try{const n=await ke.handleHitDieRecovery(i);if(i.isToken&&i._actor)try{await ke.handleHitDieRecovery(i._actor)}catch(r){c.error("Error updating base actor:",[r])}}catch(n){c.error("Error calling handleHitDieRecovery:",[n])}return pe.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:o})||`Hit dice refilled for ${o}`),!0}return!1}static async triggerRoll(e,t,s,o={}){var S;const a=I(),i=Array.from(s.selectedActors),n=o.skipRollDialog!==void 0?o.skipRollDialog:v.get(a.skipRollDialog.tag);let r=i.map(y=>{const R=se(y);if(!R)return null;let A=null;return game.actors.get(y)?A=null:A=y,{actor:R,uniqueId:y,tokenId:A}}).filter(y=>y),l=r.map(y=>y.actor);const d=V.ROLL_REQUEST_OPTIONS[e],u=(S=(d==null?void 0:d.name)||e)==null?void 0:S.toLowerCase(),f=t;if(t=await this.handleSpecialRollTypes(u,t,i,r,l,s,o),t===null&&f!==null)return;if(!l.length){pe.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}const{pcActors:g,npcActors:m}=Go(l),p=await Cs.getRollConfiguration(l,u,t,n,g,o);c.log("RollMenuOrchestrator.triggerRoll",[p]),p&&(await this.orchestrateRollsForActors(p,g,m,u,t,r),!(s!=null&&s.isLocked)&&typeof(s==null?void 0:s.close)=="function"&&setTimeout(()=>s.close(),500))}static async handleSpecialRollTypes(e,t,s,o,a,i,n={}){const r=I();switch(e){case L.CUSTOM:if(!t){const g=await Cs.handleCustomRoll({rollMode:n.rollMode});if(!g)return null;t=g.formula,g.rollMode&&(n.rollMode=g.rollMode)}break;case L.INITIATIVE:case L.INITIATIVE_DIALOG:if(!(await this.handleInitiativeRoll(s,o,a)).success)return null;v.get(r.initiateCombatOnRequest.tag)&&game.combat.startCombat();break;case L.DEATH_SAVE:const u=await No(a);a.length=0,a.push(...u),o=o.filter(g=>u.includes(g.actor));break;case L.HIT_DIE:const f=a.filter(g=>g.type==="character");if(f.length===0)return pe.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noCharactersForHitDie")||"Hit dice can only be rolled for player characters, not NPCs."),null;a.length=0,a.push(...f),o=o.filter(g=>g.actor.type==="character");break}return t}static async handleInitiativeRoll(e,t,s){var u,f;if(!await zs())return{success:!1};const a=[],i=[];for(const g of e){const m=se(g);if(!m)continue;let p=null;if(!game.actors.get(g))p=g,i.push(m.name);else{if(p=((f=(u=m.getActiveTokens())==null?void 0:u[0])==null?void 0:f.id)||null,!p){a.push(m.name);continue}i.push(m.name),game.combat.combatants.find(y=>y.tokenId===p)||await game.combat.createEmbeddedDocuments("Combatant",[{actorId:m.id,tokenId:p}])}}if(i.length===0)return{success:!1};a.length>0&&D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorsSkippedInitiative",{actors:a.join(", ")})||`Initiative skipped for actors without tokens: ${a.join(", ")}`);const n=t.filter(g=>{var p;return g.tokenId?!0:!!((p=g.actor.getActiveTokens())==null?void 0:p[0])});t.length=0,t.push(...n),s=n.map(g=>g.actor);const r=[...new Set(s.map(g=>g.id))],l=await Vs(r,game);if(!l.length)return{success:!1};const d=t.filter(g=>g&&g.actor&&l.includes(g.actor.id));return s.length=0,s.push(...l.map(g=>game.actors.get(g)).filter(g=>g)),t.length=0,t.push(...d),{success:!0}}static async sendRollRequestToPlayer(e,t,s,o,a,i=!1,n=null){var f;const r=I();let l=s==null?void 0:s.toLowerCase();if(l===L.ABILITY_CHECK?l=L.ABILITY:l===L.SAVING_THROW?l=L.SAVE:l===L.INITIATIVE_DIALOG&&(l=L.INITIATIVE),l===L.HIT_DIE&&(o=e.system.attributes.hd.largestAvailable,!o)){c.warn(`No hit dice available for ${e.name}.`);return}const d={...a};delete d.subject,delete d.workflow,delete d.item,delete d.activity,v.get(r.groupRollsMsgEnabled.tag),d.rollMode||v.get(r.publicPlayerRolls.tag)===!0&&(d.rollMode=CONST.DICE_ROLL_MODES.PUBLIC);const u={type:"rollRequest",groupRollId:n,actorId:e.isToken?e.token.id:e.id,isTokenActor:e.isToken,baseActorId:e.isToken?(f=e._actor)==null?void 0:f.id:e.id,rollType:l,rollKey:o,activityId:null,rollProcessConfig:{...d,_requestedBy:game.user.name},skipRollDialog:a.skipRollDialog||!1,targetTokenIds:Array.from(game.user.targets).map(g=>g.id),preserveTargets:v.get(r.useGMTargetTokens.tag),fromMidiWorkflow:a.fromMidiWorkflow??!1};c.log("RollMenuOrchestrator.sendRollRequestToPlayer - sending request",{actor:e.name,owner:t.name,groupRollId:u.groupRollId}),me.execForUser("handleRollRequest",t.id,u),i||pe.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:t.name,actor:e.name}))}static showConsolidatedNotification(e,t,s){var i,n,r,l,d;const o={};for(const{actor:u,owner:f}of e)o[f.id]||(o[f.id]={player:f,actors:[]}),o[f.id].actors.push(u);let a=game.i18n.localize(`FLASH_ROLLS.rollTypes.${t}`)||t;if(s){const u=t.toLowerCase();if(u===L.SKILL)a=`${a} (${((i=CONFIG.DND5E.skills[s])==null?void 0:i.label)||s})`;else if(u===L.SAVING_THROW)a=`${a} (${((n=CONFIG.DND5E.abilities[s])==null?void 0:n.label)||s})`;else if(u===L.ABILITY_CHECK)a=`${a} (${((r=CONFIG.DND5E.abilities[s])==null?void 0:r.label)||s})`;else if(u===L.TOOL){const f=(d=(l=CONFIG.DND5E.enrichmentLookup)==null?void 0:l.tools)==null?void 0:d[s];if(f!=null&&f.id){const g=dnd5e.documents.Trait.getBaseItem(f.id,{indexOnly:!0});a=`${a} (${(g==null?void 0:g.name)||s})`}else a=`${a} (${s})`}else u===L.CUSTOM&&(a=`${a}: ${s}`)}pe.notifyRollRequestsSent(o,a)}}class Wt{static addSidebarControls(e,t){if(c.log("addSidebarControls",[e,t]),!game.user.isGM||!e||e.id!=="sidebar")return;const s=document.querySelector("#roll-privacy");if(!s||s.querySelector(".flash-rolls-icon"))return;const o=I(),a=v.get(o.rollRequestsEnabled.tag),i=document.createElement("button");i.id="flash-rolls-icon",i.setAttribute("data-tooltip-direction","RIGHT"),i.className=`ui-control icon chat-control-icon flash-rolls-icon${a?" active":""}`,i.title=game.i18n.localize("FLASH_ROLLS.ui.menus.rollRequestsTitle"),i.innerHTML=`<i class="fas fa-bolt${a?"":"-slash"}"></i>`;const n=s.firstChild;n?n.parentNode.insertBefore(i,n):s.insertBefore(i,s.firstChild),c.log("addSidebarControls",[n,i]),i.addEventListener("click",r=>{r.stopPropagation(),r.preventDefault(),z.toggle()})}static updateRollRequestsIcon(e){const t=document.querySelector("#flash-rolls-icon i");t&&(t.className=`fas fa-bolt${e?"":"-slash"}`)}}class ws{static getActorStats(e){var i,n,r,l,d,u;const t=I(),s=v.get(t.actorStatsToShow.tag)||{hp:!0,ac:!0,dc:!0,prc:!0},o=e.system,a=[];if(s.hp&&((i=o.attributes)!=null&&i.hp)&&a.push({abbrev:"HP",value:o.attributes.hp.value}),s.ac&&((n=o.attributes)!=null&&n.ac)&&a.push({abbrev:"AC",value:o.attributes.ac.value}),s.dc){const f=(l=(r=o.attributes)==null?void 0:r.spell)==null?void 0:l.dc;f&&a.push({abbrev:"DC",value:f})}return s.prc&&((u=(d=o.skills)==null?void 0:d.prc)!=null&&u.passive)&&a.push({abbrev:"PRC",value:o.skills.prc.passive}),a}static getActorHPData(e){var a;const t=(a=e.system.attributes)==null?void 0:a.hp;if(!t||!t.max)return{hpPercent:100,hpColor:"var(--fr5e-color-hp-high)"};const s=Math.round(t.value/t.max*100),o=s>50?"var(--fr5e-color-hp-high)":"var(--fr5e-color-hp-low)";return{hpPercent:s,hpColor:o}}static getValidActorIds(e,t){return e.filter(s=>{const o=game.actors.get(s);if(!o)return!1;const a=cs(o),i=!a&&qs(o);return t==="pc"&&a||t==="npc"&&i})}}class Ue{static initializeDrag(e){const t=e.element.querySelector(this.DRAG_HANDLE_SELECTOR);if(!t){c.error("RollMenuDragManager.initializeDrag - No drag handle found!");return}t.addEventListener("mousedown",s=>{this.handleDragStart(s,e)})}static async handleDragStart(e,t){var m;const s=I();if(v.get(s.lockMenuPosition.tag)&&t.isLocked){e.preventDefault(),e.stopPropagation();return}if(e.preventDefault(),e.stopPropagation(),t.isDragging=!0,!t.element)return;t.element.classList.add("dragging");const a=e.clientX,i=e.clientY;t.element.classList.contains("docked-bottom");const n=((m=t.element.parentElement)==null?void 0:m.id)==="ui-bottom";t.element.classList.remove("docked-right","docked-bottom","faded-ui"),t.element.offsetHeight;const r=t.element.getBoundingClientRect();let l=r.left,d=i;if(n){const p=t.element.querySelector(this.DRAG_HANDLE_SELECTOR);if(p){const S=p.getBoundingClientRect(),y=S.left-r.left+S.width/2;l=a-y}else l=a-r.width/2;d=i}t.element.parentElement,document.body.appendChild(t.element),t.element.style.position="fixed",t.element.style.inset="",t.element.style.transform="",t.element.style.top=`${d}px`,t.element.style.left=`${l}px`,t.element.style.right="auto",t.element.style.bottom="auto",t.element.style.zIndex="var(--z-index-app)",t.element.offsetHeight;const u={startX:a,startY:i,initialLeft:l,initialTop:d,currentLeft:l,currentTop:d},f=p=>this.handleDragMove(p,t,u),g=p=>this.handleDragEnd(p,t,u,f,g);document.addEventListener("mousemove",f),document.addEventListener("mouseup",g)}static handleDragMove(e,t,s){if(!t.isDragging||!t.element)return;const o=e.clientX-s.startX,a=e.clientY-s.startY;s.currentLeft=s.initialLeft+o,s.currentTop=s.initialTop+a,t.element.style.inset="",t.element.style.right="auto",t.element.style.bottom="auto",t.element.style.position="fixed",t.element.style.top=`${s.currentTop}px`,t.element.style.left=`${s.currentLeft}px`;const i=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<i?t.element.classList.add("left-edge"):t.element.classList.remove("left-edge"),t.element.hasAttribute("data-layout")&&t.element.getAttribute("data-layout")==="horizontal"&&s.currentTop<400?t.element.classList.add("top-edge"):t.element.classList.remove("top-edge"),window.getComputedStyle(t.element);const r=this.calculateSnapDistance(t);(t.element.classList.contains("near-snap-both")?"both-edges":t.element.classList.contains("near-snap-right")?"right-edge":t.element.classList.contains("near-snap-bottom")?"bottom-edge":"none")!==r.type&&(t.element.classList.remove("near-snap","near-snap-right","near-snap-bottom","near-snap-both"),r.type==="both-edges"?t.element.classList.add("near-snap","near-snap-both"):r.type==="right-edge"?t.element.classList.add("near-snap","near-snap-right"):r.type==="bottom-edge"&&t.element.classList.add("near-snap","near-snap-bottom"))}static async handleDragEnd(e,t,s,o,a){if(c.log("RollMenuDragManager.handleDragEnd"),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",a),!(t!=null&&t.element)){c.error("RollMenuDragManager.handleDragEnd - Menu element is null");return}t.isDragging=!1,t.element.classList.remove("dragging"),t.element.classList.remove("near-snap","near-snap-right","near-snap-bottom","near-snap-both"),t.element.style.zIndex="";const i=this.calculateSnapDistance(t);if(i.type==="both-edges"){const n=document.querySelector("#chat-notifications");n&&t.element&&n.insertBefore(t.element,n.firstChild),await this.snapToDefault(t)}else if(i.type==="bottom-edge")await this.snapToBottomEdge(t);else if(i.type==="right-edge"){const n=document.querySelector("#chat-notifications");n&&t.element&&n.insertBefore(t.element,n.firstChild),await this.snapToRightEdge(t,s.currentTop)}else{t.isCustomPosition=!0,t.customPosition={x:s.currentLeft,y:s.currentTop,isCustom:!0,dockedRight:!1,dockedBottom:!1};const n=!!document.querySelector("body.crlngn-tabs");q.addCSSVars("--flash-rolls-menu-offset",n?"0px":"16px"),await this.saveCustomPosition(t.customPosition),t.element.classList.add("custom-position");const r=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<r&&t.element.classList.add("left-edge"),t.element.hasAttribute("data-layout")&&t.element.getAttribute("data-layout")==="horizontal"&&s.currentTop<400&&t.element.classList.add("top-edge")}}static calculateSnapDistance(e){if(!(e!=null&&e.element))return c.error("RollMenuDragManager.calculateSnapDistance - Menu element is null"),{type:"none",distance:1/0};const t=document.querySelector(this.LIGHTNING_BOLT_SELECTOR),s=document.querySelector("#hotbar");if(!t&&!s)return{type:"none",distance:1/0};const o=e.element.getBoundingClientRect();if(s){const a=s.getBoundingClientRect(),i=Math.abs(a.top-o.bottom),n=o.left,r=o.right,l=a.left,d=a.right;if(n<d&&r>l&&i<=this.SNAP_DISTANCE)return{type:"bottom-edge",distance:0}}if(t){const a=t.getBoundingClientRect(),i=Math.abs(a.left-o.right),n=window.innerHeight-o.bottom;if(i<=this.SNAP_DISTANCE)return n<=this.SNAP_DISTANCE?{type:"both-edges",distance:0}:{type:"right-edge",distance:0}}return{type:"none",distance:1/0}}static async snapToRightEdge(e,t){if(c.log("RollMenuDragManager.snapToRightEdge",[t]),!(e!=null&&e.element)){c.error("RollMenuDragManager.snapToRightEdge - Menu element is null");return}e.isCustomPosition=!0,e.customPosition={y:t,isCustom:!0,dockedRight:!0},e.element.classList.remove("custom-position","left-edge","top-edge","docked-bottom","faded-ui","offset"),e.element.classList.add("docked-right","snapping"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t<400?e.element.classList.add("top-edge"):e.element.classList.remove("top-edge"),e.element.style.position="fixed",e.element.style.inset="",e.element.style.left="",e.element.style.right="",e.element.style.bottom="",e.element.style.top=`${t}px`,e.element.style.zIndex="",dt(),await this.saveCustomPosition(e.customPosition),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static async snapToBottomEdge(e){if(c.log("RollMenuDragManager.snapToBottomEdge"),!(e!=null&&e.element)){c.error("RollMenuDragManager.snapToBottomEdge - Menu element is null");return}e.isCustomPosition=!0,e.customPosition={isCustom:!0,dockedBottom:!0},e.element.classList.remove("custom-position","left-edge","top-edge","docked-right","offset"),e.element.classList.add("docked-bottom","snapping");const t=document.querySelector("#ui-bottom");t&&e.element&&!t.contains(e.element)&&t.prepend(e.element);const s=document.querySelector("#ui-bottom #hotbar");s&&s.classList.contains("faded-ui")&&e.element.classList.add("faded-ui"),this.syncOffsetClass(e),dt(),await this.saveCustomPosition(e.customPosition),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static syncOffsetClass(e){const t=document.querySelector("#hotbar");if(t&&t.classList.contains("offset")){e.element.classList.add("offset");const s=t.style.getPropertyValue("--offset");s&&e.element.style.setProperty("--offset",s)}else e.element.classList.remove("offset"),e.element.style.removeProperty("--offset")}static syncFadedUIClass(e){if(!e.element.classList.contains("docked-bottom")){e.element.classList.remove("faded-ui");return}const t=document.querySelector("#ui-bottom #hotbar");t&&t.classList.contains("faded-ui")?e.element.classList.add("faded-ui"):e.element.classList.remove("faded-ui")}static async snapToDefault(e){if(c.log("RollMenuDragManager.snapToDefault"),!(e!=null&&e.element)){c.error("RollMenuDragManager.snapToDefault - Menu element is null");return}e.isCustomPosition=!1,e.customPosition=null;const t=I();v.get(t.menuLayout.tag),e.element.classList.remove("custom-position","left-edge","top-edge","docked-bottom","docked-right","faded-ui","offset"),e.element.classList.add("snapping"),e.element.style.position="",e.element.style.inset="",e.element.style.left="",e.element.style.top="",e.element.style.right="",e.element.style.bottom="",e.element.style.zIndex="",e.element.style.removeProperty("--offset"),dt(),await this.saveCustomPosition(null),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static applyCustomPosition(e,t){if(!t||!t.isCustom||!(e!=null&&e.element))return;const s=e.element.getBoundingClientRect();if(c.log("RollMenuDragManager.applyCustomPosition",[t]),t.x<0?t.x=0:t.x>window.innerWidth-s.width&&(t.x=window.innerWidth-s.width),t.y<0?t.y=0:t.y>window.innerHeight-s.height&&(t.y=window.innerHeight-s.height),e.isCustomPosition=!0,e.customPosition=t,t.dockedRight){const o=document.querySelector("#chat-notifications");o&&o.insertBefore(e.element,o.firstChild),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${t.y}px`,e.element.style.left="",e.element.style.right="",e.element.style.bottom="",e.element.classList.add("docked-right"),e.element.classList.remove("custom-position","left-edge","faded-ui","offset"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t.y<400?e.element.classList.add("top-edge"):e.element.classList.remove("top-edge"),dt()}else if(t.dockedBottom){const o=document.querySelector("#ui-bottom");o&&!o.contains(e.element)&&o.prepend(e.element),e.element.classList.add("docked-bottom"),e.element.classList.remove("custom-position","left-edge","top-edge","docked-right","faded-ui","offset");const a=document.querySelector("#ui-bottom #hotbar");a&&a.classList.contains("faded-ui")&&e.element.classList.add("faded-ui"),this.syncOffsetClass(e),dt()}else{document.body.appendChild(e.element),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${t.y}px`,e.element.style.left=`${t.x}px`,e.element.style.right="auto",e.element.style.bottom="auto";const o=!!document.querySelector("body.crlngn-tabs");q.addCSSVars("--flash-rolls-menu-offset",o?"0px":"16px"),e.element.classList.add("custom-position"),e.element.classList.remove("docked-right","faded-ui","offset");const a=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;t.x<a&&e.element.classList.add("left-edge"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t.y<400&&e.element.classList.add("top-edge")}}static async saveCustomPosition(e){if(!e){await game.user.setFlag(V.ID,"menuCustomPosition",null);return}const t=document.querySelector(".flash-rolls-menu");if(t){const s=t.getBoundingClientRect();e.x<0?e.x=0:e.x>window.innerWidth-s.width&&(e.x=window.innerWidth-s.width),e.y<0?e.y=0:e.y>window.innerHeight-s.height&&(e.y=window.innerHeight-s.height)}await game.user.setFlag(V.ID,"menuCustomPosition",e)}static loadCustomPosition(){return game.user.getFlag(V.ID,"menuCustomPosition")||null}static async resetPosition(e){await this.snapToDefault(e)}}E(Ue,"SNAP_DISTANCE",50),E(Ue,"DRAG_HANDLE_SELECTOR",".drag-handle"),E(Ue,"LIGHTNING_BOLT_SELECTOR","#flash-rolls-icon");class he{static isFavorite(e){try{const t=typeof e=="string"?game.actors.get(e):e;return!t||!t.getFlag?!1:t.getFlag(k,this.FLAGS.FAVORITE)===!0}catch(t){return c.error("Error checking favorite status",[t,e]),!1}}static isBlocked(e){const t=typeof e=="string"?game.actors.get(e):e;return t?t.getFlag(k,this.FLAGS.BLOCKED)===!0:!1}static async setFavorite(e,t){const s=typeof e=="string"?game.actors.get(e):e;if(!s){c.error("Actor not found",[e]);return}c.log("ActorStatusManager.setFavorite",[s.name,t]),t?(await s.setFlag(k,this.FLAGS.FAVORITE,!0),await s.unsetFlag(k,this.FLAGS.BLOCKED)):await s.unsetFlag(k,this.FLAGS.FAVORITE),this._refreshMenu()}static async setBlocked(e,t){const s=typeof e=="string"?game.actors.get(e):e;if(!s){c.error("Actor not found",[e]);return}t?(await s.setFlag(k,this.FLAGS.BLOCKED,!0),await s.unsetFlag(k,this.FLAGS.FAVORITE)):await s.unsetFlag(k,this.FLAGS.BLOCKED),this._refreshMenu()}static async toggleFavorite(e,t){const s=t?!0:!this.isFavorite(e);await this.setFavorite(e,s)}static async toggleBlocked(e,t){const s=t?!0:!this.isBlocked(e);await this.setBlocked(e,s)}static async blockActor(e){await this.setBlocked(e,!0)}static getFavoriteActors(){return game.actors.filter(e=>this.isFavorite(e))}static getBlockedActors(){return game.actors.filter(e=>this.isBlocked(e))}static filterBlocked(e){return e.filter(t=>!this.isBlocked(t))}static getActorStatus(e){return{isFavorite:this.isFavorite(e),isBlocked:this.isBlocked(e)}}static async clearActorStatus(e){const t=typeof e=="string"?game.actors.get(e):e;t&&(await t.unsetFlag(k,this.FLAGS.FAVORITE),await t.unsetFlag(k,this.FLAGS.BLOCKED),this._refreshMenu())}static _refreshMenu(){z.refreshIfOpen()}static getContextMenuOptions(e,t){return game.user.isGM&&(t.push({name:"FLASH_ROLLS.contextMenu.toggleFavorite",icon:'<i class="fas fa-bolt"></i>',callback:s=>{const o=s.data("documentId")||s.dataset.entryId;o&&this.toggleFavorite(o)},condition:s=>game.user.isGM}),t.push({name:"FLASH_ROLLS.contextMenu.toggleBlocked",icon:'<i class="fas fa-ban"></i>',callback:s=>{const o=s.data("documentId")||s.dataset.entryId;o&&this.toggleBlocked(o)},condition:s=>game.user.isGM})),t}}E(he,"FLAGS",{FAVORITE:"isFavorite",BLOCKED:"isBlocked"});class $o{static initializeActorDrag(e){e.element.querySelectorAll('.actor-list .actor.drag-wrapper[draggable="true"]').forEach(o=>{o.addEventListener("dragstart",a=>this.handleDragStart(a,e)),o.addEventListener("dragend",a=>this.handleDragEnd(a,e))});const s=e.element;s.addEventListener("dragover",o=>this.handleDragOver(o)),s.addEventListener("drop",o=>this.handleDrop(o,e)),document.addEventListener("dragover",o=>this.handleGlobalDragOver(o,e)),document.addEventListener("drop",o=>this.handleGlobalDrop(o,e))}static handleDragStart(e,t){const s=e.currentTarget,o=s.dataset.actorId,a=game.actors.get(o);if(!a){e.preventDefault();return}c.log("ActorDragUtil.handleDragStart",[a.name,o]),e.dataTransfer.setData("text/plain",o),e.dataTransfer.setData("application/json",JSON.stringify({actorId:o,actorName:a.name,uniqueId:s.dataset.id,tokenId:s.dataset.tokenId||null})),e.dataTransfer.effectAllowed="move",s.classList.add("dragging");const i=s.getBoundingClientRect(),n=document.createElement("div");n.style.width=i.width+"px",n.style.height=i.height+"px",n.style.backgroundColor="rgba(0, 0, 0, 0.1)",n.style.border="2px dashed rgba(255, 255, 255, 0.3)",n.style.borderRadius="4px",n.style.opacity="0.6",n.style.position="absolute",n.style.top="-1000px",n.style.left="-1000px",n.style.pointerEvents="none",document.body.appendChild(n),e.dataTransfer.setDragImage(n,i.width/2,i.height/2),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},0),t._currentDragData={actorId:o,actorElement:s,startTime:Date.now()}}static createGroupDragImage(e,t){const s=document.createElement("div");s.className="actor actor-group drag-wrapper",s.style.background=getComputedStyle(e).background,s.style.border=getComputedStyle(e).border,s.style.borderRadius=getComputedStyle(e).borderRadius,s.style.padding=getComputedStyle(e).padding;const o=e.querySelector(".actor-img");if(o){const i=o.cloneNode(!0);s.appendChild(i)}const a=document.createElement("div");return a.className="actor-name",a.textContent=t.name,a.style.color=getComputedStyle(e.querySelector(".actor-name")||e).color,a.style.fontSize=getComputedStyle(e.querySelector(".actor-name")||e).fontSize,a.style.fontWeight="bold",a.style.textAlign="center",a.style.marginTop="4px",s.appendChild(a),s}static createStandardDragImage(e){const t=document.createElement("div");t.className=e.className,t.style.background=getComputedStyle(e).background,t.style.border=getComputedStyle(e).border,t.style.borderRadius=getComputedStyle(e).borderRadius,t.style.padding=getComputedStyle(e).padding,t.style.display="flex",t.style.alignItems="center",t.style.gap="8px";const s=e.querySelector(".actor-img");if(s){const a=s.cloneNode(!0);t.appendChild(a)}const o=e.querySelector(".actor-name");if(o){const a=o.cloneNode(!0);t.appendChild(a)}return t}static handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="none"}static handleDrop(e,t){e.preventDefault(),c.log("ActorDragUtil.handleDrop - dropped within menu, canceling remove"),this.cleanupDrag(t)}static handleGlobalDragOver(e,t){if(!t._currentDragData)return;const s=t.element,o=document.elementFromPoint(e.clientX,e.clientY);s&&(s.contains(o)||s===o)?(e.dataTransfer.dropEffect="none",t._currentDragData.actorElement&&t._currentDragData.actorElement.classList.remove("drag-remove-zone")):(e.preventDefault(),e.dataTransfer.dropEffect="move",t._currentDragData.actorElement&&t._currentDragData.actorElement.classList.add("drag-remove-zone"))}static handleGlobalDrop(e,t){if(!t._currentDragData)return;const s=t.element,o=document.elementFromPoint(e.clientX,e.clientY);if(!(s&&(s.contains(o)||s===o))){e.preventDefault();const i=JSON.parse(e.dataTransfer.getData("application/json"));c.log("ActorDragUtil.handleGlobalDrop - blocking actor",[i.actorName]),this.blockActor(i.actorId,t)}this.cleanupDrag(t)}static handleDragEnd(e,t){c.log("ActorDragUtil.handleDragEnd"),setTimeout(()=>{this.cleanupDrag(t)},100)}static async blockActor(e,t){try{await he.blockActor(e);const s=t.element.querySelector(`[data-actor-id="${e}"]`);if(s){const o=s.dataset.id;t.selectedActors.delete(o)}}catch(s){c.error("Error blocking actor",[s]),ui.notifications.error(`Failed to block actor: ${s.message}`)}}static cleanupDrag(e){var t;(t=e._currentDragData)!=null&&t.actorElement&&e._currentDragData.actorElement.classList.remove("dragging","drag-remove-zone"),e._currentDragData=null}static removeDragListeners(e){document.removeEventListener("dragover",this.handleGlobalDragOver),document.removeEventListener("drop",this.handleGlobalDrop)}}class Ct{static canDrop(e){return c.log("ActorDropUtil.canDrop",[e]),game.user.isGM}static handleDragOver(e,t){c.log("ActorDropUtil.handleDragOver",[e,e.currentTarget,e.target]),e.preventDefault(),e.stopPropagation(),e.dataTransfer&&(e.dataTransfer.dropEffect="copy",c.log("ActorDropUtil.handleDragOver - dataTransfer types:",[e.dataTransfer.types]));const s=e.currentTarget.closest(".actor-list, .actors");return s&&(s.classList.add("drag-over"),c.log("ActorDropUtil.handleDragOver - added drag-over class")),!1}static handleDragLeave(e){if(c.log("ActorDropUtil.handleDragLeave",[e,e.currentTarget,e.target]),!e.currentTarget||typeof e.currentTarget.getBoundingClientRect!="function"){document.querySelectorAll(".drag-over").forEach(a=>{a.classList.remove("drag-over")}),c.log("ActorDropUtil.handleDragLeave - removed drag-over class from all elements (global cleanup)");return}const t=e.currentTarget.getBoundingClientRect();if(e.clientX<t.left||e.clientX>t.right||e.clientY<t.top||e.clientY>t.bottom){const o=e.currentTarget.closest(".actor-list, .actors");o&&(o.classList.remove("drag-over"),c.log("ActorDropUtil.handleDragLeave - removed drag-over class"))}}static async handleDrop(e,t){e.preventDefault(),e.stopPropagation();for(let o=0;o<e.dataTransfer.types.length;o++){const a=e.dataTransfer.types[o],i=e.dataTransfer.getData(a);c.log(`ActorDropUtil.handleDrop - ${a}:`,[i])}t.element.querySelectorAll(".drag-over").forEach(o=>{o.classList.remove("drag-over")}),c.log("ActorDropUtil.handleDrop - removed drag-over class from all elements");try{const o=this.parseDragData(e);if(!o||o.type!=="Actor"){c.log("ActorDropUtil.handleDrop - Invalid drag data",[o]);return}const a=await this.getActorFromDragData(o);if(!a){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.actorNotFound")||"Actor not found");return}const n=cs(a)?"pc":"npc";t.currentTab!==n&&(t.currentTab=n),await this.addActorToMenu(a,t)}catch(o){c.error("ActorDropUtil.handleDrop - Error processing drop",[o]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.dropError")||"Error adding actor to menu")}}static parseDragData(e){try{const t=e.dataTransfer.getData("application/json");if(t)return JSON.parse(t);const s=e.dataTransfer.getData("text/plain");if(s){if(s.startsWith("Actor."))return{type:"Actor",uuid:s};try{return JSON.parse(s)}catch{c.log("ActorDropUtil.parseDragData - Text is not JSON")}}return null}catch(t){return c.error("ActorDropUtil.parseDragData - Error parsing drag data",[t]),null}}static async getActorFromDragData(e){try{return e.uuid?await fromUuid(e.uuid):e.id?game.actors.get(e.id):null}catch(t){return c.error("ActorDropUtil.getActorFromDragData - Error getting actor",[t]),null}}static async addActorToMenu(e,t){const s=he.isBlocked(e);if(he.isFavorite(e)&&!s){D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorAlreadyAdded",{actor:e.name})||`${e.name} is already in the menu`);return}await he.setFavorite(e,!0)}}const zo="modulepreload",Vo=function(h){return"/modules/flash-rolls-5e/"+h},Ds={},Dt=function(e,t,s){let o=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),n=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));o=Promise.allSettled(t.map(r=>{if(r=Vo(r),r in Ds)return;Ds[r]=!0;const l=r.endsWith(".css"),d=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${r}"]${d}`))return;const u=document.createElement("link");if(u.rel=l?"stylesheet":zo,l||(u.as="script"),u.crossOrigin="",u.href=r,n&&u.setAttribute("nonce",n),document.head.appendChild(u),l)return new Promise((f,g)=>{u.addEventListener("load",f),u.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${r}`)))})}))}function a(i){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=i,window.dispatchEvent(n),!n.defaultPrevented)throw i}return o.then(i=>{for(const n of i||[])n.status==="rejected"&&a(n.reason);return e().catch(a)})};class Fe{static async toggleMovementForSelected(e){if(e.selectedActors.size===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const t=[];for(const i of e.selectedActors){const n=se(i);if(!n){c.log(`TokenMovementManager: No actor found for uniqueId: ${i}`);continue}const r=this.getTokensForActor(n.id,i);c.log(`TokenMovementManager: Found ${r.length} tokens for actor ${n.name} (${n.id})`),t.push(...r)}if(t.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensForMovementLock"));return}const s=this.getMovementStatus(t),o=s.restricted<s.unrestricted;c.log(`TokenMovementManager: Before toggle - ${s.restricted} restricted, ${s.unrestricted} unrestricted, shouldLock: ${o}`),await this.setMovementRestriction(t,o),z.refreshIfOpen();const a=o?"movementLocked":"movementUnlocked";D.notify("info",game.i18n.format(`FLASH_ROLLS.notifications.${a}`,{count:t.length})),c.log(`TokenMovementManager: ${o?"Locked":"Unlocked"} movement for ${t.length} tokens`)}static async _setMovementForSelected(e,t){if(e.selectedActors.size===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const s=[];for(const a of e.selectedActors){const i=se(a);if(!i)continue;const n=this.getTokensForActor(i.id,a);s.push(...n)}if(s.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensForMovementLock"));return}await this.setMovementRestriction(s,t);const o=t?"movementLocked":"movementUnlocked";D.notify("info",game.i18n.format(`FLASH_ROLLS.notifications.${o}`,{count:s.length})),c.log(`TokenMovementManager: ${t?"Locked":"Unlocked"} movement for ${s.length} tokens`)}static getTokensForActor(e,t){const s=[],o=game.scenes.current;if(!o)return s;if(t!==e){const a=o.tokens.get(t);a&&a.actorId===e&&s.push(a)}else{const a=o.tokens.filter(i=>i.actorId===e);s.push(...a)}return s}static async setMovementRestriction(e,t){const s=e.map(o=>{let a;if(t){const i={type:"manual",enabled:!0,source:"gm",metadata:{restrictedAt:Date.now(),restrictedBy:game.user.id}};a={_id:o.id,flags:{[k]:{movementRestriction:i}}}}else a={_id:o.id,[`flags.${k}.-=movementRestriction`]:null};return a});if(s.length>0)try{c.log(`TokenMovementManager: Updating ${s.length} tokens with updates:`,s),await game.scenes.current.updateEmbeddedDocuments("Token",s),c.log(`TokenMovementManager: Successfully updated ${s.length} tokens with movement restriction: ${t}`);for(const o of s){const a=game.scenes.current.tokens.get(o._id);if(a){const i=a.getFlag(k,"movementRestriction");c.log(`TokenMovementManager: After update, token ${a.name} restriction is:`,i)}}}catch(o){c.error("TokenMovementManager: Failed to update token movement restrictions",[o]),ui.notifications.error("Failed to update token movement restrictions")}}static isMovementRestricted(e){const t=e.getFlag(k,"movementRestriction");return(t==null?void 0:t.enabled)===!0}static isMovementAllowed(e,t,s){if(t.isGM||!(s.x!==void 0||s.y!==void 0))return!0;const a=e.getFlag(k,"movementRestriction");return a!=null&&a.enabled?(c.log(`TokenMovementManager: Movement blocked for token ${e.name} by user ${t.name}`),!1):!0}static getMovementStatus(e){let t=0,s=0;return e.forEach(o=>{this.isMovementRestricted(o)?t++:s++}),{restricted:t,unrestricted:s,total:e.length,hasRestricted:t>0,hasUnrestricted:s>0,allRestricted:t===e.length,allUnrestricted:s===e.length}}static getStatusIcon(e){return e.allRestricted?"fa-user-lock":e.allUnrestricted?"fa-person-walking":"fa-user-slash"}static async clearAllRestrictions(e){await this.setMovementRestriction(e,!1)}static async onCombatStart(e,t){var n;if(!game.user.isGM)return;const s=I();if(!v.get((n=s.autoBlockMovementInCombat)==null?void 0:n.tag))return;c.log("TokenMovementManager: Combat started, applying movement restrictions");const a=e.combatant,i=[];for(const r of e.combatants){if(r.id===(a==null?void 0:a.id))continue;const l=r.token;l&&i.push(l)}i.length>0&&(await this.setCombatMovementRestriction(i,!0),c.log(`TokenMovementManager: Blocked movement for ${i.length} combatants`))}static async onCombatTurnChange(e,t,s){var n;if(!game.user.isGM)return;const o=I();if(!v.get((n=o.autoBlockMovementInCombat)==null?void 0:n.tag))return;c.log("TokenMovementManager: Combat turn changed",[e,t,s]);const i=e.combatant;c.log("TokenMovementManager: Current combatant",[i]);for(const r of e.combatants){const l=r.token;if(!l)continue;const d=r.tokenId===(i==null?void 0:i.tokenId),u=!d;c.log(`TokenMovementManager: ${r.name} - isCurrentTurn: ${d}, shouldRestrict: ${u}`,[r]),await this.setCombatMovementRestriction([l],u)}c.log("TokenMovementManager: Updated movement restrictions for all combatants")}static async onCombatEnd(e){if(!game.user.isGM)return;c.log("TokenMovementManager: Combat ended, removing movement restrictions");const t=[];for(const s of e.combatants){const o=s.token;if(o){const a=o.getFlag(k,"movementRestriction");(a==null?void 0:a.type)==="combat"&&t.push(o)}}t.length>0&&(await this.setCombatMovementRestriction(t,!1),c.log(`TokenMovementManager: Unblocked movement for ${t.length} combatants`))}static async setCombatMovementRestriction(e,t){const s=e.map(o=>{var i;let a;if(t){const n={type:"combat",enabled:!0,source:"system",metadata:{restrictedAt:Date.now(),combatId:(i=game.combat)==null?void 0:i.id}};a={_id:o.id,flags:{[k]:{movementRestriction:n}}}}else{const n=o.getFlag(k,"movementRestriction");if((n==null?void 0:n.type)==="combat")a={_id:o.id,[`flags.${k}.-=movementRestriction`]:null};else return null}return a}).filter(o=>o!==null);if(s.length>0)try{await game.scenes.current.updateEmbeddedDocuments("Token",s),c.log(`TokenMovementManager: Updated ${s.length} tokens with combat movement restriction: ${t}`)}catch(o){c.error("TokenMovementManager: Failed to update combat movement restrictions",[o])}}static async onCreateCombatant(e,t,s){var l;if(!game.user.isGM)return;const o=I();if(!v.get((l=o.autoBlockMovementInCombat)==null?void 0:l.tag))return;const i=e.combat;if(!(i!=null&&i.started))return;const n=e.token;if(!n)return;const r=i.combatant;if(e.id===(r==null?void 0:r.id)){c.log(`TokenMovementManager: New combatant ${e.name} is current turn, allowing movement`);return}c.log(`TokenMovementManager: Blocking movement for newly added combatant ${e.name}`),await this.setCombatMovementRestriction([n],!0)}static async initializeCombatMovementRestrictions(){var a;if(!game.user.isGM)return;const e=I();if(!v.get((a=e.autoBlockMovementInCombat)==null?void 0:a.tag))return;const s=game.combat;if(!(s!=null&&s.started))return;c.log("TokenMovementManager: Initializing movement restrictions for active combat");const o=s.combatant;c.log("TokenMovementManager: Current combatant on init",[o]);for(const i of s.combatants){const n=i.token;if(!n)continue;const r=i.id===(o==null?void 0:o.id),l=!r;c.log(`TokenMovementManager: Init - ${i.name} - isCurrentTurn: ${r}, shouldRestrict: ${l}`),await this.setCombatMovementRestriction([n],l)}c.log("TokenMovementManager: Initialized movement restrictions for active combat")}}class ot{static mergeWithDefaultLayout(e,t){if(!e)return t;const s={};for(const o of["moduleActions","actorActions"]){const a=e[o]||[],i=t[o]||[],n=new Set(a.map(d=>d.id)),r=[...a];let l=a.length>0?Math.max(...a.map(d=>d.order)):-1;for(const d of i)n.has(d.id)||(l++,r.push({...d,enabled:!0,order:l}));r.sort((d,u)=>d.order-u.order),s[o]=r.map((d,u)=>({...d,order:u}))}return s}static getIconLayout(){const e=I(),t=v.get(e.menuIconsLayout.tag),s=$t();return this.mergeWithDefaultLayout(t,s)}static initializeDragAndDrop(e){e.querySelectorAll(".sortable-icon-list").forEach(o=>{this.setupListEventListeners(o)}),e.querySelectorAll(".icon-toggle").forEach(o=>{o.addEventListener("change",this.handleIconToggle.bind(this))})}static setupListEventListeners(e){e.addEventListener("dragover",this.handleDragOver.bind(this)),e.addEventListener("drop",this.handleDrop.bind(this)),e.addEventListener("dragenter",this.handleDragEnter.bind(this)),e.addEventListener("dragleave",this.handleDragLeave.bind(this)),e.querySelectorAll(".icon-item").forEach(s=>{s.addEventListener("dragstart",this.handleDragStart.bind(this)),s.addEventListener("dragend",this.handleDragEnd.bind(this))})}static handleDragStart(e){const t=e.target.closest(".icon-item");t&&(t.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",t.outerHTML),e.dataTransfer.setData("text/plain",JSON.stringify({iconId:t.dataset.iconId,iconType:t.closest(".sortable-icon-list").dataset.iconType,order:parseInt(t.dataset.order)})))}static handleDragEnd(e){const t=e.target.closest(".icon-item");t&&(t.classList.remove("dragging"),document.querySelectorAll(".sortable-icon-list").forEach(s=>{s.classList.remove("drag-over")}),document.querySelectorAll(".drag-placeholder").forEach(s=>{s.remove()}))}static handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.currentTarget,s=document.querySelector(".icon-item.dragging");if(!s)return;const o=s.closest(".sortable-icon-list").dataset.iconType,a=t.dataset.iconType;if(o!==a){e.dataTransfer.dropEffect="none";return}const i=this.getDragAfterElement(t,e.clientY);i==null?t.appendChild(s):t.insertBefore(s,i)}static handleDragEnter(e){e.preventDefault(),e.currentTarget.classList.add("drag-over")}static handleDragLeave(e){const t=e.currentTarget,s=t.getBoundingClientRect();(e.clientX<s.left||e.clientX>s.right||e.clientY<s.top||e.clientY>s.bottom)&&t.classList.remove("drag-over")}static handleDrop(e){e.preventDefault();const t=e.currentTarget;t.classList.remove("drag-over"),this.updateIconOrder(t)}static getDragAfterElement(e,t){return[...e.querySelectorAll(".icon-item:not(.dragging)")].reduce((o,a)=>{const i=a.getBoundingClientRect(),n=t-i.top-i.height/2;return n<0&&n>o.offset?{offset:n,element:a}:o},{offset:Number.NEGATIVE_INFINITY}).element}static handleIconToggle(e){const t=e.target,s=t.closest(".icon-item"),o=t.checked;s.dataset.enabled=o,o?s.classList.remove("disabled"):s.classList.add("disabled");const a=s.closest(".sortable-icon-list");this.updateIconOrder(a)}static async updateIconOrder(e){var r;const t=e.dataset.iconType,o=[...e.querySelectorAll(".icon-item")].map((l,d)=>({id:l.dataset.iconId,icon:this.getIconClass(l.dataset.iconId,t),enabled:l.dataset.enabled==="true",order:d})),a=I(),n={...this.getIconLayout(),[t]:o};await v.set(a.menuIconsLayout.tag,n),(r=game.flashRolls)!=null&&r.menu&&game.flashRolls.menu.render(!1)}static getIconClass(e,t){const s=xt(e,t);return s?s.icon:""}static getEnabledIcons(e){return(this.getIconLayout()[e]||[]).filter(o=>o.enabled).sort((o,a)=>o.order-a.order)}static getAllIcons(e){return(this.getIconLayout()[e]||[]).sort((o,a)=>o.order-a.order)}static getIconConfigurations(){return{moduleActions:Ns,actorActions:Gs}}static async resetToDefault(e=null){const t=I(),s=$t();if(e){const a={...v.get(t.menuIconsLayout.tag)||{},[e]:s[e]};await v.set(t.menuIconsLayout.tag,a)}else await v.set(t.menuIconsLayout.tag,s)}static async removeIcon(e,t){var r,l;const s=I(),o=this.getIconLayout();if(!o[t]){LogUtil.error("IconLayoutUtil.removeIcon - Invalid icon type:",[t]);return}if(o[t].findIndex(d=>d.id===e)===-1){LogUtil.error("IconLayoutUtil.removeIcon - Icon not found:",[e,t]);return}const i={...o,[t]:o[t].map(d=>d.id===e?{...d,enabled:!1}:d)};await v.set(s.menuIconsLayout.tag,i);const n=(l=(r=game.modules.get("flash-rolls-5e"))==null?void 0:r.api)==null?void 0:l.RollRequestsMenu;n&&n.refreshIfOpen()}}var gt;class Ks{static show(e,t,s,o){if(e.preventDefault(),e.stopPropagation(),this.close(),!xt(t,s)){c.error("IconContextMenu: Icon configuration not found",[t,s]);return}const i=document.createElement("div");i.className="icon-context-menu",i.style.position="fixed",i.style.left=`${e.clientX}px`,i.style.top=`${e.clientY}px`,i.style.zIndex="10000";const n=`
      <ul>
        <li class="context-menu-item" data-action="remove">
          <i class="fas fa-times"></i>
          <span>${game.i18n.localize("FLASH_ROLLS.ui.contextMenu.removeIcon")}</span>
        </li>
        <li class="context-menu-item" data-action="create-macro">
          <i class="fas fa-code"></i>
          <span>${game.i18n.localize("FLASH_ROLLS.ui.contextMenu.createMacro")}</span>
        </li>
      </ul>
    `;i.innerHTML=n,i.querySelector('[data-action="remove"]').addEventListener("click",async()=>{await this._handleRemoveIcon(t,s),this.close()}),i.querySelector('[data-action="create-macro"]').addEventListener("click",async()=>{await this._handleCreateMacro(t,s,o),this.close()}),document.body.appendChild(i),De(this,gt,i);const d=u=>{i.contains(u.target)||(this.close(),document.removeEventListener("click",d))};setTimeout(()=>{document.addEventListener("click",d)},10),this._adjustPosition(i)}static _adjustPosition(e){const t=e.getBoundingClientRect(),s=window.innerWidth,o=window.innerHeight;t.right>s&&(e.style.left=`${s-t.width-10}px`),t.bottom>o&&(e.style.top=`${o-t.height-10}px`)}static async _handleRemoveIcon(e,t){var s;try{await ot.removeIcon(e,t),D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.iconRemoved",{iconName:game.i18n.localize(((s=xt(e,t))==null?void 0:s.labelKey)||e)}))}catch(o){c.error("Failed to remove icon",[o]),D.notify("error",game.i18n.localize("FLASH_ROLLS.notifications.iconRemoveFailed"))}}static async _handleCreateMacro(e,t,s){try{const o=I(),a=v.get(o.addMacrosToFolder.tag),i=xt(e,t);let n=Array.from((s==null?void 0:s.selectedActors)||[]);e==="place-tokens"&&(n=n.map(f=>{const g=game.actors.get(f);if(g)return g.id;const m=canvas.tokens.placeables.find(p=>p.id===f);return m!=null&&m.actor?m.actor.id:f})),e==="teleport-tokens"&&(n=n.map(f=>{const g=canvas.tokens.placeables.find(p=>p.id===f);if(g)return g.id;const m=game.actors.get(f);if(m){const p=canvas.tokens.placeables.find(S=>{var y;return((y=S.actor)==null?void 0:y.id)===m.id});if(p)return p.id}return null}).filter(f=>f!==null),n.length===0&&(n=null));let r="",l=game.i18n.localize(i.labelKey);switch(e){case"lock-menu":r=this._generateToggleMacro("toggleLockMenu","Toggle Menu Lock");break;case"toggle-requests":r=this._generateToggleMacro("toggleRollRequests","Toggle Roll Requests");break;case"skip-dialogs":r=this._generateToggleMacro("toggleSkipDialogs","Toggle Skip Dialogs");break;case"group-rolls":r=this._generateToggleMacro("toggleGroupRolls","Toggle Group Rolls");break;case"show-options":r=this._generateToggleMacro("toggleShowOptions","Toggle Show Options on Hover");break;case"open-settings":r=this._generateActionMacro("openSettings","Open Flash Rolls Settings");break;case"premium-features":r=this._generateActionMacro("openPremiumFeatures","Open Premium Features");break;case"select-all":r=this._generateSelectAllMacro();break;case"filter-actors":r=this._generateFilterActorsMacro();break;case"toggle-targets":r=this._generateToggleTargetsMacro(n);break;case"heal-all":r=this._generateActorActionMacro("healAll","Heal All",n);break;case"kill-all":r=this._generateActorActionMacro("killAll","Kill All",n);break;case"remove-status":r=this._generateActorActionMacro("removeStatusEffects","Remove Status Effects",n);break;case"open-sheets":r=this._generateActorActionMacro("openSheets","Open Sheets",n);break;case"group-selected":r=this._generateActorActionMacro("groupSelected","Create Group",n);break;case"movement":r=this._generateActorActionMacro("toggleMovement","Toggle Movement",n);break;case"contested-roll":r=this._generateActorActionMacro("openContestedRoll","Contested Roll",n);break;case"place-tokens":r=this._generatePlaceTokensMacro(n);break;case"teleport-tokens":r=this._generateTeleportTokensMacro(n);break;case"transform":r=this._generateTransformActorsMacro(n);break;default:D.notify("warn",`No macro generation configured for icon: ${e}`);return}let d=null;a&&(d=await this._ensureFlashRollsFolder());const u=await Macro.create({name:`FTB: ${l}`,type:"script",command:r,img:"modules/flash-rolls-5e/assets/bolt-circle.svg",...d&&{folder:d},flags:{"flash-rolls-5e":{iconId:e,iconType:t}}});D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.macroCreated",{macroName:u.name})),u.sheet.render(!0)}catch(o){c.error("Failed to create macro",[o]),D.notify("error",game.i18n.localize("FLASH_ROLLS.notifications.macroCreationFailed"))}}static _generateToggleMacro(e,t){return`// Flash Token Bar: ${t}
try {
  FlashAPI.${e}();
} catch (error) {
  ui.notifications.error("Failed to execute ${t}: " + error.message);
}`}static _generateActionMacro(e,t){return`// Flash Token Bar: ${t}
try {
  FlashAPI.${e}();
} catch (error) {
  ui.notifications.error("Failed to execute ${t}: " + error.message);
}`}static _generateActorActionMacro(e,t,s){return s&&s.length>0?`// Flash Token Bar: ${t}
// Uses specific actors: ${s.join(", ")}
try {
  FlashAPI.${e}(${JSON.stringify(s)});
} catch (error) {
  ui.notifications.error("Failed to execute ${t}: " + error.message);
}`:`// Flash Token Bar: ${t}
// Uses currently selected actors
try {
  const actorIds = FlashAPI.getSelectedActors();
  if (actorIds.length === 0) {
    FlashAPI.notify('warn',"No actors selected");
  } else {
    FlashAPI.${e}(actorIds);
  }
} catch (error) {
  ui.notifications.error("Failed to execute ${t}: " + error.message);
}`}static _generateSelectAllMacro(){return`// Flash Token Bar: Toggle Select All Actors
// Toggles between selecting all and deselecting all actors
// Optional parameter - specify which tab to select from:
//   'pc'    - Player Characters tab
//   'npc'   - NPCs tab
//   'group' - Groups/Encounters tab
// Examples:
//   FlashAPI.selectAllActors();        // Toggle selection in current tab
//   FlashAPI.selectAllActors('pc');    // Switch to PC tab and toggle
//   FlashAPI.selectAllActors('npc');   // Switch to NPC tab and toggle

try {
  FlashAPI.selectAllActors();
} catch (error) {
  ui.notifications.error("Failed to execute Toggle Select All: " + error.message);
}`}static _generateFilterActorsMacro(){return`// Flash Token Bar: Filter Actors
// Available filter options (all are optional, defaults to false):
//   inCombat: true/false    - Show only actors in combat
//   visible: true/false     - Show only visible tokens
//   removeDead: true/false  - Hide dead actors (HP = 0)
//
// Examples:
//   FlashAPI.filterActors({ inCombat: true });
//   FlashAPI.filterActors({ visible: true, removeDead: true });
//   FlashAPI.filterActors();  // Opens filter dialog
//
// Toggle filters:
//   const current = FlashAPI.getActorFilters();
//   FlashAPI.filterActors({ ...current, inCombat: !current.inCombat });

try {
  // Customize the filters below or leave empty to open dialog
  FlashAPI.filterActors();
} catch (error) {
  ui.notifications.error("Failed to execute Filter Actors: " + error.message);
}`}static _generateToggleTargetsMacro(e){return e&&e.length>0?`// Flash Token Bar: Toggle Targets
// Uses specific actors: ${e.join(", ")}
try {
  FlashAPI.toggleTargets(${JSON.stringify(e)});
} catch (error) {
  ui.notifications.error("Failed to execute Toggle Targets: " + error.message);
}`:`// Flash Token Bar: Toggle Targets
// Uses currently selected actors, or clears all targets if none selected
try {
  const actorIds = FlashAPI.getSelectedActors();
  if (actorIds.length === 0 && game.user.targets.size === 0) {
    FlashAPI.notify('warn',"No actors selected and no targets to clear");
  } else {
    FlashAPI.toggleTargets(actorIds);
  }
} catch (error) {
  ui.notifications.error("Failed to execute Toggle Targets: " + error.message);
}`}static _generatePlaceTokensMacro(e){return e&&e.length>0?`// Flash Token Bar: Place Tokens
// Uses specific actors: ${e.join(", ")}
// Optional second parameter: location object {x: number, y: number}
// Examples:
//   FlashAPI.placeTokens(${JSON.stringify(e)});                    // Interactive placement
//   FlashAPI.placeTokens(${JSON.stringify(e)}, {x: 1000, y: 1000}); // Auto-place at coordinates

try {
  FlashAPI.placeTokens(${JSON.stringify(e)});
} catch (error) {
  ui.notifications.error("Failed to execute Place Tokens: " + error.message);
}`:`// Flash Token Bar: Place Tokens
// Uses currently selected actors
// Optional second parameter: location object {x: number, y: number}
// Examples:
//   FlashAPI.placeTokens(actorIds);                    // Interactive placement
//   FlashAPI.placeTokens(actorIds, {x: 1000, y: 1000}); // Auto-place at coordinates

try {
  const actorIds = FlashAPI.getSelectedActors();
  if (actorIds.length === 0) {
    FlashAPI.notify('warn',"No actors selected");
  } else {
    FlashAPI.placeTokens(actorIds);
  }
} catch (error) {
  ui.notifications.error("Failed to execute Place Tokens: " + error.message);
}`}static _generateTeleportTokensMacro(e){return e&&e.length>0?`// Flash Token Bar: Teleport Tokens
// Uses specific token IDs: ${e.join(", ")}
// Optional parameters:
//   destinationScene: Scene ID, name, or scene object
//   centerLocation: Object {x: number, y: number}
// Examples:
//   FlashAPI.teleportTokens(${JSON.stringify(e)});                                    // Interactive teleport
//   FlashAPI.teleportTokens(${JSON.stringify(e)}, 'sceneId', {x: 1000, y: 1000});     // Auto-teleport by scene ID
//   FlashAPI.teleportTokens(${JSON.stringify(e)}, 'Scene Name', {x: 1000, y: 1000});  // Auto-teleport by scene name

try {
  FlashAPI.teleportTokens(${JSON.stringify(e)});
} catch (error) {
  ui.notifications.error("Failed to execute Teleport Tokens: " + error.message);
}`:`// Flash Token Bar: Teleport Tokens
// Uses currently selected actors (converted to token IDs)
// Optional parameters:
//   destinationScene: Scene ID, name, or scene object
//   centerLocation: Object {x: number, y: number}
// Examples:
//   FlashAPI.teleportTokens(tokenIds);                                    // Interactive teleport
//   FlashAPI.teleportTokens(tokenIds, 'sceneId', {x: 1000, y: 1000});     // Auto-teleport by scene ID
//   FlashAPI.teleportTokens(tokenIds, 'Scene Name', {x: 1000, y: 1000});  // Auto-teleport by scene name

try {
  const tokenIds = FlashAPI.getSelectedActors(true);
  if (tokenIds.length === 0) {
    FlashAPI.notify('warn',"No tokens found for selected actors");
  } else {
    FlashAPI.teleportTokens(tokenIds);
  }
} catch (error) {
  ui.notifications.error("Failed to execute Teleport Tokens: " + error.message);
}`}static _generateTransformActorsMacro(e){return e&&e.length>0?`// Flash Token Bar: Transform Actors
// targetActorUuid: UUID of actor to transform into (shows dialog if omitted)
// options: Object with preset ('wildshape', 'polymorph', 'appearance'), settings, and renderSheet
// Example - transformation into specific actor as wildshape:
// FlashAPI.transformActors(actorIds, 'Compendium.dnd5e.monsters.Actor.xyz', { preset: 'wildshape' });

// Option 1: Use specific actors
const actorIds = ${JSON.stringify(e)};
// Option 2: Use currently selected actors in Flash Token Bar menu
// const actorIds = FlashAPI.getSelectedActors();

try {
  FlashAPI.transformActors(actorIds);
} catch (error) {
  ui.notifications.error("Failed to execute Transform Actors: " + error.message);
}`:`// Flash Token Bar: Transform Actors
// targetActorUuid: UUID of actor to transform into (shows dialog if omitted)
// options: Object with preset ('wildshape', 'polymorph', 'appearance'), settings, and renderSheet
// Example - transformation into specific actor as wildshape:
// FlashAPI.transformActors(actorIds, 'Compendium.dnd5e.monsters.Actor.xyz', { preset: 'wildshape' });

try {
  // Option 1: Use currently selected actors in Flash Token Bar menu
  const actorIds = FlashAPI.getSelectedActors();
  // Option 2: Use specific actors
  // const actorIds = ["8sKqJT1gcAUvko53","6xvOSmZnNUcP5Gyh"];

  if (actorIds.length === 0) {
    FlashAPI.notify('warn',"No actors selected");
  } else {
    FlashAPI.transformActors(actorIds);
  }
} catch (error) {
  ui.notifications.error("Failed to execute Transform Actors: " + error.message);
}`}static async _ensureFlashRollsFolder(){const e="Flash Token Bar";let t=game.folders.find(s=>s.type==="Macro"&&s.name===e);if(!t)try{t=await Folder.create({name:e,type:"Macro",color:"#302437",sort:0}),c.log("Created Flash Token Bar macro folder",[t])}catch(s){return c.error("Failed to create Flash Token Bar macro folder:",[s]),D.notify("warn","Failed to create Flash Token Bar macro folder. Macro will be created without folder organization."),null}return(t==null?void 0:t.id)||null}static close(){j(this,gt)&&(j(this,gt).remove(),De(this,gt,null))}}gt=new WeakMap,fe(Ks,gt,null);const Ze=class Ze{static attachListeners(e,t){c.log("RollMenuEventManager.attachListeners"),this.activeMenu=e,t.querySelectorAll(".actor").length===0?(this.cleanupActorTooltips(),t.classList.add("no-actors")):t.classList.remove("no-actors"),this.attachToggleHandlers(e,t),this.attachDragHandlers(e,t),this.attachTabHandlers(e,t),this.attachActorHandlers(e,t),this.attachActionIconHandlers(e,t),this.attachIconContextMenuHandlers(e,t),this.attachCompactTooltipHandlers(e,t),this.attachSearchHandlers(e,t),this.attachAccordionHandlers(e,t),this.attachSubmenuHandlers(e,t),this.attachStatusEffectHandlers(e,t),this.attachGroupHandlers(e,t),this.attachOutsideClickHandler(e)}static attachToggleHandlers(e,t){var s,o,a,i,n,r,l,d,u,f;(s=t.querySelector("#flash-rolls-toggle"))==null||s.addEventListener("change",e._onToggleRollRequests.bind(e)),(o=t.querySelector("#flash5e-skip-dialogs"))==null||o.addEventListener("change",e._onToggleSkipDialogs.bind(e)),(a=t.querySelector("#flash5e-group-rolls-msg"))==null||a.addEventListener("change",e._onToggleGroupRollsMsg.bind(e)),(i=t.querySelector("#flash5e-actors-all"))==null||i.addEventListener("change",e._onToggleSelectAll.bind(e)),(n=t.querySelector("#flash5e-filter-actors"))==null||n.addEventListener("click",e._onToggleActorFilter.bind(e)),(r=t.querySelector("#flash5e-actors-lock"))==null||r.addEventListener("click",e._onToggleLock.bind(e)),(l=t.querySelector(".options-toggle-btn"))==null||l.addEventListener("click",e._onToggleOptions.bind(e)),(d=t.querySelector("#flash5e-open-settings"))==null||d.addEventListener("click",e._onOpenSettings.bind(e)),(u=t.querySelector("#flash5e-premium-features"))==null||u.addEventListener("click",e._onOpenPremiumFeatures.bind(e)),(f=t.querySelector("#flash5e-premium-features"))==null||f.addEventListener("contextmenu",e._onPremiumFeaturesContextMenu.bind(e))}static attachDragHandlers(e,t){const s=t.querySelector(Ue.DRAG_HANDLE_SELECTOR);s&&!s.hasAttribute("data-drag-initialized")&&(s.setAttribute("data-drag-initialized","true"),s.addEventListener("mousedown",o=>{Ue.handleDragStart(o,e)}))}static attachTabHandlers(e,t){const s=t.querySelectorAll(".actor-tab");c.log("RollMenuEventManager.attachTabHandlers - found tabs:",[s.length]),s.forEach(o=>{c.log("RollMenuEventManager.attachTabHandlers - attaching to tab:",[o.dataset.tab]),o.addEventListener("click",e._onTabClick.bind(e)),o.addEventListener("dblclick",e._onTabDoubleClick.bind(e))})}static attachActionIconHandlers(e,t){var a,i,n,r,l,d,u,f,g,m,p,S;(a=t.querySelector("#flash5e-targets"))==null||a.addEventListener("click",()=>{this.toggleTargetsForSelected(e)}),(i=t.querySelector("#flash5e-heal-selected"))==null||i.addEventListener("click",()=>{this.healSelectedActors(e)}),(n=t.querySelector("#flash5e-kill-selected"))==null||n.addEventListener("click",()=>{this.killSelectedActors(e)}),(r=t.querySelector("#flash5e-sheets"))==null||r.addEventListener("click",()=>{this.openSheetsForSelected(e)}),(l=t.querySelector("#flash5e-toggle-list"))==null||l.addEventListener("change",()=>{this.toggleOptionsListOnHover(e)}),(d=t.querySelector("#flash5e-remove-effects"))==null||d.addEventListener("click",()=>{this.removeAllStatusEffectsFromSelected(e)}),(u=t.querySelector("#flash5e-group-selected"))==null||u.addEventListener("click",()=>{this.createGroupFromSelected(e)}),(f=t.querySelector("#flash5e-lock-movement"))==null||f.addEventListener("click",()=>{this.toggleMovementForSelected(e)}),(g=t.querySelector("#flash5e-contested-roll"))==null||g.addEventListener("click",()=>{this.openContestedRollDialog(e)}),(m=t.querySelector("#flash5e-place-tokens"))==null||m.addEventListener("click",()=>{this.placeTokensForSelected(e)}),(p=t.querySelector("#flash5e-teleport-tokens"))==null||p.addEventListener("click",()=>{this.teleportTokensForSelected(e)}),(S=t.querySelector("#flash5e-transform"))==null||S.addEventListener("click",()=>{this.transformSelectedActors(e)}),t.querySelectorAll(".actor-actions-nav").forEach(y=>{y.addEventListener("click",R=>{this.scrollActorActions(R.currentTarget,t)})});const o=t.querySelector(".actor-actions-scrollable");o&&(this.updateActorActionsContainerHeight(t),this.updateActorActionsNavState(t),this.restoreActorActionsScrollPosition(o),o.addEventListener("scroll",()=>{this.updateActorActionsNavState(t),this.saveActorActionsScrollPosition(o)}))}static saveActorActionsScrollPosition(e){if(!e)return;const t=I();v.get(t.menuLayout.tag);const s={left:e.scrollLeft,top:e.scrollTop};game.user.setFlag(k,"actorActionsScrollPosition",s)}static restoreActorActionsScrollPosition(e){if(!e)return;const t=game.user.getFlag(k,"actorActionsScrollPosition");t&&(e.scrollLeft=t.left||0,e.scrollTop=t.top||0)}static updateActorActionsContainerHeight(e){const t=e.querySelector(".actor-actions-scrollable");if(!t)return;const s=t.closest(".actor-actions-container");if(!s||s.classList.contains("no-scroll"))return;const o=t.querySelector("li.bulk-action");if(!o)return;const a=I(),i=v.get(a.menuLayout.tag)||"vertical",n=v.get(a.maxIconsPerRow.tag)||5;if(i==="horizontal"){const l=o.offsetWidth*n;t.style.maxWidth=`${l}px`,t.style.maxHeight=""}else{const l=o.offsetHeight*n;t.style.maxHeight=`${l}px`,t.style.maxWidth=""}}static scrollActorActions(e,t){const s=e.dataset.direction,o=t.querySelector(".actor-actions-scrollable");if(!o)return;const a=o.querySelector("li.bulk-action");if(!a)return;const i=I(),n=v.get(i.menuLayout.tag)||"vertical",r=v.get(i.maxIconsPerRow.tag)||5,l=Math.max(1,r-1);if(n==="horizontal"){const d=a.offsetWidth,u=s==="left"?-(d*l):d*l;o.scrollBy({left:u,behavior:"smooth"})}else{const d=a.offsetHeight,u=s==="up"?-(d*l):d*l;o.scrollBy({top:u,behavior:"smooth"})}setTimeout(()=>{this.updateActorActionsNavState(t)},300)}static updateActorActionsNavState(e){const t=e.querySelector(".actor-actions-scrollable");if(!t)return;const s=I(),o=v.get(s.menuLayout.tag)||"vertical";let a,i,n,r;if(o==="horizontal"){if(a=e.querySelector(".actor-actions-nav-left"),i=e.querySelector(".actor-actions-nav-right"),!a||!i)return;const l=t.scrollLeft,d=t.scrollWidth,u=t.clientWidth;n=l<=1,r=l+u>=d-1}else{if(a=e.querySelector(".actor-actions-nav-up"),i=e.querySelector(".actor-actions-nav-down"),!a||!i)return;const l=t.scrollTop,d=t.scrollHeight,u=t.clientHeight;n=l<=1,r=l+u>=d-1}n?(a.classList.add("disabled"),a.setAttribute("disabled","true")):(a.classList.remove("disabled"),a.removeAttribute("disabled")),r?(i.classList.add("disabled"),i.setAttribute("disabled","true")):(i.classList.remove("disabled"),i.removeAttribute("disabled"))}static attachIconContextMenuHandlers(e,t){const s=t.querySelectorAll('[data-icon-id][data-icon-type="moduleActions"]'),o=t.querySelectorAll('[data-icon-id][data-icon-type="actorActions"]');[...s,...o].forEach(i=>{const n=i.dataset.iconId,r=i.dataset.iconType;!n||!r||i.addEventListener("contextmenu",l=>{l.preventDefault(),l.stopPropagation(),Ks.show(l,n,r,e)})})}static attachActorHandlers(e,t){t.querySelectorAll(".actor.drag-wrapper").forEach(s=>{s.addEventListener("click",n=>{s.hasAttribute("data-non-selectable")||e._onActorClick.call(e,n)});const o=s.querySelector(".icon-sheet");o&&o.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const r=s.dataset.actorId,l=s.dataset.tokenId;this.openActorSheetById(r,l)});const a=s.querySelector(".icon-target");a&&a.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const r=s.dataset.actorId,l=s.dataset.tokenId;this.toggleActorTargetById(r,l)});const i=s.querySelector(".actor-img");i&&(i.addEventListener("contextmenu",n=>{n.preventDefault(),n.stopPropagation();const r=s.dataset.tokenId,l=s.dataset.actorId;let d=r?canvas.tokens.get(r):null;!d&&l&&(d=canvas.tokens.placeables.find(u=>{var f;return((f=u.actor)==null?void 0:f.id)===l})),d&&canvas.animatePan({x:d.x,y:d.y,duration:250})}),i.addEventListener("mouseenter",n=>{this.showTokenSelectionPreview(s,e)}),i.addEventListener("mouseleave",n=>{this.hideTokenSelectionPreview(s,e)}))})}static cleanupActorTooltips(){document.querySelectorAll(".actor-data-tooltip").forEach(t=>t.remove())}static attachCompactTooltipHandlers(e,t){if(this.cleanupActorTooltips(),!t.classList.contains("compact"))return;t.querySelectorAll("#flash-rolls-menu.compact .actor").forEach(o=>{const a=o.querySelector(".actor-data");if(!a)return;let i=null;const n=async d=>{const u=document.querySelector(".actor-data-tooltip");u&&u.remove(),i=a.cloneNode(!0);const f=o.getBoundingClientRect(),g=t.getBoundingClientRect(),m=t.classList.contains("left-edge");if(t.hasAttribute("data-layout")&&t.getAttribute("data-layout")==="horizontal"){const S=o.querySelector(".actor-img"),y=S?S.getBoundingClientRect():f,R=y.left+y.width/2-g.left-16;i.style.left=`${R}px`,i.style.transform="translateX(-50%)",i.style.bottom=`${g.bottom-f.top+8}px`,i.style.top="auto",i.style.right="auto"}else m?i.style.left=`${f.right-g.left-8}px`:i.style.right=`${g.right-f.left-8}px`,i.style.top=`${f.top-g.top}px`;i.className="actor-data-tooltip",document.querySelector("#flash-rolls-menu").appendChild(i),setTimeout(()=>{i==null||i.classList.add("visible")},e.selectedActors.size>0?300:0)},r=()=>{i&&(i.remove(),i=null)};o.addEventListener("mouseenter",n),o.addEventListener("mouseleave",r);const l=o.closest("ul");l&&l.addEventListener("scroll",r)})}static attachSearchHandlers(e,t){const s=t.querySelector(".search-input");s&&(s.addEventListener("input",e._onSearchInput.bind(e)),s.addEventListener("click",o=>{o.target.select()}),s.addEventListener("focus",o=>{o.target.select(),e.isSearchFocused=!0,game.user.setFlag(k,"searchFocused",!0)}),s.addEventListener("blur",()=>{e.isSearchFocused=!1,game.user.setFlag(k,"searchFocused",!1);const o=t.querySelector(".request-types-accordion");o&&!t.matches(":hover")&&o.classList.remove("hover-visible")}))}static attachAccordionHandlers(e,t){const s=I(),o=v.get(s.showOptionsListOnHover.tag),a=t.querySelector(".request-types-accordion");if(a){const n=()=>{const l=v.get(s.showOptionsListOnHover.tag);e.selectedActors.size>0&&l&&(a==null||a.classList.add("hover-visible"))},r=()=>{e.isSearchFocused||a==null||a.classList.remove("hover-visible")};e._accordionMouseEnter=n,e._accordionMouseLeave=r,o?(t.addEventListener("mouseenter",n),t.addEventListener("mouseleave",r),e._accordionListenersAttached=!0):e._accordionListenersAttached=!1}const i=t.querySelector(".request-types");c.log("RollMenuEventManager.attachAccordionHandlers",[i]),i&&i.addEventListener("click",n=>{if(n.target.classList.contains("btn-macro")){n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation();const u=n.target.closest(".sub-item")||n.target.closest(".request-type-item");if(u){const f={...n,currentTarget:u};e._onMacroButtonClick(f)}return}const r=n.target.closest(".btn-macro");if(r){n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation();const u=r.closest(".sub-item")||r.closest(".request-type-item");if(u){const f={...n,currentTarget:u};e._onMacroButtonClick(f)}return}const l=n.target.closest(".request-type-header");if(l){const u=l.closest(".request-type-item");if(l.classList.contains("accordion-header")){e._onAccordionToggle(n);return}if(l.classList.contains("toggle")&&u&&u.classList.contains("rollable")){const f={...n,currentTarget:u};e._onRequestTypeClick(f);return}}const d=n.target.closest(".sub-item");if(d&&d.dataset.id){const u={...n,currentTarget:d};e._onRollTypeClick(u)}})}static attachSubmenuHandlers(e,t){try{t.querySelectorAll(".submenu-tabs li[data-tab]").forEach(o=>{o.addEventListener("click",e._onSubmenuTabClick.bind(e))})}catch(s){c.error("RollMenuEventManager.attachSubmenuHandlers error:",[s])}}static attachStatusEffectHandlers(e,t){try{t.querySelectorAll(".status-effects .status-effect").forEach(o=>{o.dataset.listenerAttached||(o.dataset.listenerAttached="true",o.addEventListener("click",e._onStatusEffectClick.bind(e)))})}catch(s){c.error("RollMenuEventManager.attachStatusEffectHandlers error:",[s])}}static attachGroupHandlers(e,t){t.querySelectorAll(".group-expand-btn").forEach(o=>{o.addEventListener("click",async a=>{a.preventDefault(),a.stopPropagation();const i=o.dataset.groupId,n=e.groupExpansionStates[i]??!1;e.groupExpansionStates[i]=!n,await game.user.setFlag(k,"groupExpansionStates",e.groupExpansionStates),e.render()})})}static attachOutsideClickHandler(e){setTimeout(()=>{document.addEventListener("click",e._onClickOutside,!0)},100)}static toggleTargetsForSelected(e){if(e.selectedActors.size>0)e.selectedActors.forEach(t=>{const s=se(t);if(!s)return;const o=s.id,a=game.actors.get(t)?null:t;this.toggleActorTargetById(o,a)});else if(game.user.targets.size>0){const t=game.user.targets.size;game.user.targets.forEach(s=>{s.setTarget(!1,{releaseOthers:!1})}),D.notify("info",`Cleared ${t} target(s)`)}}static openSheetsForSelected(e){e.currentTab==="group"?this.openGroupSheetsForSelected(e):e.selectedActors.forEach(t=>{const s=se(t);if(!s)return;const o=s.id,a=game.actors.get(t)?null:t;this.openActorSheetById(o,a)})}static openGroupSheetsForSelected(e){const s=(e._lastPreparedContext||{}).actors||[],o=new Set;s.forEach(a=>{a.isGroup&&a.members&&a.members.some(n=>e.selectedActors.has(n.uniqueId))&&!o.has(a.id)&&(this.openActorSheetById(a.id,a.tokenId),o.add(a.id))})}static healSelectedActors(e){e.selectedActors.forEach(t=>{const s=se(t);if(!s)return;const o=s.id,a=game.actors.get(t)?null:t;this.healActorById(o,a)})}static killSelectedActors(e){e.selectedActors.forEach(t=>{const s=se(t);if(!s)return;const o=s.id,a=game.actors.get(t)?null:t;this.killActorById(o,a)})}static async removeAllStatusEffectsFromSelected(e){if(e.selectedActors.size===0){D.notify("warn","No actors selected");return}let t=0,s=0;for(const o of e.selectedActors){const a=se(o);if(!a)continue;s++;const i=a.appliedEffects.filter(n=>{var r,l,d;return((r=n.statuses)==null?void 0:r.size)>0||((d=(l=n.flags)==null?void 0:l.core)==null?void 0:d.statusId)});if(i.length>0)for(const n of i)try{await n.delete(),t++}catch(r){c.error(`Failed to remove status effect from ${a.name}`,[r])}}t>0?D.notify("info",`Removed ${t} status effects from ${s} actor(s)`):D.notify("info","No status effects to remove from selected actors")}static toggleActorTarget(e){const t=e.dataset.tokenId,s=e.dataset.actorId;let o=t?canvas.tokens.get(t):null;if(!o&&s&&(o=canvas.tokens.placeables.find(a=>{var i;return((i=a.actor)==null?void 0:i.id)===s})),o){const a=game.user.targets.has(o);o.setTarget(!a,{releaseOthers:!1})}}static openActorSheet(e){const t=e.dataset.actorId,s=e.dataset.tokenId;if(t){let o;if(s){const a=canvas.tokens.get(s);o=(a==null?void 0:a.actor)||game.actors.get(t)}else o=game.actors.get(t);o==null||o.sheet.render(!0)}}static healActor(e){var a,i;const t=e.dataset.actorId,s=e.dataset.tokenId;let o;if(s){const n=canvas.tokens.get(s);o=(n==null?void 0:n.actor)||game.actors.get(t)}else o=game.actors.get(t);if(o&&((i=(a=o.system)==null?void 0:a.attributes)!=null&&i.hp)){const n=o.system.attributes.hp.max;o.update({"system.attributes.hp.value":n})}}static killActor(e){var a,i;const t=e.dataset.actorId,s=e.dataset.tokenId;let o;if(s){const n=canvas.tokens.get(s);o=(n==null?void 0:n.actor)||game.actors.get(t)}else o=game.actors.get(t);o&&((i=(a=o.system)==null?void 0:a.attributes)!=null&&i.hp)&&o.update({"system.attributes.hp.value":0})}static toggleActorTargetById(e,t){let s=t?canvas.tokens.get(t):null;if(!s&&e&&(s=canvas.tokens.placeables.find(o=>{var a;return((a=o.actor)==null?void 0:a.id)===e})),s){const o=game.user.targets.has(s);s.setTarget(!o,{releaseOthers:!1})}}static openActorSheetById(e,t){if(e){let s;if(t){const o=canvas.tokens.get(t);s=(o==null?void 0:o.actor)||game.actors.get(e)}else s=game.actors.get(e);s==null||s.sheet.render(!0)}}static healActorById(e,t){var o,a;let s;if(t){const i=canvas.tokens.get(t);s=(i==null?void 0:i.actor)||game.actors.get(e)}else s=game.actors.get(e);if(s&&((a=(o=s.system)==null?void 0:o.attributes)!=null&&a.hp)){const i=s.system.attributes.hp.max;s.update({"system.attributes.hp.value":i})}}static killActorById(e,t){var o,a;let s;if(t){const i=canvas.tokens.get(t);s=(i==null?void 0:i.actor)||game.actors.get(e)}else s=game.actors.get(e);s&&((a=(o=s.system)==null?void 0:o.attributes)!=null&&a.hp)&&s.update({"system.attributes.hp.value":0})}static showTokenSelectionPreview(e,t){var i,n;const s=e.dataset.tokenId,o=e.dataset.actorId;let a=s?canvas.tokens.get(s):null;if(!a&&o&&(a=canvas.tokens.placeables.find(r=>{var l;return((l=r.actor)==null?void 0:l.id)===o})),a&&!a.hover){a.hover=!0,a.renderFlags.set({refreshState:!0}),this._hoveredTokens.add(a);const r=I();v.get(r.showTokenVisionOnHover.tag)&&((i=canvas.scene)!=null&&i.tokenVision)&&((n=a.document.sight)!=null&&n.enabled)&&game.user.isGM&&(this._previouslyControlledTokens=[...canvas.tokens.controlled],this._previewControlToken=a,this._originalControlledGetter=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(a),"controlled"),Object.defineProperty(a,"controlled",{get:()=>!0,configurable:!0}),a.initializeVisionSource(),canvas.perception.update({initializeVision:!0,refreshVision:!0}))}}static async toggleOptionsListOnHover(e){const t=I(),s=v.get(t.showOptionsListOnHover.tag),o=e.element.querySelector(".request-types-accordion");o==null||o.classList.contains("hover-visible");const a=!s;await v.set(t.showOptionsListOnHover.tag,a),Ze.updateAccordionHoverBehaviorNoRender(e,a),a===!1||e.selectedActors.size===0?o==null||o.classList.remove("hover-visible"):a===!0&&e.selectedActors.size>0&&(o==null||o.classList.add("hover-visible"))}static updateAccordionHoverBehavior(e,t){e.render()}static updateAccordionHoverBehaviorNoRender(e,t){const s=e.element,o=s.querySelector(".request-types-accordion");!o||!e._accordionMouseEnter||(s.removeEventListener("mouseenter",e._accordionMouseEnter),s.removeEventListener("mouseleave",e._accordionMouseLeave),o.classList.remove("hover-visible"),t&&(s.addEventListener("mouseenter",e._accordionMouseEnter),s.addEventListener("mouseleave",e._accordionMouseLeave)))}static hideTokenSelectionPreview(e,t){const s=e.dataset.tokenId,o=e.dataset.actorId;let a=s?canvas.tokens.get(s):null;!a&&o&&(a=canvas.tokens.placeables.find(i=>{var n;return((n=i.actor)==null?void 0:n.id)===o})),a&&this._hoveredTokens.has(a)&&(a.hover=!1,a.renderFlags.set({refreshState:!0}),this._hoveredTokens.delete(a),this._previewControlToken===a&&game.user.isGM&&(delete a.controlled,this._originalControlledGetter&&(Object.defineProperty(a,"controlled",this._originalControlledGetter),this._originalControlledGetter=null),a.initializeVisionSource(),this._previouslyControlledTokens.forEach(i=>{i.scene===canvas.scene&&i.initializeVisionSource()}),canvas.perception.update({initializeVision:!0,refreshVision:!0}),this._previewControlToken=null,this._previouslyControlledTokens=[]))}static async createGroupFromSelected(e){var u;if(e.selectedActors.size===0){D.notify("warn","No actors selected");return}const t=new Map,s={},o=(u=game.scenes.current)==null?void 0:u.id;let a=0,i=0;for(const f of e.selectedActors){const g=se(f);if(!g)continue;i++;const m=g.id;if(t.has(m)){const p=t.get(m);p.count++,g.tokenId&&p.tokenIds.push(g.tokenId)}else{t.set(m,{actor:g,count:1,tokenIds:g.tokenId?[g.tokenId]:[]});const p=game.actors.get(m);p!=null&&p.hasPlayerOwner&&a++}if(f!==g.id&&o){const p=`Scene.${o}.Token.${f}`;s[o]||(s[o]={}),s[o][m]||(s[o][m]=[]),s[o][m].push(p)}}if(t.size===0){D.notify("warn","No valid actors found");return}const n=a/t.size,r=n>=.5?"group":"encounter",l=r==="group"?"New Group":"New Encounter",d=[];if(r==="group")for(const[f,{actor:g,count:m}]of t)game.actors.get(f)&&d.push({actor:f});else for(const[f,{actor:g,count:m}]of t)d.push({uuid:`Actor.${f}`,quantity:{value:m,formula:""}});try{const f=await Actor.create({name:l,type:r,img:"icons/svg/mystery-man.svg",system:{members:d},flags:{"flash-rolls-5e":{tokenAssociationsByScene:s}},ownership:{default:CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER,[game.user.id]:CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER}});if(f){for(const[m,p]of Object.entries(s))for(const S of Object.values(p))for(const y of S)try{const R=await fromUuid(y);R&&await R.setFlag(k,"groupId",f.id)}catch(R){c.log(`createGroupFromSelected - Failed to set groupId on token ${y}`,R)}f.sheet.render(!0);const g=Array.from(t.values()).map(({actor:m,count:p})=>p>1?`${m.name} (x${p})`:m.name).join(", ");D.notify("info",`Created ${r} "${f.name}" (${i} tokens, ${t.size} unique: ${g})`),c.log(`createGroupFromSelected - Created ${r}:`,{newActor:f,totalSelectedCount:i,uniqueActorCount:t.size,playerOwnedCount:a,playerOwnedRatio:n,tokenAssociationsByScene:s,members:Array.from(t.entries()).map(([m,{actor:p,count:S,tokenUuids:y}])=>({id:m,name:p.name,quantity:S,tokenUuids:y}))})}}catch(f){c.error("Failed to create group/encounter actor:",f),D.notify("warn",`Failed to create ${r}: ${f.message}`)}}static async toggleMovementForSelected(e){await Fe.toggleMovementForSelected(e)}static async openContestedRollDialog(e){var i,n;const t=e||this.activeMenu;if(!t||t.selectedActors.size===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}const s=[];for(const r of t.selectedActors){const l=se(r);if(l){const d=(i=game.scenes.current)==null?void 0:i.tokens.get(r),u=(n=canvas.tokens)==null?void 0:n.get(r),f=d||u?r:null;s.push({actor:l,uniqueId:r,tokenId:f})}}if(s.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}if(s.length<2){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.twoActorsRequired"));return}const o=s.slice(0,2),{ContestedRollDialog:a}=await Dt(async()=>{const{ContestedRollDialog:r}=await Promise.resolve().then(()=>fa);return{ContestedRollDialog:r}},void 0);await a.show(o)}static async placeTokensForSelected(e){const{TokenPlacementManager:t}=await Dt(async()=>{const{TokenPlacementManager:s}=await Promise.resolve().then(()=>ta);return{TokenPlacementManager:s}},void 0);await t.placeTokensForSelectedActors(e)}static async teleportTokensForSelected(e){const{TokenTeleportManager:t}=await Dt(async()=>{const{TokenTeleportManager:s}=await Promise.resolve().then(()=>sa);return{TokenTeleportManager:s}},void 0);await t.teleportSelectedTokens(e)}static async transformSelectedActors(e){const{TransformationManager:t}=await Dt(async()=>{const{TransformationManager:s}=await Promise.resolve().then(()=>na);return{TransformationManager:s}},void 0);await t.transformSelectedActors(e)}};E(Ze,"_hoveredTokens",new Set),E(Ze,"_previewControlToken",null),E(Ze,"_previouslyControlledTokens",[]),E(Ze,"_originalControlledGetter",null),E(Ze,"activeMenu",null);let Ae=Ze;class Ys{static async applyStatusToSelected(e,t){const s=CONFIG.statusEffects.find(i=>i.id===e);if(!s){D.notify("warn",`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){D.notify("warn","No actors selected");return}let o=0,a=0;for(const i of t.selectedActors){const n=se(i);if(!n)continue;a++,await this.applyStatusToActor(s,n)&&o++}if(o>0){const i=s.name||s.label||s.id;D.notify("info",`Applied "${i}" to ${o}/${a} actors`)}}static async applyStatusToActor(e,t){try{if(t.appliedEffects.find(a=>{var i,n,r;return((i=a.statuses)==null?void 0:i.has(e.id))||((r=(n=a.flags)==null?void 0:n.core)==null?void 0:r.statusId)===e.id}))return c.log(`RollMenuStatusManager: Actor ${t.name} already has status effect ${e.id}`),!1;if(t.toggleStatusEffect)return t.appliedEffects.some(i=>{var n;return(n=i.statuses)==null?void 0:n.has(e.id)})?!1:(await t.toggleStatusEffect(e.id,{active:!0}),c.log(`RollMenuStatusManager: Applied ${e.id} to ${t.name}`),!0);const o={name:e.name||e.label||e.id,icon:e.icon||e.img,statuses:[e.id],flags:{core:{statusId:e.id}}};return e.changes&&(o.changes=e.changes),await t.createEmbeddedDocuments("ActiveEffect",[o]),c.log(`RollMenuStatusManager: Applied ${e.id} to ${t.name}`),!0}catch(s){return c.error(`RollMenuStatusManager: Failed to apply status effect to ${t.name}`,[s]),!1}}static async removeStatusFromSelected(e,t){const s=CONFIG.statusEffects.find(i=>i.id===e);if(!s){D.notify("warn",`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){D.notify("warn","No actors selected");return}let o=0,a=0;for(const i of t.selectedActors){const n=se(i);if(!n)continue;a++,await this.removeStatusFromActor(s,n)&&o++}if(o>0){const i=s.name||s.label||s.id;D.notify("info",`Removed "${i}" from ${o}/${a} actors`)}}static async removeStatusFromActor(e,t){try{if(t.toggleStatusEffect)return t.appliedEffects.some(a=>{var i;return(i=a.statuses)==null?void 0:i.has(e.id)})?(await t.toggleStatusEffect(e.id,{active:!1}),c.log(`RollMenuStatusManager: Removed ${e.id} from ${t.name}`),!0):!1;const s=t.appliedEffects.find(o=>{var a,i,n;return((a=o.statuses)==null?void 0:a.has(e.id))||((n=(i=o.flags)==null?void 0:i.core)==null?void 0:n.statusId)===e.id});return s?(await s.delete(),c.log(`RollMenuStatusManager: Removed ${e.id} from ${t.name}`),!0):(c.log(`RollMenuStatusManager: Actor ${t.name} does not have status effect ${e.id}`),!1)}catch(s){return c.error(`RollMenuStatusManager: Failed to remove status effect from ${t.name}`,[s]),!1}}static async toggleStatusOnSelected(e,t){const s=CONFIG.statusEffects.find(a=>a.id===e);if(!s){D.notify("warn",`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){D.notify("warn","No actors selected");return}let o=!1;for(const a of t.selectedActors){const i=se(a);if(!i)continue;if(i.appliedEffects.find(r=>{var l,d,u;return((l=r.statuses)==null?void 0:l.has(s.id))||((u=(d=r.flags)==null?void 0:d.core)==null?void 0:u.statusId)===s.id})){o=!0;break}}o?await this.removeStatusFromSelected(e,t):await this.applyStatusToSelected(e,t)}static getStatusEffectsForTemplate(){try{return!CONFIG.statusEffects||!Array.isArray(CONFIG.statusEffects)?(c.warn("RollMenuStatusManager: CONFIG.statusEffects not available or not an array"),[]):CONFIG.statusEffects.map(e=>({...e,displayName:e.name||e.label||e.id,iconPath:e.icon||e.img||"icons/svg/aura.svg"})).sort((e,t)=>e.displayName.localeCompare(t.displayName,void 0,{sensitivity:"base"}))}catch(e){return c.error("RollMenuStatusManager: Error getting status effects for template",[e]),[]}}}class ie{static async handleToggleRollRequests(e){const t=I(),s=e.target.checked;await v.set(t.rollRequestsEnabled.tag,s),Wt.updateRollRequestsIcon(s)}static async handleToggleSkipDialogs(e){const t=I(),s=e.target.checked;await v.set(t.skipRollDialog.tag,s)}static async handleToggleGroupRollsMsg(e){const t=I(),s=e.target.checked;await v.set(t.groupRollsMsgEnabled.tag,s)}static handleToggleSelectAll(e,t){const s=I(),o=e.target.checked;t._ignoreTokenControl=!0;const a=t._lastPreparedContext||{};(t.currentTab==="group"?a.groups||[]:a.actors||[]).forEach(l=>{if(l.isGroup&&l.members)l.members.forEach(d=>{const u=d.uniqueId;o?(t.selectedActors.add(u),d.tokenId?Oe(d.id,!0,d.tokenId):Oe(d.id,!0)):(t.selectedActors.delete(u),d.tokenId?Oe(d.id,!1,d.tokenId):Oe(d.id,!1))});else{const d=l.uniqueId;o?(t.selectedActors.add(d),l.tokenId?Oe(l.id,!0,l.tokenId):Oe(l.id,!0)):(t.selectedActors.delete(d),l.tokenId?Oe(l.id,!1,l.tokenId):Oe(l.id,!1))}}),setTimeout(()=>{t._ignoreTokenControl=!1},200),t._updateGroupSelectionUI(),this.updateSelectAllState(t),t.render(),this.updateRequestTypesVisibility(t);const n=v.get(s.showOptionsListOnHover.tag),r=t.element.querySelector(".request-types-accordion");r&&(t.selectedActors.size>0&&n?r.classList.add("hover-visible"):r.classList.remove("hover-visible"))}static async handleToggleLock(e,t){var i;e.preventDefault(),t.isLocked=!t.isLocked,await game.user.setFlag(V.ID,"menuLocked",t.isLocked);const s=e.currentTarget||((i=t.element)==null?void 0:i.querySelector("#flash5e-actors-lock"));s&&(s.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),s.classList.add(t.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open"));const o=I();v.get(o.lockMenuPosition.tag)&&t.element&&(t.isLocked?t.element.classList.add("position-locked"):t.element.classList.remove("position-locked"))}static async handleToggleActorFilter(e,t){e.preventDefault(),e.stopPropagation();const s=e.currentTarget,o=t.element.querySelector(".actor-filter-tooltip");if(o){o.remove();return}const a=await ie.createActorFilterTooltip(t);t.element.appendChild(a);const i=s.getBoundingClientRect(),n=t.element.getBoundingClientRect(),r=t.element.dataset.layout,l=a.getBoundingClientRect(),d=i.top-n.top,f=i.left-n.left+i.width/2-l.width/2;if(r==="horizontal")a.style.top=`${d-l.height-8}px`,a.style.left=`${f}px`;else{const g=t.element.classList.contains("left-edge"),m=i.left-n.left,S=d+i.height-l.height;g?(a.style.top=`${S}px`,a.style.left=`${m+i.width+20}px`):(a.style.top=`${S}px`,a.style.left=`${m-l.width-20}px`)}}static async handleToggleOptions(e,t){e.preventDefault(),e.stopPropagation(),t.optionsExpanded=!t.optionsExpanded,await game.user.setFlag(V.ID,"menuOptionsExpanded",t.optionsExpanded);const s=t.element.querySelector(".options-toggle");s&&s.classList.toggle("expanded",t.optionsExpanded);const o=t.element.querySelector("li.options");o&&o.classList.toggle("expanded",t.optionsExpanded)}static toggleActorSelection(e,t,s,o){const a=I();o._ignoreTokenControl=!0,o.selectedActors.has(e)?(o.selectedActors.delete(e),s?Oe(t,!1,s):Oe(t,!1)):(o.selectedActors.add(e),s?Oe(t,!0,s):Oe(t,!0)),setTimeout(()=>{o._ignoreTokenControl=!1},100),this.updateActorSelectionUI(e,o),this.updateSelectAllState(o),this.updateRequestTypesVisibilityNoRender(o);const i=v.get(a.showOptionsListOnHover.tag),n=o.element.querySelector(".request-types-accordion");n&&(o.selectedActors.size>0&&i?n.classList.add("hover-visible"):n.classList.remove("hover-visible"))}static updateActorSelectionUI(e,t){const s=t.element.querySelector(`.actor.drag-wrapper[data-id="${e}"]`);if(!s)return;const o=s.closest(".actor");if(!o)return;const a=o.querySelector(".actor-select"),i=t.selectedActors.has(e);a&&(a.checked=i),s.classList.toggle("selected",i),s.dataset.selected=i.toString()}static updateRequestTypesVisibility(e){e.render()}static updateRequestTypesVisibilityNoRender(e){const t=e.selectedActors.size>0,s=e.element.querySelector(".request-types");if(s){s.querySelectorAll(".request-type-item").forEach(n=>{n.classList.toggle("disabled",!t)});const a=Array.from(e.selectedActors).some(n=>{const r=se(n);return(r==null?void 0:r.type)==="character"}),i=s.querySelector('[data-id="HIT_DIE"]');i&&(i.style.display=a?"":"none")}}static updateSelectAllState(e){const t=e.element.querySelector("#flash5e-actors-all");let s=0,o=0;if(e.currentTab==="group"){const i=(e._lastPreparedContext||{}).groups||[],n=[];i.forEach(r=>{r.isGroup&&r.members&&n.push(...r.members)}),o=n.length,s=n.filter(r=>e.selectedActors.has(r.uniqueId)).length}else{const a=e.currentTab==="pc"?"pc":"npc",i=e.element.querySelectorAll(`.${a}-actors .actor-item input[type="checkbox"]`);o=i.length,s=Array.from(i).filter(n=>n.checked).length}t&&(t.checked=s>0&&s===o,t.indeterminate=s>0&&s<o)}static async createActorFilterTooltip(e){const t=game.user.getFlag(V.ID,"actorFilters")||{inCombat:!1,visible:!1,removeDead:!1};e.actorFilters=t;const o=await renderTemplate("modules/flash-rolls-5e/templates/actor-filter-tooltip.hbs",{filters:t}),a=document.createElement("div");a.innerHTML=o;const i=a.firstElementChild;return i.querySelectorAll('input[type="checkbox"]').forEach(n=>{n.addEventListener("change",r=>{ie.applyActorFilters(e)})}),i}static async applyActorFilters(e){const t=e.element.querySelector(".actor-filter-tooltip");if(!t)return;const s={inCombat:t.querySelector('[data-filter="inCombat"]').checked,visible:t.querySelector('[data-filter="visible"]').checked,removeDead:t.querySelector('[data-filter="removeDead"]').checked};e.actorFilters=s,await game.user.setFlag(V.ID,"actorFilters",s),e.render()}static doesActorPassFilters(e,t,s=null){return!t.inCombat&&!t.visible&&!t.removeDead?!0:!(t.inCombat&&!(s?s.inCombat:e.inCombat)||t.visible&&s&&s.hidden||t.removeDead&&e.appliedEffects.some(a=>{var i,n,r;return((i=a.statuses)==null?void 0:i.has("dead"))||((r=(n=a.flags)==null?void 0:n.core)==null?void 0:r.statusId)==="dead"}))}}class jo{static async prepareActorContext(e,t){const s=I(),o=game.actors.contents,a=[],i=[],n=[],r=game.scenes.current;for(const A of o){if(A.type==="group"||A.type==="encounter"){const b=await this.processGroupActor(A,r,e);n.push(...b);continue}if(A.type!=="character"&&A.type!=="npc")continue;const _=this.isPlayerOwnedActor(A),T=await this.processActor(A,r,e,_);_?a.push(...T):i.push(...T)}const l=e.actorFilters||{};if(l.inCombat||l.visible||l.removeDead){const A=a.filter(b=>{const C=b.tokenId?r==null?void 0:r.tokens.get(b.tokenId):null,w=(C==null?void 0:C.actor)||game.actors.get(b.id);return w?ie.doesActorPassFilters(w,l,C):!1});a.length=0,a.push(...A);const _=i.filter(b=>{const C=b.tokenId?r==null?void 0:r.tokens.get(b.tokenId):null,w=(C==null?void 0:C.actor)||game.actors.get(b.id);return w?ie.doesActorPassFilters(w,l,C):!1});i.length=0,i.push(..._);const T=n.filter(b=>{if(b.isGroup){const C=game.actors.get(b.id),w=b.tokenId?r==null?void 0:r.tokens.get(b.tokenId):null,M={inCombat:l.inCombat,visible:l.visible,removeDead:!1};return C&&ie.doesActorPassFilters(C,M,w)||b.members&&b.members.length>0}else{const C=game.actors.get(b.id);if(!C)return!1;const w=b.tokenId?r==null?void 0:r.tokens.get(b.tokenId):null;return ie.doesActorPassFilters(C,l,w)}});n.length=0,n.push(...T)}n.sort((A,_)=>{var O;const T=game.actors.get(A.id),b=game.actors.get(_.id);if(!T||!b)return 0;const C=(O=game.settings.get("dnd5e","primaryParty"))==null?void 0:O.actor,w=(C==null?void 0:C.id)===T.id,M=(C==null?void 0:C.id)===b.id;return w&&!M?-1:!w&&M?1:T.type==="group"&&b.type==="encounter"?-1:T.type==="encounter"&&b.type==="group"?1:0});const d=v.get(s.rollRequestsEnabled.tag),u=v.get(s.skipRollDialog.tag),f=v.get(s.groupRollsMsgEnabled.tag);v.get(s.showOnlyPCsWithToken.tag);const g=v.get(s.showOptionsListOnHover.tag)??s.showOptionsListOnHover.default;c.log("Template context showOptionsListOnHover:",[g,typeof g,"tag:",s.showOptionsListOnHover.tag]);const m=e.currentTab==="pc"?a:e.currentTab==="npc"?i:n;let p=!1;if(m.length>0)if(e.currentTab==="group"){const A=[];m.forEach(_=>{_.isGroup&&_.members&&A.push(..._.members)}),p=A.length>0&&A.every(_=>e.selectedActors.has(_.uniqueId))}else p=m.every(A=>e.selectedActors.has(A.uniqueId));const S=this.buildRequestTypes(e),y=ks(e.selectedRequestType,e.selectedActors),R=Ys.getStatusEffectsForTemplate();return{...t,actors:e.currentTab==="group"?[]:m,groups:e.currentTab==="group"?m:[],currentTab:e.currentTab,isPCTab:e.currentTab==="pc",isNPCTab:e.currentTab==="npc",isGroupTab:e.currentTab==="group",selectedTab:e.currentTab,selectedSubmenu:e.selectedSubmenu,rollRequestsEnabled:d,skipRollDialog:u,groupRollsMsgEnabled:f,showOptionsListOnHover:g,selectAllOn:p,hasSelectedActors:e.selectedActors.size>0,requestTypes:S,rollTypes:y,statusEffects:R,showNames:!0,actorsLocked:e.isLocked,optionsExpanded:e.optionsExpanded,isGM:game.user.isGM,isCompact:v.get(s.compactMode.tag)}}static isPlayerOwnedActor(e){return Object.entries(e.ownership).some(([o,a])=>{const i=game.users.get(o);return i&&!i.isGM&&a>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})?!0:game.users.some(o=>{var a;return!o.isGM&&((a=o.character)==null?void 0:a.id)===e.id})}static async processActor(e,t,s,o){var d;if(he.isBlocked(e))return[];const a=I(),i=v.get((d=a.showOnlyPCsWithToken)==null?void 0:d.tag),n=he.isFavorite(e),r=(t==null?void 0:t.tokens.filter(u=>u.actorId===e.id))||[],l=[];return o?n?l.push(...this.processFavoriteActor(e,r,s)):i?l.push(...this.processTokenOnlyActor(e,r,s)):l.push(...this.processRegularActor(e,r,s)):n?l.push(...this.processFavoriteActor(e,r,s)):l.push(...this.processTokenOnlyActor(e,r,s)),l}static processFavoriteActor(e,t,s){const o=[];if(t.length>0)t.forEach(a=>{const i=this.createActorData(e,a,s);i.isFavorite=!0,o.push(i)});else{const a=this.createActorData(e,null,s);a.isFavorite=!0,o.push(a)}return o}static processTokenOnlyActor(e,t,s){const o=[];return t.length>0&&t.forEach(a=>{const i=this.createActorData(e,a,s);o.push(i)}),o}static processRegularActor(e,t,s){const o=[];if(t.length>0)t.forEach(a=>{const i=this.createActorData(e,a,s);o.push(i)});else{const a=this.createActorData(e,null,s);o.push(a)}return o}static createActorData(e,t,s){const o=(t==null?void 0:t.actor)||e,a=ws.getActorHPData(o);return{id:e.id,uuid:e.uuid,name:t?t.name:e.name,img:e.img,selected:s.selectedActors.has((t==null?void 0:t.id)||e.id),crlngnStats:ws.getActorStats(o),hpPercent:a.hpPercent,hpColor:a.hpColor,tokenId:(t==null?void 0:t.id)||null,isToken:!!t,uniqueId:(t==null?void 0:t.id)||e.id,movementRestricted:t?Fe.isMovementRestricted(t):!1}}static async processGroupActor(e,t,s){var f,g,m;if(he.isBlocked(e))return[];const o=I(),a=v.get((f=o.showOnlyPCsWithToken)==null?void 0:f.tag),i=(t==null?void 0:t.tokens.filter(p=>p.actorId===e.id))||[],n=[],r=[];let l=!1;const d=s.actorFilters||{},u=d.inCombat||d.visible||d.removeDead;if(e.type==="group"){const S=(e.getFlag(k,"tokenAssociationsByScene")||{})[t==null?void 0:t.id]||{};for(const y of e.system.members||[])if(y.actor&&!he.isBlocked(y.actor)){const R=y.actor.id,A=S[R]||[];if(A.length>0){let _=!1;for(const T of A)try{const b=fromUuidSync(T);if(b&&b.actorId===y.actor.id&&b.parent===t){if(u){const w=b.actor||y.actor;if(!ie.doesActorPassFilters(w,d,b))continue}l=!0,_=!0;const C=this.createActorData(y.actor,b,s);r.push(C)}}catch{}if(!_&&!a){if(u&&!ie.doesActorPassFilters(y.actor,d,null))continue;const T=this.createActorData(y.actor,null,s);r.push(T)}}else{const _=(t==null?void 0:t.tokens.filter(T=>T.actorId===y.actor.id))||[];if(_.length>0)l=!0,_.forEach(T=>{if(u){const C=T.actor||y.actor;if(!ie.doesActorPassFilters(C,d,T))return}const b=this.createActorData(y.actor,T,s);r.push(b)});else if(!a){if(u&&!ie.doesActorPassFilters(y.actor,d,null))continue;const T=this.createActorData(y.actor,null,s);r.push(T)}}}}else if(e.type==="encounter"){const S=(e.getFlag(k,"tokenAssociationsByScene")||{})[t==null?void 0:t.id]||{};for(const y of e.system.members||[])try{const R=await fromUuid(y.uuid);if(R&&!he.isBlocked(R)){const A=R.id,_=S[A]||[];if(_.length>0)for(const T of _)try{const b=fromUuidSync(T);if(b&&b.actorId===R.id&&b.parent===t){if(u){const w=b.actor||R;if(!ie.doesActorPassFilters(w,d,b))continue}l=!0;const C=this.createActorData(R,b,s);C.quantity=1,r.push(C)}}catch{}else{const T=(t==null?void 0:t.tokens.filter(b=>b.actorId===R.id))||[];if(T.length>0)l=!0,T.forEach(b=>{if(u){const w=b.actor||R;if(!ie.doesActorPassFilters(w,d,b))return}const C=this.createActorData(R,b,s);C.quantity=1,r.push(C)});else if(!a){if(u&&!ie.doesActorPassFilters(R,d,null))continue;const b=this.createActorData(R,null,s);b.quantity=y.quantity||1,r.push(b)}}}}catch(R){c.log(`Failed to resolve member UUID: ${y.uuid}`,[R])}}if(a&&!(i.length>0)&&!l)return[];if(r.length===0&&!a){let p=[];e.type==="group"?p=(e.system.members||[]).map(R=>R.actor).filter(R=>R):e.type==="encounter"&&(p=(await Promise.all((e.system.members||[]).map(async A=>{try{return await fromUuid(A.uuid)}catch{return null}}))).filter(A=>A));const S=p.map(R=>he.isBlocked(R)||u&&!ie.doesActorPassFilters(R,d,null)?null:this.createActorData(R,null,s)).filter(R=>R!==null),y=this.createActorData(e,null,s);return y.members=S,y.isGroup=!0,y.isExpanded=((g=s.groupExpansionStates)==null?void 0:g[e.id])??!1,y.memberImages=S.slice(0,4).map(R=>R.img),y.selected=!1,n.push(y),n}if(r.length===0)return[];if(i.length>0)i.forEach(p=>{var R;const S=this.createActorData(e,p,s);S.members=r,S.isGroup=!0,S.isExpanded=((R=s.groupExpansionStates)==null?void 0:R[e.id])??!1,S.memberImages=r.slice(0,4).map(A=>A.img);const y=r.filter(A=>s.selectedActors.has(A.uniqueId));y.length===0?S.selected="false":y.length===r.length?S.selected="true":S.selected="partial",n.push(S)});else{const p=this.createActorData(e,null,s);p.members=r,p.isGroup=!0,p.isExpanded=((m=s.groupExpansionStates)==null?void 0:m[e.id])??!1,p.memberImages=r.slice(0,4).map(y=>y.img);const S=r.filter(y=>s.selectedActors.has(y.uniqueId));S.length===0?p.selected="false":S.length===r.length?p.selected="true":p.selected="partial",n.push(p)}return n}static buildRequestTypes(e){const t=[];for(const[s,o]of Object.entries(V.ROLL_REQUEST_OPTIONS)){const a={id:s,name:game.i18n.localize(`FLASH_ROLLS.rollTypes.${o.name}`)||o.label,rollable:o.subList==null,hasSubList:!!o.subList,selected:e.selectedRequestType===s,expanded:e.accordionStates[s]??!1,subItems:[]};o.subList&&(a.subItems=ks(s,e.selectedActors)),t.push(a)}return t}}const es="https://proxy.carolingian.io",Is=3e4,Wo=6e4,ts=`${k}.sessionToken`,H=class H{static getInstance(){return H._instance||(H._instance=new H),H._instance}static async initialize(){if(!game.user.isGM){c.log("PatronSessionManager: Skipping initialization for non-GM user");return}c.log("Initializing PatronSessionManager"),H._loadSessionToken();const e=H.getInstance();await e.validateSession(),e.startHeartbeat()}static _loadSessionToken(){try{H._sessionToken=localStorage.getItem(ts),H._sessionToken&&c.log("Session token loaded from storage")}catch(e){c.warn("Failed to load session token:",[e])}}static setSessionToken(e){H._sessionToken=e;try{e?localStorage.setItem(ts,e):localStorage.removeItem(ts)}catch(t){c.warn("Failed to save session token:",[t])}}static getSessionToken(){return H._sessionToken}static _getAuthHeaders(){const e={Accept:"application/json"};return H._sessionToken&&(e.Authorization=`Bearer ${H._sessionToken}`),e}static shutdown(){c.log("Shutting down PatronSessionManager"),H.getInstance().stopHeartbeat()}static getStatus(){return{...H._patronStatus}}static isPatron(){return H._patronStatus.isPatron}static isDDBConnected(){return H._patronStatus.ddbConnected}static setDDBConnected(e){H._patronStatus.ddbConnected!==e&&(H._patronStatus.ddbConnected=e,Hooks.callAll(`${k}.patronStatusChanged`,H.getStatus()))}async validateSession(e=!1){const t=Date.now();return!e&&t-H._patronStatus.lastValidated<Wo?H.getStatus():(H._validating&&H._validationPromise||(H._validating=!0,H._validationPromise=(async()=>{try{const s=await fetch(`${es}/api/validate`,{method:"GET",credentials:"include",headers:H._getAuthHeaders()});if(!s.ok)throw new Error(`Validation failed: ${s.status}`);const o=await s.json(),a={...H._patronStatus};return H._patronStatus={isPatron:o.isPatron||!1,tier:o.tier||0,name:o.name||null,ddbConnected:o.ddbConnected||!1,lastValidated:t},(a.isPatron!==H._patronStatus.isPatron||a.ddbConnected!==H._patronStatus.ddbConnected)&&(c.log("Patron status changed:",[H._patronStatus]),Hooks.callAll(`${k}.patronStatusChanged`,H.getStatus())),H.getStatus()}catch(s){c.error("Session validation error:",[s]);const o={...H._patronStatus};return H._patronStatus={isPatron:!1,tier:0,name:null,ddbConnected:!1,lastValidated:t},o.isPatron&&Hooks.callAll(`${k}.patronStatusChanged`,H.getStatus()),H.getStatus()}finally{H._validating=!1,H._validationPromise=null}})()),H._validationPromise)}async sendHeartbeat(){try{const e=H._getAuthHeaders();e["Content-Type"]="application/json";const t=await fetch(`${es}/api/heartbeat`,{method:"POST",credentials:"include",headers:e,body:JSON.stringify({ddbConnected:H._patronStatus.ddbConnected})});if(!t.ok){c.warn("Heartbeat failed:",[t.status]);return}const s=await t.json();if(!s.valid){c.warn("Session invalidated:",[s.reason]),await this.validateSession(!0);return}const o={...H._patronStatus};H._patronStatus={isPatron:s.isPatron||!1,tier:s.tier||0,name:s.name||null,ddbConnected:s.ddbConnected||!1,lastValidated:Date.now()},(o.isPatron!==H._patronStatus.isPatron||o.ddbConnected!==H._patronStatus.ddbConnected)&&Hooks.callAll(`${k}.patronStatusChanged`,H.getStatus())}catch(e){c.error("Heartbeat error:",[e])}}startHeartbeat(){H._heartbeatInterval||(c.log("Starting heartbeat",[Is+"ms interval"]),H._heartbeatInterval=setInterval(()=>{this.sendHeartbeat()},Is))}stopHeartbeat(){H._heartbeatInterval&&(clearInterval(H._heartbeatInterval),H._heartbeatInterval=null,c.log("Heartbeat stopped"))}static async logout(){try{const e=await fetch(`${es}/auth/logout`,{method:"POST",credentials:"include",headers:H._getAuthHeaders()});H.setSessionToken(null),H._patronStatus={isPatron:!1,tier:0,name:null,ddbConnected:!1,lastValidated:Date.now()},Hooks.callAll(`${k}.patronStatusChanged`,H.getStatus()),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.loggedOut"))}catch(e){c.error("Logout error:",[e]),H.setSessionToken(null),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.logoutFailed"))}}};E(H,"_instance",null),E(H,"_patronStatus",{isPatron:!1,tier:0,name:null,ddbConnected:!1,lastValidated:0}),E(H,"_heartbeatInterval",null),E(H,"_validating",!1),E(H,"_validationPromise",null),E(H,"_sessionToken",null);let J=H;const Es="https://proxy.carolingian.io";class ye{static setRollEventHandler(e){this._onRollEvent=e}static getConfig(){var i,n,r;const e=I(),t=((i=v.get(e.ddbCampaignId.tag))==null?void 0:i.trim())||"",s=((n=v.get(e.ddbUserId.tag))==null?void 0:n.trim())||"",o=((r=v.get(e.ddbCobaltCookie.tag))==null?void 0:r.trim())||"",a=J.getSessionToken();return{campaignId:t,userId:s,cobaltCookie:o,sessionToken:a,isValid:!!(a&&t&&s&&o)}}static async connect(){if(this._isConnecting||this._eventSource){c.log("DnDBConnection: Already connected or connecting");return}const e=this.getConfig();if(!e.isValid){c.warn("DnDBConnection: Cannot connect - invalid configuration");return}this._isConnecting=!0,this._notifyStatusChange();try{const t=J.getSessionToken(),s={"Content-Type":"application/json"};t&&(s.Authorization=`Bearer ${t}`);const o=await fetch(`${Es}/ddb/connect`,{method:"POST",credentials:"include",headers:s,body:JSON.stringify({gameId:e.campaignId,userId:e.userId,cobaltCookie:e.cobaltCookie})});if(!o.ok){const i=await o.json().catch(()=>({}));throw new Error(i.error||`HTTP ${o.status}`)}const a=await o.json();this._sessionId=a.sessionId,c.log("DnDBConnection: Connection established",[this._sessionId]),this._establishEventStream(),this._reconnectAttempts=0,this._notifyStatusChange()}catch(t){c.log("DnDBConnection: Connection attempt failed",[t.message]),this._scheduleReconnect()}finally{this._isConnecting=!1,this._notifyStatusChange()}}static _establishEventStream(){if(!this._sessionId){c.warn("DnDBConnection: No session ID for event stream");return}const e=J.getSessionToken(),t=`${Es}/ddb/events/${this._sessionId}?token=${encodeURIComponent(e||"")}`;this._eventSource=new EventSource(t,{withCredentials:!1}),this._eventSource.onopen=()=>{c.log("DnDBConnection: Event stream opened"),J.setDDBConnected(!0)},this._eventSource.onmessage=s=>{this._handleEvent(s)},this._eventSource.onerror=s=>{c.error("DnDBConnection: Event stream error",[s]),this._handleDisconnect()}}static _handleEvent(e){const t=e.data;if(!(t==="pong"||t==="ping"))try{const s=JSON.parse(t);s.eventType==="dice/roll/fulfilled"&&(c.log("DnDBConnection: Roll received",[`messageScope=${s.messageScope}`,`messageTarget=${s.messageTarget}`,`userId=${s.userId}`,s]),this._onRollEvent&&this._onRollEvent(s))}catch(s){c.error("DnDBConnection: Error parsing event",[s,t])}}static _handleDisconnect(){this.disconnect(),this._scheduleReconnect()}static async _scheduleReconnect(){if(this._reconnectTimer&&clearTimeout(this._reconnectTimer),this._reconnectAttempts>=this._maxReconnectAttempts){c.warn("DnDBConnection: Max reconnect attempts reached"),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.ddbConnectionFailed")),J.setDDBConnected(!1);return}if(!J.getStatus().isPatron){c.warn("DnDBConnection: Not a patron - stopping reconnection attempts"),J.setDDBConnected(!1);return}if(!J.getSessionToken()){c.warn("DnDBConnection: No session token - stopping reconnection attempts"),J.setDDBConnected(!1);return}this._reconnectAttempts++;const s=this._reconnectDelay*this._reconnectAttempts;c.log("DnDBConnection: Scheduling reconnect",[this._reconnectAttempts,s]),this._reconnectTimer=setTimeout(()=>{this.connect()},s)}static disconnect(){this._eventSource&&(this._eventSource.close(),this._eventSource=null),this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null),this._sessionId=null,this._isConnecting=!1,c.log("DnDBConnection: Disconnected"),this._notifyStatusChange()}static isConnected(){var e;return((e=this._eventSource)==null?void 0:e.readyState)===EventSource.OPEN}static getStatus(){return this._isConnecting?"connecting":this.isConnected()?"connected":"disconnected"}static async reconnect(){this.disconnect(),this._reconnectAttempts=0,await this.connect()}static _notifyStatusChange(){const e=mt.getInstance();e&&e.updateConnectionStatus(this.getStatus())}}E(ye,"_eventSource",null),E(ye,"_sessionId",null),E(ye,"_isConnecting",!1),E(ye,"_reconnectAttempts",0),E(ye,"_maxReconnectAttempts",5),E(ye,"_reconnectDelay",5e3),E(ye,"_reconnectTimer",null),E(ye,"_onRollEvent",null);const Os={EXECUTE_DDB_ROLL:"executeDnDBRoll"};class Ke{static async initialize(){if(re.registerHooks(),this._registerSocketHandlers(),!game.user.isGM)return;if(!(await J.getInstance().validateSession()).isPatron){c.log("DnDBeyondIntegration: Not a patron - skipping auto-connect");return}const t=ye.getConfig();if(!t.isValid){c.log("DnDBeyondIntegration: Missing DnDB credentials - skipping auto-connect");return}c.log("DnDBeyondIntegration: Initializing with config",[t]),ye.setRollEventHandler(s=>this._onRollEvent(s)),await ye.connect()}static _registerSocketHandlers(){var e;c.log("DnDBeyondIntegration._registerSocketHandlers - Attempting registration",["hasSocket:",!!me.socket,"isGM:",(e=game.user)==null?void 0:e.isGM]),me.registerCall(Os.EXECUTE_DDB_ROLL,this._handleSocketRollExecution.bind(this)),c.log("DnDBeyondIntegration: Registered socket handlers")}static async _handleSocketRollExecution(e){const{actorId:t,rollInfo:s,category:o}=e;c.log("DnDBeyondIntegration._handleSocketRollExecution - Received roll request",["actorId:",t,"action:",s.action,"rollType:",s.rollType,"category:",o.category,"isGM:",game.user.isGM]);const a=game.actors.get(t);return a?await _e.execute(a,s,o):(c.warn("DnDBeyondIntegration._handleSocketRollExecution - Actor not found",[t]),!1)}static async _onRollEvent(e){var t,s,o,a,i,n,r;c.log("=== DnDB ROLL EVENT ==="),c.log("Action:",[(t=e.data)==null?void 0:t.action]),c.log("Roll Type:",[(a=(o=(s=e.data)==null?void 0:s.rolls)==null?void 0:o[0])==null?void 0:a.rollType]),c.log("Roll Kind:",[(r=(n=(i=e.data)==null?void 0:i.rolls)==null?void 0:n[0])==null?void 0:r.rollKind]),c.log("Visibility:",[`messageScope=${e.messageScope}`,`messageTarget=${e.messageTarget}`,`userId=${e.userId}`]),c.log("======================"),await this._processRollEvent(e)}static async _processRollEvent(e){const t=e.entityId,s=e.entityType,o=this._getActorForCharacter(t,s),a=Ge.extractRollInfo(e),i=Ge.determineRollCategory(a.action,a.rollType,o);if(c.log("DnDBeyondIntegration: Processing roll",[a.action,a.rollType,i.category,o==null?void 0:o.name]),o){const n=Le(o),r=this._shouldPlayerExecute(n);if(c.log("DnDBeyondIntegration: shouldPlayerExecute",[r]),r){if(c.log("DnDBeyondIntegration: Sending roll to player",["category:",i.category]),await this._sendRollToPlayer(o,a,i,n))return;c.log("DnDBeyondIntegration: Player execution failed, falling back to GM")}if(await _e.execute(o,a,i))return}await this._createFallbackMessage(a)}static _shouldPlayerExecute(e){const t=I(),s=v.get(t.ddbRollOwnership.tag)??0;return c.log("DnDBeyondIntegration._shouldPlayerExecute",["playerOwner:",e==null?void 0:e.name,"playerActive:",e==null?void 0:e.active,"rollOwnership setting:",s,"result:",s===1&&!!e&&e.active]),!e||!e.active?!1:s===1}static async _sendRollToPlayer(e,t,s,o){try{const a={actorId:e.id,rollInfo:t,category:s},i=await me.execForUser(Os.EXECUTE_DDB_ROLL,o.id,a);return c.log("DnDBeyondIntegration._sendRollToPlayer - Result",[i]),i===!0}catch(a){return c.error("DnDBeyondIntegration._sendRollToPlayer - Failed",[a]),!1}}static async _createFallbackMessage(e){await _e.createSimpleRollMessage(e)}static _getActorForCharacter(e,t="character"){const s=String(e),o=I(),i=(v.get(o.ddbCharacterMappings.tag)||{})[s];if(i){const r=game.actors.get(i);if(r)return r;c.warn("DnDBeyondIntegration: Mapped actor not found",[i])}if(t==="monster"){const r=game.actors.find(l=>{var u,f;const d=(f=(u=l.flags)==null?void 0:u.ddbimporter)==null?void 0:f.id;return d&&String(d)===s});if(r)return c.log("DnDBeyondIntegration: Found monster actor via ddbimporter.id",[r.name]),r}const n=game.actors.find(r=>{var d,u;const l=(u=(d=r.flags)==null?void 0:d.ddbimporter)==null?void 0:u.dndbeyond;return l?!!(l.characterId&&String(l.characterId)===s||l.url&&l.url.includes(`/characters/${s}`)):!1});return n?(c.log("DnDBeyondIntegration: Found actor via ddbimporter flag",[n.name]),n):(c.log("DnDBeyondIntegration: No actor found for entity",[s,t]),null)}static async connect(){ye.setRollEventHandler(e=>this._onRollEvent(e)),await ye.connect()}static disconnect(){ye.disconnect()}static async reconnect(){ye.setRollEventHandler(e=>this._onRollEvent(e)),await ye.reconnect()}static isConnected(){return ye.isConnected()}static getStatus(){return ye.getStatus()}static async mapCharacter(e,t){const s=String(e),o=I(),a=v.get(o.ddbCharacterMappings.tag)||{};a[s]=t,await v.set(o.ddbCharacterMappings.tag,a),c.log("DnDBeyondIntegration: Character mapped",[s,t])}static async unmapCharacter(e){const t=String(e),s=I(),o=v.get(s.ddbCharacterMappings.tag)||{};delete o[t],await v.set(s.ddbCharacterMappings.tag,o),c.log("DnDBeyondIntegration: Character unmapped",[t])}static getMappings(){const e=I();return v.get(e.ddbCharacterMappings.tag)||{}}}function Ko(){return window.FLASH5E_DEV_PROXY||"https://proxy.carolingian.io"}class Ms{static async fetchCharacter(e){if(!e)return c.warn("DnDBCharacterFetcher: No character ID provided"),null;const t=this._getConfig();if(!t.isValid)return c.warn("DnDBCharacterFetcher: Invalid configuration"),null;try{const s={"Content-Type":"application/json"};t.sessionToken&&(s.Authorization=`Bearer ${t.sessionToken}`),t.cobaltCookie&&(s["X-Cobalt-Cookie"]=t.cobaltCookie);const o=await fetch(`${Ko()}/ddb/character/${e}`,{method:"GET",credentials:"include",headers:s});if(!o.ok){const i=await o.json().catch(()=>({}));throw new Error(i.error||`HTTP ${o.status}`)}const a=await o.json();return c.log("DnDBCharacterFetcher: Character data fetched",[e,a.name]),c.log("DnDBCharacterFetcher: Full character data",[JSON.stringify(a,null,2),a]),a}catch(s){return c.error("DnDBCharacterFetcher: Failed to fetch character",[e,s.message]),null}}static async fetchCharacters(e){const t=new Map,s=e.map(async o=>{const a=await this.fetchCharacter(o);a&&t.set(String(o),a)});return await Promise.all(s),t}static _getConfig(){var o;const e=I(),t=((o=v.get(e.ddbCobaltCookie.tag))==null?void 0:o.trim())||"",s=J.getSessionToken();return{cobaltCookie:t,sessionToken:s,isValid:!!(s&&t)}}}const Yo={1:"str",2:"dex",3:"con",4:"int",5:"wis",6:"cha"};class Be{static transformToActor(e,t){var u,f,g,m,p,S,y;const s=this._transformAbilities(e);this._calculateTotalLevel(e);const o=this._transformHP(e),a=this._transformCurrency(e),i=this._transformSkills(e),n=this._transformMovement(e),r=this._transformSenses(e),l=this._transformTraits(e),d=this.transformTools(e);return{name:e.name,type:"character",img:this._getAvatarUrl(e),system:{abilities:s,skills:i,tools:d,attributes:{hp:o,death:{success:((u=e.deathSaves)==null?void 0:u.successCount)||0,failure:((f=e.deathSaves)==null?void 0:f.failCount)||0},inspiration:e.inspiration||!1,movement:n,senses:r},traits:l,details:{xp:{value:e.currentXp||0},appearance:((g=e.traits)==null?void 0:g.appearance)||"",trait:((m=e.traits)==null?void 0:m.personalityTraits)||"",ideal:((p=e.traits)==null?void 0:p.ideals)||"",bond:((S=e.traits)==null?void 0:S.bonds)||"",flaw:((y=e.traits)==null?void 0:y.flaws)||""},currency:a},flags:{"flash-rolls-5e":{ddbCharacterId:e.id,importTier:t.tier,importDate:Date.now(),unmatchedItems:t.unmatched.map(R=>R.name)},ddbimporter:{dndbeyond:{characterId:e.id,url:`https://www.dndbeyond.com/characters/${e.id}`}}}}}static _transformAbilities(e){var i,n;const t={},s=this._getAllModifiers(e),o={"strength-saving-throws":"str","dexterity-saving-throws":"dex","constitution-saving-throws":"con","intelligence-saving-throws":"int","wisdom-saving-throws":"wis","charisma-saving-throws":"cha"},a=new Set;for(const r of s)r.type==="proficiency"&&o[r.subType]&&a.add(o[r.subType]);c.log("DnDBCharacterTransformer: Processing abilities",[`stats: ${JSON.stringify((i=e.stats)==null?void 0:i.slice(0,2))}...`,`bonusStats: ${JSON.stringify((n=e.bonusStats)==null?void 0:n.slice(0,2))}...`,`saveProficiencies: ${Array.from(a).join(", ")}`]);for(const[r,l]of Object.entries(Yo)){const d=Number(r),u=this._getStatValue(e.stats,d),f=this._getStatValue(e.bonusStats,d),g=this._getStatValue(e.overrideStats,d,!0),m=g!==null?g:u+f;t[l]={value:m,proficient:a.has(l)?1:0},m===0&&c.warn("DnDBCharacterTransformer: Ability is 0",[l,`base=${u}`,`bonus=${f}`,`override=${g}`])}return t}static _getStatValue(e,t,s=!1){if(!Array.isArray(e))return s?null:0;const o=e.find(a=>a.id===t);return!o||o.value===null||o.value===void 0?s?null:0:o.value}static _calculateTotalLevel(e){return Array.isArray(e.classes)&&e.classes.reduce((t,s)=>t+(s.level||0),0)||1}static _transformHP(e){const t=e.baseHitPoints||0,s=e.bonusHitPoints||0,o=e.overrideHitPoints,a=e.temporaryHitPoints||0,i=e.removedHitPoints||0,n=o??t+s;return{value:Math.max(0,n-i),max:n,temp:a}}static _transformCurrency(e){const t=e.currencies||{};return{cp:t.cp||0,sp:t.sp||0,ep:t.ep||0,gp:t.gp||0,pp:t.pp||0}}static _getAvatarUrl(e){var t;return e.avatarUrl?e.avatarUrl:(t=e.decorations)!=null&&t.avatarUrl?e.decorations.avatarUrl:"icons/svg/mystery-man.svg"}static applyItemState(e,t){var s;if(e.system.equipped!==void 0&&t.equipped!==void 0&&(e.system.equipped=t.equipped),e.system.attunement!==void 0&&t.isAttuned&&(e.system.attuned=!0),e.system.quantity!==void 0&&(e.system.quantity=t.quantity||1),e.type==="spell"){const o=((s=t.definition)==null?void 0:s.level)===0;t.alwaysPrepared?e.system.prepared=2:t.prepared||o?e.system.prepared=1:e.system.prepared=0}if(e.type==="class"){const o=t._classLevel||1;e.system||(e.system={}),e.system.levels=o,e.system.hd||(e.system.hd={}),e.system.hd.spent=0}}static getClassInfo(e){return Array.isArray(e.classes)?e.classes.map(t=>{var s,o;return{name:((s=t.definition)==null?void 0:s.name)||"Unknown",level:t.level||1,subclass:((o=t.subclassDefinition)==null?void 0:o.name)||null,isStartingClass:t.isStartingClass||!1}}):[]}static getRaceName(e){var t,s;return(t=e.race)!=null&&t.fullName?e.race.fullName:(s=e.race)!=null&&s.baseName?e.race.baseName:null}static getBackgroundName(e){var t,s;return((s=(t=e.background)==null?void 0:t.definition)==null?void 0:s.name)||null}static _getAllModifiers(e){const t=e.modifiers||{},s=[];for(const o of["race","class","background","feat","item"])Array.isArray(t[o])&&s.push(...t[o]);return s}static _transformSkills(e){const t={},s=this._getAllModifiers(e),o={acrobatics:"acr","animal-handling":"ani",arcana:"arc",athletics:"ath",deception:"dec",history:"his",insight:"ins",intimidation:"itm",investigation:"inv",medicine:"med",nature:"nat",perception:"prc",performance:"prf",persuasion:"per",religion:"rel","sleight-of-hand":"slt",stealth:"ste",survival:"sur"};for(const[a,i]of Object.entries(o)){const n=s.find(l=>l.type==="proficiency"&&l.subType===a&&(l.isGranted===!0||l.isGranted===!1));s.find(l=>l.type==="expertise"&&l.subType===a)?t[i]={value:2}:n&&(t[i]={value:1})}return c.log("DnDBCharacterTransformer: Skills transformed",[Object.keys(t).length,Object.entries(t).map(([a,i])=>`${a}:${i.value}`).join(", ")]),t}static _transformMovement(e){const t=this._getAllModifiers(e),s={walk:30,burrow:0,climb:0,fly:0,swim:0,units:"ft",hover:!1},o={"innate-speed-walking":"walk","innate-speed-swimming":"swim","innate-speed-flying":"fly","innate-speed-climbing":"climb","innate-speed-burrowing":"burrow","speed-walking":"walk","speed-swimming":"swim","speed-flying":"fly","speed-climbing":"climb"};for(const a of t)if(a.type==="set"&&o[a.subType]){const i=o[a.subType],n=a.value||a.fixedValue||0;n>s[i]&&(s[i]=n)}return c.log("DnDBCharacterTransformer: Movement",[`walk: ${s.walk}`,`fly: ${s.fly}`,`swim: ${s.swim}`]),s}static _transformSenses(e){const t=this._getAllModifiers(e),s={darkvision:0,blindsight:0,tremorsense:0,truesight:0,units:"ft",special:""};for(const o of t)if(o.type==="set-base"||o.type==="sense"){const a=o.value||o.fixedValue||0;o.subType==="darkvision"&&a>s.darkvision?s.darkvision=a:o.subType==="blindsight"&&a>s.blindsight?s.blindsight=a:o.subType==="tremorsense"&&a>s.tremorsense?s.tremorsense=a:o.subType==="truesight"&&a>s.truesight&&(s.truesight=a)}return c.log("DnDBCharacterTransformer: Senses",[`darkvision: ${s.darkvision}`]),s}static _transformTraits(e){var i,n,r;const t=this._getAllModifiers(e),s=new Set,o=new Set,a=new Set;for(const l of t)if(l.type==="language"){const d=(i=l.subType)==null?void 0:i.replace(/-/g," ");d&&s.add(d)}else l.type==="proficiency"&&((n=l.subType)!=null&&n.includes("armor")||l.subType==="shields"?a.add(l.subType.replace(/-/g," ")):(r=l.subType)!=null&&r.includes("weapons")&&o.add(l.subType.replace(/-/g," ")));return c.log("DnDBCharacterTransformer: Traits",[`languages: ${Array.from(s).join(", ")}`,`armor: ${Array.from(a).join(", ")}`,`weapons: ${Array.from(o).join(", ")}`]),{languages:{value:Array.from(s)},weaponProf:{value:Array.from(o)},armorProf:{value:Array.from(a)}}}static getSpellSlots(e){var u,f;const t={spellSlots:{},pactSlots:null},s=e.spellSlots||[],o=e.pactMagic||[],a=e.classes||[],i={};for(const g of s)g.level>=1&&g.level<=9&&(i[g.level]=g.used||0);let n=0;const r=[];for(const g of a){const m=g.level||1,p=(u=g.definition)==null?void 0:u.spellRules,S=p==null?void 0:p.multiClassSpellSlotDivisor;if(S&&S>0&&(p!=null&&p.levelSpellSlots)){const y=Math.floor(m/S);n+=y,r.push({name:(f=g.definition)==null?void 0:f.name,level:m,divisor:S,contribution:y})}}if(r.length>0&&c.log("DnDBCharacterTransformer: Caster level calculation",[r.map(g=>`${g.name} ${g.level}/${g.divisor}=${g.contribution}`).join(", "),`Effective level: ${n}`]),n>0){const g=Math.min(n,20)-1,m=this.MULTICLASS_SPELL_SLOTS[g];for(let p=0;p<m.length;p++){const S=p+1,y=m[p];if(y>0){const R=i[S]||0,A=Math.max(0,y-R);t.spellSlots[S]={max:y,value:A,used:R}}}}const l=o.find(g=>g.level>0);if(l){const g=l.available||0,m=l.used||0;t.pactSlots={max:g,value:Math.max(0,g-m),used:m,level:l.level}}const d=Object.entries(t.spellSlots).map(([g,m])=>`spell${g}: ${m.value}/${m.max}`);return t.pactSlots&&d.push(`pact: ${t.pactSlots.value}/${t.pactSlots.max}`),d.length>0&&c.log("DnDBCharacterTransformer: Spell slots calculated",d),t}static async applySpellSlots(e,t){const s={};for(const[o,a]of Object.entries(t.spellSlots)){const i=`spell${o}`;s[`system.spells.${i}.value`]=a.value,s[`system.spells.${i}.override`]=a.max}return t.pactSlots&&(s["system.spells.pact.value"]=t.pactSlots.value,s["system.spells.pact.override"]=t.pactSlots.max,s["system.spells.pact.level"]=t.pactSlots.level),Object.keys(s).length>0&&(await e.update(s),c.log("DnDBCharacterTransformer: Applied spell slots",[Object.entries(s).map(([o,a])=>`${o}: ${a}`).join(", ")])),s}static getToolProficiencies(e){const t=this._getAllModifiers(e),s=[],o=new Set(["alchemists-supplies","brewers-supplies","calligraphers-supplies","carpenters-tools","cartographers-tools","cobblers-tools","cooks-utensils","glassblowers-tools","jewelers-tools","leatherworkers-tools","masons-tools","painters-supplies","potters-tools","smiths-tools","tinkers-tools","weavers-tools","woodcarvers-tools","disguise-kit","forgery-kit","herbalism-kit","navigators-tools","poisoners-kit","thieves-tools","bagpipes","drum","dulcimer","flute","horn","lute","lyre","pan-flute","shawm","viol","dice-set","dragonchess-set","playing-card-set","three-dragon-ante-set"]);for(const a of t)if(a.type==="proficiency"&&o.has(a.subType)){const i=a.friendlySubtypeName||a.subType.replace(/-/g," ");s.push({name:i,subType:a.subType,type:"tool"})}return s.length>0&&c.log("DnDBCharacterTransformer: Tool proficiencies",[s.map(a=>a.name).join(", ")]),s}static _buildToolNameToKeyMap(){var s;const e={},t=((s=CONFIG.DND5E)==null?void 0:s.tools)||{};for(const[o,a]of Object.entries(t)){const i=a.id;if(i){const n=dnd5e.documents.Trait.getBaseItem(i,{indexOnly:!0});n!=null&&n.name&&(e[n.name.toLowerCase()]=o)}}return c.log("DnDBCharacterTransformer: Built tool name map",[Object.keys(e).length+" tools mapped"]),e}static _extractToolChoices(e){const t=[],s=e.choices||{},o=s.choiceDefinitions||[],a={};for(const n of o)if(n.options)for(const r of n.options)a[r.id]=r.label;const i=n=>{var r;if(Array.isArray(n))for(const l of n){const d=((r=l.label)==null?void 0:r.toLowerCase())||"";(d.includes("tool")||d.includes("gaming")||d.includes("instrument"))&&l.optionValue&&a[l.optionValue]&&t.push(a[l.optionValue])}};return i(s.background),i(s.class),i(s.race),i(s.feat),t.length>0&&c.log("DnDBCharacterTransformer: Found tool choices",t),t}static transformTools(e){const t={},s=this._buildToolNameToKeyMap(),o=this.getToolProficiencies(e),a=this._extractToolChoices(e);for(const i of o){const n=i.name.toLowerCase(),r=s[n];r&&!t[r]&&(t[r]={value:1})}for(const i of a){const n=i.toLowerCase(),r=s[n];r&&!t[r]&&(t[r]={value:1})}return Object.keys(t).length>0&&c.log("DnDBCharacterTransformer: Tools transformed",[Object.keys(t).join(", ")]),t}}E(Be,"MULTICLASS_SPELL_SLOTS",[[2,0,0,0,0,0,0,0,0],[3,0,0,0,0,0,0,0,0],[4,2,0,0,0,0,0,0,0],[4,3,0,0,0,0,0,0,0],[4,3,2,0,0,0,0,0,0],[4,3,3,0,0,0,0,0,0],[4,3,3,1,0,0,0,0,0],[4,3,3,2,0,0,0,0,0],[4,3,3,3,1,0,0,0,0],[4,3,3,3,2,0,0,0,0],[4,3,3,3,2,1,0,0,0],[4,3,3,3,2,1,0,0,0],[4,3,3,3,2,1,1,0,0],[4,3,3,3,2,1,1,0,0],[4,3,3,3,2,1,1,1,0],[4,3,3,3,2,1,1,1,0],[4,3,3,3,2,1,1,1,1],[4,3,3,3,3,1,1,1,1],[4,3,3,3,3,2,1,1,1],[4,3,3,3,3,2,2,1,1]]);const Fs=[{id:100,order:8,label:"Unearthed Arcana",subLabel:"",slug:"ua",relativePath:"sources/dnd/ua",imageUrl:"https://www.dndbeyond.com/avatars/29461/179/638010276214549263.jpeg",type:1,releaseDate:"2022-08-18T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1,prioritize:!1},{id:148,order:9,label:"D&D Beyond Basic Rules",subLabel:"",slug:"br-2024",relativePath:"sources/dnd/br-2024",imageUrl:"https://www.dndbeyond.com/avatars/43764/971/638599907624251366.jpeg",type:1,releaseDate:"2024-09-03T13:12:00Z",isReleased:!0,isFree:!0,isThirdParty:!1},{id:145,order:10,label:"Players Handbook",subLabel:"",slug:"phb-2024",relativePath:"sources/dnd/phb-2024",imageUrl:"https://www.dndbeyond.com/avatars/41956/71/638520961161219818.jpeg",type:1,releaseDate:"2024-09-17T13:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1,prioritize:!0},{id:146,order:11,label:"Dungeon Masters Guide",subLabel:"",slug:"dmg-2024",relativePath:"sources/dnd/dmg-2024",imageUrl:"https://www.dndbeyond.com/avatars/41956/44/638520960647339792.jpeg",type:1,releaseDate:"2024-10-29T14:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1,prioritize:!0},{id:147,order:12,label:"Monster Manual",subLabel:"",slug:"mm-2024",relativePath:"sources/dnd/mm-2024",imageUrl:"https://www.dndbeyond.com/avatars/41956/56/638520960908919838.jpeg",type:1,releaseDate:"2025-02-04T13:45:00Z",isReleased:!0,isFree:!1,isThirdParty:!1,prioritize:!0},{id:166,order:13,label:"Sage Advice & Errata",subLabel:"",slug:"sae",relativePath:"sources/dnd/sae",imageUrl:"https://www.dndbeyond.com/avatars/48408/464/638794027038919813.jpeg",type:1,releaseDate:"2025-04-30T16:45:00Z",isReleased:!0,isFree:!0,isThirdParty:!1,prioritize:!1},{id:110,order:21,label:"Bigby Presents: Glory of the Giants",subLabel:"",slug:"gotg",relativePath:"sources/dnd/gotg",imageUrl:"https://www.dndbeyond.com/avatars/33889/812/638179362854797417.jpeg",type:1,releaseDate:"2023-08-01T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:191,order:22,label:"Eberron: Forge of the Artificer",subLabel:"",slug:"efota",relativePath:"sources/dnd/efota",imageUrl:"https://www.dndbeyond.com/avatars/52984/276/638995468447060854.jpeg",type:1,releaseDate:"2025-11-25T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:49,order:37,label:"Eberron: Rising from the Last War",subLabel:"",slug:"erftlw",relativePath:"sources/dnd/erftlw",imageUrl:"https://www.dndbeyond.com/avatars/7745/229/637093481879972578.jpeg",type:1,releaseDate:"2019-11-19T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:81,order:43,label:"Fizban's Treasury of Dragons",subLabel:"",slug:"ftod",relativePath:"sources/dnd/ftod",imageUrl:"https://www.dndbeyond.com/avatars/19075/984/637620380257973999.jpeg",type:1,releaseDate:"2021-10-26T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:205,order:44,label:"Forgotten Realms: Heroes of Faern",subLabel:"New!",slug:"frhof",relativePath:"sources/dnd/frhof",imageUrl:"https://www.dndbeyond.com/avatars/52402/286/638971147782879883.jpeg",type:1,releaseDate:"2025-10-28T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:85,order:57,label:"Mordenkainen Presents: Monsters of the Multiverse",subLabel:"",slug:"motm",relativePath:"sources/dnd/motm",imageUrl:"https://www.dndbeyond.com/avatars/22937/355/637776964750870725.jpeg",type:1,releaseDate:"2022-05-16T10:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:114,order:62,label:"Planescape: Adventures in the Multiverse",subLabel:"",slug:"paitm",relativePath:"sources/dnd/paitm",imageUrl:"https://www.dndbeyond.com/avatars/33644/786/638170881549586932.jpeg",type:1,releaseDate:"2023-10-03T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:90,order:63,label:"Spelljammer: Adventures in Space",subLabel:"",slug:"sais",relativePath:"sources/dnd/sais",imageUrl:"https://www.dndbeyond.com/avatars/25228/877/637859890825757803.jpeg",type:1,releaseDate:"2022-08-16T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:67,order:67,label:"Tashas Cauldron of Everything",subLabel:"",slug:"tcoe",relativePath:"sources/dnd/tcoe",imageUrl:"https://www.dndbeyond.com/avatars/13526/337/637394093261962736.jpeg",type:1,releaseDate:"2020-11-17T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:109,order:68,label:"The Book of Many Things",subLabel:"",slug:"tbomt",relativePath:"sources/dnd/tbomt",imageUrl:"https://www.dndbeyond.com/avatars/34541/96/638205353418103417.jpeg",type:1,releaseDate:"2023-10-31T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:27,order:78,label:"Xanathar's Guide to Everything",subLabel:"",slug:"xgte",relativePath:"sources/dnd/xgte",imageUrl:"https://www.dndbeyond.com/avatars/10346/306/637244369065271336.jpeg",type:1,releaseDate:"2017-11-15T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:217,order:1,label:"Astarion's Book of Hungers",subLabel:"",slug:"aboh",relativePath:"sources/dnd/aboh",imageUrl:"https://www.dndbeyond.com/avatars/52637/494/638981487854541579.jpeg",type:2,releaseDate:"2025-11-11T07:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:48,order:4,label:"Baldurs Gate: Descent into Avernus",subLabel:"",slug:"bgdia",relativePath:"sources/dnd/bgdia",imageUrl:"https://www.dndbeyond.com/avatars/7745/257/637093484650833588.jpeg",type:2,releaseDate:"2019-09-17T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:83,order:7,label:"Critical Role: Call of the Netherdeep",subLabel:"",slug:"cotn",relativePath:"sources/dnd/cotn",imageUrl:"https://www.dndbeyond.com/avatars/20906/944/637695655262762818.jpeg",type:2,releaseDate:"2022-03-15T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:6,order:8,label:"Curse of Strahd",subLabel:"",slug:"cos",relativePath:"sources/dnd/cos",imageUrl:"https://www.dndbeyond.com/avatars/10346/347/637244372481971363.jpeg",type:2,releaseDate:"2016-03-15T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:163,order:9,label:"Dragon Delves",subLabel:"",slug:"drde",relativePath:"sources/dnd/drde",imageUrl:"https://www.dndbeyond.com/avatars/49845/429/638857756428432417.jpeg",type:2,releaseDate:"2025-06-24T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:95,order:12,label:"Dragonlance: Shadow of the Dragon Queen",subLabel:"",slug:"sotdq",relativePath:"sources/dnd/sotdq",imageUrl:"https://www.dndbeyond.com/avatars/27777/667/637951679603767773.jpeg",type:2,releaseDate:"2022-11-22T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:222,order:18,label:"Fated Flight of the Recluse",subLabel:"",slug:"ffotr",relativePath:"sources/dnd/ffotr",imageUrl:"https://www.dndbeyond.com/avatars/53004/853/638996385600844893.jpeg",type:2,releaseDate:"2025-11-25T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:206,order:19,label:"Forgotten Realms: Adventures in Faern",subLabel:"New!",slug:"fraif",relativePath:"sources/dnd/fraif",imageUrl:"https://www.dndbeyond.com/avatars/52402/308/638971148265450077.jpeg",type:2,releaseDate:"2025-10-28T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:43,order:20,label:"Ghosts of Saltmarsh",subLabel:"",slug:"gos",relativePath:"sources/dnd/gos",imageUrl:"https://www.dndbeyond.com/avatars/10347/264/637244456880438089.jpeg",type:2,releaseDate:"2019-05-21T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:199,order:22,label:"Heroes of the Borderlands",subLabel:"",slug:"hotb",relativePath:"sources/dnd/hotb",imageUrl:"https://www.dndbeyond.com/avatars/51322/303/638924470224291152.jpeg",type:2,releaseDate:"2025-09-16T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:66,order:26,label:"Icewind Dale: Rime of the Frostmaiden",subLabel:"",slug:"idrotf",relativePath:"sources/dnd/idrotf",imageUrl:"https://www.dndbeyond.com/avatars/11095/612/637278970090981939.jpeg",type:2,releaseDate:"2020-09-15T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:87,order:28,label:"Journeys through the Radiant Citadel",subLabel:"",slug:"jttrc",relativePath:"sources/dnd/jttrc",imageUrl:"https://www.dndbeyond.com/avatars/24454/512/637830510511365404.jpeg",type:2,releaseDate:"2022-07-19T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:103,order:29,label:"Keys from the Golden Vault",subLabel:"",slug:"kftgv",relativePath:"sources/dnd/kftgv",imageUrl:"https://www.dndbeyond.com/avatars/31000/596/638070671794669885.jpeg",type:2,releaseDate:"2023-02-07T14:45:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:223,order:37,label:"One-Shot Wonders: Holiday Adventure Pack",subLabel:"Roll & Play Press",slug:"oswhap",relativePath:"sources/dnd/oswhap",imageUrl:"https://www.dndbeyond.com/avatars/53150/57/639002890479436109.jpeg",type:2,releaseDate:"2025-12-03T13:45:00Z",isReleased:!0,isFree:!1,isThirdParty:!0},{id:113,order:39,label:"Phandelver and Below: The Shattered Obelisk",subLabel:"",slug:"pbtso",relativePath:"sources/dnd/pbtso",imageUrl:"https://www.dndbeyond.com/avatars/33178/258/638154350835162270.jpeg",type:2,releaseDate:"2023-09-05T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:12,order:47,label:"Storm King's Thunder",subLabel:"",slug:"skt",relativePath:"sources/dnd/skt",imageUrl:"https://www.dndbeyond.com/avatars/10347/307/637244460981849379.jpeg",type:2,releaseDate:"2016-09-06T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:203,order:48,label:"Stranger Things: Welcome to the Hellfire Club",subLabel:"",slug:"wthc",relativePath:"sources/dnd/wthc",imageUrl:"https://www.dndbeyond.com/avatars/52003/638/638954445979470424.jpeg",type:2,releaseDate:"2025-10-07T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:14,order:50,label:"Tales from the Yawning Portal",subLabel:"",slug:"tftyp",relativePath:"sources/dnd/tftyp",imageUrl:"https://www.dndbeyond.com/avatars/10347/315/637244461501105683.jpeg",type:2,releaseDate:"2017-03-24T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:79,order:60,label:"The Wild Beyond the Witchlight",subLabel:"",slug:"twbtw",relativePath:"sources/dnd/twbtw",imageUrl:"https://www.dndbeyond.com/avatars/18120/587/637583471235980161.jpeg",type:2,releaseDate:"2021-09-21T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:25,order:61,label:"Tomb of Annihilation",subLabel:"",slug:"toa",relativePath:"sources/dnd/toa",imageUrl:"https://www.dndbeyond.com/avatars/10347/322/637244461998912169.jpeg",type:2,releaseDate:"2017-09-08T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:132,order:65,label:"Vecna: Eve of Ruin",subLabel:"",slug:"veor",relativePath:"sources/dnd/veor",imageUrl:"https://www.dndbeyond.com/avatars/39768/809/638427681491023112.jpeg",type:2,releaseDate:"2024-05-07T13:40:00Z",isReleased:!0,isFree:!1,isThirdParty:!1},{id:35,order:69,label:"Waterdeep: Dragon Heist",subLabel:"",slug:"wdh",relativePath:"sources/dnd/wdh",imageUrl:"https://www.dndbeyond.com/avatars/10347/339/637244462815499464.jpeg",type:2,releaseDate:"2018-09-07T00:00:00Z",isReleased:!0,isFree:!1,isThirdParty:!1}],ht={Weapon:"weapon",Armor:"equipment",Shield:"equipment","Wondrous item":"equipment","Wondrous Item":"equipment",Ring:"equipment",Rod:"equipment",Staff:"equipment",Wand:"equipment","Adventuring Gear":"equipment","Other Gear":"equipment",Gear:"equipment",Tool:"tool",Potion:"consumable",Scroll:"consumable",Ammunition:"consumable",spell:"spell",Feat:"feat","Class Feature":"feat","class-feature":"feat","Racial Trait":"feat",Background:"background",Race:"race",Class:"class",Subclass:"subclass"},Ps=["equipment","consumable","tool","loot"];class Pe{static async buildIndex(){return this._indexBuildPromise?this._indexBuildPromise:(this._indexBuildPromise=this._buildIndexInternal(),this._indexBuildPromise)}static async _buildIndexInternal(){c.log("DnDBCompendiumMatcher: Building compendium indices");const e=performance.now();this._indices=new Map;for(const s of game.packs)if(!(s.documentName!=="Item"||!s.visible))try{const o=await s.getIndex({fields:["name","type","flags.ddbimporter.definitionId","system.source.book","system.source.rules","system.type.value","system.identifier","system.classIdentifier","system.requirements"]});this._indices.set(s.collection,{pack:s,index:o,entries:Array.from(o.values())})}catch(o){c.warn("DnDBCompendiumMatcher: Failed to index pack",[s.collection,o.message])}const t=performance.now()-e;c.log("DnDBCompendiumMatcher: Index built",[`${this._indices.size} packs`,`${t.toFixed(0)}ms`])}static clearCache(){this._indices=null,this._indexBuildPromise=null}static _normalizeName(e){return e?e.toLowerCase().replace(/[,()'"]/g," ").replace(/\s+/g," ").trim():""}static _mapDDBType(e){var a,i;const t=((a=e.definition)==null?void 0:a.filterType)||e.filterType,s=(i=e.definition)==null?void 0:i.type,o=e.type;return t&&ht[t]?ht[t]:o&&typeof o=="string"&&ht[o]?ht[o]:s&&typeof s=="string"&&ht[s]?ht[s]:null}static async findMatch(e){const t=await this.findAllMatches(e);return t.length>0?t[0]:null}static get DDB_2024_SOURCE_IDS(){return this._ddb2024SourceIds||(this._ddb2024SourceIds=new Set(Fs.filter(e=>{var t;return(t=e.slug)==null?void 0:t.includes("2024")}).map(e=>e.id))),this._ddb2024SourceIds}static _detectRulesVersion(e){var t,s;if(!Array.isArray(e.classes))return 1;for(const o of e.classes){const a=((t=o.definition)==null?void 0:t.sources)||[];for(const i of a)if(this.DDB_2024_SOURCE_IDS.has(i.sourceId)){const n=Fs.find(r=>r.id===i.sourceId);return c.log("DnDBCompendiumMatcher: Detected 2024 rules",[(s=o.definition)==null?void 0:s.name,(n==null?void 0:n.label)||`sourceId: ${i.sourceId}`]),1}}return c.log("DnDBCompendiumMatcher: Detected 2014 rules (no 2024 source found)"),2}static async findAllMatches(e,t=null){var f,g,m,p;this._indices||await this.buildIndex();const s=((f=e.definition)==null?void 0:f.id)||e.id,o=((g=e.definition)==null?void 0:g.name)||e.name,a=this._mapDDBType(e),i=(m=e._className)==null?void 0:m.toLowerCase(),n=(p=e._raceName)==null?void 0:p.toLowerCase();if(!o)return[];const r=[],l=this._findAllByDDBId(s,o,i,n);r.push(...l);const d=this._findAllByName(o,a,!1,i,n);for(const S of d)r.some(R=>R.uuid===S.uuid)||r.push(S);if(e._isChoiceOption&&e._parentFeatureName&&r.length===0){const S=this._getChoiceNameVariants(o,e._parentFeatureName);for(const y of S){const R=this._findAllByName(y,a);for(const A of R)r.some(T=>T.uuid===A.uuid)||r.push(A)}}if(e.type==="Race"){const S=this._findAllByName(o,a,!0);for(const y of S)r.some(A=>A.uuid===y.uuid)||r.push(y);if(e._searchVariants)for(const y of e._searchVariants){if(y===o)continue;const R=this._findAllByName(y,a);for(const A of R)r.some(T=>T.uuid===A.uuid)||r.push(A)}}let u=t;if(u===null){const S=I();u=v.get(S.ddbImportSourcePriority.tag)??0}return r.sort((S,y)=>this._compareMatches(S,y,u)),r.length>0&&c.log("DnDBCompendiumMatcher: Found matches",[o,`${r.length} sources`]),r}static _isExcludedPack(e,t){return t.includes("monster-manual")?!0:this.EXCLUDED_PACK_PATTERNS.some(s=>s.test(e))}static _getSourceInfo(e){const t=game.modules.get(e)||game.system,s=(t==null?void 0:t.version)||"0.0.0";return{packageName:e,version:s,title:(t==null?void 0:t.title)||e}}static _getSourceAbbreviation(e){if(this.SOURCE_ABBREVIATIONS[e])return this.SOURCE_ABBREVIATIONS[e];const t=game.modules.get(e);return t!=null&&t.title&&t.title.split(/\s+/).filter(a=>a.length>0).map(a=>a[0].toUpperCase()).join("")||"World"}static _createDisplayLabel(e,t,s,o){if(s)return`${e} (${s})`;const a=this._getSourceAbbreviation(t),i=e.toLowerCase(),n=i.includes("(srd)")||i.includes("(phb)")||i.includes("(dmg)");return o==="2024"?n?e.replace(/\(SRD\)/i,"(SRD 2024)").replace(/\(PHB\)/i,"(PHB 2024)").replace(/\(DMG\)/i,"(DMG 2024)"):`${e} (${a} 2024)`:n?e:`${e} (${a})`}static _getSourcePriority(e){return this.SOURCE_PRIORITIES[e]??99}static _getRulesPriority(e,t,s,o=1){const a=e==="2024"||this.PACKAGES_2024.has(s)||(s==null?void 0:s.includes("2024")),i=e==="2014"||this.PACKAGES_2014.has(s);return o===1?a?10:i?30:50:o===2?i?10:a?30:50:50}static _compareMatches(e,t,s){const o=e.requirementScore??100,a=t.requirementScore??100;if(o!==a)return a-o;if(s===3){if(e.matchType==="ddbId"&&t.matchType!=="ddbId")return-1;if(e.matchType!=="ddbId"&&t.matchType==="ddbId")return 1;const r=this._getRulesPriority(e.sourceRules,e.sourceBook,e.source,1),l=this._getRulesPriority(t.sourceRules,t.sourceBook,t.source,1);return r!==l?r-l:this._getSourcePriority(e.source)-this._getSourcePriority(t.source)}const i=this._getRulesPriority(e.sourceRules,e.sourceBook,e.source,s),n=this._getRulesPriority(t.sourceRules,t.sourceBook,t.source,s);return i!==n?i-n:e.matchType==="ddbId"&&t.matchType!=="ddbId"?-1:e.matchType!=="ddbId"&&t.matchType==="ddbId"?1:this._getSourcePriority(e.source)-this._getSourcePriority(t.source)}static _findAllByDDBId(e,t,s=null,o=null){var l,d,u,f,g,m;if(!e)return[];const a=Number(e);if(isNaN(a))return[];const i=[],n=new Set,r=this._normalizeName(t);for(const[p,{pack:S,entries:y}]of this._indices){const R=S.metadata.packageName;if(!this._isExcludedPack(S.metadata.label,R)){for(const A of y)if(((d=(l=A.flags)==null?void 0:l.ddbimporter)==null?void 0:d.definitionId)===a){const T=this._normalizeName(A.name),b=T.replace(/\s*\(?\s*legacy\s*\)?\s*/g,"").trim();if(T===r||b===r){const C=this._getRequirementScore(A,s,o);if(C===0)continue;const w=((f=(u=A.system)==null?void 0:u.source)==null?void 0:f.book)||"",M=((m=(g=A.system)==null?void 0:g.source)==null?void 0:m.rules)||"",O=`${R}::${w}::${M}`;if(n.has(O))continue;const F=this._getSourceInfo(R);i.push({uuid:A.uuid,name:A.name,type:A.type,packId:p,source:R,sourceLabel:S.metadata.label,sourceVersion:F.version,sourceTitle:F.title,sourceBook:w,sourceRules:M,displayLabel:this._createDisplayLabel(S.metadata.label,R,w,M),matchType:"ddbId",requirementScore:C}),n.add(O)}else c.warn("DnDBCompendiumMatcher: DDB ID collision",[`ID ${a}:`,`"${t}" vs compendium "${A.name}"`])}}}return i}static _getRequirementScore(e,t,s){var n,r,l,d,u;if(e.type!=="feat")return 100;const o=(r=(n=e.system)==null?void 0:n.type)==null?void 0:r.value,a=(((l=e.system)==null?void 0:l.identifier)||((d=e.system)==null?void 0:d.classIdentifier)||"").toLowerCase(),i=(((u=e.system)==null?void 0:u.requirements)||"").toLowerCase();return t&&o==="class"?i&&i.includes(t)||a&&a===t?100:i&&["barbarian","bard","cleric","druid","fighter","monk","paladin","ranger","rogue","sorcerer","warlock","wizard"].some(m=>m!==t&&i.includes(m))?0:50:s&&o==="race"?i&&i.includes(s)||a&&a.includes(s)?100:!a&&!i?50:0:100}static _findAllByName(e,t,s=!1,o=null,a=null){var u,f,g,m;const i=this._normalizeName(e);if(!i)return[];const n=i.split(/\s+/).filter(p=>p.length>0),r=[],l=new Set,d=this._getTypeVariants(t);for(const[p,{pack:S,entries:y}]of this._indices){const R=S.metadata.packageName;if(!this._isExcludedPack(S.metadata.label,R))for(const A of y){if(t&&!d.includes(A.type))continue;const _=this._normalizeName(A.name),T=_.replace(/\s*\(?\s*legacy\s*\)?\s*/g,"").trim();let b=_===i||T===i;if(!b&&s&&n.length>1){const N=new Set(["of","the","a","an"]),W=T.split(/[\s,\-]+/).filter(U=>U.length>0&&!N.has(U));b=n.filter(U=>!N.has(U)).every(U=>W.some(le=>le===U))}if(!b)continue;const C=this._getRequirementScore(A,o,a);if(C===0)continue;const w=((f=(u=A.system)==null?void 0:u.source)==null?void 0:f.book)||"",M=((m=(g=A.system)==null?void 0:g.source)==null?void 0:m.rules)||"",O=`${R}::${w}::${M}`;if(l.has(O))continue;const F=this._getSourceInfo(R);r.push({uuid:A.uuid,name:A.name,type:A.type,packId:p,source:R,sourceLabel:S.metadata.label,sourceVersion:F.version,sourceTitle:F.title,sourceBook:w,sourceRules:M,displayLabel:this._createDisplayLabel(S.metadata.label,R,w,M),matchType:"exactName",requirementScore:C}),l.add(O)}}return r}static _getTypeVariants(e){return e?e==="race"?["race","species"]:e==="species"?["race","species"]:Ps.includes(e)?Ps:[e]:[]}static async matchCharacterItems(e){var m;this._indices||await this.buildIndex();const t=I();let s=v.get(t.ddbImportSourcePriority.tag)??0;s===0&&(s=this._detectRulesVersion(e));const o=[],a=[],i=this._extractItemsToMatch(e),n=new Set,r=i.filter(p=>{var S;return p.type==="spell"||((S=p.type)==null?void 0:S.toLowerCase())==="spell"});c.log("DnDBCompendiumMatcher: Items to match",[i.length,`(${r.length} spells)`,`priority: ${s===1?"2024":s===2?"2014":"closest"}`]),r.length>0&&c.log("DnDBCompendiumMatcher: Spells to match",[r.map(p=>{var S;return((S=p.definition)==null?void 0:S.name)||p.name}).join(", ")]);for(const p of i){const S=await this.findAllMatches(p,s),y=((m=p.definition)==null?void 0:m.name)||p.name,R=this._mapDDBType(p)||"unknown";if(S.length>0){const A=S[0];for(const _ of S)n.add(_.source);o.push({ddbItem:p,foundryUuid:A.uuid,foundryName:A.name,foundryType:R,matchType:A.matchType,source:A.source,sourceLabel:A.sourceLabel,sourceTitle:A.sourceTitle,sourceVersion:A.sourceVersion,allMatches:S,selectedIndex:0})}else a.push({ddbItem:p,name:y,type:R,reason:"not_found"})}const l=o.length+a.length,d=l>0?o.length/l:0,u=d>=.5?"B":"C",f=o.filter(p=>p.foundryType==="spell"),g=a.filter(p=>p.type==="spell");return c.log("DnDBCompendiumMatcher: Character match complete",[`${o.length}/${l} matched`,`${(d*100).toFixed(0)}%`,`Tier ${u}`,`${f.length} spells matched, ${g.length} unmatched`]),g.length>0&&c.log("DnDBCompendiumMatcher: Unmatched spells",[g.map(p=>p.name).join(", ")]),{matched:o,unmatched:a,matchRate:d,tier:u,total:l,availableSources:Array.from(n)}}static _extractItemsToMatch(e){var r,l,d,u,f,g,m,p,S,y;const t=[];if(Array.isArray(e.classes)){for(const R of e.classes)if(t.push({definition:R.definition,id:(r=R.definition)==null?void 0:r.id,name:(l=R.definition)==null?void 0:l.name,type:"Class",_classLevel:R.level,_isStartingClass:R.isStartingClass,_subclass:R.subclassDefinition}),R.subclassDefinition&&t.push({definition:R.subclassDefinition,id:R.subclassDefinition.id,name:R.subclassDefinition.name,type:"Subclass",_parentClass:(d=R.definition)==null?void 0:d.name}),Array.isArray(R.classFeatures))for(const A of R.classFeatures){if(!A.definition)continue;const _=A.definition.requiredLevel||1;if(_>R.level)continue;const T=A.definition.name;this._isSystemMechanicFeature(T)||t.push({definition:A.definition,id:A.definition.id,name:T,type:A.definition.entityType||"class-feature",_className:(u=R.definition)==null?void 0:u.name,_classLevel:R.level,_requiredLevel:_,_isSubclassFeature:A.definition.isSubClassFeature||!1})}}if(e.race){const R=e.race.baseName||e.race.fullName,A=this._extractLineageVariant(e,R),_=A||e.race.fullName||R,T=this._getRaceSearchVariants(_,R,e.race.subRaceShortName,A);if(c.log("DnDBCompendiumMatcher: Extracting race/species",[`base: ${R}`,`lineage: ${A||"none"}`,`name: ${_}`,`variants: ${T.join(", ")}`]),t.push({definition:e.race,id:e.race.entityRaceId||e.race.id,name:_,type:"Race",_isSubrace:!!e.race.subRaceShortName,_baseRaceName:R,_lineageVariant:A,_searchVariants:T}),Array.isArray(e.race.racialTraits))for(const b of e.race.racialTraits){if(!b.definition)continue;const C=b.definition.name;this._isSystemMechanicFeature(C)||t.push({definition:b.definition,id:b.definition.id,name:C,type:"Racial Trait",_raceName:R})}}if((f=e.background)!=null&&f.definition){const R=e.background.definition;t.push({definition:R,id:R.id,name:R.name,type:"Background"})}if(e.inventory)for(const R of e.inventory)t.push(R);const s=new Map,o=I(),i=(v.get(o.ddbImportSpellMode.tag)??0)===1;if(e.spells){const R=["class","race","feat","item","background"];for(const A of R)if(Array.isArray(e.spells[A]))for(const _ of e.spells[A]){const T=(g=_.definition)==null?void 0:g.id;if(!T)continue;const b=((m=_.definition)==null?void 0:m.level)===0;if(i&&!_.prepared&&!_.alwaysPrepared&&!b)continue;const C=s.get(T);C?_.alwaysPrepared&&!C.alwaysPrepared&&s.set(T,{..._,_spellSource:A,type:"spell"}):s.set(T,{..._,_spellSource:A,type:"spell"})}}if(Array.isArray(e.classSpells)){for(const R of e.classSpells)if(Array.isArray(R.spells))for(const A of R.spells){const _=(p=A.definition)==null?void 0:p.id;if(!_)continue;const T=((S=A.definition)==null?void 0:S.level)===0;if(i&&!A.prepared&&!A.alwaysPrepared&&!T)continue;const b=s.get(_);b?A.alwaysPrepared&&!b.alwaysPrepared&&s.set(_,{...A,_spellSource:"classSpells",type:"spell"}):s.set(_,{...A,_spellSource:"classSpells",type:"spell"})}}for(const R of s.values())t.push(R);if(e.feats)for(const R of e.feats)t.push({...R,type:"Feat"});if((y=e.options)!=null&&y.class){const R=new Set(t.filter(A=>A.type==="class-feature"||A._className).map(A=>A.id));for(const A of e.options.class){if(!A.definition||R.has(A.definition.id))continue;const _=A.definition.name;if(this._isSystemMechanicFeature(_))continue;const T=A.componentId,b=t.find(C=>(C.type==="class-feature"||C._className)&&C.id===T);t.push({definition:A.definition,id:A.definition.id,name:_,type:"class-feature",_isChoiceOption:!0,_parentFeatureId:T,_parentFeatureName:(b==null?void 0:b.name)||null,_className:(b==null?void 0:b._className)||null}),c.log("DnDBCompendiumMatcher: Extracted choice option",[_,`parent: ${(b==null?void 0:b.name)||T}`])}}const n=Be.getToolProficiencies(e);for(const R of n)t.push({name:R.name,type:"Tool",_toolSubType:R.subType,_isToolProficiency:!0});return t}static _extractLineageVariant(e,t){var o,a;if(!((o=e.options)!=null&&o.race))return null;const s=/^(\w+(?:\s+\w+)?)\s+Lineage$/i;for(const i of e.options.race){const n=(a=i.definition)==null?void 0:a.name;if(!n)continue;const r=n.match(s);if(r){const l=r[1];if(l.toLowerCase().includes(t.toLowerCase())||t.toLowerCase().includes(l.split(/\s+/)[0].toLowerCase())){const d=l.split(/\s+/);if(d.length>=2){const u=d[0],f=`${t}, ${u}`;return c.log("DnDBCompendiumMatcher: Extracted lineage variant",[n,`-> ${f}`]),f}}}}return null}static _getRaceSearchVariants(e,t,s,o){const a=new Set([e]);if(o){a.add(o);const i=o.split(/,\s*/);i.length===2&&a.add(`${i[1]} ${i[0]}`)}return t&&s&&(a.add(`${t}, ${s}`),a.add(`${s} ${t}`)),t&&a.add(t),Array.from(a)}static _getChoiceNameVariants(e,t){const s=[];return s.push(`${t}: ${e}`),s.push(`${e} (${t})`),s.push(`${t} - ${e}`),s}static _isSystemMechanicFeature(e){return e?this.SYSTEM_MECHANIC_FEATURES.has(e)?!0:this.SYSTEM_MECHANIC_PATTERNS.some(t=>t.test(e)):!1}static getIndexStats(){if(!this._indices)return{built:!1,packCount:0,totalItems:0};let e=0;for(const{entries:t}of this._indices.values())e+=t.length;return{built:!0,packCount:this._indices.size,totalItems:e}}}E(Pe,"_indices",null),E(Pe,"_indexBuildPromise",null),E(Pe,"SOURCE_PRIORITIES",{"dnd-2024-players-handbook":10,"dnd-players-handbook-2024":10,"dnd-2024-dungeon-masters-guide":11,"ddb-importer":20,"dnd5e-complete-pack":25,"dnd-players-handbook":30,"dnd-dungeon-masters-guide":31,dnd5e:50}),E(Pe,"EXCLUDED_PACK_PATTERNS",[/monster/i,/creatures/i,/bestiary/i,/npc/i]),E(Pe,"SOURCE_ABBREVIATIONS",{dnd5e:"SRD","ddb-importer":"DDB","dnd-2024-players-handbook":"PHB","dnd-players-handbook-2024":"PHB","dnd-2024-dungeon-masters-guide":"DMG","dnd-players-handbook":"PHB","dnd-dungeon-masters-guide":"DMG","dnd-monster-manual":"MM","dnd5e-complete-pack":"Complete"}),E(Pe,"PACKAGES_2024",new Set(["dnd-2024-players-handbook","dnd-players-handbook-2024","dnd-2024-dungeon-masters-guide","dnd-2024-monster-manual"])),E(Pe,"PACKAGES_2014",new Set(["dnd5e"])),E(Pe,"SYSTEM_MECHANIC_FEATURES",new Set(["Proficiencies","Hit Points","Equipment","Languages","Ability Score Increases","Ability Score Increase","Creature Type","Size","Speed","Darkvision","Superior Darkvision","Fighting Style feat","Epic Boon feat"])),E(Pe,"SYSTEM_MECHANIC_PATTERNS",[/^Core .+ Traits$/]);class Ut{static async getOrCreateFolder(){let e=game.folders.find(t=>t.type==="Compendium"&&t.name===this.FOLDER_NAME);if(e)return e;try{return e=await Folder.create({name:this.FOLDER_NAME,type:"Compendium",color:this.FOLDER_COLOR}),c.log("DnDBHomebrewManager: Created compendium folder",[e.id]),e}catch(t){return c.error("DnDBHomebrewManager: Failed to create folder",[t.message]),null}}static async getOrCreateCompendium(e){var a,i,n;const t=this.COMPENDIUM_CONFIG[e.toLowerCase()];if(!t)return c.warn("DnDBHomebrewManager: Unknown item type",[e]),null;const s=this._getPackName(t.label);let o=game.packs.get(`world.${s}`);if(o||(o=game.packs.find(r=>r.metadata.packageType==="world"&&r.metadata.label===t.label),o))return o;try{const r=await this.getOrCreateFolder();return o=await(((i=(a=foundry.documents)==null?void 0:a.collections)==null?void 0:i.CompendiumCollection)??CompendiumCollection).createCompendium({type:t.type,label:t.label,name:s,packageType:"world",flags:{[V.ID]:{isHomebrewCompendium:!0,createdDate:Date.now()}}}),o&&r&&await o.setFolder(r.id),c.log("DnDBHomebrewManager: Created compendium",[t.label,(n=o==null?void 0:o.metadata)==null?void 0:n.id]),o}catch(r){return c.error("DnDBHomebrewManager: Failed to create compendium",[t.label,r.message]),null}}static _getPackName(e){return e.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"")}static async findExistingItem(e,t){const s=await this.getOrCreateCompendium(t);if(!s)return null;const o=e.toLowerCase().trim(),i=(await s.getIndex()).find(n=>n.name.toLowerCase().trim()===o);return i?{uuid:`${s.metadata.id}.${i._id}`,name:i.name,pack:s.metadata.id}:null}static async createItemInCompendium(e,t){const s=await this.getOrCreateCompendium(t);if(!s)return null;const o=await this.findExistingItem(e.name,t);if(o)return c.log("DnDBHomebrewManager: Item already exists in compendium",[e.name,o.uuid]),await fromUuid(o.uuid);try{const i=await CONFIG.Item.documentClass.create(e,{pack:s.metadata.id});return c.log("DnDBHomebrewManager: Created item in compendium",[i.name,s.metadata.id]),i}catch(a){return c.error("DnDBHomebrewManager: Failed to create item in compendium",[e.name,a.message]),null}}static async createHomebrewItemsForActor(e,t){const s=[],o=[];c.log("DnDBHomebrewManager: Creating homebrew items",[t.length,t.map(a=>`${a.name} (${a.type})`).join(", ")]);for(const a of t){const i=this._createPlaceholderItemData(a);if(!i){c.warn("DnDBHomebrewManager: Failed to create placeholder data for",[a.name]);continue}const n=a.type||"feat";c.log("DnDBHomebrewManager: Creating item",[i.name,i.type,n]);const r=await this.createItemInCompendium(i,n);if(r){s.push(r);const l=r.toObject();delete l._id,this._applyItemState(l,a),o.push(l)}}return o.length>0&&(await e.createEmbeddedDocuments("Item",o),c.log("DnDBHomebrewManager: Added homebrew items to actor",[o.length,e.name])),s}static _createPlaceholderItemData(e){var d,u,f,g,m;const t=e.name||((u=(d=e.ddbItem)==null?void 0:d.definition)==null?void 0:u.name)||"Unknown Item",s=e.type||"feat",o=this._mapTypeForCreation(s),a=(f=e.ddbItem)==null?void 0:f.definition,i=(a==null?void 0:a.description)||"",n=(a==null?void 0:a.snippet)||"",r=(i.length>=n.length?i:n)||"<p><em>Placeholder item imported from D&D Beyond. This item was not found in any compendium.</em></p>",l={name:t,type:o,img:this._getDefaultIcon(o),system:{description:{value:r},source:{custom:"FTB - D&D Beyond"}},flags:{[V.ID]:{ddbPlaceholder:!0,ddbItemType:s,ddbDefinitionId:((m=(g=e.ddbItem)==null?void 0:g.definition)==null?void 0:m.id)||e.id}}};return o==="class"&&e._classLevel&&(l.system.levels=e._classLevel),l}static _applyItemState(e,t){e.type==="class"&&t._classLevel&&(e.system||(e.system={}),e.system.levels=t._classLevel)}static _mapTypeForCreation(e){if(!e)return"feat";const t=e.toLowerCase();return{race:"race",species:"race",background:"background",class:"class",subclass:"subclass",feat:"feat",spell:"spell",weapon:"weapon",equipment:"equipment",consumable:"consumable",tool:"tool",unknown:"feat"}[t]||"feat"}static _getDefaultIcon(e){return{race:"icons/environment/people/group.webp",background:"icons/skills/trades/academics-book-study-purple.webp",class:"icons/sundries/books/book-red-exclamation.webp",subclass:"icons/sundries/books/book-stack.webp",feat:"icons/sundries/scrolls/scroll-runed-brown-purple.webp",spell:"icons/magic/symbols/runes-star-pentagon-orange-purple.webp",weapon:"icons/weapons/swords/sword-guard-bronze.webp",equipment:"icons/equipment/chest/breastplate-banded-steel-gold.webp",consumable:"icons/consumables/potions/potion-bottle-corked-red.webp",tool:"icons/tools/hand/hammer-and-nails.webp"}[e]||"icons/svg/item-bag.svg"}}E(Ut,"FOLDER_NAME","Flash Token Bar"),E(Ut,"FOLDER_COLOR","#5c2d91"),E(Ut,"COMPENDIUM_CONFIG",{race:{label:"FTB Species",type:"Item"},species:{label:"FTB Species",type:"Item"},background:{label:"FTB Backgrounds",type:"Item"},class:{label:"FTB Classes",type:"Item"},subclass:{label:"FTB Subclasses",type:"Item"},feat:{label:"FTB Features",type:"Item"},spell:{label:"FTB Spells",type:"Item"},weapon:{label:"FTB Equipment",type:"Item"},equipment:{label:"FTB Equipment",type:"Item"},consumable:{label:"FTB Equipment",type:"Item"},tool:{label:"FTB Equipment",type:"Item"},unknown:{label:"FTB Features",type:"Item"}});class Jo{static async importCharacter(e,t={}){if(c.log("DnDBCharacterImporter: Starting import",[e]),this._hasDDBImporter())return await this._importViaDDBImporter(e);const s=await Ms.fetchCharacter(e);if(!s)return ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumSettings.fetchFailed")),null;const o=await Pe.matchCharacterItems(s);if(!t.skipDialog){const{CharacterImportResultsDialog:a}=await Dt(async()=>{const{CharacterImportResultsDialog:n}=await Promise.resolve().then(()=>ha);return{CharacterImportResultsDialog:n}},void 0),i=await a.show({characterName:s.name,tier:o.tier,matchRate:o.matchRate,matched:o.matched,unmatched:o.unmatched,classInfo:Be.getClassInfo(s),raceName:Be.getRaceName(s),backgroundName:Be.getBackgroundName(s)});if(!i)return c.log("DnDBCharacterImporter: Import cancelled by user"),null;o.matched=i.matched,o.homebrewToCreate=i.homebrewToCreate||[]}return await this._createActorFromMatch(s,o)}static _hasDDBImporter(){var e;return((e=game.modules.get("ddb-importer"))==null?void 0:e.active)===!0}static async _importViaDDBImporter(e){var t;c.log("DnDBCharacterImporter: Using DDB Importer (Tier A)");try{const s=(t=game.modules.get("ddb-importer"))==null?void 0:t.api;if(!(s!=null&&s.importCharacter))return c.error("DnDBCharacterImporter: DDB Importer API not available"),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumSettings.ddbImporterApiError")),null;const o=await Actor.create({name:`DDB Import ${e}`,type:"character",flags:{ddbimporter:{dndbeyond:{characterId:String(e)}}}});if(!o)return c.error("DnDBCharacterImporter: Failed to create stub actor"),null;c.log("DnDBCharacterImporter: Created stub actor for DDB Importer",[o.id]),await s.importCharacter({actor:o});const a=game.actors.get(o.id);return a?(await Ke.mapCharacter(e,a.id),ui.notifications.info(game.i18n.format("FLASH_ROLLS.settings.premiumSettings.successDDBImporter",{name:a.name})),a):(ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.settings.premiumSettings.ddbImporterFailed")),null)}catch(s){return c.error("DnDBCharacterImporter: DDB Importer error",[s.message]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumSettings.ddbImporterError")),null}}static async _createActorFromMatch(e,t){var o,a;const s=((o=t.homebrewToCreate)==null?void 0:o.length)||0;c.log("DnDBCharacterImporter: Creating actor",[`Tier ${t.tier}`,`${t.matched.length} items to add`,`${s} homebrew to create`]);try{const i=Be.transformToActor(e,t),n=await Actor.create(i);if(!n)throw new Error("Actor.create returned null");await this._addMatchedItems(n,t.matched),((a=t.homebrewToCreate)==null?void 0:a.length)>0&&await this._createHomebrewItems(n,t.homebrewToCreate);const r=game.actors.get(n.id),l=Be.getSpellSlots(e);(Object.keys(l.spellSlots).length>0||l.pactSlots)&&await Be.applySpellSlots(r,l),await Ke.mapCharacter(e.id,n.id);const d=t.tier==="B"?"partial":"basic",u=t.matched.length+s;return ui.notifications.info(game.i18n.format("FLASH_ROLLS.settings.premiumSettings.success",{name:n.name,tier:d,count:u})),c.log("DnDBCharacterImporter: Import complete",[n.id,n.name]),n}catch(i){return c.error("DnDBCharacterImporter: Failed to create actor",[i.message]),ui.notifications.error(game.i18n.format("FLASH_ROLLS.settings.premiumSettings.createFailed",{error:i.message})),null}}static async _createHomebrewItems(e,t){const s=await Ut.createHomebrewItemsForActor(e,t);c.log("DnDBCharacterImporter: Created homebrew items via compendiums",[s.length])}static async _addMatchedItems(e,t){var l,d,u;const s=[],o=[],a=[],i=[],n=[];for(const f of t){const g=f.foundryType||((l=f.ddbItem.type)==null?void 0:l.toLowerCase()),m=((d=f.ddbItem.type)==null?void 0:d.toLowerCase())||((u=f.ddbItem.definition)==null?void 0:u.entityType),p=f.ddbItem._isChoiceOption===!0,S=m==="class-feature"||f.ddbItem._className;g==="class"?s.push(f):g==="subclass"?o.push(f):["race","species","background"].includes(g)?a.push(f):S||p?i.push(f):n.push(f)}const r=n.filter(f=>{var g;return f.foundryType==="spell"||((g=f.ddbItem)==null?void 0:g.type)==="spell"});c.log("DnDBCharacterImporter: Categorized items",[`${s.length} classes`,`${o.length} subclasses`,`${a.length} race/bg`,`${i.length} class features`,`${n.length} regular (${r.length} spells)`]),r.length>0&&c.log("DnDBCharacterImporter: Spells to add",[r.map(f=>f.foundryName).join(", ")]),s.length>0&&await this._addClassItemsDirectly(e,s),o.length>0&&await this._addItemsToActor(e,o),a.length>0&&await this._addItemsToActor(e,a),i.length>0&&await this._addItemsToActor(e,i),n.length>0&&await this._addItemsToActor(e,n)}static async _addItemsToActor(e,t){const s=[];for(const o of t)try{const a=await fromUuid(o.foundryUuid);if(!a){c.warn("DnDBCharacterImporter: Could not load item",[o.foundryUuid]);continue}const i=a.toObject();delete i._id,Be.applyItemState(i,o.ddbItem),s.push(i)}catch(a){c.warn("DnDBCharacterImporter: Failed to process item",[o.foundryName,a.message])}s.length>0&&(await e.createEmbeddedDocuments("Item",s),c.log("DnDBCharacterImporter: Added items to actor",[s.length]))}static async _addClassItemsDirectly(e,t){var o;const s=[];for(const a of t)try{const i=await fromUuid(a.foundryUuid);if(!i){c.warn("DnDBCharacterImporter: Could not load class item",[a.foundryUuid]);continue}const n=i.toObject();delete n._id;const r=a.ddbItem._classLevel||1;n.system&&(n.system.levels=r),(o=n.system)!=null&&o.advancement&&(n.system.advancement=n.system.advancement.filter(l=>l.type==="ScaleValue")),Be.applyItemState(n,a.ddbItem),c.log("DnDBCharacterImporter: Adding class directly",[n.name,`Level ${r}`,"No advancement flow"]),s.push(n)}catch(i){c.warn("DnDBCharacterImporter: Failed to process class item",[a.foundryName,i.message])}s.length>0&&(await e.createEmbeddedDocuments("Item",s),c.log("DnDBCharacterImporter: Added class items",[s.length]))}static async previewImport(e){if(this._hasDDBImporter())return{tier:"A",method:"ddb-importer",matchRate:1,matched:[],unmatched:[]};const t=await Ms.fetchCharacter(e);if(!t)return{error:"fetch_failed"};const s=await Pe.matchCharacterItems(t);return{tier:s.tier,method:"compendium-match",matchRate:s.matchRate,matched:s.matched.length,unmatched:s.unmatched.length,characterName:t.name}}}const{ApplicationV2:Xo,HandlebarsApplicationMixin:Qo}=foundry.applications.api,Je="https://proxy.carolingian.io";var Z,Js,Xs,Qs,Zs,eo,to,so,oo,ao,io,no,ro,lo,co;const ee=class ee extends Qo(Xo){constructor(e={}){super(e),this._authStatus=null,this._campaignCharacters=[],this._isLoadingCharacters=!1,this._patronVerified=!1,this._ddbGameLogStatus="unknown",this._initialDataLoaded=!1,this.tabGroups.primary=ee.getLastActiveTab()}static getLastActiveTab(){return game.user.getFlag(V.ID,ee.FLAG_LAST_TAB)||"authentication"}static setLastActiveTab(e){game.user.setFlag(V.ID,ee.FLAG_LAST_TAB,e)}changeTab(e,t,s={}){super.changeTab(e,t,s),t==="primary-tabs"&&(ee.setLastActiveTab(e),e==="ddbSettings"&&this._autoTestDDBConnection())}async _prepareContext(e={}){return await super._prepareContext(e)}async _preparePartContext(e,t,s){var A;const o=await super._preparePartContext(e,t,s),a=I();e in t.tabs&&(o.tab=t.tabs[e]);const i=v.get(a.ddbCampaignId.tag)||"",n=v.get(a.ddbUserId.tag)||"",r=v.get(a.ddbCobaltCookie.tag)||"",l=v.get(a.ddbNoAutoConsumeSpellSlot.tag)||!1,d=v.get(a.ddbImportOwnership.tag)??!0,u=!!J.getSessionToken(),f=this._getDDBConnectionStatusInfo(this._ddbGameLogStatus),g=this._getPatreonStatusInfo(),m=J.getStatus(),p=m.isPatron&&i&&n&&r,S=(A=game.modules.get("ddb-importer"))==null?void 0:A.active,y=m.isPatron&&i&&r,R=this._campaignCharacters.map(_=>{var b,C;const T=this._findActorForCharacter(_.id,_.name);return{..._,mappedActorId:(b=T.actor)==null?void 0:b.id,mappedActorName:(C=T.actor)==null?void 0:C.name,isMapped:!!T.actor,mappingSource:T.source}});switch(e){case"tabs":break;case"footer":o.buttons=[{type:"button",icon:"fas fa-save",label:"FLASH_ROLLS.ui.buttons.save",action:"save"}];break;case"authentication":case"ddbSettings":const _=R.filter(M=>M.isMapped).length,T=R.length-_,b=game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.characterCountText",{count:R.length}),C=J.getStatus(),w=this._getTierName(C.tier);Object.assign(o,{ddbCampaignId:i,ddbUserId:n,ddbCobaltCookie:r,ddbNoAutoConsumeSpellSlot:l,ddbImportOwnership:d,hasSessionToken:u,proxyAuthUrl:`${Je}/auth/patreon`,patronStatus:C,patronTierName:w,patreonStatusClass:g.cssClass,patreonStatusIcon:g.icon,patreonStatusText:g.text,ddbStatusClass:f.cssClass,ddbStatusIcon:f.icon,ddbStatusText:f.text,ddbIsConnected:this._ddbGameLogStatus==="connected",patronVerified:C.isPatron,canShowCharacters:C.isPatron&&y,canTestGameLog:C.isPatron&&p,isLoadingCharacters:this._isLoadingCharacters,campaignCharacters:R,hasCharacters:R.length>0,hasDDBImporter:S,characterCount:b,hasMappedCharacters:_>0,hasUnmappedCharacters:T>0});break}return o}_findActorForCharacter(e,t){const o=Ke.getMappings()[e];if(o){const i=game.actors.get(o);if(i)return{actor:i,source:"manual"}}const a=game.actors.find(i=>{var r,l;const n=(l=(r=i.flags)==null?void 0:r.ddbimporter)==null?void 0:l.dndbeyond;return n?!!(n.characterId&&String(n.characterId)===String(e)||n.roUrl&&n.roUrl.includes(`/characters/${e}`)||n.url&&n.url.includes(`/characters/${e}`)):!1});return a?{actor:a,source:"ddbimporter"}:{actor:null,source:null}}_getPatreonStatusInfo(){return J.getStatus().isPatron?{cssClass:"connected",icon:"fa-circle-check",text:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.patreonVerified")}:{cssClass:"disconnected",icon:"fa-circle-xmark",text:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.patreonNotVerified")}}_getTierName(e){return!e||e===0?"Free":e>=99999?"Special":e>=500?"Gatewarden":e>=200?"Avowed":"Free"}_getDDBConnectionStatusInfo(e){switch(e){case"connected":return{cssClass:"connected",icon:"fa-circle-check",text:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.statusConnected")};case"connecting":case"testing":return{cssClass:"connecting",icon:"fa-spinner fa-spin",text:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.statusConnecting")};case"error":return{cssClass:"disconnected",icon:"fa-circle-xmark",text:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.statusError")};case"unknown":return{cssClass:"unknown",icon:"",text:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.statusNotTested")};default:return{cssClass:"disconnected",icon:"fa-circle-xmark",text:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.statusDisconnected")}}}async _fetchCampaignCharacters(e=!0){const t=I(),s=v.get(t.ddbCampaignId.tag),o=v.get(t.ddbCobaltCookie.tag),a=J.getSessionToken();if(!a||!s||!o)return[];try{this._isLoadingCharacters=!0,e&&this._updateRefreshButtonSpinner(!0);const i=await fetch(`${Je}/ddb/campaign/${s}/characters`,{headers:{Authorization:`Bearer ${a}`,"X-Cobalt-Cookie":o}});if(!i.ok)throw new Error(`HTTP ${i.status}`);const n=await i.json();this._campaignCharacters=n.characters||[],c.log("PremiumFeaturesDialog: Fetched characters",[this._campaignCharacters])}catch(i){c.error("PremiumFeaturesDialog: Failed to fetch characters",[i]),this._campaignCharacters=[]}finally{this._isLoadingCharacters=!1,e&&(this._updateRefreshButtonSpinner(!1),this._updateCharacterList())}}_updateRefreshButtonSpinner(e){var s;const t=(s=this.element)==null?void 0:s.querySelector('[data-action="refreshCharacters"] i');t&&(e?t.classList.add("fa-spin"):t.classList.remove("fa-spin"))}_updateCharacterList(){var l,d;const e=(l=this.element)==null?void 0:l.querySelector(".campaign-characters");if(!e)return;const t=(d=game.modules.get("ddb-importer"))==null?void 0:d.active,s=this._campaignCharacters.map(u=>{var g,m;const f=this._findActorForCharacter(u.id,u.name);return{...u,mappedActorId:(g=f.actor)==null?void 0:g.id,mappedActorName:(m=f.actor)==null?void 0:m.name,isMapped:!!f.actor,mappingSource:f.source}});let o="";if(s.length>0){const u=s.filter(m=>m.isMapped).length,f=s.length-u;o=`
        <div class="character-list-header">
          <span class="character-count">${game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.characterCountText",{count:s.length})}</span>
          <div class="bulk-actions">
            <button type="button" data-action="importAll" class="import-all-btn"
                    ${!t||f===0?"disabled":""}
                    data-tooltip="${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.importAllTooltip")}">
              <i class="fas fa-download"></i>
              ${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.importAll")}
            </button>
            <button type="button" data-action="syncAll" class="sync-all-btn"
                    ${!t||u===0?"disabled":""}
                    data-tooltip="${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.syncAllTooltip")}">
              <i class="fas fa-sync"></i>
              ${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.syncAll")}
            </button>
          </div>
        </div>
        <ul class="character-list">`;for(const m of s){const p=m.isMapped?"mapped":"unmapped",S=m.avatarUrl?`<img src="${m.avatarUrl}" alt="${m.name}" />`:'<i class="fas fa-user"></i>',y=m.isMapped?`<span class="mapping-status mapped" data-tooltip="${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.mappedTo")} ${m.mappedActorName}">
               <i class="fas fa-circle-check"></i> #${m.id}
             </span>`:`<span class="mapping-status unmapped" data-tooltip="${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.notMapped")}">
               <i class="fas fa-circle-question"></i> ${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.notMapped")}
             </span>`,R=m.isMapped?`<button type="button" data-action="unlinkCharacter" data-character-id="${m.id}" data-character-name="${m.name}"
                     class="unlink-btn" data-tooltip="${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.unlinkCharacter")}">
               <i class="fas fa-link-slash"></i>
             </button>`:`<button type="button" data-action="mapCharacter" data-character-id="${m.id}" data-character-name="${m.name}"
                     class="map-btn" data-tooltip="${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.mapCharacter")}">
               <i class="fas fa-link"></i>
             </button>`,A=m.isMapped?`<button type="button" data-action="syncCharacter" data-character-id="${m.id}" data-actor-id="${m.mappedActorId}"
                     ${t?`data-tooltip="${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.syncCharacter")}"`:`disabled data-tooltip="${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.ddbImporterRequired")}"`}
                     class="sync-btn"><i class="fas fa-sync"></i></button>`:`<button type="button" data-action="importCharacter" data-character-id="${m.id}" data-character-name="${m.name}"
                     data-tooltip="${t?game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.importCharacter"):game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.importCharacterCompendium")}"
                     class="import-btn"><i class="fas fa-download"></i></button>`;o+=`
          <li class="character-item ${p}">
            <div class="character-avatar">${S}</div>
            <div class="character-info">
              <span class="character-name">${m.name}</span>
              ${y}
            </div>
            <div class="character-actions">
              ${R}
              ${A}
            </div>
          </li>`}o+="</ul>",t||(o+=`<p class="hint ddb-importer-hint"><i class="fas fa-info-circle"></i> ${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.ddbImporterHint")}</p>`)}else o=`<p class="no-characters">${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.noCharacters")}</p>`;const a=e.querySelector(".character-list-header"),i=e.querySelector(".character-list, .no-characters, .loading-characters"),n=e.querySelector(".ddb-importer-hint");a&&a.remove(),i&&i.remove(),n&&n.remove();const r=e.querySelector(".form-group");r?r.insertAdjacentHTML("beforebegin",o):e.insertAdjacentHTML("beforeend",o),this._attachCharacterClickListeners()}async _verifyPatreonStatus(){const e=J.getSessionToken();if(!e){this._patronVerified=!1;return}try{const s=await(await fetch(`${Je}/auth/status`,{headers:{Authorization:`Bearer ${e}`}})).json();this._patronVerified=s.authenticated&&s.isPatron}catch{this._patronVerified=!1}}async _autoTestDDBConnection(){var n,r,l;const e=J.getStatus(),t=J.getSessionToken();if(!e.isPatron||!t)return;const s=I(),o=(n=v.get(s.ddbCampaignId.tag))==null?void 0:n.trim(),a=(r=v.get(s.ddbUserId.tag))==null?void 0:r.trim(),i=(l=v.get(s.ddbCobaltCookie.tag))==null?void 0:l.trim();if(!(!o||!a||!i)){this._ddbGameLogStatus="testing",this._updateDDBStatusIndicator();try{const d=await fetch(`${Je}/ddb/test`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({cobaltCookie:i,userId:a,gameId:o})}),u=await d.json();d.ok&&u.success?(this._ddbGameLogStatus="connected",this._collapseDdbSettingsFieldset()):this._ddbGameLogStatus="error"}catch(d){c.error("Auto DDB connection test failed:",[d]),this._ddbGameLogStatus="error"}this._updateDDBStatusIndicator()}}_setBulkOperationOverlay(e,t=""){var i,n;const s=(i=this.element)==null?void 0:i.querySelector(".campaign-characters"),o=(n=this.element)==null?void 0:n.querySelector(".bulk-operation-overlay");if(!o||!s)return;const a=o.querySelector(".overlay-message");a&&(a.textContent=t),e?(s.classList.add("bulk-operation-active"),o.classList.remove("hidden")):(s.classList.remove("bulk-operation-active"),o.classList.add("hidden"))}async _loadInitialData(){if(this._initialDataLoaded)return;this._initialDataLoaded=!0,J.getSessionToken()&&(await this._verifyPatreonStatus(),this._updatePatreonStatusIndicator(),this._patronVerified&&(this.render({parts:["ddbSettings"]}),await this._fetchCampaignCharacters(),this.tabGroups.primary==="ddbSettings"&&this._autoTestDDBConnection()))}async _onRender(e,t){this.element.querySelectorAll(".toggle-hint").forEach(r=>{r.addEventListener("click",()=>{this.element.querySelectorAll("p.hint:not(.on)").forEach(l=>l.classList.toggle("shown"))})});const o=this.element.querySelector('input[name="ddbCampaignId"]'),a=this.element.querySelector('input[name="ddbUserId"]'),i=this.element.querySelector('input[name="ddbCobaltCookie"]'),n=this._debounce(async()=>{var f,g,m;if(!J.isPatron())return;const r=I(),l=(f=o==null?void 0:o.value)==null?void 0:f.trim(),d=(g=a==null?void 0:a.value)==null?void 0:g.trim(),u=(m=i==null?void 0:i.value)==null?void 0:m.trim();l&&await v.set(r.ddbCampaignId.tag,l),d&&await v.set(r.ddbUserId.tag,d),u&&await v.set(r.ddbCobaltCookie.tag,u),await this._fetchCampaignCharacters()},1e3);[o,a,i].forEach(r=>{r&&r.addEventListener("input",n)}),this._attachCharacterClickListeners(),this._loadInitialData()}_attachCharacterClickListeners(){var t;const e=(t=this.element)==null?void 0:t.querySelectorAll(".character-item.mapped");e==null||e.forEach(s=>{s.style.cursor="pointer",s.addEventListener("click",o=>{var n;if(o.target.closest("button"))return;o.stopPropagation();const a=s.querySelector('[data-action="syncCharacter"]'),i=a==null?void 0:a.dataset.actorId;if(i){const r=game.actors.get(i);(n=r==null?void 0:r.sheet)==null||n.render(!0)}})})}_debounce(e,t){let s;return(...o)=>{clearTimeout(s),s=setTimeout(()=>e.apply(this,o),t)}}_updateDDBStatusIndicator(){var s;const e=(s=this.element)==null?void 0:s.querySelector(".ddb-status .status-indicator");if(!e)return;const t=this._getDDBConnectionStatusInfo(this._ddbGameLogStatus);e.className=`status-indicator ${t.cssClass}`,e.querySelector("i").className=`fas ${t.icon}`,e.querySelector("span").textContent=t.text}_collapseDdbSettingsFieldset(){var s;const e=(s=this.element)==null?void 0:s.querySelector(".collapsible-fieldset");if(!e||e.classList.contains("collapsed"))return;e.classList.add("collapsed");const t=e.querySelector(".toggle-icon");t&&(t.classList.remove("fa-caret-down"),t.classList.add("fa-caret-right"))}_updatePatreonStatusIndicator(){var s;const e=(s=this.element)==null?void 0:s.querySelector(".patreon-status .status-indicator");if(!e)return;const t=this._getPatreonStatusInfo();e.className=`status-indicator ${t.cssClass}`,e.querySelector("i").className=`fas ${t.icon}`,e.querySelector("span").textContent=t.text}updateDDBConnectionStatus(e){this._ddbGameLogStatus=e,this._updateDDBStatusIndicator(),(e==="connected"||e==="disconnected")&&this._fetchCampaignCharacters()}updatePatreonStatus(){var s;const e=(s=this.element)==null?void 0:s.querySelector(".patreon-status .status-indicator");if(!e)return;const t=this._getPatreonStatusInfo();e.className=`status-indicator ${t.cssClass}`,e.querySelector("i").className=`fas ${t.icon}`,e.querySelector("span").textContent=t.text}static getInstance(){return Object.values(ui.windows).find(e=>e instanceof ee)||null}};Z=new WeakSet,Js=async function(e,t){var l,d,u,f,g;const s=I(),o=(l=this.element.querySelector('input[name="ddbCampaignId"]'))==null?void 0:l.value,a=(d=this.element.querySelector('input[name="ddbUserId"]'))==null?void 0:d.value,i=(u=this.element.querySelector('input[name="ddbCobaltCookie"]'))==null?void 0:u.value,n=(f=this.element.querySelector('input[name="ddbNoAutoConsumeSpellSlot"]'))==null?void 0:f.checked,r=(g=this.element.querySelector('input[name="ddbImportOwnership"]'))==null?void 0:g.checked;o!==void 0&&await v.set(s.ddbCampaignId.tag,o),a!==void 0&&await v.set(s.ddbUserId.tag,a),i!==void 0&&await v.set(s.ddbCobaltCookie.tag,i),n!==void 0&&await v.set(s.ddbNoAutoConsumeSpellSlot.tag,n),r!==void 0&&await v.set(s.ddbImportOwnership.tag,r),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.settingsUpdated")),this.close()},Xs=function(e,t){const s=t.closest(".collapsible-fieldset");if(!s)return;const o=s.classList.toggle("collapsed"),a=s.querySelector(".toggle-icon");a&&(a.classList.toggle("fa-caret-down",!o),a.classList.toggle("fa-caret-right",o))},Qs=async function(e,t){console.log(`${V.ID} | Opening Patreon authentication popup`);const s=async a=>{if(a.origin!==new URL(Je).origin){console.log(`${V.ID} | Ignoring message from unexpected origin: ${a.origin}`);return}if(a.data&&a.data.type==="patreon-auth-success"){console.log(`${V.ID} | Received auth success message from popup`,a.data),window.removeEventListener("message",s);try{const i=a.data.sessionToken;i?(J.setSessionToken(i),c.log("Session token received and stored")):c.warn("No session token in auth success message");const n=await J.getInstance().validateSession(!0);c.log("Session validated successfully",[n]);const r=ee.getInstance();r&&r.rendered?(c.log("Refreshing existing dialog"),r.render()):(c.log("Opening new dialog"),new ee().render(!0)),n.isPatron?(ui.notifications.info(game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.connectionSuccess",{name:n.name||"Patron"})),Ke.initialize()):ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.patreonNotVerified"))}catch(i){c.error("Session validation failed:",[i]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.connectionFailed"))}}};if(window.addEventListener("message",s),!window.open(`${Je}/auth/patreon`,"patreon-auth","width=600,height=800,left=200,top=100")){console.error(`${V.ID} | Popup blocked`),window.removeEventListener("message",s),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.popupBlocked"));return}console.log(`${V.ID} | Popup opened, waiting for success message`),setTimeout(()=>{window.removeEventListener("message",s),console.log(`${V.ID} | Message listener timeout after 2 minutes`)},12e4)},Zs=async function(e,t){await J.getInstance().validateSession(!0),this.render()},eo=async function(e,t){await J.logout(),this.render()},to=async function(e,t){const s=J.getSessionToken();if(!s){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.notConnected"));return}try{const a=await(await fetch(`${Je}/auth/status`,{headers:{Authorization:`Bearer ${s}`}})).json();if(a.authenticated&&a.isPatron){this._patronVerified=!0,ui.notifications.info(game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.connectionSuccess",{name:a.name||"Patron"})),this._updatePatreonStatusIndicator();try{await this._fetchCampaignCharacters()}catch{c.log("Character fetch skipped - DDB settings may not be configured yet")}}else a.authenticated&&!a.isPatron?(this._patronVerified=!1,ui.notifications.warn(game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.notPatron",{reason:a.reason||"Unknown"})),this._updatePatreonStatusIndicator()):(this._patronVerified=!1,ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.connectionFailed")),this._updatePatreonStatusIndicator())}catch(o){c.error("Test connection failed:",[o]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.connectionError"))}},so=async function(e,t){var r,l,d,u,f,g;const s=J.getStatus(),o=J.getSessionToken();if(!s.isPatron||!o){await foundry.applications.api.DialogV2.prompt({window:{title:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.label")},content:`<p>${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.patreonRequired")}</p>`,ok:{label:game.i18n.localize("Close")}});return}const a=(l=(r=this.element.querySelector('input[name="ddbCampaignId"]'))==null?void 0:r.value)==null?void 0:l.trim(),i=(u=(d=this.element.querySelector('input[name="ddbUserId"]'))==null?void 0:d.value)==null?void 0:u.trim(),n=(g=(f=this.element.querySelector('input[name="ddbCobaltCookie"]'))==null?void 0:f.value)==null?void 0:g.trim();if(!a||!i||!n){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.missingDDBCredentials"));return}this._ddbGameLogStatus="testing",this._updateDDBStatusIndicator();try{const m=await fetch(`${Je}/ddb/test`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({cobaltCookie:n,userId:i,gameId:a})}),p=await m.json();m.ok&&p.success?(this._ddbGameLogStatus="connected",ui.notifications.info(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.gameLogTestSuccess")),this._collapseDdbSettingsFieldset()):(this._ddbGameLogStatus="error",ui.notifications.error(game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.gameLogTestFailed",{error:p.error||"Unknown error"})))}catch(m){c.error("Game log test failed:",[m]),this._ddbGameLogStatus="error",ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.connectionError"))}this._updateDDBStatusIndicator()},oo=async function(e,t){await this._fetchCampaignCharacters()},ao=async function(e,t){var d;const s=t.dataset.characterId,o=t.dataset.characterName,a=this,n=game.actors.filter(u=>u.type==="character").map(u=>`<option value="${u.id}">${u.name}</option>`).join(""),r=`
      <div class="form-group">
        <label>${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.selectActor")}</label>
        <select name="actorId">
          <option value="">${game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.noActor")}</option>
          ${n}
        </select>
      </div>
    `,l=await foundry.applications.api.DialogV2.prompt({window:{title:game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.mapCharacterTitle",{name:o}),icon:"fas fa-link"},content:r,ok:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.save"),icon:"fas fa-save",callback:(u,f,g)=>f.form.elements.actorId.value},rejectClose:!1});if(l){await Ke.mapCharacter(s,l),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.characterMapped")),a._updateCharacterList();const u=(d=game.modules.get("ddb-importer"))==null?void 0:d.api;if(u!=null&&u.importCharacter){const f=game.actors.get(l);if(f)try{ui.notifications.info(game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.syncingCharacter",{name:f.name})),await u.importCharacter({actor:f}),ui.notifications.info(game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.characterSynced",{name:f.name}))}catch(g){c.error("Character sync after mapping failed:",[g]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.syncFailed"))}}}},io=async function(e,t){const s=t.dataset.characterId,o=t.dataset.characterName,a=this._findActorForCharacter(s,o);if(!a.actor){await Ke.unmapCharacter(s),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.characterUnmapped")),this._updateCharacterList();return}await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.unlinkCharacter"),icon:"fas fa-link-slash"},content:`<p>${game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.unlinkConfirm",{name:a.actor.name})}</p>`,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.delete"),icon:"fas fa-trash",class:"danger"},no:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.cancelButton"),icon:"fas fa-times"},rejectClose:!1})&&(await a.actor.delete(),await Ke.unmapCharacter(s),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.characterUnmapped")),this._updateCharacterList())},no=async function(e,t){const s=t.dataset.characterId,o=t.dataset.characterName,a=this;try{ui.notifications.info(game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.importingCharacter",{name:o})),await Jo.importCharacter(s)&&a._updateCharacterList()}catch(i){c.error("Character import failed:",[i]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.importFailed"))}},ro=async function(e,t){var a,i;const s=t.dataset.actorId;if(!((a=game.modules.get("ddb-importer"))!=null&&a.active)){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.ddbImporterRequired"));return}const o=game.actors.get(s);if(!o){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.actorNotFound"));return}try{ui.notifications.info(game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.syncingCharacter",{name:o.name}));const n=(i=game.modules.get("ddb-importer"))==null?void 0:i.api;n!=null&&n.importCharacter?(await n.importCharacter({actor:o}),ui.notifications.info(game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.characterSynced",{name:o.name})),this._updateCharacterList()):ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.ddbImporterAPINotFound"))}catch(n){c.error("Character sync failed:",[n]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.syncFailed"))}},lo=async function(e,t){var d,u;if(!((d=game.modules.get("ddb-importer"))!=null&&d.active)){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.ddbImporterRequired"));return}const s=(this._campaignCharacters||[]).filter(f=>!this._findActorForCharacter(f.id,f.name).actor);if(s.length===0){ui.notifications.info(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.noCharactersToImport"));return}const o=(u=game.modules.get("ddb-importer"))==null?void 0:u.api;if(!(o!=null&&o.importCharacter)){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.ddbImporterAPINotFound"));return}let a=0,i=0;const n=I(),l=v.get(n.ddbImportOwnership.tag)??!0?CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER:CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER;for(const f of s){this._setBulkOperationOverlay(!0,game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.bulkImportProgress",{current:a+i+1,total:s.length,name:f.name}));try{const g=await Actor.create({name:f.name||"New Character",type:"character",ownership:{default:l},flags:{ddbimporter:{dndbeyond:{characterId:f.id,url:`https://www.dndbeyond.com/characters/${f.id}`}}}});await o.importCharacter({actor:g}),await Ke.mapCharacter(f.id,g.id),a++}catch(g){c.error(`Failed to import ${f.name}:`,[g]),i++}}this._setBulkOperationOverlay(!1),ui.notifications.info(game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.bulkImportComplete",{imported:a,failed:i})),this._updateCharacterList()},co=async function(e,t){var n,r;if(!((n=game.modules.get("ddb-importer"))!=null&&n.active)){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.ddbImporterRequired"));return}const s=(this._campaignCharacters||[]).filter(l=>!!this._findActorForCharacter(l.id,l.name).actor).map(l=>({...l,actor:this._findActorForCharacter(l.id,l.name).actor}));if(s.length===0){ui.notifications.info(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.noCharactersToSync"));return}const o=(r=game.modules.get("ddb-importer"))==null?void 0:r.api;if(!(o!=null&&o.importCharacter)){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.ddbImporterAPINotFound"));return}let a=0,i=0;for(const l of s){this._setBulkOperationOverlay(!0,game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.bulkSyncProgress",{current:a+i+1,total:s.length,name:l.actor.name}));try{await o.importCharacter({actor:l.actor}),a++}catch(d){c.error(`Failed to sync ${l.actor.name}:`,[d]),i++}}this._setBulkOperationOverlay(!1),ui.notifications.info(game.i18n.format("FLASH_ROLLS.settings.premiumFeatures.bulkSyncComplete",{synced:a,failed:i})),this._updateCharacterList()},fe(ee,Z),E(ee,"FLAG_LAST_TAB","premiumDialogLastTab"),E(ee,"DEFAULT_OPTIONS",{id:"flash5e-premium-features-dialog",tag:"div",window:{icon:"fas fa-gem",title:"FLASH_ROLLS.settings.premiumFeatures.title",contentClasses:["standard-form","crlngn","flash5e","tabbed-settings"],resizable:!0},position:{width:620,height:"auto"},actions:{authenticatePatreon:X(ee,Z,Qs),refreshSession:X(ee,Z,Zs),logout:X(ee,Z,eo),testConnection:X(ee,Z,to),testGameLog:X(ee,Z,so),refreshCharacters:X(ee,Z,oo),mapCharacter:X(ee,Z,ao),unlinkCharacter:X(ee,Z,io),importCharacter:X(ee,Z,no),syncCharacter:X(ee,Z,ro),importAll:X(ee,Z,lo),syncAll:X(ee,Z,co),save:X(ee,Z,Js),toggleDdbSettings:X(ee,Z,Xs)}}),E(ee,"PARTS",{tabs:{template:"templates/generic/tab-navigation.hbs"},authentication:{template:`modules/${V.ID}/templates/premium-authentication.hbs`},ddbSettings:{template:`modules/${V.ID}/templates/premium-ddb-settings.hbs`},footer:{template:"templates/generic/form-footer.hbs"}}),E(ee,"TABS",{primary:{initial:"authentication",tabs:[{id:"authentication",icon:"",group:"primary-tabs",label:"FLASH_ROLLS.settings.premiumFeatures.tabs.authentication"},{id:"ddbSettings",icon:"",group:"primary-tabs",label:"FLASH_ROLLS.settings.premiumFeatures.tabs.ddbSettings"}],labelPrefix:""}});let mt=ee;const{ApplicationV2:Zo,HandlebarsApplicationMixin:ea}=foundry.applications.api;var oe,ft,Yt;const xe=class xe extends ea(Zo){constructor(t={}){c.log("RollRequestsMenu.constructor",[t]);super(t);E(this,"_onClickOutside",t=>{const s=this.element;if(!s)return;const o=s.querySelector(".actor-filter-tooltip");if(o&&!t.target.closest(".actor-filter-tooltip")&&!t.target.closest("#flash5e-filter-actors")){o.remove();return}this.isLocked||t.target.closest(".flash-rolls-menu")||s.contains(t.target)||this.close()});this.selectedActors=new Set,this.currentTab="pc",this.selectedSubmenu="request-types",this.selectedRequestType=null,this.isLocked=game.user.getFlag(V.ID,"menuLocked")??!1,this.optionsExpanded=game.user.getFlag(V.ID,"menuOptionsExpanded")??!1,this.accordionStates=game.user.getFlag(V.ID,"menuAccordionStates")??{},this.groupExpansionStates=game.user.getFlag(V.ID,"groupExpansionStates")??{},this.isSearchFocused=game.user.getFlag("flash-rolls-5e","searchFocused")??!1,this.actorFilters=game.user.getFlag(V.ID,"actorFilters")??{inCombat:!1,visible:!1,removeDead:!1},this.isDragging=!1,this.isCustomPosition=!1,this.customPosition=Ue.loadCustomPosition()}static get DEFAULT_OPTIONS(){v.updateColorScheme();const t=["flash-rolls-menu","themed"];return v.coreColorScheme&&t.push(`theme-${v.coreColorScheme}`),{id:"flash-rolls-menu",classes:t,tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:{},dragDrop:[{dropSelector:".actor-list"}]}}async _prepareContext(t){const s=await super._prepareContext(t),o=await jo.prepareActorContext(this,s),a=I();return o.menuLayout=v.get(a.menuLayout.tag),o.maxIconsPerRow=v.get(a.maxIconsPerRow.tag)||5,o.enabledModuleIcons=ot.getEnabledIcons("moduleActions"),o.enabledActorIcons=ot.getEnabledIcons("actorActions"),o.iconConfigs=ot.getIconConfigurations(),this._lastPreparedContext=o,o}async _renderFrame(t){const s=await super._renderFrame(t),o=this.customPosition||Ue.loadCustomPosition();o!=null&&o.isCustom&&(this.isCustomPosition=!0,this.customPosition=o);const a=document.querySelector("#chat-notifications");return a&&s&&a.insertBefore(s,a.firstChild),s}_onRender(t,s){super._onRender(t,s);const o=document.querySelector("#flash-rolls-menu");if(o){const i=I();v.get(i.compactMode.tag)?o.classList.add("compact"):o.classList.remove("compact");const r=v.get(i.menuLayout.tag);o.setAttribute("data-layout",r),v.get(i.lockMenuPosition.tag)&&this.isLocked?o.classList.add("position-locked"):o.classList.remove("position-locked")}Ue.applyCustomPosition(this,this.customPosition);const a=this.element.querySelectorAll(".actor-list");if(this._boundGlobalDragEnd&&document.removeEventListener("dragend",this._boundGlobalDragEnd),a.forEach((i,n)=>{i.removeEventListener("dragover",this._boundDragOver),i.removeEventListener("drop",this._boundDrop),i.removeEventListener("dragenter",this._boundDragEnter),i.removeEventListener("dragleave",this._boundDragLeave),this._boundDragOver=r=>{this._onDragOver(r)},this._boundDrop=r=>{this._onDrop(r)},this._boundDragEnter=r=>{r.preventDefault()},this._boundDragLeave=r=>{Ct.handleDragLeave(r)},i.addEventListener("dragover",this._boundDragOver),i.addEventListener("drop",this._boundDrop),i.addEventListener("dragenter",this._boundDragEnter),i.addEventListener("dragleave",this._boundDragLeave)}),this._boundGlobalDragEnd=i=>{this._onGlobalDragEnd(i)},document.addEventListener("dragend",this._boundGlobalDragEnd),dt(),this.optionsExpanded){const i=this.element.querySelector(".options-toggle"),n=this.element.querySelector("li.options");this.element.querySelector(".options-toggle-btn"),i==null||i.classList.add("expanded"),n==null||n.classList.add("expanded")}this._tokenControlHook=Hooks.on(x.CONTROL_TOKEN,this._onTokenControlChange.bind(this)),this._updateItemHook=Hooks.on(x.UPDATE_ITEM,this._onItemUpdate.bind(this)),this._createItemHook=Hooks.on(x.CREATE_ITEM,this._onItemUpdate.bind(this)),this._deleteItemHook=Hooks.on(x.DELETE_ITEM,this._onItemUpdate.bind(this)),this._patronStatusHook=Hooks.on(`${V.ID}.patronStatusChanged`,this._onPatronStatusChange.bind(this)),$o.initializeActorDrag(this),this._updateRequestTypesVisibilityNoRender(),this._updateGemIconStatus(),Ae.attachListeners(this,this.element)}_onTokenControlChange(t,s){this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{const o=new Set(this.selectedActors);this._initializeFromSelectedTokens();const a=new Set([...o,...this.selectedActors]);for(const i of a)this._updateActorSelectionUI(i);this._updateGroupSelectionUI(),this._updateSelectAllState(),this._updateRequestTypesVisibilityNoRender(),s&&(t!=null&&t.id)&&this._scrollToActor(t.id),this._tokenUpdateTimeout=null},100)))}_onPatronStatusChange(t){this.rendered&&this._updateGemIconStatus()}_updateGemIconStatus(){if(!this.element)return;const t=this.element.querySelector("#flash5e-premium-features"),s=t==null?void 0:t.querySelector("i.fa-gem");if(!s)return;s.classList.remove("patron-connected-ddb","patron-connected","patron-disconnected");const o=J.getStatus();o.isPatron&&o.ddbConnected?s.classList.add("patron-connected-ddb","gem-icon"):o.isPatron?s.classList.add("patron-connected","gem-icon"):s.classList.add("patron-disconnected","gem-icon");const a=game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.label"),i=game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.tooltipPatreon"),n=game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.tooltipDDB"),r=o.isPatron?game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.tooltipVerified"):game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.tooltipNotVerified"),l=o.ddbConnected?game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.tooltipOn"):game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.tooltipOff"),d=`<strong>${a}</strong><br/><b>${i}</b> ${r}<br/><b>${n}</b> ${l}`;t.setAttribute("data-tooltip",d)}_scrollToActor(t){var n;if(!this.element)return;const s=(n=canvas.tokens)==null?void 0:n.get(t);if(!s)return;const o=s.document.getFlag(k,"groupId");if(o&&this.currentTab==="group"){const r=this.element.querySelector(`.actor.actor-group[data-actor-id="${o}"]`);r&&this._scrollElementIntoView(r);return}let a=this.element.querySelector(`.actor.drag-wrapper[data-id="${t}"]`);if(!a)return;if(a.closest(".group-members")){const r=a.closest(".actor.actor-group");r&&(a=r)}this._scrollElementIntoView(a)}_scrollElementIntoView(t){if(!t||!this.element)return;const s=this.element.querySelector(".main-content ul.actors > li.actor-list");if(!s)return;const o=s.getBoundingClientRect(),a=t.getBoundingClientRect();(this.element.dataset.layout==="horizontal"?a.left<o.left||a.right>o.right:a.top<o.top||a.bottom>o.bottom)&&t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}_onItemUpdate(t,s,o,a){var u,f;if(!this.rendered||!(t.type==="equipment"||((u=s.system)==null?void 0:u.equipped)!==void 0||((f=s.system)==null?void 0:f.attunement)!==void 0))return;const n=t.parent;if(!n||n.documentName!=="Actor")return;const r=this.currentTab,l=Object.entries(n.ownership).some(([g,m])=>{const p=game.users.get(g);return p&&!p.isGM&&m>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER});(r==="pc"&&l||r==="npc"&&!l&&qs(n)||r==="group")&&(this._itemUpdateTimeout&&clearTimeout(this._itemUpdateTimeout),this._itemUpdateTimeout=setTimeout(()=>{this.render(),this._itemUpdateTimeout=null},500))}async _onToggleRollRequests(t){return ie.handleToggleRollRequests(t)}async _onToggleSkipDialogs(t){return ie.handleToggleSkipDialogs(t)}async _onToggleGroupRollsMsg(t){return ie.handleToggleGroupRollsMsg(t)}_onToggleSelectAll(t){return ie.handleToggleSelectAll(t,this)}_onToggleActorFilter(t){return ie.handleToggleActorFilter(t,this)}_onToggleLock(t){return ie.handleToggleLock(t,this)}async _onToggleOptions(t){return ie.handleToggleOptions(t,this)}async _onOpenSettings(t){t.preventDefault(),t.stopPropagation(),new Mt().render(!0)}async _onOpenPremiumFeatures(t){t.preventDefault(),t.stopPropagation(),new mt().render(!0)}_onPremiumFeaturesContextMenu(t){t.preventDefault(),t.stopPropagation();const s=J.getStatus(),o=[];if(s.isPatron||o.push({name:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.contextReconnect"),icon:'<i class="fab fa-patreon"></i>',callback:()=>{new mt().render(!0)}}),o.length===0)return;new foundry.applications.ui.ContextMenu(this.element,"#flash5e-premium-features",o,{eventName:"contextmenu"}).render(t.currentTarget,{event:t})}_canDragDrop(t){return Ct.canDrop(t)}_onDragOver(t){Ct.handleDragOver(t,this)}async _onDrop(t){await Ct.handleDrop(t,this)}_onGlobalDragEnd(t){Ct.handleDragLeave(t)}async close(t={}){return this._boundGlobalDragEnd&&(document.removeEventListener("dragend",this._boundGlobalDragEnd),this._boundGlobalDragEnd=null),super.close(t)}_initializeFromSelectedTokens(){var s,o,a;c.log("_initializeFromSelectedTokens called",{_ignoreTokenControl:this._ignoreTokenControl,currentSelectedActors:Array.from(this.selectedActors),controlledTokensCount:((o=(s=canvas.tokens)==null?void 0:s.controlled)==null?void 0:o.length)||0});const t=((a=canvas.tokens)==null?void 0:a.controlled)||[];this.selectedActors.clear();for(const i of t)if(i.actor){const n=i.id;this.selectedActors.add(n)}}async _onTabClick(t){const s=t.currentTarget.dataset.tab;c.log("_onTabClick #0",[s]),this.selectedRequestType=null,this.currentTab=s,await this.render()}async _onTabDoubleClick(t){var s;t.preventDefault(),t.stopPropagation(),this._ignoreTokenControl=!0,this.selectedActors.clear(),(s=canvas.tokens)==null||s.releaseAll(),this.selectedRequestType=null,setTimeout(()=>{this._ignoreTokenControl=!1},200),await this.render(),this._updateRequestTypesVisibility()}async _onSubmenuTabClick(t){const s=t.currentTarget.dataset.tab;if(c.log("_onSubmenuTabClick",[s]),s===this.selectedSubmenu)return;this.selectedSubmenu=s,await this.render();const o=this.element.querySelector(".request-types-accordion");o&&this.selectedActors.size>0&&o.classList.add("hover-visible")}async _onStatusEffectClick(t){t.preventDefault(),t.stopPropagation();const s=t.currentTarget.dataset.id;c.log("_onStatusEffectClick",[s]),await Ys.toggleStatusOnSelected(s,this)}_onActorClick(t){if(t.target.closest(".actor-select"))return;const s=t.currentTarget,o=s.dataset.id,a=s.dataset.actorId,i=s.dataset.tokenId;s.classList.contains("actor-group")?this._toggleGroupSelection(a):this._toggleActorSelection(o,a,i)}_toggleActorSelection(t,s,o){return ie.toggleActorSelection(t,s,o,this)}async _toggleGroupSelection(t){const s=game.actors.get(t);if(!s||s.type!=="group"&&s.type!=="encounter")return;const o=game.scenes.current,i=(s.getFlag(k,"tokenAssociationsByScene")||{})[o==null?void 0:o.id]||{},n=[],r=Object.entries(i).some(([d,u])=>!Array.isArray(u)||u.length===0?!1:u.some(f=>{try{const g=fromUuidSync(f);return g&&g.actorId===d&&g.parent===o}catch{return!1}}));if(s.type==="group"){for(const d of s.system.members||[])if(d.actor){const u=d.actor.id,f=i[u]||[];if(r&&f.length>0)for(const g of f)try{const m=fromUuidSync(g);m&&m.actorId===d.actor.id&&m.parent===o&&n.push({actor:d.actor,uniqueId:m.id})}catch(m){c.log(`Failed to resolve token UUID: ${g}`,[m])}else if(!r){const g=(o==null?void 0:o.tokens.filter(m=>m.actorId===d.actor.id))||[];g.length>0?g.forEach(m=>{n.push({actor:d.actor,uniqueId:m.id})}):n.push({actor:d.actor,uniqueId:d.actor.id})}}}else if(s.type==="encounter")for(const d of s.system.members||[])try{const u=await fromUuid(d.uuid);if(u){const f=u.id,g=i[f]||[];if(r&&g.length>0)for(const m of g)try{const p=fromUuidSync(m);p&&p.actorId===u.id&&p.parent===o&&n.push({actor:u,uniqueId:p.id})}catch(p){console.warn(`Failed to resolve token UUID: ${m}`,p)}else if(!r){const m=(o==null?void 0:o.tokens.filter(p=>p.actorId===u.id))||[];m.length>0?m.forEach(p=>{n.push({actor:u,uniqueId:p.id})}):n.push({actor:u,uniqueId:u.id})}}}catch(u){console.warn(`Failed to resolve member UUID: ${d.uuid}`,u)}if(n.length===0)return;const l=n.every(d=>this.selectedActors.has(d.uniqueId));for(const d of n){const u=d.uniqueId!==d.actor.id?d.uniqueId:null;l?this.selectedActors.has(d.uniqueId)&&this._toggleActorSelection(d.uniqueId,d.actor.id,u):this.selectedActors.has(d.uniqueId)||this._toggleActorSelection(d.uniqueId,d.actor.id,u)}this._updateGroupSelectionUI(t,n)}_updateActorSelectionUI(t){return ie.updateActorSelectionUI(t,this)}_updateGroupSelectionUI(t=null,s=null){t&&s?this._updateSingleGroupSelection(t,s):((this._lastPreparedContext||{}).groups||[]).forEach(i=>{i.isGroup&&i.members&&this._updateSingleGroupSelection(i.id,i.members)})}_updateSingleGroupSelection(t,s){this.element.querySelectorAll(`[data-actor-id="${t}"].actor-group`).forEach(a=>{const i=s.filter(r=>this.selectedActors.has(r.uniqueId)).length;let n;i===0?n="false":i===s.length?n="true":n="partial",a.setAttribute("data-group-selected",n),a.classList.remove("selected")})}_updateRequestTypesVisibility(){return ie.updateRequestTypesVisibility(this)}_updateRequestTypesVisibilityNoRender(){return ie.updateRequestTypesVisibilityNoRender(this)}_updateSelectAllState(){return ie.updateSelectAllState(this)}_onSearchInput(t){const s=t.target.value.toLowerCase().trim();if(this.selectedSubmenu==="request-types"){const o=this.element.querySelector(".request-types");if(!o)return;o.querySelectorAll(".request-type-item").forEach(i=>{var d;const n=((d=i.querySelector(".request-type-name"))==null?void 0:d.textContent.toLowerCase())||"",r=i.querySelectorAll(".sub-item");let l=!1;if(r.length>0){r.forEach(g=>{var S;const p=(((S=g.querySelector(".sub-item-name"))==null?void 0:S.textContent.toLowerCase())||"").includes(s);g.classList.toggle("hidden",!p),p&&(l=!0)});const u=n.includes(s),f=s===""||u||l;if(i.classList.toggle("hidden",!f),s&&l){const g=i.querySelector(".roll-types-nested"),m=i.querySelector(".accordion-toggle");g&&m&&(g.style.display="block",m.classList.add("expanded"))}}else{const u=s===""||n.includes(s);i.classList.toggle("hidden",!u)}})}else if(this.selectedSubmenu==="status-effects"){const o=this.element.querySelector(".status-effects");if(!o)return;o.querySelectorAll(".status-effect").forEach(i=>{var d,u;const n=((d=i.querySelector(".status-effect-name"))==null?void 0:d.textContent.toLowerCase())||"",r=((u=i.dataset.id)==null?void 0:u.toLowerCase())||"",l=s===""||n.includes(s)||r.includes(s);i.classList.toggle("hidden",!l)})}}async _onAccordionToggle(t){t.stopPropagation();const o=t.target.closest(".request-type-header").closest(".request-type-item"),a=o.dataset.id,i=o.querySelector(".accordion-toggle"),n=o.querySelector(".roll-types-nested");if(!n)return;const r=i.classList.contains("expanded");i.classList.toggle("expanded",!r),n.style.display=r?"none":"flex",this.accordionStates[a]=!r,await game.user.setFlag(V.ID,"menuAccordionStates",this.accordionStates)}async _onRequestTypeClick(t){const o=t.currentTarget.dataset.id,a=V.ROLL_REQUEST_OPTIONS[o];if(!a){c.error("Unknown request type:",[o]);return}this.selectedRequestType===o?this.selectedRequestType=null:this.selectedRequestType=o,a.subList?await this.render():this.selectedRequestType&&this._triggerRoll(o,null)}_onRollTypeClick(t){c.log("_onRollTypeClick");const s=t.currentTarget.dataset.id,a=t.currentTarget.dataset.parent||this.selectedRequestType;this._triggerRoll(a,s)}async _onMacroButtonClick(t){c.log("_onMacroButtonClick");const s=t.currentTarget,o=s.dataset.id||null,a=s.dataset.parent;let i,n;if(a?(i=a,n=o):(i=o,n=null),!i){D.notify("warn","No roll type selected for macro creation");return}const r=Array.from(this.selectedActors);if(r.length===0){D.notify("warn","No actors selected for macro creation");return}const l={requestType:i,rollKey:n,actorIds:r,config:{}};try{await D.createMacro(l)}catch(d){c.error("Failed to create macro",[d]),ui.notifications.error("Failed to create macro: "+d.message)}}async _orchestrateRollsForActors(t,s,o,a,i,n){return Rt.orchestrateRollsForActors(t,s,o,a,i,n)}async _handleHitDieRefill(t){return Rt.handleHitDieRefill(t)}async _triggerRoll(t,s){return Rt.triggerRoll(t,s,this)}async _sendRollRequestToPlayer(t,s,o,a,i,n=!1,r=null){return Rt.sendRollRequestToPlayer(t,s,o,a,i,n,r)}_showConsolidatedNotification(t,s,o){return Rt.showConsolidatedNotification(t,s,o)}async _handleGMRolls(t,s,o,a){return wt.handleGMRolls(t,s,o,a)}async _handleGMRollsWithTokens(t,s,o,a){return wt.handleGMRollsWithTokens(t,s,o,a)}async _initiateRollForToken(t,s,o,a,i){return wt.initiateRollForToken(t,s,o,a,i)}async _initiateRoll(t,s,o,a){return wt.initiateRoll(t,s,o,a)}async _onClose(t){if(c.log("_onClose",[t]),!!this.element){if(this.isCustomPosition&&this.element.parentElement===document.body){const s=document.querySelector("#chat-notifications");s&&s.insertBefore(this.element,s.firstChild),this.element.style.position="",this.element.style.inset="",this.element.style.top="",this.element.style.left="",this.element.style.right="",this.element.style.bottom="",this.element.classList.remove("custom-position")}await super._onClose(t),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),game.user.setFlag(k,"searchFocused",!1),this._cleanupHooks(),this._cleanupTimeouts(),j(xe,oe)===this&&De(xe,oe,null)}}setPosition(t={}){return c.log("setPosition"),this}_cleanupHooks(){[{hook:x.CONTROL_TOKEN,property:"_tokenControlHook"},{hook:x.UPDATE_ITEM,property:"_updateItemHook"},{hook:x.CREATE_ITEM,property:"_createItemHook"},{hook:x.DELETE_ITEM,property:"_deleteItemHook"},{hook:`${V.ID}.patronStatusChanged`,property:"_patronStatusHook"}].forEach(({hook:s,property:o})=>{this[o]&&(Hooks.off(s,this[o]),this[o]=null)})}_cleanupTimeouts(){["_tokenUpdateTimeout","_actorUpdateTimeout","_itemUpdateTimeout"].forEach(s=>{this[s]&&(clearTimeout(this[s]),this[s]=null)})}static toggle(){document.querySelectorAll("#flash-rolls-menu").forEach(s=>{s.remove()}),j(this,oe)?j(this,oe).rendered?j(this,oe).close():(j(this,oe)._initializeFromSelectedTokens(),j(this,oe).render(!0)):(De(this,oe,new xe),j(this,oe)._initializeFromSelectedTokens(),j(this,oe).render(!0))}static refreshIfOpen(t=!1){if(!(!j(this,oe)||!j(this,oe).rendered)){if(t){this._performRefresh();return}j(this,ft)&&clearTimeout(j(this,ft)),De(this,ft,setTimeout(()=>{this._performRefresh(),De(this,ft,null)},j(this,Yt)))}}static _performRefresh(){!j(this,oe)||!j(this,oe).rendered||j(this,oe).render()}static getInstance(){return j(this,oe)}getSelectedActorElements(){return this.element?Array.from(this.element.querySelectorAll(".actor.drag-wrapper.selected")):[]}static showOnLoadIfEnabled(){var o;const t=I();v.get(t.showMenuOnLoad.tag)&&game.user.isGM&&(document.querySelectorAll("#flash-rolls-menu").forEach(i=>{i.remove()}),j(this,oe)?j(this,oe).rendered||j(this,oe)._initializeFromSelectedTokens():(De(this,oe,new xe),j(this,oe)._initializeFromSelectedTokens()),(o=j(this,oe))==null||o.render(!0),j(this,oe)&&(j(this,oe).isLocked=!0))}};oe=new WeakMap,ft=new WeakMap,Yt=new WeakMap,fe(xe,oe,null),fe(xe,ft,null),fe(xe,Yt,250),E(xe,"PARTS",{main:{template:`modules/${V.ID}/templates/requests-menu.hbs`}});let z=xe;class we{static async placeTokensForSelectedActors(e){if(!game.user.isGM){D.notify("warn","Only GMs can place tokens");return}if(e.selectedActors.size===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelectedForPlacement"));return}if(this._isPlacingTokens){D.notify("warn","Token placement already in progress");return}const t=[];for(const s of e.selectedActors){const o=se(s);if(o)if(o.type==="group"||o.type==="encounter"){const a=o.system.members||[];for(const i of a){const n=i.actor||(i.uuid?await fromUuid(i.uuid):null);n&&t.push(n)}}else t.push(o)}if(t.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelectedForPlacement"));return}this._actorsToPlace=t,this._placementIndex=0,this._isPlacingTokens=!0,await this._createPreviewTokens(),this._attachCanvasHandlers(),D.notify("info",`Click to place ${t.length} token(s) one at a time, right-click to skip current token`)}static async _createPreviewTokens(){this._previewTokens=[];for(const e of this._actorsToPlace){const t=e.isToken?e.baseActor:e,o={...(await t.getTokenDocument()).toObject(),x:0,y:0,alpha:.5,actorLink:!1};this._previewTokens.push({actor:t,data:o})}}static _attachCanvasHandlers(){this._canvasMoveHandler=e=>this._onCanvasMouseMove(e),this._canvasClickHandler=e=>this._onCanvasClick(e),this._canvasRightClickHandler=e=>this._onCanvasRightClick(e),this._canvasRightDownHandler=e=>{this._rightMouseDown=!0},this._canvasRightUpHandler=e=>{this._rightMouseDown=!1},canvas.stage.on("mousemove",this._canvasMoveHandler),canvas.stage.on("click",this._canvasClickHandler),canvas.stage.on("rightclick",this._canvasRightClickHandler),canvas.stage.on("rightdown",this._canvasRightDownHandler),canvas.stage.on("rightup",this._canvasRightUpHandler)}static async _onCanvasMouseMove(e){var n;if(!this._isPlacingTokens||this._placementIndex>=this._previewTokens.length)return;const t=e.data.getLocalPosition(canvas.tokens),s=canvas.grid.getSnappedPoint({x:t.x,y:t.y},{mode:CONST.GRID_SNAPPING_MODES.CENTER});if((n=canvas.controls)!=null&&n.children)try{const r=Array.from(canvas.controls.children);for(const l of r)l._flashRollsPlacementPreview&&(canvas.controls.removeChild(l),l.destroy&&l.destroy())}catch(r){c.warn("Error clearing preview graphics",r)}const a=this._previewTokens[this._placementIndex].data,i=canvas.grid.size;try{const r=await foundry.canvas.loadTexture(a.texture.src),l=new PIXI.Sprite(r),d=a.width*i,u=a.height*i;l.anchor.set(0),l.x=s.x-d/2,l.y=s.y-u/2,l.width=d,l.height=u,l.alpha=.5,l.tint=52479,l._flashRollsPlacementPreview=!0,canvas.controls&&canvas.controls.addChild(l);const f=`${this._placementIndex+1}/${this._previewTokens.length}`,g=new PIXI.Text(f,{fontSize:20,fill:16777215,stroke:0,strokeThickness:4});g.anchor.set(.5),g.x=s.x,g.y=s.y-u/2-20,g._flashRollsPlacementPreview=!0,canvas.controls&&canvas.controls.addChild(g)}catch(r){c.warn("Error drawing placement preview",r)}}static async _onCanvasClick(e){if(!this._isPlacingTokens||this._placementIndex>=this._previewTokens.length)return;const t=e.data.getLocalPosition(canvas.tokens),s=canvas.grid.getSnappedPoint({x:t.x,y:t.y},{mode:CONST.GRID_SNAPPING_MODES.CENTER}),o=canvas.grid.size,a=this._previewTokens[this._placementIndex],i={...a.data,x:s.x-a.data.width*o/2,y:s.y-a.data.height*o/2,alpha:1,actorLink:!1};try{if(await canvas.scene.createEmbeddedDocuments("Token",[i]),this._placementIndex++,this._placementIndex>=this._previewTokens.length){const n=this._previewTokens.length;this._cleanup(),D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.tokensPlaced",{count:n}))}}catch(n){c.error("Failed to create token",[n,a.actor.name])}}static _onCanvasRightClick(e){this._isPlacingTokens&&(this._placementIndex>=this._previewTokens.length||this._rightMouseDown||(e.stopPropagation(),this._previewTokens.splice(this._placementIndex,1),this._actorsToPlace.splice(this._placementIndex,1),this._previewTokens.length===0||this._placementIndex>=this._previewTokens.length?(this._cleanup(),D.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.tokenPlacementCancelled"))):this._clearPreviewGraphics()))}static _clearPreviewGraphics(){var e;if((e=canvas.controls)!=null&&e.children)try{const t=Array.from(canvas.controls.children);for(const s of t)s._flashRollsPlacementPreview&&(canvas.controls.removeChild(s),s.destroy&&s.destroy())}catch(t){c.warn("Error clearing preview graphics",t)}}static _cleanup(){this._isPlacingTokens=!1,this._previewTokens=[],this._actorsToPlace=[],this._placementIndex=0,this._canvasMoveHandler&&(canvas.stage.off("mousemove",this._canvasMoveHandler),this._canvasMoveHandler=null),this._canvasClickHandler&&(canvas.stage.off("click",this._canvasClickHandler),this._canvasClickHandler=null),this._canvasRightClickHandler&&(canvas.stage.off("rightclick",this._canvasRightClickHandler),this._canvasRightClickHandler=null),this._canvasRightDownHandler&&(canvas.stage.off("rightdown",this._canvasRightDownHandler),this._canvasRightDownHandler=null),this._canvasRightUpHandler&&(canvas.stage.off("rightup",this._canvasRightUpHandler),this._canvasRightUpHandler=null),this._rightMouseDown=!1,this._clearPreviewGraphics()}static isPlacing(){return this._isPlacingTokens}static async placeTokensAtLocation(e,t){if(!game.user.isGM){D.notify("warn","Only GMs can place tokens");return}if(!e||e.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelectedForPlacement"));return}if(!t||typeof t.x!="number"||typeof t.y!="number"){ui.notifications.error("Invalid location provided for token placement");return}const s=[];for(const n of e){const r=se(n);if(!r){c.warn(`Could not find actor for ID: ${n}`);continue}if(r.type==="group"||r.type==="encounter"){const l=r.system.members||[];for(const d of l){const u=d.actor||(d.uuid?await fromUuid(d.uuid):null);u&&s.push(u)}}else s.push(r)}if(s.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelectedForPlacement")),c.warn("No valid actors found for placement",e);return}const o=canvas.grid.getSnappedPoint({x:t.x,y:t.y},{mode:CONST.GRID_SNAPPING_MODES.CENTER}),a=canvas.grid.size,i=[];for(const n of s){const r=n.isToken?n.baseActor:n,l=await r.getTokenDocument(),d={...l.toObject(),x:o.x-l.width*a/2,y:o.y-l.height*a/2,alpha:1,actorLink:!1};try{const u=await canvas.scene.createEmbeddedDocuments("Token",[d]);i.push(...u)}catch(u){c.error("Failed to create token",[u,r.name])}}}}E(we,"_isPlacingTokens",!1),E(we,"_previewTokens",[]),E(we,"_actorsToPlace",[]),E(we,"_placementIndex",0),E(we,"_canvasClickHandler",null),E(we,"_canvasRightClickHandler",null),E(we,"_canvasMoveHandler",null),E(we,"_canvasRightDownHandler",null),E(we,"_canvasRightUpHandler",null),E(we,"_rightMouseDown",!1);const ta=Object.freeze(Object.defineProperty({__proto__:null,TokenPlacementManager:we},Symbol.toStringTag,{value:"Module"}));class ae{static async teleportSelectedTokens(e){if(!game.user.isGM){D.notify("warn","Only GMs can teleport tokens");return}if(e.selectedActors.size===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensSelectedForTeleport"));return}if(this._isTeleporting){D.notify("warn","Teleportation already in progress");return}const t=[],s=[];for(const o of e.selectedActors){const a=se(o);if(!a)continue;const i=game.actors.get(o)?null:o,n=i?canvas.tokens.get(i):canvas.tokens.placeables.find(r=>{var l;return((l=r.actor)==null?void 0:l.id)===a.id});n&&(t.push(n),s.push({id:n.id,sceneId:canvas.scene.id,x:n.document.x,y:n.document.y,width:n.document.width,height:n.document.height,documentData:n.document.toObject()}))}if(t.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensSelectedForTeleport"));return}this._tokensToTeleport=t,this._tokenDataToTeleport=s,this._sourceScene=canvas.scene,this._targetScene=canvas.scene,this._isTeleporting=!0,await this._enterPlacementMode()}static _getTokensFromData(){const e=[];for(const t of this._tokenDataToTeleport){const s=game.scenes.get(t.sceneId);if(!s)continue;const o=s.tokens.get(t.id);if(o){const a=canvas.scene.id===t.sceneId?canvas.tokens.get(t.id):null;e.push(a||{document:o,id:t.id})}}return e}static async _enterPlacementMode(e=!0){var o;this._targetScene.id===this._sourceScene.id&&this._getTokensFromData().forEach(i=>{i.alpha!==void 0&&(i.alpha=.5)}),this._attachCanvasHandlers();const t=((o=this._tokenDataToTeleport)==null?void 0:o.length)||0,s=this._targetScene.name;c.log(`Teleport ready with ${t} tokens on scene: ${s}`,this._tokenDataToTeleport),e&&D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.teleportReady",{count:t}))}static async _onSceneChange(){var e,t,s,o,a,i;if(!this._isTeleporting){c.log("_onSceneChange called but not teleporting");return}if(((e=this._targetScene)==null?void 0:e.id)===((t=canvas.scene)==null?void 0:t.id)){c.log("_onSceneChange - Same scene, skipping");return}c.log("_onSceneChange - Before cleanup",{currentScene:(s=canvas.scene)==null?void 0:s.name,targetScene:(o=this._targetScene)==null?void 0:o.name,tokenCount:(a=this._tokenDataToTeleport)==null?void 0:a.length,hasHandlers:{move:!!this._canvasMoveHandler,click:!!this._canvasClickHandler,rightclick:!!this._canvasRightClickHandler}}),this._targetScene=canvas.scene,c.log(`Scene changed to ${this._targetScene.name} during teleport`,this._tokenDataToTeleport),this._removeCanvasHandlers(),this._clearPreviewGraphics(),c.log("_onSceneChange - About to re-enter placement mode",{canvasReady:!!(canvas!=null&&canvas.stage),sceneId:(i=this._targetScene)==null?void 0:i.id}),setTimeout(async()=>{await this._enterPlacementMode(!1),c.log("_onSceneChange - After re-entering placement mode",{hasHandlers:{move:!!this._canvasMoveHandler,click:!!this._canvasClickHandler,rightclick:!!this._canvasRightClickHandler}})},100)}static _attachCanvasHandlers(){if(c.log("Attaching canvas handlers for teleportation"),this._canvasMoveHandler=e=>this._onCanvasMouseMove(e),this._canvasClickHandler=e=>this._onCanvasClick(e),this._canvasRightClickHandler=e=>this._onCanvasRightClick(e),this._canvasRightDownHandler=e=>{const t=e.data.getLocalPosition(canvas.tokens);this._rightMouseDownPosition={x:t.x,y:t.y},this._hasDragged=!1},this._canvasRightUpHandler=e=>{setTimeout(()=>{this._rightMouseDownPosition=null,this._hasDragged=!1},300)},this._escapeKeyHandler=e=>{e.key==="Escape"&&this._isTeleporting&&(e.preventDefault(),e.stopPropagation(),c.log("Cancelling teleport via ESC key"),this._cleanup(),D.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.teleportCancelled")))},!(canvas!=null&&canvas.stage)){c.warn("Canvas stage not available");return}canvas.stage.on("mousemove",this._canvasMoveHandler),canvas.stage.on("click",this._canvasClickHandler),canvas.stage.on("rightclick",this._canvasRightClickHandler),canvas.stage.on("rightdown",this._canvasRightDownHandler),canvas.stage.on("rightup",this._canvasRightUpHandler),document.addEventListener("keydown",this._escapeKeyHandler),c.log("Canvas handlers attached successfully")}static async _onCanvasMouseMove(e){var l;if(this._rightMouseDownPosition){const d=e.data.getLocalPosition(canvas.tokens);Math.sqrt(Math.pow(d.x-this._rightMouseDownPosition.x,2)+Math.pow(d.y-this._rightMouseDownPosition.y,2))>5&&(this._hasDragged=!0)}if(!this._isTeleporting||!this._targetScene||this._tokenDataToTeleport.length===0||this._isPerformingTeleport||!(canvas!=null&&canvas.controls))return;const t=e.data.getLocalPosition(canvas.tokens),s=this._snapToHalfGrid(t.x,t.y);if((l=canvas.controls)!=null&&l.children)try{const d=Array.from(canvas.controls.children);for(const u of d)u!==this._cursorIndicator&&u._flashRollsTeleportPreview&&(canvas.controls.removeChild(u),u.destroy&&u.destroy())}catch(d){c.warn("Error clearing preview graphics",d)}const o=this._sourceScene.grid.size,a=canvas.grid.size,i=this._calculateBoundingBox(this._tokenDataToTeleport,o),n=i.x+i.width/2,r=i.y+i.height/2;this._targetScene.id,this._sourceScene.id;try{for(let d=0;d<this._tokenDataToTeleport.length;d++){const u=this._tokenDataToTeleport[d],f=this._sourceScene.tokens.get(u.id);if(!f)continue;const g=u.width*o,m=u.height*o,p=u.x+g/2,S=u.y+m/2,y=(p-n)/o,R=(S-r)/o,A=s.x+y*a,_=s.y+R*a,T=u.width*a,b=u.height*a,C=A-T/2,w=_-b/2,M=await foundry.canvas.loadTexture(f.texture.src),O=new PIXI.Sprite(M);O.anchor.set(0),O.x=C,O.y=w,O.width=T,O.height=b,O.alpha=.5,O.tint=52479,O._flashRollsTeleportPreview=!0,canvas.controls.addChild(O)}}catch(d){c.warn("Error drawing teleport preview",d);return}}static async _onCanvasClick(e){if(!this._isTeleporting||this._isPerformingTeleport)return;const t=e.data.getLocalPosition(canvas.tokens),s=this._snapToHalfGrid(t.x,t.y);await this._performTeleport(s)}static async _performTeleport(e){this._isPerformingTeleport=!0;const t=this._sourceScene.grid.size,s=this._calculateBoundingBox(this._tokenDataToTeleport,t),o=s.x+s.width/2,a=s.y+s.height/2,i=this._targetScene.id===this._sourceScene.id;try{i?await this._performSameSceneTeleport(e,o,a,t):await this._performCrossSceneTeleport(e,o,a,t)}catch(n){c.error("Failed to teleport tokens",[n]),ui.notifications.error("Failed to teleport tokens"),this._isPerformingTeleport=!1,this._cleanup()}}static async _performSameSceneTeleport(e,t,s,o){const a=I(),i=v.get(a.teleportAnimationPath.tag),n=this._getTokensFromData();if(n.length===0)return D.notify("warn","No valid tokens found for teleportation"),this._cleanup(),[];const r=this._tokenDataToTeleport.map(g=>({_id:g.id,alpha:.3}));await this._sourceScene.updateEmbeddedDocuments("Token",r,{animate:!1}),(i||this._hasJB2A())&&await this._playDepartureAnimations(n);const l=[],d=[];for(const g of this._tokenDataToTeleport){const m=g.width*o,p=g.height*o,S=g.x+m/2,y=g.y+p/2,R=S-t,A=y-s,_=e.x+R,T=e.y+A,b=this._sourceScene.grid.getSnappedPoint({x:_,y:T},{mode:CONST.GRID_SNAPPING_MODES.CENTER}),C=b.x-m/2,w=b.y-p/2;l.push({_id:g.id,x:C,y:w,alpha:.3}),d.push({x:b.x,y:b.y})}await this._sourceScene.updateEmbeddedDocuments("Token",l,{animate:!1}),(i||this._hasJB2A())&&await this._playArrivalAnimations(d);const u=this._tokenDataToTeleport.map(g=>({_id:g.id,alpha:1}));await this._sourceScene.updateEmbeddedDocuments("Token",u,{animate:!1});const f=this._tokenDataToTeleport.map(g=>g.id);return this._tokenDataToTeleport.length,this._cleanup(),f}static async _performCrossSceneTeleport(e,t,s,o){const a=I(),i=v.get(a.teleportAnimationPath.tag),n=this._getTokensFromData();if(n.length===0)return D.notify("warn","No valid tokens found for teleportation"),this._cleanup(),[];const r=this._tokenDataToTeleport.map(m=>({_id:m.id,alpha:.3}));await this._sourceScene.updateEmbeddedDocuments("Token",r,{animate:!1}),(i||this._hasJB2A())&&await this._playDepartureAnimations(n),await this._sourceScene.deleteEmbeddedDocuments("Token",this._tokenDataToTeleport.map(m=>m.id));const l=this._targetScene.grid.size,d=[],u=[];for(const m of this._tokenDataToTeleport){const p=m.width*o,S=m.height*o,y=m.x+p/2,R=m.y+S/2,A=(y-t)/o,_=(R-s)/o,T=e.x+A*l,b=e.y+_*l,C=this._targetScene.grid.getSnappedPoint({x:T,y:b},{mode:CONST.GRID_SNAPPING_MODES.CENTER}),w=m.width*l,M=m.height*l,O=C.x-w/2,F=C.y-M/2,N=foundry.utils.duplicate(m.documentData);N.x=O,N.y=F,d.push(N),u.push({x:C.x,y:C.y})}const f=await this._targetScene.createEmbeddedDocuments("Token",d.map(m=>({...m,alpha:.3})));(i||this._hasJB2A())&&await this._playArrivalAnimations(u),await this._targetScene.updateEmbeddedDocuments("Token",f.map(m=>({_id:m.id,alpha:1})));const g=f.map(m=>m.id);return this._cleanup(),g}static async _playTeleportAnimations(e,t,s){await this._playDepartureAnimations(e),await new Promise(a=>setTimeout(a,100));const o=e.map(a=>{const i=a.document.x-s.x,n=a.document.y-s.y;return{x:t.x+i+a.document.width*canvas.grid.size/2,y:t.y+n+a.document.height*canvas.grid.size/2}});await this._playArrivalAnimations(o)}static async _playDepartureAnimations(e){const t=I();let s=v.get(t.teleportAnimationPath.tag);if(!s&&this._hasJB2A()&&(s=await this._getDefaultJB2APath()),!!s&&this._hasSequencer()){const o=canvas.grid.size;for(const a of e){const i=a.document.x+a.document.width*o/2,n=a.document.y+a.document.height*o/2;new Sequence().effect().file(s).atLocation({x:i,y:n}).scale(.5).fadeIn(50).fadeOut(100).forUsers(game.users.map(r=>r.id)).play()}await new Promise(a=>setTimeout(a,400))}}static async _playArrivalAnimations(e){const t=I();let s=v.get(t.teleportAnimationPath.tag);if(!s&&this._hasJB2A()&&(s=await this._getDefaultJB2APath()),!!s&&this._hasSequencer()){for(const o of e)new Sequence().effect().file(s).atLocation(o).scale(.5).fadeIn(50).fadeOut(100).forUsers(game.users.map(a=>a.id)).play();await new Promise(o=>setTimeout(o,250))}}static _getJB2AModule(){return game.modules.get("JB2A_DnD5e")||game.modules.get("jb2a_patreon")}static _hasJB2A(){const e=this._getJB2AModule();return e==null?void 0:e.active}static _hasSequencer(){var e;return(e=game.modules.get("sequencer"))==null?void 0:e.active}static async _getDefaultJB2APath(){var t;if(this._hasSequencer()&&((t=window.Sequencer)!=null&&t.Database)){const s=["jb2a.teleportation.circle.blue","jb2a.teleport.circle.blue","jb2a.teleportation.blue"];for(const o of s)if(Sequencer.Database.entryExists(o))return c.log(`Found JB2A teleport animation via Sequencer: ${o}`),o}const e=this._getJB2AModule();if(e!=null&&e.active){const o=`modules/${e.id}/Library/Generic/Energy/Teleport/Teleport01_01_Regular_Blue_500x300.webm`;return c.log(`Using JB2A teleport animation file path: ${o}`),o}return c.warn("JB2A module not found, animations disabled"),null}static _createCursorIndicator(){var a;if(!((a=canvas==null?void 0:canvas.controls)!=null&&a.ruler)){c.warn("Canvas controls not ready for cursor indicator");return}if(this._cursorIndicator&&(this._cursorIndicator.destroy({children:!0}),this._cursorIndicator=null),this._cursorAnimation&&(clearInterval(this._cursorAnimation),this._cursorAnimation=null),!(canvas!=null&&canvas.controls)){c.warn("Canvas controls not available for cursor indicator");return}this._cursorIndicator=new PIXI.Container,this._cursorIndicator.zIndex=1e3,canvas.controls.addChild(this._cursorIndicator);const e=new PIXI.Graphics;e.lineStyle(3,65280,1),e.drawCircle(0,0,20),this._cursorIndicator.addChild(e);const t=new PIXI.Graphics;t.lineStyle(3,65280,.6),t.drawCircle(0,0,30),this._cursorIndicator.addChild(t);const s=new PIXI.Graphics;s.lineStyle(3,65280,.3),s.drawCircle(0,0,40),this._cursorIndicator.addChild(s);let o=0;this._cursorAnimation=setInterval(()=>{if(!this._cursorIndicator||!this._cursorIndicator.parent){this._cursorAnimation&&(clearInterval(this._cursorAnimation),this._cursorAnimation=null);return}o+=.05;const i=1+Math.sin(o)*.3,n=1+Math.sin(o+1)*.3,r=1+Math.sin(o+2)*.3;e.alpha=.8+Math.sin(o)*.2,t.alpha=.5+Math.sin(o+1)*.3,s.alpha=.3+Math.sin(o+2)*.2,e.scale.set(i),t.scale.set(n),s.scale.set(r)},50),c.log("Cursor indicator created and animation started")}static _onCanvasRightClick(e){if(this._isTeleporting){if(this._hasDragged){c.log("Ignoring right-click due to drag");return}e.stopPropagation(),c.log("Cancelling teleport via right-click"),this._cleanup(),D.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.teleportCancelled"))}}static _calculateCenterPoint(e){if(e.length===0)return{x:0,y:0};const t=e.reduce((s,o)=>({x:s.x+o.x,y:s.y+o.y}),{x:0,y:0});return{x:t.x/e.length,y:t.y/e.length}}static _snapToHalfGrid(e,t){const o=canvas.grid.size/2,a=Math.round(e/o)*o,i=Math.round(t/o)*o;return{x:a,y:i}}static _calculateBoundingBox(e,t){if(e.length===0)return{x:0,y:0,width:0,height:0};let s=1/0,o=1/0,a=-1/0,i=-1/0;for(const n of e){const r=n.width*t,l=n.height*t;s=Math.min(s,n.x),o=Math.min(o,n.y),a=Math.max(a,n.x+r),i=Math.max(i,n.y+l)}return{x:s,y:o,width:a-s,height:i-o}}static _calculateRelativePositions(e){const t=e.map(o=>({x:o.document.x,y:o.document.y})),s=this._calculateCenterPoint(t);return e.map(o=>({token:o,relativeX:o.document.x-s.x,relativeY:o.document.y-s.y}))}static _removeCanvasHandlers(){var e,t,s,o,a;this._canvasMoveHandler&&((e=canvas.stage)==null||e.off("mousemove",this._canvasMoveHandler),this._canvasMoveHandler=null),this._canvasClickHandler&&((t=canvas.stage)==null||t.off("click",this._canvasClickHandler),this._canvasClickHandler=null),this._canvasRightClickHandler&&((s=canvas.stage)==null||s.off("rightclick",this._canvasRightClickHandler),this._canvasRightClickHandler=null),this._canvasRightDownHandler&&((o=canvas.stage)==null||o.off("rightdown",this._canvasRightDownHandler),this._canvasRightDownHandler=null),this._canvasRightUpHandler&&((a=canvas.stage)==null||a.off("rightup",this._canvasRightUpHandler),this._canvasRightUpHandler=null),this._escapeKeyHandler&&(document.removeEventListener("keydown",this._escapeKeyHandler),this._escapeKeyHandler=null)}static _cleanup(){this._getTokensFromData().forEach(t=>{t.alpha!==void 0&&(t.alpha=1)}),this._clearPreviewGraphics(),this._isTeleporting=!1,this._isPerformingTeleport=!1,this._tokensToTeleport=[],this._tokenDataToTeleport=[],this._sourceScene=null,this._targetScene=null,this._rightMouseDown=!1,this._rightMouseDownPosition=null,this._removeCanvasHandlers()}static _clearPreviewGraphics(){var e;if((e=canvas==null?void 0:canvas.controls)!=null&&e.children){try{const t=Array.from(canvas.controls.children);for(const s of t)s._flashRollsTeleportPreview&&(canvas.controls.removeChild(s),s.destroy())}catch(t){c.warn("Error clearing preview graphics",t)}this._rightMouseDown=!1,this._rightMouseDownPosition=null}}static isTeleporting(){return this._isTeleporting}static async teleportToDestination(e,t,s){if(!game.user.isGM){D.notify("warn","Only GMs can teleport tokens");return}if(this._isPerformingTeleport&&(c.log("Teleport already in progress, queueing..."),await new Promise(m=>{const p=setInterval(()=>{this._isPerformingTeleport||(clearInterval(p),m())},50)})),!e||e.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensSelectedForTeleport"));return}if(!t||!s||typeof s.x!="number"||typeof s.y!="number"){ui.notifications.error("Invalid destination scene or location provided for teleportation");return}let o;if(typeof t=="string"){if(o=game.scenes.get(t)||game.scenes.getName(t),!o){ui.notifications.error(`Scene "${t}" not found`);return}}else if(t instanceof Scene)o=t;else{ui.notifications.error("Invalid destination scene provided");return}const a=[],i=[],n=[];for(const m of e){const p=canvas.tokens.get(m);p?(a.push(p),i.push({id:p.id,sceneId:canvas.scene.id,x:p.document.x,y:p.document.y,width:p.document.width,height:p.document.height,documentData:p.document.toObject()})):n.push(m)}if(n.length>0)if(c.warn(`Invalid token IDs provided: ${n.join(", ")}`),a.length===0){ui.notifications.error("No valid tokens found. Ensure you're using token IDs, not actor IDs.");return}else D.notify("warn",`Some token IDs were invalid and skipped. ${a.length} token(s) will be teleported.`);if(a.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensSelectedForTeleport"));return}this._tokensToTeleport=a,this._tokenDataToTeleport=i,this._sourceScene=canvas.scene,this._targetScene=o,this._isTeleporting=!0,this._isPerformingTeleport=!0;const r=o.grid.getSnappedPoint(s,{mode:CONST.GRID_SNAPPING_MODES.CENTER}),l=canvas.scene.grid.size,d=this._calculateBoundingBox(i,l),u=d.x+d.width/2,f=d.y+d.height/2;let g=[];try{o.id===canvas.scene.id?g=await this._performSameSceneTeleport(r,u,f,l):(await o.view(),g=await this._performCrossSceneTeleport(r,u,f,l))}catch(m){throw c.error("Error during teleportation",[m]),this._cleanup(),m}if(g.length>0){await new Promise(p=>setTimeout(p,50));const m=g.map(p=>canvas.tokens.get(p)).filter(p=>p);if(m.length>0){canvas.tokens.releaseAll(),m.forEach(y=>y.control({releaseOthers:!1}));const p=m.reduce((y,R)=>y+R.center.x,0)/m.length,S=m.reduce((y,R)=>y+R.center.y,0)/m.length;await canvas.animatePan({x:p,y:S,duration:150})}}}}E(ae,"_isTeleporting",!1),E(ae,"_isPerformingTeleport",!1),E(ae,"_tokensToTeleport",[]),E(ae,"_tokenDataToTeleport",[]),E(ae,"_sourceScene",null),E(ae,"_canvasClickHandler",null),E(ae,"_canvasRightClickHandler",null),E(ae,"_canvasMoveHandler",null),E(ae,"_canvasRightDownHandler",null),E(ae,"_canvasRightUpHandler",null),E(ae,"_escapeKeyHandler",null),E(ae,"_targetScene",null),E(ae,"_rightMouseDown",!1),E(ae,"_rightMouseDownPosition",null),E(ae,"_hasDragged",!1);const sa=Object.freeze(Object.defineProperty({__proto__:null,TokenTeleportManager:ae},Symbol.toStringTag,{value:"Module"})),{ApplicationV2:oa,HandlebarsApplicationMixin:aa}=foundry.applications.api,{FormDataExtended:ia}=foundry.applications.ux;var it,uo,go,fo;const et=class et extends aa(oa){static async show(e){return new Promise(t=>{new this({actors:e,resolve:t}).render(!0)})}constructor(e={}){super(e),this.actors=e.actors||[],this.resolve=e.resolve,this.selectedActorUuid=null,this.selectedActorName="",this.selectedPreset="polymorph",this.showCustomSettings=!1}async _prepareContext(e){return await super._prepareContext(e)}async _preparePartContext(e,t,s){switch(t=await super._preparePartContext(e,t,s),e){case"content":{t.actors=this.actors,t.actorCount=this.actors.length,t.actorNames=this.actors.map(i=>i.name).join(", "),t.selectedActorName=this.selectedActorName;const o=game.settings.get("flash-rolls-5e","transform-favorites")||[],a=new Set(o);t.favorites=[];for(const i of o){const n=await fromUuid(i);n&&t.favorites.push({uuid:i,name:n.name,img:n.img})}if(this.selectedActorUuid){const i=await fromUuid(this.selectedActorUuid);t.selectedActor={uuid:this.selectedActorUuid,name:this.selectedActorName,img:i==null?void 0:i.img,isFavorite:a.has(this.selectedActorUuid)}}else t.selectedActor=null;t.selectedPreset=this.selectedPreset,t.showCustomSettings=this.showCustomSettings,t.presets=[{value:"polymorph",label:"FLASH_ROLLS.ui.dialogs.transformation.presets.polymorph",description:"FLASH_ROLLS.ui.dialogs.transformation.presets.polymorphDesc"},{value:"wildshape",label:"FLASH_ROLLS.ui.dialogs.transformation.presets.wildshape",description:"FLASH_ROLLS.ui.dialogs.transformation.presets.wildshapeDesc"},{value:"appearance",label:"FLASH_ROLLS.ui.dialogs.transformation.presets.appearance",description:"FLASH_ROLLS.ui.dialogs.transformation.presets.appearanceDesc"},{value:"custom",label:"FLASH_ROLLS.ui.dialogs.transformation.presets.custom",description:"FLASH_ROLLS.ui.dialogs.transformation.presets.customDesc"}];break}case"footer":{t.buttons=[{type:"button",icon:"fa-solid fa-times",label:"FLASH_ROLLS.ui.buttons.cancelButton",action:"cancel"},{type:"button",icon:"fa-solid fa-wand-magic-sparkles",label:"FLASH_ROLLS.ui.dialogs.transformation.transform",action:"transform"}];break}}return t}_onRender(e,t){super._onRender(e,t);const s=this.element.querySelector(".select-actor-btn"),o=this.element.querySelector(".actor-image-container"),a=this.element.querySelector(".actor-image-placeholder"),i=this.element.querySelector(".clear-actor-btn"),n=this.element.querySelector(".preset-selector"),r=this.element.querySelectorAll(".favorite-item"),l=this.element.querySelectorAll(".toggle-favorite-btn"),d=this.element.querySelector(".form-group.favorites-section"),u=this.element.querySelector(".selected-actor-preview .actor-image-container img");s&&s.addEventListener("click",f=>{f.preventDefault(),this._onSelectActor()}),o&&o.addEventListener("click",f=>{f.target.closest(".toggle-favorite-btn")||(f.preventDefault(),this._onSelectActor())}),a&&a.addEventListener("click",f=>{f.preventDefault(),this._onSelectActor()}),i&&i.addEventListener("click",f=>{f.preventDefault(),this._onClearActor()}),n&&n.addEventListener("change",f=>this._onPresetChange(f)),r.forEach(f=>{f.addEventListener("click",g=>{g.target.closest(".toggle-favorite-btn")||this._onSelectFavorite(f.dataset.uuid)})}),l.forEach(f=>{const g=f.dataset.isFavorite==="true";f.title=g?game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.removeFromFavorites"):game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.addToFavorites"),f.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),this._onToggleFavorite(f.dataset.uuid)})}),d&&this._setupDragAndDrop(d),u&&u.addEventListener("error",()=>{u.classList.add("hidden")})}_setupDragAndDrop(e){e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="copy",e.classList.add("drag-over")}),e.addEventListener("dragleave",t=>{t.target===e&&e.classList.remove("drag-over")}),e.addEventListener("drop",async t=>{t.preventDefault(),e.classList.remove("drag-over");const s=TextEditor.getDragEventData(t);if(s.type==="Actor"){const o=await fromUuid(s.uuid);o&&o.type==="npc"?await this._onToggleFavorite(s.uuid):o&&o.type!=="npc"&&D.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.onlyNPCs"))}})}async _onSelectActor(){const e=await this._showActorBrowser();if(e){this.selectedActorUuid=e;const t=await fromUuid(e);t&&(this.selectedActorName=t.name,this.render(!0))}}async _showActorBrowser(){return dnd5e.applications.CompendiumBrowser.selectOne({tab:"monsters",filters:{locked:{documentClass:"Actor",types:new Set(["npc"])}}})}_onClearActor(){this.selectedActorUuid=null,this.selectedActorName="",this.render(!0)}async _onSelectFavorite(e){const t=await fromUuid(e);if(t){const s=!this.selectedActorUuid;if(this.selectedActorUuid=e,this.selectedActorName=t.name,s){this.render(!0);return}const o=this.element.querySelector(".selected-actor-preview .actor-image-container"),a=o==null?void 0:o.querySelector("img"),i=this.element.querySelector(".selected-actor-preview .toggle-favorite-btn"),n=this.element.querySelector(".selected-actor-preview");if(a&&o&&(a.src=t.img,a.alt=t.name,a.classList.remove("hidden")),i){i.dataset.uuid=e;const r=i.querySelector("i"),d=(game.settings.get("flash-rolls-5e","transform-favorites")||[]).includes(e);r&&(d?r.classList.remove("faded"):r.classList.add("faded")),i.title=game.i18n.localize(d?"FLASH_ROLLS.ui.dialogs.transformation.removeFromFavorites":"FLASH_ROLLS.ui.dialogs.transformation.addToFavorites")}n&&(n.dataset.tooltip=t.name)}}async _onToggleFavorite(e){const t=game.settings.get("flash-rolls-5e","transform-favorites")||[],s=new Set(t),o=s.has(e);if(o?s.delete(e):s.add(e),await game.settings.set("flash-rolls-5e","transform-favorites",Array.from(s)),o)this.render(!0);else{const a=this.element.querySelector(`.toggle-favorite-btn[data-uuid="${e}"]`);if(a){const i=a.querySelector("i");i&&i.classList.remove("faded"),a.title=game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.removeFromFavorites")}this.render(!0)}}_onPresetChange(e){this.selectedPreset=e.target.value,this.showCustomSettings=this.selectedPreset==="custom",this.render(!0)}_createPresetSettings(e){switch(e){case"wildshape":return new dnd5e.dataModels.settings.TransformationSetting({preset:"wildshape"});case"appearance":return new dnd5e.dataModels.settings.TransformationSetting({effects:new Set(["all"]),keep:new Set(["self"])});case"polymorph":default:return new dnd5e.dataModels.settings.TransformationSetting({keep:new Set(["mental"]),transformTokens:!0})}}};it=new WeakSet,uo=async function(e,t,s){e.preventDefault()},go=async function(e,t){const s=this;if(!s.selectedActorUuid){D.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.noActorSelected"));return}const o=await fromUuid(s.selectedActorUuid);if(!o){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidActorUuid"));return}const a=new ia(s.element).object,i=a.renderSheet||!1;let n;if(s.selectedPreset==="custom"){const r=new Set;a["keep-mental"]&&r.add("mental"),a["keep-physical"]&&r.add("physical"),a["keep-saves"]&&r.add("saves"),a["keep-skills"]&&r.add("skills"),a["keep-spells"]&&r.add("spells"),a["keep-items"]&&r.add("items"),a["keep-hp"]&&r.add("hp"),n=new dnd5e.dataModels.settings.TransformationSetting({keep:r,transformTokens:!!a["transform-tokens"]})}else n=s._createPresetSettings(s.selectedPreset);s.resolve&&s.resolve({targetActor:o,settings:n,renderSheet:i}),s.close()},fo=function(){const e=this;e.resolve&&e.resolve(null),e.close()},fe(et,it),E(et,"DEFAULT_OPTIONS",{id:"flash5e-transformation-dialog",tag:"form",window:{title:"",icon:"fa-solid fa-frog",contentClasses:["standard-form","crlngn","flash5e","transformation-dialog"]},position:{width:560,height:"auto"},form:{handler:X(et,it,uo),submitOnChange:!1,closeOnSubmit:!1},actions:{transform:X(et,it,go),cancel:X(et,it,fo)}}),E(et,"PARTS",{content:{template:`modules/${k}/templates/transformation-dialog.hbs`},footer:{template:"templates/generic/form-footer.hbs"}});let ss=et;class It{static async transformSelectedActors(e){if(!e||!e.selectedActors||e.selectedActors.size===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}const t=Array.from(e.selectedActors);await this.transformActors(t)}static async transformActors(e,t=null,s={}){if(c.log("TransformationManager.transformActors",[e,t,s]),!e||e.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}if(!game.user.isGM){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.gmOnly"));return}const o=e.map(r=>se(r)).filter(r=>r);if(o.length===0){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const a=o.filter(r=>r.getFlag("dnd5e","isPolymorphed"));if(a.length>0&&!s.skipRevertCheck&&await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.revertTitle")},content:`<p>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.revertConfirm")}</p>`,rejectClose:!1,modal:!0})){const l=a.map(d=>{const u=canvas.tokens.placeables.find(f=>f.actor===d);return u?u.document.id:d.id});await this.revertTransformation(l);return}let i,n;if(t){if(i=await fromUuid(t),!i){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidActorUuid"));return}n=this._createTransformSettings(s.preset,s.settings)}else{const r=await ss.show(o);if(!r)return;i=r.targetActor,n=r.settings,s.renderSheet=r.renderSheet??!1}await this._performTransformations(o,i,n,s)}static async revertTransformation(e){if(c.log("TransformationManager.revertTransformation",[e]),!e||e.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}const t=e.map(i=>se(i)).filter(i=>i);if(t.length===0){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const s=t.filter(i=>i.getFlag("dnd5e","isPolymorphed"));if(s.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.notTransformed"));return}const o=this._getTokensForActors(s);o.length>0&&(this._hasJB2A()||this._hasCustomAnimation())&&await this._playTransformationAnimation(o);let a=0;for(const i of s)try{await i.revertOriginalForm(),a++}catch(n){c.error(`Failed to revert ${i.name}:`,[n]),ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.transformationFailed",{name:i.name,error:n.message}))}a>0&&D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.reversionSuccess",{count:a}))}static async _performTransformations(e,t,s,o={}){const a=this._getTokensForActors(e);a.length>0&&(this._hasJB2A()||this._hasCustomAnimation())&&this._playTransformationAnimation(a);let i=0;for(const n of e)try{const r=this._sanitizeTargetActor(n,t);await n.transformInto(r,s,{renderSheet:o.renderSheet??!1}),i++,await new Promise(l=>setTimeout(l,200))}catch(r){c.error(`Failed to transform ${n.name}:`,[r]),ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.transformationFailed",{name:n.name,error:r.message}))}i>0&&D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.transformationSuccess",{count:i,target:t.name}))}static async _playTransformationAnimation(e){if(!e||e.length===0)return;let t=this._getAnimationPath();if(!t&&this._hasJB2A()&&(t=await this._getDefaultJB2APath()),!!t)try{for(const s of e){const{x:o,y:a}=s.center;new Sequence().effect().file(t).atLocation({x:o,y:a}).scale(.6).fadeIn(200).fadeOut(400).duration(1500).forUsers(game.users.map(i=>i.id)).play(),await new Promise(i=>setTimeout(i,200))}await new Promise(s=>setTimeout(s,1e3))}catch(s){c.warn(`Transformation animation file not found: ${t}`,[s]),D.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.animationFileNotFound",{path:t}))}}static _getTokensForActors(e){const t=[];for(const s of e){const o=canvas.tokens.placeables.find(a=>a.actor===s);o&&t.push(o)}return t}static _createTransformSettings(e,t){if(t)return new dnd5e.dataModels.settings.TransformationSetting(t);switch(e){case"wildshape":return new dnd5e.dataModels.settings.TransformationSetting({preset:"wildshape"});case"polymorph":return new dnd5e.dataModels.settings.TransformationSetting({keep:new Set(["mental"]),transformTokens:!0});default:return new dnd5e.dataModels.settings.TransformationSetting({keep:new Set(["mental"]),transformTokens:!0})}}static _getJB2AModule(){return game.modules.get("JB2A_DnD5e")||game.modules.get("jb2a_patreon")}static _hasJB2A(){const e=this._getJB2AModule();return e==null?void 0:e.active}static _hasSequencer(){var e;return(e=game.modules.get("sequencer"))==null?void 0:e.active}static async _getDefaultJB2APath(){var t;if(this._hasSequencer()&&((t=window.Sequencer)!=null&&t.Database)){const s=["jb2a.smoke.puff.centered.grey.1","jb2a.smoke.puff.centered.grey","jb2a.smoke.puff.grey"];for(const o of s)if(Sequencer.Database.entryExists(o))return c.log(`Found JB2A transformation animation via Sequencer: ${o}`),o}const e=this._getJB2AModule();if(e!=null&&e.active){const o=`modules/${e.id}/Library/Generic/Smoke/SmokePuff01_02_Regular_Grey_400x400.webm`;return c.log(`Using JB2A transformation animation file path: ${o}`),o}return c.warn("JB2A module not found, transformation animations disabled"),null}static _hasCustomAnimation(){return!!this._getAnimationPath()}static _getAnimationPath(){var e;try{const t=I();if(!((e=t.transformAnimationPath)!=null&&e.tag))return null;const s=game.settings.get("flash-rolls-5e",t.transformAnimationPath.tag);return s&&s.trim()!==""?s:null}catch{return null}}static _sanitizeTargetActor(e,t){var d,u;if(!((d=e==null?void 0:e.system)!=null&&d.abilities)||!((u=t==null?void 0:t.system)!=null&&u.abilities))return t;const s=e.toObject(),o=t.toObject(),a=Object.keys(s.system.abilities),i=Object.keys(o.system.abilities);c.log(`Sanitization check - Source (${e.name}) toObject:`,a),c.log(`Sanitization check - Target (${t.name}) toObject:`,i);const n=i.filter(f=>!a.includes(f));if(n.length===0)return c.log("No extra abilities found in serialized data - skipping sanitization"),t;c.log(`Sanitizing target actor ${t.name}: removing abilities not present in source toObject`,n);for(const f of n)delete o.system.abilities[f];c.log("Sanitized data abilities:",Object.keys(o.system.abilities));const r=CONFIG.Actor.documentClass,l=new r(o,{temporary:!0});return c.log("Temp actor abilities after creation:",Object.keys(l.system.abilities)),l}}const na=Object.freeze(Object.defineProperty({__proto__:null,TransformationManager:It},Symbol.toStringTag,{value:"Module"}));class D{static async requestRoll(e={}){try{if(!e||typeof e!="object"){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidMacroData"));return}const{requestType:t,rollKey:s=null,actorIds:o=[],dc:a,situationalBonus:i,advantage:n,disadvantage:r,rollMode:l,skipRollDialog:d,sendAsRequest:u=!0,groupRollId:f=null,isContestedRoll:g=!1,workflowId:m=null}=e;if(!t){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.missingRequestType"));return}const p=!!m,S={dc:a,situationalBonus:i,advantage:n,disadvantage:r,rollMode:l,skipRollDialog:d,sendAsRequest:u,groupRollId:f,isContestedRoll:g,fromMidiWorkflow:p};c.log("FlashAPI.requestRoll",[t,s,o,"workflowId:",m,"fromMidiWorkflow:",p,S]);let y=V.ROLL_REQUEST_OPTIONS[t];if(y||(y=Object.values(V.ROLL_REQUEST_OPTIONS).find(C=>C.name===t)),!y){ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.unknownRequestType",{requestType:t}));return}const R=y.name;if(o.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}if(!Array.isArray(o)){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidActorIdsFormat"));return}const A=[],_=[];for(const b of o){const C=se(b);if(!C){A.push(b);continue}let w=null;game.actors.get(b)||(w=b),_.push({actor:C,uniqueId:b,tokenId:w})}if(A.length>0){const b=A.join(", ");D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.invalidActorIds",{numIds:A.length,invalidIds:b}))}if(_.length===0){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const T={selectedActors:new Set(o),selectedRequestType:t,isLocked:!0,close:()=>{}};return Rt.triggerRoll(R,s,T,S)}catch(t){c.error("FlashAPI.requestRoll - Execution error:",[t]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.macroExecutionFailed"));return}}static getAvailableRollTypes(){const e={};for(const[t,s]of Object.entries(V.ROLL_REQUEST_OPTIONS))e[t]={name:s.name,label:s.label};return e}static getSelectedActors(e=!1){const t=z.getInstance();if(t&&t.selectedActors){const s=Array.from(t.selectedActors);return e?s.map(o=>{const a=canvas.tokens.placeables.find(n=>n.id===o);if(a)return a.id;const i=game.actors.get(o);if(i){const n=canvas.tokens.placeables.find(r=>{var l;return((l=r.actor)==null?void 0:l.id)===i.id});if(n)return n.id}return null}).filter(o=>o!==null):s}return[]}static isMenuOpen(){const e=z.getInstance();return e&&e.rendered}static async createMacro(e){const t=I(),s=v.get(t.addMacrosToFolder.tag);c.log("FlashAPI.createMacro",[e]);const{requestType:o,rollKey:a=null,actorIds:i=[],config:n={}}=e;let r=V.ROLL_REQUEST_OPTIONS[o];if(r||(r=Object.values(V.ROLL_REQUEST_OPTIONS).find(S=>S.name===o)),!r){D.notify("warn",`Unknown request type: ${o}`);return}let l=r.label;if(c.log("FlashAPI.createMacro",[l,r.subList]),a&&r.subList&&Array.isArray(r.subList)){const p=r.subList.find(S=>S.id===a);p&&(l=p.name)}else a&&(l=Fo(r.name,a));const d={requestType:r.name,...a&&{rollKey:a},...i.length>0&&{actorIds:i},...n};d.advantage===void 0&&(d.advantage=!1),d.disadvantage===void 0&&(d.disadvantage=!1);const u=`// Flash Token Bar: ${l} - ${a||""}
    try {
      FlashAPI.requestRoll(${JSON.stringify(d,null,2)});
    } catch (error) {
      ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.macroDataMalformed"));
    }`;let f=null;s&&(f=await this._ensureFlashRollsFolder());const g={name:`Flash Token Bar: ${l}`,type:"script",command:u,img:"modules/flash-rolls-5e/assets/bolt-circle.svg",...f&&{folder:f},flags:{"flash-rolls-5e":{requestType:o,rollKey:a,actorIds:i,config:n}}},m=await Macro.create(g);return D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.macroCreated",{macroName:m.name})),m.sheet.render(!0),m}static async _ensureFlashRollsFolder(){const e="Flash Token Bar";let t=game.folders.find(s=>s.type==="Macro"&&s.name===e);if(!t)try{t=await Folder.create({name:e,type:"Macro",color:"#302437",sort:0}),c.log("Created Flash Token Bar macro folder",[t])}catch(s){return c.error("Failed to create Flash Token Bar macro folder:",[s]),D.notify("warn","Failed to create Flash Token Bar macro folder. Macro will be created without folder organization."),null}return(t==null?void 0:t.id)||null}static calculateGroupRoll(e={}){const{rollResults:t,dc:s,rollType:o,rollKey:a}=e;let{method:i,actors:n}=e;const r={"standard rule":1,"group average":2,"leader with help":3,"weakest link":4};if(typeof i=="string"){const d=i.toLowerCase();if(i=r[d],!i)return ui.notifications.error(`Invalid method name: "${e.method}". Valid options: "Standard Rule", "Group Average", "Leader with Help", "Weakest Link", or numbers 1-4`),null}if(!i||![1,2,3,4].includes(i))return ui.notifications.error("Method must be 1-4 or valid method name: 'Standard Rule', 'Group Average', 'Leader with Help', 'Weakest Link'"),null;if(!Array.isArray(t)||t.length===0)return ui.notifications.error("rollResults must be a non-empty array"),null;if(typeof s!="number"||s<0)return ui.notifications.error("dc must be a positive number"),null;const l=[];for(let d=0;d<t.length;d++){const u=t[d];if(!u.hasOwnProperty("total")||typeof u.total!="number")return ui.notifications.error(`rollResults[${d}] must have a 'total' property with a numeric value`),null;if(!u.actorId)return ui.notifications.error(`rollResults[${d}] must have an 'actorId' property`),null;let f=u.actorName;if(!f){const g=se(u.actorId);f=(g==null?void 0:g.name)||u.actorId}l.push({...u,actorName:f,passed:u.total>=s})}if([3,4].includes(i)){if(!o)return ui.notifications.error("rollType is required for Leader with Help and Weakest Link methods"),null;if(!a)return ui.notifications.error("rollKey is required for Leader with Help and Weakest Link methods"),null;if(!Array.isArray(n)||n.length===0){n=[];for(const d of l){const u=se(d.actorId);u&&n.push(u)}if(n.length===0)return ui.notifications.error("No valid actors could be resolved from the rollResults for Leader with Help and Weakest Link methods"),null}}try{let d,u;switch(i){case 1:return d=P.calculateStandardRule(t,s),u="Standard Rule",{success:d.finalResult,result:d.finalResult?1:0,details:d,method:u,actorResults:l};case 2:return d=P.calculateGroupAverage(t,s),u="Group Average",{success:d.success,result:d.finalResult,details:d,method:u,actorResults:l};case 3:d=P.calculateLeaderWithHelp(t,s,n,o,a),u="Leader with Help";const f=l.map(m=>({...m,isLeadRoll:m.actorId===d.leaderActorId}));return{success:d.success,result:d.finalResult,details:d,method:u,actorResults:f};case 4:d=P.calculateWeakestLink(t,s,n,o,a),u="Weakest Link";const g=l.map(m=>({...m,isLeadRoll:m.actorId===d.weakestActorId}));return{success:d.success,result:d.finalResult,details:d,method:u,actorResults:g};default:return ui.notifications.error(`Invalid calculation method: ${i}`),null}}catch(d){return c.error("FlashAPI.calculateGroupRoll - Error:",[d]),ui.notifications.error(`Error calculating group roll: ${d.message}`),null}}static async createGroupRollMessage(e,t,s,o={},a){return ne.createGroupRollMessage(e,t,s,o,a)}static async toggleLockMenu(){var o;const t=!(game.user.getFlag(V.ID,"menuLocked")??!1);await game.user.setFlag(V.ID,"menuLocked",t);const s=z.getInstance();if(s&&s.rendered){s.isLocked=t;const a=(o=s.element)==null?void 0:o.querySelector("#flash5e-actors-lock");a&&(a.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),a.classList.add(t?"fa-lock-keyhole":"fa-lock-keyhole-open"))}}static async toggleRollRequests(){const e=I(),s=!v.get(e.rollRequestsEnabled.tag);await v.set(e.rollRequestsEnabled.tag,s),Wt.updateRollRequestsIcon(s),v.applyRollRequestsEnabled(s);const o=z.getInstance();o&&o.rendered&&await o.render()}static async toggleSkipDialogs(){const e=I(),t=v.get(e.skipRollDialog.tag);await v.set(e.skipRollDialog.tag,!t);const s=z.getInstance();s&&s.rendered&&await s.render()}static async toggleGroupRolls(){const e=I(),t=v.get(e.groupRollsMsgEnabled.tag);await v.set(e.groupRollsMsgEnabled.tag,!t);const s=z.getInstance();s&&s.rendered&&await s.render()}static async toggleShowOptions(){const e=I(),t=v.get(e.showOptionsListOnHover.tag);await v.set(e.showOptionsListOnHover.tag,!t);const s=z.getInstance();s&&s.rendered&&await s.render()}static openSettings(){new Mt().render(!0)}static openPremiumFeatures(){new mt().render(!0)}static async selectAllActors(e){var o;const t=z.getInstance();if(!t||!t.rendered){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.menuNotOpen"));return}e&&["pc","npc","group"].includes(e)&&t.currentTab!==e&&(t.currentTab=e,await t.render());const s=(o=t.element)==null?void 0:o.querySelector("#flash5e-actors-all");s&&(s.checked=!s.checked,s.dispatchEvent(new Event("change")))}static async filterActors(e){var s;const t=z.getInstance();if(!t||!t.rendered){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.menuNotOpen"));return}if(e&&typeof e=="object"){const o={inCombat:!!e.inCombat,visible:!!e.visible,removeDead:!!e.removeDead};t.actorFilters=o,await game.user.setFlag(V.ID,"actorFilters",o),t.render()}else{const o=(s=t.element)==null?void 0:s.querySelector("#flash5e-filter-actors");o&&o.click()}}static getActorFilters(){return game.user.getFlag(V.ID,"actorFilters")||{inCombat:!1,visible:!1,removeDead:!1}}static toggleTargets(e){const t=z.getInstance();e&&e.length>0?e.forEach(s=>{const o=se(s);if(!o)return;const a=o.id,i=game.actors.get(s)?null:s;Ae.toggleActorTargetById(a,i)}):t&&t.rendered&&Ae.toggleTargetsForSelected(t)}static healAll(e){const t=z.getInstance();e&&e.length>0?e.forEach(s=>{const o=se(s);if(!o)return;const a=o.id,i=game.actors.get(s)?null:s;Ae.healActorById(a,i)}):t&&t.rendered&&Ae.healSelectedActors(t)}static killAll(e){const t=z.getInstance();e&&e.length>0?e.forEach(s=>{const o=se(s);if(!o)return;const a=o.id,i=game.actors.get(s)?null:s;Ae.killActorById(a,i)}):t&&t.rendered&&Ae.killSelectedActors(t)}static async removeStatusEffects(e){const t=z.getInstance();if(e&&e.length>0){let s=0;for(const o of e){const a=se(o);if(!a)continue;const i=a.appliedEffects.filter(n=>{var r,l,d;return((r=n.statuses)==null?void 0:r.size)>0||((d=(l=n.flags)==null?void 0:l.core)==null?void 0:d.statusId)});for(const n of i)try{await n.delete(),s++}catch(r){c.error(`Failed to remove status effect from ${a.name}`,[r])}}s>0&&D.notify("info",`Removed ${s} status effects`)}else t&&t.rendered&&await Ae.removeAllStatusEffectsFromSelected(t)}static openSheets(e){const t=z.getInstance();e&&e.length>0?e.forEach(s=>{const o=se(s);if(!o)return;const a=o.id,i=game.actors.get(s)?null:s;Ae.openActorSheetById(a,i)}):t&&t.rendered&&Ae.openSheetsForSelected(t)}static async groupSelected(e){const t=z.getInstance();if(e&&e.length>0){const s={selectedActors:new Set(e)};await Ae.createGroupFromSelected(s)}else t&&t.rendered?await Ae.createGroupFromSelected(t):D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async toggleMovement(e){const t=z.getInstance();if(e&&e.length>0){const s={selectedActors:new Set(e)};await Fe.toggleMovementForSelected(s)}else t&&t.rendered?await Fe.toggleMovementForSelected(t):D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async openContestedRoll(e){const t=z.getInstance();if(e&&e.length>0){const s={selectedActors:new Set(e)};await Ae.openContestedRollDialog(s)}else t&&t.rendered?await Ae.openContestedRollDialog(t):D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async placeTokens(e,t=null){const s=z.getInstance();if(e&&e.length>0)if(t&&typeof t=="object"&&typeof t.x=="number"&&typeof t.y=="number")await we.placeTokensAtLocation(e,t);else{const o={selectedActors:new Set(e)};await we.placeTokensForSelectedActors(o)}else s&&s.rendered?await we.placeTokensForSelectedActors(s):D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async teleportTokens(e,t=null,s=null){const o=z.getInstance();if(e&&e.length>0)if(t&&s&&typeof s=="object"&&typeof s.x=="number"&&typeof s.y=="number")await ae.teleportToDestination(e,t,s);else{const a={selectedActors:new Set(e)};await ae.teleportSelectedTokens(a)}else o&&o.rendered?await ae.teleportSelectedTokens(o):D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async transformActors(e,t=null,s={}){const o=z.getInstance();e&&e.length>0?await It.transformActors(e,t,s):o&&o.rendered?await It.transformSelectedActors(o):D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async revertTransformation(e){const t=z.getInstance();if(e&&e.length>0)await It.revertTransformation(e);else if(t&&t.rendered){const s=Array.from(t.selectedActors);await It.revertTransformation(s)}else D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static notify(e,t){q.notify(e,t)}}var st,Ft,Pt;class Tt{static isAvailable(){var e;return j(this,Ft)||(De(this,Pt,((e=game.modules.get("lib-wrapper"))==null?void 0:e.active)??!1),De(this,Ft,!0)),j(this,Pt)}static register(e,t,s="WRAPPER",o={}){if(!this.isAvailable())return o.required&&c.warn(`LibWrapperUtil.register - libWrapper required but not available for: ${e}`),!1;try{return libWrapper.register(k,e,t,s),j(this,st).add(e),c.log(`LibWrapperUtil.register - Successfully registered: ${e}`),!0}catch(a){return c.error(`LibWrapperUtil.register - Failed to register ${e}:`,a),!1}}static unregister(e){if(this.isAvailable())try{libWrapper.unregister(k,e),j(this,st).delete(e),c.log(`LibWrapperUtil.unregister - Successfully unregistered: ${e}`)}catch(t){c.error(`LibWrapperUtil.unregister - Failed to unregister ${e}:`,t)}}static unregisterAll(){if(this.isAvailable()){for(const e of j(this,st))this.unregister(e);j(this,st).clear(),c.log("LibWrapperUtil.unregisterAll - All wrappers unregistered")}}static getRegisteredWrappers(){return Array.from(j(this,st))}static showMissingLibWrapperNotification(){if(!game.user.isGM)return;const e=I();if(this.isAvailable()){v.get(e.libWrapperNotificationShown.tag)&&v.set(e.libWrapperNotificationShown.tag,!1);return}v.get(e.libWrapperNotificationShown.tag)||(D.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.libWrapperRecommended"),{permanent:!0,console:!1}),v.set(e.libWrapperNotificationShown.tag,!0))}}st=new WeakMap,Ft=new WeakMap,Pt=new WeakMap,fe(Tt,st,new Set),fe(Tt,Ft,!1),fe(Tt,Pt,!1);const{FormDataExtended:Sa}=foundry.applications.ux,{ApplicationV2:ra,HandlebarsApplicationMixin:la}=foundry.applications.api;var Hs,He,Lt,ls,_t,mo,po,nt,ho,yo,So;const Q=class Q extends la(ra){constructor(){super(...arguments);fe(this,_t);E(this,"_onRender",(t,s)=>{I(),De(Q,He,this.element),j(Q,He).querySelectorAll(".toggle-hint").forEach(n=>{n.addEventListener("click",()=>{j(Q,He).querySelectorAll("p.hint").forEach(r=>r.classList.toggle("shown"))})});const a=j(Q,He).querySelector(".icon-arrangement-container");a&&ot.initializeDragAndDrop(a),j(Q,He).querySelectorAll("select[data-current-value]").forEach(n=>{const r=String(n.dataset.currentValue),l=n.querySelector(`option[value="${r}"]`);l&&(l.selected=!0)}),X(this,_t,mo).call(this)})}_configureRenderParts(t){const s=super._configureRenderParts(t),o=Q.getRestrictedTabs();return game.user.isGM||o.forEach(a=>{delete s[a]}),s}async _prepareContext(t){const s=await super._prepareContext(t);return s.activeTab=t.activeTab||Object.keys(s.tabs)[0],s.isGM=game.user.isGM,s.interceptWarning=q.isModuleOn("midi-qol"),s.interceptWarning=game.i18n.localize("FLASH_ROLLS.notifications.interceptWarning"),s}async _preparePartContext(t,s,o){var n,r,l;const a=await super._preparePartContext(t,s,o);t in s.tabs&&(a.tab=a.tabs[t]),I(),Ro();const i=Q.getRestrictedTabs();switch(game.user.isGM||i.forEach(d=>{delete a.tabs[d]}),t){case"tabs":break;case"footer":{a.buttons=[{type:"button",icon:"",label:"FLASH_ROLLS.ui.buttons.reset",action:"redefine"},{type:"submit",icon:"",label:"FLASH_ROLLS.ui.buttons.save"}];break}default:{a.tab=a.tabs[t];const d=((n=Q.PARTS[t])==null?void 0:n.menuKey)||null;if(d){const u=Q.getMenuContext(d);if(u.fields&&(a.fields={...a.fields,...u.fields}),u.fieldDefaults&&(a.fieldDefaults={...a.fieldDefaults,...u.fieldDefaults}),u.fieldValues&&Object.assign(a,u.fieldValues),t==="interfaceSettings"){a.iconConfigs=ot.getIconConfigurations();const f=ot.getIconConfigurations(),m=I().menuIconsLayout.default,p=a.menuIconsLayout||{},S=(y,R)=>{const A=m[y]||[],_=p[y]||[],T=new Map(A.map(w=>[w.id,w])),b=new Map(_.map(w=>[w.id,w]));return Object.keys(R).map((w,M)=>{const O=R[w],F=T.get(w),N=b.get(w);return{id:w,icon:O.icon,enabled:N?N.enabled:F?F.enabled:!1,order:N?N.order:F?F.order:M,label:game.i18n.localize(O.labelKey||w)}}).sort((w,M)=>w.order-M.order)};a.menuIconsLayout={moduleActions:S("moduleActions",f.moduleActions),actorActions:S("actorActions",f.actorActions)}}a.sidebarTabs=Object.values(((l=(r=foundry.applications)==null?void 0:r.sidebar)==null?void 0:l.tabs)||{}).map(f=>({tabName:f.tabName,name:f.name,hideForGM:!1,hideForPlayer:!1,localizedName:`FLASH_ROLLS.settings.sidebarTabs.${f.name}`}))}break}}return c.log("_preparePartContext",[a,t]),a}static getMenuContext(t){var r;const s=I(),o=((r=s[t])==null?void 0:r.fields)||null;if(!o)return{};const a={},i={},n={};return o.forEach(l=>{if(s[l]){const d=v.get(s[l].tag);a[l]=s[l],i[l]=d!==void 0?d:s[l].default,n[l]=s[l].default}}),{fields:a,fieldValues:i,fieldDefaults:n}}static getRestrictedTabs(){const t=[];return Object.entries(Q.PARTS).forEach((s,o)=>{s[0]!=="tabs"&&s[0]!=="footer"&&s[1].isGMOnly&&t.push(s[0])}),t}static updateSettings(t){let s=!1;const o=I(),n=j(Q,He).querySelector(".form-content.active").dataset.tab;if(De(Q,Lt,n),!t)return;let r;return t.object&&(r=foundry.utils.expandObject(t.object)),Object.entries(r).forEach(([l,d])=>{var u;if(!l.endsWith("_value")&&(c.log("updateSettings #1",[o,o[l]]),r[l]!==void 0&&o[l])){const f=v.get(o[l].tag);v.set(o[l].tag,r[l]),(u=o[l])!=null&&u.requiresReload&&f!==r[l]&&(s=!0)}}),D.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.settingsUpdated")),s}changeTab(t,s,o){super.changeTab(t,s,o),De(Q,Lt,t)}};He=new WeakMap,Lt=new WeakMap,ls=new WeakMap,_t=new WeakSet,mo=function(){j(Q,He).querySelectorAll(".form-group.range").forEach(s=>{const o=s.querySelector('input[type="range"]'),a=s.querySelector('input[type="number"]');X(this,_t,po).call(this,o,a)})},po=function(t,s){if(t&&s){const o=parseInt(t.min,10),a=parseInt(t.max,10);t.addEventListener("input",()=>{s.value=t.value}),s.addEventListener("input",()=>{const i=s.value;if(i===""||i==="-")return;const n=parseInt(i,10);!isNaN(n)&&n>=o&&n<=a&&(t.value=n)}),s.addEventListener("change",()=>{let i=parseInt(s.value,10);isNaN(i)||i<o?i=o:i>a&&(i=a),s.value=i,t.value=i}),s.value=t.value}},nt=new WeakSet,ho=async function(t,s,o){t.preventDefault(),t.stopPropagation(),Q.updateSettings(o)&&q.confirmReload()},yo=async function(t,s){const o=I(),i=j(Q,He).querySelector(".form-content.active"),n=i.dataset.tab,r=Q.PARTS[n].menuKey,l=o[r].default;if(n==="interfaceSettings"){ot.resetToDefault();const u=foundry.applications.instances.get("flash-rolls-settings");if(u){await u.renderPart("interfaceSettings",{force:!0});return}}i.querySelectorAll("input, select").forEach(u=>{const f=u.name.split(".");let g=l;for(const m of f)g=g==null?void 0:g[m];g!==void 0&&(u.value=g,u.type==="checkbox"&&(u.checked=g))}),c.log("#onReset",[j(Q,Lt),n,t,s])},So=function(){const t=[];return Object.entries(Q.PARTS).forEach(([s,o])=>{o.menuKey&&t.push({id:s,icon:"",group:"primary-tabs",label:`FLASH_ROLLS.settings.moduleSettingsMenu.tabs.${s}`})}),t},fe(Q,nt),fe(Q,He),fe(Q,Lt),fe(Q,ls),E(Q,"selectedTheme"),E(Q,"DEFAULT_OPTIONS",{id:"flash-rolls-settings",tag:"form",window:{icon:"fas fa-cog",title:"FLASH_ROLLS.settings.moduleSettingsMenu.title",contentClasses:["standard-form","crlngn","flash5e","tabbed-settings"],resizable:!0},position:{width:700,height:"auto"},actions:{redefine:X(Q,nt,yo)},form:{handler:X(Q,nt,ho),closeOnSubmit:!0}}),E(Q,"PARTS",{tabs:{template:"templates/generic/tab-navigation.hbs",isGMOnly:!1},generalSettings:{menuKey:"generalSettings",template:"modules/flash-rolls-5e/templates/settings-general.hbs",isGMOnly:!0},interfaceSettings:{menuKey:"interfaceSettings",template:"modules/flash-rolls-5e/templates/settings-interface.hbs",isGMOnly:!0},groupRolls:{menuKey:"groupRollsSettings",template:"modules/flash-rolls-5e/templates/settings-group-rolls.hbs",isGMOnly:!0},rollRequests:{menuKey:"rollRequestsSettings",template:"modules/flash-rolls-5e/templates/settings-roll-requests.hbs",isGMOnly:!0},integrations:{menuKey:"integrationSettings",template:"modules/flash-rolls-5e/templates/settings-integrations.hbs",isGMOnly:!0},footer:{template:"templates/generic/form-footer.hbs",isGMOnly:!1}}),E(Q,"TABS",{primary:{initial:"interfaceSettings",tabs:X(Hs=Q,nt,So).call(Hs),labelPrefix:""}});let Mt=Q;function Ro(){return{moduleSettingsMenu:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),name:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),icon:"fas fa-cog",propType:Mt,restricted:!0},premiumFeatures:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.label"),name:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.label"),label:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.buttonLabel"),hint:game.i18n.localize("FLASH_ROLLS.settings.premiumFeatures.hint"),icon:"fas fa-gem",propType:mt,restricted:!0}}}const te=class te{static registerSettings(){const e=I();var t=te.get(e.debugMode.tag);t&&(CONFIG.debug.hooks=!0),Object.entries(e).forEach(o=>{const a=o[1],i={name:a.label,hint:a.hint,default:a.default,type:a.propType,scope:a.scope,config:a.config,requiresReload:a.requiresReload||!1,restricted:a.scope===G.world,onChange:n=>te.apply(a.tag,n)};a.choices&&(i.choices=a.choices),c.log("registerSettings",[i,i.scope]);try{game.settings.register(k,a.tag,i)}catch(n){c.log(`Setting ${a.tag} already registered or error:`,n)}})}static registerSettingsMenu(){var t;const e=Object.entries(Ro());for(const[s,o]of e)if(o.restricted&&((t=game.user)!=null&&t.isGM)||!o.restricted){const a={name:o.tag,label:o.label,hint:o.hint,icon:o.icon,type:o.propType,restricted:o.restricted};game.settings.registerMenu(k,o.tag,a)}te.updateColorScheme(),te.validateAndUpdateIconLayout(),te.checkMidiQol(),te.initializeMaxIconsPerRow()}static checkMidiQol(){const e=I(),t=q.isModuleOn("midi-qol"),s=te.get(e.rollInterceptionEnabled.tag);c.log("checkMidiQol",[t,s])}static updateColorScheme(){var s;const e=game.settings.get("core","uiConfig");let t=(s=e==null?void 0:e.colorScheme)==null?void 0:s.interface;t||(matchMedia("(prefers-color-scheme: dark)").matches?t="dark":matchMedia("(prefers-color-scheme: light)").matches&&(t="light")),te.coreColorScheme=t,c.log("SettingsUtil.updateColorScheme",[e,te.coreColorScheme])}static get(e,t=k){if(!e)return null;let s=!1;try{if(t===k)s=game.settings.get(t,e);else{let a=game.settings.storage.get("client")[`${t}.${e}`];a===void 0&&(a=game.settings.storage.get("world").getSetting(`${t}.${e}`),s=a==null?void 0:a.value)}}catch{return c.log(`Setting ${t}.${e} not found, returning false`),!1}return s}static async set(e,t,s=k){if(!e)return!1;let o=game.settings.storage.get("client")[`${s}.${e}`];o||(o=game.settings.storage.get("world").getSetting(`${s}.${e}`),c.log("SettingsUtil.set - world Setting?",[o]));try{await game.settings.set(s,e,t),c.log("SettingsUtil.set - success",[s,e])}catch(a){c.error("SettingsUtil.set - error",[a])}return!0}static apply(e,t){const s=I();switch(e){case s.rollRequestsEnabled.tag:te.applyRollRequestsEnabled(t);break;case s.rollInterceptionEnabled.tag:te.applyRollInterceptionEnabled(t);break;case s.compactMode.tag:te.applyCompactMode(t);break;case s.menuLayout.tag:te.applyMenuLayout(t);break;case s.menuIconsLayout.tag:te.applyMenuIconsLayout(t);break;case s.maxIconsPerRow.tag:te.applyMaxIconsPerRow(t);break;case s.actorStatsToShow.tag:te.applyActorStatsToShow(t);break;case s.autoBlockMovementInCombat.tag:te.applyAutoBlockMovementInCombat(t);break}}static applyRollInterceptionEnabled(e){te.checkMidiQol()}static applyRollRequestsEnabled(e){const t=document.querySelector(".chat-controls .flash-rolls-icon");t&&(e?t.classList.add("active"):t.classList.remove("active"))}static applyCompactMode(e){const t=I(),s=e||te.get(t.compactMode.tag);c.log("applyCompactMode",[s]),z.refreshIfOpen()}static applyMenuLayout(e){const t=I(),s=e||te.get(t.menuLayout.tag);c.log("applyMenuLayout",[s]),z.refreshIfOpen()}static applyMenuIconsLayout(e){const t=I(),s=e||te.get(t.menuIconsLayout.tag);c.log("applyMenuIconsLayout",[s]),z.refreshIfOpen()}static applyActorStatsToShow(e){c.log("applyActorStatsToShow",[e]),z.refreshIfOpen()}static initializeMaxIconsPerRow(){const e=I(),t=te.get(e.maxIconsPerRow.tag)||5;q.addCSSVars("--fr5e-menu-icons-limit",t),c.log("initializeMaxIconsPerRow",[t])}static applyMaxIconsPerRow(e){var a,i;const t=I();let s=e||te.get(t.maxIconsPerRow.tag)||5;const o=(i=(a=game.modules.get(k))==null?void 0:a.api)==null?void 0:i.IconLayoutUtil;if(o){const n=o.getEnabledIcons("actorActions");n&&s>n.length&&(s=n.length)}s<1&&(s=1),c.log("applyMaxIconsPerRow",[s,e]),q.addCSSVars("--fr5e-menu-icons-limit",s),z.refreshIfOpen()}static async validateAndUpdateIconLayout(){const e=I(),t=te.get(e.menuIconsLayout.tag),s=$t();if(!t){c.log("validateAndUpdateIconLayout - no current layout found, using default");return}let o=!1;const a=foundry.utils.deepClone(t);for(const[i,n]of Object.entries(s)){a[i]||(a[i]=[]);const r=new Set(n.map(u=>u.id));a[i].length,a[i]=a[i].filter(u=>r.has(u.id)?!0:(c.log(`validateAndUpdateIconLayout - removed obsolete icon: ${u.id} from ${i}`),o=!0,!1));const l=new Set(a[i].map(u=>u.id));let d=Math.max(...a[i].map(u=>u.order||0),-1);for(const u of n)l.has(u.id)||(d++,a[i].push({...u,order:d}),o=!0,c.log(`validateAndUpdateIconLayout - added missing icon: ${u.id} to ${i}`))}o?(await te.set(e.menuIconsLayout.tag,a),c.log("validateAndUpdateIconLayout - updated layout",a)):c.log("validateAndUpdateIconLayout - no changes needed")}static applyAutoBlockMovementInCombat(e){if(!game.user.isGM)return;const t=game.combat;t&&(c.log("applyAutoBlockMovementInCombat",[e,t]),e?Fe.onCombatStart(t,{}):Fe.onCombatEnd(t))}};E(te,"coreColorScheme","dark");let v=te;class ca{static initialize(){c.log("ActorDirectoryIconUtil.initialize"),Hooks.on(x.RENDER_ACTOR_DIRECTORY,this.onRenderActorDirectory.bind(this)),Hooks.on(x.UPDATE_ACTOR,this.onUpdateActor.bind(this)),this.updateExistingDirectory()}static updateExistingDirectory(){const e=ui.actors;e&&e.rendered&&e.element?(c.log("ActorDirectoryIconUtil.updateExistingDirectory - Found rendered directory, adding icons"),this.onRenderActorDirectory(e,e.element)):c.log("ActorDirectoryIconUtil.updateExistingDirectory - No rendered directory found")}static onRenderActorDirectory(e,t){t.querySelectorAll(".directory-item.actor").forEach(o=>{const a=o.dataset.entryId||o.dataset.documentId;a&&this.updateActorIcon(o,a)})}static onUpdateActor(e,t){var o;const s=(o=t.flags)==null?void 0:o["flash-rolls-5e"];s&&(c.log("ActorDirectoryIconUtil.onUpdateActor - Flash Token Bar flags changed",[e.name,s]),this.refreshActorIcon(e.id))}static updateActorIcon(e,t){const s=e.querySelector("span.fas.fa-bolt, span.fas.fa-bolt-slash");s&&s.remove();const o=game.actors.get(t);if(!o)return;const a=he.isFavorite(o),i=he.isBlocked(o);if(!a&&!i)return;const n=document.createElement("span");i?(n.className="fas fa-bolt-slash",n.dataset.tooltip=game.i18n.localize("FLASH_ROLLS.contextMenu.unblockFromMenu"),n.dataset.tooltipDirection="LEFT",n.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),he.toggleBlocked(t,!1)})):a&&(n.className="fas fa-bolt",n.dataset.tooltip=game.i18n.localize("FLASH_ROLLS.contextMenu.blockFromMenu"),n.dataset.tooltipDirection="LEFT",n.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),he.toggleFavorite(t,!1)})),n.style.cursor="pointer",e.appendChild(n)}static refreshActorIcon(e){const t=document.querySelector(`.directory-item.actor[data-entry-id="${e}"], .directory-item.actor[data-document-id="${e}"]`);t&&this.updateActorIcon(t,e)}static refreshAllIcons(){c.log("ActorDirectoryIconUtil.refreshAllIcons"),document.querySelectorAll(".directory-item.actor").forEach(t=>{const s=t.dataset.entryId||t.dataset.documentId;s&&this.updateActorIcon(t,s)})}}class Re{static onPreRollGM(e,t,s){var o;if(!(e._flashRollsProcessed||Me.isMidiActive)){if(e._flashRollsProcessed=!0,c.log("RollHooksHandler.onPreRollGM",[e,t,s]),(o=e.subject)!=null&&o.item){e.rolls=P.consolidateRolls(e.rolls);const a=q.areSkipKeysPressed(e.event),i=e.subject.item.getFlag(k,"tempAttackConfig")||e.subject.item.getFlag(k,"tempDamageConfig")||e.subject.item.getFlag(k,"tempSaveConfig");c.log("RollHooksHandler.onPreRollGM - flag",[i]),((i==null?void 0:i.skipRollDialog)===!0||a)&&(t.configure=!1,c.log("RollHooksHandler.onPreRollGM - Local GM roll, skipping dialog via stored flag"))}(_e.hasPendingDamageRoll()||_e.isDnDBDamageInProgress()||re.hasPendingRoll())&&(t.configure=!1,c.log("RollHooksHandler.onPreRollGM - DnDB roll detected, skipping dialog"))}}static onPreRollInitiativeDialog(e,t,s){var i,n,r,l,d;if(e._flashRollsProcessed)return;e._flashRollsProcessed=!0;const o=e.subject;q.areSkipKeysPressed(e.event);const a=o.getFlag(k,"tempInitiativeConfig");if(c.log("RollHooksHandler.onPreRollInitiativeDialog triggered",[e,a,t,s]),!a){c.log("RollHooksHandler.onPreRollInitiativeDialog - No stored config, player-initiated roll, returning early");return}t.configure=!0,c.log("RollHooksHandler.onPreRollInitiativeDialog - Player roll request, always showing dialog"),e.advantage=(a==null?void 0:a.advantage)||e.advantage||!1,e.disadvantage=(a==null?void 0:a.disadvantage)||e.disadvantage||!1,e.rollMode=(a==null?void 0:a.rollMode)||e.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,s.rollMode=(a==null?void 0:a.rollMode)||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,(r=(n=(i=a==null?void 0:a.rolls)==null?void 0:i[0])==null?void 0:n.data)!=null&&r.situational&&((d=(l=e.rolls)==null?void 0:l[0])!=null&&d.data)&&(e.rolls[0].data.situational=a.rolls[0].data.situational)}static onPreRollAttackV2(e,t,s){var i,n;if(e._flashRollsProcessed)return;e._flashRollsProcessed=!0,c.log("RollHooksHandler.onPreRollAttackV2 triggered",[e,t,s]);const o=(n=(i=e.subject)==null?void 0:i.item)==null?void 0:n.getFlag(k,"tempAttackConfig");if(!o){c.log("RollHooksHandler.onPreRollAttackV2 - No stored config, player-initiated roll, returning early");return}q.isModuleOn("midi-qol")&&e.midiOptions&&ut.onPreRollAttackV2(e,t,s),t.configure=!0,c.log("RollHooksHandler.onPreRollAttackV2 - Player roll request, always showing dialog"),o.attackMode&&(e.attackMode=o.attackMode),o.ammunition&&(e.ammunition=o.ammunition),o.mastery!==void 0&&(e.mastery=o.mastery),e.advantage=o.advantage||!1,e.disadvantage=o.disadvantage||!1,s.rollMode=o.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,o.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=o.situational),c.log("RollHooksHandler.onPreRollAttackV2 - Applied stored configuration to attack roll",[e,s])}static onPreRollDamageV2(e,t,s){var i,n;if(e._flashRollsProcessed)return;e._flashRollsProcessed=!0,c.log("RollHooksHandler.onPreRollDamageV2 triggered",[e,t,s]);const o=(n=(i=e.subject)==null?void 0:i.item)==null?void 0:n.getFlag(k,"tempDamageConfig");if(!o){c.log("RollHooksHandler.onPreRollDamageV2 - No stored config, player-initiated roll, returning early");return}const a=q.isModuleOn("midi-qol");e.rolls=P.consolidateRolls(e.rolls),a&&e.midiOptions&&ut.onPreRollDamageV2(e,t,s),t.configure=!0,c.log("RollHooksHandler.onPreRollDamageV2 - Found stored request config from flag",[o,o.situational]),o.critical&&(e.critical=o.critical),s.rollMode=o.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,c.log("RollHooksHandler.onPreRollDamageV2 triggered #1",[e,t,s]),o.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=o.situational,e._flashRollsSituational=o.situational),c.log("RollHooksHandler.onPreRollDamageV2 - Applied stored configuration to damage roll",[e,s])}static onPreRollAbilityCheck(e,t,s){e._flashRollsProcessed||(e._flashRollsProcessed=!0,c.log("RollHooksHandler.onPreRollAbilityCheck",[e,t,s]),e.isRollRequest&&(t.configure=!0))}static onPreRollHitDieV2(e,t,s){if(!e._flashRollsProcessed&&(e._flashRollsProcessed=!0,c.log("RollHooksHandler.onPreRollHitDieV2 triggered",[e,t,s]),e.rolls&&e.rolls.length>1)){const o=[];for(let a=0;a<e.rolls.length;a++){const i=e.rolls[a];i&&i.data&&i.data.situational&&o.push(i.data.situational)}if(o.length>0){e.rolls[0].data||(e.rolls[0].data={});const a=[...new Set(o)];e.rolls[0].data.situational=a.map(i=>{const n=i.toString().trim();return n.startsWith("-")?`(${n})`:n.startsWith("+")?`${n.substring(1)}`:`${n}`}).join(" + "),game.user.isGM&&!e.rolls[0].parts.find(i=>i.includes("@situational"))&&e.rolls[0].parts.push("@situational")}e.rolls=e.rolls.slice(0,1),c.log("RollHooksHandler.onPreRollHitDieV2 - Cleaned up hit die rolls",e.rolls)}}static onPostRollConfig(e,t,s,o){t._showRequestedBy&&e.length>0&&(o.data=o.data||{},o.data._showRequestedBy=!0,o.data._requestedBy=t._requestedBy)}static onRollDamageV2(e,t,s,o){var l;const a=(l=t.subject)==null?void 0:l.item;if(c.log("RollHooksHandler.onRollDamageV2 - scheduled template removal",[a==null?void 0:a.name,a==null?void 0:a.uuid]),!a)return;if(Ie.templateRemovalTimers.has(a.uuid)){c.log("RollHooksHandler.onRollDamageV2 - template removal already scheduled for item",[a.uuid]);return}Ie.templateRemovalTimers.add(a.uuid);const i=I(),r=v.get(i.templateRemovalTimeout.tag)*1e3;setTimeout(()=>{q.removeTemplateForItem(a),Ie.templateRemovalTimers.delete(a.uuid)},r)}}const tt=class tt{static initialize(){c.log("GroupTokenTracker.initialize"),this.setupPlaceMembersTracking(),Hooks.on(x.CREATE_TOKEN,this.onCreateToken.bind(this)),Hooks.on(x.DELETE_TOKEN,this.onDeleteToken.bind(this)),Hooks.on(x.DELETE_ACTOR,this.onDeleteActor.bind(this)),Hooks.on(x.UPDATE_ACTOR,this.onUpdateActor.bind(this)),Hooks.on(x.CANVAS_READY,this.onCanvasReady.bind(this)),Hooks.on(Y.RENDER_GROUP_ACTOR_SHEET,this.onRenderActorSheet.bind(this)),Hooks.on(Y.RENDER_ENCOUNTER_ACTOR_SHEET,this.onRenderActorSheet.bind(this)),game.user.isGM&&setTimeout(()=>this.migrateLegacyAssociationsForAllGroups(),500)}static async migrateLegacyAssociationsForAllGroups(){const e=I();let t=!1;try{t=game.settings.get(k,e.legacyTokenAssociationsMigrated.tag)}catch{c.log("GroupTokenTracker: Migration setting not yet registered, proceeding with migration check")}if(t){c.log("GroupTokenTracker: Legacy migration already completed globally");return}if(!game.actors.some(a=>(a.type==="group"||a.type==="encounter")&&a.getFlag(k,"tokenAssociations")&&!a.getFlag(k,"tokenAssociationsByScene"))){c.log("GroupTokenTracker: No legacy associations to migrate, setting global flag");try{await game.settings.set(k,e.legacyTokenAssociationsMigrated.tag,!0)}catch{c.log("GroupTokenTracker: Could not set migration flag, setting may not be registered yet")}return}const o=game.actors.filter(a=>(a.type==="group"||a.type==="encounter")&&a.getFlag(k,"tokenAssociations")&&!a.getFlag(k,"tokenAssociationsByScene"));for(const a of o)await this.migrateLegacyAssociations(a);try{await game.settings.set(k,e.legacyTokenAssociationsMigrated.tag,!0),c.log(`GroupTokenTracker: Migrated legacy associations for ${o.length} group actors and set global completion flag`)}catch{c.log(`GroupTokenTracker: Migrated legacy associations for ${o.length} group actors but could not set completion flag`)}}static setupPlaceMembersTracking(){Hooks.on(x.PRE_CREATE_TOKEN,(e,t,s,o)=>{if(!(o!==game.user.id||!game.user.isGM)){c.log("preCreateToken",[e,t,s,o]);for(const[a,i]of this.pendingPlacements.entries())i.memberActorIds.includes(t.actorId)&&i.isPlacing&&e.updateSource({flags:{[k]:{groupId:a,fromGroupPlacement:!0}}})}}),this._wrapPlaceMembersMethod()}static _wrapPlaceMembersMethod(){if(!Tt.register("CONFIG.Actor.dataModels.group.prototype.placeMembers",async function(t,...s){const o=this.parent;return await tt._trackPlaceMembers(o),t(...s)},"WRAPPER")){c.log("GroupTokenTracker: libWrapper not available, using fallback wrapping for group.placeMembers");const t=CONFIG.Actor.dataModels.group.prototype.placeMembers;CONFIG.Actor.dataModels.group.prototype.placeMembers=async function(...s){const o=this.parent;return await tt._trackPlaceMembers(o),t.call(this,...s)}}if(CONFIG.Actor.dataModels.encounter&&!Tt.register("CONFIG.Actor.dataModels.encounter.prototype.placeMembers",async function(s,...o){const a=this.parent;return await tt._trackPlaceMembers(a),s(...o)},"WRAPPER")){c.log("GroupTokenTracker: libWrapper not available, using fallback wrapping for encounter.placeMembers");const s=CONFIG.Actor.dataModels.encounter.prototype.placeMembers;CONFIG.Actor.dataModels.encounter.prototype.placeMembers=async function(...o){const a=this.parent;return await tt._trackPlaceMembers(a),s.call(this,...o)}}}static async _trackPlaceMembers(e){c.log("GroupTokenTracker: placeMembers clicked for",e.name);const t=game.scenes.current;t&&await this.removeGroupAssociations(e,t);const s=await e.system.getPlaceableMembers(),o=s.map(n=>n.actor.id),a=s.reduce((n,r)=>{var d;const l=((d=r.quantity)==null?void 0:d.value)||1;return n+l},0);this.pendingPlacements.set(e.id,{groupActor:e,memberActorIds:o,expectedTokenCount:a,placedTokenCount:0,timestamp:Date.now(),isPlacing:!0});const i=e.getFlag(k,"tokenAssociationsByScene")||{};this.activeAssociations.set(e.id,JSON.parse(JSON.stringify(i))),setTimeout(()=>{const n=this.pendingPlacements.get(e.id);n&&(n.isPlacing=!0,c.log(`GroupTokenTracker: Token placement phase active for group ${e.name}`))},100),setTimeout(()=>{var r;const n=this.pendingPlacements.get(e.id);n&&n.timestamp===((r=this.pendingPlacements.get(e.id))==null?void 0:r.timestamp)&&(c.log(`GroupTokenTracker: Timeout reached for group ${e.name}, cleaning up`),this.pendingPlacements.delete(e.id),this.activeAssociations.delete(e.id))},12e4)}static async onCreateToken(e,t,s){if(s!==game.user.id||(await this.cleanupCopiedTokenFlags(e),!game.user.isGM))return;const o=e.getFlag(k,"fromGroupPlacement"),a=e.getFlag(k,"groupId");if(!o||!a){await this.cleanupDanglingAssociations();return}const i=this.pendingPlacements.get(a);if(!i)return;const n=e.actorId,r=e.parent.id,l=e.uuid,d=this.activeAssociations.get(a)||{};d[r]||(d[r]={}),d[r][n]||(d[r][n]=[]);const u=[...d[r][n]];u.includes(l)||(u.push(l),d[r][n]=u,this.activeAssociations.set(a,d),await i.groupActor.setFlag(k,"tokenAssociationsByScene",d),await e.unsetFlag(k,"fromGroupPlacement"),i.placedTokenCount++,i.placedTokenCount>=i.expectedTokenCount?(i.isPlacing=!1,c.log(`GroupTokenTracker: All tokens placed for group ${i.groupActor.name}, cleaning up`),this.pendingPlacements.delete(a),this.activeAssociations.delete(a),setTimeout(()=>{this._reRenderGroupSheets(a)},100)):this._reRenderGroupSheets(a)),await this.cleanupDanglingAssociations()}static async onDeleteActor(e,t,s){if(e.type!=="group"&&e.type!=="encounter"||!game.user.isGM)return;c.log(`GroupTokenTracker: Group/encounter ${e.name} deleted, cleaning up token flags`);const o=e.getFlag(k,"tokenAssociationsByScene");if(!o){c.log(`GroupTokenTracker: No associations found for deleted group ${e.name}`);return}c.log(`GroupTokenTracker: Found associations for ${Object.keys(o).length} scene(s)`);let a=0,i=0;for(const[n,r]of Object.entries(o)){const l=game.scenes.get(n);c.log("GroupTokenTracker: Processing scene",[(l==null?void 0:l.name)||n,r]);for(const[d,u]of Object.entries(r)){c.log("GroupTokenTracker: Processing tokens for actor",[d,u]);for(const f of u)try{const g=await fromUuid(f);g?(await g.unsetFlag(k,"groupId"),c.log(`GroupTokenTracker: Removed groupId flag from token ${g.name} in scene ${(l==null?void 0:l.name)||n}`),a++):(c.log(`GroupTokenTracker: Token ${f} no longer exists`),i++)}catch(g){c.log(`GroupTokenTracker: Failed to remove flag from token ${f}`,g),i++}}}c.log(`GroupTokenTracker: Cleaned up token flags for deleted group ${e.name} - ${a} succeeded, ${i} failed`)}static async onUpdateActor(e,t,s,o){var l,d;if(e.type!=="group"&&e.type!=="encounter"||!game.user.isGM||!((l=t.system)!=null&&l.members))return;c.log(`GroupTokenTracker: Group/encounter ${e.name} updated, checking for removed members`);const a=e.getFlag(k,"tokenAssociationsByScene");if(!a)return;const i=new Set;if(e.type==="group")for(const u of e.system.members||[])(d=u.actor)!=null&&d.id&&i.add(u.actor.id);else for(const u of e.system.members||[])try{const f=await fromUuid(u.uuid);f!=null&&f.id&&i.add(f.id)}catch(f){c.log(`GroupTokenTracker: Failed to resolve member UUID ${u.uuid}`,f)}let n=!1;const r={...a};for(const[u,f]of Object.entries(r)){for(const g of Object.keys(f))if(!i.has(g)){c.log(`GroupTokenTracker: Member ${g} removed from group ${e.name}, cleaning up associations`);const m=f[g];for(const p of m)try{const S=await fromUuid(p);S&&(await S.unsetFlag(k,"groupId"),c.log(`GroupTokenTracker: Removed groupId flag from token ${S.name}`))}catch(S){c.log(`GroupTokenTracker: Failed to remove flag from token ${p}`,S)}delete f[g],n=!0}Object.keys(f).length===0&&delete r[u]}n&&(Object.keys(r).length===0?await e.unsetFlag(k,"tokenAssociationsByScene"):await e.setFlag(k,"tokenAssociationsByScene",r),c.log(`GroupTokenTracker: Cleaned up associations for removed members from group ${e.name}`),this._reRenderGroupSheets(e.id))}static async onDeleteToken(e,t,s){const o=e.getFlag(k,"groupId");if(!o)return;const a=game.actors.get(o);if(!a)return;const i=e.actorId,n=e.parent.id,r=e.uuid;c.log(`GroupTokenTracker: onDeleteToken - Token ${e.name} deleted from scene ${n}, group ${a.name}`);const l=a.getFlag(k,"tokenAssociationsByScene");if(!l||!l[n]||!l[n][i]){c.log("GroupTokenTracker: No associations found for this token");return}const d=l[n][i].indexOf(r);if(d===-1){c.log("GroupTokenTracker: Token UUID not found in associations");return}c.log(`GroupTokenTracker: Removing deleted token ${r} from group ${o}`),l[n][i].splice(d,1),l[n][i].length===0&&delete l[n][i],Object.keys(l[n]).length===0&&delete l[n],Object.keys(l).length===0?await a.unsetFlag(k,"tokenAssociationsByScene"):await a.setFlag(k,"tokenAssociationsByScene",l),await this.cleanupDanglingAssociations(),this._reRenderGroupSheets(o)}static _reRenderGroupSheets(e=null){var t,s,o,a;if(foundry.applications.instances)for(const i of foundry.applications.instances.values())(((t=i.document)==null?void 0:t.type)==="group"||((s=i.document)==null?void 0:s.type)==="encounter")&&(!e||i.document.id===e)&&(c.log(`GroupTokenTracker: Re-rendering ApplicationV2 sheet for ${i.document.name}`),i.render({force:!0}));if(ui.windows)for(const i of Object.values(ui.windows))(((o=i.document)==null?void 0:o.type)==="group"||((a=i.document)==null?void 0:a.type)==="encounter")&&(!e||i.document.id===e)&&(c.log(`GroupTokenTracker: Re-rendering legacy sheet for ${i.document.name}`),i.render(!1))}static cleanupOldPendingPlacements(){const e=Date.now(),t=5e3;for(const[s,o]of this.pendingPlacements.entries())e-o.timestamp>t&&(c.log(`GroupTokenTracker: Cleaning up old pending placement for group ${s}`),this.pendingPlacements.delete(s))}static async cleanupInvalidTokens(e){if(e.type!=="group"&&e.type!=="encounter")return;const t=e.getFlag(k,"tokenAssociationsByScene");if(!t)return;let s=!1;const o={};for(const[a,i]of Object.entries(t)){if(!game.scenes.get(a)){c.log(`GroupTokenTracker: Scene ${a} no longer exists, removing associations`),s=!0;continue}const r={};for(const[l,d]of Object.entries(i)){const u=d.filter(f=>{try{const g=fromUuidSync(f);return g&&g.actorId===l&&g.parent.id===a}catch{return c.log(`GroupTokenTracker: Invalid token UUID ${f}, removing`),!1}});u.length>0&&(r[l]=u),u.length!==d.length&&(s=!0)}Object.keys(r).length>0&&(o[a]=r)}s&&(Object.keys(o).length===0?await e.unsetFlag(k,"tokenAssociationsByScene"):await e.setFlag(k,"tokenAssociationsByScene",o),c.log(`GroupTokenTracker: Cleaned invalid tokens for group ${e.name}`))}static async cleanupDanglingAssociations(){const e=game.actors.filter(t=>(t.type==="group"||t.type==="encounter")&&t.getFlag(k,"tokenAssociationsByScene"));for(const t of e)await this.cleanupInvalidTokens(t);c.log(`GroupTokenTracker: Cleaned dangling associations for ${e.length} group actors`)}static getGroupForToken(e){const t=e.getFlag(k,"groupId");return t&&game.actors.get(t)||null}static getGroupTokens(e,t=null){const s=t||game.scenes.active,o=new Map;if(!s)return o;const i=(e.getFlag(k,"tokenAssociationsByScene")||{})[s.id];if(!i)return o;for(const[n,r]of Object.entries(i)){const l=r.map(d=>{try{return fromUuidSync(d)}catch{return c.log(`GroupTokenTracker: Invalid token UUID ${d}`),null}}).filter(d=>d&&d.actorId===n&&d.parent.id===s.id);l.length>0&&o.set(n,l)}return o}static getAllGroupTokens(e){const t=e.getFlag(k,"tokenAssociationsByScene")||{},s=new Map;for(const[o,a]of Object.entries(t)){if(!game.scenes.get(o))continue;const n=new Map;for(const[r,l]of Object.entries(a)){const d=l.map(u=>{try{return fromUuidSync(u)}catch{return null}}).filter(u=>u&&u.actorId===r);d.length>0&&n.set(r,d)}n.size>0&&s.set(o,n)}return s}static async cleanupCopiedTokenFlags(e){var n,r;const t=e.getFlag(k);if(!t)return;const s=t.groupId;if(t.fromGroupPlacement)return;let a=!1;const i=[];if(s){const l=game.actors.get(s),d=e.parent.id,u=e.uuid;if(!l)a=!0,i.push("group actor no longer exists");else{const f=l.getFlag(k,"tokenAssociationsByScene");((r=(n=f==null?void 0:f[d])==null?void 0:n[e.actorId])==null?void 0:r.includes(u))||(a=!0,i.push("not in group associations"))}}t.movementRestriction&&!s&&(a=!0,i.push("orphaned movement restriction")),a&&(c.log(`GroupTokenTracker: Cleaning up invalid module flags from token ${e.name} (${e.id})`),c.log("GroupTokenTracker: Cleanup reasons:",i),c.log("GroupTokenTracker: Removing flags:",Object.keys(t)),await e.unsetFlag(k))}static async migrateLegacyAssociations(e){const t=e.getFlag(k,"tokenAssociations"),s=e.getFlag(k,"tokenAssociationsByScene");if(!t||s)return;c.log(`GroupTokenTracker: Migrating legacy associations for group ${e.name}`);const o={};let a=0;for(const i of game.scenes){const n={};for(const[r,l]of Object.entries(t)){const d=l.map(u=>{const f=i.tokens.get(u);return f&&f.actorId===r?f.uuid:null}).filter(u=>u!==null);d.length>0&&(n[r]=d,a+=d.length)}Object.keys(n).length>0&&(o[i.id]=n)}Object.keys(o).length>0?(await e.setFlag(k,"tokenAssociationsByScene",o),c.log(`GroupTokenTracker: Migrated ${a} tokens across ${Object.keys(o).length} scenes for group ${e.name}`)):c.log(`GroupTokenTracker: No valid tokens found to migrate for group ${e.name}`),await e.unsetFlag(k,"tokenAssociations")}static async checkAndSyncAssociations(e,t){const s=e.type==="group"?(e.system.members||[]).map(n=>({actor:n.actor,quantity:1})):await Promise.all((e.system.members||[]).map(async n=>{var d;const r=await fromUuid(n.uuid),l=typeof n.quantity=="object"?((d=n.quantity)==null?void 0:d.value)||1:n.quantity||1;return{actor:r,quantity:l}})),o=e.getFlag(k,"tokenAssociationsByScene")||{},a=o[t.id]||{};let i=!1;for(const{actor:n,quantity:r}of s){if(!n)continue;const l=n.id,d=a[l]||[],u=d.filter(S=>{try{const y=fromUuidSync(S);return y&&y.parent.id===t.id}catch{return!1}}),f=t.tokens.filter(S=>{var y,R;return S.actorId===l?!0:S.actorLink?!1:((R=(y=S.actor)==null?void 0:y.prototypeToken)==null?void 0:R.actorId)===l}),g=r,m=u.length,p=f.length;if(m!==g&&p>=g){i=!0;break}if(u.length!==d.length){i=!0;break}}i&&await this.autoSyncTokens(e,t),c.log("checkAndSyncAssociations",[o])}static async onRenderActorSheet(e,t,s){if(c.log("onRenderActorSheet",[e,t,s]),!e.document||!game.user.isGM||e.document.type!=="group"&&e.document.type!=="encounter")return;const o=this._getMainContentElement(t);if(!o)return;const a=game.scenes.current;if(!a)return;await this._cleanupInvalidAssociations(e.document);const i=this._countValidTokens(e.document,a),n=this._createTokenAssociationUI(e.document,a,i);this._removeExistingContainers(o),o.appendChild(n)}static _getMainContentElement(e){let t=e.querySelector('[data-container-id="main"]');return t||(t=e),t}static _removeExistingContainers(e){e.querySelectorAll(".flash5e-token-associations").forEach(s=>s.remove())}static async _cleanupInvalidAssociations(e){var a;const t=e.getFlag(k,"tokenAssociationsByScene")||{};let s=!1;c.log("onRenderActorSheet - tokenAssociationsByScene",[t]);const o=new Set;if(e.type==="group")for(const i of e.system.members||[])(a=i.actor)!=null&&a.id&&o.add(i.actor.id);else for(const i of e.system.members||[])try{const n=await fromUuid(i.uuid);n!=null&&n.id&&o.add(n.id)}catch(n){c.log(`GroupTokenTracker: Failed to resolve member UUID ${i.uuid}`,n)}for(const i of Object.keys(t)){if(!game.scenes.get(i)){delete t[i],s=!0;continue}const r=t[i];for(const[l,d]of Object.entries(r)){if(!o.has(l)){c.log(`GroupTokenTracker: Actor ${l} is not a member of group ${e.name}, removing stale associations`);for(const f of d)try{const g=await fromUuid(f);g&&(await g.unsetFlag(k,"groupId"),c.log(`GroupTokenTracker: Removed groupId flag from token ${g.name}`))}catch(g){c.log(`GroupTokenTracker: Failed to remove flag from token ${f}`,g)}delete r[l],s=!0;continue}const u=d.filter(f=>{try{const g=fromUuidSync(f);return g&&g.parent.id===i}catch{return!1}});u.length!==d.length&&(s=!0),u.length>0?r[l]=u:delete r[l]}Object.keys(r).length===0&&(delete t[i],s=!0)}s&&(Object.keys(t).length===0?await e.unsetFlag(k,"tokenAssociationsByScene"):await e.setFlag(k,"tokenAssociationsByScene",t),z.refreshIfOpen())}static _countValidTokens(e,t){const o=(e.getFlag(k,"tokenAssociationsByScene")||{})[t.id]||{};let a=0;for(const[i,n]of Object.entries(o))for(const r of n)try{const l=fromUuidSync(r);l&&l.parent.id===t.id&&a++}catch{}return a}static _createTokenAssociationUI(e,t,s){const o=document.createElement("div");o.classList.add("sheet-body","flash5e-token-associations"),s===0&&o.classList.add("no-tokens");const a=document.createElement("div");if(a.textContent=s>0?game.i18n.format("FLASH_ROLLS.ui.tokenAssociations.associatedTokens",{count:s}):game.i18n.localize("FLASH_ROLLS.ui.tokenAssociations.noTokensInScene"),o.appendChild(a),s>0){const i=document.createElement("div");i.className="button-group";const n=document.createElement("button");n.type="button",n.className="flash5e-select-tokens",n.textContent=game.i18n.localize("FLASH_ROLLS.ui.inputs.selectTokens"),n.addEventListener("click",async()=>{await this.selectGroupTokens(e,t)}),i.appendChild(n),o.appendChild(i)}return o}static async removeGroupAssociations(e,t){const s=e.getFlag(k,"tokenAssociationsByScene")||{},o=s[t.id]||{};if(Object.keys(o).length===0)return;const a=[];for(const i of Object.values(o))a.push(...i);for(const i of a)try{const n=fromUuidSync(i);n&&n.parent.id===t.id&&await n.unsetFlag(k,"groupId")}catch(n){c.log(`GroupTokenTracker: Failed to remove groupId flag from token ${i}`,n)}delete s[t.id],Object.keys(s).length===0?await e.unsetFlag(k,"tokenAssociationsByScene"):await e.setFlag(k,"tokenAssociationsByScene",s)}static async selectGroupTokens(e,t){const o=(e.getFlag(k,"tokenAssociationsByScene")||{})[t.id]||{},a=[];for(const i of Object.values(o))for(const n of i)try{const r=fromUuidSync(n);if(r&&r.parent.id===t.id){const l=canvas.tokens.get(r.id);l&&a.push(l)}}catch(r){c.log(`GroupTokenTracker: Failed to resolve token ${n}`,r)}if(a.length===0){D.notify("warn",`No tokens found for ${e.name} in ${t.name}`);return}canvas.tokens.releaseAll();for(const i of a)i.control({releaseOthers:!1});a.length>0&&canvas.animatePan({x:a[0].center.x,y:a[0].center.y,duration:250})}static async onCanvasReady(e){if(!game.user.isGM)return;const t=game.scenes.current;if(!t)return;const s=game.actors.filter(o=>o.type==="group"||o.type==="encounter");await Promise.all(s.map(o=>this.autoSyncTokens(o,t))),z.refreshIfOpen(),setTimeout(()=>{this._reRenderGroupSheets()},500)}static async autoSyncTokens(e,t){const s=e.getFlag(k,"tokenAssociationsByScene")||{},o=s[t.id]||{},a=e.type==="group"?(e.system.members||[]).map(n=>({actor:n.actor,quantity:1})):await Promise.all((e.system.members||[]).map(async n=>{var d;const r=await fromUuid(n.uuid),l=typeof n.quantity=="object"?((d=n.quantity)==null?void 0:d.value)||1:n.quantity||1;return{actor:r,quantity:l}}));let i=!1;for(const{actor:n,quantity:r}of a){if(!n)continue;const l=n.id,d=o[l]||[],u=d.filter(y=>{try{const R=fromUuidSync(y);return R&&R.parent.id===t.id}catch{return!1}}),f=t.tokens.filter(y=>{var _,T;const R=y.actorId===l,A=!y.actorLink&&((T=(_=y.actor)==null?void 0:_.prototypeToken)==null?void 0:T.actorId)===l;return R||A}),g=r,m=u.length;if(m>=g){u.length!==d.length&&(o[l]=u,i=!0);continue}const p=[];for(const y of f){const R=y.getFlag(k,"groupId"),A=u.includes(y.uuid);if(R&&R!==e.id){const _=game.actors.get(R);if(!_)c.log(`GroupTokenTracker: Clearing stale groupId flag from token ${y.name}`),await y.unsetFlag(k,"groupId");else{c.log(`GroupTokenTracker: Token ${y.name} belongs to different group ${_.name}, skipping`);continue}}A||p.push(y)}const S=p.slice(0,g-m);if(S.length>0){const y=[...u,...S.map(R=>R.uuid)];o[l]=y,i=!0;for(const R of S)await R.setFlag(k,"groupId",e.id)}}i&&(s[t.id]=o,await e.setFlag(k,"tokenAssociationsByScene",s),c.log(`GroupTokenTracker: Auto-sync completed for group ${e.name}`))}};E(tt,"pendingPlacements",new Map),E(tt,"activeAssociations",new Map);let Ce=tt;class da{static initialize(){const e=foundry.canvas.placeables.Token,t=e.prototype.animate;e.prototype.animate=async function(s,o={}){const a=I(),i=v.get(a.tokenMovementSpeed.tag);return i&&!o.movementSpeed&&(o.movementSpeed=i),t.call(this,s,o)}}}var rt,bo,Ao,To;const Ve=class Ve{static initialize(){this.originalActivationMS=game.tooltip.constructor.TOOLTIP_ACTIVATION_MS,X(this,rt,bo).call(this),X(this,rt,Ao).call(this),X(this,rt,To).call(this)}static setupAutoDismiss(e,t){t>0&&Ve.scheduleAutoDismiss(e,t*1e3)}static scheduleAutoDismiss(e,t){this.clearAutoDismiss(e);const s=setTimeout(()=>{game.tooltip.element===e&&game.tooltip.deactivate(),this.dismissTimers.delete(e)},t);this.dismissTimers.set(e,s)}static clearAutoDismiss(e){const t=this.dismissTimers.get(e);t&&(clearTimeout(t),this.dismissTimers.delete(e))}};rt=new WeakSet,bo=function(){const e=game.tooltip,t=e.constructor,s=t.TOOLTIP_ACTIVATION_MS;e._frCustomDelayElement=null,window.addEventListener("pointerenter",o=>{var a;(a=o.target.dataset)!=null&&a.tooltip&&(e._frCustomDelayElement=o.target)},{capture:!0}),Object.defineProperty(t,"TOOLTIP_ACTIVATION_MS",{get(){var a;const o=e._frCustomDelayElement;if((a=o==null?void 0:o.closest)!=null&&a.call(o,"#flash-rolls-menu")&&o.dataset.tooltipDelay){const i=parseInt(o.dataset.tooltipDelay);if(!isNaN(i)&&i>0)return i}return s},configurable:!0})},Ao=function(){const e=game.tooltip.activate.bind(game.tooltip);game.tooltip.activate=function(t,s={}){if(t==null?void 0:t.closest("#flash-rolls-menu")){const a=I(),i=v.get(a.tooltipAutoDismiss.tag);if(i===0)return;const n=e(t,s);return Ve.setupAutoDismiss(t,i),n}return e(t,s)}},To=function(){const e=game.tooltip.deactivate.bind(game.tooltip);game.tooltip.deactivate=function(){const t=e();return Ve.clearAutoDismiss(game.tooltip.element),Ve.lastHoveredElement=null,t}},fe(Ve,rt),E(Ve,"dismissTimers",new Map),E(Ve,"originalActivationMS",null);let os=Ve;const Ot=class Ot{static getUpdateNewsUrl(){var s;const e=(s=game.modules.get("flash-rolls-5e"))==null?void 0:s.version,t=e?`https://github.com/crlngn/flash-rolls-5e/releases/download/v${e}/module-updates.json`:"";return`https://proxy.carolingian.io/proxy?url=${encodeURIComponent(t)}&v=${e}`}static init(){var e;(e=game.user)!=null&&e.isGM&&this.checkForUpdates()}static async cleanSetting(){const e=I();await v.set(e.lastUpdateId.tag,"")}static async checkForUpdates(){const e=I();try{const t=new AbortController,s=setTimeout(()=>t.abort(),1e4);try{const o=await v.get(e.lastUpdateId.tag),a=await Ot.getIdFromRawJson();if(c.log("checkForUpdates...",[a,o]),o===a)return;const i=await fetch(Ot.getUpdateNewsUrl(),{signal:t.signal,mode:"cors",credentials:"omit"});if(clearTimeout(s),!i.ok){c.warn("checkForUpdates | Failed to fetch update news",[i.status,i.statusText]);return}const n=await i.json();await this.displayUpdateNews(n),await v.set(e.lastUpdateId.tag,a),c.log("checkForUpdates | SUCCESS",[a])}catch(o){clearTimeout(s),o.name==="AbortError"?c.warn("checkForUpdates | Request timed out",[o]):c.warn("checkForUpdates | Fetch error",[o.message])}}catch(t){c.warn("checkForUpdates | Unexpected error",[t])}}static async displayUpdateNews(e){try{const t=`
        <div class="crlngn-news">
          <h3>${e.title}</h3>
          ${e.imageUrl?`<img src="${e.imageUrl}" alt="Update Preview" />`:""}
          ${e.videoUrl?`<div class="updates-media-container"><video controls autoplay loop src="${e.videoUrl}" alt="Update Preview" style="width: 100%"></video></div>`:""}
          <div class="crlngn-news-content">
          ${e.content}
          </div>
        </div>
      `;c.log("displayUpdateNews | Creating chat message",[e]);const s=await ChatMessage.create({content:t,whisper:[game.user.id],speaker:{alias:"Flash Token Bar 5e"}});c.log("displayUpdateNews | Chat message created",[s,e])}catch(t){c.error("displayUpdateNews | Error creating chat message",[t])}}};E(Ot,"getIdFromRawJson",async()=>{const t=await fetch("https://raw.githubusercontent.com/crlngn/flash-rolls-5e/refs/heads/main/news/module-updates.json"),s=t.ok?await t.json():null;return s&&s.id||""});let as=Ot;const Jt=class Jt{static initialize(){var e;if(!((e=game.modules.get("monks-active-tiles"))!=null&&e.active)){c.log("MonksActiveTilesIntegration: Monk's Active Tiles not active, skipping integration");return}Hooks.on("setupTileActions",t=>{c.log("MonksActiveTilesIntegration: Registering Flash Rolls 5e tile actions"),t.registerTileGroup(k,"Flash Token Bar 5e"),this._registerRequestRollAction(t),this._registerHealAllAction(t),this._registerKillAllAction(t),this._registerToggleMovementAction(t),this._registerTeleportTokensAction(t),this._registerTransformActorsAction(t)})}static _registerRequestRollAction(e){e.registerTileAction(k,"request-roll",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.requestRoll"),group:k,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"},{id:"requestType",name:"Roll Type",type:"list",list:()=>{const t={};for(const[s,o]of Object.entries(yt))t[o.name]=o.label;return t},required:!0,defvalue:L.SKILL,onChange:async(t,s,o,a)=>{var l,d,u;const i=$(s).val(),n=Object.values(yt).find(f=>f.name===i),r=$('select[name="data.rollKey"]',t.element);if(r.length>0){if(r.empty(),i===L.CUSTOM)for(const[f,g]of Object.entries(As))r.append($("<option>",{value:f,text:g}));else if(n&&n.subList){const f=n.subList;let g={};if(f==="abilities"){g=((l=CONFIG.DND5E)==null?void 0:l.abilities)||{};for(const[m,p]of Object.entries(g))r.append($("<option>",{value:m,text:p.label}))}else if(f==="skills"){g=((d=CONFIG.DND5E)==null?void 0:d.skills)||{};for(const[m,p]of Object.entries(g))r.append($("<option>",{value:m,text:p.label}))}else if(f==="tools"){g=((u=CONFIG.DND5E)==null?void 0:u.tools)||{};for(const[m,p]of Object.entries(g)){const S=await this._getToolName(m,p);r.append($("<option>",{value:m,text:S}))}}}}t.checkConditional()}},{id:"rollKey",name:"Roll Name",type:"list",list:async t=>{var n,r,l,d,u;const s=(r=(n=t.element)==null?void 0:n.querySelector('select[name="data.requestType"]'))==null?void 0:r.value;if(!s)return{};if(s===L.CUSTOM)return As;const o=Object.values(yt).find(f=>f.name===s);if(!o||!o.subList)return{};const a=o.subList,i={};if(a==="abilities")for(const[f,g]of Object.entries(((l=CONFIG.DND5E)==null?void 0:l.abilities)||{}))i[f]=g.label;else if(a==="skills")for(const[f,g]of Object.entries(((d=CONFIG.DND5E)==null?void 0:d.skills)||{}))i[f]=g.label;else if(a==="tools")for(const[f,g]of Object.entries(((u=CONFIG.DND5E)==null?void 0:u.tools)||{}))i[f]=await Jt._getToolName(f,g);return i},conditional:t=>{var a,i;const s=(i=(a=t.element)==null?void 0:a.querySelector('select[name="data.requestType"]'))==null?void 0:i.value;if(!s)return!1;if(s===L.CUSTOM)return!0;const o=Object.values(yt).find(n=>n.name===s);return o&&o.subList!==null}},{id:"dc",name:"Difficulty Class (DC)",type:"number",defvalue:10,min:0,max:50},{id:"advantage",name:"Advantage/Disadvantage",type:"list",list:()=>({normal:"Normal",advantage:"Advantage",disadvantage:"Disadvantage"}),defvalue:"normal"},{id:"bonus",name:"Situational Bonus",type:"text",help:"Enter a bonus/penalty (e.g., '+2', '-1', '1d4')"},{id:"skipRollDialog",name:"Skip Roll Dialog",type:"checkbox",defvalue:!1}],fn:async t=>{var u,f,g,m,p,S;const{action:s,tokens:o,tile:a}=t;if(ae._isTeleporting)return c.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=o;if(((f=(u=s.data)==null?void 0:u.entity)==null?void 0:f.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const y=a.entitiesWithin({collection:"tokens"});Array.isArray(y)&&y.length>0&&(i=y)}else if(((m=(g=s.data)==null?void 0:g.entity)==null?void 0:m.id)==="players")i=canvas.tokens.placeables.filter(y=>{var R;return(R=y.actor)==null?void 0:R.hasPlayerOwner});else if((S=(p=s.data)==null?void 0:p.entity)!=null&&S.id&&typeof s.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(s.data.entity.id)){const y=s.data.entity.id,R=await fromUuid(y);R&&(i=[R])}const n=this._resolveActorIds(null,i);if(!n||n.length===0)return D.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{};const r=this._generateGroupRollId(a,s);if(this._pendingGroupRolls.has(r)){const y=this._pendingGroupRolls.get(r);for(const R of n)y.actorIds.includes(R)||y.actorIds.push(R);return{}}this._pendingGroupRolls.set(r,{actorIds:[...n],action:s,tile:a}),await new Promise(y=>setTimeout(y,50));const l=this._pendingGroupRolls.get(r);this._pendingGroupRolls.delete(r);const d={requestType:s.data.requestType,actorIds:l.actorIds,dc:s.data.dc,advantage:s.data.advantage==="advantage",disadvantage:s.data.advantage==="disadvantage",skipRollDialog:s.data.skipRollDialog===!0,sendAsRequest:!0,groupRollId:r};return s.data.rollKey&&(d.rollKey=s.data.rollKey),s.data.bonus&&(d.situationalBonus=s.data.bonus),await D.requestRoll(d),{}},content:async(t,s)=>{var g,m,p,S,y,R;const o=(g=s.data)==null?void 0:g.requestType,a=Object.values(yt).find(A=>A.name===o),i=(a==null?void 0:a.label)||o||"Unknown";let n="";(m=s.data)!=null&&m.rollKey&&(s.data.rollKey.length===3?n=` (${this._getSkillName(s.data.rollKey)||this._getAbilityName(s.data.rollKey)||s.data.rollKey})`:n=` (${s.data.rollKey})`);const r=(p=s.data)!=null&&p.dc?` DC ${s.data.dc}`:"",l=((S=s.data)==null?void 0:S.advantage)||"normal",d=this._getAdvantageLabel(l),u=(y=s.data)!=null&&y.bonus?` (${s.data.bonus})`:"",f=(R=s.data)!=null&&R.skipRollDialog?" [Skip Dialog]":"";return`<div>Request <span class="value">${i}${n}</span>${r}${d?" "+d:""}${u}${f}</div>`}})}static _registerHealAllAction(e){e.registerTileAction(k,"heal-all",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.healAll"),group:k,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"}],fn:async t=>{var r,l,d,u,f,g;const{action:s,tokens:o,tile:a}=t;if(ae._isTeleporting)return c.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=o;if(((l=(r=s.data)==null?void 0:r.entity)==null?void 0:l.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const m=a.entitiesWithin({collection:"tokens"});Array.isArray(m)&&m.length>0&&(i=m)}else if(((u=(d=s.data)==null?void 0:d.entity)==null?void 0:u.id)==="players")i=canvas.tokens.placeables.filter(m=>{var p;return(p=m.actor)==null?void 0:p.hasPlayerOwner});else if((g=(f=s.data)==null?void 0:f.entity)!=null&&g.id&&typeof s.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(s.data.entity.id)){const m=s.data.entity.id,p=await fromUuid(m);p&&(i=[p])}const n=this._resolveActorIds(null,i);return!n||n.length===0?(D.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{}):(await D.healAll(n),{})},content:async(t,s)=>`<div>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.content.healAll")}</div>`})}static _registerKillAllAction(e){e.registerTileAction(k,"kill-all",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.killAll"),group:k,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"}],fn:async t=>{var r,l,d,u,f,g;const{action:s,tokens:o,tile:a}=t;if(ae._isTeleporting)return c.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=o;if(((l=(r=s.data)==null?void 0:r.entity)==null?void 0:l.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const m=a.entitiesWithin({collection:"tokens"});Array.isArray(m)&&m.length>0&&(i=m)}else if(((u=(d=s.data)==null?void 0:d.entity)==null?void 0:u.id)==="players")i=canvas.tokens.placeables.filter(m=>{var p;return(p=m.actor)==null?void 0:p.hasPlayerOwner});else if((g=(f=s.data)==null?void 0:f.entity)!=null&&g.id&&typeof s.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(s.data.entity.id)){const m=s.data.entity.id,p=await fromUuid(m);p&&(i=[p])}const n=this._resolveActorIds(null,i);return!n||n.length===0?(D.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{}):(await D.killAll(n),{})},content:async(t,s)=>`<div>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.content.killAll")}</div>`})}static _registerOpenSheetsAction(e){e.registerTileAction(k,"open-sheets",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.openSheets"),group:k,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"}],fn:async t=>{var r,l,d,u,f,g;const{action:s,tokens:o,tile:a}=t;if(ae._isTeleporting)return c.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=o;if(((l=(r=s.data)==null?void 0:r.entity)==null?void 0:l.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const m=a.entitiesWithin({collection:"tokens"});Array.isArray(m)&&m.length>0&&(i=m)}else if(((u=(d=s.data)==null?void 0:d.entity)==null?void 0:u.id)==="players")i=canvas.tokens.placeables.filter(m=>{var p;return(p=m.actor)==null?void 0:p.hasPlayerOwner});else if((g=(f=s.data)==null?void 0:f.entity)!=null&&g.id&&typeof s.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(s.data.entity.id)){const m=s.data.entity.id,p=await fromUuid(m);p&&(i=[p])}const n=this._resolveActorIds(null,i);return!n||n.length===0?(D.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{}):(await D.openSheets(n),{})},content:async(t,s)=>`<div>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.content.openSheets")}</div>`})}static _registerToggleMovementAction(e){e.registerTileAction(k,"toggle-movement",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.toggleMovement"),group:k,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"}],fn:async t=>{var r,l,d,u,f,g;const{action:s,tokens:o,tile:a}=t;if(ae._isTeleporting)return c.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=o;if(((l=(r=s.data)==null?void 0:r.entity)==null?void 0:l.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const m=a.entitiesWithin({collection:"tokens"});Array.isArray(m)&&m.length>0&&(i=m)}else if(((u=(d=s.data)==null?void 0:d.entity)==null?void 0:u.id)==="players")i=canvas.tokens.placeables.filter(m=>{var p;return(p=m.actor)==null?void 0:p.hasPlayerOwner});else if((g=(f=s.data)==null?void 0:f.entity)!=null&&g.id&&typeof s.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(s.data.entity.id)){const m=s.data.entity.id,p=await fromUuid(m);p&&(i=[p])}const n=this._resolveActorIds(null,i);return!n||n.length===0?(D.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{}):(await D.toggleMovement(n),{})},content:async(t,s)=>`<div>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.content.toggleMovement")}</div>`})}static _registerTeleportTokensAction(e){e.registerTileAction(k,"teleport-tokens",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.teleportTokens"),group:k,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"},{id:"location",name:"Select Coordinates",type:"select",subtype:"either",options:{show:["either","tile","previous"]},restrict:(t,s)=>t instanceof foundry.canvas.placeables.Tile||t instanceof Scene,required:!0,placeholder:"Select a location"},{id:"snap",name:"Snap to Grid",type:"checkbox",defvalue:!0}],fn:async t=>{var p,S,y,R,A,_,T,b,C,w,M,O,F,N,W;const{action:s,tokens:o,tile:a,value:i}=t;c.log("MATT Teleport - Initial args:",[{actionEntityId:(S=(p=s.data)==null?void 0:p.entity)==null?void 0:S.id,tokensCount:o==null?void 0:o.length,valueTokensCount:(y=i==null?void 0:i.tokens)==null?void 0:y.length}]);let n=[];if(((A=(R=s.data)==null?void 0:R.entity)==null?void 0:A.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const B=a.entitiesWithin({collection:"tokens"}),U=a.document?a:canvas.tiles.get(a.id);n=this._filterTokensWithinTileBounds(B,U)}else if(((T=(_=s.data)==null?void 0:_.entity)==null?void 0:T.id)==="players")n=canvas.tokens.placeables.filter(B=>{var U;return(U=B.actor)==null?void 0:U.hasPlayerOwner});else if((C=(b=s.data)==null?void 0:b.entity)!=null&&C.id&&typeof s.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(s.data.entity.id)){const B=s.data.entity.id,U=await fromUuid(B);U&&(n=[U])}else i!=null&&i.tokens&&Array.isArray(i.tokens)&&i.tokens.length>0?n=i.tokens:o&&Array.isArray(o)&&o.length>0&&(n=o);const r=[];for(const B of n)(B instanceof foundry.canvas.placeables.Token||B instanceof TokenDocument||B!=null&&B.id)&&r.push(B.id);if(!r||r.length===0)return D.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{};const l=(w=s.data)==null?void 0:w.location;if(!l)return await D.teleportTokens(r),{};let d,u=l.sceneId||null,f=null;if((M=i==null?void 0:i.stopdata)!=null&&M.tile)f=i.stopdata.tile,u=((F=(O=f.document)==null?void 0:O.parent)==null?void 0:F.id)||canvas.scene.id;else if(l.id&&typeof l.id=="string"&&!l.x&&!l.y){const B=await fromUuid(l.id);B instanceof foundry.canvas.placeables.Tile&&(f=B,u=((N=B.document.parent)==null?void 0:N.id)||canvas.scene.id)}if(!f&&(l.x!==void 0&&l.y!==void 0?d={x:l.x,y:l.y}:i!=null&&i.location&&(d={x:i.location.x,y:i.location.y},i.location.sceneId&&(u=i.location.sceneId)),!d))return c.warn("No valid location coordinates found, entering interactive mode",l),await D.teleportTokens(r),{};const g=u?game.scenes.get(u):canvas.scene;if(!g)return ui.notifications.error(`Scene not found: ${u}`),{};const m=((W=s.data)==null?void 0:W.snap)!==!1;if(f){const B=f.document,U={x:B.x,y:B.y,width:B.width,height:B.height},le=[];for(const de of r){const ue=canvas.tokens.get(de);if(!ue)continue;const Ee=ue.document.width*g.grid.size,ve=ue.document.height*g.grid.size,Ne=U.x+U.width-Ee,ze=U.y+U.height-ve,Nt=U.x+Math.random()*(Ne-U.x),Gt=U.y+Math.random()*(ze-U.y);let pt={x:Nt,y:Gt};m&&(pt=g.grid.getSnappedPoint(pt,{mode:CONST.GRID_SNAPPING_MODES.CENTER})),le.push({tokenId:de,finalLocation:pt})}for(const{tokenId:de,finalLocation:ue}of le)await D.teleportTokens([de],g,ue)}else await D.teleportTokens(r,g,d);return{}},content:async(t,s)=>{var l,d,u;const o=(l=s.data)==null?void 0:l.location;let a="coordinates";(o==null?void 0:o.id)==="previous"?a="previous location":(o==null?void 0:o.id)==="origin"?a="trigger origin":o!=null&&o.id&&(a=o.id);let i="";if(o!=null&&o.sceneId&&o.sceneId!==((d=canvas.scene)==null?void 0:d.id)){const f=game.scenes.get(o.sceneId);i=f?` in <span class="value">${f.name}</span>`:" in Unknown Scene"}const r=((u=s.data)==null?void 0:u.snap)??!0?" (snap to grid)":"";return`<div>${game.i18n.format("FLASH_ROLLS.ui.dialogs.matt.content.teleport",{location:`<span class="value">${a}</span>`,scene:i,snap:r})}</div>`}})}static _registerTransformActorsAction(e){e.registerTileAction(k,"transform-actors",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.transformActors"),group:k,ctrls:[{id:"entity",name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.transform.actors"),type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"},{id:"targetActorUuid",name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.transform.targetCreature"),type:"select",subtype:"entity",options:{show:["actor"]},restrict:t=>t instanceof Actor,required:!1,help:"Leave empty to show selection dialog"},{id:"preset",name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.transform.preset"),type:"list",list:()=>({polymorph:game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.presets.polymorph"),wildshape:game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.presets.wildshape"),appearance:game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.presets.appearance"),custom:game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.presets.custom")}),defvalue:"polymorph"},{id:"revert",name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.transform.revert"),type:"checkbox",defvalue:!1}],fn:async t=>{var r,l,d,u,f,g,m,p,S;const{action:s,tokens:o,tile:a}=t;if(ae._isTeleporting)return c.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=o;if(((l=(r=s.data)==null?void 0:r.entity)==null?void 0:l.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const y=a.entitiesWithin({collection:"tokens"});Array.isArray(y)&&y.length>0&&(i=y)}else if(((u=(d=s.data)==null?void 0:d.entity)==null?void 0:u.id)==="players")i=canvas.tokens.placeables.filter(y=>{var R;return(R=y.actor)==null?void 0:R.hasPlayerOwner});else if((g=(f=s.data)==null?void 0:f.entity)!=null&&g.id&&typeof s.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(s.data.entity.id)){const y=s.data.entity.id,R=await fromUuid(y);R&&(i=[R])}const n=[];for(const y of i){let R=null;if(y instanceof TokenDocument)R=y;else if(y instanceof foundry.canvas.placeables.Token)R=y.document;else if(y instanceof Actor){const A=canvas.tokens.placeables.find(_=>{var T;return((T=_.actor)==null?void 0:T.id)===y.id});A&&(R=A.document)}R&&!n.includes(R)&&n.push(R)}if(!n||n.length===0)return D.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{};if(n.map(y=>y.actor).filter(y=>y),(m=s.data)!=null&&m.revert){const y=n.filter(R=>{var A;return(A=R.actor)==null?void 0:A.getFlag("dnd5e","isPolymorphed")}).map(R=>R.id);y.length>0&&await D.revertTransformation(y)}else{const y=n.filter(T=>{var b;return!((b=T.actor)!=null&&b.getFlag("dnd5e","isPolymorphed"))}).map(T=>T.id);if(y.length===0)return{};let R=null;if((p=s.data)!=null&&p.targetActorUuid){if(typeof s.data.targetActorUuid=="string")R=s.data.targetActorUuid.trim()||null;else if(s.data.targetActorUuid.id){const T=await fromUuid(s.data.targetActorUuid.id);R=(T==null?void 0:T.uuid)||null}}const A=((S=s.data)==null?void 0:S.preset)||"polymorph";await D.transformActors(y,R,{preset:A,skipRevertCheck:!0})}return{}},content:async(t,s)=>{var r,l,d;if((r=s.data)==null?void 0:r.revert)return`<div>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.content.revertTransformation")}</div>`;let a=null;(l=s.data)!=null&&l.targetActorUuid&&(typeof s.data.targetActorUuid=="string"?a=s.data.targetActorUuid.trim()||null:s.data.targetActorUuid.id&&(a=s.data.targetActorUuid.id));const i=((d=s.data)==null?void 0:d.preset)||"polymorph";let n="selection dialog";if(a)try{const u=await fromUuid(a);n=(u==null?void 0:u.name)||"Unknown Actor"}catch{n="Invalid UUID"}return`<div>${game.i18n.format("FLASH_ROLLS.ui.dialogs.matt.content.transform",{target:`<span class="value">${n}</span>`,preset:i})}</div>`}})}static _filterTokensWithinTileBounds(e,t){if(!Array.isArray(e)||e.length===0||!t||!t.document)return[];const s=t.document,o={x:s.x,y:s.y,x2:s.x+s.width,y2:s.y+s.height};return e.filter(a=>{const i=a instanceof foundry.canvas.placeables.Token?a:canvas.tokens.get(a.id);if(!i)return!1;const n=i.document.x,r=i.document.y,l=i.document.width*canvas.grid.size,d=i.document.height*canvas.grid.size,u=n+l/2,f=r+d/2;return u>=o.x&&u<=o.x2&&f>=o.y&&f<=o.y2})}static _resolveActorIds(e,t){var o,a,i,n,r;const s=[];if(!t||t.length===0)return s;for(let l=0;l<t.length;l++){const d=t[l];let u=null;d instanceof TokenDocument||(d==null?void 0:d.documentName)==="Token"?u=(o=d.actor)==null?void 0:o.id:d instanceof foundry.canvas.placeables.Token?u=((i=(a=d.document)==null?void 0:a.actor)==null?void 0:i.id)||((n=d.actor)==null?void 0:n.id):d instanceof Actor?u=d.id:d!=null&&d.actorId?u=d.actorId:(r=d==null?void 0:d.actor)!=null&&r.id&&(u=d.actor.id),u&&!s.includes(u)&&s.push(u)}return s}static _getSkillName(e){var t,s,o;return e&&((o=(s=(t=CONFIG.DND5E)==null?void 0:t.skills)==null?void 0:s[e])==null?void 0:o.label)||null}static _getAbilityName(e){var t,s,o;return e&&((o=(s=(t=CONFIG.DND5E)==null?void 0:t.abilities)==null?void 0:s[e])==null?void 0:o.label)||null}static async _getToolName(e,t){var a,i,n;if(!e)return e;const s=((a=game.actors)==null?void 0:a.contents)||[];for(const r of s){const l=(n=(i=r.system)==null?void 0:i.tools)==null?void 0:n[e];if(l!=null&&l.label)return l.label}if(t!=null&&t.id)try{const r=await fromUuid(t.id);if(r!=null&&r.name)return r.name}catch(r){c.log(`MonksActiveTilesIntegration: Failed to fetch tool name for ${e}`,r)}return e.charAt(0).toUpperCase()+e.slice(1)}static _getAdvantageLabel(e){switch(e){case"advantage":return"with Advantage";case"disadvantage":return"with Disadvantage";default:return""}}static _generateGroupRollId(e,t){if(!(e!=null&&e.id))return foundry.utils.randomID();const s=Math.floor(Date.now()/100);return`matt-${e.id}-${t._id||"action"}-${s}`}};E(Jt,"_pendingGroupRolls",new Map);let is=Jt;const Te=class Te{static getActivityConfigFromCache(e){const t=Te.activityConfigCache.get(e);return t?Date.now()-t.timestamp>Te.CACHE_EXPIRY_MS?(Te.activityConfigCache.delete(e),c.log("getActivityConfigFromCache - deleted expired entry",[e]),null):t.config:null}static initialize(){Hooks.once(x.INIT,this._onInit.bind(this)),Hooks.once(x.READY,this._onReady.bind(this)),Hooks.on(x.CANVAS_READY,this._onCanvasReady.bind(this)),Hooks.on(Oo.READY,()=>{c.log("flash-rolls-5e.ready hook",[])}),Hooks.on(x.GET_CHAT_MESSAGE_CONTEXT_OPTIONS,(e,t)=>{c.log("getChatMessageContextOptions hook",[e,t]),game.user.isGM&&this._addGroupRollContextOptions(e,t)}),Hooks.on(x.CLIENT_SETTING_CHANGED,this._onClientSettingChanged.bind(this)),this._registerTidy5eHooks(),Hooks.once(x.GET_ACTOR_CONTEXT_OPTIONS,(e,t)=>{c.log("getActorContextOptions hook",[e,t]),game.user.isGM&&(t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.unblockFromMenu"),icon:'<i class="fas fa-bolt"></i>',callback:s=>{const o=s.dataset.entryId;return o&&he.toggleBlocked(o,!1),o},condition:s=>{var i;const o=(i=s==null?void 0:s.dataset)==null?void 0:i.entryId;return he.isBlocked(o)}}),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.blockFromMenu"),icon:'<i class="fas fa-bolt-slash"></i>',callback:s=>{const o=s.dataset.entryId;return o&&he.toggleBlocked(o,!0),o},condition:s=>{var i;const o=(i=s==null?void 0:s.dataset)==null?void 0:i.entryId;return!he.isBlocked(o)}}))})}static _addGroupRollContextOptions(e,t){c.log("_addGroupRollContextOptions",[e,t]),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.hideNPCsFromPlayers"),icon:'<i class="fas fa-eye-slash"></i>',callback:s=>{const o=s.dataset.messageId,a=game.messages.get(o);a&&(a.setFlag(k,"npcHiddenOverride",!0),D.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.npcHiddenFromPlayers")))},condition:s=>{const o=s.dataset.messageId;if(!o)return!1;const a=game.messages.get(o);if(!a||!a.getFlag(k,"isGroupRoll"))return!1;const i=I(),n=v.get(i.groupRollNPCHidden.tag),r=a.getFlag(k,"npcHiddenOverride");return!(r!==void 0?r:n)}}),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.showNPCsToPlayers"),icon:'<i class="fas fa-eye"></i>',callback:s=>{const o=s.dataset.messageId,a=game.messages.get(o);if(a){const i=I();v.get(i.groupRollNPCHidden.tag)?a.setFlag(k,"npcHiddenOverride",!1):a.unsetFlag(k,"npcHiddenOverride"),D.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.npcVisibleToPlayers"))}},condition:s=>{const o=s.dataset.messageId;if(!o)return!1;const a=game.messages.get(o);if(!a||!a.getFlag(k,"isGroupRoll"))return!1;const i=I(),n=v.get(i.groupRollNPCHidden.tag),r=a.getFlag(k,"npcHiddenOverride");return r!==void 0?r:n}}),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.showAllResultsToPlayers"),icon:'<i class="fas fa-eye"></i>',callback:s=>{const o=s.dataset.messageId,a=game.messages.get(o);a&&a.setFlag(k,"showAllResultsToPlayers",!0)},condition:s=>{const o=s.dataset.messageId;if(!o)return!1;const a=game.messages.get(o);return!a||!a.getFlag(k,"isGroupRoll")?!1:!a.getFlag(k,"showAllResultsToPlayers")}})}static _onInit(){I(),document.body.classList.add("flash5e"),v.registerSettings(),Ye.initialize(),this._registerHook(x.RENDER_CHAT_MESSAGE,ne.onRenderChatMessage.bind(ne)),this._registerHook(x.RENDER_ROLL_RESOLVER,this._onRenderRollResolver.bind(this)),is.initialize()}static _onReady(){var e;c.log("CONFIG.DND5E",[CONFIG.DND5E]),v.registerSettingsMenu(),ca.initialize(),Wt.addSidebarControls(ui.sidebar,(e=ui.sidebar)==null?void 0:e.element),as.init(),J.initialize(),game.user.isGM&&Tt.showMissingLibWrapperNotification(),matchMedia&&matchMedia("(prefers-color-scheme: dark)").addEventListener("change",this._onBrowserColorSchemeChanged.bind(this)),q.isModuleOn("midi-qol")?Hooks.once(Bs.READY,this._initModule.bind(this)):this._initModule(),c.log("HooksManager.ready",[canvas])}static async _initModule(){const e=I();v.get(e.debugMode.tag)&&(CONFIG.debug.hooks=!0),await ne.initialize(),this._registerHooks(),da.initialize(),os.initialize(),game.user.isGM?(us.initialize(),z.showOnLoadIfEnabled(),Ce.initialize(),game.users.forEach(o=>{this._onUserConnected(o)})):Ye.getDiceConfig(),Ls(Ts()),Fe.initializeCombatMovementRestrictions();const s=game.modules.get("flash-rolls-5e");s&&(s.api=D),globalThis.FlashAPI=D,globalThis.FlashRolls5e=D,Hooks.call("flash-rolls-5e.ready"),Ke.initialize()}static _registerHooks(){this._registerCommonHooks(),game.user.isGM?this._registerGMOnlyHooks():this._registerPlayerOnlyHooks()}static _registerCommonHooks(){this._registerHook(x.RENDER_SIDEBAR,this._onRenderSidebar.bind(this)),this._registerHook(x.CHANGE_SIDEBAR_TAB,this._onSidebarUpdate.bind(this)),this._registerHook(x.COLLAPSE_SIDE_BAR,this._onSidebarUpdate.bind(this)),this._registerHook(x.REFRESH_MEASURED_TEMPLATE,this.onRefreshTemplate.bind(this)),this._registerHook(x.CANVAS_READY,this._onCanvasReady.bind(this)),this._registerHook(x.CREATE_CHAT_MESSAGE,ne.onCreateChatMessage.bind(ne)),this._registerHook(x.PRE_CREATE_CHAT_MESSAGE,ne.onPreCreateChatMessage.bind(ne)),this._registerHook(x.RENDER_CHAT_LOG,ne.onRenderChatLog.bind(ne)),this._registerHook(x.PRE_UPDATE_TOKEN,this._onPreUpdateToken.bind(this)),this._registerHook(Y.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this)),this._registerHook(Y.RENDER_SKILL_TOOL_ROLL_DIALOG,this._onRenderSkillToolDialog.bind(this)),this._registerHook(Y.PRE_ROLL_HIT_DIE_V2,Re.onPreRollHitDieV2.bind(Re)),this._registerHook(Y.POST_ROLL_CONFIG,Re.onPostRollConfig.bind(Re)),this._registerHook(Y.ROLL_DAMAGE_V2,Re.onRollDamageV2.bind(Re))}static _registerGMOnlyHooks(){this._registerHook(x.USER_CONNECTED,this._onUserConnected.bind(this)),this._registerHook(Y.PRE_ROLL_V2,Re.onPreRollGM.bind(Re)),this._registerHook(Y.PRE_USE_ACTIVITY,Me.onPreUseActivityGM.bind(Me)),this._registerHook(Y.POST_USE_ACTIVITY,Me.onPostUseActivityGM.bind(Me)),this._registerHook(x.CREATE_COMBATANT,this._onCombatChange.bind(this)),this._registerHook(x.DELETE_COMBATANT,this._onCombatChange.bind(this)),this._registerHook(x.UPDATE_COMBAT,this._onCombatChange.bind(this)),this._registerHook(x.DELETE_COMBAT,this._onCombatChange.bind(this)),this._registerHook(x.COMBAT_START,this._onCombatStart.bind(this)),this._registerHook(x.COMBAT_TURN_CHANGE,this._onCombatTurnChange.bind(this)),this._registerHook(x.DELETE_COMBAT,this._onDeleteCombat.bind(this)),this._registerHook(x.CREATE_COMBATANT,this._onCreateCombatant.bind(this)),this._registerHook(x.CREATE_ACTIVE_EFFECT,this._onActiveEffectChange.bind(this)),this._registerHook(x.DELETE_ACTIVE_EFFECT,this._onActiveEffectChange.bind(this)),this._registerHook(x.UPDATE_ACTIVE_EFFECT,this._onActiveEffectChange.bind(this)),this._registerHook(x.UPDATE_SETTING,this._onSettingUpdate.bind(this)),this._registerHook(x.UPDATE_SCENE,this._onSceneUpdate.bind(this)),this._registerHook(x.UPDATE_ACTOR,this._onActorUpdate.bind(this)),this._registerHook(x.UPDATE_TOKEN,this._onTokenUpdate.bind(this)),this._registerHook(x.CREATE_TOKEN,this._onCreateToken.bind(this)),this._registerHook(x.DELETE_TOKEN,this._onDeleteToken.bind(this)),this._registerHook(x.CREATE_ACTOR,this._onCreateActor.bind(this)),this._registerHook(x.DELETE_ACTOR,this._onDeleteActor.bind(this)),this._registerHook(x.RENDER_CHAT_INPUT,this._onRenderChatInput.bind(this))}static _registerPlayerOnlyHooks(){this._registerHook(Y.PRE_ROLL_INITIATIVE_DIALOG,Re.onPreRollInitiativeDialog.bind(Re)),this._registerHook(Y.PRE_ROLL_ATTACK_V2,Re.onPreRollAttackV2.bind(Re)),this._registerHook(Y.PRE_ROLL_DAMAGE_V2,Re.onPreRollDamageV2.bind(Re)),Hooks.on(Y.PRE_ROLL_ABILITY_CHECK,Re.onPreRollAbilityCheck.bind(Re)),this._registerHook(Y.PRE_USE_ACTIVITY,Me.onPreUseActivityPlayer.bind(Me)),this._registerHook(Y.POST_USE_ACTIVITY,Me.onPostUseActivityPlayer.bind(Me))}static _onSidebarUpdate(e){c.log("_onSidebarUpdate",[e]),Ls(Ts())}static _onRenderChatInput(){c.log("_onRenderChatInput - syncing offset and faded-ui classes");const e=document.querySelector("#flash-rolls-menu");e&&e.classList.contains("docked-bottom")&&setTimeout(async()=>{const t={element:e};Ue.syncOffsetClass(t),Ue.syncFadedUIClass(t)},50)}static _onRenderRollConfigDialog(e,t,s){var a,i,n,r,l;if(c.log("_onRenderRollConfigDialog #0",[e,s]),e._flashRollsApplied)return;if(((i=(a=e.config)==null?void 0:a.hookNames)==null?void 0:i.includes("initiativeDialog"))||((r=(n=e.element)==null?void 0:n.id)==null?void 0:r.includes("initiative"))){const d=(l=e.config)==null?void 0:l.subject;if(!d)return;if(e._flashRollsTitleApplied||(t.querySelector(".window-title").textContent=game.i18n.localize("DND5E.Initiative"),t.querySelector(".window-subtitle").textContent=d.name,e._flashRollsTitleApplied=!0),d.getFlag(k,"tempInitiativeConfig")){e._flashRollsApplied=!0;const f=t.querySelector('input[name*="situational"]');setTimeout(()=>{f.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},50)}return}else t.querySelectorAll('input[name*="situational"]').forEach((u,f)=>{var g,m,p,S,y,R,A;c.log("_onRenderRollConfigDialog - processing input",[f,u.name,u.value]),!u.value&&((S=(p=(m=(g=e.config)==null?void 0:g.rolls)==null?void 0:m[0])==null?void 0:p.data)!=null&&S.situational)&&(u.value=e.config.rolls[0].data.situational),e.config.scaling=!0,u.value&&(e._flashRollsApplied=!0,(A=(R=(y=e.config)==null?void 0:y.rolls)==null?void 0:R[0])!=null&&A.data&&delete e.config.rolls[0].data.situational,setTimeout(()=>{u.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},150))})}static _onRenderRollResolver(e,t){var s,o,a,i,n,r,l;try{const d=e.roll;if(!d)return;c.log("_onRenderRollResolver - roll options:",[d.options]);const u=(s=d.options)==null?void 0:s.messageData;if(!((o=u==null?void 0:u.flags)!=null&&o[k])){c.log("_onRenderRollResolver - no metadata found in messageData");return}const{rollType:f,rollKey:g}=u.flags[k];if(!f){c.log("_onRenderRollResolver - no rollType found");return}c.log("_onRenderRollResolver - found metadata",[f,g]);const m=t[0].querySelector(".window-title");if(!m){c.log("_onRenderRollResolver - no title element found");return}let p;switch(f.toLowerCase()){case"ability":case"abilitycheck":p=`${game.i18n.localize(((a=CONFIG.DND5E.abilities[g])==null?void 0:a.label)||g)} ${game.i18n.localize("DND5E.AbilityCheck")}`;break;case"save":case"savingthrow":p=`${game.i18n.localize(((i=CONFIG.DND5E.abilities[g])==null?void 0:i.label)||g)} ${game.i18n.localize("DND5E.SavingThrow")}`;break;case"skill":p=game.i18n.localize(((n=CONFIG.DND5E.skills[g])==null?void 0:n.label)||g);break;case"tool":p=game.i18n.localize(((l=(r=CONFIG.DND5E.tools)==null?void 0:r[g])==null?void 0:l.label)||g);break;case"initiative":case"initiativedialog":p=game.i18n.localize("DND5E.Initiative");break;case"deathsave":p=game.i18n.localize("DND5E.DeathSave");break;case"hitdie":p=`${game.i18n.localize("DND5E.HitDie")} (${g})`;break;default:return}m.textContent=p}catch(d){c.error("Error customizing Roll Resolver title:",[d])}}static _onPreCreateChatMessageGM(e,t,s,o){c.log("_onPreCreateChatMessageGM",[e,t,s,o])}static _addSelectTargetsButton(e,t){var o,a,i;if(!game.user.isGM||(c.log("_addSelectTargetsButton #0",[e,t,t.querySelector(".message-content")]),((i=(a=(o=e.flags)==null?void 0:o.dnd5e)==null?void 0:a.roll)==null?void 0:i.type)!=="damage"||t.querySelector(".select-targeted")))return;const s=document.createElement("button");s.className="select-targeted",s.type="button",s.setAttribute("data-tooltip-direction","LEFT"),s.setAttribute("data-tooltip","Select Targeted"),s.innerHTML='<i class="fas fa-crosshairs"></i>',s.addEventListener("click",n=>{n.preventDefault(),this._selectTargetedTokens(n)}),t.querySelector(".message-content").appendChild(s),e.update({content:t})}static _selectTargetedTokens(e){const s=e.currentTarget.closest(".chat-message").querySelectorAll("[data-target-uuid]");if(s.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTargetedTokens"));return}for(let o=0;o<s.length;o++){const i=s[o].dataset.targetUuid.split("Actor.")[1];canvas.tokens.placeables.filter(r=>{var l,d;return((l=r.document.actor)==null?void 0:l.id)===i||((d=r.document.baseActor)==null?void 0:d.id)===i}).forEach((r,l)=>{r&&r.control&&r.control({releaseOthers:o===0})})}}static _onUserConnected(e){e.active&&e.id!==game.user.id&&setTimeout(()=>{e.active&&Ye.requestDiceConfigFromUser(e.id)},500)}static _registerTidy5eHooks(){Hooks.once(ct.READY,()=>{c.log("Tidy5e Sheets ready - registering hooks"),Hooks.on(ct.PRE_PROMPT_GROUP_SKILL_ROLL,this._onTidy5eGroupSkillRoll.bind(this)),Hooks.on(ct.RENDER_ACTOR_SHEET,Ce.onRenderActorSheet.bind(Ce)),Hooks.on(ct.RENDER_GROUP_SHEET_QUADRONE,Ce.onRenderActorSheet.bind(Ce)),Hooks.on(ct.RENDER_GROUP_SHEET_CLASSIC,Ce.onRenderActorSheet.bind(Ce)),Hooks.on(ct.RENDER_ENCOUNTER_SHEET_QUADRONE,Ce.onRenderActorSheet.bind(Ce)),Hooks.on(ct.RENDER_ENCOUNTER_SHEET_CLASSIC,Ce.onRenderActorSheet.bind(Ce))})}static _onTidy5eGroupSkillRoll(e,t){var f,g;if(c.log("HooksManager._onTidy5eGroupSkillRoll",[e,t]),!game.user.isGM)return!0;const s=I();if(!v.get(s.interceptTidySheetsGroupRolls.tag))return c.log("Tidy5e group roll interception disabled",[]),!0;const{skill:a,ability:i,event:n}=t;if(!((g=(f=e==null?void 0:e.actor)==null?void 0:f.system)!=null&&g.members))return c.warn("Tidy5e group roll: No members found",[e]),!0;const r=e.actor.system.members,l=r.map(m=>m.actor.id).filter(m=>m);if(l.length===0)return c.warn("Tidy5e group roll: No valid actor IDs",[r]),!0;const d=P.shouldSkipRollDialog({isPC:!0,sendRequest:!0}),u=foundry.utils.randomID();return D.requestRoll({requestType:"skill",rollKey:a,actorIds:l,ability:i,skipRollDialog:d,groupRollId:u,sendAsRequest:!0}),!1}static _onCreateToken(e,t,s){z.refreshIfOpen()}static _onPreUpdateToken(e,t,s,o){var n;c.log("HooksManager._onPreUpdateToken called",{tokenDoc:e,updateData:t,options:s,userId:o,userIsGM:(n=game.users.get(o))==null?void 0:n.isGM});const a=game.users.get(o);if(!a)return;const i=Fe.isMovementAllowed(e,a,t);if(c.log("Movement check result:",{isMovementAllowed:i,user:a.name,token:e.name}),!i)return D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.movementRestricted")),c.log("Movement blocked for token:",e.name),!1}static _onDeleteToken(e,t,s){Ce.onDeleteToken(e,t,s),z.refreshIfOpen()}static _onCreateActor(e,t,s){z.refreshIfOpen()}static _onDeleteActor(e,t,s){z.refreshIfOpen()}static _onSettingUpdate(e,t,s,o){const a=I(),i={ID:"flash-rolls-5e"};e.key===`${i.ID}.${a.showOnlyPCsWithToken.tag}`||e.key===`${i.ID}.${a.compactMode.tag}`||e.key===`${i.ID}.${a.menuLayout.tag}`?(c.log("HooksManager._onSettingUpdate - Re-rendering roll requests menu due to setting change",[e.key]),z.refreshIfOpen()):e.key==="core.uiConfig"&&(v.updateColorScheme(),z.refreshIfOpen(),q.confirmReload(game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredTitle"),game.i18n.localize("FLASH_ROLLS.ui.uiConfigReloadLabel")))}static _onSceneUpdate(e,t,s,o){t.active===!0&&(c.log("HooksManager._onSceneUpdate - Re-rendering roll requests menu due to active scene change"),z.refreshIfOpen())}static _onCanvasReady(e){c.log("HooksManager._onCanvasReady - Re-rendering roll requests menu due to scene view change"),z.refreshIfOpen();const t=ae.isTeleporting();c.log("HooksManager._onCanvasReady - Checking for teleport",{isTeleporting:t}),t&&(c.log("HooksManager._onCanvasReady - Calling TokenTeleportManager._onSceneChange"),ae._onSceneChange())}static _onActorUpdate(e,t,s,o){var r,l,d,u,f,g,m,p,S,y,R,A;c.log("HooksManager._onActorUpdate",[e,t]),c.log("HooksManager._onActorUpdate - changes.effects:",[t.effects]);const a=t["==ownership"]!==void 0,i=((l=(r=t.system)==null?void 0:r.attributes)==null?void 0:l.hp)||((u=(d=t.system)==null?void 0:d.attributes)==null?void 0:u.ac)||((m=(g=(f=t.system)==null?void 0:f.attributes)==null?void 0:g.spell)==null?void 0:m.dc)||((S=(p=t.system)==null?void 0:p.skills)==null?void 0:S.prc)||((y=t.system)==null?void 0:y.abilities)||((A=(R=t.system)==null?void 0:R.attributes)==null?void 0:A.prof),n=t.effects!==void 0;c.log("HooksManager._onActorUpdate - triggers:",["statsChanged:",i,"ownershipChanged:",a,"effectsChanged:",n]),!(!i&&!a&&!n)&&z.refreshIfOpen()}static _onTokenUpdate(e,t,s,o){c.log("HooksManager._onTokenUpdate",[e,t]),t.hidden!==void 0&&z.refreshIfOpen()}static _onCombatChange(...e){c.log("HooksManager._onCombatChange",e),c.log("HooksManager._onCombatChange - Re-rendering roll requests menu due to combat status change"),z.refreshIfOpen()}static _onActiveEffectChange(e,t,s,o){if(c.log("HooksManager._onActiveEffectChange",[e,t,s,o]),!e.parent||e.parent.documentName!=="Actor"){c.log("HooksManager._onActiveEffectChange - Effect not on actor, skipping");return}c.log("HooksManager._onActiveEffectChange - Re-rendering roll requests menu due to status effect change"),c.log("HooksManager._onActiveEffectChange - Effect statuses:",e.statuses),z.refreshIfOpen()}static _onRenderApplicationV2(e,t,s){c.log("_onRenderApplicationV2",[e,t,s])}static _onRenderSidebar(e,t,s){c.log("_onRenderSidebar",[e,t]),game.ready&&Wt.addSidebarControls(e,t)}static _registerHook(e,t){const s=Hooks.on(e,t);return this.registeredHooks.set(`${e}_${s}`,s),s}static unregisterAll(){this.registeredHooks.forEach((e,t)=>{const s=t.split("_")[0];Hooks.off(s,e)}),this.registeredHooks.clear()}static isRegistered(e){for(const t of this.registeredHooks.keys())if(t.startsWith(`${e}_`))return!0;return!1}static _onRenderSkillToolDialog(e,t,s){var a,i;if(c.log("_onRenderSkillToolDialog triggered",[e]),e._abilityFlavorFixed)return;const o=t.querySelector('select[name="ability"]');if(o&&(a=e.config)!=null&&a.isRollRequest&&(i=e.config)!=null&&i.ability){const n=o.value,r=e.config.ability;n===r&&(e._abilityFlavorFixed=!0,setTimeout(()=>{const l=new Event("change",{bubbles:!0,cancelable:!0});o.dispatchEvent(l)},50))}}static onRefreshTemplate(e,t){if(!e.isOwner)return;const s=`refresh-template-${e.id}`,o=I(),a=v.get(o.templateAutoTarget.tag);Te.throttleTimers[s]&&clearTimeout(Te.throttleTimers[s]),Te.throttleTimers[s]=setTimeout(()=>{let i=3;switch(a){case 1:i=3;break;case 2:i=0;break;default:return}game.user.targets.forEach(r=>r.setTarget(!1,{releaseOthers:!1}));const n=[];for(let r of canvas.tokens.placeables)r.document.disposition<=i&&e.shape.contains(r.center.x-e.x,r.center.y-e.y)&&n.push(r);n.forEach((r,l)=>{r.setTarget(!0,{releaseOthers:l===0,groupSelection:!0})}),n.length>0&&game.user.broadcastActivity({targets:game.user.targets.ids}),delete Te.throttleTimers[s]},50)}static _onClientSettingChanged(e,t,s){c.log("HooksManager._onClientSettingChanged",[e,t,s]),e==="core.uiConfig"&&this._updateMenuColorScheme()}static _onBrowserColorSchemeChanged(){var t;c.log("HooksManager._onBrowserColorSchemeChanged - Browser color scheme changed");const e=game.settings.get("core","uiConfig");(t=e==null?void 0:e.colorScheme)!=null&&t.interface||this._updateMenuColorScheme()}static _updateMenuColorScheme(){const e=v.coreColorScheme;v.updateColorScheme();const t=v.coreColorScheme,s=z.getInstance();s!=null&&s.rendered&&s.classList&&(e&&s.classList.remove(`theme-${e}`),t&&s.classList.add(`theme-${t}`))}static _onCombatStart(e,t){Fe.onCombatStart(e,t)}static _onCombatTurnChange(e,t,s){Fe.onCombatTurnChange(e,t,s)}static _onDeleteCombat(e){Fe.onCombatEnd(e)}static _onCreateCombatant(e,t,s){Fe.onCreateCombatant(e,t,s)}};E(Te,"registeredHooks",new Map),E(Te,"midiTimeout",null),E(Te,"throttleTimers",{}),E(Te,"activityConfigCache",new Map),E(Te,"CACHE_EXPIRY_MS",3e4),E(Te,"templateRemovalTimers",new Set);let Ie=Te;class Qe{static init(){me.initialize(Qe.registerSocketCalls),Ie.initialize()}static getDiceConfig(){return Ye.getDiceConfig()}static receiveDiceConfig(e,t){Ye.receiveDiceConfig(e,t)}static async handleRollRequest(e){return c.log("Main.handleRollRequest",e),We.handleRequest(e)}static registerSocketCalls(){me.registerCall(Xe.getDiceConfig,Qe.getDiceConfig),me.registerCall(Xe.receiveDiceConfig,Qe.receiveDiceConfig),me.registerCall(Xe.handleRollRequest,Qe.handleRollRequest),me.registerCall(Xe.removeTemplate,q.removeTemplate),me.registerCall(Xe.broadcastRollComplete,Qe.handleBroadcastRollComplete),me.registerCall(Xe.deleteChatMessage,Qe.handleDeleteChatMessage)}static async handleDeleteChatMessage(e){if(!game.user.isGM)return;const t=game.messages.get(e);t&&await t.delete().catch(s=>{c.error("Main.handleDeleteChatMessage - Failed to delete message",[s])})}static handleBroadcastRollComplete(e){c.log("Main.handleBroadcastRollComplete",[e]),e.roll&&!(e.roll instanceof Roll)&&(e.roll=Roll.fromJSON(JSON.stringify(e.roll))),Hooks.callAll("flash-rolls-5e.rollComplete",e)}}Qe.init();const{ApplicationV2:ua,HandlebarsApplicationMixin:ga}=foundry.applications.api,bt=class bt extends ga(ua){constructor(e={}){super(e),this.actors=e.actors||[],this.rollSelections=new Map,this.rollMode="publicroll",this.flavor="",this.hideNpcNames=!1}async _prepareContext(e={}){const t=await super._prepareContext(e),s={};for(const[a,i]of Object.entries(CONFIG.DND5E.abilities))s[a]={label:game.i18n.localize(i.label),abbreviation:game.i18n.localize(i.abbreviation)};const o={};for(const[a,i]of Object.entries(CONFIG.DND5E.skills))o[a]={label:game.i18n.localize(i.label)};return{...t,actors:this.actors.map(a=>{const i=a.actor||a;return{id:i.id,name:i.name,img:i.img}}),abilities:s,skills:o,rollMode:this.rollMode,flavor:this.flavor,hideNpcNames:this.hideNpcNames}}_attachPartListeners(e,t,s){super._attachPartListeners(e,t,s);const o=t.querySelector(".roll-mode-select");o&&o.addEventListener("change",r=>{this.rollMode=r.target.value});const a=t.querySelector('input[name="flavor"]');a&&a.addEventListener("input",r=>{this.flavor=r.target.value});const i=t.querySelector('input[name="hideNpcNames"]');i&&i.addEventListener("change",r=>{this.hideNpcNames=r.target.checked}),t.querySelectorAll(".actor-roll-type").forEach(r=>{const l=r.dataset.actorId;r.value&&this.rollSelections.set(l,r.value),r.addEventListener("change",d=>{const u=d.target.dataset.actorId;this.rollSelections.set(u,d.target.value)})})}async _onRequest(e,t){if(this.actors.length===0){D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}for(const o of this.actors){const a=o.actor||o;if(!this.rollSelections.get(a.id)){D.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.noRollSelected",{name:a.name}));return}}const s={actors:this.actors.map(o=>{const a=o.actor||o;return{actor:a,uniqueId:o.uniqueId||a.id,tokenId:o.tokenId||null,rollType:this.rollSelections.get(a.id)}}),rollMode:this.rollMode,flavor:this.flavor,hideNpcNames:this.hideNpcNames};await this._executeContestedRolls(s),this.close()}async _executeContestedRolls(e){c.log("_executeContestedRolls",[e]);const t=I(),o=v.get(t.groupRollsMsgEnabled.tag)?foundry.utils.randomID():null;c.log("ContestedRoll - groupRollId",[o]);const a={...e,isContestedRoll:!0};if(o){const i=e.actors.map(d=>{const u=d.actor,f=d.uniqueId||u.id,g=d.tokenId||null,[m,p]=d.rollType.split(":");return{actor:u,uniqueId:f,tokenId:g,rollType:m,rollKey:p}}),n=e.actors[0].rollType.split(":"),r=n[0],l=n[1];await ne.createGroupRollMessage(i,r,l,a,o)}for(const i of e.actors)await this._executeRollForActor(i,a,o)}async _executeRollForActor(e,t,s=null){var f,g,m;const o=e.actor,a=e.tokenId,[i,n]=e.rollType.split(":");c.log("_executeRollForActor",[o.name,i,n,"tokenId:",a,"groupRollId:",s]);const r=I(),l=P.isPlayerOwned(o),d=v.get(r.rollRequestsEnabled.tag),u=P.shouldSkipRollDialog({isPC:l,isNPC:!l,sendRequest:l&&d});try{if(i==="dice"){const p=await new Roll(n,o.getRollData()).evaluate(),S={actor:o};if(a){const _=((f=canvas.tokens)==null?void 0:f.get(a))||((m=(g=game.scenes.active)==null?void 0:g.tokens)==null?void 0:m.get(a));_&&(S.token=_)}const y=ChatMessage.implementation.getSpeaker(S),R=t.flavor||game.i18n.localize("FLASH_ROLLS.ui.dialogs.contestedRoll.customRoll"),A={speaker:y,flavor:R};t.rollMode&&(A.rollMode=t.rollMode),s&&(A.flags={"flash-rolls-5e":{groupRollId:s,isContestedRoll:!0}}),await p.toMessage(A)}else{const p=i==="ability"?"abilitycheck":i,S=a||o.id;await D.requestRoll({requestType:p,rollKey:n,actorIds:[S],sendAsRequest:l&&d,skipRollDialog:u,groupRollId:s,isContestedRoll:t.isContestedRoll||!1})}}catch(p){c.error("Error executing roll",[p]),ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.rollFailed",{name:o.name}),[p])}}async _onShowCode(e,t){c.log("ContestedRollDialog _onShowCode",[]);for(const o of this.actors){const a=o.actor||o;if(!this.rollSelections.get(a.id)){D.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.noRollSelected",{name:a.name}));return}}const s=this._generateMacroCode();c.log("Generated macro code:",[s]);try{await this._createContestedRollMacro(s),this.close()}catch(o){c.error("Failed to create macro:",[o]),ui.notifications.error(`Failed to create macro: ${o.message}`)}}_generateMacroCode(){const e=this.actors[0].actor||this.actors[0],t=this.rollSelections.get(e.id);if(!t)return D.notify("warn","Please select a roll type for all actors before creating a macro."),null;const s=t.split(":"),o=s[0]==="ability"?"abilitycheck":s[0],a=s[1],i=this.actors.map(l=>{const d=l.actor||l,u=this.rollSelections.get(d.id);if(!u)return null;const[f,g]=u.split(":"),m=f==="ability"?"abilitycheck":f;return f==="dice"?`  // ${d.name}: Custom Dice Roll
  const actor${d.id} = game.actors.get("${d.id}");
  if (actor${d.id}) {
    const roll = await new Roll("${g}", actor${d.id}.getRollData()).evaluate();
    await roll.toMessage({
      speaker: ChatMessage.implementation.getSpeaker({ actor: actor${d.id} }),
      flavor: "${this.flavor||"Custom Roll"}",
      rollMode: "${this.rollMode}",
      flags: {
        "flash-rolls-5e": {
          groupRollId: groupRollId,
          isContestedRoll: true
        }
      }
    });
  }`:`  // ${d.name}: ${f}:${g}
  await FlashAPI.requestRoll({
    requestType: "${m}",
    rollKey: "${g}",
    actorIds: ["${d.id}"],
    skipRollDialog: true,
    groupRollId: groupRollId,
    isContestedRoll: true
  });`});if(i.includes(null))return null;const n=i.join(`

`),r=this.actors.map(l=>{const d=l.actor||l;return`    {
      actor: game.actors.get("${d.id}"),
      uniqueId: "${d.id}",
      tokenId: null
    }`}).join(`,
`);return`// Flash Token Bar: Contested Roll
// Roll Mode: ${this.rollMode}
${this.flavor?`// Flavor: ${this.flavor}`:""}

(async () => {
  try {
    const groupRollId = foundry.utils.randomID();

    const actorEntries = [
${r}
    ];

    await FlashAPI.createGroupRollMessage(
      actorEntries,
      "${o}",
      "${a}",
      { rollMode: "${this.rollMode}", flavor: "${this.flavor}", isContestedRoll: true },
      groupRollId
    );

${n}
  } catch (error) {
    ui.notifications.error("Failed to execute contested roll: " + error.message);
  }
})();`}async _createContestedRollMacro(e){const t=I(),s=v.get(t.addMacrosToFolder.tag);let o=null;s&&(o=await this._ensureFlashRollsFolder());const n={name:`Contested Roll: ${this.actors.map(l=>(l.actor||l).name).join(" vs ")}`,type:"script",command:e,img:"modules/flash-rolls-5e/assets/bolt-circle.svg",...o&&{folder:o},flags:{"flash-rolls-5e":{type:"contested-roll",actors:this.actors.map(l=>(l.actor||l).id),rollSelections:Array.from(this.rollSelections.entries()),rollMode:this.rollMode,flavor:this.flavor}}},r=await Macro.create(n);return D.notify("info",game.i18n.format("FLASH_ROLLS.notifications.macroCreated",{macroName:r.name})),r.sheet.render(!0),r}async _ensureFlashRollsFolder(){const e="Flash Token Bar";let t=game.folders.find(s=>s.type==="Macro"&&s.name===e);if(!t)try{t=await Folder.create({name:e,type:"Macro",color:"#302437",sort:0}),c.log("Created Flash Token Bar macro folder",[t])}catch(s){return c.error("Failed to create Flash Token Bar macro folder:",[s]),D.notify("warn","Failed to create Flash Token Bar macro folder. Macro will be created without folder organization."),null}return(t==null?void 0:t.id)||null}async _onDeleteActor(e,t){const s=t.dataset.actorId;c.log("ContestedRollDialog _onDeleteActor",[s]),this.actors=this.actors.filter(o=>o.id!==s),this.rollSelections.delete(s),await this.render(!0)}static async show(e){if(!e||e.length===0)return D.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected")),null;const t=new this({actors:e});return t.render(!0),t}};E(bt,"DEFAULT_OPTIONS",{id:"flash5e-contested-roll-dialog",classes:["flash5e-dialog","flash5e-contested-roll-dialog"],tag:"div",window:{title:"FLASH_ROLLS.ui.dialogs.contestedRoll.title",icon:"fas fa-swords",resizable:!1,positioned:!0,frame:!0},position:{width:540,height:"auto"},actions:{request:bt.prototype._onRequest,"show-code":bt.prototype._onShowCode}}),E(bt,"PARTS",{main:{template:`modules/${k}/templates/contested-roll-dialog.hbs`}});let ns=bt;const fa=Object.freeze(Object.defineProperty({__proto__:null,ContestedRollDialog:ns},Symbol.toStringTag,{value:"Module"})),{ApplicationV2:ma,HandlebarsApplicationMixin:pa}=foundry.applications.api;var lt,Lo,ko,_o;const je=class je extends pa(ma){constructor(e={}){super(e),this.importData=e.importData||{},this._resolve=null}get id(){var e;return`flash5e-import-results-${((e=this.importData.characterName)==null?void 0:e.replace(/\s+/g,"-"))||"unknown"}`}get title(){return this.importData.characterName?game.i18n.format("FLASH_ROLLS.ui.dialogs.characterImport.resultsTitle",{name:this.importData.characterName}):game.i18n.localize("FLASH_ROLLS.ui.dialogs.characterImport.resultsTitle")}async _prepareContext(e={}){const t=await super._prepareContext(e),{tier:s,matchRate:o,matched:a,unmatched:i,characterName:n,classInfo:r,raceName:l,backgroundName:d}=this.importData,u=Math.round((o||0)*100);a&&a.forEach((m,p)=>{m._itemKey=`item-${p}`}),i&&i.forEach((m,p)=>{m._unmatchedKey=`unmatched-${p}`});const f=this._groupByType(a||[]),g=this._groupByType(i||[]);return{...t,characterName:n,tier:s,matchPercentage:u,matchedCount:(a==null?void 0:a.length)||0,unmatchedCount:(i==null?void 0:i.length)||0,totalCount:((a==null?void 0:a.length)||0)+((i==null?void 0:i.length)||0),isTierB:s==="B",isTierC:s==="C",groupedMatched:f,groupedUnmatched:g,hasUnmatched:((i==null?void 0:i.length)||0)>0,classInfo:r,raceName:l,backgroundName:d}}async _preparePartContext(e,t,s){const o=await super._preparePartContext(e,t,s);return e==="footer"&&(o.buttons=[{type:"button",icon:"fas fa-times",label:"Cancel",action:"cancel"},{type:"button",icon:"fas fa-check",label:"Create Actor",action:"confirm",cssClass:"primary"}]),o}_groupByType(e){const t={},s={spell:"Spells",weapon:"Weapons",equipment:"Equipment",consumable:"Consumables",feat:"Features & Feats",tool:"Tools",class:"Classes",subclass:"Subclasses",background:"Background",race:"Species",species:"Species",unknown:"Other"};for(const o of e){const a=o.foundryType||o.type||"unknown",i=a.toLowerCase();t[i]||(t[i]={label:s[i]||a,items:[]}),t[i].items.push(o)}for(const o of Object.values(t))o.items.sort((a,i)=>{var l,d,u,f,g,m;const n=(a.foundryName||((d=(l=a.ddbItem)==null?void 0:l.definition)==null?void 0:d.name)||((u=a.ddbItem)==null?void 0:u.name)||a.name||"").toLowerCase(),r=(i.foundryName||((g=(f=i.ddbItem)==null?void 0:f.definition)==null?void 0:g.name)||((m=i.ddbItem)==null?void 0:m.name)||i.name||"").toLowerCase();return n.localeCompare(r)});return t}static async show(e){return new Promise(t=>{const s=new je({importData:e});s._resolve=t,s.render(!0)})}_onRender(e,t){super._onRender(e,t),this.element.querySelectorAll(".source-select").forEach(o=>{o.addEventListener("change",this._onSourceChange.bind(this))});const s=this.element.querySelector("#createAllHomebrew");s&&s.addEventListener("change",this._onCreateAllChange.bind(this))}_onCreateAllChange(e){const t=e.target.checked;this.element.querySelectorAll(".create-homebrew-checkbox").forEach(s=>{s.checked=t})}_getHomebrewToCreate(){const e=[];return this.element.querySelectorAll(".create-homebrew-checkbox:checked").forEach(t=>{var a;const s=t.dataset.itemKey,o=(a=this.importData.unmatched)==null?void 0:a.find(i=>i._unmatchedKey===s);o&&e.push(o)}),e}_onSourceChange(e){const t=e.target,s=parseInt(t.value,10),o=t.dataset.itemKey;for(const a of this.importData.matched)if(a.allMatches&&a._itemKey===o){const i=a.allMatches[s];a.selectedIndex=s,a.foundryUuid=i.uuid,a.foundryName=i.name,a.source=i.source,a.sourceLabel=i.sourceLabel,a.sourceVersion=i.sourceVersion,a.sourceTitle=i.sourceTitle,a.matchType=i.matchType;break}}close(e={}){return this._resolve&&!e._resolved&&this._resolve(null),super.close(e)}};lt=new WeakSet,Lo=function(e,t){this._resolve&&(this.importData.homebrewToCreate=this._getHomebrewToCreate(),this._resolve(this.importData)),this.close()},ko=function(e,t){this._resolve&&this._resolve(null),this.close()},_o=function(e,t){window.open("https://foundryvtt.com/packages/ddb-importer","_blank")},fe(je,lt),E(je,"DEFAULT_OPTIONS",{classes:["flash5e-dialog","flash5e-import-results-dialog"],tag:"div",window:{title:"FLASH_ROLLS.ui.dialogs.characterImport.resultsTitle",icon:"fas fa-file-import",resizable:!0,positioned:!0,frame:!0,contentClasses:["standard-form","crlngn","flash5e"]},position:{width:620,height:"auto"},actions:{confirm:X(je,lt,Lo),cancel:X(je,lt,ko),openDDBImporter:X(je,lt,_o)}}),E(je,"PARTS",{content:{template:`modules/${V.ID}/templates/character-import-results.hbs`},footer:{template:"templates/generic/form-footer.hbs"}});let rs=je;const ha=Object.freeze(Object.defineProperty({__proto__:null,CharacterImportResultsDialog:rs},Symbol.toStringTag,{value:"Module"}));
//# sourceMappingURL=flash-rolls-5e.js.map
