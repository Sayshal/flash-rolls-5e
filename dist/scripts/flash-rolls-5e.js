var Ft=Object.defineProperty;var lt=g=>{throw TypeError(g)};var Ht=(g,e,t)=>e in g?Ft(g,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[e]=t;var w=(g,e,t)=>Ht(g,typeof e!="symbol"?e+"":e,t),je=(g,e,t)=>e.has(g)||lt("Cannot "+t);var P=(g,e,t)=>(je(g,e,"read from private field"),t?t.call(g):e.get(g)),ue=(g,e,t)=>e.has(g)?lt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(g):e.set(g,t),he=(g,e,t,s)=>(je(g,e,"write to private field"),s?s.call(g,t):e.set(g,t),t),be=(g,e,t)=>(je(g,e,"access private method"),t);const nt={MODULE_ACTIONS:"moduleActions",ACTOR_ACTIONS:"actorActions"},ht={"lock-menu":{id:"lock-menu",icon:"fa-lock-keyhole",labelKey:"FLASH_ROLLS.ui.inputs.lockMenu",tooltipKey:"FLASH_ROLLS.ui.inputs.lockMenu",element:"flash5e-actors-lock",type:"button"},"toggle-requests":{id:"toggle-requests",icon:"fa-bolt",labelKey:"FLASH_ROLLS.ui.inputs.toggleRollRequests",tooltipKey:"FLASH_ROLLS.ui.inputs.toggleRollRequests",element:"flash-rolls-toggle",type:"checkbox"},"skip-dialogs":{id:"skip-dialogs",icon:"fa-square-question",labelKey:"FLASH_ROLLS.ui.inputs.skipRollDialog",tooltipKey:"FLASH_ROLLS.ui.inputs.skipRollDialog",element:"flash5e-skip-dialogs",type:"checkbox"},"group-rolls":{id:"group-rolls",icon:"fa-users-rectangle",labelKey:"FLASH_ROLLS.ui.inputs.groupRollsMsg",tooltipKey:"FLASH_ROLLS.ui.inputs.groupRollsMsg",element:"flash5e-group-rolls-msg",type:"checkbox"},"show-options":{id:"show-options",icon:"fa-bars-sort",labelKey:"FLASH_ROLLS.ui.inputs.showOptionsListOnHover",tooltipKey:"FLASH_ROLLS.ui.inputs.showOptionsListOnHover",element:"flash5e-toggle-list",type:"checkbox"},"open-settings":{id:"open-settings",icon:"fa-cog",labelKey:"FLASH_ROLLS.ui.inputs.openSettings",tooltipKey:"FLASH_ROLLS.ui.inputs.openSettings",element:"flash5e-open-settings",type:"button"}},Rt={"select-all":{id:"select-all",icon:"fa-object-group",labelKey:"FLASH_ROLLS.ui.inputs.selectAll",tooltipKey:"FLASH_ROLLS.ui.inputs.selectAll",element:"flash5e-actors-all",type:"checkbox",cssClass:"bulk-action"},"filter-actors":{id:"filter-actors",icon:"fa-filter-list",labelKey:"FLASH_ROLLS.ui.inputs.filterActors",tooltipKey:"FLASH_ROLLS.ui.inputs.filterActors",element:"flash5e-filter-actors",type:"button",cssClass:"bulk-action"},"toggle-targets":{id:"toggle-targets",icon:"fa-crosshairs",labelKey:"FLASH_ROLLS.ui.inputs.toggleTargets",tooltipKey:"FLASH_ROLLS.ui.inputs.toggleTargets",element:"flash5e-targets",type:"button",cssClass:"bulk-action"},"heal-all":{id:"heal-all",icon:"fa-heart-pulse",labelKey:"FLASH_ROLLS.ui.inputs.healAll",tooltipKey:"FLASH_ROLLS.ui.inputs.healAll",element:"flash5e-heal-selected",type:"button",cssClass:"bulk-action"},"kill-all":{id:"kill-all",icon:"fa-skull",labelKey:"FLASH_ROLLS.ui.inputs.killAll",tooltipKey:"FLASH_ROLLS.ui.inputs.killAll",element:"flash5e-kill-selected",type:"button",cssClass:"bulk-action"},"remove-status":{id:"remove-status",icon:"fa-sparkles",labelKey:"FLASH_ROLLS.ui.inputs.removeStatus",tooltipKey:"FLASH_ROLLS.ui.inputs.removeStatus",element:"flash5e-remove-effects",type:"button",cssClass:"bulk-action"},"open-sheets":{id:"open-sheets",icon:"fa-square-user",labelKey:"FLASH_ROLLS.ui.inputs.openSheets",tooltipKey:"FLASH_ROLLS.ui.inputs.openSheets",element:"flash5e-sheets",type:"button",cssClass:"bulk-action"},"group-selected":{id:"group-selected",icon:"fa-users-medical",labelKey:"FLASH_ROLLS.ui.inputs.groupSelected",tooltipKey:"FLASH_ROLLS.ui.inputs.groupSelected",element:"flash5e-group-selected",type:"button",cssClass:"bulk-action"},movement:{id:"movement",icon:"fa-person-walking",labelKey:"FLASH_ROLLS.ui.inputs.toggleMovement",tooltipKey:"FLASH_ROLLS.ui.inputs.toggleMovement",element:"flash5e-lock-movement",type:"button",cssClass:"bulk-action"}};function Nt(g){switch(g){case nt.MODULE_ACTIONS:return ht;case nt.ACTOR_ACTIONS:return Rt;default:return{}}}function Pt(g,e){return Nt(e)[g]||null}function Ie(){return{moduleActions:[{id:"lock-menu",icon:"fa-lock-keyhole",enabled:!0,order:0},{id:"toggle-requests",icon:"fa-bolt",enabled:!0,order:1},{id:"skip-dialogs",icon:"fa-square-question",enabled:!0,order:2},{id:"group-rolls",icon:"fa-users-rectangle",enabled:!0,order:3},{id:"show-options",icon:"fa-bars-sort",enabled:!0,order:4},{id:"open-settings",icon:"fa-cog",enabled:!0,order:5}],actorActions:[{id:"filter-actors",icon:"fa-filter-list",enabled:!0,order:0},{id:"select-all",icon:"fa-object-group",enabled:!0,order:1},{id:"toggle-targets",icon:"fa-crosshairs",enabled:!0,order:2},{id:"group-selected",icon:"fa-users-medical",enabled:!0,order:3},{id:"remove-status",icon:"fa-sparkles",enabled:!0,order:4},{id:"movement",icon:"fa-person-walking",enabled:!0,order:5},{id:"open-sheets",icon:"fa-square-user",enabled:!0,order:6},{id:"heal-all",icon:"fa-heart-pulse",enabled:!0,order:7},{id:"kill-all",icon:"fa-skull",enabled:!0,order:8}]}}const z={select:"select",checkbox:"checkbox"},H={client:"client",world:"world"},rt=Ie(),E=()=>({generalSettings:{tag:"flash5e-general-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["showMenuOnLoad","skipRollDialog","skipRollDialogOption","showOnlyPCsWithToken","addMacrosToFolder","templateAutoTarget","removeTemplate","templateRemovalTimeout","autoBlockMovementInCombat"],default:{showMenuOnLoad:!1,skipRollDialog:!1,skipRollDialogOption:1,showOnlyPCsWithToken:!0,addMacrosToFolder:!0,templateAutoTarget:1,removeTemplate:!0,templateRemovalTimeout:5,autoBlockMovementInCombat:!1},scope:H.world,config:!1,requiresReload:!1},interfaceSettings:{tag:"flash5e-interface-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["showMenuOnLoad","compactMode","menuLayout","menuIconsLayout"],default:{showMenuOnLoad:!1,compactMode:!0,menuLayout:"vertical",menuIconsLayout:rt},scope:H.world,config:!1,requiresReload:!1},groupRollsSettings:{tag:"flash5e-group-rolls-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["groupRollsMsgEnabled","groupRollResultMode","showGroupDCToPlayers","groupRollNPCHidden"],default:{groupRollsMsgEnabled:!0,groupRollResultMode:1,showGroupDCToPlayers:!1,groupRollNPCHidden:!0},scope:H.world,config:!1,requiresReload:!1},rollRequestsSettings:{tag:"flash5e-roll-request-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["rollInterceptionEnabled","useGMTargetTokens","consumptionConfigMode","placeTemplateForPlayer","showOfflineNotifications","initiateCombatOnRequest","publicPlayerRolls"],default:{rollInterceptionEnabled:!0,useGMTargetTokens:!0,consumptionConfigMode:2,placeTemplateForPlayer:!1,showOfflineNotifications:!0,initiateCombatOnRequest:!0,publicPlayerRolls:!0},scope:H.world,config:!1,requiresReload:!1},showGroupDCToPlayers:{tag:"show-group-dc-to-players",label:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:H.world,config:!1},groupRollNPCHidden:{tag:"group-roll-npc-hidden",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollNPCHidden.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollNPCHidden.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!1},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!0},groupRollsMsgEnabled:{tag:"group-roll-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!1},groupRollResultMode:{tag:"group-roll-result-mode",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.hint"),propType:Number,inputType:z.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.4")},default:1,scope:H.world,config:!1},consumptionConfigMode:{tag:"consumption-config",label:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.hint"),propType:Number,inputType:z.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.4")},default:2,scope:H.world,config:!1},placeTemplateForPlayer:{tag:"place-template-for-player",label:game.i18n.localize("FLASH_ROLLS.settings.placeTemplateForPlayer.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.placeTemplateForPlayer.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:H.world,config:!1},skipRollDialog:{tag:"skip-roll-dialog",label:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:H.world,config:!1},skipRollDialogOption:{tag:"skip-roll-dialog-options",label:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.hint"),propType:Number,inputType:z.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.choices.3")},default:1,scope:H.world,config:!1},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!1},rollInterceptionEnabled:{tag:"roll-interception-on",label:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:H.world,config:!1},publicPlayerRolls:{tag:"public-player-rolls",label:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!1},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!1},showRequestNotifications:{tag:"show-request-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!1},initiateCombatOnRequest:{tag:"initiate-combat-on-request",label:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!1},showOnlyPCsWithToken:{tag:"show-only-pcs-with-token",label:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!1},compactMode:{tag:"compact-mode",label:game.i18n.localize("FLASH_ROLLS.settings.compactMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.compactMode.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!1},menuLayout:{tag:"menu-layout",label:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.hint"),propType:String,inputType:z.select,choices:{vertical:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.choices.vertical"),horizontal:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.choices.horizontal")},default:"vertical",scope:H.world,config:!1},showOptionsListOnHover:{tag:"show-list-on-hover",label:game.i18n.localize("FLASH_ROLLS.settings.showOptionsListOnHover.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOptionsListOnHover.hint"),propType:Boolean,default:!0,scope:H.world,config:!1},templateAutoTarget:{tag:"template-auto-target",label:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.hint"),propType:Number,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.all.label"),2:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.notFriendly.label"),3:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.none.label")},inputType:z.select,default:1,scope:H.world,config:!1},removeTemplate:{tag:"remove-template",label:game.i18n.localize("FLASH_ROLLS.settings.removeTemplate.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.removeTemplate.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!1},templateRemovalTimeout:{tag:"template-removal-timeout",label:game.i18n.localize("FLASH_ROLLS.settings.templateRemovalTimeout.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.templateRemovalTimeout.hint"),propType:Number,default:5,scope:H.world,config:!1,range:{min:0,max:30,step:1}},debugMode:{tag:"debug-mode-on",label:game.i18n.localize("FLASH_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:H.client,config:!0},showMenuOnLoad:{tag:"show-menu-on-world-load",label:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:H.world,config:!1},addMacrosToFolder:{tag:"add-macros-to-folder",label:game.i18n.localize("FLASH_ROLLS.settings.addMacrosToFolder.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.addMacrosToFolder.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:H.world,config:!1},menuIconsLayout:{tag:"menu-icons-layout",label:game.i18n.localize("FLASH_ROLLS.settings.menuIconsLayout.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.menuIconsLayout.hint"),propType:Object,default:rt,scope:H.world,config:!1},autoBlockMovementInCombat:{tag:"auto-block-movement-in-combat",label:game.i18n.localize("FLASH_ROLLS.settings.autoBlockMovementInCombat.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.autoBlockMovementInCombat.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:H.world,config:!1},legacyTokenAssociationsMigrated:{tag:"legacy-token-associations-migrated",label:game.i18n.localize("FLASH_ROLLS.settings.legacyTokenAssociationsMigrated.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.legacyTokenAssociationsMigrated.hint"),propType:Boolean,default:!1,scope:H.world,config:!1}}),b="flash-rolls-5e",Pe=["%cFlash Rolls 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],Ge={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest",removeTemplate:"removeTemplate"},le={ATTACK:"attack",DAMAGE:"damage",HEAL:"heal",SAVE:"save"},y={ABILITY:"ability",ABILITY_CHECK:"abilitycheck",ATTACK:"attack",CONCENTRATION:"concentration",CUSTOM:"custom",DEATH_SAVE:"deathsave",FORMULA:"formula",DAMAGE:"damage",HEALING:"healing",HIT_DIE:"hitdie",INITIATIVE:"initiative",INITIATIVE_DIALOG:"initiativedialog",ITEM_SAVE:"itemsave",SAVE:"save",SAVING_THROW:"savingthrow",SKILL:"skill",TOOL:"tool"},Gt={ABILITY_CHECK:{name:y.ABILITY_CHECK,label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:y.SAVING_THROW,label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:y.SKILL,label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:y.TOOL,label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:y.CONCENTRATION,label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:y.INITIATIVE,label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:y.DEATH_SAVE,label:"Death Save",subList:null,actorPath:""},HIT_DIE:{name:y.HIT_DIE,label:"Hit Die",subList:null,actorPath:""},CUSTOM:{name:y.CUSTOM,label:"Custom Roll",subList:null,actorPath:""}},W={ID:b,ROLL_REQUEST_OPTIONS:Gt},O={INIT:"init",READY:"ready",RENDER_CHAT_MESSAGE:"renderChatMessageHTML",RENDER_CHAT_LOG:"renderChatLog",RENDER_CHAT_INPUT:"renderChatInput",CHANGE_SIDEBAR_TAB:"changeSidebarTab",RENDER_SIDEBAR:"renderSidebar",RENDER_APPLICATION_V2:"renderApplicationV2",UPDATE_SCENE:"updateScene",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",CREATE_CHAT_MESSAGE:"createChatMessage",COLLAPSE_SIDE_BAR:"collapseSidebar",REFRESH_MEASURED_TEMPLATE:"refreshMeasuredTemplate",CONTROL_TOKEN:"controlToken",UPDATE_TOKEN:"updateToken",PRE_UPDATE_TOKEN:"preUpdateToken",DELETE_TOKEN:"deleteToken",CREATE_TOKEN:"createToken",UPDATE_ACTOR:"updateActor",CREATE_ACTOR:"createActor",DELETE_ACTOR:"deleteActor",UPDATE_ITEM:"updateItem",CREATE_ITEM:"createItem",DELETE_ITEM:"deleteItem",UPDATE_SETTING:"updateSetting",CLIENT_SETTING_CHANGED:"clientSettingChanged",GET_ACTOR_CONTEXT_OPTIONS:"getActorContextOptions",GET_CHAT_MESSAGE_CONTEXT_OPTIONS:"getChatMessageContextOptions",RENDER_ACTOR_DIRECTORY:"renderActorDirectory",CREATE_COMBATANT:"createCombatant",DELETE_COMBATANT:"deleteCombatant",UPDATE_COMBAT:"updateCombat",DELETE_COMBAT:"deleteCombat",COMBAT_START:"combatStart",COMBAT_TURN_CHANGE:"combatTurnChange",CREATE_ACTIVE_EFFECT:"createActiveEffect",DELETE_ACTIVE_EFFECT:"deleteActiveEffect",UPDATE_ACTIVE_EFFECT:"updateActiveEffect",RENDER_APPLICATION:"renderApplication",PRE_CREATE_TOKEN:"preCreateToken",CANVAS_READY:"canvasReady"},qt={READY:"socketlib.ready"},xt={READY:"midi-qol.ready"},U={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_USE_ACTIVITY:"dnd5e.preUseActivity",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE_DIALOG:"dnd5e.preRollInitiativeDialog",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",ROLL_DAMAGE_V2:"dnd5e.rollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog",RENDER_SKILL_TOOL_ROLL_DIALOG:"renderSkillToolRollConfigurationDialog"},Bt={READY:"ready"},we=class we{static log(e="",t=[],s=!1){try{const o=game.settings.get(b,"debug-mode-on")||we.debugOn;if(!(s||o))return;const i=Array.isArray(t)?t:[t];console.log(...Pe,e,...i)}catch{if(s||we.debugOn){const a=Array.isArray(t)?t:[t];console.log(...Pe,e,...a)}}}static warn(e="",t=[]){const s=Array.isArray(t)?t:[t];console.warn(...Pe,e,...s)}static error(e,t=[],s={ui:!1,console:!0,permanent:!1}){var a;const o=Array.isArray(t)?t:[t];s.ui&&((a=ui.notifications)==null||a.error(e,{localize:!0,permanent:s.permanent})),s.console&&console.error(...Pe,e,...o)}};w(we,"debugOn",!1);let r=we;const $=class ${static serializeForTransport(e,t=!1){return r.log("serializeForTransport",[e,t]),e==null||t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(s=>s instanceof Roll?s.toJSON():s)),e}static deserializeFromTransport(e,t=!1){r.log("deserializeFromTransport",[e,t]);let s={...e};if(!e)return s;if(t&&e.rolls&&e.rolls.length>0){const o=s.rolls.map(a=>{let i=a;return typeof a=="string"?i=Roll.fromJSON(a):a instanceof Roll?i=a:i=Roll.fromJSON(JSON.stringify(a)),i});return s.rolls=[...o],s}return s}};w($,"socket"),w($,"_activeExecutions",new Map),w($,"initialize",e=>{r.log("initialize",[e]),Hooks.once(qt.READY,()=>{if(typeof socketlib>"u"){r.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{$.socket=socketlib.registerModule(b),e&&e()}catch(t){r.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled.",[t])}})}),w($,"registerCall",(e,t)=>{r.log("registerCall",[e]),$.socket&&$.socket.register(e,t)}),w($,"sendMessage",(e,t)=>{r.log("sendMessage",[e]),t&&t()}),w($,"execForGMs",async(e,...t)=>{if(r.log("execForGMs",[e,...t]),!!$.socket)return await $.socket.executeForAllGMs(e,...t)}),w($,"execForAll",async(e,...t)=>{if($.socket)return await $.socket.executeForEveryone(e,...t)}),w($,"execForUser",async(e,t,...s)=>{if(r.log("execForUser #0",[e,t,...s]),!$.socket)return;if(r.log("execForUser #1",[t===game.user.id]),t===game.user.id)return null;const o=`${e}-${t}`;if(r.log("execForUser #2",[$._activeExecutions.has(o)]),$._activeExecutions.has(o))return null;$._activeExecutions.set(o,!0);try{const a=await $.socket.executeAsUser(e,t,...s);return r.log("execForUser #3 - response",[a]),a}catch(a){return r.error("execForUser #4 - error",[a]),null}finally{r.log("execForUser #5 - success",[]),$._activeExecutions.delete(o)}});let re=$;class ke{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const e=game.settings.storage.get("client");return this.diceConfig=e["core.diceConfiguration"]||"",this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){re.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(e,t){var s,o;((s=game.user)!=null&&s.isGM||e===((o=game.user)==null?void 0:o.id))&&(this.playerDiceConfigs[e]=t?JSON.parse(t):{})}static getUserDiceConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?this.diceConfig:this.playerDiceConfigs[e]||{}}static requestDiceConfigFromUser(e){re.execForUser("getDiceConfig",e)}static requestDiceConfigFromAllPlayers(){var e;(e=game.user)!=null&&e.isGM&&game.users.forEach(t=>{t.active&&!t.isGM&&t.id!==game.user.id&&this.requestDiceConfigFromUser(t.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?!!this.diceConfig:!!this.playerDiceConfigs[e]}}w(ke,"diceConfig",{}),w(ke,"playerDiceConfigs",{});var Ue,yt;const Fe=class Fe{static isModuleOn(e){var s;const t=(s=game.modules)==null?void 0:s.get(e);return r.log("isModuleOn",[e,t,t==null?void 0:t.active]),!!(t!=null&&t.active)}static html(e,t){return e.querySelector(t)}static getFullWidth(e){return window.getComputedStyle(e).width==="0px"?0:e.offsetWidth}static preventDialogFlicker(e,t=0){e&&(e.style.opacity="0",e.style.transition="opacity 0.15s ease-in",requestAnimationFrame(()=>{e&&(e.style.opacity="1")}))}static addCSSVars(e,t){let s=document.querySelector("style#flash5e-vars");if(!s){const f=document.querySelector("body.flash5e");if(!f)return;const p=f.querySelector("style#flash5e-vars");p&&p.remove(),s=document.createElement("style"),s.id="flash5e-vars",s.textContent=`body.flash5e {
}
`,f.prepend(s)}let o=s.textContent,a=o.indexOf("body.flash5e {"),i=o.indexOf("}",a);a===-1&&(o=`body.flash5e {
}
`,a=0,i=o.indexOf("}"));const n=o.substring(a+14,i).split(";").map(f=>f.trim()).filter(f=>f!==""),c={};n.forEach(f=>{const p=f.split(":");if(p.length>=2){const m=p[0].trim(),h=p.slice(1).join(":").trim();m&&(c[m]=h)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),c[e]=t;const d=Object.entries(c).map(([f,p])=>`  ${f}: ${p};`).join(`
`),u=o.substring(0,a)+`body.flash5e {
`+d+`
}`+o.substring(i+1);s.textContent=u}static getOffsetBottom(e){const t=e.offsetTop,s=e.offsetHeight;return window.innerHeight-(t+s)}static async getAllFonts(){const e=new Set(Object.keys(CONFIG.fontDefinitions)),t=game.settings.get("core","fonts")||{},s=Object.entries(t).map(([i])=>i),o=await this.processStyleSheets();return Array.from(new Set([...e,...s,...o])).filter(i=>!/FontAwesome|Font Awesome|FoundryVTT/.test(i)).map(i=>i.replace(/['"]/g,"").trim()).sort((i,l)=>i.toLowerCase().localeCompare(l.toLowerCase()))||[]}static addCustomCSS(e,t="flash5e-custom-css",s=!0){if(!e)return;let o=document.querySelector("#"+t);o||(o=document.createElement("style"),o.id=t,o.textContent="",document.head.appendChild(o));const a=/@import\s+(?:url\()?\s*['"]?[^'")]+['"]?\s*\)?\s*;/g,i=[];let l=e,n;for(;(n=a.exec(e))!==null;)i.push(n[0]);if(l=e.replace(a,"").trim(),!s){o.textContent=i.join(`
`)+(i.length?`

`:"")+l;return}if(!o.textContent.includes(l)){const c=o.textContent,d=[];let u;for(;(u=a.exec(c))!==null;)d.push(u[0]);const f=c.replace(a,"").trim(),p=i.filter(h=>!d.includes(h)),m=[...d,...p];o.textContent=m.join(`
`)+(m.length?`

`:"")+f+(f&&l?`

`:"")+l}}static smoothScrollTo(e,t,s="horizontal",o=300,a=null){const i=e.dataset.scrollAnimationId;i&&cancelAnimationFrame(Number(i));const l=s==="horizontal",n=l?e.scrollLeft:e.scrollTop,c=t-n;if(c===0)return a&&a(),null;const d=performance.now(),u=p=>{const m=p-d;if(m>=o){l?e.scrollLeft=t:e.scrollTop=t,delete e.dataset.scrollAnimationId,a&&a();return}const h=m/o,S=h<.5?2*h*h:1-Math.pow(-2*h+2,2)/2;l?e.scrollLeft=n+c*S:e.scrollTop=n+c*S;const R=requestAnimationFrame(u);return e.dataset.scrollAnimationId=R,R},f=requestAnimationFrame(u);return e.dataset.scrollAnimationId=f,f}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredLabel"),s={}){const o={window:{title:e},position:{width:420,height:"auto"},content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.reloadButton"),callback:()=>(r.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(o,s),foundry.applications.api.DialogV2.confirm(o)}static renderTemplate(e,t){return foundry.applications.handlebars.renderTemplate(e,t)}static loadTemplate(e){return foundry.applications.handlebars.loadTemplate(e)}static loadTemplates(e){return Array.isArray(e)||(e=[e]),foundry.applications.handlebars.loadTemplates(e)}static isValidCSSRule(e){if(!e||typeof e!="string")return!1;const t=e.trim();if(!t)return!1;try{const s=document.createElement("style"),o=`${t} { color: inherit; }`;s.textContent=o,document.head.appendChild(s);const a=!!(s.sheet&&s.sheet.cssRules&&s.sheet.cssRules.length>0);return document.head.removeChild(s),a}catch(s){return r.log("CSS validation error:",[s,e]),!1}}static processCSSRules(e,t){if(!e||!t)return"";const s=be(this,Ue,yt).call(this,e),o=t+` {
`+s.baseProperties.join(`
`)+`
}`,a=[],i=new Map;return s.nestedRules.forEach(l=>{const{selector:n,content:c}=l;if(n.startsWith("&")){const f=n.substring(1),p=t.split(",").map(m=>m.trim()).filter(Boolean).map(m=>m+f).join(", ");a.push(`${p} {
${c}
}`);return}i.has(c)||i.set(c,[]);const d=n.split(",").map(f=>f.trim()),u=t.split(",").map(f=>f.trim()).filter(Boolean);d.forEach(f=>{u.forEach(p=>{i.get(c).push(`${p} ${f}`)})})}),i.forEach((l,n)=>{a.push(`${l.join(", ")} {
${n}
}`)}),o+`

`+a.join(`

`)}static getActorOwner(e){const t=e.ownership||{};for(const[s,o]of Object.entries(t))if(o>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const a=game.users.get(s);if(a&&!a.isGM)return a}if((t==null?void 0:t.default)>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const s=game.users.filter(o=>!o.isGM)[0];if(s)return s}return null}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredLabel"),s={}){const o={window:{title:e},position:{width:420,height:"auto"},content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.reloadButton"),callback:()=>(r.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(o,s),foundry.applications.api.DialogV2.confirm(o)}static async removeTemplateForItem(e){const t=E(),s=C.get(t.removeTemplate.tag);if(r.log("removeTemplateForItem",[e,s]),!!s){if(!game.user.isGM){r.log("removeTemplateForItem - requesting GM to remove template",[e==null?void 0:e.uuid]),re.execForGMs("removeTemplate",e==null?void 0:e.uuid);return}try{const o=canvas.templates.objects.children.filter(a=>a.document.flags.dnd5e.item===(e==null?void 0:e.uuid));if(o.length>0){const a=o.map(l=>l.id),i=canvas.scene.templates.filter(l=>a.includes(l.id));i.length>0?(r.log("removeTemplateForItem - removing templates",[e==null?void 0:e.uuid,i.length]),await canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate",i.map(l=>l.id))):r.log("removeTemplateForItem - templates already removed",[e==null?void 0:e.uuid])}}catch(o){r.log("removeTemplateForItem - template not found or already deleted",[e==null?void 0:e.uuid,o.message])}}}static async removeTemplate(e){r.log("removeTemplate",[e]);try{const t=await fromUuid(e);if(t&&game.user.isGM)return Fe.removeTemplateForItem(t)}catch(t){r.error("removeTemplate - error",[t])}}static areSkipKeysPressed(e){if(!e)return!1;const{areKeysPressed:t}=game.dnd5e.utils||{};return t?t(e,"skipDialogNormal")||t(e,"skipDialogAdvantage")||t(e,"skipDialogDisadvantage"):e.shiftKey||e.altKey||e.ctrlKey||e.metaKey||!1}};Ue=new WeakSet,yt=function(e){const t=[],s=[],o=e.split(`
`);let a=null,i=0;for(let l=0;l<o.length;l++){const n=o[l].trim();if(!n)continue;const c=(n.match(/{/g)||[]).length,d=(n.match(/}/g)||[]).length;if(n.includes("{")&&!a){a={selector:n.substring(0,n.indexOf("{")).trim(),content:"",startLine:l},i=1;const f=n.substring(n.indexOf("{")+1).trim();f&&!f.includes("}")&&(a.content+=f+`
`)}else a?(i+=c-d,i>0?a.content+=n+`
`:(a.content=a.content.replace(/}\s*$/,"").trim(),s.push(a),a=null)):!n.includes("{")&&!n.includes("}")&&t.push(n)}return{baseProperties:t,nestedRules:s}},ue(Fe,Ue),w(Fe,"wrapFontName",e=>{const t=e.replace(/['"`]/g,"");return t.includes(" ")?`"${t}"`:t});let D=Fe;class Te{static initializeDragAndDrop(e){e.querySelectorAll(".sortable-icon-list").forEach(o=>{this.setupListEventListeners(o)}),e.querySelectorAll(".icon-toggle").forEach(o=>{o.addEventListener("change",this.handleIconToggle.bind(this))})}static setupListEventListeners(e){e.addEventListener("dragover",this.handleDragOver.bind(this)),e.addEventListener("drop",this.handleDrop.bind(this)),e.addEventListener("dragenter",this.handleDragEnter.bind(this)),e.addEventListener("dragleave",this.handleDragLeave.bind(this)),e.querySelectorAll(".icon-item").forEach(s=>{s.addEventListener("dragstart",this.handleDragStart.bind(this)),s.addEventListener("dragend",this.handleDragEnd.bind(this))})}static handleDragStart(e){const t=e.target.closest(".icon-item");t&&(t.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",t.outerHTML),e.dataTransfer.setData("text/plain",JSON.stringify({iconId:t.dataset.iconId,iconType:t.closest(".sortable-icon-list").dataset.iconType,order:parseInt(t.dataset.order)})))}static handleDragEnd(e){const t=e.target.closest(".icon-item");t&&(t.classList.remove("dragging"),document.querySelectorAll(".sortable-icon-list").forEach(s=>{s.classList.remove("drag-over")}),document.querySelectorAll(".drag-placeholder").forEach(s=>{s.remove()}))}static handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.currentTarget,s=document.querySelector(".icon-item.dragging");if(!s)return;const o=s.closest(".sortable-icon-list").dataset.iconType,a=t.dataset.iconType;if(o!==a){e.dataTransfer.dropEffect="none";return}const i=this.getDragAfterElement(t,e.clientY);i==null?t.appendChild(s):t.insertBefore(s,i)}static handleDragEnter(e){e.preventDefault(),e.currentTarget.classList.add("drag-over")}static handleDragLeave(e){const t=e.currentTarget,s=t.getBoundingClientRect();(e.clientX<s.left||e.clientX>s.right||e.clientY<s.top||e.clientY>s.bottom)&&t.classList.remove("drag-over")}static handleDrop(e){e.preventDefault();const t=e.currentTarget;t.classList.remove("drag-over"),this.updateIconOrder(t)}static getDragAfterElement(e,t){return[...e.querySelectorAll(".icon-item:not(.dragging)")].reduce((o,a)=>{const i=a.getBoundingClientRect(),l=t-i.top-i.height/2;return l<0&&l>o.offset?{offset:l,element:a}:o},{offset:Number.NEGATIVE_INFINITY}).element}static handleIconToggle(e){const t=e.target,s=t.closest(".icon-item"),o=t.checked;s.dataset.enabled=o,o?s.classList.remove("disabled"):s.classList.add("disabled");const a=s.closest(".sortable-icon-list");this.updateIconOrder(a)}static updateIconOrder(e){var n;const t=e.dataset.iconType,o=[...e.querySelectorAll(".icon-item")].map((c,d)=>({id:c.dataset.iconId,icon:this.getIconClass(c.dataset.iconId,t),enabled:c.dataset.enabled==="true",order:d})),a=E(),l={...C.get(a.menuIconsLayout.tag)||Ie(),[t]:o};C.set(a.menuIconsLayout.tag,l),(n=game.flashRolls)!=null&&n.menu&&game.flashRolls.menu.render(!1)}static getIconClass(e,t){const s=Pt(e,t);return s?s.icon:""}static getEnabledIcons(e){const t=E();return((C.get(t.menuIconsLayout.tag)||Ie())[e]||[]).filter(a=>a.enabled).sort((a,i)=>a.order-i.order)}static getAllIcons(e){const t=E();return((C.get(t.menuIconsLayout.tag)||Ie())[e]||[]).sort((a,i)=>a.order-i.order)}static getIconConfigurations(){return{moduleActions:ht,actorActions:Rt}}static resetToDefault(e=null){const t=E(),s=Ie();if(e){const a={...C.get(t.menuIconsLayout.tag)||{},[e]:s[e]};C.set(t.menuIconsLayout.tag,a)}else C.set(t.menuIconsLayout.tag,s)}}const{FormDataExtended:ns}=foundry.utils,{ApplicationV2:zt,HandlebarsApplicationMixin:Ut}=foundry.applications.api;var mt,ce,ve,Ze,_e,bt,St,ye,Lt,Tt,At;const N=class N extends Ut(zt){constructor(){super(...arguments);ue(this,_e);w(this,"_onRender",(t,s)=>{E(),he(N,ce,this.element),P(N,ce).querySelectorAll(".toggle-hint").forEach(l=>{l.addEventListener("click",()=>{P(N,ce).querySelectorAll("p.hint").forEach(n=>n.classList.toggle("shown"))})});const a=P(N,ce).querySelector(".icon-arrangement-container");a&&Te.initializeDragAndDrop(a),P(N,ce).querySelectorAll("select[data-current-value]").forEach(l=>{const n=String(l.dataset.currentValue),c=l.querySelector(`option[value="${n}"]`);c&&(c.selected=!0)}),be(this,_e,bt).call(this)})}_configureRenderParts(t){const s=super._configureRenderParts(t),o=N.getRestrictedTabs();return game.user.isGM||o.forEach(a=>{delete s[a]}),s}async _prepareContext(t){const s=await super._prepareContext(t);return s.activeTab=t.activeTab||Object.keys(s.tabs)[0],s.isGM=game.user.isGM,s.midiQolActive=D.isModuleOn("midi-qol"),s.midiQolActiveWarning=game.i18n.localize("FLASH_ROLLS.notifications.midiQolActive"),s}async _preparePartContext(t,s,o){var l,n,c;const a=await super._preparePartContext(t,s,o);t in s.tabs&&(a.tab=a.tabs[t]),E(),kt();const i=N.getRestrictedTabs();switch(game.user.isGM||i.forEach(d=>{delete a.tabs[d]}),t){case"tabs":break;case"footer":{a.buttons=[{type:"button",icon:"",label:"FLASH_ROLLS.ui.buttons.reset",action:"redefine"},{type:"submit",icon:"",label:"FLASH_ROLLS.ui.buttons.save"}];break}default:{a.tab=a.tabs[t];const d=((l=N.PARTS[t])==null?void 0:l.menuKey)||null;if(d){const u=N.getMenuContext(d);if(u.fields&&(a.fields={...a.fields,...u.fields}),u.fieldDefaults&&(a.fieldDefaults={...a.fieldDefaults,...u.fieldDefaults}),u.fieldValues&&Object.assign(a,u.fieldValues),t==="interfaceSettings"){a.iconConfigs=Te.getIconConfigurations();const f=Te.getIconConfigurations(),m=E().menuIconsLayout.default,h=a.menuIconsLayout||{},S=(R,T)=>{const L=m[R]||[],k=h[R]||[],I=new Map(L.map(_=>[_.id,_])),A=new Map(k.map(_=>[_.id,_]));return Object.keys(T).map((_,F)=>{const q=T[_],G=I.get(_),Q=A.get(_);return{id:_,icon:q.icon,enabled:Q?Q.enabled:G?G.enabled:!1,order:Q?Q.order:G?G.order:F,label:game.i18n.localize(q.labelKey||_)}}).sort((_,F)=>_.order-F.order)};a.menuIconsLayout={moduleActions:S("moduleActions",f.moduleActions),actorActions:S("actorActions",f.actorActions)}}a.sidebarTabs=Object.values(((c=(n=foundry.applications)==null?void 0:n.sidebar)==null?void 0:c.tabs)||{}).map(f=>({tabName:f.tabName,name:f.name,hideForGM:!1,hideForPlayer:!1,localizedName:`FLASH_ROLLS.settings.sidebarTabs.${f.name}`}))}break}}return r.log("_preparePartContext",[a,t]),a}static getMenuContext(t){var n;const s=E(),o=((n=s[t])==null?void 0:n.fields)||null;if(!o)return{};const a={},i={},l={};return o.forEach(c=>{if(s[c]){const d=C.get(s[c].tag);a[c]=s[c],i[c]=d!==void 0?d:s[c].default,l[c]=s[c].default}}),{fields:a,fieldValues:i,fieldDefaults:l}}static getRestrictedTabs(){const t=[];return Object.entries(N.PARTS).forEach((s,o)=>{s[0]!=="tabs"&&s[0]!=="footer"&&s[1].isGMOnly&&t.push(s[0])}),t}static updateSettings(t){let s=!1;const o=E(),l=P(N,ce).querySelector(".form-content.active").dataset.tab;if(he(N,ve,l),!t)return;let n;return t.object&&(n=foundry.utils.expandObject(t.object)),Object.entries(n).forEach(([c,d])=>{var u;if(!c.endsWith("_value")&&(r.log("updateSettings #1",[o,o[c]]),n[c]!==void 0&&o[c])){const f=C.get(o[c].tag);C.set(o[c].tag,n[c]),(u=o[c])!=null&&u.requiresReload&&f!==n[c]&&(s=!0)}}),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.settingsUpdated")),s}changeTab(t,s,o){super.changeTab(t,s,o),he(N,ve,t)}};ce=new WeakMap,ve=new WeakMap,Ze=new WeakMap,_e=new WeakSet,bt=function(){P(N,ce).querySelectorAll(".form-group.range").forEach(s=>{const o=s.querySelector('input[type="range"]'),a=s.querySelector('input[type="number"]');be(this,_e,St).call(this,o,a)})},St=function(t,s){if(t&&s){const o=parseInt(t.min,10),a=parseInt(t.max,10);t.addEventListener("input",()=>{s.value=t.value}),s.addEventListener("input",()=>{const i=s.value;if(i===""||i==="-")return;const l=parseInt(i,10);!isNaN(l)&&l>=o&&l<=a&&(t.value=l)}),s.addEventListener("change",()=>{let i=parseInt(s.value,10);isNaN(i)||i<o?i=o:i>a&&(i=a),s.value=i,t.value=i}),s.value=t.value}},ye=new WeakSet,Lt=async function(t,s,o){t.preventDefault(),t.stopPropagation(),N.updateSettings(o)&&D.confirmReload()},Tt=async function(t,s){const o=E(),i=P(N,ce).querySelector(".form-content.active"),l=i.dataset.tab,n=N.PARTS[l].menuKey,c=o[n].default;if(l==="interfaceSettings"){Te.resetToDefault();const u=foundry.applications.instances.get("flash-rolls-settings");if(u){await u.renderPart("interfaceSettings",{force:!0});return}}i.querySelectorAll("input, select").forEach(u=>{u.value=c[u.name],u.type==="checkbox"&&(u.checked=c[u.name])}),r.log("#onReset",[P(N,ve),l,t,s])},At=function(){const t=[];return Object.entries(N.PARTS).forEach(([s,o])=>{o.menuKey&&t.push({id:s,icon:"",group:"primary-tabs",label:`FLASH_ROLLS.settings.moduleSettingsMenu.tabs.${s}`})}),t},ue(N,ye),ue(N,ce),ue(N,ve),ue(N,Ze),w(N,"selectedTheme"),w(N,"DEFAULT_OPTIONS",{id:"flash-rolls-settings",tag:"form",window:{icon:"fas fa-cog",title:"FLASH_ROLLS.settings.moduleSettingsMenu.title",contentClasses:["standard-form","crlngn","flash5e","tabbed-settings"],resizable:!0},position:{width:700,height:"auto"},actions:{redefine:be(N,ye,Tt)},form:{handler:be(N,ye,Lt),closeOnSubmit:!0}}),w(N,"PARTS",{tabs:{template:"templates/generic/tab-navigation.hbs",isGMOnly:!1},generalSettings:{menuKey:"generalSettings",template:"modules/flash-rolls-5e/templates/settings-general.hbs",isGMOnly:!0},interfaceSettings:{menuKey:"interfaceSettings",template:"modules/flash-rolls-5e/templates/settings-interface.hbs",isGMOnly:!0},groupRolls:{menuKey:"groupRollsSettings",template:"modules/flash-rolls-5e/templates/settings-group-rolls.hbs",isGMOnly:!0},rollRequests:{menuKey:"rollRequestsSettings",template:"modules/flash-rolls-5e/templates/settings-roll-requests.hbs",isGMOnly:!0},footer:{template:"templates/generic/form-footer.hbs",isGMOnly:!1}}),w(N,"TABS",{primary:{initial:"interfaceSettings",tabs:be(mt=N,ye,At).call(mt),labelPrefix:""}});let xe=N;class Vt extends FormApplication{constructor(...e){super(...e),window.open("https://www.patreon.com/c/carolingiandev/membership","_blank"),this.close()}render(){return this.close(),this}}function kt(){return{moduleSettingsMenu:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),name:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),icon:"fas fa-cog",propType:xe,restricted:!0},supportPatreon:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.label"),name:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.label"),label:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.buttonLabel"),hint:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.hint"),icon:"fas fa-heart",propType:Vt,restricted:!1}}}class Ct{static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}static getMidiQOL(){return this.isModuleActive("midi-qol")&&typeof MidiQOL<"u"?MidiQOL:null}}w(Ct,"midiTimeout",null);function $t(g,e){var o,a,i,l,n;let t=game.i18n.localize(`FLASH_ROLLS.rollTypes.${g}`)||g;const s=g==null?void 0:g.toLowerCase();if(e)switch(s){case y.SKILL:t+=` (${((o=CONFIG.DND5E.skills[e])==null?void 0:o.label)||e})`;break;case y.SAVE:t+=` (${((a=CONFIG.DND5E.abilities[e])==null?void 0:a.label)||e})`;break;case y.ABILITY:t+=` (${((i=CONFIG.DND5E.abilities[e])==null?void 0:i.label)||e})`;break;case y.TOOL:const c=(n=(l=CONFIG.DND5E.enrichmentLookup)==null?void 0:l.tools)==null?void 0:n[e];if(c!=null&&c.id){const d=dnd5e.documents.Trait.getBaseItem(c.id,{indexOnly:!0});t+=` (${(d==null?void 0:d.name)||e})`}else t+=` (${e})`;break;case y.CUSTOM:t=`${t}: ${e}`;break}return t}function jt(g,e){var s,o,a,i,l;if(!e)return"";switch(g==null?void 0:g.toLowerCase()){case y.SKILL:return((s=CONFIG.DND5E.skills[e])==null?void 0:s.label)||e;case y.SAVE:case y.SAVING_THROW:return((o=CONFIG.DND5E.abilities[e])==null?void 0:o.label)||e;case y.ABILITY:case y.ABILITY_CHECK:return((a=CONFIG.DND5E.abilities[e])==null?void 0:a.label)||e;case y.TOOL:const n=(l=(i=CONFIG.DND5E.enrichmentLookup)==null?void 0:i.tools)==null?void 0:l[e];if(n!=null&&n.id){const c=dnd5e.documents.Trait.getBaseItem(n.id,{indexOnly:!0});return(c==null?void 0:c.name)||e}return e;default:return e}}function Wt(g,e=$t){if(g.length===0)return;const t={};for(const o of g){const a=`${o.rollType}_${o.rollKey||""}`;t[a]||(t[a]={rollType:o.rollType,rollKey:o.rollKey,actors:[],gm:o.gm}),t[a].actors.push(o.actor)}const s=Object.values(t);if(s.length===1&&s[0].actors.length===1){const o=s[0];ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestReceived",{gm:o.gm,rollType:e(o.rollType,o.rollKey)}))}else{const o=[];for(const a of s){const i=e(a.rollType,a.rollKey),l=a.actors.join(", ");o.push(`${i} (${l})`)}ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsReceivedMultiple",{gm:s[0].gm,requests:o.join("; ")}))}}function It(g){const e=g.ownership||{};for(const[t,s]of Object.entries(e))if(s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const o=game.users.get(t);if(o&&!o.isGM)return o}return null}function Kt(g,e=game.user){g!=null&&g.length&&g.forEach((t,s)=>{r.log("applyTargetTokens",[t,canvas.tokens.placeables.map(a=>a.id)]);const o=canvas.tokens.placeables.find(a=>a.id===t);o?o.setTarget(!0,{releaseOthers:s===0}):r.warn("applyTargetTokens - Token not found:",[t])})}function et(g){return g.type!=="character"&&g.type!=="npc"?!1:Object.entries(g.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}function Et(g){if(g.type!=="character"&&g.type!=="npc")return!1;const e=game.scenes.current;return e&&e.tokens.some(t=>t.actorId===g.id)}function ie(g,e,t=null){if(!game.scenes.current)return;let o;if(t){const a=canvas.tokens.placeables.find(i=>i.id===t);o=a?[a]:[]}else o=canvas.tokens.placeables.filter(a=>{var i;return((i=a.actor)==null?void 0:i.id)===g});for(const a of o)e?a.control({releaseOthers:!1}):a.release()}function Be(g){return new Promise(e=>setTimeout(e,g))}function ct(){var g;return((g=ui==null?void 0:ui.sidebar)==null?void 0:g.expanded)||!1}function dt(g){const e=document.querySelector("body");g?e.classList.add("flash5e-sidebar-expanded"):e.classList.remove("flash5e-sidebar-expanded"),Le()}function ut(g,e){var a,i;const t=[];if(!g)return t;const s=W.ROLL_REQUEST_OPTIONS[g];if(!s||!s.subList)return t;const o=CONFIG.DND5E[s.subList];if(o){for(const[l,n]of Object.entries(o)){let c=n.label||n.name||l;if(s.subList==="tools"&&((i=(a=CONFIG.DND5E.enrichmentLookup)==null?void 0:a.tools)!=null&&i[l])){const d=CONFIG.DND5E.enrichmentLookup.tools[l];if(d!=null&&d.id){const u=dnd5e.documents.Trait.getBaseItem(d.id,{indexOnly:!0});c=(u==null?void 0:u.name)||c}}t.push({id:l,name:c,rollable:!0})}t.sort((l,n)=>l.name.localeCompare(n.name))}return t}const Z=class Z{static notify(e,t,s={}){if(!s.batch){ui.notifications[e](t);return}s.batchData&&(Z.pendingNotifications.push(s.batchData),Z.notificationTimer&&clearTimeout(Z.notificationTimer),Z.notificationTimer=setTimeout(()=>{Wt(Z.pendingNotifications),Z.pendingNotifications=[],Z.notificationTimer=null},Z.NOTIFICATION_BATCH_DELAY))}static notifyRollRequestsSent(e,t){const s=Object.entries(e);if(s.length!==0)if(s.length===1){const o=Object.values(e)[0],a=o.actors.map(i=>i.name).join(", ");ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentSingle",{rollType:t,actors:a,player:o.player.name}))}else{const o=s.map(([a,i])=>{const l=i.actors.map(n=>n.name).join(", ");return`${i.player.name} (${l})`});ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentMultiple",{rollType:t,count:s.length,players:o.join("; ")}))}}static clearPending(){Z.notificationTimer&&(clearTimeout(Z.notificationTimer),Z.notificationTimer=null),Z.pendingNotifications=[]}};w(Z,"pendingNotifications",[]),w(Z,"notificationTimer",null),w(Z,"NOTIFICATION_BATCH_DELAY",500);let X=Z;function Yt(g){var s;const e=[],t=[];for(const o of g){const a=((s=o.system.attributes.hp)==null?void 0:s.value)||0,i=o.system.attributes.death||{},l=i.success||0,n=i.failure||0;a<=0&&l<3&&n<3?e.push(o):t.push(o.name)}return t.length>0&&X.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorsSkippingDeathSave",{actors:t.join(", ")})),e}function Qt(g){const e=[],t=[];for(const s of g){const o=It(s);o?e.push({actor:s,owner:o}):t.push(s)}return{pcActors:e,npcActors:t}}function Le(g=!0){const e=document.querySelector("#chat-notifications #roll-privacy"),t=e?D.getFullWidth(e):36,s=!!document.querySelector("body.crlngn-tabs");D.addCSSVars("--flash-rolls-menu-offset",(s?t:t+16)+"px")}function ee(g){var o,a;const e=(o=game.scenes.current)==null?void 0:o.tokens.get(g);if(e!=null&&e.actor)return e.actor;const t=(a=canvas.tokens)==null?void 0:a.get(g);return t!=null&&t.actor?t.actor:game.actors.get(g)||null}function gt(){const g=E();switch(C.get(g.consumptionConfigMode.tag)){case 1:return!1;case 2:return game.user.isGM;case 3:return!game.user.isGM;default:return!0}}function Se(g,e=!0){let t={...g};return game.user.isGM&&(t.action=e?g.action:!1,t.resources=e?g.resources:[],t.spellSlot=e?g.spellSlot:!1),t}function We(g,e=!0){const t=E(),s=C.get(t.placeTemplateForPlayer.tag),o=g.measuredTemplate===!0,a=game.user.isGM?e||s:!s;return r.log("getCreateConfig",[g,e,s,o,a]),{...g,measuredTemplate:o?a:!1}}const v={addSituationalBonus(g,e){var t;return r.log("Config before adding bonus:",[e,g]),e&&((t=g.rolls)!=null&&t[0])&&(g.rolls[0].parts||(g.rolls[0].parts=[]),g.rolls[0].data||(g.rolls[0].data={}),g.rolls[0].data.situational=e,g.rolls[0].parts.includes("@situational")||g.rolls[0].parts.push("@situational"),r.log("Config after adding bonus:",[g])),g},async unsetActivityFlag(g){if(!game.user.isGM||!g)return;const e=g.getFlag(b,"tempActivityConfig");e&&(r.log("updateActivityConfigFlag - cleaning up existing config",[e]),await g.unsetFlag(b,"tempActivityConfig"))},async updateActivityConfigFlag(g,e){r.log("updateActivityConfigFlag - storing new activity config",[e]),await g.setFlag(b,"tempActivityConfig",e)},buildRollConfig(g,e,t={}){var a;r.log("RollHelpers.buildRollConfig - incoming rollConfig",["parts:",e.parts,"data:",e.data,"requestData.config.situational:",g.config.situational]);const s={rolls:[{parts:e.parts||[],data:e.data||{},options:{...e.options||{},...((a=e.options)==null?void 0:a._fromFlashRolls)&&{_fromFlashRolls:!0}}}],advantage:g.config.advantage||!1,disadvantage:g.config.disadvantage||!1,target:g.config.target,subject:null,chatMessage:!0,legacy:!1,...g.config.rollMode&&{rollMode:g.config.rollMode},...t},o=g.config.situational;return o&&this.addSituationalBonus(s,o),this.ensureRollFlags(s,g)},ensureRollFlags(g,e){return g.isRollRequest=!game.user.isGM,g._showRequestedBy=!0,g._requestedBy=e.config.requestedBy||"GM",g},validateActors(g){return!g||g.length===0?null:(typeof g[0]=="string"&&(g=g.map(e=>game.actors.get(e)).filter(e=>e)),g.length>0?g:null)},getRollClass(g){const e=g==null?void 0:g.toLowerCase();return[y.DAMAGE,y.HEALING].includes(e)?CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:[y.FORMULA,y.CUSTOM,y.HIT_DIE].includes(e)?CONFIG.Dice.BasicRoll:CONFIG.Dice.D20Roll},shouldShowDC(g){const e=g==null?void 0:g.toLowerCase();return[y.SAVE,y.SAVING_THROW,y.ABILITY,y.ABILITY_CHECK,y.CONCENTRATION,y.SKILL,y.TOOL].includes(e)},createBaseRollConfig(g,e,t){const s=e==null?void 0:e.toLowerCase(),o={data:g.getRollData(),subject:g,rolls:[{parts:[],data:g.getRollData(),options:{}}]};switch(s){case y.SKILL:o.skill=t;break;case y.TOOL:o.tool=t;break;case y.SAVE:case y.SAVING_THROW:case y.ABILITY:case y.ABILITY_CHECK:o.ability=t;break;case y.HIT_DIE:o.rolls[0].options.flavor="Hit Die";break}return o},createMessageConfig(g,e=null){const t={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:g})}};return e&&(t.rollMode=e),t},async triggerRollDialog(g,e,t,s){const o=new g(e,t,s);return await new Promise(i=>{o.addEventListener("close",()=>{i({rolls:o.rolls,config:o.config,message:o.message,sendRequest:o.sendRequest,critical:o.config.critical,isCritical:o.config.isCritical})},{once:!0}),o.render({force:!0})})},processDialogResult(g,e,t,s,o={}){var h,S,R,T,L,k,I;if(!(g!=null&&g.rolls)||g.rolls.length===0)return null;const a=t==null?void 0:t.toLowerCase(),i=g.rolls[0];let l=!1,n=!1;((h=i==null?void 0:i.options)==null?void 0:h.advantageMode)!==void 0&&(l=i.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,n=i.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const c=((S=i==null?void 0:i.data)==null?void 0:S.situational)||"",d=(R=i==null?void 0:i.options)==null?void 0:R.target,u={rolls:[{parts:((T=i==null?void 0:i.parts)==null?void 0:T.slice())||[],data:c?{situational:c}:{},options:d?{target:d}:{}}],subject:e[0],advantage:l,disadvantage:n,target:d,sendRequest:g.sendRequest,isRollRequest:g.sendRequest,skipRollDialog:((L=g.config)==null?void 0:L.skipRollDialog)||o.skipRollDialog||!1,chatMessage:!0},f=E(),p=C.get(f.publicPlayerRolls.tag)===!0,m=this.determineRollMode(p,(k=g.message)==null?void 0:k.rollMode);return u.rollMode=m,(I=g.config)!=null&&I.ability&&[y.SKILL,y.TOOL].includes(a)&&(u.ability=g.config.ability),u},determineRollMode(g,e){return e||game.settings.get("core","rollMode")},isPlayerOwned(g){return Object.entries(g.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})},isPlayerOwnerActive(g){const e=It(g);return e&&e.active},calculateStandardRule(g,e){const t=g.filter(a=>a.total>=e).length,s=g.length-t,o=Math.ceil(g.length/2);return{finalResult:t>=o,successes:t,failures:s,summary:game.i18n.format("FLASH_ROLLS.groupRoll.standardRule.summary",{successes:t,total:g.length,threshold:o}),method:"Standard Rule"}},calculateGroupAverage(g,e){const t=g.reduce((o,a)=>o+a.total,0),s=Math.floor(t/g.length);return{finalResult:s,average:s,success:s>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.groupAverage.summary",{average:s,dc:e}),method:"Group Average"}},calculateLeaderWithHelp(g,e,t,s,o){var S;let a=-999,i=-1,l=null,n=0;for(let R=0;R<g.length;R++){const T=g[R],L=t.find(I=>I.id===T.actorId);if(!L)continue;const k=this._getActorModifier(L,s,o);k>a&&(a=k,i=R,l=L.id,n=k)}if(i===-1)return{finalResult:0,error:"No leader found",method:"Leader with Help"};const c=g[i],d=g.filter((R,T)=>T!==i),u=d.filter(R=>R.total>=e).length,f=d.filter(R=>R.total<e).length,p=c.total+u-f;let m,h={leaderRoll:c.total,adjustedResult:p,dc:e};return u>0&&f>0?(m="FLASH_ROLLS.groupRoll.leaderWithHelp.summary",h.bonus=u,h.penalty=f):u>0?(m="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlySuccess",h.bonus=u,h.successWord=u===1?game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.successPlural")):f>0?(m="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlyFailure",h.penalty=f,h.failureWord=f===1?game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.failureSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.failurePlural")):m="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryNoModifiers",{finalResult:p,leaderRoll:c.total,leaderName:(S=t.find(R=>R.id===l))==null?void 0:S.name,leaderActorId:l,leaderModifier:n,bonus:u,penalty:f,success:p>=e,summary:game.i18n.format(m,h),method:"Leader with Help"}},calculateWeakestLink(g,e,t,s,o){var f;let a=999,i=null,l=0;for(const p of t){const m=this._getActorModifier(p,s,o);m<a&&(a=m,i=p.id,l=m)}const n=g.find(p=>p.actorId===i);if(!n)return{finalResult:0,error:"Weakest link actor did not roll",method:"Weakest Link"};const c=g.filter(p=>p.actorId!==i&&p.total>=e).length,d=n.total+c,u=c===1?game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successPlural");return{finalResult:d,weakestRoll:n.total,weakestName:(f=t.find(p=>p.id===i))==null?void 0:f.name,weakestActorId:i,weakestModifier:l,bonus:c,success:d>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.weakestLink.summary",{weakestRoll:n.total,bonus:c,successWord:u,adjustedResult:d,dc:e}),method:"Weakest Link"}},_getActorModifier(g,e,t){var o,a,i,l,n,c,d;switch(e==null?void 0:e.toLowerCase()){case y.SKILL:return((o=g.system.skills[t])==null?void 0:o.total)||((a=g.system.skills[t])==null?void 0:a.mod)||0;case y.SAVE:case y.SAVING_THROW:return((l=(i=g.system.abilities[t])==null?void 0:i.save)==null?void 0:l.value)||((n=g.system.abilities[t])==null?void 0:n.save)||0;case y.ABILITY:case y.ABILITY_CHECK:return((c=g.system.abilities[t])==null?void 0:c.mod)||0;case y.TOOL:if((d=g.system.tools)!=null&&d[t])return g.system.tools[t].total||g.system.tools[t].mod||0;const u=g.items.find(f=>f.type==="tool"&&f.system.toolType===t);return(u==null?void 0:u.system.bonus)||0;default:return 0}},getGroupResult(g,e,t,s,o){if(!g.every(c=>c.total!==null&&c.total!==void 0))return{complete:!1,success:!1,result:0};const i=E(),l=C.get(i.groupRollResultMode.tag)||1;let n;switch(l){case 1:return n=this.calculateStandardRule(g,e),{complete:!0,success:n.finalResult,result:n.finalResult?1:0,details:n};case 2:return n=this.calculateGroupAverage(g,e),{complete:!0,success:n.success,result:n.finalResult,details:n};case 3:return n=this.calculateLeaderWithHelp(g,e,t,s,o),{complete:!0,success:n.success,result:n.finalResult,details:n};case 4:return n=this.calculateWeakestLink(g,e,t,s,o),{complete:!0,success:n.success,result:n.finalResult,details:n};default:return n=this.calculateStandardRule(g,e),{complete:!0,success:n.finalResult,result:n.finalResult?1:0,details:n}}},consolidateRolls(g){if(!g||g.length===0||g.length===1)return g;let e=g[0];for(let t=1;t<g.length;t++)g[t]&&(e=foundry.utils.mergeObject(e,g[t],{insertKeys:!0,insertValues:!0,overwrite:!1,inplace:!0}));return[e]},shouldDisplayChallengeForPlayer(g){var s;if(game.user.isGM)return!0;const e=g._requestedBy;if(e===game.user.name)return!0;switch(game.settings.get("dnd5e","challengeVisibility")){case"all":return!0;case"player":return e!==((s=game.users.find(o=>o.isGM))==null?void 0:s.name);default:return!1}},shouldSkipRollDialog(g=null,{isPC:e=!1,isNPC:t=!1}){const s=E();if(!C.get(s.skipRollDialog.tag))return!1;const a=C.get(s.skipRollDialogOption.tag),i=C.get(s.rollRequestsEnabled.tag);switch(r.log("RollHelpers.shouldSkipRollDialog",["skipRollDialogOption:",a,"rollRequestsEnabled:",i,"sendRequest:",g,"isPC:",e,"isNPC:",t,"test:",g===!0||g!==!1&&i===!0]),a){case 1:return!0;case 2:return r.log("RollHelpers.shouldSkipRollDialog!!!",[e===!0&&g===!0,e===!0&&g!==!1&&i===!0]),e===!0&&g===!0||e===!0&&g!==!1&&i===!0;case 3:return t===!0;default:return!1}}};class Re{static onPreUseActivityGM(e,t,s,o){const a=E(),i=C.get(a.rollRequestsEnabled.tag),l=C.get(a.rollInterceptionEnabled.tag),n=D.isModuleOn("midi-qol");if(!i||!l)return;const c=e.actor,d=D.getActorOwner(c),f=!(et(c)&&d.active)||t.isRollRequest===!1;if(e.item.unsetFlag(b,"tempAttackConfig"),e.item.unsetFlag(b,"tempDamageConfig"),e.item.unsetFlag(b,"tempSaveConfig"),n&&f||!c)return;r.log("ActivityManager.onPreUseActivityGM #1",[t,f]),d&&d.active&&!d.isGM&&(t._originalConsume=structuredClone(t.consume||{}),t._originalCreate=structuredClone(t.create||{}));const p=gt();s.configure=s.configure?p:!1,t.consume=Se(t.consume||{},f),t.create=We(t.create||{},f),d&&d.active&&!d.isGM&&(r.log("ActivityManager.onPreUseActivityGM - Preventing usage message for player-owned actor",[c.name]),o.create=!1)}static onPostUseActivityGM(e,t,s){var p,m;const o=E(),a=C.get(o.rollRequestsEnabled.tag),i=C.get(o.rollInterceptionEnabled.tag),l=D.isModuleOn("midi-qol"),n=e.actor;if(r.log("ActivityManager.onPostUseActivityGM",[e,t,s]),!a||!i||!n)return;const c=D.getActorOwner(n),d=c&&c.active&&c.id!==game.user.id,u=!d||t.isRollRequest===!1;if(l&&u)return;const f=v.shouldSkipRollDialog(d,{isPC:d,isNPC:!d});if(s.configure=t.skipRollDialog!==void 0?!t.skipRollDialog:d&&!f,r.log("ActivityManager.onPostUseActivityGM - skipRollDialog",[f,t.skipRollDialog]),t.skipRollDialog===!1&&(!(c!=null&&c.active)||c.isGM)){r.log("ActivityManager.onPostUseActivityGM - Preventing usage message - no owning player for actor",[e.actor]);return}if(e.item){const h={spell:t.spell||{},scaling:t.scaling,consume:t._originalConsume||t.consume||{},create:t._originalCreate||t.create||{}},S=e.item.id,R={config:h,timestamp:Date.now()};ae.activityConfigCache.set(S,R),r.log("ActivityManager.onPostUseActivityGM - storing activity config in cache",[S,h])}if(l&&(r.log("ActivityManager.onPostUseActivityGM -  MIDI QOL is active",[e]),e.midiOptions={workflowOptions:{autoFastForward:"none",fastForwardSpells:!1,autoFastDamage:!1,autoRollAttack:!1,autoRollDamage:"none"}}),e.type===le.SAVE&&((m=(p=e.damage)==null?void 0:p.parts)==null?void 0:m.length)>0&&!l){r.log("ActivityManager.onPostUseActivityGM - triggering save damage roll",[e,t]);const h=t.skipRollDialog!==void 0?!t.skipRollDialog:d&&!f;e.rollDamage(t,{configure:h},{})}}static onPreUseActivityPlayer(e,t,s,o){const a=E(),i=C.get(a.rollRequestsEnabled.tag),l=C.get(a.rollInterceptionEnabled.tag);if(!i||!l)return;D.isModuleOn("midi-qol"),r.log("ActivityManager.onPreUseActivityPlayer",[e,t,s,o]);const n=e.actor;if(e.item.unsetFlag(b,"tempAttackConfig"),e.item.unsetFlag(b,"tempDamageConfig"),e.item.unsetFlag(b,"tempSaveConfig"),!n)return;const c=gt();s.configure=s.configure?c:!1,t.consume=Se(t.consume||{},!0),t.create=We(t.create||{},!0)}static onPostUseActivityPlayer(e,t,s){var c,d,u,f,p,m;const o=D.isModuleOn("midi-qol");e.midiOptions&&(e.midiOptions={...e.midiOptions,fastForwardDamage:!0,autoRollAttack:!1,autoRollDamage:!0}),r.log("ActivityManager.onPostUseActivityPlayer",[e,t,s,o,(c=e.target)==null?void 0:c.template.count]);const a=((d=e.target)==null?void 0:d.template.count)>0,i=t.create.measuredTemplate!==!0,l=((f=(u=e.target)==null?void 0:u.template)==null?void 0:f.type)==="radius";if((!o||o&&a&&i&&!l)&&e.type===le.SAVE&&((m=(p=e.damage)==null?void 0:p.parts)==null?void 0:m.length)>0){r.log("ActivityManager.onPostUseActivityPlayer - triggering save damage roll",[e,t]);const h=t.skipRollDialog!==void 0?!t.skipRollDialog:!0;e.rollDamage(t,{configure:h},{create:!0})}}static findActivityForRoll(e,t){var a;if(!((a=e==null?void 0:e.system)!=null&&a.activities))return null;const s=e.system.activities;switch(t==null?void 0:t.toLowerCase()){case y.ATTACK:const i=s.getByType("attack");return(i==null?void 0:i[0])||null;case y.DAMAGE:const l=s.getByType("attack");if((l==null?void 0:l.length)>0)return l[0];const n=s.getByType("damage");if((n==null?void 0:n.length)>0)return n[0];const c=s.getByType("save");return(c==null?void 0:c.length)>0?c[0]:null;case y.ITEM_SAVE:const d=s.getByType("save");return(d==null?void 0:d[0])||null;default:return null}}static getActivitiesByType(e,t){var s;return(s=e==null?void 0:e.system)!=null&&s.activities?e.system.activities.getByType(t):[]}static hasActivityForRoll(e,t){return r.log("hasActivityForRoll",[e,t]),!!this.findActivityForRoll(e,t)}static async executeActivityRoll(e,t,s,o,a){var u,f,p;r.log("executeActivityRoll #0",[e,t,s,o,a]);const i=E();game.user.isGM||C.get(i.placeTemplateForPlayer.tag),D.isModuleOn("midi-qol");const l=e.items.get(s);if(!l){r.error("Item not found on actor",[e,s]);return}let n=(o?(u=l.system.activities)==null?void 0:u.get(o):this.findActivityForRoll(l,t))||null,c=null;if(!n){r.error("Activity not found on item",[l,o,t]);return}const d=t==null?void 0:t.toLowerCase();if(n){switch(d){case y.ATTACK:await this.executeAttackActivity(e,n,a);break;case y.DAMAGE:switch(r.log("executeActivityRoll - damage roll #0",[n,a]),c={critical:a.usage.critical||{},situational:a.usage.rolls[0].data.situational||"",rollMode:(f=a.message)==null?void 0:f.rollMode,create:((p=a.message)==null?void 0:p.create)!==!1,scaling:a.usage.scaling,skipRollDialog:a.usage.skipRollDialog,consume:a.usage.consume},a.usage={...a.usage,consume:Se(a.usage.consume||{},!0),create:We(a.usage.create||{},!0)},await n.item.setFlag(b,"tempDamageConfig",c),r.log("executeActivityRoll - flag set",[c]),n.type===le.DAMAGE||n.type===le.SAVE||n!=null&&n.attack,n.type,le.SAVE,n.type,le.ATTACK,n.type){case le.DAMAGE:await this.executeDamageActivity(e,n,a);break;case le.SAVE:await this.executeSaveActivity(e,n,a);break;case le.HEAL:await this.executeHealActivity(e,n,a);break;case le.ATTACK:await this.executeDamagefromAttack(e,n,a,c);break;default:r.error("executeActivityRoll | untracked activity type",[n.type]);break}}return}throw new Error(`No suitable method found for ${d} on item ${l.name}`)}static async executeAttackActivity(e,t,s){var i,l,n,c;const o=D.isModuleOn("midi-qol");r.log("executeAttackActivity",[s]);const a={attackMode:s.usage.attackMode,ammunition:s.usage.ammunition,mastery:s.usage.mastery,situational:(n=(l=(i=s.usage.rolls)==null?void 0:i[0])==null?void 0:l.data)==null?void 0:n.situational,advantage:s.usage.advantage,disadvantage:s.usage.disadvantage,rollMode:(c=s.message)==null?void 0:c.rollMode,skipRollDialog:s.usage.skipRollDialog,consume:s.usage.consume,create:s.usage.create};s.message.create=!0,await t.item.setFlag(b,"tempAttackConfig",a);try{o?(s.usage.consume=Se(s.usage.consume||{},!0),await this.midiActivityRoll(t,s.usage)):await t.use(s.usage,s.dialog,s.message)}catch(d){r.error("executeAttackActivity - attack roll error",[d])}finally{await t.item.unsetFlag(b,"tempAttackConfig")}}static async executeSaveActivity(e,t,s,o){const a=D.isModuleOn("midi-qol");try{a?(s.usage.consume=Se(s.usage.consume||{},!0),await this.midiActivityRoll(t,s.usage)):(r.log("executeSaveActivity - calling activity use",[t,s]),await t.use(s.usage,s.dialog,s.message))}catch(i){r.error("executeSaveActivity - save roll error",[i])}finally{await t.item.unsetFlag(b,"tempDamageConfig"),await t.item.unsetFlag(b,"tempSaveConfig")}}static async executeDamageActivity(e,t,s){const o=D.isModuleOn("midi-qol");try{o?(s.usage.consume=Se(s.usage.consume||{},!0),await this.midiActivityRoll(t,s.usage)):(r.log("executeDamageActivity - calling damage use",[t,s]),await t.use(s.usage,s.dialog,s.message))}catch(a){r.error("executeDamageActivity - roll error",[a])}finally{await t.item.unsetFlag(b,"tempDamageConfig")}}static async executeHealActivity(e,t,s){const o=D.isModuleOn("midi-qol");try{o?(s.usage.consume=Se(s.usage.consume||{},!0),await this.midiActivityRoll(t,s.usage)):(r.log("executeHealActivity - calling use",[t,s]),await t.use(s.usage,s.dialog,s.message))}catch(a){r.error("executeHealActivity - roll error",[a])}finally{await t.item.unsetFlag(b,"tempDamageConfig")}}static async executeDamagefromAttack(e,t,s,o){await t.rollDamage(o,s.dialog,s.message)}static getActivityDisplayInfo(e){return r.log("getActivityDisplayInfo",[e]),e?{name:e.name||e.constructor.metadata.label,type:e.type,icon:e.constructor.metadata.icon,canAttack:e.type==="attack",canDamage:["attack","damage","save"].includes(e.type),canSave:e.type==="save"}:null}static getDamageFormula(e){var s,o;if(r.log("getDamageFormula",[e]),!((o=(s=e==null?void 0:e.damage)==null?void 0:s.parts)!=null&&o.length))return null;const t=e.damage.parts.map(a=>a.formula).filter(a=>a);return t.length>0?t.join(" + "):null}static async midiActivityRoll(e,t={}){r.log("midiActivityRoll",[e,t]);const s=Ct.getMidiQOL();if(!s){r.warn("MidiQOL is not active");return}let o={consume:{action:!1,resources:[],spellSlot:!1},fastForward:!1,fastForwardAttack:!1,dialogOptions:{fastForward:!1,fastForwardAttack:!1,fastForwardDamage:!1},configureDialog:!0,midiOptions:{autoRollAttack:!1,autoFastAttack:!1,autoRollDamage:"none",autoFastDamage:!1,fastForward:!1,fastForwardAttack:!1,fastForwardDamage:!1}};return e.midiProperties={...e.midiProperties,forceDamageDialog:"always"},t={...o,...t},r.log("midiActivityRoll - config",[t]),await s.completeActivityUse(e,t,{})}}class Ke{static addSidebarControls(e,t){if(r.log("addSidebarControls",[e,t]),!game.user.isGM||!e||e.id!=="sidebar")return;const s=document.querySelector("#roll-privacy");if(r.log("addSidebarControls",[s]),!s||s.querySelector(".flash-rolls-icon"))return;const o=E(),a=C.get(o.rollRequestsEnabled.tag),i=document.createElement("button");i.id="flash-rolls-icon",i.setAttribute("data-tooltip-direction","RIGHT"),i.className=`ui-control icon chat-control-icon flash-rolls-icon${a?" active":""}`,i.title=game.i18n.localize("FLASH_ROLLS.ui.menus.rollRequestsTitle"),i.innerHTML=`<i class="fas fa-bolt${a?"":"-slash"}"></i>`;const l=s.firstChild;l?l.parentNode.insertBefore(i,l):s.insertBefore(i,s.firstChild),r.log("addSidebarControls",[l,i]),i.addEventListener("click",n=>{n.stopPropagation(),n.preventDefault(),V.toggle()})}static updateRollRequestsIcon(e){const t=document.querySelector("#flash-rolls-icon i");t&&(t.className=`fas fa-bolt${e?"":"-slash"}`)}}const{ApplicationV2:Xt,HandlebarsApplicationMixin:Jt}=foundry.applications.api;class tt extends Jt(Xt){constructor(e={}){super(e),this.formula=e.formula||"",this.readonly=e.readonly||!1,this.actor=e.actor,this.callback=e.callback,this.diceCounts={}}static get DEFAULT_OPTIONS(){return foundry.utils.mergeObject(super.DEFAULT_OPTIONS,{classes:["flash5e-dialog","flash5e-custom-roll-dialog"],tag:"div",window:{title:"FLASH_ROLLS.ui.dialogs.customRollTitle",icon:"fas fa-dice-d20",resizable:!1,positioned:!0,frame:!0},position:{width:420,height:"auto"}})}get id(){var e;return`flash5e-custom-roll-dialog-${((e=this.actor)==null?void 0:e.id)||"unknown"}`}get title(){const e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.customRollTitle");return this.actor?`${e} - ${this.actor.name}`:e}_onClickAction(e,t){switch(t.dataset.action){case"rollDice":return this.rollDice(e,t);case"addDie":return this.addDie(e,t);case"cancel":return this.cancel(e,t)}}async _prepareContext(e={}){return{...await super._prepareContext(e),formula:this.formula,readonly:this.readonly}}_attachPartListeners(e,t,s){super._attachPartListeners(e,t,s);const o=t.querySelector("#custom-roll-formula"),a=t.querySelector("#formula-validation-message");o&&!this.readonly&&(o.addEventListener("input",i=>{this.formula=i.target.value.trim(),this.updateValidationMessage(a)}),this.formula&&this.updateValidationMessage(a))}updateValidationMessage(e){if(!e)return;if(!this.formula){e.textContent="&nbsp;",e.classList.remove("error","success");return}this.validateFormula(this.formula)?(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaValid"),e.classList.remove("error"),e.classList.add("success")):(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaInvalid"),e.classList.remove("success"),e.classList.add("error"))}addDie(e,t){const s=t.dataset.die,o=this.element.querySelector("#custom-roll-formula");if(!o)return;const a=o.value.trim();if(a){const i=/(\d*)d(\d+)/g,l=new Map;let n=a,c;for(;(c=i.exec(a))!==null;){const f=parseInt(c[1]||"1"),p=c[2];l.set(p,(l.get(p)||0)+f),n=n.replace(c[0],"").trim()}const d=s.substring(1);l.set(d,(l.get(d)||0)+1);const u=[];for(const[f,p]of l)u.push(`${p}d${f}`);n=n.replace(/^\+\s*|\s*\+\s*$|\s*\+\s*\+/g,"").trim(),n&&n!=="+"?this.formula=`${u.join(" + ")} + ${n}`:this.formula=u.join(" + ")}else this.formula=`1${s}`;o.value=this.formula,o.dispatchEvent(new Event("input"))}validateFormula(e){var t;if(!e||e.trim()==="")return!1;try{return Roll.validate(e)}catch{try{return new Roll(e,((t=this.actor)==null?void 0:t.getRollData())||{}),!0}catch{return!1}}}async rollDice(){if(r.log("rollDice"),!this.validateFormula(this.formula)){ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.invalidFormula",{formula:this.formula||"empty"}));return}this.callback&&await this.callback(this.formula),this.close()}cancel(){this.close()}static async prompt(e={}){return new Promise(t=>{const s=new this({...e,callback:o=>t(o)});s.addEventListener("close",()=>{s._resolved||t(null)}),s.render(!0)})}async close(e={}){return this._resolved=!0,super.close(e)}}w(tt,"PARTS",{main:{template:`modules/${W.ID}/templates/custom-roll-dialog.hbs`},footer:{template:`modules/${W.ID}/templates/custom-roll-dialog-footer.hbs`}});const ne=class ne{static async initialize(){r.log("ChatMessageManager.initialize"),await this.preloadTemplate()}static onCreateChatMessage(e,t,s,o){r.log("ChatMessageManager.onCreateChatMessage",[e,t,s,o])}static onPreCreateChatMessage(e,t,s,o){var a,i,l,n,c,d,u,f,p,m,h,S;if(r.log("ChatMessageManager.onPreCreateChatMessage",[e,t,s,o]),t._showRequestedBy&&((a=t.rolls)==null?void 0:a.length)>0){const R=t._requestedBy||"GM",T=game.i18n.format("FLASH_ROLLS.chat.requestedBy",{gm:R}),L=t.flavor||"";t.flavor=L?`${L} ${T}`:T}if((l=(i=t.flags)==null?void 0:i[b])!=null&&l.groupRollId&&r.log("ChatMessageManager.onPreCreateChatMessage - Found groupRollId in data flags",[t]),((n=t.rolls)==null?void 0:n.length)>0||(d=(c=t.flags)==null?void 0:c.core)!=null&&d.initiativeRoll){const R=t.speaker,T=R==null?void 0:R.actor;if(T){let L=game.actors.get(T);if(!L&&(R!=null&&R.token)){const k=canvas.tokens.get(R.token);k!=null&&k.actor&&(L=k.actor,r.log("ChatMessageManager.onPreCreateChatMessage - Using token actor from speaker",[L.name,L.id]))}if(!L){r.log("ChatMessageManager.onPreCreateChatMessage - No actor found",[T,R]);return}if(game.user.isGM){const k=L.isToken?(u=L.actor)==null?void 0:u.id:L.id,I=[T,k].filter(A=>A);for(const[A,M]of ne.pendingRolls.entries()){const _=M.actorEntries||(M.actors?M.actors.map(F=>({actorId:F})):[]);if(I.some(F=>_.some(q=>q.actorId===F))){t.flags=t.flags||{},t.flags[b]=t.flags[b]||{},t.flags[b].groupRollId=A,t.flags.rsr5e={processed:!0,quickRoll:!1},r.log("ChatMessageManager.onPreCreateChatMessage - Added groupRollId flag (GM)",[A,T]);break}}}else{let k=L.getFlag(b,"tempGroupRollId");if(!k&&L.isToken){const A=game.actors.get((f=L.actor)==null?void 0:f.id);A&&(k=A.getFlag(b,"tempGroupRollId"),r.log("ChatMessageManager.onPreCreateChatMessage - Checking base actor for tempGroupRollId",[A.id,k]))}if(k&&(L.unsetFlag(b,"tempGroupRollId"),L.isToken)){const A=game.actors.get((p=L.actor)==null?void 0:p.id);A&&A.unsetFlag(b,"tempGroupRollId")}let I=L.getFlag(b,"tempInitiativeConfig");if(!I&&L.isToken){const A=game.actors.get((m=L.actor)==null?void 0:m.id);A&&(I=A.getFlag(b,"tempInitiativeConfig"))}(I!=null&&I.groupRollId||k)&&(t.flags=t.flags||{},t.flags[b]=t.flags[b]||{},t.flags[b].groupRollId=k||(I==null?void 0:I.groupRollId)||"",t.flags.rsr5e={processed:!0,quickRoll:!1})}}}if(((h=t.rolls)==null?void 0:h.length)>0&&t.rolls[0])try{const R=t.rolls[0];(S=R.options)!=null&&S._customFlavor&&(t.flavor=R.options._customFlavor)}catch(R){r.error("ChatMessageManager.onPreCreateChatMessage - flavor error",[R])}}static onRenderChatMessage(e,t,s){var o,a,i,l,n,c,d,u,f;if(r.log("ChatMessageManager.onRenderChatMessage #0",[e,t,s]),ne.interceptRollMessage(e,t,s),e.getFlag(b,"isGroupRoll")){const p=E(),m=C.get(p.groupRollNPCHidden.tag),h=e.getFlag(b,"npcHiddenOverride"),S=game.user.isGM;if((h!==void 0?h:m)&&!S){const T=e.getFlag(b,"rollData");T&&T.results&&t.querySelectorAll(".actor-result").forEach((k,I)=>{const A=T.results[I];if(A){const M=game.actors.get(A.actorId);M&&!M.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER)&&k.classList.add("npc-hidden")}})}ne._attachGroupRollListeners(t,e)}if(this._addSelectTargetsButton(e,t),game.user.isGM){let p=(o=s.subject)==null?void 0:o.item;!p&&((l=(i=(a=e.flags)==null?void 0:a.dnd5e)==null?void 0:i.item)!=null&&l.uuid)&&(p=fromUuidSync(e.flags.dnd5e.item.uuid)),p&&setTimeout(()=>{ae.activityConfigCache.delete(p.id),r.log("ChatMessageManager.onRenderChatMessage - cleared activity config cache",[p.id])},1e3)}if(!game.user.isGM&&(((c=(n=e.flags)==null?void 0:n[b])==null?void 0:c.isFlashRollRequest)||((u=(d=e.flags)==null?void 0:d[b])==null?void 0:u.groupRollId)||((f=e.getFlag("dnd5e","roll"))==null?void 0:f._requestedBy))){const m=game.settings.get("dnd5e","challengeVisibility");let h=!0;switch(m){case"none":h=!1;break;case"all":h=!0;break;case"player":h=e.author.id===game.user.id||!e.author.isGM;break;default:h=!0;break}h===!1&&setTimeout(()=>{t.querySelectorAll("[data-display-challenge]").forEach(T=>delete T.dataset.displayChallenge);const R=t.querySelectorAll(".success, .failure, .critical, .fumble");R==null||R.forEach(T=>{T.classList.remove("success","failure","critical","fumble")}),R==null||R.forEach(T=>{var L;return(L=T.querySelector(".icons"))==null?void 0:L.remove()}),t.querySelectorAll(".save-dc, .dc, .target-dc").forEach(T=>{const L=T.textContent;L&&L.includes("DC")&&(T.textContent=L.replace(/DC\s*\d+/gi,""))})},50)}return!1}static onRenderChatLog(e,t){t.querySelectorAll(".flash5e-group-roll").forEach(a=>{const i=a.closest(".chat-message");if(i){const l=i.dataset.messageId,n=game.messages.get(l);if(n&&n.getFlag(b,"isGroupRoll")){const c=E(),d=C.get(c.groupRollNPCHidden.tag),u=n.getFlag(b,"npcHiddenOverride"),f=game.user.isGM;if((u!==void 0?u:d)&&!f){const m=n.getFlag(b,"rollData");m&&m.results&&a.querySelectorAll(".actor-result").forEach((S,R)=>{const T=m.results[R];if(T){const L=game.actors.get(T.actorId);L&&!L.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER)&&S.classList.add("npc-hidden")}})}ne._attachGroupRollListeners(a,n)}}}),t.querySelectorAll(".chat-message").forEach(a=>{var n,c,d,u,f,p;const i=a.dataset.messageId,l=game.messages.get(i);if(((d=(c=(n=l==null?void 0:l.flags)==null?void 0:n.dnd5e)==null?void 0:c.roll)==null?void 0:d.type)==="damage"&&((p=(f=(u=l.flags)==null?void 0:u.dnd5e)==null?void 0:f.item)!=null&&p.uuid)){const m=l.flags.dnd5e.item.uuid,h=fromUuidSync(m);if(h&&!ae.templateRemovalTimers.has(m)){r.log("ChatMessageManager.onRenderChatLog - scheduling template removal for rendered damage message",[h.name,m]),ae.templateRemovalTimers.add(m);const S=E(),T=C.get(S.templateRemovalTimeout.tag)*1e3;setTimeout(()=>{D.removeTemplateForItem(h),ae.templateRemovalTimers.delete(m)},T)}}})}static _addSelectTargetsButton(e,t){var o,a,i;if(!game.user.isGM||(r.log("ChatMessageManager._addSelectTargetsButton #0",[e,t,t.querySelector(".message-content")]),((i=(a=(o=e.flags)==null?void 0:o.dnd5e)==null?void 0:a.roll)==null?void 0:i.type)!=="damage"||t.querySelector(".select-targeted")))return;const s=document.createElement("button");s.className="select-targeted",s.type="button",s.setAttribute("data-tooltip-direction","LEFT"),s.setAttribute("data-tooltip","Select Targeted"),s.innerHTML='<i class="fas fa-crosshairs"></i>',s.addEventListener("click",l=>{l.preventDefault(),this._selectTargetedTokens(l)}),t.querySelector(".message-content").appendChild(s),e.update({content:t})}static _selectTargetedTokens(e){const s=e.currentTarget.closest(".chat-message").querySelectorAll("[data-target-uuid]");if(s.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noTargetedTokens"));return}for(let o=0;o<s.length;o++){const i=s[o].dataset.targetUuid.split("Actor.")[1];canvas.tokens.placeables.filter(n=>{var c,d;return((c=n.document.actor)==null?void 0:c.id)===i||((d=n.document.baseActor)==null?void 0:d.id)===i}).forEach((n,c)=>{n&&n.control&&n.control({releaseOthers:o===0})})}}static _attachGroupRollListeners(e,t){e.querySelectorAll(".actor-result").forEach(a=>{a.addEventListener("click",i=>{if(i.target.closest(".dice-btn.rollable"))return;i.preventDefault(),i.stopPropagation();const l=a;r.log("actor-result click",[a]),l.classList.contains("expanded")?l.classList.remove("expanded"):l.classList.add("expanded")})}),e.querySelectorAll(".dice-btn.rollable").forEach(a=>{a.addEventListener("click",async i=>{var L;i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();const l=a.dataset,n=l.actorId,c=game.actors.get(n);if(!c){ui.notifications.warn("Actor not found");return}if(!(game.user.isGM||c.isOwner)){ui.notifications.warn(`You don't have permission to roll for ${c.name}`);return}const u=(L=l.type)==null?void 0:L.toLowerCase(),f=l.rollKey,p=l.groupRollId,m=l.dc?parseInt(l.dc):null;r.log("Rollable dice clicked",[u,f,n,p]);const h={rollKey:f,groupRollId:p,config:{advantage:!1,disadvantage:!1,target:m,rollMode:game.settings.get("core","rollMode")}},S={configure:!0,isRollRequest:!0},R={rollMode:game.settings.get("core","rollMode"),create:!0,isRollRequest:!0},T={parts:[],data:{},options:{}};try{const k=se[u];if(k)await k(c,h,T,S,R);else{let I;switch(u){case y.SKILL:I="rollSkill";break;case y.ABILITY:case y.ABILITY_CHECK:I="rollAbilityTest";break;case y.SAVE:case y.SAVING_THROW:I="rollAbilitySave";break;case y.TOOL:I="rollToolCheck";break;default:ui.notifications.warn(`Unknown roll type: ${u}`);return}I&&c[I]&&await c[I](f,{...h.config,messageOptions:{"flags.flash-rolls-5e.groupRollId":p}})}}catch(k){r.error("Error executing roll from chat",k),ui.notifications.error(`Failed to execute roll: ${k.message}`)}})});const s=e.querySelector(".group-roll-dc-control"),o=e.querySelector(".dc-input");if(s){const a=s.dataset.showToPlayers==="true";if(game.user.isGM||(s.style.display="none"),!game.user.isGM&&!a){const i=e.querySelector(".group-roll-footer .group-result-details");i&&(i.style.display="none")}}if(o)if(!game.user.isGM)o.readOnly=!0,o.style.cursor="not-allowed";else{let a=null;const i=async()=>{const l=parseInt(o.value);if(!o.value)return;if(isNaN(l)||l<1||l>99){o.value="";return}const n=o.dataset.messageId,c=game.messages.get(n);c&&await ne.updateGroupRollDC(c,l)};o.addEventListener("input",l=>{a&&clearTimeout(a),a=setTimeout(()=>{i()},750)}),o.addEventListener("keypress",l=>{l.key==="Enter"&&(a&&clearTimeout(a),i())})}}static async preloadTemplate(){r.log("ChatMessageManager.preloadTemplate");try{await D.loadTemplates([this.templatePath])}catch(e){r.error("Failed to preload template",e)}}static async createGroupRollMessage(e,t,s,o,a){r.log("ChatMessageManager.createGroupRollMessage",[e.length,t,s,a]);const i=this.buildGroupRollData(e,t,s,o);if(!i)return r.error("createGroupRollMessage - Failed to build group roll data"),null;i.groupRollId=a;const l=e.filter(u=>u&&u.actor),c=l.some(u=>v.isPlayerOwnerActive(u.actor))?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode");return this.pendingRolls.set(a,{actorEntries:l.map(u=>({actorId:u.actor.id,uniqueId:u.uniqueId,tokenId:u.tokenId})),rollType:t,rollKey:s,config:o,results:new Map}),await this.postGroupMessage(i,c)}static buildGroupRollData(e,t,s,o){const a=e.filter(m=>m&&m.actor);if(a.length===0)return r.error("buildGroupRollData - No valid actor entries found",[e]),null;let i=this._buildFlavorText(t,s,o);const l=(o==null?void 0:o.dc)||(o==null?void 0:o.target),n=a.map(m=>{var h,S,R,T;return{actorId:m.actor.id,uniqueId:m.uniqueId,tokenId:m.tokenId,actorImg:m.actor.img||((S=(h=m.actor.prototypeToken)==null?void 0:h.texture)==null?void 0:S.src)||"icons/svg/mystery-man.svg",actorName:m.tokenId&&((T=(R=canvas.tokens)==null?void 0:R.get(m.tokenId))==null?void 0:T.name)||m.actor.name,isNPC:!m.actor.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER),rolled:!1,showDice:!0,total:null,success:!1,failure:!1}}),c=v.shouldShowDC(t),d=E(),u=C.get(d.showGroupDCToPlayers.tag),f=C.get(d.groupRollNPCHidden.tag),p=game.user.isGM;return n.forEach(m=>{m.shouldHide=m.isNPC&&f&&!p}),{flavor:i,results:n,showDC:l!=null,dc:l,rollType:t,rollKey:s,supportsDC:c,showDCToPlayers:u,groupRollNPCHidden:f,isGM:p,actorEntries:a.map(m=>({actorId:m.actor.id,uniqueId:m.uniqueId,tokenId:m.tokenId})),moduleId:b}}static _buildFlavorText(e,t,s){var a,i,l,n,c,d,u,f;let o="";switch(e==null?void 0:e.toLowerCase()){case y.ABILITY:case y.ABILITY_CHECK:const p=((a=CONFIG.DND5E.abilities[t])==null?void 0:a.label)||t;o=game.i18n.format("DND5E.AbilityPromptTitle",{ability:p});break;case y.SAVE:case y.SAVING_THROW:const m=((i=CONFIG.DND5E.abilities[t])==null?void 0:i.label)||t;o=game.i18n.format("DND5E.SavePromptTitle",{ability:m});break;case y.SKILL:const h=((l=CONFIG.DND5E.skills[t])==null?void 0:l.label)||t,S=(s==null?void 0:s.ability)||((n=CONFIG.DND5E.skills[t])==null?void 0:n.ability)||"int",R=((c=CONFIG.DND5E.abilities[S])==null?void 0:c.label)||S;r.log("buildFlavorText - skill",[s==null?void 0:s.ability,h,S,R]),o=game.i18n.format("DND5E.SkillPromptTitle",{skill:h,ability:R});break;case y.TOOL:const T=(u=(d=CONFIG.DND5E.enrichmentLookup)==null?void 0:d.tools)==null?void 0:u[t];let L=t;if(T!=null&&T.id){const A=dnd5e.documents.Trait.getBaseItem(T.id,{indexOnly:!0});L=(A==null?void 0:A.name)||t}const k=(s==null?void 0:s.ability)||(T==null?void 0:T.ability)||"int",I=((f=CONFIG.DND5E.abilities[k])==null?void 0:f.label)||k;o=game.i18n.format("DND5E.ToolPromptTitle",{tool:L,ability:I});break;case y.CONCENTRATION:o=game.i18n.localize("DND5E.Concentration")||"Concentration";break;case y.DEATH_SAVE:o=game.i18n.localize("DND5E.DeathSave")||"Death Saving Throw";break;case y.HIT_DIE:case"hitdice":o=game.i18n.localize("DND5E.HitDice")||"Hit Dice";break;case y.HEALING:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Healing")||"Healing";break;case y.CUSTOM:o=(s==null?void 0:s.flavor)||t||game.i18n.localize("DND5E.Roll")||"Custom Roll";break;case y.FORMULA:o=(s==null?void 0:s.flavor)||t||game.i18n.localize("DND5E.Roll")||"Custom Formula";break;case y.ITEM_SAVE:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.SavingThrow")||"Saving Throw";break;case y.INITIATIVE:o=game.i18n.localize("DND5E.Initiative");break;case y.ATTACK:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Attack")||"Attack Roll";break;case y.DAMAGE:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Damage")||"Damage Roll";break;default:o=(s==null?void 0:s.flavor)||"Roll"}return o}static async postGroupMessage(e,t=null){r.log("postGroupMessage - groupRollId",[e.groupRollId,t]);try{const o={content:await D.renderTemplate(this.templatePath,e),speaker:{alias:"Group Roll"},flags:{[b]:{isGroupRoll:!0,groupRollId:e.groupRollId,rollData:e},rsr5e:{processed:!0,quickRoll:!1}}};t&&ChatMessage.applyRollMode(o,t);const a=await ChatMessage.create(o);return this.groupRollMessages.set(e.groupRollId,a),a}catch(s){return r.error("Failed to post group message",s),null}}static async updateGroupRollMessage(e,t,s){if(game.user.isGM)return r.log("ChatMessageManager.updateGroupRollMessage #0",[e,t,s]),await this._performGroupRollUpdate(e,t,s)}static async _performGroupRollUpdate(e,t,s){var d,u,f,p,m,h;let o=this.groupRollMessages.get(e),a=this.pendingRolls.get(e);if(!o&&(o=game.messages.contents.find(R=>R.getFlag(b,"groupRollId")===e&&R.getFlag(b,"isGroupRoll")),o&&(this.groupRollMessages.set(e,o),r.log("_performGroupRollUpdate - Found and registered group message",[e]),!a))){const R=o.getFlag(b,"rollData");a={actorEntries:R.actorEntries||R.results.map(T=>({actorId:T.actorId,uniqueId:T.uniqueId,tokenId:T.tokenId})),results:new Map},this.pendingRolls.set(e,a)}if(!o){r.log("No group message found for groupRollId",e);return}a&&a.results&&a.results.set(t,{total:s.total,roll:s});const i=o.getFlag(b,"rollData");r.log("_performGroupRollUpdate - Searching for uniqueId",[t,"in results:",i.results.map(S=>({uniqueId:S.uniqueId,actorId:S.actorId,tokenId:S.tokenId}))]);let l=i.results.findIndex(S=>S.uniqueId===t);if(l===-1){if(l=i.results.findIndex(S=>S.actorId===t),l===-1&&(l=i.results.findIndex(S=>S.tokenId===t)),l===-1&&((d=o.speaker)!=null&&d.actor)){const S=o.speaker.actor;l=i.results.findIndex(R=>R.actorId===S)}if(l===-1){const S=((u=canvas.tokens)==null?void 0:u.get(t))||((p=(f=game.scenes.active)==null?void 0:f.tokens)==null?void 0:p.get(t));if(S&&S.actor){const R=S.actor.id;r.log("_performGroupRollUpdate - Trying token actor match",[t,"token actor:",R]),l=i.results.findIndex(T=>T.actorId===R||T.uniqueId===R)}}}if(l!==-1){i.results[l].rolled=!0,i.results[l].showDice=!1,i.results[l].total=s.total;try{let S=await s.render();i.results[l].rollBreakdown=S}catch(S){r.error("Error rendering roll breakdown",[S]),i.results[l].rollBreakdown=null}i.showDC&&i.dc&&(i.results[l].success=s.total>=i.dc,i.results[l].failure=s.total<i.dc)}else{r.error("Group message id not found");return}i.allRolled=i.results.every(S=>S.rolled),i.messageId=o.id,i.supportsDC=v.shouldShowDC(i.rollType);const n=E();if(i.showDCToPlayers=C.get(n.showGroupDCToPlayers.tag),i.groupRollNPCHidden=C.get(n.groupRollNPCHidden.tag),i.isGM=game.user.isGM,i.results&&i.results.forEach(S=>{if(S.isNPC===void 0){const R=game.actors.get(S.actorId);S.isNPC=R?!R.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER):!1}S.shouldHide=S.isNPC&&i.groupRollNPCHidden&&!i.isGM}),i.supportsDC&&i.showDC&&i.dc){const S=((m=i.actorEntries)==null?void 0:m.map(T=>game.actors.get(T.actorId)).filter(T=>T))||((h=i.actors)==null?void 0:h.map(T=>game.actors.get(T)).filter(T=>T))||[],R=v.getGroupResult(i.results,i.dc,S,i.rollType,i.rollKey);i.groupResult=R,r.log("updateGroupRollMessage - COMPLETE?",[R.complete]),R.complete&&R.details&&(i.groupSummary=R.details.summary)}const c=await D.renderTemplate(this.templatePath,i);await o.update({content:c,flags:{[b]:{rollData:i}}}),a!=null&&a.results&&(a!=null&&a.actorEntries)&&a.results.size===a.actorEntries.length&&(this.pendingRolls.delete(e),setTimeout(()=>{this.groupRollMessages.delete(e),this.updateQueue.delete(e)},6e4))}static async updateGroupRollDC(e,t){var n,c;const s=e.getFlag(b,"rollData");if(!s||(s.supportsDC=v.shouldShowDC(s.rollType),!s.supportsDC))return;s.dc=t,s.showDC=!0,s.results.forEach(d=>{d.rolled&&d.total!==null&&(d.success=d.total>=t,d.failure=d.total<t)});const o=((n=s.actorEntries)==null?void 0:n.map(d=>game.actors.get(d.actorId)).filter(d=>d))||((c=s.actors)==null?void 0:c.map(d=>game.actors.get(d)).filter(d=>d))||[],a=v.getGroupResult(s.results,t,o,s.rollType,s.rollKey);s.groupResult=a,a.complete&&a.details&&(s.groupSummary=a.details.summary),s.allRolled=s.results.every(d=>d.rolled),s.messageId=e.id;const i=E();s.showDCToPlayers=C.get(i.showGroupDCToPlayers.tag),s.groupRollNPCHidden=C.get(i.groupRollNPCHidden.tag),s.isGM=game.user.isGM,s.results&&s.results.forEach(d=>{if(d.isNPC===void 0){const u=game.actors.get(d.actorId);d.isNPC=u?!u.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER):!1}d.shouldHide=d.isNPC&&s.groupRollNPCHidden&&!s.isGM});const l=await D.renderTemplate(this.templatePath,s);await e.update({content:l,flags:{[b]:{rollData:s}}})}static interceptRollMessage(e,t,s){var f,p,m,h,S,R,T;const o=E();if(!C.get(o.groupRollsMsgEnabled.tag))return;const i=(f=e.speaker)==null?void 0:f.actor,l=(p=e.speaker)==null?void 0:p.token;let n;if(l){const L=((m=canvas.tokens)==null?void 0:m.get(l))||((S=(h=game.scenes.active)==null?void 0:h.tokens)==null?void 0:S.get(l));n=L==null?void 0:L.actor}if(n||(n=game.actors.get(i)),!n)return;const c=l||i,d=e.getFlag(b,"groupRollId")||((R=n.getFlag(b,"tempInitiativeConfig"))==null?void 0:R.groupRollId);if(!d){r.log("interceptRollMessage #2 - no groupRollId in flag",[n.name]);return}if(!game.user.isGM&&!this.groupRollMessages.has(d)){const k=game.messages.contents.find(I=>I.getFlag(b,"groupRollId")===d&&I.getFlag(b,"isGroupRoll"));k&&(this.groupRollMessages.set(d,k),r.log("interceptRollMessage - Registered group roll message",[n.name,d]))}if(!this.groupRollMessages.has(d)){const k=game.messages.contents.find(I=>I.getFlag(b,"groupRollId")===d&&I.getFlag(b,"isGroupRoll"));if(k)r.log("interceptRollMessage - Found group message in chat log, registering",[d]),this.groupRollMessages.set(d,k);else{r.log("interceptRollMessage - No group message found in chat log either",[d]);return}}const u=(T=e.rolls)==null?void 0:T[0];if(u)if(t&&t instanceof HTMLElement&&t.style&&(t.style.display="none"),game.user.isGM){r.log("interceptRollMessage - Updating group message",[d,c,n.name,u.total]),this.updateGroupRollMessage(d,c,u);const L=e.id;if(this.messagesScheduledForDeletion.has(L))return;this.messagesScheduledForDeletion.add(L),L&&setTimeout(async()=>{r.log("interceptRollMessage - deletion",[L]);try{game.messages.get(L)?(await e.delete(),r.log("interceptRollMessage - Deleted individual message",[L])):r.log("interceptRollMessage - Message already deleted",[L])}catch(k){r.log("interceptRollMessage - Error deleting message",[L,k.message])}finally{this.messagesScheduledForDeletion.delete(L)}},500)}else r.log("interceptRollMessage - Player roll intercepted, GM will handle update",[d])}static isGroupRoll(e){return this.pendingRolls.has(e)||this.groupRollMessages.has(e)}static async addGroupRollFlag(e,t,s=null){const o=E(),a=C.get(o.groupRollsMsgEnabled.tag);if(r.log("addGroupRollFlag called",[e,t.groupRollId,this.isGroupRoll(t.groupRollId)]),!game.user.isGM&&t.groupRollId&&s&&(await s.setFlag(b,"tempGroupRollId",t.groupRollId),s.isToken&&s.actor&&(await s.actor.setFlag(b,"tempGroupRollId",t.groupRollId),r.log("addGroupRollFlag - Also stored tempGroupRollId on base actor for player",[t.groupRollId,s.actor.id])),!this.groupRollMessages.has(t.groupRollId))){const l=game.messages.contents.find(n=>n.getFlag(b,"groupRollId")===t.groupRollId&&n.getFlag(b,"isGroupRoll"));l&&(this.groupRollMessages.set(t.groupRollId,l),r.log("addGroupRollFlag - Registered group roll message on player side",[t.groupRollId]))}a&&t.groupRollId&&(!game.user.isGM||this.isGroupRoll(t.groupRollId))&&(e.data=e.data||{},e.data.flags=e.data.flags||{},e.data.flags[b]=e.data.flags[b]||{},e.data.flags[b].groupRollId=t.groupRollId,e.data.flags.rsr5e={processed:!0,quickRoll:!1},r.log("addGroupRollFlag - Added flag to messageConfig",[e]))}static cleanup(){const e=Date.now()-3e5;for(const[t,s]of this.groupRollMessages.entries())s.timestamp<e&&(this.groupRollMessages.delete(t),this.pendingRolls.delete(t))}};w(ne,"groupRollMessages",new Map),w(ne,"pendingRolls",new Map),w(ne,"messagesScheduledForDeletion",new Set),w(ne,"updateQueue",new Map),w(ne,"templatePath","modules/flash-rolls-5e/templates/chat-msg-group-roll.hbs");let B=ne;const se={ability:async(g,e,t,s,o)=>{const a=v.buildRollConfig(e,t,{ability:e.rollKey});await B.addGroupRollFlag(o,e,g),await g.rollAbilityCheck(a,s,o)},abilitycheck:async(g,e,t,s,o)=>se.ability(g,e,t,s,o),save:async(g,e,t,s,o)=>{var i;const a=v.buildRollConfig(e,t,{ability:((i=e.config)==null?void 0:i.ability)||e.rollKey});await B.addGroupRollFlag(o,e,g),await g.rollSavingThrow(a,s,o)},savingthrow:async(g,e,t,s,o)=>se.save(g,e,t,s,o),skill:async(g,e,t,s,o)=>{var l,n,c,d;const a=((n=(l=g.system.skills)==null?void 0:l[e.rollKey])==null?void 0:n.ability)||((d=(c=CONFIG.DND5E.skills)==null?void 0:c[e.rollKey])==null?void 0:d.ability)||void 0,i=v.buildRollConfig(e,t,{skill:e.rollKey,chooseAbility:s.configure!==!1,ability:e.config.ability||a});await B.addGroupRollFlag(o,e,g),await g.rollSkill(i,s,o)},tool:async(g,e,t,s,o)=>{var n,c,d,u;const a=(n=g.system.tools)==null?void 0:n[e.rollKey],i=(a==null?void 0:a.ability)||((u=(d=(c=CONFIG.DND5E.enrichmentLookup)==null?void 0:c.tools)==null?void 0:d[e.rollKey])==null?void 0:u.ability)||"int",l=v.buildRollConfig(e,t,{tool:e.rollKey,chooseAbility:s.configure!==!1,ability:e.config.ability||i});r.log("RollHandlers.tool #2",[l,s,o]),await B.addGroupRollFlag(o,e,g),await g.rollToolCheck(l,s,o)},concentration:async(g,e,t,s,o)=>{const a=v.buildRollConfig(e,t);await B.addGroupRollFlag(o,e,g),await g.rollConcentration(a,s,o)},attack:async(g,e,t,s,o)=>{await se.handleActivityRoll(g,y.ATTACK,e,t,s,o)},damage:async(g,e,t,s,o)=>{await se.handleActivityRoll(g,y.DAMAGE,e,t,s,o)},itemsave:async(g,e,t,s,o)=>{await se.handleActivityRoll(g,y.ITEM_SAVE,e,t,s,o)},initiative:async(g,e,t,s,o)=>{var i,l,n;if(!game.combat){ui.notifications.warn(game.i18n.localize("COMBAT.NoneActive"));return}e.config.situational||(i=t.data)!=null&&i.situational,e.groupRollId;let a=g;if(!g.isToken){const c=canvas.tokens.placeables.find(d=>{var u;return((u=d.actor)==null?void 0:u.id)===g.id});if(c)a=c.actor;else{ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.noTokensForInitiative"));return}}await B.addGroupRollFlag(o,e,g);try{if(s.configure){if(r.log("RollHandlers.initiative - Dialog",[]),e.config){const c=v.buildRollConfig(e,t,{ability:((n=(l=g.system.attributes)==null?void 0:l.init)==null?void 0:n.ability)||"dex"}),d={advantage:e.config.advantage||!1,disadvantage:e.config.disadvantage||!1,rollMode:e.config.rollMode||game.settings.get("core","rollMode"),rolls:c.rolls,groupRollId:e.groupRollId};await g.setFlag(b,"tempInitiativeConfig",d),await a.setFlag(b,"tempInitiativeConfig",d)}await a.rollInitiativeDialog(),await a.unsetFlag(b,"tempInitiativeConfig"),await g.unsetFlag(b,"tempInitiativeConfig")}else{const c={rollMode:e.config.rollMode||game.settings.get("core","rollMode"),groupRollId:e.groupRollId};await g.setFlag(b,"tempInitiativeConfig",c),await a.setFlag(b,"tempInitiativeConfig",c);const d={createCombatants:!0,rerollInitiative:!0};await a.rollInitiative(d),await a.unsetFlag(b,"tempInitiativeConfig"),await g.unsetFlag(b,"tempInitiativeConfig")}}catch(c){r.error("RollHandlers.initiative - Error",[c]),X.notify("error",`Initiative roll failed: ${c.message}`)}},initiativedialog:async(g,e,t,s,o)=>se.initiative(g,e,t,s,o),deathsave:async(g,e,t,s,o)=>{const a=v.buildRollConfig(e,t);await B.addGroupRollFlag(o,e,g),await g.rollDeathSave(a,s,o)},hitdie:async(g,e,t,s,o)=>{s.configure=game.user.isGM?s.configure:!0;const a=v.buildRollConfig(e,t,{denomination:e.rollKey});r.log("RollHandlers.hitdie",[a,s,o]),await B.addGroupRollFlag(o,e,g),await g.rollHitDie(a,s,o)},custom:async(g,e,t,s,o)=>{await se.handleCustomRoll(g,e,s,o)},async handleActivityRoll(g,e,t,s,o,a){var i,l;if(r.log("RollHandlers.handleActivityRoll",[e,t,s]),t.rollKey){const n=v.buildRollConfig(t,s),c=((l=(i=n.rolls)==null?void 0:i[0])==null?void 0:l.options)||{},d={usage:{...t.config,rolls:n.rolls,...c.attackMode&&{attackMode:c.attackMode},...c.ammunition&&{ammunition:c.ammunition},...c.mastery!==void 0&&{mastery:c.mastery},...t.config.spell&&{spell:t.config.spell},...t.config.scaling!==void 0&&{scaling:t.config.scaling},...t.config.consume&&{consume:t.config.consume},...t.config.create&&{create:t.config.create}},dialog:{...o,configure:game.user.isGM&&t.config.skipRollDialog!==void 0?!t.config.skipRollDialog:o.configure},message:a};r.log("handleActivityRoll - final activity config",[d]),await Re.executeActivityRoll(g,e,t.rollKey,t.activityId,d)}},async handleCustomRoll(g,e,t,s){var i,l,n,c;const o=e.rollKey;if((t==null?void 0:t.configure)===!1){try{const d=new Roll(o,g.getRollData());d.options=d.options||{},d.options.isRollRequest=((i=e.config)==null?void 0:i.isRollRequest)!==!1,await d.evaluate(),await B.addGroupRollFlag(s,e,g),await d.toMessage({speaker:ChatMessage.getSpeaker({actor:g}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${y.CUSTOM}`),rollMode:(s==null?void 0:s.rollMode)||((l=e.config)==null?void 0:l.rollMode)||game.settings.get("core","rollMode"),isRollRequest:((n=e.config)==null?void 0:n.isRollRequest)!==!1,create:(s==null?void 0:s.create)!==!1,flags:(c=s==null?void 0:s.data)==null?void 0:c.flags})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:o}))}return}new tt({formula:o,readonly:!0,actor:g,callback:async d=>{var u;try{const f=new Roll(d,g.getRollData());f.options=f.options||{},f.options.isRollRequest=!0,await f.evaluate(),await B.addGroupRollFlag(s,e,g),await f.toMessage({speaker:ChatMessage.getSpeaker({actor:g}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${y.CUSTOM}`),rollMode:e.config.rollMode,isRollRequest:!0,_showRequestedBy:!0,_requestedBy:e.config.requestedBy||"GM",flags:(u=s==null?void 0:s.data)==null?void 0:u.flags})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:d}))}}}).render(!0)},async handleHitDieRecovery(g){const e=foundry.utils.mergeObject({type:"long",deltas:{hitDice:0},newDay:!1,rolls:[],updateData:{},updateItems:[]},{});"dhd"in e&&(e.deltas.hitDice=e.dhd),g._getRestHitDiceRecovery({maxHitDice:g.system.attributes.hd.max,type:"long"},e),e.dhd=e.deltas.hitDice,e.longRest=!0;try{if(e.updateData&&Object.keys(e.updateData).length>0){const t=await g.update(e.updateData,{isRest:!1})}else r.log("No actor updates to perform",[]);if(e.updateItems&&e.updateItems.length>0){const t=await g.updateEmbeddedDocuments("Item",e.updateItems,{isRest:!1})}else r.log("No item updates to perform",[])}catch(t){throw r.error("Error during updates in handleHitDieRecovery:",[t]),t}return r.log("handleHitDieRecovery #3",[e]),e}};async function vt(){return game.combat||(await(await Combat.create({scene:game.scenes.active.id})).activate(),X.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.combatCreated"))),game.combat}async function _t(g,e){if(!e.combat)return g;const t=g.map(a=>e.actors.get(a)).filter(a=>a),s=[],o=new Set;for(const a of t)e.combat.getCombatantsByActor(a.id).some(n=>n.initiative!==null)&&(s.push(a.name),o.add(a.id));if(r.log("filterActorsForInitiative",[s]),s.length>0)if(await foundry.applications.api.DialogV2.confirm({window:{title:e.i18n.localize("FLASH_ROLLS.ui.dialogs.rerollInitiativeTitle"),classes:["flash5e-dialog"]},position:{width:420,height:"auto"},content:"<p>"+e.i18n.format("FLASH_ROLLS.ui.dialogs.rerollInitiative",{actors:s.join(", ")})+"</p>",rejectClose:!1,modal:!0})){if(e.user.isGM)for(const i of o){const l=e.combat.getCombatantsByActor(i);r.log("filterActorsForInitiative - resetting initiative for combatants",[l]);for(const n of l)await n.update({initiative:null})}else r.log("filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll");return g}else{const i=g.filter(l=>!o.has(l));return i.length===0&&X.notify("info",e.i18n.localize("FLASH_ROLLS.notifications.allActorsHaveInitiative")),i}return g}class ft{static getActorStats(e){var a,i,l,n,c,d;const t=e.system,s=[];(a=t.attributes)!=null&&a.hp&&s.push({abbrev:"HP",value:t.attributes.hp.value}),(i=t.attributes)!=null&&i.ac&&s.push({abbrev:"AC",value:t.attributes.ac.value});const o=(n=(l=t.attributes)==null?void 0:l.spell)==null?void 0:n.dc;return o&&s.push({abbrev:"DC",value:o}),(d=(c=t.skills)==null?void 0:c.prc)!=null&&d.passive&&s.push({abbrev:"PRC",value:t.skills.prc.passive}),s}static getActorHPData(e){var a;const t=(a=e.system.attributes)==null?void 0:a.hp;if(!t||!t.max)return{hpPercent:100,hpColor:"var(--fr5e-color-hp-high)"};const s=Math.round(t.value/t.max*100),o=s>50?"var(--fr5e-color-hp-high)":"var(--fr5e-color-hp-low)";return{hpPercent:s,hpColor:o}}static getValidActorIds(e,t){return e.filter(s=>{const o=game.actors.get(s);if(!o)return!1;const a=et(o),i=!a&&Et(o);return t==="pc"&&a||t==="npc"&&i})}}class st{static initialize(){r.log("RollInterceptor.initialize"),game.user.isGM&&this.registerHooks()}static registerHooks(){r.log("RollInterceptor.registerHooks"),this._registerHook(U.PRE_ROLL_ABILITY_CHECK,this._onPreRollIntercept.bind(this,y.ABILITY)),this._registerHook(U.PRE_ROLL_SAVING_THROW,this._onPreRollIntercept.bind(this,y.SAVE)),this._registerHook(U.PRE_ROLL_SKILL_V2,this._onPreRollIntercept.bind(this,y.SKILL)),this._registerHook(U.PRE_ROLL_TOOL_V2,this._onPreRollIntercept.bind(this,y.TOOL)),this._registerHook(U.PRE_ROLL_ATTACK_V2,this._onPreRollIntercept.bind(this,y.ATTACK)),this._registerHook(U.PRE_ROLL_DAMAGE_V2,this._onPreRollIntercept.bind(this,y.DAMAGE)),this._registerHook(U.PRE_ROLL_DEATH_SAVE_V2,this._onPreRollIntercept.bind(this,y.DEATH_SAVE)),this._registerHook(U.PRE_ROLL_HIT_DIE_V2,this._onPreRollIntercept.bind(this,y.HIT_DIE)),this._registerHook(U.PRE_ROLL_INITIATIVE,this._onPreRollInterceptInitiative.bind(this,y.INITIATIVE)),this._registerHook(U.PRE_ROLL_INITIATIVE_DIALOG,this._onPreRollInterceptInitiative.bind(this,y.INITIATIVE))}static _registerHook(e,t){r.log("RollInterceptor._registerHook");const s=Hooks.on(e,t);this.registeredHooks.add({hookName:e,hookId:s})}static unregisterHooks(){r.log("RollInterceptor.unregisterHooks");for(const{hookName:e,hookId:t}of this.registeredHooks)Hooks.off(e,t);this.registeredHooks.clear()}static _onPreRollInterceptInitiative(e,t,s){}static _onPreRollIntercept(e,t,s,o){var R,T,L,k,I,A,M;r.log("_onPreRollIntercept #0",[e,t,s,o]);const a=E(),i=C.get(a.rollRequestsEnabled.tag),l=C.get(a.rollInterceptionEnabled.tag),n=D.isModuleOn("midi-qol");let c;if(e===y.INITIATIVE&&t instanceof Actor){if(c=t,r.log("_onPreRollIntercept - Initiative",[t,s,o]),(s==null?void 0:s.isRollRequest)===!1||(o==null?void 0:o.isRollRequest)===!1)return}else e===y.HIT_DIE?c=((R=s==null?void 0:s.subject)==null?void 0:R.actor)||(s==null?void 0:s.subject)||(s==null?void 0:s.actor):e===y.ATTACK||e===y.DAMAGE?c=(T=t.subject)==null?void 0:T.actor:c=((L=t.subject)==null?void 0:L.actor)||t.subject||t.actor;const d=D.getActorOwner(c),u=(d==null?void 0:d.id)===game.user.id&&(d==null?void 0:d.active),f=D.areSkipKeysPressed(t.event),p=f||C.get(a.skipRollDialog.tag);if(!i||!l||t.isRollRequest===!1){s.configure=f||t.isRollRequest!==void 0?!1:!v.shouldSkipRollDialog(p,{isPC:u,isNPC:!u});return}if(r.log("_onPreRollIntercept #1",[i,l,t.isRollRequest]),!game.user.isGM||n&&(d!=null&&d.isGM||!(d!=null&&d.active)))return;const m=(t==null?void 0:t.hookNames)||(s==null?void 0:s.hookNames)||(o==null?void 0:o.hookNames)||[],h=m.includes("initiativeDialog")||m.includes("initiative");if(e===y.ATTACK||e===y.DAMAGE){const _=((I=(k=t.subject)==null?void 0:k.item)==null?void 0:I.getFlag(b,"tempAttackConfig"))||((M=(A=t.subject)==null?void 0:A.item)==null?void 0:M.getFlag(b,"tempDamageConfig"));if(s.configure=!1,r.log("_onPreRollIntercept - attack / damage - flag",[_]),_){r.log("_onPreRollIntercept - found module flags, skipping interception",[_]);return}}if(h&&e===y.ABILITY&&(r.log("RollInterceptor._onPreRollIntercept - Overriding ability to initiative",[m]),e=y.INITIATIVE),t!=null&&t.isRollRequest||t.sendRequest===!1||s!=null&&s.isRollRequest||o!=null&&o.isRollRequest){r.log("_onPreRollIntercept - skipping interception (roll request)",[t,s,o]);return}if(!l||!c||c.documentName!=="Actor")return;e===y.ATTACK&&(o={...o,rollMode:CONST.DICE_ROLL_MODES.PUBLIC});const S=n&&t.midiOptions;if(t.sendRequest===!1||t.skipRollDialog===!0){r.log("_onPreRollIntercept - skipping interception",[s.configure,t.sendRequest]);return}return S&&game.user.isGM?(r.log("_onPreRollIntercept - MidiActive",[t.midiOptions]),this._showGMConfigDialog(c,d,e,t,s,o),!1):(r.log("_onPreRollIntercept - intercepting roll #1",[t,o]),this._showGMConfigDialog(c,d,e,t,s,o),!1)}static async _handleInitiativePreChecks(e){return!game.combat&&!await vt()?!1:(await _t([e.id],game)).length>0}static _getDialogClass(e){const t=e==null?void 0:e.toLowerCase();return[y.SKILL,y.TOOL].includes(t)?Dt:t===y.HIT_DIE?Ot:t===y.ATTACK?es:t===y.DAMAGE?Zt:me}static _extractRollConfiguration(e,t,s,o){var n,c,d,u,f,p,m,h,S,R,T;const a=e==null?void 0:e.toLowerCase();let i=null;const l={rolls:[{parts:[],data:{},options:{}}]};switch(a){case y.SKILL:l.skill=t.skill,l.ability=t.ability||((n=t.subject)==null?void 0:n.ability),i=l.skill;break;case y.TOOL:l.tool=t.tool,l.ability=t.ability||((c=t.subject)==null?void 0:c.ability),i=l.tool;break;case y.ABILITY:case y.SAVE:l.ability=t.ability||((d=t.subject)==null?void 0:d.ability),i=l.ability,l.ability==="con"&&t.targetValue!==void 0&&(e=y.CONCENTRATION);break;case y.CONCENTRATION:l.ability="con",i="con";break;case y.INITIATIVE:case y.INITIATIVE_DIALOG:i=((f=(u=o.system.attributes)==null?void 0:u.init)==null?void 0:f.ability)||"dex";break;case y.HIT_DIE:l.denomination=typeof t=="string"?t:t.denomination||((p=t.subject)==null?void 0:p.denomination),i=l.denomination;break;case y.ATTACK:s!=null&&s.options&&(l.ammunition=s.options.ammunition,l.attackMode=s.options.attackMode,l.mastery=s.options.mastery),i=(h=(m=t.subject)==null?void 0:m.item)==null?void 0:h.id;break;case y.DAMAGE:l.item=(S=t.subject)==null?void 0:S.item,l.subject=t.subject,l.critical=t.critical||{},i=(T=(R=t.subject)==null?void 0:R.item)==null?void 0:T.id;break}return{rollKey:i,rollConfig:l}}static async _getDialogResult(e,t,s,o,a,i,l,n){const c=s==null?void 0:s.toLowerCase();if(r.log("_getDialogResult",[t,s,o,l,n]),a)return{sendRequest:!0,advantage:!1,disadvantage:!1,skipRollDialog:!1,situational:"",rollMode:game.settings.get("core","rollMode")};if(!e.initConfiguration)throw r.error("DialogClass.initConfiguration not found",[e,e.name]),new Error(`DialogClass ${e.name} does not have initConfiguration method`);const d={skipRollDialog:!1,sendRequest:i&&l.isRollRequest!==!1};return r.log("_getDialogResult - normalizedRollType",[c,y.DAMAGE,y.ATTACK]),c===y.ATTACK||c===y.DAMAGE?(r.log("DialogClass.initConfiguration A",[t,c,o,d,l,n]),await e.initConfiguration([t],c,o,d,l,n)):(r.log("DialogClass.initConfiguration B",[t,c,o,d,l,n]),await e.initConfiguration([t],c,o,d,l,n))}static async _showGMConfigDialog(e,t,s,o,a,i){r.log("_showGMConfigDialog - config",[s,o]);const l=E(),n=C.get(l.rollRequestsEnabled.tag),c=D.areSkipKeysPressed(o.event);try{if((s==null?void 0:s.toLowerCase())===y.INITIATIVE&&!await this._handleInitiativePreChecks(e))return;const u=this._getDialogClass(s),{rollKey:f,rollConfig:p}=this._extractRollConfiguration(s,o,a,e),m=t&&(t==null?void 0:t.active)&&!(t!=null&&t.isGM);let h;const S=c||v.shouldSkipRollDialog(m?n:!1,{isPC:m,isNPC:!m});if(r.log("_showGMConfigDialog - rollConfig",[p,f,S,m,t]),S?h={sendRequest:m?n:!1,advantage:!1,disadvantage:!1,skipRollDialog:!0,situational:"",rollMode:game.settings.get("core","rollMode")}:(h=await this._getDialogResult(u,e,s,f,S,n,o,a),r.log("_showGMConfigDialog - _getDialogResult",[h])),!h){r.log("_showGMConfigDialog - Dialog cancelled");return}if(!h.sendRequest||!n){r.log("_showGMConfigDialog - triggering _executeInterceptedRoll",[s,o,h]),await this._executeInterceptedRoll(e,s,o,h);return}delete o.event;const R=o.subject,T={...o,...h,subject:R,rolls:h.rolls,requestedBy:game.user.name,...s===y.ATTACK&&{chatMessage:!1}};r.log("_showGMConfigDialog - triggering _sendRollRequest",[s,T]),this._sendRollRequest(e,t,s,T)}catch(d){r.error("RollInterceptor._showGMConfigDialog - Error",[d])}}static async _executeInterceptedRoll(e,t,s,o){var f,p,m,h,S,R,T,L,k,I,A,M,_,F;r.log("RollInterceptor._executeInterceptedRoll",[e,t,s,o]);const a=t==null?void 0:t.toLowerCase(),i=((f=o.rolls)==null?void 0:f[0])||{parts:[],data:{},options:{}},l=((p=i.data)==null?void 0:p.situational)||o.situational||"";let n;switch(a){case y.SKILL:n=s.skill;break;case y.TOOL:n=s.tool;break;case y.ABILITY:case y.SAVE:n=s.ability||((m=s.subject)==null?void 0:m.ability);break;case y.HIT_DIE:n=s.denomination;break;default:n=s.ability||s.skill||s.tool||s.denomination}const c={rollKey:n,config:{advantage:o.advantage||s.advantage,disadvantage:o.disadvantage||s.disadvantage,target:o.target||o.dc||s.target,rollMode:o.rollMode||s.rollMode,situational:l,isRollRequest:!1,skipRollDialog:o.skipRollDialog,ability:s.ability}};if(a===y.SKILL&&!c.config.ability)c.config.ability=((S=(h=e.system.skills)==null?void 0:h[c.rollKey])==null?void 0:S.ability)||((T=(R=CONFIG.DND5E.skills)==null?void 0:R[c.rollKey])==null?void 0:T.ability);else if(a===y.TOOL&&!c.config.ability){const q=(L=e.system.tools)==null?void 0:L[c.rollKey];c.config.ability=(q==null?void 0:q.ability)||((A=(I=(k=CONFIG.DND5E.enrichmentLookup)==null?void 0:k.tools)==null?void 0:I[c.rollKey])==null?void 0:A.ability)||"int"}else(a===y.ABILITY||a===y.SAVE)&&!c.config.ability&&(c.config.ability=c.rollKey);r.log("RollInterceptor._executeInterceptedRoll - requestData",[c,s,o]);const d={configure:!1,isRollRequest:!1},u={rollMode:c.config.rollMode,create:!0,isRollRequest:!1};try{const q=y,G=se[a];G?((a===y.ATTACK||a===y.DAMAGE||a===y.SAVE)&&(c.rollKey=(_=(M=s.subject)==null?void 0:M.item)==null?void 0:_.id,c.activityId=(F=s.subject)==null?void 0:F.id,c.config.skipRollDialog=!0),await G(e,c,i,d,u)):r.warn(`No handler found for roll type: ${a}`)}catch(q){r.error("RollInterceptor._executeInterceptedRoll",[q])}}static async _sendRollRequest(e,t,s,o){var p;r.log("_sendRollRequest",[e,t,s,o]),r.log("_sendRollRequest - config.rolls",[o.rolls]);const a=E();let i=s==null?void 0:s.toLowerCase();const l=t&&t.active&&t.id!==game.user.id;i===y.INITIATIVE&&(i=y.INITIATIVE_DIALOG);let n=null,c=null;switch(i){case y.ABILITY:case y.SAVE:n=o.ability;break;case y.SKILL:n=o.skill;break;case y.TOOL:n=o.tool;break;case y.ATTACK:case y.DAMAGE:r.log("_sendRollRequest - Attack/Damage roll config",[s,o]),n=(p=o.subject.item)==null?void 0:p.id,c=o.subject.id,r.log("_sendRollRequest - resolved rollKey and activityId",[n,c]);break;case y.HIT_DIE:n=typeof o=="string"?o:o.denomination;break;case y.INITIATIVE_DIALOG:case y.INITIATIVE:n=null;break;case y.DEATH_SAVE:n=null;break;default:r.warn(`Unknown roll type: ${s}`);return}const d={...o};d.midiOptions&&d.activity&&d.activity.type===le.DAMAGE&&(r.log("_sendRollRequest - Damage activity",[d]),d.midiOptions={...d.midiOptions,workflowOptions:{...d.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1,fastForwardDamage:!1}}),delete d.subject,delete d.workflow,delete d.item,delete d.activity;const u={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:e.id,rollType:i,rollKey:n,activityId:c,rollProcessConfig:{...d,_requestedBy:game.user.name},skipRollDialog:!1,targetTokenIds:Array.from(game.user.targets).map(m=>m.id),preserveTargets:C.get(a.useGMTargetTokens.tag)};if(r.log("_sendRollRequest - requestData",[t,u]),!l){r.log("_sendRollRequest - No valid active owner, executing locally",[t==null?void 0:t.name,t==null?void 0:t.active]);const m={...d,rollMode:o.rollMode||game.settings.get("core","rollMode"),skipRollDialog:v.shouldSkipRollDialog(!1,{isPC:!1,isNPC:!0})};await this._executeInterceptedRoll(e,s,o,m);return}await Ye.handleOfflinePlayer(t,e,s,o,{...o,sendRequest:!1})||(re.execForUser("handleRollRequest",t.id,u),ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:(t==null?void 0:t.name)||"Unknown",actor:e.name||"Unknown"})))}}w(st,"registeredHooks",new Set);class Ye{static async handleOfflinePlayer(e,t,s,o,a=null){if(r.log("OfflinePlayerManager.handleOfflinePlayer",[e==null?void 0:e.name,t==null?void 0:t.name,s]),!e||!o)return ui.notifications.warn("Flash Rolls: No owner found for actor "+t.name),!0;if(!e.active){const i=E();return C.get(i.showOfflineNotifications.tag)&&ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:e.name})),await st._executeInterceptedRoll(t,s,o,a||{...o,sendRequest:!1}),!0}return!1}static categorizeActorsByOnlineStatus(e){const t=[],s=[],o=new Map;for(const{actor:a,owner:i}of e)o.has(a.id)||o.set(a.id,{actor:a,owners:[]}),o.get(a.id).owners.push(i);for(const{actor:a,owners:i}of o.values()){const l=i.find(n=>n.active&&!n.isGM);l?t.push({actor:a,owner:l}):s.push(a)}return{onlinePlayerActors:t,offlinePlayerActors:s}}static async processOfflineActors(e,t,s,o){r.log("OfflinePlayerManager.processOfflineActors",[e.map(a=>a.name),t,s]);for(const a of e){const i=a.ownership||{};let l=null;for(const[p,m]of Object.entries(i))if(m>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER&&p!=="default"){const h=game.users.get(p);if(h&&!h.isGM){l=h;break}}if(!l){r.warn("OfflinePlayerManager.processOfflineActors - No owner found for actor",[a.name]);continue}const n={rollKey:s,groupRollId:o.groupRollId,config:{...o,...t==="ability"||t==="abilitycheck"||t==="save"||t==="savingthrow"?{ability:s}:{},sendRequest:!1,isGroupRoll:!!o.groupRollId}},c={parts:[],data:o.situational?{situational:o.situational}:{},options:o.dc?{target:o.dc}:{}},d={configure:!1,isRollRequest:!0},u={rollMode:o.rollMode||game.settings.get("core","rollMode"),create:!0,isRollRequest:!0,groupRollId:o.groupRollId},f=se[t.toLowerCase()];f&&await f(a,n,c,d,u),await new Promise(p=>setTimeout(p,200))}}}class Ce{static async orchestrateRollsForActors(e,t,s,o,a,i,l){const n=E(),c=[],d=[],u=[];let f=foundry.utils.randomID();r.log("RollMenuOrchestrator.orchestrateRollsForActors",["config.sendRequest:",e.sendRequest,"pcActors:",t.map(R=>{var T;return`${R.actor.name}(${(T=R.owner)==null?void 0:T.name})`}),"npcActors:",s.map(R=>R.name)]);const p=[],m=[];if(e.sendRequest){const{onlinePlayerActors:R,offlinePlayerActors:T}=Ye.categorizeActorsByOnlineStatus(t);if(u.push(...R),d.push(...T),T.length>0){const L=E();C.get(L.showOfflineNotifications.tag)&&T.forEach(k=>{var A;const I=(A=t.find(M=>M.actor.id===k.id))==null?void 0:A.owner;I&&X.notify("info",game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:I.name}))})}m.push(...u.map(({actor:L})=>L))}else s.push(...t.map(({actor:R})=>R));m.push(...d,...s);const h=m.map(R=>R.id);p.push(...i.filter(R=>R&&R.actor&&h.includes(R.actor.id)));const S=C.get(n.groupRollsMsgEnabled.tag);if(S&&m.length>1&&(await B.createGroupRollMessage(p,o,a,e,f),await Be(100)),d.length>0&&(e.skipRollDialog=!0,e.groupRollId=f,await Ye.processOfflineActors(d,o,a,e)),o===y.HIT_DIE){const R=[];if(u.forEach(({actor:L})=>R.push(L)),d.forEach(L=>R.push(L)),s.forEach(L=>R.push(L)),!await this.handleHitDieRefill(R))return}for(const{actor:R,owner:T}of u){const L=S&&m.length>1?f:null;let k=a;o===y.HIT_DIE&&(k=R.system.attributes.hd.largestAvailable,!k)||(await this.sendRollRequestToPlayer(R,T,o,k,e,!0,L),c.push({actor:R,owner:T}),await Be(250))}if(c.length>0&&this.showConsolidatedNotification(c,o,a),s.length>0){e.skipRollDialog=!0,e.groupRollId=S&&m.length>1?f:null;const R=s.map(L=>L.id),T=i.filter(L=>L&&L.actor&&R.includes(L.actor.id));await l._handleGMRollsWithTokens(T,o,a,e)}}static async handleHitDieRefill(e){const s=(Array.isArray(e)?e:[e]).filter(i=>i.system.attributes.hd.value===0);if(s.length===0)return!0;const o=s.map(i=>i.name).join(", ");if(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessage",{actors:o})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){for(const i of s)try{const l=await se.handleHitDieRecovery(i);if(i.isToken&&i._actor)try{await se.handleHitDieRecovery(i._actor)}catch(n){r.error("Error updating base actor:",[n])}}catch(l){r.error("Error calling handleHitDieRecovery:",[l])}return X.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:o})||`Hit dice refilled for ${o}`),!0}return!1}static async triggerRoll(e,t,s,o={}){var S;const a=E(),i=Array.from(s.selectedActors),l=o.skipRollDialog!==void 0?o.skipRollDialog:C.get(a.skipRollDialog.tag);let n=i.map(R=>{const T=ee(R);if(!T)return null;let L=null;return game.actors.get(R)?L=null:L=R,{actor:T,uniqueId:R,tokenId:L}}).filter(R=>R),c=n.map(R=>R.actor);const d=W.ROLL_REQUEST_OPTIONS[e],u=(S=(d==null?void 0:d.name)||e)==null?void 0:S.toLowerCase(),f=t;if(t=await this.handleSpecialRollTypes(u,t,i,n,c,s),t===null&&f!==null)return;if(!c.length){X.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}const{pcActors:p,npcActors:m}=Qt(c),h=await pt.getRollConfiguration(c,u,t,l,p,o);h&&(await this.orchestrateRollsForActors(h,p,m,u,t,n,s),!s.isLocked&&typeof s.close=="function"&&setTimeout(()=>s.close(),500))}static async handleSpecialRollTypes(e,t,s,o,a,i){const l=E();switch(e){case y.CUSTOM:if(t=await pt.handleCustomRoll(),!t)return null;break;case y.INITIATIVE:case y.INITIATIVE_DIALOG:if(!(await this.handleInitiativeRoll(s,o,a)).success)return null;C.get(l.initiateCombatOnRequest.tag)&&game.combat.startCombat();break;case y.DEATH_SAVE:const d=await Yt(a);a.length=0,a.push(...d),o=o.filter(f=>d.includes(f.actor));break;case y.HIT_DIE:const u=a.filter(f=>f.type==="character");if(u.length===0)return X.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noCharactersForHitDie")||"Hit dice can only be rolled for player characters, not NPCs."),null;a.length=0,a.push(...u),o=o.filter(f=>f.actor.type==="character");break}return t}static async handleInitiativeRoll(e,t,s){var u,f;if(!await vt())return{success:!1};const a=[],i=[];for(const p of e){const m=ee(p);if(!m)continue;let h=null;if(!game.actors.get(p))h=p,i.push(m.name);else{if(h=((f=(u=m.getActiveTokens())==null?void 0:u[0])==null?void 0:f.id)||null,!h){a.push(m.name);continue}i.push(m.name),game.combat.combatants.find(R=>R.tokenId===h)||await game.combat.createEmbeddedDocuments("Combatant",[{actorId:m.id,tokenId:h}])}}if(i.length===0)return{success:!1};a.length>0&&ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.actorsSkippedInitiative",{actors:a.join(", ")})||`Initiative skipped for actors without tokens: ${a.join(", ")}`);const l=t.filter(p=>{var h;return p.tokenId?!0:!!((h=p.actor.getActiveTokens())==null?void 0:h[0])});t.length=0,t.push(...l),s=l.map(p=>p.actor);const n=[...new Set(s.map(p=>p.id))],c=await _t(n,game);if(!c.length)return{success:!1};const d=t.filter(p=>p&&p.actor&&c.includes(p.actor.id));return s.length=0,s.push(...c.map(p=>game.actors.get(p)).filter(p=>p)),t.length=0,t.push(...d),{success:!0}}static async sendRollRequestToPlayer(e,t,s,o,a,i=!1,l=null){var p;const n=E();let c=s==null?void 0:s.toLowerCase();if(c===y.ABILITY_CHECK?c=y.ABILITY:c===y.SAVING_THROW?c=y.SAVE:c===y.INITIATIVE_DIALOG&&(c=y.INITIATIVE),c===y.HIT_DIE&&(o=e.system.attributes.hd.largestAvailable,!o)){r.warn(`No hit dice available for ${e.name}.`);return}const d={...a};delete d.subject,delete d.workflow,delete d.item,delete d.activity;const u=C.get(n.publicPlayerRolls.tag)===!0;C.get(n.groupRollsMsgEnabled.tag),u&&(d.rollMode=CONST.DICE_ROLL_MODES.PUBLIC);const f={type:"rollRequest",groupRollId:l||foundry.utils.randomID(),actorId:e.isToken?e.token.id:e.id,isTokenActor:e.isToken,baseActorId:e.isToken?(p=e._actor)==null?void 0:p.id:e.id,rollType:c,rollKey:o,activityId:null,rollProcessConfig:{...d,_requestedBy:game.user.name},skipRollDialog:!1,targetTokenIds:Array.from(game.user.targets).map(m=>m.id),preserveTargets:C.get(n.useGMTargetTokens.tag)};r.log("RollMenuOrchestrator.sendRollRequestToPlayer - sending request",[]),re.execForUser("handleRollRequest",t.id,f),i||X.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:t.name,actor:e.name}))}static showConsolidatedNotification(e,t,s){var i,l,n,c,d;const o={};for(const{actor:u,owner:f}of e)o[f.id]||(o[f.id]={player:f,actors:[]}),o[f.id].actors.push(u);let a=game.i18n.localize(`FLASH_ROLLS.rollTypes.${t}`)||t;if(s){const u=t.toLowerCase();if(u===y.SKILL)a=`${a} (${((i=CONFIG.DND5E.skills[s])==null?void 0:i.label)||s})`;else if(u===y.SAVING_THROW)a=`${a} (${((l=CONFIG.DND5E.abilities[s])==null?void 0:l.label)||s})`;else if(u===y.ABILITY_CHECK)a=`${a} (${((n=CONFIG.DND5E.abilities[s])==null?void 0:n.label)||s})`;else if(u===y.TOOL){const f=(d=(c=CONFIG.DND5E.enrichmentLookup)==null?void 0:c.tools)==null?void 0:d[s];if(f!=null&&f.id){const p=dnd5e.documents.Trait.getBaseItem(f.id,{indexOnly:!0});a=`${a} (${(p==null?void 0:p.name)||s})`}else a=`${a} (${s})`}else u===y.CUSTOM&&(a=`${a}: ${s}`)}X.notifyRollRequestsSent(o,a)}}class Qe{static async requestRoll(e={}){try{if(!e||typeof e!="object"){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidMacroData"));return}const{requestType:t,rollKey:s=null,actorIds:o=[],dc:a,situationalBonus:i,advantage:l,disadvantage:n,skipRollDialog:c,sendAsRequest:d=!0}=e;if(!t){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.missingRequestType"));return}const u={dc:a,situationalBonus:i,advantage:l,disadvantage:n,skipRollDialog:c,sendAsRequest:d};r.log("FlashRollsAPI.requestRoll",[t,s,o,u]);let f=W.ROLL_REQUEST_OPTIONS[t];if(f||(f=Object.values(W.ROLL_REQUEST_OPTIONS).find(T=>T.name===t)),!f){ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.unknownRequestType",{requestType:t}));return}const p=f.name;if(o.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}if(!Array.isArray(o)){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidActorIdsFormat"));return}const m=[],h=[];for(const R of o){const T=ee(R);if(!T){m.push(R);continue}let L=null;game.actors.get(R)||(L=R),h.push({actor:T,uniqueId:R,tokenId:L})}if(m.length>0){const R=m.join(", ");ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.invalidActorIds",{numIds:m.length,invalidIds:R}))}if(h.length===0){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const S={selectedActors:new Set(o),selectedRequestType:t,isLocked:!0,close:()=>{}};return Ce.triggerRoll(p,s,S,u)}catch(t){r.error("FlashRollsAPI.requestRoll - Execution error:",[t]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.macroExecutionFailed"));return}}static getAvailableRollTypes(){const e={};for(const[t,s]of Object.entries(W.ROLL_REQUEST_OPTIONS))e[t]={name:s.name,label:s.label};return e}static getSelectedActors(){const e=V.getInstance();return e&&e.selectedActors?Array.from(e.selectedActors):[]}static isMenuOpen(){const e=V.getInstance();return e&&e.rendered}static async createMacro(e){const t=E(),s=C.get(t.addMacrosToFolder.tag);r.log("FlashRollsAPI.createMacro",[e]);const{requestType:o,rollKey:a=null,actorIds:i=[],config:l={}}=e;let n=W.ROLL_REQUEST_OPTIONS[o];if(n||(n=Object.values(W.ROLL_REQUEST_OPTIONS).find(S=>S.name===o)),!n){ui.notifications.warn(`Unknown request type: ${o}`);return}let c=n.label;if(r.log("FlashRollsAPI.createMacro",[c,n.subList]),a&&n.subList&&Array.isArray(n.subList)){const h=n.subList.find(S=>S.id===a);h&&(c=h.name)}else a&&(c=jt(n.name,a));const d={requestType:n.name,...a&&{rollKey:a},...i.length>0&&{actorIds:i},...l};d.advantage===void 0&&(d.advantage=!1),d.disadvantage===void 0&&(d.disadvantage=!1);const u=`// Flash Rolls: ${c} - ${a||""}
    try {
      FlashRolls5e.requestRoll(${JSON.stringify(d,null,2)});
    } catch (error) {
      ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.macroDataMalformed"));
    }`;let f=null;s&&(f=await this._ensureFlashRollsFolder());const p={name:`Flash Rolls: ${c}`,type:"script",command:u,img:"modules/flash-rolls-5e/assets/bolt-circle.svg",...f&&{folder:f},flags:{"flash-rolls-5e":{requestType:o,rollKey:a,actorIds:i,config:l}}},m=await Macro.create(p);return ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.macroCreated",{macroName:m.name})),m.sheet.render(!0),m}static async _ensureFlashRollsFolder(){const e="Flash Rolls";let t=game.folders.find(s=>s.type==="Macro"&&s.name===e);if(!t)try{t=await Folder.create({name:e,type:"Macro",color:"#302437",sort:0}),r.log("Created Flash Rolls macro folder",[t])}catch(s){return r.error("Failed to create Flash Rolls macro folder:",[s]),ui.notifications.warn("Failed to create Flash Rolls macro folder. Macro will be created without folder organization."),null}return(t==null?void 0:t.id)||null}static calculateGroupRoll(e={}){const{rollResults:t,dc:s,rollType:o,rollKey:a}=e;let{method:i,actors:l}=e;const n={"standard rule":1,"group average":2,"leader with help":3,"weakest link":4};if(typeof i=="string"){const d=i.toLowerCase();if(i=n[d],!i)return ui.notifications.error(`Invalid method name: "${e.method}". Valid options: "Standard Rule", "Group Average", "Leader with Help", "Weakest Link", or numbers 1-4`),null}if(!i||![1,2,3,4].includes(i))return ui.notifications.error("Method must be 1-4 or valid method name: 'Standard Rule', 'Group Average', 'Leader with Help', 'Weakest Link'"),null;if(!Array.isArray(t)||t.length===0)return ui.notifications.error("rollResults must be a non-empty array"),null;if(typeof s!="number"||s<0)return ui.notifications.error("dc must be a positive number"),null;const c=[];for(let d=0;d<t.length;d++){const u=t[d];if(!u.hasOwnProperty("total")||typeof u.total!="number")return ui.notifications.error(`rollResults[${d}] must have a 'total' property with a numeric value`),null;if(!u.actorId)return ui.notifications.error(`rollResults[${d}] must have an 'actorId' property`),null;let f=u.actorName;if(!f){const p=ee(u.actorId);f=(p==null?void 0:p.name)||u.actorId}c.push({...u,actorName:f,passed:u.total>=s})}if([3,4].includes(i)){if(!o)return ui.notifications.error("rollType is required for Leader with Help and Weakest Link methods"),null;if(!a)return ui.notifications.error("rollKey is required for Leader with Help and Weakest Link methods"),null;if(!Array.isArray(l)||l.length===0){l=[];for(const d of c){const u=ee(d.actorId);u&&l.push(u)}if(l.length===0)return ui.notifications.error("No valid actors could be resolved from the rollResults for Leader with Help and Weakest Link methods"),null}}try{let d,u;switch(i){case 1:return d=v.calculateStandardRule(t,s),u="Standard Rule",{success:d.finalResult,result:d.finalResult?1:0,details:d,method:u,actorResults:c};case 2:return d=v.calculateGroupAverage(t,s),u="Group Average",{success:d.success,result:d.finalResult,details:d,method:u,actorResults:c};case 3:d=v.calculateLeaderWithHelp(t,s,l,o,a),u="Leader with Help";const f=c.map(m=>({...m,isLeadRoll:m.actorId===d.leaderActorId}));return{success:d.success,result:d.finalResult,details:d,method:u,actorResults:f};case 4:d=v.calculateWeakestLink(t,s,l,o,a),u="Weakest Link";const p=c.map(m=>({...m,isLeadRoll:m.actorId===d.weakestActorId}));return{success:d.success,result:d.finalResult,details:d,method:u,actorResults:p};default:return ui.notifications.error(`Invalid calculation method: ${i}`),null}}catch(d){return r.error("FlashRollsAPI.calculateGroupRoll - Error:",[d]),ui.notifications.error(`Error calculating group roll: ${d.message}`),null}}}Hooks.once(O.READY,()=>{dnd5e.applications.dice.DamageRollConfigurationDialog||r.warn("DamageRollConfigurationDialog not found in dnd5e.applications.dice")});function He(g){return class extends g{constructor(e={},t={},s={}){var o,a;super(e,t,s),this.actors=s.actors||[],this.sendRequest=s.sendRequest??s.isRollRequest??!1,this.showDC=s.showDC||!1,this.dcValue=s.dcValue||null,this.rollKey=s.rollKey||e.skill||e.ability||null,this.rollTypeString=s.rollTypeString||null,this.windowTitle=((o=s.window)==null?void 0:o.title)||"",this.windowSubtitle=((a=s.window)==null?void 0:a.subtitle)||""}_buildConfig(e,t,s){const o=t==null?void 0:t.get("ability"),a=t==null?void 0:t.get("dc"),i=t==null?void 0:t.get(`rolls.${s}.situational`);if(r.log("_buildConfig",[i,t,e]),i)e.parts||(e.parts=[]),e.parts.push("@situational"),e.data||(e.data={}),e.data.situational=i;else if(e.parts){const n=e.parts.indexOf("@situational");n!==-1&&e.parts.splice(n,1)}o&&(e.ability=o,this.config.ability=o);const l=super._buildConfig(e,t,s);if(a){const n=parseInt(a);isNaN(n)||(l.options=l.options||{},l.options.target=n)}else this.dcValue!==void 0&&this.dcValue!==null&&(l.options=l.options||{},l.options.target=this.dcValue);return r.log(`${this.constructor.name}._buildConfig`,[this.config,t,l]),l}_onChangeForm(e,t){r.log("_onChangeForm",[t.target.value]),super._onChangeForm(e,t);const s=this.element.querySelector('input[name="flash5e-send-request"]');s&&(this.sendRequest=s.checked);const o=this.element.querySelector('input[name="dc"]');o&&o.value&&(this.dcValue=parseInt(o.value)||null)}_finalizeRolls(e){const t=super._finalizeRolls(e);if(r.log("_finalizeRolls #1",[t,this.sendRequest]),this.dcValue!==void 0&&this.dcValue!==null)for(const s of t)s.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,this.config.skipRollDialog=this.sendRequest?this.config.skipRollDialog||!1:!0,t}async _onCreateMacroClick(e){var d;if(e.preventDefault(),e.stopPropagation(),r.log("_onCreateMacroClick",[this]),!this.rollTypeString){ui.notifications.error("Cannot create macro: roll type not defined");return}const t=new FormDataExtended(this.form),s=t.get("roll.0.situational")||t.get("rolls.0.situational")||"",o=t.get("dc"),a=t.get("flash5e-send-request"),i=t.get("rollMode")||game.settings.get("core","rollMode"),l=t.get("ability"),n=((d=this.actors)==null?void 0:d.map(u=>u.id))||[],c={requestType:this.rollTypeString,rollKey:this.rollKey,actorIds:n,config:{...s&&{situationalBonus:s},...o&&{dc:parseInt(o)},...i!==game.settings.get("core","rollMode")&&{rollMode:i},...l&&{ability:l},sendAsRequest:!!a,skipRollDialog:!0,advantage:!1,disadvantage:!1}};try{await Qe.createMacro(c),this.close()}catch(u){r.error("Failed to create macro:",[u]),ui.notifications.error(`Failed to create macro: ${u.message}`)}}async _onRender(e,t){var s,o,a;await super._onRender(e,t),((a=(o=(s=this.config.rolls)==null?void 0:s[0])==null?void 0:o.data)!=null&&a.situational||this.config.situational)&&(r.log(`${this.constructor.name}._onRender`,["Triggering rebuild for initial situational bonus"]),this.element&&(this.element.style.transition="none",this.element.style.opacity="1"),requestAnimationFrame(()=>{this.rebuild(),this.element&&requestAnimationFrame(()=>{this.element.style.transition=""})}))}}}class me extends He(dnd5e.applications.dice.D20RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(e,t,s),r.log("constructor - initializing GM Dialog",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}get title(){return this.windowTitle||super.title}_prepareConfigurationData(e,t,s,o){r.log("_prepareConfigurationData",[e,t,s,o]);const a=super._prepareConfigurationData(e,t,s,o);return a.showDC=this.showDC,a.dcValue=this.dcValue,a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,s){return r.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(r.log("_onRender",[e,t]),super._onRender(e,t),D.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},a=await D.renderTemplate(`modules/${b}/templates/gm-roll-config-fields.hbs`,o),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,s.parentNode.insertBefore(i,s)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,s,o={}){var T,L,k,I,A,M,_,F,q;if(e=v.validateActors(e),!e)return null;const a=e[0];r.log("GMRollConfigDialog, initConfiguration",[]);const i=t==null?void 0:t.toLowerCase(),l=E(),n=C.get(l.publicPlayerRolls.tag)===!0,c=v.determineRollMode(n),d=v.shouldShowDC(i),u=v.getRollClass(i),f=v.createBaseRollConfig(a,t,s),p=v.createMessageConfig(a,c),m={options:{actors:e,sendRequest:e.some(G=>v.isPlayerOwned(G)),showDC:d,rollKey:s,rollType:u,rollTypeString:i,window:{title:me._getRollTitle(i,s,a),subtitle:me._getSubtitle(e)},position:{width:420,height:"auto"},...o}},h=await v.triggerRollDialog(this,f,p,m.options),S=v.processDialogResult(h,e,t,s,o);if(!S)return null;if((T=h.config)!=null&&T.ability&&[y.SKILL,y.TOOL].includes(i)){const G=((k=(L=a.system.skills)==null?void 0:L[s])==null?void 0:k.ability)||((A=(I=CONFIG.DND5E.skills)==null?void 0:I[s])==null?void 0:A.ability);h.config.ability!==G&&(S.ability=h.config.ability)}let R=m.options.window.title;if(h.config.ability&&[y.SKILL,y.TOOL].includes(i)){const G=((M=CONFIG.DND5E.abilities[h.config.ability])==null?void 0:M.label)||h.config.ability;if(i===y.SKILL){const Q=((_=CONFIG.DND5E.skills[s])==null?void 0:_.label)||s;R=game.i18n.format("DND5E.SkillPromptTitle",{skill:Q,ability:G})}else if(i===y.TOOL){const Q=(q=(F=CONFIG.DND5E.enrichmentLookup)==null?void 0:F.tools)==null?void 0:q[s];let de=s;if(Q!=null&&Q.id){const oe=dnd5e.documents.Trait.getBaseItem(Q.id,{indexOnly:!0});de=(oe==null?void 0:oe.name)||s}R=game.i18n.format("DND5E.ToolPromptTitle",{tool:de,ability:G})}}return S.rollTitle=R,S.rollType=i,S.rollKey=s,S}static _getRollTitle(e,t,s){var i,l,n,c,d,u,f,p,m,h,S,R,T;let o="";const a=e==null?void 0:e.toLowerCase();switch([y.SAVE,y.ABILITY,y.ABILITY_CHECK].includes(a)&&!t&&r.warn("Missing rollKey for roll type",[a,t]),a){case y.SKILL:const L=((i=CONFIG.DND5E.skills[t])==null?void 0:i.label)||t,k=(l=s==null?void 0:s.system.skills)==null?void 0:l[t],I=(k==null?void 0:k.ability)||((n=CONFIG.DND5E.skills[t])==null?void 0:n.ability)||"int",A=((c=CONFIG.DND5E.abilities[I])==null?void 0:c.label)||I;o=game.i18n.format("DND5E.SkillPromptTitle",{skill:L,ability:A});break;case y.SAVE:case y.SAVING_THROW:const M=((d=CONFIG.DND5E.abilities[t])==null?void 0:d.label)||t;o=game.i18n.format("DND5E.SavePromptTitle",{ability:M});break;case y.ABILITY:case y.ABILITY_CHECK:const _=((u=CONFIG.DND5E.abilities[t])==null?void 0:u.label)||t;o=game.i18n.format("DND5E.AbilityPromptTitle",{ability:_});break;case y.CONCENTRATION:o=game.i18n.localize("DND5E.Concentration");break;case y.TOOL:const F=(p=(f=CONFIG.DND5E.enrichmentLookup)==null?void 0:f.tools)==null?void 0:p[t];let q=t;if(F!=null&&F.id){const oe=dnd5e.documents.Trait.getBaseItem(F.id,{indexOnly:!0});q=(oe==null?void 0:oe.name)||t}const G=(m=s==null?void 0:s.system.tools)==null?void 0:m[t],Q=(G==null?void 0:G.ability)||((R=(S=(h=CONFIG.DND5E.enrichmentLookup)==null?void 0:h.tools)==null?void 0:S[t])==null?void 0:R.ability)||"int",de=((T=CONFIG.DND5E.abilities[Q])==null?void 0:T.label)||Q;o=game.i18n.format("DND5E.ToolPromptTitle",{tool:q,ability:de});break;case y.DEATH_SAVE:o=game.i18n.localize("DND5E.DeathSave");break;case y.INITIATIVE:case y.INITIATIVE_DIALOG:o=game.i18n.localize("DND5E.Initiative");break;default:o=game.i18n.localize("DND5E.Roll")}return r.log("_getRollTitle",[a,o]),o}static _getSubtitle(e=[]){return e.length===1?e[0].name:e.length>1?game.i18n.localize("FLASH_ROLLS.ui.dialogs.multipleActors"):""}}class Ot extends He(dnd5e.applications.dice.RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=CONFIG.Dice.BasicRoll||Roll,s.showDC=!1,super(e,t,s),r.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config","hit-die-config"]})}_prepareConfigurationData(e,t,s,o){const a=super._prepareConfigurationData(e,t,s,o);return r.log("GMHitDieConfigDialog._prepareConfigurationData",[a]),a.formula="Hit Die (varies by actor)",a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length,t.formula="Hit Die (varies by actor)"),t}async _onRender(e,t){if(super._onRender(e,t),D.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},a=await D.renderTemplate(`modules/${b}/templates/gm-roll-config-fields.hbs`,o),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,s.parentNode.insertBefore(i,s)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}async _processSubmitData(e,t,s){await super._processSubmitData(e,t,s),this.sendRequest=s.get("flash5e-send-request")!=="false",r.log("_processSubmitData",[s,this.config])}_finalizeRolls(e){const t=super._finalizeRolls(e);return this.config.sendRequest=this.sendRequest,t}static async initConfiguration(e,t,s,o={}){var m;if(e=v.validateActors(e),!e)return null;const a=e[0];r.log("GMHitDieConfigDialog, initConfiguration",[]);const i=E(),l=C.get(i.publicPlayerRolls.tag)===!0,n=v.determineRollMode(l),c={data:a.getRollData(),subject:a,rolls:[{parts:[],data:a.getRollData(),options:{flavor:"Hit Die Roll"}}]},d=v.createMessageConfig(a,n),u={options:{actors:e,sendRequest:e.some(h=>v.isPlayerOwned(h)),rollKey:s,rollType:CONFIG.Dice.BasicRoll||Roll,window:{title:game.i18n.localize("DND5E.HitDice"),subtitle:me._getSubtitle(e)},position:{width:420,height:"auto"},...o}},f=await v.triggerRollDialog(this,c,d,u.options);if(!(f!=null&&f.rolls)||f.rolls.length===0)return null;r.log("GMHitDieConfigDialog - dialog result",[f.rolls]);const p=v.processDialogResult(f,e,t,s,o);return p?((m=f.config)!=null&&m.ability&&(p.ability=f.config.ability),p):null}}class Dt extends He(dnd5e.applications.dice.SkillToolRollConfigurationDialog){constructor(e={},t={},s={}){const o=foundry.utils.mergeObject(e,{chooseAbility:!0});s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(o,t,s),r.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){r.log("_prepareConfigurationData",[e,t,s,o]);const a=super._prepareConfigurationData(e,t,s,o);return a.showDC=this.showDC,a.dcValue=this.dcValue,a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,s){return r.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(r.log("_onRender",[e,t]),super._onRender(e,t),D.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},a=await D.renderTemplate(`modules/${b}/templates/gm-roll-config-fields.hbs`,o),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,s.parentNode.insertBefore(i,s)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,s,o={}){var T,L,k,I,A,M;if(e=v.validateActors(e),!e)return null;const a=e[0];r.log("GMSkillToolConfigDialog, initConfiguration",[]);const i=t==null?void 0:t.toLowerCase(),l=E(),n=C.get(l.publicPlayerRolls.tag)===!0,c=v.determineRollMode(n),d=v.shouldShowDC(i),u=CONFIG.Dice.D20Roll;let f=null;if(i===y.SKILL){const _=a.system.skills[s];f=(_==null?void 0:_.ability)||((T=CONFIG.DND5E.skills[s])==null?void 0:T.ability)||"int"}else if(i===y.TOOL){const _=(L=a.system.tools)==null?void 0:L[s];f=(_==null?void 0:_.ability)||((A=(I=(k=CONFIG.DND5E.enrichmentLookup)==null?void 0:k.tools)==null?void 0:I[s])==null?void 0:A.ability)||"int"}const p={data:a.getRollData(),subject:a,ability:f,chooseAbility:!0,rolls:[{parts:[],data:a.getRollData(),options:{}}]};i===y.SKILL?p.skill=s:i===y.TOOL&&(p.tool=s);const m=v.createMessageConfig(a,c),h={options:{actors:e,sendRequest:e.some(_=>v.isPlayerOwned(_)),showDC:d,rollKey:s,rollType:u,rollTypeString:i,window:{title:me._getRollTitle(i,s,a),subtitle:me._getSubtitle(e)},position:{width:420,height:"auto"},...o}},S=await v.triggerRollDialog(this,p,m,h.options),R=v.processDialogResult(S,e,t,s,o);return R?((M=S.config)!=null&&M.ability&&[y.SKILL,y.TOOL].includes(i)&&(R.ability=S.config.ability),R.rollTitle=h.options.window.title,R.rollType=i,R.rollKey=s,R):null}}class Zt extends He(dnd5e.applications.dice.DamageRollConfigurationDialog){constructor(e={},t={},s={}){const o=foundry.utils.mergeObject({configure:!0},e);super(o,t,s),r.log("GMDamageConfigDialog.constructor",[o,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","damage-roll","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){r.log("GMDamageConfigDialog._prepareConfigurationData",[e,t,s,o]);const a=super._prepareConfigurationData(e,t,s,o);return a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _onRender(e,t){if(await super._onRender(e,t),D.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields")||(D.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields")))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!1},a=await D.renderTemplate(`modules/${b}/templates/gm-roll-config-fields.hbs`,o),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,s.parentNode.insertBefore(i,s)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,s,o={},a={},i={}){var G,Q,de,oe,Oe,De;if(e=v.validateActors(e),r.log("GMDamageConfigDialog, initConfiguration",[e,a,i]),!e)return null;const l=e[0],n=(G=a.subject)==null?void 0:G.item,c=l.items.get(s),d=(c==null?void 0:c.id)||(n==null?void 0:n.id);let u={};d&&(u=ae.getActivityConfigFromCache(d)||{}),r.log("GMDamageConfigDialog - retrieved activity config from cache",[d,u]);const f=E(),p=C.get(f.publicPlayerRolls.tag)===!0,m=v.determineRollMode(p,a.rollMode),h=t==null?void 0:t.toLowerCase(),S={subject:a.subject||l,data:l.getRollData(),critical:a.critical||{},rolls:a.rolls||[{parts:[],data:l.getRollData(),options:{}}]};r.log("GMDamageConfigDialog, initConfiguration #1",[S]);const R=v.createMessageConfig(l,m);r.log("GMDamageConfigDialog, initConfiguration #2",[R]);const{position:T,...L}=(i==null?void 0:i.options)||{},k={options:{actors:e,sendRequest:e.some(Ne=>v.isPlayerOwned(Ne)),rollKey:s,rollType:CONFIG.Dice.DamageRoll,rollTypeString:h,window:{title:game.i18n.localize("DND5E.DamageRoll"),subtitle:me._getSubtitle(e)},...L,...o}},I=await v.triggerRollDialog(this,S,R,k.options);if(!(I!=null&&I.rolls)||I.rolls.length===0)return null;const A=I.rolls[0],M=((Q=A==null?void 0:A.data)==null?void 0:Q.situational)||"",_=(de=A==null?void 0:A.options)==null?void 0:de.target,F={rolls:[{parts:[],data:M?{situational:M}:{},options:{..._&&{target:_},isCritical:((oe=A==null?void 0:A.options)==null?void 0:oe.isCritical)||(A==null?void 0:A.isCritical)||!1}}],subject:a.subject||l,target:_,isCritical:((Oe=A==null?void 0:A.options)==null?void 0:Oe.isCritical)||(A==null?void 0:A.isCritical)||!1,sendRequest:I.sendRequest,isRollRequest:I.sendRequest,skipRollDialog:I.sendRequest?o.skipRollDialog||!1:!0,chatMessage:!0,spell:u.spell||a.spell||{},scaling:u.scaling!==void 0?u.scaling:a.scaling,consume:u.consume||a.consume||{},create:u.create||a.create||{}};r.log("GMDamageConfigDialog, initConfiguration #6",[F]);const q=v.determineRollMode(p,(De=I.message)==null?void 0:De.rollMode);return F.rollMode=q,F.rollTitle=k.options.window.title,F.rollType=h,F.rollKey=s,r.log("GMDamageConfigDialog, initConfiguration - result",[F]),F}}class es extends He(dnd5e.applications.dice.AttackRollConfigurationDialog){constructor(e={},t={},s={}){super(e,t,s),r.log("GMAttackConfigDialog.constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){r.log("GMAttackConfigDialog._prepareConfigurationData",[e,t,s,o]);const a=super._prepareConfigurationData(e,t,s,o);return a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(await super._onRender(e,t),D.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!1},a=await D.renderTemplate(`modules/${b}/templates/gm-roll-config-fields.hbs`,o),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,s.parentNode.insertBefore(i,s)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}_finalizeRolls(e){return this.config.sendRequest=this.sendRequest,!this.sendRequest&&this.config.isRollRequest&&(this.config.isRollRequest=!1),super._finalizeRolls(e)}static async initConfiguration(e,t,s,o={},a={},i={}){var de,oe,Oe,De,Ne,ot,at,it;if(e=v.validateActors(e),!e)return null;const l=e[0];r.log("GMAttackConfigDialog, initConfiguration",[]);const n=(de=a.subject)==null?void 0:de.item,c=l.items.get(s),d=(c==null?void 0:c.id)||(n==null?void 0:n.id);let u={};d&&(u=ae.getActivityConfigFromCache(d)||{}),r.log("GMAttackConfigDialog - retrieved activity config from cache",[d,u]);const f=E(),p=C.get(f.publicPlayerRolls.tag)===!0,m=t==null?void 0:t.toLowerCase(),h={subject:a.subject||l,data:l.getRollData(),rolls:[{parts:[],data:l.getRollData(),options:{}}]},S=v.determineRollMode(p),R=v.createMessageConfig(l,S),{position:T,...L}=(i==null?void 0:i.options)||{},k={options:{actors:e,sendRequest:e.some(wt=>v.isPlayerOwned(wt)),rollKey:s,rollType:CONFIG.Dice.D20Roll,rollTypeString:m,window:{title:game.i18n.localize("DND5E.Attack"),subtitle:me._getSubtitle(e)},...L,...o}},I=await v.triggerRollDialog(this,h,R,k.options);if(r.log("GMAttackConfigDialog, initConfiguration",[I==null?void 0:I.sendRequest]),!(I!=null&&I.rolls)||I.rolls.length===0)return null;const A=I.rolls[0];let M=!1,_=!1;((oe=A==null?void 0:A.options)==null?void 0:oe.advantageMode)!==void 0&&(M=A.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,_=A.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const F=((Oe=A==null?void 0:A.data)==null?void 0:Oe.situational)||"",q=(De=A==null?void 0:A.options)==null?void 0:De.target,G={rolls:[{parts:[],data:F?{situational:F}:{},options:{...q&&{target:q},...((Ne=A==null?void 0:A.options)==null?void 0:Ne.ammunition)&&{ammunition:A.options.ammunition},...((ot=A==null?void 0:A.options)==null?void 0:ot.attackMode)&&{attackMode:A.options.attackMode},...((at=A==null?void 0:A.options)==null?void 0:at.mastery)!==void 0&&{mastery:A.options.mastery}}}],subject:a.subject||l,advantage:M,disadvantage:_,target:q,sendRequest:I.sendRequest,isRollRequest:I.sendRequest,skipRollDialog:I.sendRequest?o.skipRollDialog||!1:!0,chatMessage:!D.isModuleOn("midi-qol")||!0,spell:(u==null?void 0:u.spell)||(a==null?void 0:a.spell)||{},scaling:(u==null?void 0:u.scaling)!==void 0?u==null?void 0:u.scaling:a==null?void 0:a.scaling,consume:(u==null?void 0:u.consume)||(a==null?void 0:a.consume)||{},create:(u==null?void 0:u.create)||(a==null?void 0:a.create)||{}},Q=v.determineRollMode(p,(it=I.message)==null?void 0:it.rollMode);return G.rollMode=Q,G.rollTitle=k.options.window.title,G.rollType=m,G.rollKey=s,r.log("GMAttackConfigDialog, initConfiguration - SIMPLIFIED result",[G]),G}}class pt{static async getRollConfiguration(e,t,s,o,a,i={}){const l=E(),n=C.get(l.rollRequestsEnabled.tag),c=i.hasOwnProperty("sendAsRequest")?i.sendAsRequest:void 0,d=e.filter(f=>a.includes(f.id)),u=v.shouldSkipRollDialog(o,{isPC:a.length>0,isNPC:d.length>0});if(r.log("RollMenuConfig.getRollConfiguration",["sendAsRequest:",c,"rollRequestsEnabled:",n,"skipRollDialog:",o,"confirmedSkipDialog:",u,"pcActors.length:",a,"npcActors.length:",d,"actors:",e]),!u&&t!==y.CUSTOM){let f;[y.SKILL,y.TOOL].includes(t)?f=Dt:t===y.HIT_DIE?f=Ot:f=me;const p=await f.initConfiguration(e,t,s,{confirmedSkipDialog:u,sendRequest:c===!0||c===void 0&&n||!1});return r.log("getRollConfiguration",[p]),p}else{const f={rolls:[{parts:[],data:i.situationalBonus?{situational:i.situationalBonus}:{},options:i.dc?{target:i.dc}:{}}],advantage:i.advantage||!1,disadvantage:i.disadvantage||!1,rollMode:i.rollMode||game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:!0,sendRequest:i.hasOwnProperty("sendAsRequest")?i.sendAsRequest:n&&a.length>0};return t===y.DEATH_SAVE&&(f.target=10),f}}static async handleCustomRoll(){return await this.showCustomRollDialog()}static async showCustomRollDialog(){return r.log("showCustomRollDialog"),tt.prompt({formula:"",readonly:!1})}}class pe{static initializeDrag(e){const t=e.element.querySelector(this.DRAG_HANDLE_SELECTOR);if(!t){r.error("RollMenuDragManager.initializeDrag - No drag handle found!");return}t.addEventListener("mousedown",s=>{this.handleDragStart(s,e)})}static async handleDragStart(e,t){var f;if(e.preventDefault(),e.stopPropagation(),t.isDragging=!0,!t.element)return;t.element.classList.add("dragging");const s=e.clientX,o=e.clientY;t.element.classList.contains("docked-bottom");const a=((f=t.element.parentElement)==null?void 0:f.id)==="ui-bottom";t.element.classList.remove("docked-right","docked-bottom","faded-ui"),t.element.offsetHeight;const i=t.element.getBoundingClientRect();let l=i.left,n=o;if(a){const p=t.element.querySelector(this.DRAG_HANDLE_SELECTOR);if(p){const m=p.getBoundingClientRect(),h=m.left-i.left+m.width/2;l=s-h}else l=s-i.width/2;n=o}t.element.parentElement,document.body.appendChild(t.element),t.element.style.position="fixed",t.element.style.inset="",t.element.style.transform="",t.element.style.top=`${n}px`,t.element.style.left=`${l}px`,t.element.style.right="auto",t.element.style.bottom="auto",t.element.style.zIndex="var(--z-index-app)",t.element.offsetHeight;const c={startX:s,startY:o,initialLeft:l,initialTop:n,currentLeft:l,currentTop:n},d=p=>this.handleDragMove(p,t,c),u=p=>this.handleDragEnd(p,t,c,d,u);document.addEventListener("mousemove",d),document.addEventListener("mouseup",u)}static handleDragMove(e,t,s){if(!t.isDragging||!t.element)return;const o=e.clientX-s.startX,a=e.clientY-s.startY;s.currentLeft=s.initialLeft+o,s.currentTop=s.initialTop+a,t.element.style.inset="",t.element.style.right="auto",t.element.style.bottom="auto",t.element.style.position="fixed",t.element.style.top=`${s.currentTop}px`,t.element.style.left=`${s.currentLeft}px`;const i=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<i?t.element.classList.add("left-edge"):t.element.classList.remove("left-edge"),t.element.hasAttribute("data-layout")&&t.element.getAttribute("data-layout")==="horizontal"&&s.currentTop<400?t.element.classList.add("top-edge"):t.element.classList.remove("top-edge"),window.getComputedStyle(t.element);const n=this.calculateSnapDistance(t);(t.element.classList.contains("near-snap-both")?"both-edges":t.element.classList.contains("near-snap-right")?"right-edge":t.element.classList.contains("near-snap-bottom")?"bottom-edge":"none")!==n.type&&(t.element.classList.remove("near-snap","near-snap-right","near-snap-bottom","near-snap-both"),n.type==="both-edges"?t.element.classList.add("near-snap","near-snap-both"):n.type==="right-edge"?t.element.classList.add("near-snap","near-snap-right"):n.type==="bottom-edge"&&t.element.classList.add("near-snap","near-snap-bottom"))}static async handleDragEnd(e,t,s,o,a){if(r.log("RollMenuDragManager.handleDragEnd"),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",a),!(t!=null&&t.element)){r.error("RollMenuDragManager.handleDragEnd - Menu element is null");return}t.isDragging=!1,t.element.classList.remove("dragging"),t.element.classList.remove("near-snap","near-snap-right","near-snap-bottom","near-snap-both"),t.element.style.zIndex="";const i=this.calculateSnapDistance(t);if(i.type==="both-edges"){const l=document.querySelector("#chat-notifications");l&&t.element&&l.insertBefore(t.element,l.firstChild),await this.snapToDefault(t)}else if(i.type==="bottom-edge")await this.snapToBottomEdge(t);else if(i.type==="right-edge"){const l=document.querySelector("#chat-notifications");l&&t.element&&l.insertBefore(t.element,l.firstChild),await this.snapToRightEdge(t,s.currentTop)}else{t.isCustomPosition=!0,t.customPosition={x:s.currentLeft,y:s.currentTop,isCustom:!0,dockedRight:!1,dockedBottom:!1};const l=!!document.querySelector("body.crlngn-tabs");D.addCSSVars("--flash-rolls-menu-offset",l?"0px":"16px"),await this.saveCustomPosition(t.customPosition),t.element.classList.add("custom-position");const n=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<n&&t.element.classList.add("left-edge"),t.element.hasAttribute("data-layout")&&t.element.getAttribute("data-layout")==="horizontal"&&s.currentTop<400&&t.element.classList.add("top-edge")}}static calculateSnapDistance(e){if(!(e!=null&&e.element))return r.error("RollMenuDragManager.calculateSnapDistance - Menu element is null"),{type:"none",distance:1/0};const t=document.querySelector(this.LIGHTNING_BOLT_SELECTOR),s=document.querySelector("#hotbar");if(!t&&!s)return{type:"none",distance:1/0};const o=e.element.getBoundingClientRect();if(s){const a=s.getBoundingClientRect(),i=Math.abs(a.top-o.bottom),l=o.left,n=o.right,c=a.left,d=a.right;if(l<d&&n>c&&i<=this.SNAP_DISTANCE)return{type:"bottom-edge",distance:0}}if(t){const a=t.getBoundingClientRect(),i=Math.abs(a.left-o.right),l=window.innerHeight-o.bottom;if(i<=this.SNAP_DISTANCE)return l<=this.SNAP_DISTANCE?{type:"both-edges",distance:0}:{type:"right-edge",distance:0}}return{type:"none",distance:1/0}}static async snapToRightEdge(e,t){if(r.log("RollMenuDragManager.snapToRightEdge",[t]),!(e!=null&&e.element)){r.error("RollMenuDragManager.snapToRightEdge - Menu element is null");return}e.isCustomPosition=!0,e.customPosition={y:t,isCustom:!0,dockedRight:!0},e.element.classList.remove("custom-position","left-edge","top-edge","docked-bottom","faded-ui","offset"),e.element.classList.add("docked-right","snapping"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t<400?e.element.classList.add("top-edge"):e.element.classList.remove("top-edge"),e.element.style.position="fixed",e.element.style.inset="",e.element.style.left="",e.element.style.right="",e.element.style.bottom="",e.element.style.top=`${t}px`,e.element.style.zIndex="",Le(),await this.saveCustomPosition(e.customPosition),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static async snapToBottomEdge(e){if(r.log("RollMenuDragManager.snapToBottomEdge"),!(e!=null&&e.element)){r.error("RollMenuDragManager.snapToBottomEdge - Menu element is null");return}e.isCustomPosition=!0,e.customPosition={isCustom:!0,dockedBottom:!0},e.element.classList.remove("custom-position","left-edge","top-edge","docked-right","offset"),e.element.classList.add("docked-bottom","snapping");const t=document.querySelector("#ui-bottom");t&&e.element&&!t.contains(e.element)&&t.prepend(e.element);const s=document.querySelector("#ui-bottom #hotbar");s&&s.classList.contains("faded-ui")&&e.element.classList.add("faded-ui"),this.syncOffsetClass(e),Le(),await this.saveCustomPosition(e.customPosition),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static syncOffsetClass(e){const t=document.querySelector("#hotbar");if(t&&t.classList.contains("offset")){e.element.classList.add("offset");const s=t.style.getPropertyValue("--offset");s&&e.element.style.setProperty("--offset",s)}else e.element.classList.remove("offset"),e.element.style.removeProperty("--offset")}static syncFadedUIClass(e){if(!e.element.classList.contains("docked-bottom")){e.element.classList.remove("faded-ui");return}const t=document.querySelector("#ui-bottom #hotbar");t&&t.classList.contains("faded-ui")?e.element.classList.add("faded-ui"):e.element.classList.remove("faded-ui")}static async snapToDefault(e){if(r.log("RollMenuDragManager.snapToDefault"),!(e!=null&&e.element)){r.error("RollMenuDragManager.snapToDefault - Menu element is null");return}e.isCustomPosition=!1,e.customPosition=null;const t=E();C.get(t.menuLayout.tag),e.element.classList.remove("custom-position","left-edge","top-edge","docked-bottom","docked-right","faded-ui","offset"),e.element.classList.add("snapping"),e.element.style.position="",e.element.style.inset="",e.element.style.left="",e.element.style.top="",e.element.style.right="",e.element.style.bottom="",e.element.style.zIndex="",e.element.style.removeProperty("--offset"),Le(),await this.saveCustomPosition(null),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static applyCustomPosition(e,t){if(!t||!t.isCustom||!(e!=null&&e.element))return;const s=e.element.getBoundingClientRect();if(r.log("RollMenuDragManager.applyCustomPosition",[t]),t.x<0?t.x=0:t.x>window.innerWidth-s.width&&(t.x=window.innerWidth-s.width),t.y<0?t.y=0:t.y>window.innerHeight-s.height&&(t.y=window.innerHeight-s.height),e.isCustomPosition=!0,e.customPosition=t,t.dockedRight){const o=document.querySelector("#chat-notifications");o&&o.insertBefore(e.element,o.firstChild),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${t.y}px`,e.element.style.left="",e.element.style.right="",e.element.style.bottom="",e.element.classList.add("docked-right"),e.element.classList.remove("custom-position","left-edge","faded-ui","offset"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t.y<400?e.element.classList.add("top-edge"):e.element.classList.remove("top-edge"),Le()}else if(t.dockedBottom){const o=document.querySelector("#ui-bottom");o&&!o.contains(e.element)&&o.prepend(e.element),e.element.classList.add("docked-bottom"),e.element.classList.remove("custom-position","left-edge","top-edge","docked-right","faded-ui","offset");const a=document.querySelector("#ui-bottom #hotbar");a&&a.classList.contains("faded-ui")&&e.element.classList.add("faded-ui"),this.syncOffsetClass(e),Le()}else{document.body.appendChild(e.element),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${t.y}px`,e.element.style.left=`${t.x}px`,e.element.style.right="auto",e.element.style.bottom="auto";const o=!!document.querySelector("body.crlngn-tabs");D.addCSSVars("--flash-rolls-menu-offset",o?"0px":"16px"),e.element.classList.add("custom-position"),e.element.classList.remove("docked-right","faded-ui","offset");const a=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;t.x<a&&e.element.classList.add("left-edge"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t.y<400&&e.element.classList.add("top-edge")}}static async saveCustomPosition(e){if(!e){await game.user.setFlag(W.ID,"menuCustomPosition",null);return}const t=document.querySelector(".flash-rolls-menu");if(t){const s=t.getBoundingClientRect();e.x<0?e.x=0:e.x>window.innerWidth-s.width&&(e.x=window.innerWidth-s.width),e.y<0?e.y=0:e.y>window.innerHeight-s.height&&(e.y=window.innerHeight-s.height)}await game.user.setFlag(W.ID,"menuCustomPosition",e)}static loadCustomPosition(){return game.user.getFlag(W.ID,"menuCustomPosition")||null}static async resetPosition(e){await this.snapToDefault(e)}}w(pe,"SNAP_DISTANCE",30),w(pe,"DRAG_HANDLE_SELECTOR",".drag-handle"),w(pe,"LIGHTNING_BOLT_SELECTOR","#flash-rolls-icon");class J{static isFavorite(e){try{const t=typeof e=="string"?game.actors.get(e):e;return!t||!t.getFlag?!1:t.getFlag(b,this.FLAGS.FAVORITE)===!0}catch(t){return r.error("Error checking favorite status",[t,e]),!1}}static isBlocked(e){const t=typeof e=="string"?game.actors.get(e):e;return t?t.getFlag(b,this.FLAGS.BLOCKED)===!0:!1}static async setFavorite(e,t){const s=typeof e=="string"?game.actors.get(e):e;if(!s){r.error("Actor not found",[e]);return}r.log("ActorStatusManager.setFavorite",[s.name,t]),t?(await s.setFlag(b,this.FLAGS.FAVORITE,!0),await s.unsetFlag(b,this.FLAGS.BLOCKED)):await s.unsetFlag(b,this.FLAGS.FAVORITE),this._refreshMenu()}static async setBlocked(e,t){const s=typeof e=="string"?game.actors.get(e):e;if(!s){r.error("Actor not found",[e]);return}t?(await s.setFlag(b,this.FLAGS.BLOCKED,!0),await s.unsetFlag(b,this.FLAGS.FAVORITE)):await s.unsetFlag(b,this.FLAGS.BLOCKED),this._refreshMenu()}static async toggleFavorite(e,t){const s=t?!0:!this.isFavorite(e);await this.setFavorite(e,s)}static async toggleBlocked(e,t){const s=t?!0:!this.isBlocked(e);await this.setBlocked(e,s)}static async blockActor(e){await this.setBlocked(e,!0)}static getFavoriteActors(){return game.actors.filter(e=>this.isFavorite(e))}static getBlockedActors(){return game.actors.filter(e=>this.isBlocked(e))}static filterBlocked(e){return e.filter(t=>!this.isBlocked(t))}static getActorStatus(e){return{isFavorite:this.isFavorite(e),isBlocked:this.isBlocked(e)}}static async clearActorStatus(e){const t=typeof e=="string"?game.actors.get(e):e;t&&(await t.unsetFlag(b,this.FLAGS.FAVORITE),await t.unsetFlag(b,this.FLAGS.BLOCKED),this._refreshMenu())}static _refreshMenu(){V.refreshIfOpen()}static getContextMenuOptions(e,t){return game.user.isGM&&(t.push({name:"FLASH_ROLLS.contextMenu.toggleFavorite",icon:'<i class="fas fa-bolt"></i>',callback:s=>{const o=s.data("documentId")||s.dataset.entryId;o&&this.toggleFavorite(o)},condition:s=>game.user.isGM}),t.push({name:"FLASH_ROLLS.contextMenu.toggleBlocked",icon:'<i class="fas fa-ban"></i>',callback:s=>{const o=s.data("documentId")||s.dataset.entryId;o&&this.toggleBlocked(o)},condition:s=>game.user.isGM})),t}}w(J,"FLAGS",{FAVORITE:"isFavorite",BLOCKED:"isBlocked"});class ts{static initializeActorDrag(e){e.element.querySelectorAll('.actor-list .actor.drag-wrapper[draggable="true"]').forEach(o=>{o.addEventListener("dragstart",a=>this.handleDragStart(a,e)),o.addEventListener("dragend",a=>this.handleDragEnd(a,e))});const s=e.element;s.addEventListener("dragover",o=>this.handleDragOver(o)),s.addEventListener("drop",o=>this.handleDrop(o,e)),document.addEventListener("dragover",o=>this.handleGlobalDragOver(o,e)),document.addEventListener("drop",o=>this.handleGlobalDrop(o,e))}static handleDragStart(e,t){const s=e.currentTarget,o=s.dataset.actorId,a=game.actors.get(o);if(!a){e.preventDefault();return}r.log("ActorDragUtil.handleDragStart",[a.name,o]),e.dataTransfer.setData("text/plain",o),e.dataTransfer.setData("application/json",JSON.stringify({actorId:o,actorName:a.name,uniqueId:s.dataset.id,tokenId:s.dataset.tokenId||null})),e.dataTransfer.effectAllowed="move",s.classList.add("dragging");const i=s.getBoundingClientRect(),l=document.createElement("div");l.style.width=i.width+"px",l.style.height=i.height+"px",l.style.backgroundColor="rgba(0, 0, 0, 0.1)",l.style.border="2px dashed rgba(255, 255, 255, 0.3)",l.style.borderRadius="4px",l.style.opacity="0.6",l.style.position="absolute",l.style.top="-1000px",l.style.left="-1000px",l.style.pointerEvents="none",document.body.appendChild(l),e.dataTransfer.setDragImage(l,i.width/2,i.height/2),setTimeout(()=>{l.parentNode&&l.parentNode.removeChild(l)},0),t._currentDragData={actorId:o,actorElement:s,startTime:Date.now()}}static createGroupDragImage(e,t){const s=document.createElement("div");s.className="actor actor-group drag-wrapper",s.style.background=getComputedStyle(e).background,s.style.border=getComputedStyle(e).border,s.style.borderRadius=getComputedStyle(e).borderRadius,s.style.padding=getComputedStyle(e).padding;const o=e.querySelector(".actor-img");if(o){const i=o.cloneNode(!0);s.appendChild(i)}const a=document.createElement("div");return a.className="actor-name",a.textContent=t.name,a.style.color=getComputedStyle(e.querySelector(".actor-name")||e).color,a.style.fontSize=getComputedStyle(e.querySelector(".actor-name")||e).fontSize,a.style.fontWeight="bold",a.style.textAlign="center",a.style.marginTop="4px",s.appendChild(a),s}static createStandardDragImage(e){const t=document.createElement("div");t.className=e.className,t.style.background=getComputedStyle(e).background,t.style.border=getComputedStyle(e).border,t.style.borderRadius=getComputedStyle(e).borderRadius,t.style.padding=getComputedStyle(e).padding,t.style.display="flex",t.style.alignItems="center",t.style.gap="8px";const s=e.querySelector(".actor-img");if(s){const a=s.cloneNode(!0);t.appendChild(a)}const o=e.querySelector(".actor-name");if(o){const a=o.cloneNode(!0);t.appendChild(a)}return t}static handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="none"}static handleDrop(e,t){e.preventDefault(),r.log("ActorDragUtil.handleDrop - dropped within menu, canceling remove"),this.cleanupDrag(t)}static handleGlobalDragOver(e,t){if(!t._currentDragData)return;const s=t.element,o=document.elementFromPoint(e.clientX,e.clientY);s&&(s.contains(o)||s===o)?(e.dataTransfer.dropEffect="none",t._currentDragData.actorElement&&t._currentDragData.actorElement.classList.remove("drag-remove-zone")):(e.preventDefault(),e.dataTransfer.dropEffect="move",t._currentDragData.actorElement&&t._currentDragData.actorElement.classList.add("drag-remove-zone"))}static handleGlobalDrop(e,t){if(!t._currentDragData)return;const s=t.element,o=document.elementFromPoint(e.clientX,e.clientY);if(!(s&&(s.contains(o)||s===o))){e.preventDefault();const i=JSON.parse(e.dataTransfer.getData("application/json"));r.log("ActorDragUtil.handleGlobalDrop - blocking actor",[i.actorName]),this.blockActor(i.actorId,t)}this.cleanupDrag(t)}static handleDragEnd(e,t){r.log("ActorDragUtil.handleDragEnd"),setTimeout(()=>{this.cleanupDrag(t)},100)}static async blockActor(e,t){try{await J.blockActor(e);const s=t.element.querySelector(`[data-actor-id="${e}"]`);if(s){const o=s.dataset.id;t.selectedActors.delete(o)}}catch(s){r.error("Error blocking actor",[s]),ui.notifications.error(`Failed to block actor: ${s.message}`)}}static cleanupDrag(e){var t;(t=e._currentDragData)!=null&&t.actorElement&&e._currentDragData.actorElement.classList.remove("dragging","drag-remove-zone"),e._currentDragData=null}static removeDragListeners(e){document.removeEventListener("dragover",this.handleGlobalDragOver),document.removeEventListener("drop",this.handleGlobalDrop)}}class Me{static canDrop(e){return r.log("ActorDropUtil.canDrop",[e]),game.user.isGM}static handleDragOver(e,t){r.log("ActorDropUtil.handleDragOver",[e,e.currentTarget,e.target]),e.preventDefault(),e.stopPropagation(),e.dataTransfer&&(e.dataTransfer.dropEffect="copy",r.log("ActorDropUtil.handleDragOver - dataTransfer types:",[e.dataTransfer.types]));const s=e.currentTarget.closest(".actor-list, .actors");return s&&(s.classList.add("drag-over"),r.log("ActorDropUtil.handleDragOver - added drag-over class")),!1}static handleDragLeave(e){if(r.log("ActorDropUtil.handleDragLeave",[e,e.currentTarget,e.target]),!e.currentTarget||typeof e.currentTarget.getBoundingClientRect!="function"){document.querySelectorAll(".drag-over").forEach(a=>{a.classList.remove("drag-over")}),r.log("ActorDropUtil.handleDragLeave - removed drag-over class from all elements (global cleanup)");return}const t=e.currentTarget.getBoundingClientRect();if(e.clientX<t.left||e.clientX>t.right||e.clientY<t.top||e.clientY>t.bottom){const o=e.currentTarget.closest(".actor-list, .actors");o&&(o.classList.remove("drag-over"),r.log("ActorDropUtil.handleDragLeave - removed drag-over class"))}}static async handleDrop(e,t){e.preventDefault(),e.stopPropagation();for(let o=0;o<e.dataTransfer.types.length;o++){const a=e.dataTransfer.types[o],i=e.dataTransfer.getData(a);r.log(`ActorDropUtil.handleDrop - ${a}:`,[i])}t.element.querySelectorAll(".drag-over").forEach(o=>{o.classList.remove("drag-over")}),r.log("ActorDropUtil.handleDrop - removed drag-over class from all elements");try{const o=this.parseDragData(e);if(!o||o.type!=="Actor"){r.log("ActorDropUtil.handleDrop - Invalid drag data",[o]);return}const a=await this.getActorFromDragData(o);if(!a){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.actorNotFound")||"Actor not found");return}const l=et(a)?"pc":"npc";t.currentTab!==l&&(t.currentTab=l),await this.addActorToMenu(a,t)}catch(o){r.error("ActorDropUtil.handleDrop - Error processing drop",[o]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.dropError")||"Error adding actor to menu")}}static parseDragData(e){try{const t=e.dataTransfer.getData("application/json");if(t)return JSON.parse(t);const s=e.dataTransfer.getData("text/plain");if(s){if(s.startsWith("Actor."))return{type:"Actor",uuid:s};try{return JSON.parse(s)}catch{r.log("ActorDropUtil.parseDragData - Text is not JSON")}}return null}catch(t){return r.error("ActorDropUtil.parseDragData - Error parsing drag data",[t]),null}}static async getActorFromDragData(e){try{return e.uuid?await fromUuid(e.uuid):e.id?game.actors.get(e.id):null}catch(t){return r.error("ActorDropUtil.getActorFromDragData - Error getting actor",[t]),null}}static async addActorToMenu(e,t){const s=J.isBlocked(e);if(J.isFavorite(e)&&!s){ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.actorAlreadyAdded",{actor:e.name})||`${e.name} is already in the menu`);return}await J.setFavorite(e,!0)}}class fe{static async toggleMovementForSelected(e){if(e.selectedActors.size===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const t=[];for(const i of e.selectedActors){const l=ee(i);if(!l){r.log(`TokenMovementManager: No actor found for uniqueId: ${i}`);continue}const n=this.getTokensForActor(l.id,i);r.log(`TokenMovementManager: Found ${n.length} tokens for actor ${l.name} (${l.id})`),t.push(...n)}if(t.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noTokensForMovementLock"));return}const s=this.getMovementStatus(t),o=s.restricted<s.unrestricted;r.log(`TokenMovementManager: Before toggle - ${s.restricted} restricted, ${s.unrestricted} unrestricted, shouldLock: ${o}`),await this.setMovementRestriction(t,o),V.refreshIfOpen();const a=o?"movementLocked":"movementUnlocked";ui.notifications.info(game.i18n.format(`FLASH_ROLLS.notifications.${a}`,{count:t.length})),r.log(`TokenMovementManager: ${o?"Locked":"Unlocked"} movement for ${t.length} tokens`)}static async _setMovementForSelected(e,t){if(e.selectedActors.size===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const s=[];for(const a of e.selectedActors){const i=ee(a);if(!i)continue;const l=this.getTokensForActor(i.id,a);s.push(...l)}if(s.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noTokensForMovementLock"));return}await this.setMovementRestriction(s,t);const o=t?"movementLocked":"movementUnlocked";ui.notifications.info(game.i18n.format(`FLASH_ROLLS.notifications.${o}`,{count:s.length})),r.log(`TokenMovementManager: ${t?"Locked":"Unlocked"} movement for ${s.length} tokens`)}static getTokensForActor(e,t){const s=[],o=game.scenes.current;if(!o)return s;if(t!==e){const a=o.tokens.get(t);a&&a.actorId===e&&s.push(a)}else{const a=o.tokens.filter(i=>i.actorId===e);s.push(...a)}return s}static async setMovementRestriction(e,t){const s=e.map(o=>{let a;if(t){const i={type:"manual",enabled:!0,source:"gm",metadata:{restrictedAt:Date.now(),restrictedBy:game.user.id}};a={_id:o.id,flags:{[b]:{movementRestriction:i}}}}else a={_id:o.id,[`flags.${b}.-=movementRestriction`]:null};return a});if(s.length>0)try{r.log(`TokenMovementManager: Updating ${s.length} tokens with updates:`,s),await game.scenes.current.updateEmbeddedDocuments("Token",s),r.log(`TokenMovementManager: Successfully updated ${s.length} tokens with movement restriction: ${t}`);for(const o of s){const a=game.scenes.current.tokens.get(o._id);if(a){const i=a.getFlag(b,"movementRestriction");r.log(`TokenMovementManager: After update, token ${a.name} restriction is:`,i)}}}catch(o){r.error("TokenMovementManager: Failed to update token movement restrictions",[o]),ui.notifications.error("Failed to update token movement restrictions")}}static isMovementRestricted(e){const t=e.getFlag(b,"movementRestriction");return(t==null?void 0:t.enabled)===!0}static isMovementAllowed(e,t,s){if(t.isGM||!(s.x!==void 0||s.y!==void 0))return!0;const a=e.getFlag(b,"movementRestriction");return a!=null&&a.enabled?(r.log(`TokenMovementManager: Movement blocked for token ${e.name} by user ${t.name}`),!1):!0}static getMovementStatus(e){let t=0,s=0;return e.forEach(o=>{this.isMovementRestricted(o)?t++:s++}),{restricted:t,unrestricted:s,total:e.length,hasRestricted:t>0,hasUnrestricted:s>0,allRestricted:t===e.length,allUnrestricted:s===e.length}}static getStatusIcon(e){return e.allRestricted?"fa-user-lock":e.allUnrestricted?"fa-person-walking":"fa-user-slash"}static async clearAllRestrictions(e){await this.setMovementRestriction(e,!1)}static async onCombatStart(e,t){var l;const s=E();if(!C.get((l=s.autoBlockMovementInCombat)==null?void 0:l.tag))return;r.log("TokenMovementManager: Combat started, applying movement restrictions");const a=e.combatant,i=[];for(const n of e.combatants){if(n.id===(a==null?void 0:a.id))continue;const c=n.token;c&&i.push(c)}i.length>0&&(await this.setCombatMovementRestriction(i,!0),r.log(`TokenMovementManager: Blocked movement for ${i.length} combatants`))}static async onCombatTurnChange(e,t,s){var l;const o=E();if(!C.get((l=o.autoBlockMovementInCombat)==null?void 0:l.tag))return;r.log("TokenMovementManager: Combat turn changed",[e,t,s]);const i=e.combatant;r.log("TokenMovementManager: Current combatant",[i]);for(const n of e.combatants){const c=n.token;if(!c)continue;const d=n.tokenId===(i==null?void 0:i.tokenId),u=!d;r.log(`TokenMovementManager: ${n.name} - isCurrentTurn: ${d}, shouldRestrict: ${u}`,[n]),await this.setCombatMovementRestriction([c],u)}r.log("TokenMovementManager: Updated movement restrictions for all combatants")}static async onCombatEnd(e){r.log("TokenMovementManager: Combat ended, removing movement restrictions");const t=[];for(const s of e.combatants){const o=s.token;if(o){const a=o.getFlag(b,"movementRestriction");(a==null?void 0:a.type)==="combat"&&t.push(o)}}t.length>0&&(await this.setCombatMovementRestriction(t,!1),r.log(`TokenMovementManager: Unblocked movement for ${t.length} combatants`))}static async setCombatMovementRestriction(e,t){const s=e.map(o=>{var i;let a;if(t){const l={type:"combat",enabled:!0,source:"system",metadata:{restrictedAt:Date.now(),combatId:(i=game.combat)==null?void 0:i.id}};a={_id:o.id,flags:{[b]:{movementRestriction:l}}}}else{const l=o.getFlag(b,"movementRestriction");if((l==null?void 0:l.type)==="combat")a={_id:o.id,[`flags.${b}.-=movementRestriction`]:null};else return null}return a}).filter(o=>o!==null);if(s.length>0)try{await game.scenes.current.updateEmbeddedDocuments("Token",s),r.log(`TokenMovementManager: Updated ${s.length} tokens with combat movement restriction: ${t}`)}catch(o){r.error("TokenMovementManager: Failed to update combat movement restrictions",[o])}}static async onCreateCombatant(e,t,s){var c;const o=E();if(!C.get((c=o.autoBlockMovementInCombat)==null?void 0:c.tag))return;const i=e.combat;if(!(i!=null&&i.started))return;const l=e.token;if(!l)return;const n=i.combatant;if(e.id===(n==null?void 0:n.id)){r.log(`TokenMovementManager: New combatant ${e.name} is current turn, allowing movement`);return}r.log(`TokenMovementManager: Blocking movement for newly added combatant ${e.name}`),await this.setCombatMovementRestriction([l],!0)}static async initializeCombatMovementRestrictions(){var a;const e=E();if(!C.get((a=e.autoBlockMovementInCombat)==null?void 0:a.tag))return;const s=game.combat;if(!(s!=null&&s.started))return;r.log("TokenMovementManager: Initializing movement restrictions for active combat");const o=s.combatant;r.log("TokenMovementManager: Current combatant on init",[o]);for(const i of s.combatants){const l=i.token;if(!l)continue;const n=i.id===(o==null?void 0:o.id),c=!n;r.log(`TokenMovementManager: Init - ${i.name} - isCurrentTurn: ${n}, shouldRestrict: ${c}`),await this.setCombatMovementRestriction([l],c)}r.log("TokenMovementManager: Initialized movement restrictions for active combat")}}const Ve=class Ve{static attachListeners(e,t){r.log("RollMenuEventManager.attachListeners"),t.querySelectorAll(".actor").length===0?(this.cleanupActorTooltips(),t.classList.add("no-actors")):t.classList.remove("no-actors"),this.attachToggleHandlers(e,t),this.attachDragHandlers(e,t),this.attachTabHandlers(e,t),this.attachActorHandlers(e,t),this.attachActionIconHandlers(e,t),this.attachCompactTooltipHandlers(e,t),this.attachSearchHandlers(e,t),this.attachAccordionHandlers(e,t),this.attachSubmenuHandlers(e,t),this.attachStatusEffectHandlers(e,t),this.attachGroupHandlers(e,t),this.attachOutsideClickHandler(e)}static attachToggleHandlers(e,t){var s,o,a,i,l,n,c,d;(s=t.querySelector("#flash-rolls-toggle"))==null||s.addEventListener("change",e._onToggleRollRequests.bind(e)),(o=t.querySelector("#flash5e-skip-dialogs"))==null||o.addEventListener("change",e._onToggleSkipDialogs.bind(e)),(a=t.querySelector("#flash5e-group-rolls-msg"))==null||a.addEventListener("change",e._onToggleGroupRollsMsg.bind(e)),(i=t.querySelector("#flash5e-actors-all"))==null||i.addEventListener("change",e._onToggleSelectAll.bind(e)),(l=t.querySelector("#flash5e-filter-actors"))==null||l.addEventListener("click",e._onToggleActorFilter.bind(e)),(n=t.querySelector("#flash5e-actors-lock"))==null||n.addEventListener("click",e._onToggleLock.bind(e)),(c=t.querySelector(".options-toggle-btn"))==null||c.addEventListener("click",e._onToggleOptions.bind(e)),(d=t.querySelector("#flash5e-open-settings"))==null||d.addEventListener("click",e._onOpenSettings.bind(e))}static attachDragHandlers(e,t){const s=t.querySelector(pe.DRAG_HANDLE_SELECTOR);s&&!s.hasAttribute("data-drag-initialized")&&(s.setAttribute("data-drag-initialized","true"),s.addEventListener("mousedown",o=>{pe.handleDragStart(o,e)}))}static attachTabHandlers(e,t){const s=t.querySelectorAll(".actor-tab");r.log("RollMenuEventManager.attachTabHandlers - found tabs:",[s.length]),s.forEach(o=>{r.log("RollMenuEventManager.attachTabHandlers - attaching to tab:",[o.dataset.tab]),o.addEventListener("click",e._onTabClick.bind(e)),o.addEventListener("dblclick",e._onTabDoubleClick.bind(e))})}static attachActionIconHandlers(e,t){var s,o,a,i,l,n,c,d;(s=t.querySelector("#flash5e-targets"))==null||s.addEventListener("click",()=>{this.toggleTargetsForSelected(e)}),(o=t.querySelector("#flash5e-heal-selected"))==null||o.addEventListener("click",()=>{this.healSelectedActors(e)}),(a=t.querySelector("#flash5e-kill-selected"))==null||a.addEventListener("click",()=>{this.killSelectedActors(e)}),(i=t.querySelector("#flash5e-sheets"))==null||i.addEventListener("click",()=>{this.openSheetsForSelected(e)}),(l=t.querySelector("#flash5e-toggle-list"))==null||l.addEventListener("change",()=>{this.toggleOptionsListOnHover(e)}),(n=t.querySelector("#flash5e-remove-effects"))==null||n.addEventListener("click",()=>{this.removeAllStatusEffectsFromSelected(e)}),(c=t.querySelector("#flash5e-group-selected"))==null||c.addEventListener("click",()=>{this.createGroupFromSelected(e)}),(d=t.querySelector("#flash5e-lock-movement"))==null||d.addEventListener("click",()=>{this.toggleMovementForSelected(e)})}static attachActorHandlers(e,t){t.querySelectorAll(".actor.drag-wrapper").forEach(s=>{s.addEventListener("click",l=>{s.hasAttribute("data-non-selectable")||e._onActorClick.call(e,l)});const o=s.querySelector(".icon-sheet");o&&o.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const n=s.dataset.actorId,c=s.dataset.tokenId;this.openActorSheetById(n,c)});const a=s.querySelector(".icon-target");a&&a.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const n=s.dataset.actorId,c=s.dataset.tokenId;this.toggleActorTargetById(n,c)});const i=s.querySelector(".actor-img");i&&(i.addEventListener("contextmenu",l=>{l.preventDefault(),l.stopPropagation();const n=s.dataset.tokenId,c=s.dataset.actorId;let d=n?canvas.tokens.get(n):null;!d&&c&&(d=canvas.tokens.placeables.find(u=>{var f;return((f=u.actor)==null?void 0:f.id)===c})),d&&canvas.animatePan({x:d.x,y:d.y,duration:250})}),i.addEventListener("mouseenter",l=>{this.showTokenSelectionPreview(s,e)}),i.addEventListener("mouseleave",l=>{this.hideTokenSelectionPreview(s,e)}))})}static cleanupActorTooltips(){document.querySelectorAll(".actor-data-tooltip").forEach(t=>t.remove())}static attachCompactTooltipHandlers(e,t){if(this.cleanupActorTooltips(),!t.classList.contains("compact"))return;t.querySelectorAll("#flash-rolls-menu.compact .actor").forEach(o=>{const a=o.querySelector(".actor-data");if(!a)return;let i=null;const l=async d=>{const u=document.querySelector(".actor-data-tooltip");u&&u.remove(),i=a.cloneNode(!0);const f=o.getBoundingClientRect(),p=t.getBoundingClientRect(),m=t.classList.contains("left-edge");if(t.hasAttribute("data-layout")&&t.getAttribute("data-layout")==="horizontal"){const S=o.querySelector(".actor-img"),R=S?S.getBoundingClientRect():f,T=R.left+R.width/2-p.left-16;i.style.left=`${T}px`,i.style.transform="translateX(-50%)",i.style.bottom=`${p.bottom-f.top+8}px`,i.style.top="auto",i.style.right="auto"}else m?i.style.left=`${f.right-p.left-8}px`:i.style.right=`${p.right-f.left-8}px`,i.style.top=`${f.top-p.top}px`;i.className="actor-data-tooltip",document.querySelector("#flash-rolls-menu").appendChild(i),setTimeout(()=>{i==null||i.classList.add("visible")},e.selectedActors.size>0?300:0)},n=()=>{i&&(i.remove(),i=null)};o.addEventListener("mouseenter",l),o.addEventListener("mouseleave",n);const c=o.closest("ul");c&&c.addEventListener("scroll",n)})}static attachSearchHandlers(e,t){const s=t.querySelector(".search-input");s&&(s.addEventListener("input",e._onSearchInput.bind(e)),s.addEventListener("click",o=>{o.target.select()}),s.addEventListener("focus",o=>{o.target.select(),e.isSearchFocused=!0,game.user.setFlag(b,"searchFocused",!0)}),s.addEventListener("blur",()=>{e.isSearchFocused=!1,game.user.setFlag(b,"searchFocused",!1);const o=t.querySelector(".request-types-accordion");o&&!t.matches(":hover")&&o.classList.remove("hover-visible")}))}static attachAccordionHandlers(e,t){const s=E(),o=C.get(s.showOptionsListOnHover.tag),a=t.querySelector(".request-types-accordion");if(a){const l=()=>{const c=C.get(s.showOptionsListOnHover.tag);r.log("Accordion mouseEnter",[e.isSearchFocused]),e.selectedActors.size>0&&c&&(a==null||a.classList.add("hover-visible"))},n=()=>{r.log("Accordion mouseLeave",[e.isSearchFocused]),e.isSearchFocused||a==null||a.classList.remove("hover-visible")};e._accordionMouseEnter=l,e._accordionMouseLeave=n,o?(t.addEventListener("mouseenter",l),t.addEventListener("mouseleave",n),e._accordionListenersAttached=!0):e._accordionListenersAttached=!1}const i=t.querySelector(".request-types");r.log("RollMenuEventManager.attachAccordionHandlers",[i]),i&&i.addEventListener("click",l=>{if(r.log("requestTypes click",[l.target]),l.target.classList.contains("btn-macro")){l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation();const u=l.target.closest(".sub-item")||l.target.closest(".request-type-item");if(u){const f={...l,currentTarget:u};e._onMacroButtonClick(f)}return}const n=l.target.closest(".btn-macro");if(n){l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation();const u=n.closest(".sub-item")||n.closest(".request-type-item");if(u){const f={...l,currentTarget:u};e._onMacroButtonClick(f)}return}const c=l.target.closest(".request-type-header");if(c){const u=c.closest(".request-type-item");if(c.classList.contains("accordion-header")){e._onAccordionToggle(l);return}if(c.classList.contains("toggle")&&u&&u.classList.contains("rollable")){const f={...l,currentTarget:u};e._onRequestTypeClick(f);return}}const d=l.target.closest(".sub-item");if(d&&d.dataset.id){const u={...l,currentTarget:d};e._onRollTypeClick(u)}})}static attachSubmenuHandlers(e,t){try{const s=t.querySelectorAll(".submenu-tabs li[data-tab]");r.log("RollMenuEventManager.attachSubmenuHandlers - found tabs:",[s.length]),s.forEach(o=>{o.addEventListener("click",e._onSubmenuTabClick.bind(e))})}catch(s){r.error("RollMenuEventManager.attachSubmenuHandlers error:",[s])}}static attachStatusEffectHandlers(e,t){try{const s=t.querySelectorAll(".status-effects .status-effect");r.log("RollMenuEventManager.attachStatusEffectHandlers - found effects:",[s.length]),s.forEach(o=>{o.dataset.listenerAttached||(o.dataset.listenerAttached="true",o.addEventListener("click",e._onStatusEffectClick.bind(e)))})}catch(s){r.error("RollMenuEventManager.attachStatusEffectHandlers error:",[s])}}static attachGroupHandlers(e,t){t.querySelectorAll(".group-expand-btn").forEach(o=>{o.addEventListener("click",async a=>{a.preventDefault(),a.stopPropagation();const i=o.dataset.groupId,l=e.groupExpansionStates[i]??!1;e.groupExpansionStates[i]=!l,await game.user.setFlag(b,"groupExpansionStates",e.groupExpansionStates),e.render()})})}static attachOutsideClickHandler(e){setTimeout(()=>{document.addEventListener("click",e._onClickOutside,!0)},100)}static toggleTargetsForSelected(e){e.selectedActors.forEach(t=>{const s=ee(t);if(!s)return;const o=s.id,a=game.actors.get(t)?null:t;this.toggleActorTargetById(o,a)})}static openSheetsForSelected(e){e.currentTab==="group"?this.openGroupSheetsForSelected(e):e.selectedActors.forEach(t=>{const s=ee(t);if(!s)return;const o=s.id,a=game.actors.get(t)?null:t;this.openActorSheetById(o,a)})}static openGroupSheetsForSelected(e){const s=(e._lastPreparedContext||{}).actors||[],o=new Set;s.forEach(a=>{a.isGroup&&a.members&&a.members.some(l=>e.selectedActors.has(l.uniqueId))&&!o.has(a.id)&&(this.openActorSheetById(a.id,a.tokenId),o.add(a.id))})}static healSelectedActors(e){e.selectedActors.forEach(t=>{const s=ee(t);if(!s)return;const o=s.id,a=game.actors.get(t)?null:t;this.healActorById(o,a)})}static killSelectedActors(e){e.selectedActors.forEach(t=>{const s=ee(t);if(!s)return;const o=s.id,a=game.actors.get(t)?null:t;this.killActorById(o,a)})}static async removeAllStatusEffectsFromSelected(e){if(e.selectedActors.size===0){ui.notifications.warn("No actors selected");return}let t=0,s=0;for(const o of e.selectedActors){const a=ee(o);if(!a)continue;s++;const i=a.appliedEffects.filter(l=>{var n,c,d;return((n=l.statuses)==null?void 0:n.size)>0||((d=(c=l.flags)==null?void 0:c.core)==null?void 0:d.statusId)});if(i.length>0)for(const l of i)try{await l.delete(),t++}catch(n){r.error(`Failed to remove status effect from ${a.name}`,[n])}}t>0?ui.notifications.info(`Removed ${t} status effects from ${s} actor(s)`):ui.notifications.info("No status effects to remove from selected actors")}static toggleActorTarget(e){const t=e.dataset.tokenId,s=e.dataset.actorId;let o=t?canvas.tokens.get(t):null;if(!o&&s&&(o=canvas.tokens.placeables.find(a=>{var i;return((i=a.actor)==null?void 0:i.id)===s})),o){const a=game.user.targets.has(o);o.setTarget(!a,{releaseOthers:!1})}}static openActorSheet(e){const t=e.dataset.actorId,s=e.dataset.tokenId;if(t){let o;if(s){const a=canvas.tokens.get(s);o=(a==null?void 0:a.actor)||game.actors.get(t)}else o=game.actors.get(t);o==null||o.sheet.render(!0)}}static healActor(e){var a,i;const t=e.dataset.actorId,s=e.dataset.tokenId;let o;if(s){const l=canvas.tokens.get(s);o=(l==null?void 0:l.actor)||game.actors.get(t)}else o=game.actors.get(t);if(o&&((i=(a=o.system)==null?void 0:a.attributes)!=null&&i.hp)){const l=o.system.attributes.hp.max;o.update({"system.attributes.hp.value":l})}}static killActor(e){var a,i;const t=e.dataset.actorId,s=e.dataset.tokenId;let o;if(s){const l=canvas.tokens.get(s);o=(l==null?void 0:l.actor)||game.actors.get(t)}else o=game.actors.get(t);o&&((i=(a=o.system)==null?void 0:a.attributes)!=null&&i.hp)&&o.update({"system.attributes.hp.value":0})}static toggleActorTargetById(e,t){let s=t?canvas.tokens.get(t):null;if(!s&&e&&(s=canvas.tokens.placeables.find(o=>{var a;return((a=o.actor)==null?void 0:a.id)===e})),s){const o=game.user.targets.has(s);s.setTarget(!o,{releaseOthers:!1})}}static openActorSheetById(e,t){if(e){let s;if(t){const o=canvas.tokens.get(t);s=(o==null?void 0:o.actor)||game.actors.get(e)}else s=game.actors.get(e);s==null||s.sheet.render(!0)}}static healActorById(e,t){var o,a;let s;if(t){const i=canvas.tokens.get(t);s=(i==null?void 0:i.actor)||game.actors.get(e)}else s=game.actors.get(e);if(s&&((a=(o=s.system)==null?void 0:o.attributes)!=null&&a.hp)){const i=s.system.attributes.hp.max;s.update({"system.attributes.hp.value":i})}}static killActorById(e,t){var o,a;let s;if(t){const i=canvas.tokens.get(t);s=(i==null?void 0:i.actor)||game.actors.get(e)}else s=game.actors.get(e);s&&((a=(o=s.system)==null?void 0:o.attributes)!=null&&a.hp)&&s.update({"system.attributes.hp.value":0})}static showTokenSelectionPreview(e,t){const s=e.dataset.tokenId,o=e.dataset.actorId,a=e.dataset.id;let i=s?canvas.tokens.get(s):null;if(!i&&o&&(i=canvas.tokens.placeables.find(l=>{var n;return((n=l.actor)==null?void 0:n.id)===o})),i){const l=t.selectedActors.has(a);i._controlled||(t._ignoreTokenControl=!0,i.control({releaseOthers:!1}),setTimeout(()=>{t._ignoreTokenControl=!1},50),this._hoveredTokens.add(i),i._flashRollsWasSelected=l)}}static async toggleOptionsListOnHover(e){const t=E(),s=C.get(t.showOptionsListOnHover.tag),o=e.element.querySelector(".request-types-accordion");o==null||o.classList.contains("hover-visible");const a=!s;await C.set(t.showOptionsListOnHover.tag,a),Ve.updateAccordionHoverBehaviorNoRender(e,a),a===!1||e.selectedActors.size===0?o==null||o.classList.remove("hover-visible"):a===!0&&e.selectedActors.size>0&&(o==null||o.classList.add("hover-visible"))}static updateAccordionHoverBehavior(e,t){e.render()}static updateAccordionHoverBehaviorNoRender(e,t){const s=e.element,o=s.querySelector(".request-types-accordion");!o||!e._accordionMouseEnter||(s.removeEventListener("mouseenter",e._accordionMouseEnter),s.removeEventListener("mouseleave",e._accordionMouseLeave),o.classList.remove("hover-visible"),t&&(s.addEventListener("mouseenter",e._accordionMouseEnter),s.addEventListener("mouseleave",e._accordionMouseLeave)))}static hideTokenSelectionPreview(e,t){const s=e.dataset.tokenId,o=e.dataset.actorId,a=e.dataset.id;let i=s?canvas.tokens.get(s):null;if(!i&&o&&(i=canvas.tokens.placeables.find(l=>{var n;return((n=l.actor)==null?void 0:n.id)===o})),i&&this._hoveredTokens.has(i)){const l=t.selectedActors.has(a),n=i._flashRollsWasSelected;!l&&!n&&(t._ignoreTokenControl=!0,i.release(),setTimeout(()=>{t._ignoreTokenControl=!1},50)),this._hoveredTokens.delete(i),delete i._flashRollsWasSelected}}static async createGroupFromSelected(e){if(e.selectedActors.size===0){ui.notifications.warn("No actors selected");return}const t=new Map,s={};let o=0,a=0;for(const d of e.selectedActors){const u=ee(d);if(!u)continue;a++;const f=u.id;if(t.has(f)){const p=t.get(f);p.count++,u.tokenId&&p.tokenIds.push(u.tokenId)}else t.set(f,{actor:u,count:1,tokenIds:u.tokenId?[u.tokenId]:[]}),Object.entries(u.ownership||{}).some(([m,h])=>{if(m==="default")return!1;const S=game.users.get(m);return S&&!S.isGM&&h>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER})&&o++;s[f]||(s[f]=[]),d!==u.id&&s[f].push(d)}if(t.size===0){ui.notifications.warn("No valid actors found");return}const i=o/t.size,l=i>=.5?"group":"encounter",n=l==="group"?"New Group":"New Encounter",c=[];if(l==="group")for(const[d,{actor:u,count:f}]of t){const p=game.actors.get(d);p&&c.push({actor:p,quantity:f})}else for(const[d,{actor:u,count:f}]of t)c.push({uuid:`Actor.${d}`,quantity:{value:f,formula:""}});try{const d=await Actor.create({name:n,type:l,img:"icons/svg/mystery-man.svg",system:{members:c},flags:{"flash-rolls-5e":{tokenAssociations:s}},ownership:{default:CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER,[game.user.id]:CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER}});if(d){d.sheet.render(!0);const u=Array.from(t.values()).map(({actor:f,count:p})=>p>1?`${f.name} (x${p})`:f.name).join(", ");ui.notifications.info(`Created ${l} "${d.name}" (${a} tokens, ${t.size} unique: ${u})`),r.log(`createGroupFromSelected - Created ${l}:`,{newActor:d,totalSelectedCount:a,uniqueActorCount:t.size,playerOwnedCount:o,playerOwnedRatio:i,tokenAssociations:s,members:Array.from(t.entries()).map(([f,{actor:p,count:m,tokenUuids:h}])=>({id:f,name:p.name,quantity:m,tokenUuids:h}))})}}catch(d){r.error("Failed to create group/encounter actor:",d),ui.notifications.warn(`Failed to create ${l}: ${d.message}`)}}static async toggleMovementForSelected(e){await fe.toggleMovementForSelected(e)}};w(Ve,"_hoveredTokens",new Set);let Xe=Ve;class Mt{static async applyStatusToSelected(e,t){const s=CONFIG.statusEffects.find(i=>i.id===e);if(!s){ui.notifications.warn(`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){ui.notifications.warn("No actors selected");return}let o=0,a=0;for(const i of t.selectedActors){const l=ee(i);if(!l)continue;a++,await this.applyStatusToActor(s,l)&&o++}if(o>0){const i=s.name||s.label||s.id;ui.notifications.info(`Applied "${i}" to ${o}/${a} actors`)}}static async applyStatusToActor(e,t){try{if(t.appliedEffects.find(a=>{var i,l,n;return((i=a.statuses)==null?void 0:i.has(e.id))||((n=(l=a.flags)==null?void 0:l.core)==null?void 0:n.statusId)===e.id}))return r.log(`RollMenuStatusManager: Actor ${t.name} already has status effect ${e.id}`),!1;if(t.toggleStatusEffect)return t.appliedEffects.some(i=>{var l;return(l=i.statuses)==null?void 0:l.has(e.id)})?!1:(await t.toggleStatusEffect(e.id,{active:!0}),r.log(`RollMenuStatusManager: Applied ${e.id} to ${t.name}`),!0);const o={name:e.name||e.label||e.id,icon:e.icon||e.img,statuses:[e.id],flags:{core:{statusId:e.id}}};return e.changes&&(o.changes=e.changes),await t.createEmbeddedDocuments("ActiveEffect",[o]),r.log(`RollMenuStatusManager: Applied ${e.id} to ${t.name}`),!0}catch(s){return r.error(`RollMenuStatusManager: Failed to apply status effect to ${t.name}`,[s]),!1}}static async removeStatusFromSelected(e,t){const s=CONFIG.statusEffects.find(i=>i.id===e);if(!s){ui.notifications.warn(`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){ui.notifications.warn("No actors selected");return}let o=0,a=0;for(const i of t.selectedActors){const l=ee(i);if(!l)continue;a++,await this.removeStatusFromActor(s,l)&&o++}if(o>0){const i=s.name||s.label||s.id;ui.notifications.info(`Removed "${i}" from ${o}/${a} actors`)}}static async removeStatusFromActor(e,t){try{if(t.toggleStatusEffect)return t.appliedEffects.some(a=>{var i;return(i=a.statuses)==null?void 0:i.has(e.id)})?(await t.toggleStatusEffect(e.id,{active:!1}),r.log(`RollMenuStatusManager: Removed ${e.id} from ${t.name}`),!0):!1;const s=t.appliedEffects.find(o=>{var a,i,l;return((a=o.statuses)==null?void 0:a.has(e.id))||((l=(i=o.flags)==null?void 0:i.core)==null?void 0:l.statusId)===e.id});return s?(await s.delete(),r.log(`RollMenuStatusManager: Removed ${e.id} from ${t.name}`),!0):(r.log(`RollMenuStatusManager: Actor ${t.name} does not have status effect ${e.id}`),!1)}catch(s){return r.error(`RollMenuStatusManager: Failed to remove status effect from ${t.name}`,[s]),!1}}static async toggleStatusOnSelected(e,t){const s=CONFIG.statusEffects.find(a=>a.id===e);if(!s){ui.notifications.warn(`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){ui.notifications.warn("No actors selected");return}let o=!1;for(const a of t.selectedActors){const i=ee(a);if(!i)continue;if(i.appliedEffects.find(n=>{var c,d,u;return((c=n.statuses)==null?void 0:c.has(s.id))||((u=(d=n.flags)==null?void 0:d.core)==null?void 0:u.statusId)===s.id})){o=!0;break}}o?await this.removeStatusFromSelected(e,t):await this.applyStatusToSelected(e,t)}static getStatusEffectsForTemplate(){try{return!CONFIG.statusEffects||!Array.isArray(CONFIG.statusEffects)?(r.warn("RollMenuStatusManager: CONFIG.statusEffects not available or not an array"),[]):CONFIG.statusEffects.map(e=>({...e,displayName:e.name||e.label||e.id,iconPath:e.icon||e.img||"icons/svg/aura.svg"})).sort((e,t)=>e.displayName.localeCompare(t.displayName,void 0,{sensitivity:"base"}))}catch(e){return r.error("RollMenuStatusManager: Error getting status effects for template",[e]),[]}}}class Y{static async handleToggleRollRequests(e){const t=E(),s=e.target.checked;await C.set(t.rollRequestsEnabled.tag,s),Ke.updateRollRequestsIcon(s)}static async handleToggleSkipDialogs(e){const t=E(),s=e.target.checked;await C.set(t.skipRollDialog.tag,s)}static async handleToggleGroupRollsMsg(e){const t=E(),s=e.target.checked;await C.set(t.groupRollsMsgEnabled.tag,s)}static handleToggleSelectAll(e,t){const s=E(),o=e.target.checked;t._ignoreTokenControl=!0;const a=t._lastPreparedContext||{};(t.currentTab==="group"?a.groups||[]:a.actors||[]).forEach(c=>{if(c.isGroup&&c.members)c.members.forEach(d=>{const u=d.uniqueId;o?(t.selectedActors.add(u),d.tokenId?ie(d.id,!0,d.tokenId):ie(d.id,!0)):(t.selectedActors.delete(u),d.tokenId?ie(d.id,!1,d.tokenId):ie(d.id,!1))});else{const d=c.uniqueId;o?(t.selectedActors.add(d),c.tokenId?ie(c.id,!0,c.tokenId):ie(c.id,!0)):(t.selectedActors.delete(d),c.tokenId?ie(c.id,!1,c.tokenId):ie(c.id,!1))}}),setTimeout(()=>{t._ignoreTokenControl=!1},200),t._updateGroupSelectionUI(),this.updateSelectAllState(t),t.render(),this.updateRequestTypesVisibility(t);const l=C.get(s.showOptionsListOnHover.tag),n=t.element.querySelector(".request-types-accordion");n&&(t.selectedActors.size>0&&l?n.classList.add("hover-visible"):n.classList.remove("hover-visible"))}static handleToggleLock(e,t){e.preventDefault(),t.isLocked=!t.isLocked;const s=e.currentTarget;s.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),s.classList.add(t.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open")}static async handleToggleActorFilter(e,t){e.preventDefault(),e.stopPropagation();const s=e.currentTarget,o=t.element.querySelector(".actor-filter-tooltip");if(o){o.remove();return}const a=await Y.createActorFilterTooltip(t);t.element.appendChild(a);const i=s.getBoundingClientRect(),l=t.element.getBoundingClientRect(),n=t.element.dataset.layout,c=a.getBoundingClientRect(),d=i.top-l.top,f=i.left-l.left+i.width/2-c.width/2;if(n==="horizontal")a.style.top=`${d-c.height-8}px`,a.style.left=`${f}px`;else{const p=t.element.classList.contains("left-edge"),m=i.left-l.left,S=d+i.height-c.height;p?(a.style.top=`${S}px`,a.style.left=`${m+i.width+20}px`):(a.style.top=`${S}px`,a.style.left=`${m-c.width-20}px`)}}static async handleToggleOptions(e,t){e.preventDefault(),e.stopPropagation(),t.optionsExpanded=!t.optionsExpanded,await game.user.setFlag(W.ID,"menuOptionsExpanded",t.optionsExpanded);const s=t.element.querySelector(".options-toggle");s&&s.classList.toggle("expanded",t.optionsExpanded);const o=t.element.querySelector("li.options");o&&o.classList.toggle("expanded",t.optionsExpanded)}static toggleActorSelection(e,t,s,o){const a=E();o._ignoreTokenControl=!0,o.selectedActors.has(e)?(o.selectedActors.delete(e),s?ie(t,!1,s):ie(t,!1)):(o.selectedActors.add(e),s?ie(t,!0,s):ie(t,!0)),setTimeout(()=>{o._ignoreTokenControl=!1},100),this.updateActorSelectionUI(e,o),this.updateSelectAllState(o),this.updateRequestTypesVisibilityNoRender(o);const i=C.get(a.showOptionsListOnHover.tag),l=o.element.querySelector(".request-types-accordion");l&&(o.selectedActors.size>0&&i?l.classList.add("hover-visible"):l.classList.remove("hover-visible"))}static updateActorSelectionUI(e,t){const s=t.element.querySelector(`.actor.drag-wrapper[data-id="${e}"]`);if(!s)return;const o=s.closest(".actor");if(!o)return;const a=o.querySelector(".actor-select"),i=t.selectedActors.has(e);a&&(a.checked=i),s.classList.toggle("selected",i),s.dataset.selected=i.toString()}static updateRequestTypesVisibility(e){e.render()}static updateRequestTypesVisibilityNoRender(e){const t=e.selectedActors.size>0,s=e.element.querySelector(".request-types");if(s){s.querySelectorAll(".request-type-item").forEach(l=>{l.classList.toggle("disabled",!t)});const a=Array.from(e.selectedActors).some(l=>{const n=ee(l);return(n==null?void 0:n.type)==="character"}),i=s.querySelector('[data-id="HIT_DIE"]');i&&(i.style.display=a?"":"none")}}static updateSelectAllState(e){const t=e.element.querySelector("#flash5e-actors-all");let s=0,o=0;if(e.currentTab==="group"){const i=(e._lastPreparedContext||{}).groups||[],l=[];i.forEach(n=>{n.isGroup&&n.members&&l.push(...n.members)}),o=l.length,s=l.filter(n=>e.selectedActors.has(n.uniqueId)).length}else{const a=e.currentTab==="pc"?"pc":"npc",i=e.element.querySelectorAll(`.${a}-actors .actor-item input[type="checkbox"]`);o=i.length,s=Array.from(i).filter(l=>l.checked).length}t.checked=s>0&&s===o,t.indeterminate=s>0&&s<o}static async createActorFilterTooltip(e){const t=game.user.getFlag(W.ID,"actorFilters")||{inCombat:!1,visible:!1,removeDead:!1};e.actorFilters=t;const o=await renderTemplate("modules/flash-rolls-5e/templates/actor-filter-tooltip.hbs",{filters:t}),a=document.createElement("div");a.innerHTML=o;const i=a.firstElementChild;return i.querySelectorAll('input[type="checkbox"]').forEach(l=>{l.addEventListener("change",n=>{Y.applyActorFilters(e)})}),i}static async applyActorFilters(e){const t=e.element.querySelector(".actor-filter-tooltip");if(!t)return;const s={inCombat:t.querySelector('[data-filter="inCombat"]').checked,visible:t.querySelector('[data-filter="visible"]').checked,removeDead:t.querySelector('[data-filter="removeDead"]').checked};e.actorFilters=s,await game.user.setFlag(W.ID,"actorFilters",s),e.render()}static doesActorPassFilters(e,t,s=null){if(!t.inCombat&&!t.visible&&!t.removeDead)return!0;if(t.inCombat&&!(s?s.inCombat:e.inCombat))return!1;if(t.visible){if(s){if(s.hidden)return!1}else if(!e.getActiveTokens().some(i=>!i.document.hidden))return!1}return!(t.removeDead&&e.appliedEffects.some(a=>{var i,l,n;return((i=a.statuses)==null?void 0:i.has("dead"))||((n=(l=a.flags)==null?void 0:l.core)==null?void 0:n.statusId)==="dead"}))}}class ss{static async prepareActorContext(e,t){const s=E(),o=game.actors.contents,a=[],i=[],l=[],n=game.scenes.current;for(const L of o){if(L.type==="group"||L.type==="encounter"){const A=await this.processGroupActor(L,n,e);l.push(...A);continue}if(L.type!=="character"&&L.type!=="npc")continue;const k=this.isPlayerOwnedActor(L),I=await this.processActor(L,n,e,k);k?a.push(...I):i.push(...I)}const c=e.actorFilters||{};if(c.inCombat||c.visible||c.removeDead){const L=a.filter(A=>{const M=A.tokenId?n==null?void 0:n.tokens.get(A.tokenId):null,_=(M==null?void 0:M.actor)||game.actors.get(A.id);return _?Y.doesActorPassFilters(_,c,M):!1});a.length=0,a.push(...L);const k=i.filter(A=>{const M=A.tokenId?n==null?void 0:n.tokens.get(A.tokenId):null,_=(M==null?void 0:M.actor)||game.actors.get(A.id);return _?Y.doesActorPassFilters(_,c,M):!1});i.length=0,i.push(...k);const I=l.filter(A=>{if(A.isGroup){const M=game.actors.get(A.id),_=A.tokenId?n==null?void 0:n.tokens.get(A.tokenId):null,F={inCombat:c.inCombat,visible:c.visible,removeDead:!1};return M&&Y.doesActorPassFilters(M,F,_)||A.members&&A.members.length>0}else{const M=game.actors.get(A.id);if(!M)return!1;const _=A.tokenId?n==null?void 0:n.tokens.get(A.tokenId):null;return Y.doesActorPassFilters(M,c,_)}});l.length=0,l.push(...I)}const d=C.get(s.rollRequestsEnabled.tag),u=C.get(s.skipRollDialog.tag),f=C.get(s.groupRollsMsgEnabled.tag);C.get(s.showOnlyPCsWithToken.tag);const p=C.get(s.showOptionsListOnHover.tag)??s.showOptionsListOnHover.default;r.log("Template context showOptionsListOnHover:",[p,typeof p,"tag:",s.showOptionsListOnHover.tag]);const m=e.currentTab==="pc"?a:e.currentTab==="npc"?i:l;let h=!1;if(m.length>0)if(e.currentTab==="group"){const L=[];m.forEach(k=>{k.isGroup&&k.members&&L.push(...k.members)}),h=L.length>0&&L.every(k=>e.selectedActors.has(k.uniqueId))}else h=m.every(L=>e.selectedActors.has(L.uniqueId));const S=this.buildRequestTypes(e),R=ut(e.selectedRequestType,e.selectedActors),T=Mt.getStatusEffectsForTemplate();return{...t,actors:e.currentTab==="group"?[]:m,groups:e.currentTab==="group"?m:[],currentTab:e.currentTab,isPCTab:e.currentTab==="pc",isNPCTab:e.currentTab==="npc",isGroupTab:e.currentTab==="group",selectedTab:e.currentTab,selectedSubmenu:e.selectedSubmenu,rollRequestsEnabled:d,skipRollDialog:u,groupRollsMsgEnabled:f,showOptionsListOnHover:p,selectAllOn:h,hasSelectedActors:e.selectedActors.size>0,requestTypes:S,rollTypes:R,statusEffects:T,showNames:!0,actorsLocked:e.isLocked,optionsExpanded:e.optionsExpanded,isGM:game.user.isGM,isCompact:C.get(s.compactMode.tag)}}static isPlayerOwnedActor(e){return Object.entries(e.ownership).some(([t,s])=>{const o=game.users.get(t);return o&&!o.isGM&&s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}static async processActor(e,t,s,o){var d;if(J.isBlocked(e))return[];const a=E(),i=C.get((d=a.showOnlyPCsWithToken)==null?void 0:d.tag),l=J.isFavorite(e),n=(t==null?void 0:t.tokens.filter(u=>u.actorId===e.id))||[],c=[];return o?l?c.push(...this.processFavoriteActor(e,n,s)):i?c.push(...this.processTokenOnlyActor(e,n,s)):c.push(...this.processRegularActor(e,n,s)):l?c.push(...this.processFavoriteActor(e,n,s)):c.push(...this.processTokenOnlyActor(e,n,s)),c}static processFavoriteActor(e,t,s){const o=[];if(t.length>0)t.forEach(a=>{const i=this.createActorData(e,a,s);i.isFavorite=!0,o.push(i)});else{const a=this.createActorData(e,null,s);a.isFavorite=!0,o.push(a)}return o}static processTokenOnlyActor(e,t,s){const o=[];return t.length>0&&t.forEach(a=>{const i=this.createActorData(e,a,s);o.push(i)}),o}static processRegularActor(e,t,s){const o=[];if(t.length>0)t.forEach(a=>{const i=this.createActorData(e,a,s);o.push(i)});else{const a=this.createActorData(e,null,s);o.push(a)}return o}static createActorData(e,t,s){const o=(t==null?void 0:t.actor)||e,a=ft.getActorHPData(o);return{id:e.id,uuid:e.uuid,name:t?t.name:e.name,img:e.img,selected:s.selectedActors.has((t==null?void 0:t.id)||e.id),crlngnStats:ft.getActorStats(o),hpPercent:a.hpPercent,hpColor:a.hpColor,tokenId:(t==null?void 0:t.id)||null,isToken:!!t,uniqueId:(t==null?void 0:t.id)||e.id,movementRestricted:t?fe.isMovementRestricted(t):!1}}static async processGroupActor(e,t,s){var f,p;if(J.isBlocked(e))return[];const o=E(),a=C.get((f=o.showOnlyPCsWithToken)==null?void 0:f.tag),i=(t==null?void 0:t.tokens.filter(m=>m.actorId===e.id))||[],l=[],n=[];let c=!1;const d=s.actorFilters||{},u=d.inCombat||d.visible||d.removeDead;if(e.type==="group"){const h=(e.getFlag(b,"tokenAssociationsByScene")||{})[t==null?void 0:t.id]||{};for(const S of e.system.members||[])if(S.actor&&!J.isBlocked(S.actor)){const R=S.actor.id,T=h[R]||[];if(T.length>0)for(const L of T)try{const k=fromUuidSync(L);if(k&&k.actorId===S.actor.id&&k.parent===t){if(u){const A=k.actor||S.actor;if(!Y.doesActorPassFilters(A,d,k))continue}c=!0;const I=this.createActorData(S.actor,k,s);n.push(I)}}catch{}}}else if(e.type==="encounter"){const h=(e.getFlag(b,"tokenAssociationsByScene")||{})[t==null?void 0:t.id]||{};for(const S of e.system.members||[])try{const R=await fromUuid(S.uuid);if(R&&!J.isBlocked(R)){const T=R.id,L=h[T]||[];if(L.length>0)for(const k of L)try{const I=fromUuidSync(k);if(I&&I.actorId===R.id&&I.parent===t){if(u){const M=I.actor||R;if(!Y.doesActorPassFilters(M,d,I))continue}c=!0;const A=this.createActorData(R,I,s);A.quantity=1,n.push(A)}}catch{}}}catch(R){r.log(`Failed to resolve member UUID: ${S.uuid}`,[R])}}if(a&&!(i.length>0)&&!c)return[];if(n.length===0)return[];if(i.length>0)i.forEach(m=>{var R;const h=this.createActorData(e,m,s);h.members=n,h.isGroup=!0,h.isExpanded=((R=s.groupExpansionStates)==null?void 0:R[e.id])??!1,h.memberImages=n.slice(0,4).map(T=>T.img);const S=n.filter(T=>s.selectedActors.has(T.uniqueId));S.length===0?h.selected="false":S.length===n.length?h.selected="true":h.selected="partial",l.push(h)});else{const m=this.createActorData(e,null,s);m.members=n,m.isGroup=!0,m.isExpanded=((p=s.groupExpansionStates)==null?void 0:p[e.id])??!1,m.memberImages=n.slice(0,4).map(S=>S.img);const h=n.filter(S=>s.selectedActors.has(S.uniqueId));h.length===0?m.selected="false":h.length===n.length?m.selected="true":m.selected="partial",l.push(m)}return l}static buildRequestTypes(e){const t=[];for(const[s,o]of Object.entries(W.ROLL_REQUEST_OPTIONS)){const a={id:s,name:game.i18n.localize(`FLASH_ROLLS.rollTypes.${o.name}`)||o.label,rollable:o.subList==null,hasSubList:!!o.subList,selected:e.selectedRequestType===s,expanded:e.accordionStates[s]??!1,subItems:[]};o.subList&&(a.subItems=ut(s,e.selectedActors)),t.push(a)}return t}}class qe{static async handleGMRolls(e,t,s,o){r.log("RollMenuExecutor.handleGMRolls",[e,t,s,o]);for(const a of e)await this.initiateRoll(a,t,s,o),await Be(100)}static async handleGMRollsWithTokens(e,t,s,o){var a,i;r.log("RollMenuExecutor.handleGMRollsWithTokens",[e,t,s,o]);for(const l of e){if(l.tokenId){const n=((a=canvas.tokens)==null?void 0:a.get(l.tokenId))||((i=game.scenes.active)==null?void 0:i.tokens.get(l.tokenId));n?await this.initiateRollForToken(l.actor,n,t,s,o):await this.initiateRoll(l.actor,t,s,o)}else await this.initiateRoll(l.actor,t,s,o);await Be(100)}}static async initiateRollForToken(e,t,s,o,a){r.log("RollMenuExecutor.initiateRollForToken",[e.name,t.name,s,o,a]);const i=t.controlled;i||t.control({releaseOthers:!1});try{await this.initiateRoll(e,s,o,a)}finally{i||t.release()}}static async initiateRoll(e,t,s,o){var a;r.log("RollMenuExecutor.initiateRoll",[e,t,s,o]);try{const i=t.toLowerCase();let l=s;if(i===y.HIT_DIE){const R=e.system.attributes.hd;if(R.value>0&&(l=R.largestAvailable),!l){r.warn("RollMenuExecutor.initiateRoll - No hit dice available after orchestration refill",[e.name]),X.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.noHitDice",{actor:e.name})||`No hit dice available for ${e.name}`);return}}const n={rollKey:l,groupRollId:o.groupRollId,config:{...o,rollMode:o.rollMode||game.settings.get("core","rollMode"),advantage:o.advantage||!1,disadvantage:o.disadvantage||!1,target:o.target}},c={configure:!o.fastForward&&!o.skipRollDialog,isRollRequest:!0};let d=o.rollMode||game.settings.get("core","rollMode");const u=E(),f=C.get(u.publicPlayerRolls.tag)===!0;(!(C.get(u.groupRollsMsgEnabled.tag)===!0)||!o.groupRollId)&&!o.rollMode&&f&&e&&v.isPlayerOwned(e)&&(d=CONST.DICE_ROLL_MODES.PUBLIC);const m={rollMode:d,create:o.chatMessage!==!1,isRollRequest:!0},h=((a=o.rolls)==null?void 0:a[0])||{};r.log("RollMenuExecutor.initiateRoll - rollConfig before handler",["parts:",h.parts,"data:",h.data,"rollProcessConfig:",o]);const S=se[i];S?await S(e,n,h,c,m):X.notify("warn",`Unknown roll type: ${t}`)}catch(i){r.error("RollMenuExecutor.initiateRoll error",[i]),X.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name}))}}}const{ApplicationV2:os,HandlebarsApplicationMixin:as}=foundry.applications.api;var x,Ae,$e;const ge=class ge extends as(os){constructor(t={}){r.log("RollRequestsMenu.constructor",[t]);super(t);w(this,"_onClickOutside",t=>{const s=this.element;if(!s)return;const o=s.querySelector(".actor-filter-tooltip");if(o&&!t.target.closest(".actor-filter-tooltip")&&!t.target.closest("#flash5e-filter-actors")){o.remove();return}this.isLocked||t.target.closest(".flash-rolls-menu")||s.contains(t.target)||this.close()});this.selectedActors=new Set,this.currentTab="pc",this.selectedSubmenu="request-types",this.selectedRequestType=null,this.isLocked=!1,this.optionsExpanded=game.user.getFlag(W.ID,"menuOptionsExpanded")??!1,this.accordionStates=game.user.getFlag(W.ID,"menuAccordionStates")??{},this.groupExpansionStates=game.user.getFlag(W.ID,"groupExpansionStates")??{},this.isSearchFocused=game.user.getFlag("flash-rolls-5e","searchFocused")??!1,this.actorFilters=game.user.getFlag(W.ID,"actorFilters")??{inCombat:!1,visible:!1,removeDead:!1},this.isDragging=!1,this.isCustomPosition=!1,this.customPosition=pe.loadCustomPosition(),this._initializeFromSelectedTokens()}static get DEFAULT_OPTIONS(){C.updateColorScheme();const t=["flash-rolls-menu","themed"];return C.coreColorScheme&&t.push(`theme-${C.coreColorScheme}`),{id:"flash-rolls-menu",classes:t,tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:{},dragDrop:[{dropSelector:".actor-list"}]}}async _prepareContext(t){const s=await super._prepareContext(t),o=await ss.prepareActorContext(this,s),a=E();return o.menuLayout=C.get(a.menuLayout.tag),o.enabledModuleIcons=Te.getEnabledIcons("moduleActions"),o.enabledActorIcons=Te.getEnabledIcons("actorActions"),o.iconConfigs=Te.getIconConfigurations(),this._lastPreparedContext=o,o}async _renderFrame(t){const s=await super._renderFrame(t),o=this.customPosition||pe.loadCustomPosition();o!=null&&o.isCustom&&(this.isCustomPosition=!0,this.customPosition=o);const a=document.querySelector("#chat-notifications");return a&&s&&a.insertBefore(s,a.firstChild),s}_onRender(t,s){super._onRender(t,s);const o=document.querySelector("#flash-rolls-menu");if(o){const i=E();C.get(i.compactMode.tag)?o.classList.add("compact"):o.classList.remove("compact");const n=C.get(i.menuLayout.tag);o.setAttribute("data-layout",n)}pe.applyCustomPosition(this,this.customPosition),this._dragDrop&&this._dragDrop.length>0&&this._dragDrop.forEach((i,l)=>{r.log(`_onRender - DragDrop handler ${l}:`,[i,i.dropSelector,i.callbacks])});const a=this.element.querySelectorAll(".actor-list");if(this._boundGlobalDragEnd&&document.removeEventListener("dragend",this._boundGlobalDragEnd),a.forEach((i,l)=>{i.removeEventListener("dragover",this._boundDragOver),i.removeEventListener("drop",this._boundDrop),i.removeEventListener("dragenter",this._boundDragEnter),i.removeEventListener("dragleave",this._boundDragLeave),this._boundDragOver=n=>{this._onDragOver(n)},this._boundDrop=n=>{this._onDrop(n)},this._boundDragEnter=n=>{n.preventDefault()},this._boundDragLeave=n=>{Me.handleDragLeave(n)},i.addEventListener("dragover",this._boundDragOver),i.addEventListener("drop",this._boundDrop),i.addEventListener("dragenter",this._boundDragEnter),i.addEventListener("dragleave",this._boundDragLeave)}),this._boundGlobalDragEnd=i=>{this._onGlobalDragEnd(i)},document.addEventListener("dragend",this._boundGlobalDragEnd),Le(),this.optionsExpanded){const i=this.element.querySelector(".options-toggle"),l=this.element.querySelector("li.options");this.element.querySelector(".options-toggle-btn"),i==null||i.classList.add("expanded"),l==null||l.classList.add("expanded")}this._tokenControlHook=Hooks.on(O.CONTROL_TOKEN,this._onTokenControlChange.bind(this)),this._updateItemHook=Hooks.on(O.UPDATE_ITEM,this._onItemUpdate.bind(this)),this._createItemHook=Hooks.on(O.CREATE_ITEM,this._onItemUpdate.bind(this)),this._deleteItemHook=Hooks.on(O.DELETE_ITEM,this._onItemUpdate.bind(this)),ts.initializeActorDrag(this),this._updateRequestTypesVisibilityNoRender(),Xe.attachListeners(this,this.element)}_onTokenControlChange(t,s){this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{const o=new Set(this.selectedActors);this._initializeFromSelectedTokens();const a=new Set([...o,...this.selectedActors]);for(const i of a)this._updateActorSelectionUI(i);this._updateGroupSelectionUI(),this._updateSelectAllState(),this._updateRequestTypesVisibilityNoRender(),this._tokenUpdateTimeout=null},100)))}_onItemUpdate(t,s,o,a){var u,f;if(!this.rendered||!(t.type==="equipment"||((u=s.system)==null?void 0:u.equipped)!==void 0||((f=s.system)==null?void 0:f.attunement)!==void 0))return;const l=t.parent;if(!l||l.documentName!=="Actor")return;const n=this.currentTab,c=Object.entries(l.ownership).some(([p,m])=>{const h=game.users.get(p);return h&&!h.isGM&&m>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER});(n==="pc"&&c||n==="npc"&&!c&&Et(l)||n==="group")&&(this._itemUpdateTimeout&&clearTimeout(this._itemUpdateTimeout),this._itemUpdateTimeout=setTimeout(()=>{this.render(),this._itemUpdateTimeout=null},500))}async _onToggleRollRequests(t){return Y.handleToggleRollRequests(t)}async _onToggleSkipDialogs(t){return Y.handleToggleSkipDialogs(t)}async _onToggleGroupRollsMsg(t){return Y.handleToggleGroupRollsMsg(t)}_onToggleSelectAll(t){return Y.handleToggleSelectAll(t,this)}_onToggleActorFilter(t){return Y.handleToggleActorFilter(t,this)}_onToggleLock(t){return Y.handleToggleLock(t,this)}async _onToggleOptions(t){return Y.handleToggleOptions(t,this)}async _onOpenSettings(t){t.preventDefault(),t.stopPropagation(),new xe().render(!0)}_canDragDrop(t){return Me.canDrop(t)}_onDragOver(t){Me.handleDragOver(t,this)}async _onDrop(t){await Me.handleDrop(t,this)}_onGlobalDragEnd(t){Me.handleDragLeave(t)}async close(t={}){return this._boundGlobalDragEnd&&(document.removeEventListener("dragend",this._boundGlobalDragEnd),this._boundGlobalDragEnd=null),super.close(t)}_initializeFromSelectedTokens(){var s,o,a;r.log("_initializeFromSelectedTokens called",{_ignoreTokenControl:this._ignoreTokenControl,currentSelectedActors:Array.from(this.selectedActors),controlledTokensCount:((o=(s=canvas.tokens)==null?void 0:s.controlled)==null?void 0:o.length)||0});const t=((a=canvas.tokens)==null?void 0:a.controlled)||[];this.selectedActors.clear();for(const i of t)if(i.actor){const l=i.id;this.selectedActors.add(l)}}async _onTabClick(t){const s=t.currentTarget.dataset.tab;r.log("_onTabClick #0",[s]),this.selectedRequestType=null,this.currentTab=s,await this.render()}async _onTabDoubleClick(t){var s;t.preventDefault(),t.stopPropagation(),this._ignoreTokenControl=!0,this.selectedActors.clear(),(s=canvas.tokens)==null||s.releaseAll(),this.selectedRequestType=null,setTimeout(()=>{this._ignoreTokenControl=!1},200),await this.render(),this._updateRequestTypesVisibility()}async _onSubmenuTabClick(t){const s=t.currentTarget.dataset.tab;if(r.log("_onSubmenuTabClick",[s]),s===this.selectedSubmenu)return;this.selectedSubmenu=s,await this.render();const o=this.element.querySelector(".request-types-accordion");o&&this.selectedActors.size>0&&o.classList.add("hover-visible")}async _onStatusEffectClick(t){t.preventDefault(),t.stopPropagation();const s=t.currentTarget.dataset.id;r.log("_onStatusEffectClick",[s]),await Mt.toggleStatusOnSelected(s,this)}_onActorClick(t){if(t.target.closest(".actor-select"))return;const s=t.currentTarget,o=s.dataset.id,a=s.dataset.actorId,i=s.dataset.tokenId;s.classList.contains("actor-group")?this._toggleGroupSelection(a):this._toggleActorSelection(o,a,i)}_toggleActorSelection(t,s,o){return Y.toggleActorSelection(t,s,o,this)}async _toggleGroupSelection(t){const s=game.actors.get(t);if(!s||s.type!=="group"&&s.type!=="encounter")return;const o=game.scenes.current,i=(s.getFlag(b,"tokenAssociationsByScene")||{})[o==null?void 0:o.id]||{},l=[],n=Object.entries(i).some(([d,u])=>!Array.isArray(u)||u.length===0?!1:u.some(f=>{try{const p=fromUuidSync(f);return p&&p.actorId===d&&p.parent===o}catch{return!1}}));if(s.type==="group"){for(const d of s.system.members||[])if(d.actor){const u=d.actor.id,f=i[u]||[];if(n&&f.length>0)for(const p of f)try{const m=fromUuidSync(p);m&&m.actorId===d.actor.id&&m.parent===o&&l.push({actor:d.actor,uniqueId:m.id})}catch(m){r.log(`Failed to resolve token UUID: ${p}`,[m])}}}else if(s.type==="encounter")for(const d of s.system.members||[])try{const u=await fromUuid(d.uuid);if(u){const f=u.id,p=i[f]||[];if(n&&p.length>0)for(const m of p)try{const h=fromUuidSync(m);h&&h.actorId===u.id&&h.parent===o&&l.push({actor:u,uniqueId:h.id})}catch(h){console.warn(`Failed to resolve token UUID: ${m}`,h)}else if(!n){const m=(o==null?void 0:o.tokens.filter(h=>h.actorId===u.id))||[];m.length>0?m.forEach(h=>{l.push({actor:u,uniqueId:h.id})}):l.push({actor:u,uniqueId:u.id})}}}catch(u){console.warn(`Failed to resolve member UUID: ${d.uuid}`,u)}if(l.length===0)return;const c=l.every(d=>this.selectedActors.has(d.uniqueId));for(const d of l){const u=d.uniqueId!==d.actor.id?d.uniqueId:null;c?this.selectedActors.has(d.uniqueId)&&this._toggleActorSelection(d.uniqueId,d.actor.id,u):this.selectedActors.has(d.uniqueId)||this._toggleActorSelection(d.uniqueId,d.actor.id,u)}this._updateGroupSelectionUI(t,l)}_updateActorSelectionUI(t){return Y.updateActorSelectionUI(t,this)}_updateGroupSelectionUI(t=null,s=null){t&&s?this._updateSingleGroupSelection(t,s):((this._lastPreparedContext||{}).groups||[]).forEach(i=>{i.isGroup&&i.members&&this._updateSingleGroupSelection(i.id,i.members)})}_updateSingleGroupSelection(t,s){this.element.querySelectorAll(`[data-actor-id="${t}"].actor-group`).forEach(a=>{const i=s.filter(n=>this.selectedActors.has(n.uniqueId)).length;let l;i===0?l="false":i===s.length?l="true":l="partial",a.setAttribute("data-group-selected",l),a.classList.remove("selected")})}_updateRequestTypesVisibility(){return Y.updateRequestTypesVisibility(this)}_updateRequestTypesVisibilityNoRender(){return Y.updateRequestTypesVisibilityNoRender(this)}_updateSelectAllState(){return Y.updateSelectAllState(this)}_onSearchInput(t){const s=t.target.value.toLowerCase().trim();if(this.selectedSubmenu==="request-types"){const o=this.element.querySelector(".request-types");if(!o)return;o.querySelectorAll(".request-type-item").forEach(i=>{var d;const l=((d=i.querySelector(".request-type-name"))==null?void 0:d.textContent.toLowerCase())||"",n=i.querySelectorAll(".sub-item");let c=!1;if(n.length>0){n.forEach(p=>{var S;const h=(((S=p.querySelector(".sub-item-name"))==null?void 0:S.textContent.toLowerCase())||"").includes(s);p.classList.toggle("hidden",!h),h&&(c=!0)});const u=l.includes(s),f=s===""||u||c;if(i.classList.toggle("hidden",!f),s&&c){const p=i.querySelector(".roll-types-nested"),m=i.querySelector(".accordion-toggle");p&&m&&(p.style.display="block",m.classList.add("expanded"))}}else{const u=s===""||l.includes(s);i.classList.toggle("hidden",!u)}})}else if(this.selectedSubmenu==="status-effects"){const o=this.element.querySelector(".status-effects");if(!o)return;o.querySelectorAll(".status-effect").forEach(i=>{var d,u;const l=((d=i.querySelector(".status-effect-name"))==null?void 0:d.textContent.toLowerCase())||"",n=((u=i.dataset.id)==null?void 0:u.toLowerCase())||"",c=s===""||l.includes(s)||n.includes(s);i.classList.toggle("hidden",!c)})}}async _onAccordionToggle(t){t.stopPropagation();const o=t.target.closest(".request-type-header").closest(".request-type-item"),a=o.dataset.id,i=o.querySelector(".accordion-toggle"),l=o.querySelector(".roll-types-nested");if(!l)return;const n=i.classList.contains("expanded");i.classList.toggle("expanded",!n),l.style.display=n?"none":"flex",this.accordionStates[a]=!n,await game.user.setFlag(W.ID,"menuAccordionStates",this.accordionStates)}async _onRequestTypeClick(t){const o=t.currentTarget.dataset.id,a=W.ROLL_REQUEST_OPTIONS[o];if(!a){r.error("Unknown request type:",[o]);return}this.selectedRequestType===o?this.selectedRequestType=null:this.selectedRequestType=o,a.subList?await this.render():this.selectedRequestType&&this._triggerRoll(o,null)}_onRollTypeClick(t){r.log("_onRollTypeClick");const s=t.currentTarget.dataset.id,a=t.currentTarget.dataset.parent||this.selectedRequestType;this._triggerRoll(a,s)}async _onMacroButtonClick(t){r.log("_onMacroButtonClick");const s=t.currentTarget,o=s.dataset.id||null,a=s.dataset.parent;let i,l;if(a?(i=a,l=o):(i=o,l=null),!i){ui.notifications.warn("No roll type selected for macro creation");return}const n=Array.from(this.selectedActors);if(n.length===0){ui.notifications.warn("No actors selected for macro creation");return}const c={requestType:i,rollKey:l,actorIds:n,config:{}};try{await FlashRolls5e.createMacro(c)}catch(d){r.error("Failed to create macro",[d]),ui.notifications.error("Failed to create macro: "+d.message)}}async _orchestrateRollsForActors(t,s,o,a,i,l){return Ce.orchestrateRollsForActors(t,s,o,a,i,l,this)}async _handleHitDieRefill(t){return Ce.handleHitDieRefill(t)}async _triggerRoll(t,s){return Ce.triggerRoll(t,s,this)}async _sendRollRequestToPlayer(t,s,o,a,i,l=!1,n=null){return Ce.sendRollRequestToPlayer(t,s,o,a,i,l,n)}_showConsolidatedNotification(t,s,o){return Ce.showConsolidatedNotification(t,s,o)}async _handleGMRolls(t,s,o,a){return qe.handleGMRolls(t,s,o,a)}async _handleGMRollsWithTokens(t,s,o,a){return qe.handleGMRollsWithTokens(t,s,o,a)}async _initiateRollForToken(t,s,o,a,i){return qe.initiateRollForToken(t,s,o,a,i)}async _initiateRoll(t,s,o,a){return qe.initiateRoll(t,s,o,a)}async _onClose(t){if(r.log("_onClose",[t]),!!this.element){if(this.isCustomPosition&&this.element.parentElement===document.body){const s=document.querySelector("#chat-notifications");s&&s.insertBefore(this.element,s.firstChild),this.element.style.position="",this.element.style.inset="",this.element.style.top="",this.element.style.left="",this.element.style.right="",this.element.style.bottom="",this.element.classList.remove("custom-position")}await super._onClose(t),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),game.user.setFlag(b,"searchFocused",!1),this._cleanupHooks(),this._cleanupTimeouts(),P(ge,x)===this&&he(ge,x,null)}}setPosition(t={}){return r.log("setPosition"),this}_cleanupHooks(){[{hook:O.CONTROL_TOKEN,property:"_tokenControlHook"},{hook:O.UPDATE_ITEM,property:"_updateItemHook"},{hook:O.CREATE_ITEM,property:"_createItemHook"},{hook:O.DELETE_ITEM,property:"_deleteItemHook"}].forEach(({hook:s,property:o})=>{this[o]&&(Hooks.off(s,this[o]),this[o]=null)})}_cleanupTimeouts(){["_tokenUpdateTimeout","_actorUpdateTimeout","_itemUpdateTimeout"].forEach(s=>{this[s]&&(clearTimeout(this[s]),this[s]=null)})}static toggle(){document.querySelectorAll("#flash-rolls-menu").forEach(s=>{s.remove()}),P(this,x)?P(this,x).rendered?P(this,x).close():(P(this,x)._initializeFromSelectedTokens(),P(this,x).render(!0)):(he(this,x,new ge),P(this,x).render(!0))}static refreshIfOpen(t=!1){if(!(!P(this,x)||!P(this,x).rendered)){if(t){this._performRefresh();return}P(this,Ae)&&clearTimeout(P(this,Ae)),he(this,Ae,setTimeout(()=>{this._performRefresh(),he(this,Ae,null)},P(this,$e)))}}static _performRefresh(){!P(this,x)||!P(this,x).rendered||P(this,x).render()}static getInstance(){return P(this,x)}getSelectedActorElements(){return this.element?Array.from(this.element.querySelectorAll(".actor.drag-wrapper.selected")):[]}static showOnLoadIfEnabled(){var o;const t=E();C.get(t.showMenuOnLoad.tag)&&game.user.isGM&&(document.querySelectorAll("#flash-rolls-menu").forEach(i=>{i.remove()}),P(this,x)?P(this,x).rendered||P(this,x)._initializeFromSelectedTokens():he(this,x,new ge),(o=P(this,x))==null||o.render(!0),P(this,x)&&(P(this,x).isLocked=!0))}};x=new WeakMap,Ae=new WeakMap,$e=new WeakMap,ue(ge,x,null),ue(ge,Ae,null),ue(ge,$e,250),w(ge,"PARTS",{main:{template:`modules/${W.ID}/templates/requests-menu.hbs`}});let V=ge;const j=class j{static registerSettings(){const e=E();var t=j.get(e.debugMode.tag);t&&(CONFIG.debug.hooks=!0),Object.entries(e).forEach(o=>{const a=o[1],i={name:a.label,hint:a.hint,default:a.default,type:a.propType,scope:a.scope,config:a.config,requiresReload:a.requiresReload||!1,restricted:a.scope===H.world,onChange:l=>j.apply(a.tag,l)};a.choices&&(i.choices=a.choices),r.log("registerSettings",[i,i.scope]);try{game.settings.register(b,a.tag,i)}catch(l){r.log(`Setting ${a.tag} already registered or error:`,l)}})}static registerSettingsMenu(){var t;const e=Object.entries(kt());for(const[s,o]of e)if(o.restricted&&((t=game.user)!=null&&t.isGM)||!o.restricted){const a={name:o.tag,label:o.label,hint:o.hint,icon:o.icon,type:o.propType,restricted:o.restricted};game.settings.registerMenu(b,o.tag,a)}j.updateColorScheme(),j.validateAndUpdateIconLayout(),j.checkMidiQol()}static checkMidiQol(){const e=E(),t=D.isModuleOn("midi-qol"),s=j.get(e.rollInterceptionEnabled.tag);r.log("checkMidiQol",[t,s])}static updateColorScheme(){var s;const e=game.settings.get("core","uiConfig");let t=(s=e==null?void 0:e.colorScheme)==null?void 0:s.interface;t||(matchMedia("(prefers-color-scheme: dark)").matches?t="dark":matchMedia("(prefers-color-scheme: light)").matches&&(t="light")),j.coreColorScheme=t,r.log("SettingsUtil.updateColorScheme",[e,j.coreColorScheme])}static get(e,t=b){if(!e)return null;let s=!1;try{if(t===b)s=game.settings.get(t,e);else{let a=game.settings.storage.get("client")[`${t}.${e}`];a===void 0&&(a=game.settings.storage.get("world").getSetting(`${t}.${e}`),s=a==null?void 0:a.value)}}catch{return r.log(`Setting ${t}.${e} not found, returning false`),!1}return s}static set(e,t,s=b){if(!e)return!1;let o=game.settings.storage.get("client")[`${s}.${e}`];o||(o=game.settings.storage.get("world").getSetting(`${s}.${e}`),r.log("SettingsUtil.set - world Setting?",[o]));try{game.settings.set(s,e,t),r.log("SettingsUtil.set - success",[s,e,t])}catch(a){r.error("SettingsUtil.set - error",[a])}return!0}static apply(e,t){const s=E();switch(e){case s.rollRequestsEnabled.tag:j.applyRollRequestsEnabled(t);break;case s.rollInterceptionEnabled.tag:j.applyRollInterceptionEnabled(t);break;case s.compactMode.tag:j.applyCompactMode(t);break;case s.menuLayout.tag:j.applyMenuLayout(t);break;case s.menuIconsLayout.tag:j.applyMenuIconsLayout(t);break;case s.autoBlockMovementInCombat.tag:j.applyAutoBlockMovementInCombat(t);break}}static applyRollInterceptionEnabled(e){j.checkMidiQol()}static applyRollRequestsEnabled(e){const t=document.querySelector(".chat-controls .flash-rolls-icon");t&&(e?t.classList.add("active"):t.classList.remove("active"))}static applyCompactMode(e){const t=E(),s=e||j.get(t.compactMode.tag);r.log("applyCompactMode",[s]),V.refreshIfOpen()}static applyMenuLayout(e){const t=E(),s=e||j.get(t.menuLayout.tag);r.log("applyMenuLayout",[s]),V.refreshIfOpen()}static applyMenuIconsLayout(e){const t=E(),s=e||j.get(t.menuIconsLayout.tag);r.log("applyMenuIconsLayout",[s]),V.refreshIfOpen()}static validateAndUpdateIconLayout(){const e=E(),t=j.get(e.menuIconsLayout.tag),s=Ie();if(!t){r.log("validateAndUpdateIconLayout - no current layout found, using default");return}let o=!1;const a=foundry.utils.deepClone(t);for(const[i,l]of Object.entries(s)){a[i]||(a[i]=[]);const n=new Set(l.map(u=>u.id));a[i].length,a[i]=a[i].filter(u=>n.has(u.id)?!0:(r.log(`validateAndUpdateIconLayout - removed obsolete icon: ${u.id} from ${i}`),o=!0,!1));const c=new Set(a[i].map(u=>u.id));let d=Math.max(...a[i].map(u=>u.order||0),-1);for(const u of l)c.has(u.id)||(d++,a[i].push({...u,order:d}),o=!0,r.log(`validateAndUpdateIconLayout - added missing icon: ${u.id} to ${i}`))}o?(j.set(e.menuIconsLayout.tag,a),r.log("validateAndUpdateIconLayout - updated layout",a)):r.log("validateAndUpdateIconLayout - no changes needed")}static applyAutoBlockMovementInCombat(e){if(!game.user.isGM)return;const t=game.combat;t&&(r.log("applyAutoBlockMovementInCombat",[e,t]),e?fe.onCombatStart(t,{}):fe.onCombatEnd(t))}};w(j,"coreColorScheme","dark");let C=j;class is{static initialize(){r.log("ActorDirectoryIconUtil.initialize"),Hooks.on(O.RENDER_ACTOR_DIRECTORY,this.onRenderActorDirectory.bind(this)),Hooks.on(O.UPDATE_ACTOR,this.onUpdateActor.bind(this)),this.updateExistingDirectory()}static updateExistingDirectory(){const e=ui.actors;e&&e.rendered&&e.element?(r.log("ActorDirectoryIconUtil.updateExistingDirectory - Found rendered directory, adding icons"),this.onRenderActorDirectory(e,e.element)):r.log("ActorDirectoryIconUtil.updateExistingDirectory - No rendered directory found")}static onRenderActorDirectory(e,t){t.querySelectorAll(".directory-item.actor").forEach(o=>{const a=o.dataset.entryId||o.dataset.documentId;a&&this.updateActorIcon(o,a)})}static onUpdateActor(e,t){var o;const s=(o=t.flags)==null?void 0:o["flash-rolls-5e"];s&&(r.log("ActorDirectoryIconUtil.onUpdateActor - Flash Rolls flags changed",[e.name,s]),this.refreshActorIcon(e.id))}static updateActorIcon(e,t){const s=e.querySelector("span.fas.fa-bolt, span.fas.fa-bolt-slash");s&&s.remove();const o=game.actors.get(t);if(!o)return;const a=J.isFavorite(o),i=J.isBlocked(o);if(!a&&!i)return;const l=document.createElement("span");i?(l.className="fas fa-bolt-slash",l.dataset.tooltip=game.i18n.localize("FLASH_ROLLS.contextMenu.unblockFromMenu"),l.dataset.tooltipDirection="LEFT",l.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),J.toggleBlocked(t,!1)})):a&&(l.className="fas fa-bolt",l.dataset.tooltip=game.i18n.localize("FLASH_ROLLS.contextMenu.blockFromMenu"),l.dataset.tooltipDirection="LEFT",l.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),J.toggleFavorite(t,!1)})),l.style.cursor="pointer",e.appendChild(l)}static refreshActorIcon(e){const t=document.querySelector(`.directory-item.actor[data-entry-id="${e}"], .directory-item.actor[data-document-id="${e}"]`);t&&this.updateActorIcon(t,e)}static refreshAllIcons(){r.log("ActorDirectoryIconUtil.refreshAllIcons"),document.querySelectorAll(".directory-item.actor").forEach(t=>{const s=t.dataset.entryId||t.dataset.documentId;s&&this.updateActorIcon(t,s)})}}class te{static onPreRollGM(e,t,s){var o;if(r.log("RollHooksHandler.onPreRollGM",[e,t,s]),e.rolls=v.consolidateRolls(e.rolls),(o=e.subject)!=null&&o.item){const a=D.areSkipKeysPressed(e.event),i=e.subject.item.getFlag(b,"tempAttackConfig")||e.subject.item.getFlag(b,"tempDamageConfig")||e.subject.item.getFlag(b,"tempSaveConfig");r.log("RollHooksHandler.onPreRollGM - flag",[i]),((i==null?void 0:i.skipRollDialog)===!0||a)&&(t.configure=!1,r.log("RollHooksHandler.onPreRollGM - Local GM roll, skipping dialog via stored flag"))}}static onPreRollInitiativeDialog(e,t,s){var i,l,n,c,d;const a=e.subject.getFlag(b,"tempInitiativeConfig");r.log("RollHooksHandler.onPreRollInitiativeDialog triggered",[e,a,t,s]),a&&(t.configure=!0,r.log("RollHooksHandler.onPreRollInitiativeDialog - Player roll request, always showing dialog")),e.advantage=(a==null?void 0:a.advantage)||e.advantage||!1,e.disadvantage=(a==null?void 0:a.disadvantage)||e.disadvantage||!1,e.rollMode=(a==null?void 0:a.rollMode)||e.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,s.rollMode=(a==null?void 0:a.rollMode)||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,(n=(l=(i=a==null?void 0:a.rolls)==null?void 0:i[0])==null?void 0:l.data)!=null&&n.situational&&((d=(c=e.rolls)==null?void 0:c[0])!=null&&d.data)&&(e.rolls[0].data.situational=a.rolls[0].data.situational)}static onPreRollAttackV2(e,t,s){var a,i;r.log("RollHooksHandler.onPreRollAttackV2 triggered",[e,t,s]);const o=(i=(a=e.subject)==null?void 0:a.item)==null?void 0:i.getFlag(b,"tempAttackConfig");o&&(r.log("RollHooksHandler.onPreRollAttackV2 - flag",[o]),t.configure=!0,r.log("RollHooksHandler.onPreRollAttackV2 - Player roll request, always showing dialog"),o.attackMode&&(e.attackMode=o.attackMode),o.ammunition&&(e.ammunition=o.ammunition),o.mastery!==void 0&&(e.mastery=o.mastery),e.advantage=o.advantage||!1,e.disadvantage=o.disadvantage||!1,s.rollMode=o.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,o.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=o.situational),r.log("RollHooksHandler.onPreRollAttackV2 - Applied stored configuration to attack roll",[e,s]))}static onPreRollDamageV2(e,t,s){var i,l,n;const o=(l=(i=e.subject)==null?void 0:i.item)==null?void 0:l.getFlag(b,"tempDamageConfig");r.log("RollHooksHandler.onPreRollDamageV2 triggered",[e,t,s]);const a=D.isModuleOn("midi-qol");if(e.rolls=v.consolidateRolls(e.rolls),o&&(t.configure=!0,r.log("RollHooksHandler.onPreRollDamageV2 - Player roll request, forcing dialog to show")),e.midiOptions&&!game.user.isGM&&a&&((n=e.subject)==null?void 0:n.type)===le.DAMAGE){t.configure=!0;const c=e.midiOptions.workflowOptions||{};e.midiOptions={...e.midiOptions,fastForwardDamage:!1,workflowOptions:{...c,fastForwardDamage:!1,autoRollAttack:!1,autoRollDamage:!1,forceCompletion:!1}},r.log("RollHooksHandler.onPreRollDamageV2 - configured midiOptions for Flash Rolls compatibility",[e.midiOptions])}o&&(r.log("RollHooksHandler.onPreRollDamageV2 - Found stored request config from flag",[o,o.situational]),o.critical&&(e.critical=o.critical),s.rollMode=o.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,r.log("RollHooksHandler.onPreRollDamageV2 triggered #1",[e,t,s]),o.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=o.situational,e._flashRollsSituational=o.situational),r.log("RollHooksHandler.onPreRollDamageV2 - Applied stored configuration to damage roll",[e,s]))}static onPreRollAbilityCheck(e,t,s){r.log("RollHooksHandler.onPreRollAbilityCheck",[e,t,s]),e.isRollRequest&&(t.configure=!0)}static onPreRollHitDieV2(e,t,s){if(r.log("RollHooksHandler.onPreRollHitDieV2 triggered",[e,t,s]),e.rolls&&e.rolls.length>1){const o=[];for(let a=0;a<e.rolls.length;a++){const i=e.rolls[a];i&&i.data&&i.data.situational&&o.push(i.data.situational)}if(o.length>0){e.rolls[0].data||(e.rolls[0].data={});const a=[...new Set(o)];e.rolls[0].data.situational=a.map(i=>{const l=i.toString().trim();return l.startsWith("-")?`(${l})`:l.startsWith("+")?`${l.substring(1)}`:`${l}`}).join(" + "),game.user.isGM&&!e.rolls[0].parts.find(i=>i.includes("@situational"))&&e.rolls[0].parts.push("@situational")}e.rolls=e.rolls.slice(0,1),r.log("RollHooksHandler.onPreRollHitDieV2 - Cleaned up hit die rolls",e.rolls)}}static onPostRollConfig(e,t,s,o){t._showRequestedBy&&e.length>0&&(o.data=o.data||{},o.data._showRequestedBy=!0,o.data._requestedBy=t._requestedBy)}static onRollDamageV2(e,t,s,o){var c;const a=(c=t.subject)==null?void 0:c.item;if(r.log("RollHooksHandler.onRollDamageV2 - scheduled template removal",[a==null?void 0:a.name,a==null?void 0:a.uuid]),!a)return;if(ae.templateRemovalTimers.has(a.uuid)){r.log("RollHooksHandler.onRollDamageV2 - template removal already scheduled for item",[a.uuid]);return}ae.templateRemovalTimers.add(a.uuid);const i=E(),n=C.get(i.templateRemovalTimeout.tag)*1e3;setTimeout(()=>{D.removeTemplateForItem(a),ae.templateRemovalTimers.delete(a.uuid)},n)}}class ze{static initialize(){r.log("GroupTokenTracker.initialize"),this.setupPlaceMembersTracking(),Hooks.on(O.CREATE_TOKEN,this.onCreateToken.bind(this)),Hooks.on(O.DELETE_TOKEN,this.onDeleteToken.bind(this)),game.user.isGM&&this.migrateLegacyAssociationsForAllGroups()}static async migrateLegacyAssociationsForAllGroups(){let e=!1;try{e=game.settings.get(b,"legacyTokenAssociationsMigrated")}catch{r.log("GroupTokenTracker: Migration setting not yet registered, proceeding with migration check")}if(e){r.log("GroupTokenTracker: Legacy migration already completed globally");return}if(!game.actors.some(o=>(o.type==="group"||o.type==="encounter")&&o.getFlag(b,"tokenAssociations")&&!o.getFlag(b,"tokenAssociationsByScene"))){r.log("GroupTokenTracker: No legacy associations to migrate, setting global flag");try{await game.settings.set(b,"legacyTokenAssociationsMigrated",!0)}catch{r.log("GroupTokenTracker: Could not set migration flag, setting may not be registered yet")}return}const s=game.actors.filter(o=>(o.type==="group"||o.type==="encounter")&&o.getFlag(b,"tokenAssociations")&&!o.getFlag(b,"tokenAssociationsByScene"));for(const o of s)await this.migrateLegacyAssociations(o);try{await game.settings.set(b,"legacyTokenAssociationsMigrated",!0),r.log(`GroupTokenTracker: Migrated legacy associations for ${s.length} group actors and set global completion flag`)}catch{r.log(`GroupTokenTracker: Migrated legacy associations for ${s.length} group actors but could not set completion flag`)}}static setupPlaceMembersTracking(){Hooks.on(O.PRE_CREATE_TOKEN,(e,t,s,o)=>{if(!(o!==game.user.id||!game.user.isGM)){r.log("preCreateToken",[e,t,s,o]);for(const[a,i]of this.pendingPlacements.entries())i.memberActorIds.includes(t.actorId)&&i.isPlacing&&e.updateSource({flags:{[b]:{groupId:a,fromGroupPlacement:!0}}})}}),Hooks.on(O.RENDER_APPLICATION_V2,(e,t,s)=>{if(!e.document||e.document.type!=="group"&&e.document.type!=="encounter")return;const o=t.querySelector('[data-action="placeMembers"]');o&&(o.removeEventListener("click",this._handlePlaceMembersClick),o._groupActor=e.document,o.addEventListener("click",this._handlePlaceMembersClick.bind(this)))}),Hooks.on(O.RENDER_APPLICATION,(e,t,s)=>{if(!e.actor||e.actor.type!=="group"&&e.actor.type!=="encounter")return;const o=t.find('[data-action="placeMembers"]');o.length!==0&&(o.off("click.groupTokenTracker"),o.on("click.groupTokenTracker",async()=>{await this._trackPlaceMembers(e.actor)}))})}static async _handlePlaceMembersClick(e){const t=e.currentTarget._groupActor;r.log("GroupTokenTracker: placeMembers clicked",[t.name,t,e]),t&&await this._trackPlaceMembers(t)}static async _trackPlaceMembers(e){r.log("GroupTokenTracker: placeMembers clicked for",e.name);const t=await e.system.getPlaceableMembers(),s=t.map(i=>i.actor.id),o=t.reduce((i,l)=>{var c;const n=((c=l.quantity)==null?void 0:c.value)||1;return i+n},0);this.pendingPlacements.set(e.id,{groupActor:e,memberActorIds:s,expectedTokenCount:o,placedTokenCount:0,timestamp:Date.now(),isPlacing:!0});const a=e.getFlag(b,"tokenAssociationsByScene")||{};this.activeAssociations.set(e.id,JSON.parse(JSON.stringify(a))),setTimeout(()=>{const i=this.pendingPlacements.get(e.id);i&&(i.isPlacing=!0,r.log(`GroupTokenTracker: Token placement phase active for group ${e.name}`))},100),setTimeout(()=>{var l;const i=this.pendingPlacements.get(e.id);i&&i.timestamp===((l=this.pendingPlacements.get(e.id))==null?void 0:l.timestamp)&&(r.log(`GroupTokenTracker: Timeout reached for group ${e.name}, cleaning up`),this.pendingPlacements.delete(e.id),this.activeAssociations.delete(e.id))},12e4)}static async onCreateToken(e,t,s){if(s!==game.user.id||(await this.cleanupCopiedTokenFlags(e),!game.user.isGM))return;const o=e.getFlag(b,"fromGroupPlacement"),a=e.getFlag(b,"groupId");if(!o||!a){await this.cleanupDanglingAssociations();return}const i=this.pendingPlacements.get(a);if(!i)return;const l=e.actorId,n=e.parent.id,c=e.uuid,d=this.activeAssociations.get(a)||{};d[n]||(d[n]={}),d[n][l]||(d[n][l]=[]);const u=[...d[n][l]];u.includes(c)||(u.push(c),d[n][l]=u,this.activeAssociations.set(a,d),await i.groupActor.setFlag(b,"tokenAssociationsByScene",d),await e.unsetFlag(b,"fromGroupPlacement"),i.placedTokenCount++,r.log(`GroupTokenTracker: Updated tokenAssociationsByScene for group ${i.groupActor.name}`,{associations:d,placedCount:i.placedTokenCount,expectedCount:i.expectedTokenCount}),i.placedTokenCount>=i.expectedTokenCount&&(i.isPlacing=!1,r.log(`GroupTokenTracker: All tokens placed for group ${i.groupActor.name}, cleaning up`),this.pendingPlacements.delete(a),this.activeAssociations.delete(a))),await this.cleanupDanglingAssociations()}static async onDeleteToken(e,t,s){const o=e.getFlag(b,"groupId");if(!o)return;const a=game.actors.get(o);if(!a)return;const i=e.actorId,l=e.parent.id,n=e.uuid,c=a.getFlag(b,"tokenAssociationsByScene");if(!c||!c[l]||!c[l][i])return;const d=c[l][i].indexOf(n);d!==-1&&(r.log(`GroupTokenTracker: Removing deleted token ${n} from group ${o}`),c[l][i].splice(d,1),c[l][i].length===0&&delete c[l][i],Object.keys(c[l]).length===0&&delete c[l],Object.keys(c).length===0?await a.unsetFlag(b,"tokenAssociationsByScene"):await a.setFlag(b,"tokenAssociationsByScene",c),await this.cleanupDanglingAssociations())}static cleanupOldPendingPlacements(){const e=Date.now(),t=5e3;for(const[s,o]of this.pendingPlacements.entries())e-o.timestamp>t&&(r.log(`GroupTokenTracker: Cleaning up old pending placement for group ${s}`),this.pendingPlacements.delete(s))}static async cleanupInvalidTokens(e){if(e.type!=="group"&&e.type!=="encounter")return;const t=e.getFlag(b,"tokenAssociationsByScene");if(!t)return;let s=!1;const o={};for(const[a,i]of Object.entries(t)){if(!game.scenes.get(a)){r.log(`GroupTokenTracker: Scene ${a} no longer exists, removing associations`),s=!0;continue}const n={};for(const[c,d]of Object.entries(i)){const u=d.filter(f=>{try{const p=fromUuidSync(f);return p&&p.actorId===c&&p.parent.id===a}catch{return r.log(`GroupTokenTracker: Invalid token UUID ${f}, removing`),!1}});u.length>0&&(n[c]=u),u.length!==d.length&&(s=!0)}Object.keys(n).length>0&&(o[a]=n)}s&&(Object.keys(o).length===0?await e.unsetFlag(b,"tokenAssociationsByScene"):await e.setFlag(b,"tokenAssociationsByScene",o),r.log(`GroupTokenTracker: Cleaned invalid tokens for group ${e.name}`))}static async cleanupDanglingAssociations(){const e=game.actors.filter(t=>(t.type==="group"||t.type==="encounter")&&t.getFlag(b,"tokenAssociationsByScene"));for(const t of e)await this.cleanupInvalidTokens(t);r.log(`GroupTokenTracker: Cleaned dangling associations for ${e.length} group actors`)}static getGroupForToken(e){const t=e.getFlag(b,"groupId");return t&&game.actors.get(t)||null}static getGroupTokens(e,t=null){const s=t||game.scenes.active,o=new Map;if(!s)return o;const i=(e.getFlag(b,"tokenAssociationsByScene")||{})[s.id];if(!i)return o;for(const[l,n]of Object.entries(i)){const c=n.map(d=>{try{return fromUuidSync(d)}catch{return r.log(`GroupTokenTracker: Invalid token UUID ${d}`),null}}).filter(d=>d&&d.actorId===l&&d.parent.id===s.id);c.length>0&&o.set(l,c)}return o}static getAllGroupTokens(e){const t=e.getFlag(b,"tokenAssociationsByScene")||{},s=new Map;for(const[o,a]of Object.entries(t)){if(!game.scenes.get(o))continue;const l=new Map;for(const[n,c]of Object.entries(a)){const d=c.map(u=>{try{return fromUuidSync(u)}catch{return null}}).filter(u=>u&&u.actorId===n);d.length>0&&l.set(n,d)}l.size>0&&s.set(o,l)}return s}static async cleanupCopiedTokenFlags(e){var l,n;const t=e.getFlag(b);if(!t)return;const s=t.groupId;if(t.fromGroupPlacement)return;let a=!1;const i=[];if(s){const c=game.actors.get(s),d=e.parent.id,u=e.uuid;if(!c)a=!0,i.push("group actor no longer exists");else{const f=c.getFlag(b,"tokenAssociationsByScene");((n=(l=f==null?void 0:f[d])==null?void 0:l[e.actorId])==null?void 0:n.includes(u))||(a=!0,i.push("not in group associations"))}}t.movementRestriction&&!s&&(a=!0,i.push("orphaned movement restriction")),a&&(r.log(`GroupTokenTracker: Cleaning up invalid module flags from token ${e.name} (${e.id})`),r.log("GroupTokenTracker: Cleanup reasons:",i),r.log("GroupTokenTracker: Removing flags:",Object.keys(t)),await e.unsetFlag(b))}static async migrateLegacyAssociations(e){const t=e.getFlag(b,"tokenAssociations"),s=e.getFlag(b,"tokenAssociationsByScene");if(!t||s)return;r.log(`GroupTokenTracker: Migrating legacy associations for group ${e.name}`);const o={};let a=0;for(const i of game.scenes){const l={};for(const[n,c]of Object.entries(t)){const d=c.map(u=>{const f=i.tokens.get(u);return f&&f.actorId===n?f.uuid:null}).filter(u=>u!==null);d.length>0&&(l[n]=d,a+=d.length)}Object.keys(l).length>0&&(o[i.id]=l)}Object.keys(o).length>0?(await e.setFlag(b,"tokenAssociationsByScene",o),r.log(`GroupTokenTracker: Migrated ${a} tokens across ${Object.keys(o).length} scenes for group ${e.name}`)):r.log(`GroupTokenTracker: No valid tokens found to migrate for group ${e.name}`),await e.unsetFlag(b,"tokenAssociations")}}w(ze,"pendingPlacements",new Map),w(ze,"activeAssociations",new Map);const K=class K{static getActivityConfigFromCache(e){const t=K.activityConfigCache.get(e);return t?Date.now()-t.timestamp>K.CACHE_EXPIRY_MS?(K.activityConfigCache.delete(e),r.log("getActivityConfigFromCache - deleted expired entry",[e]),null):t.config:null}static initialize(){Hooks.once(O.INIT,this._onInit.bind(this)),Hooks.once(O.READY,this._onReady.bind(this)),Hooks.on(Bt.READY,()=>{r.log("flash-rolls-5e.ready hook",[])}),Hooks.on(O.GET_CHAT_MESSAGE_CONTEXT_OPTIONS,(e,t)=>{r.log("getChatMessageContextOptions hook",[e,t]),game.user.isGM&&this._addGroupRollContextOptions(e,t)}),Hooks.on(O.CLIENT_SETTING_CHANGED,this._onClientSettingChanged.bind(this)),Hooks.once(O.GET_ACTOR_CONTEXT_OPTIONS,(e,t)=>{r.log("getActorContextOptions hook",[e,t]),game.user.isGM&&(t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.unblockFromMenu"),icon:'<i class="fas fa-bolt"></i>',callback:s=>{const o=s.dataset.entryId;return o&&J.toggleBlocked(o,!1),o},condition:s=>{var i;const o=(i=s==null?void 0:s.dataset)==null?void 0:i.entryId;return J.isBlocked(o)}}),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.blockFromMenu"),icon:'<i class="fas fa-bolt-slash"></i>',callback:s=>{const o=s.dataset.entryId;return o&&J.toggleBlocked(o,!0),o},condition:s=>{var i;const o=(i=s==null?void 0:s.dataset)==null?void 0:i.entryId;return!J.isBlocked(o)}}))})}static _addGroupRollContextOptions(e,t){r.log("_addGroupRollContextOptions",[e,t]),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.hideNPCsFromPlayers"),icon:'<i class="fas fa-eye-slash"></i>',callback:s=>{const o=s.dataset.messageId,a=game.messages.get(o);a&&(a.setFlag(b,"npcHiddenOverride",!0),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.npcHiddenFromPlayers")))},condition:s=>{const o=s.dataset.messageId;if(!o)return!1;const a=game.messages.get(o);if(!a||!a.getFlag(b,"isGroupRoll"))return!1;const i=E(),l=C.get(i.groupRollNPCHidden.tag),n=a.getFlag(b,"npcHiddenOverride");return!(n!==void 0?n:l)}}),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.showNPCsToPlayers"),icon:'<i class="fas fa-eye"></i>',callback:s=>{const o=s.dataset.messageId,a=game.messages.get(o);if(a){const i=E();C.get(i.groupRollNPCHidden.tag)?a.setFlag(b,"npcHiddenOverride",!1):a.unsetFlag(b,"npcHiddenOverride"),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.npcVisibleToPlayers"))}},condition:s=>{const o=s.dataset.messageId;if(!o)return!1;const a=game.messages.get(o);if(!a||!a.getFlag(b,"isGroupRoll"))return!1;const i=E(),l=C.get(i.groupRollNPCHidden.tag),n=a.getFlag(b,"npcHiddenOverride");return n!==void 0?n:l}})}static _onInit(){E(),document.body.classList.add("flash5e"),C.registerSettings(),ke.initialize()}static _onReady(){var e;C.registerSettingsMenu(),is.initialize(),Ke.addSidebarControls(ui.sidebar,(e=ui.sidebar)==null?void 0:e.element),matchMedia&&matchMedia("(prefers-color-scheme: dark)").addEventListener("change",this._onBrowserColorSchemeChanged.bind(this)),D.isModuleOn("midi-qol")?Hooks.once(xt.READY,this._initModule.bind(this)):this._initModule(),r.log("HooksManager.ready",[CONFIG.statusEffects])}static async _initModule(){const e=E();C.get(e.debugMode.tag)&&(CONFIG.debug.hooks=!0),await B.initialize(),this._registerHooks(),game.user.isGM?(st.initialize(),V.showOnLoadIfEnabled(),ze.initialize(),game.users.forEach(o=>{this._onUserConnected(o)})):ke.getDiceConfig(),dt(ct()),fe.initializeCombatMovementRestrictions();const s=game.modules.get("flash-rolls-5e");s&&(s.api=Qe),globalThis.FlashRolls5e=Qe,Hooks.call("flash-rolls-5e.ready")}static _registerHooks(){this._registerCommonHooks(),game.user.isGM?this._registerGMOnlyHooks():this._registerPlayerOnlyHooks()}static _registerCommonHooks(){this._registerHook(O.RENDER_SIDEBAR,this._onRenderSidebar.bind(this)),this._registerHook(O.CHANGE_SIDEBAR_TAB,this._onSidebarUpdate.bind(this)),this._registerHook(O.COLLAPSE_SIDE_BAR,this._onSidebarUpdate.bind(this)),this._registerHook(O.REFRESH_MEASURED_TEMPLATE,this.onRefreshTemplate.bind(this)),this._registerHook(O.CANVAS_READY,this._onCanvasReady.bind(this)),this._registerHook(O.CREATE_CHAT_MESSAGE,B.onCreateChatMessage.bind(B)),this._registerHook(O.PRE_CREATE_CHAT_MESSAGE,B.onPreCreateChatMessage.bind(B)),this._registerHook(O.RENDER_CHAT_MESSAGE,B.onRenderChatMessage.bind(B)),this._registerHook(O.RENDER_CHAT_LOG,B.onRenderChatLog.bind(B)),this._registerHook(O.PRE_UPDATE_TOKEN,this._onPreUpdateToken.bind(this)),this._registerHook(U.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this)),this._registerHook(U.RENDER_SKILL_TOOL_ROLL_DIALOG,this._onRenderSkillToolDialog.bind(this)),this._registerHook(U.PRE_ROLL_HIT_DIE_V2,te.onPreRollHitDieV2.bind(te)),this._registerHook(U.POST_ROLL_CONFIG,te.onPostRollConfig.bind(te)),this._registerHook(U.ROLL_DAMAGE_V2,te.onRollDamageV2.bind(te))}static _registerGMOnlyHooks(){this._registerHook(O.USER_CONNECTED,this._onUserConnected.bind(this)),this._registerHook(U.PRE_ROLL_V2,te.onPreRollGM.bind(te)),this._registerHook(U.PRE_USE_ACTIVITY,Re.onPreUseActivityGM.bind(Re)),this._registerHook(U.POST_USE_ACTIVITY,Re.onPostUseActivityGM.bind(Re)),this._registerHook(O.CREATE_COMBATANT,this._onCombatChange.bind(this)),this._registerHook(O.DELETE_COMBATANT,this._onCombatChange.bind(this)),this._registerHook(O.UPDATE_COMBAT,this._onCombatChange.bind(this)),this._registerHook(O.DELETE_COMBAT,this._onCombatChange.bind(this)),this._registerHook(O.COMBAT_START,this._onCombatStart.bind(this)),this._registerHook(O.COMBAT_TURN_CHANGE,this._onCombatTurnChange.bind(this)),this._registerHook(O.DELETE_COMBAT,this._onDeleteCombat.bind(this)),this._registerHook(O.CREATE_COMBATANT,this._onCreateCombatant.bind(this)),this._registerHook(O.CREATE_ACTIVE_EFFECT,this._onActiveEffectChange.bind(this)),this._registerHook(O.DELETE_ACTIVE_EFFECT,this._onActiveEffectChange.bind(this)),this._registerHook(O.UPDATE_ACTIVE_EFFECT,this._onActiveEffectChange.bind(this)),this._registerHook(O.UPDATE_SETTING,this._onSettingUpdate.bind(this)),this._registerHook(O.UPDATE_SCENE,this._onSceneUpdate.bind(this)),this._registerHook(O.UPDATE_ACTOR,this._onActorUpdate.bind(this)),this._registerHook(O.UPDATE_TOKEN,this._onTokenUpdate.bind(this)),this._registerHook(O.CREATE_TOKEN,this._onCreateToken.bind(this)),this._registerHook(O.DELETE_TOKEN,this._onDeleteToken.bind(this)),this._registerHook(O.CREATE_ACTOR,this._onCreateActor.bind(this)),this._registerHook(O.DELETE_ACTOR,this._onDeleteActor.bind(this)),this._registerHook(O.RENDER_CHAT_INPUT,this._onRenderChatInput.bind(this))}static _registerPlayerOnlyHooks(){this._registerHook(U.PRE_ROLL_INITIATIVE_DIALOG,te.onPreRollInitiativeDialog.bind(te)),this._registerHook(U.PRE_ROLL_ATTACK_V2,te.onPreRollAttackV2.bind(te)),this._registerHook(U.PRE_ROLL_DAMAGE_V2,te.onPreRollDamageV2.bind(te)),Hooks.on(U.PRE_ROLL_ABILITY_CHECK,te.onPreRollAbilityCheck.bind(te)),this._registerHook(U.PRE_USE_ACTIVITY,Re.onPreUseActivityPlayer.bind(Re)),this._registerHook(U.POST_USE_ACTIVITY,Re.onPostUseActivityPlayer.bind(Re))}static _onSidebarUpdate(e){r.log("_onSidebarUpdate",[e]),dt(ct())}static _onRenderChatInput(){r.log("_onRenderChatInput - syncing offset and faded-ui classes");const e=document.querySelector("#flash-rolls-menu");e&&e.classList.contains("docked-bottom")&&setTimeout(async()=>{const t={element:e};pe.syncOffsetClass(t),pe.syncFadedUIClass(t)},50)}static _onRenderRollConfigDialog(e,t,s){var a,i,l,n,c;if(r.log("_onRenderRollConfigDialog #0",[e,s]),e._flashRollsApplied)return;if(((i=(a=e.config)==null?void 0:a.hookNames)==null?void 0:i.includes("initiativeDialog"))||((n=(l=e.element)==null?void 0:l.id)==null?void 0:n.includes("initiative"))){const d=(c=e.config)==null?void 0:c.subject;if(!d)return;if(e._flashRollsTitleApplied||(t.querySelector(".window-title").textContent=game.i18n.localize("DND5E.Initiative"),t.querySelector(".window-subtitle").textContent=d.name,e._flashRollsTitleApplied=!0),d.getFlag(b,"tempInitiativeConfig")){e._flashRollsApplied=!0;const f=t.querySelector('input[name*="situational"]');setTimeout(()=>{f.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},50)}return}else t.querySelectorAll('input[name*="situational"]').forEach((u,f)=>{var p,m,h,S,R,T,L;r.log("_onRenderRollConfigDialog - processing input",[f,u.name,u.value]),!u.value&&((S=(h=(m=(p=e.config)==null?void 0:p.rolls)==null?void 0:m[0])==null?void 0:h.data)!=null&&S.situational)&&(u.value=e.config.rolls[0].data.situational),e.config.scaling=!0,u.value&&(e._flashRollsApplied=!0,(L=(T=(R=e.config)==null?void 0:R.rolls)==null?void 0:T[0])!=null&&L.data&&delete e.config.rolls[0].data.situational,setTimeout(()=>{u.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},150))})}static _onPreCreateChatMessageGM(e,t,s,o){r.log("_onPreCreateChatMessageGM",[e,t,s,o])}static _onRenderChatMessageHTML(e,t,s){var o,a,i,l,n,c,d,u,f,p,m;if(r.log("_onRenderChatMessageHTML #0",[e,t,s]),B.interceptRollMessage(e,t,s),e.getFlag(b,"isGroupRoll")){const h=E(),S=C.get(h.groupRollNPCHidden.tag),R=e.getFlag(b,"npcHiddenOverride"),T=game.user.isGM;if((R!==void 0?R:S)&&!T){const k=e.getFlag(b,"rollData");k&&k.results&&t.querySelectorAll(".actor-result").forEach((A,M)=>{const _=k.results[M];if(_){const F=game.actors.get(_.actorId);F&&!F.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER)&&A.classList.add("npc-hidden")}})}B._attachGroupRollListeners(t,e)}if(this._addSelectTargetsButton(e,t),game.user.isGM){let h=(o=s.subject)==null?void 0:o.item;!h&&((l=(i=(a=e.flags)==null?void 0:a.dnd5e)==null?void 0:i.item)!=null&&l.uuid)&&(h=fromUuidSync(e.flags.dnd5e.item.uuid)),r.log("_onRenderChatMessageHTML - item",[h,s,(c=(n=e.flags)==null?void 0:n.dnd5e)==null?void 0:c.item]),h&&setTimeout(()=>{K.activityConfigCache.delete(h.id),r.log("_onRenderChatMessageHTML - cleared activity config cache",[h.id])},1e3)}if(r.log("_onRenderChatMessageHTML",[e,t,s]),!game.user.isGM){const h=((u=(d=e.flags)==null?void 0:d[b])==null?void 0:u.isFlashRollRequest)||((p=(f=e.flags)==null?void 0:f[b])==null?void 0:p.groupRollId)||((m=e.getFlag("dnd5e","roll"))==null?void 0:m._requestedBy);if(r.log("_onRenderChatMessageHTML #1",[h]),h){const S=game.settings.get("dnd5e","challengeVisibility");r.log("_onRenderChatMessageHTML #2",[S]);let R=!0;switch(S){case"none":R=!1;break;case"all":R=!0;break;case"player":R=e.author.id===game.user.id||!e.author.isGM,r.log("_onRenderChatMessageHTML #3",[e.author.id,game.user.id,R]);break;default:R=!0;break}R===!1&&setTimeout(()=>{t.querySelectorAll("[data-display-challenge]").forEach(k=>delete k.dataset.displayChallenge);const L=t.querySelectorAll(".success, .failure, .critical, .fumble");r.log("_onRenderChatMessageHTML #4",[t,L]),L==null||L.forEach(k=>{r.log("_onRenderChatMessageHTML #4b",[k]),k.classList.remove("success","failure","critical","fumble")}),L==null||L.forEach(k=>{var I;return(I=k.querySelector(".icons"))==null?void 0:I.remove()}),r.log("_onRenderChatMessageHTML #5",[t]),t.querySelectorAll(".save-dc, .dc, .target-dc").forEach(k=>{const I=k.textContent;I&&I.includes("DC")&&(k.textContent=I.replace(/DC\s*\d+/gi,""))})},50)}}return!1}static _addSelectTargetsButton(e,t){var o,a,i;if(!game.user.isGM||(r.log("_addSelectTargetsButton #0",[e,t,t.querySelector(".message-content")]),((i=(a=(o=e.flags)==null?void 0:o.dnd5e)==null?void 0:a.roll)==null?void 0:i.type)!=="damage"||t.querySelector(".select-targeted")))return;const s=document.createElement("button");s.className="select-targeted",s.type="button",s.setAttribute("data-tooltip-direction","LEFT"),s.setAttribute("data-tooltip","Select Targeted"),s.innerHTML='<i class="fas fa-crosshairs"></i>',s.addEventListener("click",l=>{l.preventDefault(),this._selectTargetedTokens(l)}),t.querySelector(".message-content").appendChild(s),e.update({content:t})}static _selectTargetedTokens(e){const s=e.currentTarget.closest(".chat-message").querySelectorAll("[data-target-uuid]");if(s.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noTargetedTokens"));return}for(let o=0;o<s.length;o++){const i=s[o].dataset.targetUuid.split("Actor.")[1];canvas.tokens.placeables.filter(n=>{var c,d;return((c=n.document.actor)==null?void 0:c.id)===i||((d=n.document.baseActor)==null?void 0:d.id)===i}).forEach((n,c)=>{n&&n.control&&n.control({releaseOthers:o===0})})}}static _onUserConnected(e){e.active&&e.id!==game.user.id&&ke.requestDiceConfigFromUser(e.id)}static _onCreateToken(e,t,s){V.refreshIfOpen()}static _onPreUpdateToken(e,t,s,o){var l;r.log("HooksManager._onPreUpdateToken called",{tokenDoc:e,updateData:t,options:s,userId:o,userIsGM:(l=game.users.get(o))==null?void 0:l.isGM});const a=game.users.get(o);if(!a)return;const i=fe.isMovementAllowed(e,a,t);if(r.log("Movement check result:",{isMovementAllowed:i,user:a.name,token:e.name}),!i)return ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.movementRestricted")),r.log("Movement blocked for token:",e.name),!1}static _onDeleteToken(e,t,s){ze.onDeleteToken(e,t,s),V.refreshIfOpen()}static _onCreateActor(e,t,s){V.refreshIfOpen()}static _onDeleteActor(e,t,s){V.refreshIfOpen()}static _onSettingUpdate(e,t,s,o){const a=E(),i={ID:"flash-rolls-5e"};e.key===`${i.ID}.${a.showOnlyPCsWithToken.tag}`||e.key===`${i.ID}.${a.compactMode.tag}`||e.key===`${i.ID}.${a.menuLayout.tag}`?(r.log("HooksManager._onSettingUpdate - Re-rendering roll requests menu due to setting change",[e.key]),V.refreshIfOpen()):e.key==="core.uiConfig"&&(C.updateColorScheme(),V.refreshIfOpen())}static _onSceneUpdate(e,t,s,o){t.active===!0&&(r.log("HooksManager._onSceneUpdate - Re-rendering roll requests menu due to active scene change"),V.refreshIfOpen())}static _onCanvasReady(e){r.log("HooksManager._onCanvasReady - Re-rendering roll requests menu due to scene view change"),V.refreshIfOpen()}static _onActorUpdate(e,t,s,o){var n,c,d,u,f,p,m,h,S,R,T,L;r.log("HooksManager._onActorUpdate",[e,t]),r.log("HooksManager._onActorUpdate - changes.effects:",[t.effects]);const a=t["==ownership"]!==void 0,i=((c=(n=t.system)==null?void 0:n.attributes)==null?void 0:c.hp)||((u=(d=t.system)==null?void 0:d.attributes)==null?void 0:u.ac)||((m=(p=(f=t.system)==null?void 0:f.attributes)==null?void 0:p.spell)==null?void 0:m.dc)||((S=(h=t.system)==null?void 0:h.skills)==null?void 0:S.prc)||((R=t.system)==null?void 0:R.abilities)||((L=(T=t.system)==null?void 0:T.attributes)==null?void 0:L.prof),l=t.effects!==void 0;r.log("HooksManager._onActorUpdate - triggers:",["statsChanged:",i,"ownershipChanged:",a,"effectsChanged:",l]),!(!i&&!a&&!l)&&V.refreshIfOpen()}static _onTokenUpdate(e,t,s,o){r.log("HooksManager._onTokenUpdate",[e,t]),t.hidden!==void 0&&V.refreshIfOpen()}static _onCombatChange(...e){r.log("HooksManager._onCombatChange",e),r.log("HooksManager._onCombatChange - Re-rendering roll requests menu due to combat status change"),V.refreshIfOpen()}static _onActiveEffectChange(e,t,s,o){if(r.log("HooksManager._onActiveEffectChange",[e,t,s,o]),!e.parent||e.parent.documentName!=="Actor"){r.log("HooksManager._onActiveEffectChange - Effect not on actor, skipping");return}r.log("HooksManager._onActiveEffectChange - Re-rendering roll requests menu due to status effect change"),r.log("HooksManager._onActiveEffectChange - Effect statuses:",e.statuses),V.refreshIfOpen()}static _onRenderApplicationV2(e,t,s){r.log("_onRenderApplicationV2",[e,t,s])}static _onRenderChatLog(e,t){t.querySelectorAll(".flash5e-group-roll").forEach(a=>{const i=a.closest(".chat-message");if(i){const l=i.dataset.messageId,n=game.messages.get(l);if(n&&n.getFlag(b,"isGroupRoll")){const c=E(),d=C.get(c.groupRollNPCHidden.tag),u=n.getFlag(b,"npcHiddenOverride"),f=game.user.isGM;if((u!==void 0?u:d)&&!f){const m=n.getFlag(b,"rollData");m&&m.results&&a.querySelectorAll(".actor-result").forEach((S,R)=>{const T=m.results[R];if(T){const L=game.actors.get(T.actorId);L&&!L.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER)&&S.classList.add("npc-hidden")}})}B._attachGroupRollListeners(a,n)}}}),t.querySelectorAll(".chat-message").forEach(a=>{var n,c,d,u,f,p;const i=a.dataset.messageId,l=game.messages.get(i);if(((d=(c=(n=l==null?void 0:l.flags)==null?void 0:n.dnd5e)==null?void 0:c.roll)==null?void 0:d.type)==="damage"&&((p=(f=(u=l.flags)==null?void 0:u.dnd5e)==null?void 0:f.item)!=null&&p.uuid)){const m=l.flags.dnd5e.item.uuid,h=fromUuidSync(m);if(h&&!K.templateRemovalTimers.has(m)){r.log("_onRenderChatLog - scheduling template removal for rendered damage message",[h.name,m]),K.templateRemovalTimers.add(m);const S=E(),T=C.get(S.templateRemovalTimeout.tag)*1e3;setTimeout(()=>{D.removeTemplateForItem(h),K.templateRemovalTimers.delete(m)},T)}}})}static _onRenderSidebar(e,t,s){r.log("_onRenderSidebar",[e,t]),game.ready&&Ke.addSidebarControls(e,t)}static _registerHook(e,t){const s=Hooks.on(e,t);return this.registeredHooks.set(`${e}_${s}`,s),s}static unregisterAll(){this.registeredHooks.forEach((e,t)=>{const s=t.split("_")[0];Hooks.off(s,e)}),this.registeredHooks.clear()}static isRegistered(e){for(const t of this.registeredHooks.keys())if(t.startsWith(`${e}_`))return!0;return!1}static _onPreRoll(e,t,s,o){var a;if(r.log("_onPreRoll #0",[e,t,s,o]),(a=e.subject)!=null&&a.item){const i=D.areSkipKeysPressed(e.event),l=e.subject.item.getFlag(b,"tempAttackConfig");r.log("_onPreRoll - flag",[l]),((l==null?void 0:l.skipRollDialog)===!0||i)&&(t.configure=!1,r.log("_onPreRoll - Local GM roll, skipping dialog via stored flag"))}}static _onPreRollHitDieV2(e,t,s){if(r.log("_onPreRollHitDieV2 triggered",[e,t,s]),e.rolls&&e.rolls.length>1){const o=[];for(let a=0;a<e.rolls.length;a++){const i=e.rolls[a];i&&i.data&&i.data.situational&&o.push(i.data.situational)}if(o.length>0){e.rolls[0].data||(e.rolls[0].data={});const a=[...new Set(o)];e.rolls[0].data.situational=a.map(i=>{const l=i.toString().trim();return l.startsWith("-")?`(${l})`:l.startsWith("+")?`${l.substring(1)}`:`${l}`}).join(" + "),game.user.isGM&&!e.rolls[0].parts.find(i=>i.includes("@situational"))&&e.rolls[0].parts.push("@situational")}e.rolls=e.rolls.slice(0,1),r.log("Cleaned up hit die rolls",e.rolls)}}static _onPreRollInitiativeDialog(e,t,s){var i,l,n,c,d;const a=e.subject.getFlag(b,"tempInitiativeConfig");r.log("_onPreRollInitiativeDialog triggered",[e,a,t,s]),e.advantage=(a==null?void 0:a.advantage)||e.advantage||!1,e.disadvantage=(a==null?void 0:a.disadvantage)||e.disadvantage||!1,e.rollMode=(a==null?void 0:a.rollMode)||e.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,s.rollMode=(a==null?void 0:a.rollMode)||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,(n=(l=(i=a.rolls)==null?void 0:i[0])==null?void 0:l.data)!=null&&n.situational&&((d=(c=e.rolls)==null?void 0:c[0])!=null&&d.data)&&(e.rolls[0].data.situational=a.rolls[0].data.situational)}static _onPreRollAttackV2(e,t,s){var a,i;r.log("_onPreRollAttackV2 triggered",[e,t,s]);const o=(i=(a=e.subject)==null?void 0:a.item)==null?void 0:i.getFlag(b,"tempAttackConfig");o&&(r.log("_onPreRollAttackV2 - flag",[o]),o.attackMode&&(e.attackMode=o.attackMode),o.ammunition&&(e.ammunition=o.ammunition),o.mastery!==void 0&&(e.mastery=o.mastery),e.advantage=o.advantage||!1,e.disadvantage=o.disadvantage||!1,s.rollMode=o.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,o.skipRollDialog===!0&&(t.configure=!1,r.log("_onPreRollAttackV2 - Local GM roll, skipping dialog",[o])),o.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=o.situational),r.log("_onPreRollAttackV2 - Applied stored configuration to attack roll",[e,s]))}static _onRollDamageV2(e,t,s,o){var c;const a=(c=t.subject)==null?void 0:c.item;if(r.log("_onRollDamageV2 - scheduled template removal",[a==null?void 0:a.name,a==null?void 0:a.uuid]),!a)return;if(K.templateRemovalTimers.has(a.uuid)){r.log("_onRollDamageV2 - template removal already scheduled for item",[a.uuid]);return}K.templateRemovalTimers.add(a.uuid);const i=E(),n=C.get(i.templateRemovalTimeout.tag)*1e3;setTimeout(()=>{D.removeTemplateForItem(a),K.templateRemovalTimers.delete(a.uuid)},n)}static _onRenderSkillToolDialog(e,t,s){var a,i;if(r.log("_onRenderSkillToolDialog triggered",[e]),e._abilityFlavorFixed)return;const o=t.querySelector('select[name="ability"]');if(o&&(a=e.config)!=null&&a.isRollRequest&&(i=e.config)!=null&&i.ability){const l=o.value,n=e.config.ability;l===n&&(e._abilityFlavorFixed=!0,setTimeout(()=>{const c=new Event("change",{bubbles:!0,cancelable:!0});o.dispatchEvent(c)},50))}}static onRefreshTemplate(e,t){if(!e.isOwner)return;const s=`refresh-template-${e.id}`,o=E(),a=C.get(o.templateAutoTarget.tag);K.throttleTimers[s]&&clearTimeout(K.throttleTimers[s]),K.throttleTimers[s]=setTimeout(()=>{let i=3;switch(a){case 1:i=3;break;case 2:i=0;break;default:return}game.user.targets.forEach(n=>n.setTarget(!1,{releaseOthers:!1}));const l=[];for(let n of canvas.tokens.placeables)n.document.disposition<=i&&e.shape.contains(n.center.x-e.x,n.center.y-e.y)&&l.push(n);l.forEach((n,c)=>{n.setTarget(!0,{releaseOthers:c===0,groupSelection:!0})}),l.length>0&&game.user.broadcastActivity({targets:game.user.targets.ids}),delete K.throttleTimers[s]},50)}static _onClientSettingChanged(e,t,s){r.log("HooksManager._onClientSettingChanged",[e,t,s]),e==="core.uiConfig"&&this._updateMenuColorScheme()}static _onBrowserColorSchemeChanged(){var t;r.log("HooksManager._onBrowserColorSchemeChanged - Browser color scheme changed");const e=game.settings.get("core","uiConfig");(t=e==null?void 0:e.colorScheme)!=null&&t.interface||this._updateMenuColorScheme()}static _updateMenuColorScheme(){const e=C.coreColorScheme;C.updateColorScheme();const t=C.coreColorScheme,s=V.getInstance();s!=null&&s.rendered&&s.classList&&(e&&s.classList.remove(`theme-${e}`),t&&s.classList.add(`theme-${t}`))}static _onCombatStart(e,t){fe.onCombatStart(e,t)}static _onCombatTurnChange(e,t,s){fe.onCombatTurnChange(e,t,s)}static _onDeleteCombat(e){fe.onCombatEnd(e)}static _onCreateCombatant(e,t,s){fe.onCreateCombatant(e,t,s)}};w(K,"registeredHooks",new Map),w(K,"midiTimeout",null),w(K,"throttleTimers",{}),w(K,"activityConfigCache",new Map),w(K,"CACHE_EXPIRY_MS",3e4),w(K,"templateRemovalTimers",new Set);let ae=K;class Je{static async handleRequest(e){var o,a;const t=D.isModuleOn("midi-qol");if(r.log("handleRequest",[e]),game.user.isGM)return;let s;if(e.isTokenActor){const i=(o=game.scenes.active)==null?void 0:o.tokens.get(e.actorId);if(s=i==null?void 0:i.actor,!s){r.warn("Token actor not found:",e.actorId);return}}else s=game.actors.get(e.actorId);!s||!s.isOwner||(e.preserveTargets&&((a=e.targetTokenIds)==null?void 0:a.length)>0&&(r.log("handleRequest - applyTargetTokens",[e]),Kt(e.targetTokenIds)),t&&e.rollProcessConfig.midiOptions&&(e.rollProcessConfig.midiOptions={...e.rollProcessConfig.midiOptions,fastForward:!1,fastForwardAttack:!1,dialogOptions:{...e.rollProcessConfig.midiOptions.dialogOptions,fastForward:!1,fastForwardAttack:!1},workflowOptions:{...e.rollProcessConfig.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1}}),X.notify("info","",{batch:!0,batchData:{actor:s.name,rollType:e.rollType,rollKey:e.rollKey,gm:e.rollProcessConfig._requestedBy||"GM"}}),this.rollQueue.push({actor:s,requestData:e}),r.log("handleRequest - Added to queue",[this.rollQueue.length,this.isProcessingRoll]),this.isProcessingRoll||this.processNextRoll())}static async processNextRoll(){if(this.rollQueue.length===0){this.isProcessingRoll=!1;return}this.isProcessingRoll=!0;const{actor:e,requestData:t}=this.rollQueue.shift();r.log("processNextRoll - Processing",[e.name,this.rollQueue.length,"remaining"]);try{await this.executePlayerRollRequest(e,t)}catch(s){r.error("Error processing roll request:",[s])}setTimeout(()=>{this.processNextRoll()},500)}static async executePlayerRollRequest(e,t){var o,a;const s=E();C.get(s.publicPlayerRolls.tag),r.log("executePlayerRollRequest",[e,t]),r.log("executePlayerRollRequest - groupRollId check",[t.groupRollId,typeof t.groupRollId]);try{const i=(o=t.rollType)==null?void 0:o.toLowerCase(),l=((a=t.rollProcessConfig.rolls)==null?void 0:a[0])||{parts:[],data:{},options:{}},c={configure:!(game.user.isGM?t.skipRollDialog:!1)},d=t.rollProcessConfig.rollMode,u=game.settings.get("core","rollMode"),p={rollMode:d||u,create:t.rollProcessConfig.chatMessage!==!1,flags:{[b]:{isFlashRollRequest:!0}}},m={rollKey:t.rollKey,activityId:t.activityId,config:t.rollProcessConfig,groupRollId:t.groupRollId},h=se[i];h?await h(e,m,l,c,p):(r.warn(`No handler found for roll type: ${i}`),X.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"})))}catch(i){r.error("Error executing roll request:",[i]),X.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"}))}}}w(Je,"rollQueue",[]),w(Je,"isProcessingRoll",!1);class Ee{static init(){re.initialize(Ee.registerSocketCalls),ae.initialize()}static getDiceConfig(){return ke.getDiceConfig()}static receiveDiceConfig(e,t){ke.receiveDiceConfig(e,t)}static async handleRollRequest(e){return r.log("Main.handleRollRequest",e),Je.handleRequest(e)}static registerSocketCalls(){re.registerCall(Ge.getDiceConfig,Ee.getDiceConfig),re.registerCall(Ge.receiveDiceConfig,Ee.receiveDiceConfig),re.registerCall(Ge.handleRollRequest,Ee.handleRollRequest),re.registerCall(Ge.removeTemplate,D.removeTemplate)}}Ee.init();
//# sourceMappingURL=flash-rolls-5e.js.map
