var _o=Object.defineProperty;var Gt=h=>{throw TypeError(h)};var Io=(h,e,t)=>e in h?_o(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var D=(h,e,t)=>Io(h,typeof e!="symbol"?e+"":e,t),_t=(h,e,t)=>e.has(h)||Gt("Cannot "+t);var B=(h,e,t)=>(_t(h,e,"read from private field"),t?t.call(h):e.get(h)),ne=(h,e,t)=>e.has(h)?Gt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(h):e.set(h,t),ye=(h,e,t,o)=>(_t(h,e,"write to private field"),o?o.call(h,t):e.set(h,t),t),de=(h,e,t)=>(_t(h,e,"access private method"),t);let It;const Co=new RegExp(`([^.[]+|\\[('([^'\\\\]|\\\\.)+?'|"([^"\\\\]|\\\\.)+?")\\])`,"g"),Eo=new RegExp(`(^\\['|'\\]$|^\\["|"\\]$)`,"g");Hooks.once("init",()=>{if(globalThis.libWrapper){It=globalThis.libWrapper;return}It=class{static get is_fallback(){return!0}static get WRAPPER(){return"WRAPPER"}static get MIXED(){return"MIXED"}static get OVERRIDE(){return"OVERRIDE"}static register(h,e,t,o="MIXED",{chain:s=void 0,bind:a=[]}={}){var k;const i=e.endsWith("#set");e=i?e.slice(0,-4):e;const n=e.match(Co).map(y=>y.replace(/\\(.)/g,"$1").replace(Eo,"")),r=n.splice(0,1)[0],l=n.pop();n.join(".");let c,u;if(n.length==0)c=globalThis,u=r;else{const y=eval;u=l,c=n.reduce((S,T)=>S[T],globalThis[r]??y(r))}let g=c,f=null;for(;g&&(f=Object.getOwnPropertyDescriptor(g,u),!f);)g=Object.getPrototypeOf(g);if(!f||(f==null?void 0:f.configurable)===!1)throw new Error(`libWrapper Shim: '${e}' does not exist, could not be found, or has a non-configurable descriptor.`);let p=null;const m=s??(((k=o.toUpperCase)==null?void 0:k.call(o))!="OVERRIDE"&&o!=3)?function(...y){return t.call(this,p.bind(this),...a,...y)}:function(...y){return t.call(this,...a,...y)};if(!i)f.value?(p=f.value,f.value=m):(p=f.get,f.get=m);else{if(!f.set)throw new Error(`libWrapper Shim: '${e}' does not have a setter`);p=f.set,f.set=m}f.configurable=!0,Object.defineProperty(c,u,f)}},globalThis.libWrapper=It});const xt={MODULE_ACTIONS:"moduleActions",ACTOR_ACTIONS:"actorActions"},Xt={"lock-menu":{id:"lock-menu",icon:"fa-lock-keyhole",labelKey:"FLASH_ROLLS.ui.inputs.lockMenu",tooltipKey:"FLASH_ROLLS.ui.inputs.lockMenu",element:"flash5e-actors-lock",type:"button"},"toggle-requests":{id:"toggle-requests",icon:"fa-bolt",labelKey:"FLASH_ROLLS.ui.inputs.toggleRollRequests",tooltipKey:"FLASH_ROLLS.ui.inputs.toggleRollRequests",element:"flash-rolls-toggle",type:"checkbox"},"skip-dialogs":{id:"skip-dialogs",icon:"fa-square-question",labelKey:"FLASH_ROLLS.ui.inputs.skipRollDialog",tooltipKey:"FLASH_ROLLS.ui.inputs.skipRollDialog",element:"flash5e-skip-dialogs",type:"checkbox"},"group-rolls":{id:"group-rolls",icon:"fa-users-rectangle",labelKey:"FLASH_ROLLS.ui.inputs.groupRollsMsg",tooltipKey:"FLASH_ROLLS.ui.inputs.groupRollsMsg",element:"flash5e-group-rolls-msg",type:"checkbox"},"show-options":{id:"show-options",icon:"fa-bars-sort",labelKey:"FLASH_ROLLS.ui.inputs.showOptionsListOnHover",tooltipKey:"FLASH_ROLLS.ui.inputs.showOptionsListOnHover",element:"flash5e-toggle-list",type:"checkbox"},"open-settings":{id:"open-settings",icon:"fa-cog",labelKey:"FLASH_ROLLS.ui.inputs.openSettings",tooltipKey:"FLASH_ROLLS.ui.inputs.openSettings",element:"flash5e-open-settings",type:"button"}},Qt={"select-all":{id:"select-all",icon:"fa-object-group",labelKey:"FLASH_ROLLS.ui.inputs.selectAll",tooltipKey:"FLASH_ROLLS.ui.inputs.selectAll",element:"flash5e-actors-all",type:"checkbox",cssClass:"bulk-action"},"filter-actors":{id:"filter-actors",icon:"fa-filter-list",labelKey:"FLASH_ROLLS.ui.inputs.filterActors",tooltipKey:"FLASH_ROLLS.ui.inputs.filterActors",element:"flash5e-filter-actors",type:"button",cssClass:"bulk-action"},"toggle-targets":{id:"toggle-targets",icon:"fa-crosshairs",labelKey:"FLASH_ROLLS.ui.inputs.toggleTargets",tooltipKey:"FLASH_ROLLS.ui.inputs.toggleTargets",element:"flash5e-targets",type:"button",cssClass:"bulk-action"},"place-tokens":{id:"place-tokens",icon:"fa-location-dot",labelKey:"FLASH_ROLLS.ui.inputs.placeTokens",tooltipKey:"FLASH_ROLLS.ui.inputs.placeTokens",element:"flash5e-place-tokens",type:"button",cssClass:"bulk-action"},"teleport-tokens":{id:"teleport-tokens",icon:"fa-person-to-portal",labelKey:"FLASH_ROLLS.ui.inputs.teleportTokens",tooltipKey:"FLASH_ROLLS.ui.inputs.teleportTokens",element:"flash5e-teleport-tokens",type:"button",cssClass:"bulk-action"},"heal-all":{id:"heal-all",icon:"fa-heart-pulse",labelKey:"FLASH_ROLLS.ui.inputs.healAll",tooltipKey:"FLASH_ROLLS.ui.inputs.healAll",element:"flash5e-heal-selected",type:"button",cssClass:"bulk-action"},"kill-all":{id:"kill-all",icon:"fa-skull",labelKey:"FLASH_ROLLS.ui.inputs.killAll",tooltipKey:"FLASH_ROLLS.ui.inputs.killAll",element:"flash5e-kill-selected",type:"button",cssClass:"bulk-action"},"remove-status":{id:"remove-status",icon:"fa-sparkles",labelKey:"FLASH_ROLLS.ui.inputs.removeStatus",tooltipKey:"FLASH_ROLLS.ui.inputs.removeStatus",element:"flash5e-remove-effects",type:"button",cssClass:"bulk-action"},"open-sheets":{id:"open-sheets",icon:"fa-square-user",labelKey:"FLASH_ROLLS.ui.inputs.openSheets",tooltipKey:"FLASH_ROLLS.ui.inputs.openSheets",element:"flash5e-sheets",type:"button",cssClass:"bulk-action"},"group-selected":{id:"group-selected",icon:"fa-users-medical",labelKey:"FLASH_ROLLS.ui.inputs.groupSelected",tooltipKey:"FLASH_ROLLS.ui.inputs.groupSelected",element:"flash5e-group-selected",type:"button",cssClass:"bulk-action"},movement:{id:"movement",icon:"fa-person-walking",labelKey:"FLASH_ROLLS.ui.inputs.toggleMovement",tooltipKey:"FLASH_ROLLS.ui.inputs.toggleMovement",element:"flash5e-lock-movement",type:"button",cssClass:"bulk-action"},"contested-roll":{id:"contested-roll",icon:"fa-swords",labelKey:"FLASH_ROLLS.ui.inputs.contestedRoll",tooltipKey:"FLASH_ROLLS.ui.inputs.contestedRoll",element:"flash5e-contested-roll",type:"button",cssClass:"bulk-action"},transform:{id:"transform",icon:"fa-frog",labelKey:"FLASH_ROLLS.ui.inputs.transform",tooltipKey:"FLASH_ROLLS.ui.inputs.transform",element:"flash5e-transform",type:"button",cssClass:"bulk-action"}};function wo(h){switch(h){case xt.MODULE_ACTIONS:return Xt;case xt.ACTOR_ACTIONS:return Qt;default:return{}}}function mt(h,e){return wo(e)[h]||null}function yt(){return{moduleActions:[{id:"lock-menu",icon:"fa-lock-keyhole",enabled:!0,order:0},{id:"toggle-requests",icon:"fa-bolt",enabled:!0,order:1},{id:"skip-dialogs",icon:"fa-square-question",enabled:!0,order:2},{id:"group-rolls",icon:"fa-users-rectangle",enabled:!0,order:3},{id:"show-options",icon:"fa-bars-sort",enabled:!0,order:4},{id:"open-settings",icon:"fa-cog",enabled:!0,order:5}],actorActions:[{id:"filter-actors",icon:"fa-filter-list",enabled:!0,order:0},{id:"select-all",icon:"fa-object-group",enabled:!0,order:1},{id:"toggle-targets",icon:"fa-crosshairs",enabled:!0,order:2},{id:"remove-status",icon:"fa-sparkles",enabled:!0,order:3},{id:"teleport-tokens",icon:"fa-person-to-portal",enabled:!0,order:4},{id:"transform",icon:"fa-frog",enabled:!0,order:5},{id:"place-tokens",icon:"fa-location-dot",enabled:!0,order:6},{id:"contested-roll",icon:"fa-swords",enabled:!0,order:7},{id:"group-selected",icon:"fa-users-medical",enabled:!0,order:8},{id:"movement",icon:"fa-person-walking",enabled:!0,order:9},{id:"heal-all",icon:"fa-heart-pulse",enabled:!0,order:10},{id:"kill-all",icon:"fa-skull",enabled:!0,order:11},{id:"open-sheets",icon:"fa-square-user",enabled:!0,order:12}]}}const V={select:"select",checkbox:"checkbox"},G={client:"client",world:"world"},qt=yt(),C=()=>({generalSettings:{tag:"flash5e-general-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["showMenuOnLoad","skipRollDialog","skipRollDialogOption","skipToRollResolver","showOnlyPCsWithToken","addMacrosToFolder","templateAutoTarget","removeTemplate","tooltipAutoDismiss","templateRemovalTimeout","tokenMovementSpeed","autoBlockMovementInCombat","disableNotifications"],default:{showMenuOnLoad:!1,skipRollDialog:!1,skipRollDialogOption:1,skipToRollResolver:!1,showOnlyPCsWithToken:!0,addMacrosToFolder:!0,templateAutoTarget:1,removeTemplate:!0,tooltipAutoDismiss:2,tokenMovementSpeed:6,templateRemovalTimeout:5,autoBlockMovementInCombat:!1,disableNotifications:!1},scope:G.world,config:!1,requiresReload:!1},interfaceSettings:{tag:"flash5e-interface-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["showMenuOnLoad","showTokenVisionOnHover","compactMode","menuLayout","menuIconsLayout","maxIconsPerRow","teleportAnimationPath","lockMenuPosition"],default:{showMenuOnLoad:!1,showTokenVisionOnHover:!0,compactMode:!0,menuLayout:"vertical",menuIconsLayout:qt,maxIconsPerRow:5,teleportAnimationPath:"",lockMenuPosition:!1},scope:G.world,config:!1,requiresReload:!1},groupRollsSettings:{tag:"flash5e-group-rolls-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["groupRollsMsgEnabled","groupRollResultMode","showGroupDCToPlayers","showGroupResultToPlayers","groupRollNPCHidden","concealNPCNames","interceptTidySheetsGroupRolls","disableDialogInPlayerGroupRoll"],default:{groupRollsMsgEnabled:!0,groupRollResultMode:1,showGroupDCToPlayers:!1,showGroupResultToPlayers:!0,groupRollNPCHidden:!0,concealNPCNames:!1,interceptTidySheetsGroupRolls:!0,disableDialogInPlayerGroupRoll:!1},scope:G.world,config:!1,requiresReload:!1},rollRequestsSettings:{tag:"flash5e-roll-request-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["rollInterceptionEnabled","useGMTargetTokens","consumptionConfigMode","placeTemplateForPlayer","showOfflineNotifications","initiateCombatOnRequest","publicPlayerRolls","useCondensedRollMessage"],default:{rollInterceptionEnabled:!0,useGMTargetTokens:!0,consumptionConfigMode:2,placeTemplateForPlayer:!1,showOfflineNotifications:!0,initiateCombatOnRequest:!0,publicPlayerRolls:!1,useCondensedRollMessage:!1},scope:G.world,config:!1,requiresReload:!1},showGroupDCToPlayers:{tag:"show-group-dc-to-players",label:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},showGroupResultToPlayers:{tag:"show-group-result-to-players",label:game.i18n.localize("FLASH_ROLLS.settings.showGroupResultToPlayers.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showGroupResultToPlayers.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},groupRollNPCHidden:{tag:"group-roll-npc-hidden",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollNPCHidden.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollNPCHidden.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},concealNPCNames:{tag:"conceal-npc-names",label:game.i18n.localize("FLASH_ROLLS.settings.concealNPCNames.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.concealNPCNames.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},interceptTidySheetsGroupRolls:{tag:"intercept-tidy-sheets-group-rolls",label:game.i18n.localize("FLASH_ROLLS.settings.interceptTidySheetsGroupRolls.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.interceptTidySheetsGroupRolls.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},disableDialogInPlayerGroupRoll:{tag:"disable-dialog-in-player-group-roll",label:game.i18n.localize("FLASH_ROLLS.settings.disableDialogInPlayerGroupRoll.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.disableDialogInPlayerGroupRoll.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!0},groupRollsMsgEnabled:{tag:"group-roll-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},groupRollResultMode:{tag:"group-roll-result-mode",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.hint"),propType:Number,inputType:V.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.4")},default:1,scope:G.world,config:!1},consumptionConfigMode:{tag:"consumption-config",label:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.hint"),propType:Number,inputType:V.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.4")},default:2,scope:G.world,config:!1},placeTemplateForPlayer:{tag:"place-template-for-player",label:game.i18n.localize("FLASH_ROLLS.settings.placeTemplateForPlayer.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.placeTemplateForPlayer.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},skipRollDialog:{tag:"skip-roll-dialog",label:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},skipRollDialogOption:{tag:"skip-roll-dialog-options",label:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.hint"),propType:Number,inputType:V.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialogOption.choices.3")},default:1,scope:G.world,config:!1},skipToRollResolver:{tag:"skip-to-roll-resolver",label:game.i18n.localize("FLASH_ROLLS.settings.skipToRollResolver.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipToRollResolver.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},rollInterceptionEnabled:{tag:"roll-interception-on",label:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},publicPlayerRolls:{tag:"public-player-roll-messages",label:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},showRequestNotifications:{tag:"show-request-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},initiateCombatOnRequest:{tag:"initiate-combat-on-request",label:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},useCondensedRollMessage:{tag:"use-condensed-roll-message",label:game.i18n.localize("FLASH_ROLLS.settings.useCondensedRollMessage.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.useCondensedRollMessage.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},showOnlyPCsWithToken:{tag:"show-only-pcs-with-token",label:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},compactMode:{tag:"compact-mode",label:game.i18n.localize("FLASH_ROLLS.settings.compactMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.compactMode.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},menuLayout:{tag:"menu-layout",label:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.hint"),propType:String,inputType:V.select,choices:{vertical:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.choices.vertical"),horizontal:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.choices.horizontal")},default:"vertical",scope:G.world,config:!1},lockMenuPosition:{tag:"lock-menu-position",label:game.i18n.localize("FLASH_ROLLS.settings.lockMenuPosition.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.lockMenuPosition.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},maxIconsPerRow:{tag:"max-icons-per-row",label:game.i18n.localize("FLASH_ROLLS.settings.maxIconsPerRow.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.maxIconsPerRow.hint"),propType:Number,default:5,scope:G.world,config:!1},showOptionsListOnHover:{tag:"show-list-on-hover",label:game.i18n.localize("FLASH_ROLLS.settings.showOptionsListOnHover.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOptionsListOnHover.hint"),propType:Boolean,default:!0,scope:G.world,config:!1},templateAutoTarget:{tag:"template-auto-target",label:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.hint"),propType:Number,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.all.label"),2:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.notFriendly.label"),3:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.none.label")},inputType:V.select,default:1,scope:G.world,config:!1},removeTemplate:{tag:"remove-template",label:game.i18n.localize("FLASH_ROLLS.settings.removeTemplate.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.removeTemplate.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},templateRemovalTimeout:{tag:"template-removal-timeout",label:game.i18n.localize("FLASH_ROLLS.settings.templateRemovalTimeout.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.templateRemovalTimeout.hint"),propType:Number,default:5,scope:G.world,config:!1,range:{min:0,max:30,step:1}},debugMode:{tag:"debug-mode-on",label:game.i18n.localize("FLASH_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.client,config:!0},showMenuOnLoad:{tag:"show-menu-on-world-load",label:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},showTokenVisionOnHover:{tag:"show-token-vision-on-hover",label:game.i18n.localize("FLASH_ROLLS.settings.showTokenVisionOnHover.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showTokenVisionOnHover.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},addMacrosToFolder:{tag:"add-macros-to-folder",label:game.i18n.localize("FLASH_ROLLS.settings.addMacrosToFolder.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.addMacrosToFolder.hint"),propType:Boolean,inputType:V.checkbox,default:!0,scope:G.world,config:!1},menuIconsLayout:{tag:"menu-icons-layout",label:game.i18n.localize("FLASH_ROLLS.settings.menuIconsLayout.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.menuIconsLayout.hint"),propType:Object,default:qt,scope:G.world,config:!1},autoBlockMovementInCombat:{tag:"auto-block-movement-in-combat",label:game.i18n.localize("FLASH_ROLLS.settings.autoBlockMovementInCombat.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.autoBlockMovementInCombat.hint"),propType:Boolean,inputType:V.checkbox,default:!1,scope:G.world,config:!1},tokenMovementSpeed:{tag:"token-movement-speed",label:game.i18n.localize("FLASH_ROLLS.settings.tokenMovementSpeed.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.tokenMovementSpeed.hint"),propType:Number,default:6,scope:G.world,config:!1,range:{min:1,max:20,step:1}},tooltipAutoDismiss:{tag:"tooltip-auto-dismiss",label:game.i18n.localize("FLASH_ROLLS.settings.tooltipAutoDismiss.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.tooltipAutoDismiss.hint"),propType:Number,default:2,scope:G.world,config:!1,range:{min:0,max:10,step:1}},teleportAnimationPath:{tag:"teleport-animation-path",label:game.i18n.localize("FLASH_ROLLS.settings.teleportAnimationPath.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.teleportAnimationPath.hint"),propType:String,inputType:"filepicker",default:"",scope:G.world,config:!1,filePicker:"video"},legacyTokenAssociationsMigrated:{tag:"legacy-token-associations-migrated",label:game.i18n.localize("FLASH_ROLLS.settings.legacyTokenAssociationsMigrated.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.legacyTokenAssociationsMigrated.hint"),propType:Boolean,default:!1,scope:G.world,config:!1},disableNotifications:{tag:"disable-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.disableNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.disableNotifications.hint"),propType:Boolean,default:!1,scope:G.world,config:!1},lastUpdateId:{tag:"last-update-id",label:"Last Update ID",hint:"Stores the ID of the last update news shown",propType:String,default:"",scope:G.client,config:!1},libWrapperNotificationShown:{tag:"libwrapper-notification-shown",label:"LibWrapper Notification Shown",hint:"Tracks whether the libWrapper recommendation notification has been shown",propType:Boolean,default:!1,scope:G.world,config:!1},transformFavorites:{tag:"transform-favorites",label:"Transformation Favorites",hint:"Stores favorite transformation targets",propType:Array,default:[],scope:G.world,config:!1}}),R="flash-rolls-5e",pt=["%cFlash Token Bar 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],Be={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest",removeTemplate:"removeTemplate",broadcastRollComplete:"broadcastRollComplete"},se={ATTACK:"attack",DAMAGE:"damage",HEAL:"heal",SAVE:"save"},A={ABILITY:"ability",ABILITY_CHECK:"abilitycheck",ATTACK:"attack",CONCENTRATION:"concentration",CUSTOM:"custom",DEATH_SAVE:"deathsave",FORMULA:"formula",DAMAGE:"damage",HEALING:"healing",HIT_DIE:"hitdie",INITIATIVE:"initiative",INITIATIVE_DIALOG:"initiativedialog",ITEM_SAVE:"itemsave",SAVE:"save",SAVING_THROW:"savingthrow",SKILL:"skill",TOOL:"tool"},Ke={ABILITY_CHECK:{name:A.ABILITY_CHECK,label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:A.SAVING_THROW,label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:A.SKILL,label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:A.TOOL,label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:A.CONCENTRATION,label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:A.INITIATIVE,label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:A.DEATH_SAVE,label:"Death Save",subList:null,actorPath:""},HIT_DIE:{name:A.HIT_DIE,label:"Hit Die",subList:null,actorPath:""},CUSTOM:{name:A.CUSTOM,label:"Custom Roll",subList:null,actorPath:""}},W={ID:R,ROLL_REQUEST_OPTIONS:Ke},H={INIT:"init",READY:"ready",RENDER_CHAT_MESSAGE:"renderChatMessageHTML",RENDER_CHAT_LOG:"renderChatLog",RENDER_CHAT_INPUT:"renderChatInput",CHANGE_SIDEBAR_TAB:"changeSidebarTab",RENDER_SIDEBAR:"renderSidebar",UPDATE_SCENE:"updateScene",RENDER_ROLL_RESOLVER:"renderRollResolver",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",CREATE_CHAT_MESSAGE:"createChatMessage",COLLAPSE_SIDE_BAR:"collapseSidebar",REFRESH_MEASURED_TEMPLATE:"refreshMeasuredTemplate",CONTROL_TOKEN:"controlToken",UPDATE_TOKEN:"updateToken",PRE_UPDATE_TOKEN:"preUpdateToken",DELETE_TOKEN:"deleteToken",CREATE_TOKEN:"createToken",UPDATE_ACTOR:"updateActor",CREATE_ACTOR:"createActor",DELETE_ACTOR:"deleteActor",UPDATE_ITEM:"updateItem",CREATE_ITEM:"createItem",DELETE_ITEM:"deleteItem",UPDATE_SETTING:"updateSetting",CLIENT_SETTING_CHANGED:"clientSettingChanged",GET_ACTOR_CONTEXT_OPTIONS:"getActorContextOptions",GET_CHAT_MESSAGE_CONTEXT_OPTIONS:"getChatMessageContextOptions",RENDER_ACTOR_DIRECTORY:"renderActorDirectory",CREATE_COMBATANT:"createCombatant",DELETE_COMBATANT:"deleteCombatant",UPDATE_COMBAT:"updateCombat",DELETE_COMBAT:"deleteCombat",COMBAT_START:"combatStart",COMBAT_TURN_CHANGE:"combatTurnChange",CREATE_ACTIVE_EFFECT:"createActiveEffect",DELETE_ACTIVE_EFFECT:"deleteActiveEffect",UPDATE_ACTIVE_EFFECT:"updateActiveEffect",PRE_CREATE_TOKEN:"preCreateToken",CANVAS_READY:"canvasReady"},Oo={READY:"socketlib.ready"},Do={READY:"midi-qol.ready"},ee={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_USE_ACTIVITY:"dnd5e.preUseActivity",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE_DIALOG:"dnd5e.preRollInitiativeDialog",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",ROLL_DAMAGE_V2:"dnd5e.rollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog",RENDER_SKILL_TOOL_ROLL_DIALOG:"renderSkillToolRollConfigurationDialog",RENDER_GROUP_ACTOR_SHEET:"renderGroupActorSheet",RENDER_ENCOUNTER_ACTOR_SHEET:"renderEncounterActorSheet"},qe={READY:"tidy5e-sheet.ready",PRE_PROMPT_GROUP_SKILL_ROLL:"tidy5e-sheet.prePromptGroupSkillRoll",RENDER_ACTOR_SHEET:"tidy5e-sheet.renderActorSheet",RENDER_GROUP_SHEET_QUADRONE:"renderTidy5eGroupSheetQuadrone",RENDER_GROUP_SHEET_CLASSIC:"renderTidy5eGroupSheetClassic",RENDER_ENCOUNTER_SHEET_QUADRONE:"renderTidy5eEncounterSheetQuadrone",RENDER_ENCOUNTER_SHEET_CLASSIC:"renderTidy5eEncounterSheetClassic"},Mo={READY:"ready"};var He;let d=(He=class{static log(e="",t=[],o=!1){try{const s=game.settings.get(R,"debug-mode-on")||He.debugOn;if(!(o||s))return;const i=Array.isArray(t)?t:[t];console.log(...pt,e,...i)}catch{if(o||He.debugOn){const a=Array.isArray(t)?t:[t];console.log(...pt,e,...a)}}}static warn(e="",t=[]){const o=Array.isArray(t)?t:[t];console.warn(...pt,e,...o)}static error(e,t=[],o={ui:!1,console:!0,permanent:!1}){var a;const s=Array.isArray(t)?t:[t];o.ui&&((a=ui.notifications)==null||a.error(e,{localize:!0,permanent:o.permanent})),o.console&&console.error(...pt,e,...s)}},D(He,"debugOn",!1),He);const oe=class oe{static serializeForTransport(e,t=!1){return d.log("serializeForTransport",[e,t]),e==null||t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(o=>o instanceof Roll?o.toJSON():o)),e}static deserializeFromTransport(e,t=!1){d.log("deserializeFromTransport",[e,t]);let o={...e};if(!e)return o;if(t&&e.rolls&&e.rolls.length>0){const s=o.rolls.map(a=>{let i=a;return typeof a=="string"?i=Roll.fromJSON(a):a instanceof Roll?i=a:i=Roll.fromJSON(JSON.stringify(a)),i});return o.rolls=[...s],o}return o}};D(oe,"socket"),D(oe,"_activeExecutions",new Map),D(oe,"initialize",e=>{d.log("initialize",[e]),Hooks.once(Oo.READY,()=>{if(typeof socketlib>"u"){d.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{oe.socket=socketlib.registerModule(R),e&&e()}catch(t){d.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled.",[t])}})}),D(oe,"registerCall",(e,t)=>{d.log("registerCall",[e]),oe.socket&&oe.socket.register(e,t)}),D(oe,"sendMessage",(e,t)=>{d.log("sendMessage",[e]),t&&t()}),D(oe,"execForGMs",async(e,...t)=>{if(d.log("execForGMs",[e,...t]),!!oe.socket)return await oe.socket.executeForAllGMs(e,...t)}),D(oe,"execForAll",async(e,...t)=>{if(oe.socket)return await oe.socket.executeForEveryone(e,...t)}),D(oe,"execForUser",async(e,t,...o)=>{if(d.log("execForUser #0",[e,t,...o]),!oe.socket)return;if(d.log("execForUser #1",[t===game.user.id]),t===game.user.id)return null;const s=`${e}-${t}`;if(d.log("execForUser #2",[oe._activeExecutions.has(s)]),oe._activeExecutions.has(s))return null;oe._activeExecutions.set(s,!0);try{const a=await oe.socket.executeAsUser(e,t,...o);return d.log("execForUser #3 - response",[a]),a}catch(a){return d.error("execForUser #4 - error",[a]),null}finally{d.log("execForUser #5 - success",[]),oe._activeExecutions.delete(s)}});let ge=oe;class Ce{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const e=game.settings.storage.get("client");return this.diceConfig=e["core.diceConfiguration"]||"",d.log("setDiceConfig",[this.diceConfig]),this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){ge.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(e,t){var o,s;((o=game.user)!=null&&o.isGM||e===((s=game.user)==null?void 0:s.id))&&(this.playerDiceConfigs[e]=t?JSON.parse(t):{})}static getUserDiceConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?this.diceConfig:this.playerDiceConfigs[e]||{}}static requestDiceConfigFromUser(e){try{ge.execForUser("getDiceConfig",e)}catch(t){d.log("Failed to request dice config from user:",[e,t.message])}}static requestDiceConfigFromAllPlayers(){var e;(e=game.user)!=null&&e.isGM&&game.users.forEach(t=>{t.active&&!t.isGM&&t.id!==game.user.id&&this.requestDiceConfigFromUser(t.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?!!this.diceConfig:!!this.playerDiceConfigs[e]}static hasNonDigitalDice(e){var a,i;let t=e?this.getUserDiceConfig(e):this.diceConfig;if(t||(this.setDiceConfig(),t=this.diceConfig,d.log("hasNonDigitalDice - config was empty, refreshed:",[t])),!t||typeof t!="object"&&typeof t!="string")return d.log("hasNonDigitalDice - no config or wrong type",[typeof t,t]),!1;let o;try{o=typeof t=="string"?JSON.parse(t):t}catch(n){return d.error("hasNonDigitalDice - failed to parse config",[t,n]),!1}const s=(i=(a=CONFIG.Dice)==null?void 0:a.fulfillment)==null?void 0:i.methods;d.log("hasNonDigitalDice - all available methods:",[s]),d.log("hasNonDigitalDice - user config:",[o]);for(const n of Object.values(o))if(n){if(d.log("hasNonDigitalDice - checking method value:",[n]),n==="manual")return d.log("hasNonDigitalDice - found manual method"),!0;if(n!=="random"){const r=s==null?void 0:s[n];return d.log("hasNonDigitalDice - found non-random method",[n,"config:",r,"interactive:",r==null?void 0:r.interactive]),r!=null&&r.interactive?(d.log("hasNonDigitalDice - method is interactive"),!0):(d.log("hasNonDigitalDice - treating non-random method as non-digital"),!0)}}return d.log("hasNonDigitalDice - no non-digital dice found"),!1}}D(Ce,"diceConfig",{}),D(Ce,"playerDiceConfigs",{});var Tt,Zt;const nt=class nt{static notify(e,t){var o;try{const s=C();if((o=s==null?void 0:s.disableNotifications)!=null&&o.tag&&_.get(s.disableNotifications.tag))return}catch{}e==="info"?ui.notifications.info(t):e==="warn"?ui.notifications.warn(t):e==="error"&&ui.notifications.error(t)}static isModuleOn(e){var o;const t=(o=game.modules)==null?void 0:o.get(e);return!!(t!=null&&t.active)}static html(e,t){return e.querySelector(t)}static getFullWidth(e){return window.getComputedStyle(e).width==="0px"?0:e.offsetWidth}static preventDialogFlicker(e,t=0){e&&(e.style.opacity="0",e.style.transition="opacity 0.15s ease-in",requestAnimationFrame(()=>{e&&(e.style.opacity="1")}))}static addCSSVars(e,t){let o=document.querySelector("style#flash5e-vars");if(!o){const g=document.querySelector("body.flash5e");if(!g)return;const f=g.querySelector("style#flash5e-vars");f&&f.remove(),o=document.createElement("style"),o.id="flash5e-vars",o.textContent=`body.flash5e {
}
`,g.prepend(o)}let s=o.textContent,a=s.indexOf("body.flash5e {"),i=s.indexOf("}",a);a===-1&&(s=`body.flash5e {
}
`,a=0,i=s.indexOf("}"));const r=s.substring(a+14,i).split(";").map(g=>g.trim()).filter(g=>g!==""),l={};r.forEach(g=>{const f=g.split(":");if(f.length>=2){const p=f[0].trim(),m=f.slice(1).join(":").trim();p&&(l[p]=m)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),l[e]=t;const c=Object.entries(l).map(([g,f])=>`  ${g}: ${f};`).join(`
`),u=s.substring(0,a)+`body.flash5e {
`+c+`
}`+s.substring(i+1);o.textContent=u}static getOffsetBottom(e){const t=e.offsetTop,o=e.offsetHeight;return window.innerHeight-(t+o)}static async getAllFonts(){const e=new Set(Object.keys(CONFIG.fontDefinitions)),t=game.settings.get("core","fonts")||{},o=Object.entries(t).map(([i])=>i),s=await this.processStyleSheets();return Array.from(new Set([...e,...o,...s])).filter(i=>!/FontAwesome|Font Awesome|FoundryVTT/.test(i)).map(i=>i.replace(/['"]/g,"").trim()).sort((i,n)=>i.toLowerCase().localeCompare(n.toLowerCase()))||[]}static addCustomCSS(e,t="flash5e-custom-css",o=!0){if(!e)return;let s=document.querySelector("#"+t);s||(s=document.createElement("style"),s.id=t,s.textContent="",document.head.appendChild(s));const a=/@import\s+(?:url\()?\s*['"]?[^'")]+['"]?\s*\)?\s*;/g,i=[];let n=e,r;for(;(r=a.exec(e))!==null;)i.push(r[0]);if(n=e.replace(a,"").trim(),!o){s.textContent=i.join(`
`)+(i.length?`

`:"")+n;return}if(!s.textContent.includes(n)){const l=s.textContent,c=[];let u;for(;(u=a.exec(l))!==null;)c.push(u[0]);const g=l.replace(a,"").trim(),f=i.filter(m=>!c.includes(m)),p=[...c,...f];s.textContent=p.join(`
`)+(p.length?`

`:"")+g+(g&&n?`

`:"")+n}}static smoothScrollTo(e,t,o="horizontal",s=300,a=null){const i=e.dataset.scrollAnimationId;i&&cancelAnimationFrame(Number(i));const n=o==="horizontal",r=n?e.scrollLeft:e.scrollTop,l=t-r;if(l===0)return a&&a(),null;const c=performance.now(),u=f=>{const p=f-c;if(p>=s){n?e.scrollLeft=t:e.scrollTop=t,delete e.dataset.scrollAnimationId,a&&a();return}const m=p/s,k=m<.5?2*m*m:1-Math.pow(-2*m+2,2)/2;n?e.scrollLeft=r+l*k:e.scrollTop=r+l*k;const y=requestAnimationFrame(u);return e.dataset.scrollAnimationId=y,y},g=requestAnimationFrame(u);return e.dataset.scrollAnimationId=g,g}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredLabel"),o={}){const s={window:{title:e},position:{width:420,height:"auto"},content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.reloadButton"),callback:()=>(d.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(s,o),foundry.applications.api.DialogV2.confirm(s)}static renderTemplate(e,t){return foundry.applications.handlebars.renderTemplate(e,t)}static loadTemplate(e){return foundry.applications.handlebars.loadTemplate(e)}static loadTemplates(e){return Array.isArray(e)||(e=[e]),foundry.applications.handlebars.loadTemplates(e)}static isValidCSSRule(e){if(!e||typeof e!="string")return!1;const t=e.trim();if(!t)return!1;try{const o=document.createElement("style"),s=`${t} { color: inherit; }`;o.textContent=s,document.head.appendChild(o);const a=!!(o.sheet&&o.sheet.cssRules&&o.sheet.cssRules.length>0);return document.head.removeChild(o),a}catch(o){return d.log("CSS validation error:",[o,e]),!1}}static processCSSRules(e,t){if(!e||!t)return"";const o=de(this,Tt,Zt).call(this,e),s=t+` {
`+o.baseProperties.join(`
`)+`
}`,a=[],i=new Map;return o.nestedRules.forEach(n=>{const{selector:r,content:l}=n;if(r.startsWith("&")){const g=r.substring(1),f=t.split(",").map(p=>p.trim()).filter(Boolean).map(p=>p+g).join(", ");a.push(`${f} {
${l}
}`);return}i.has(l)||i.set(l,[]);const c=r.split(",").map(g=>g.trim()),u=t.split(",").map(g=>g.trim()).filter(Boolean);c.forEach(g=>{u.forEach(f=>{i.get(l).push(`${f} ${g}`)})})}),i.forEach((n,r)=>{a.push(`${n.join(", ")} {
${r}
}`)}),s+`

`+a.join(`

`)}static getActorOwner(e){const t=e.ownership||{};for(const[o,s]of Object.entries(t))if(s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const a=game.users.get(o);if(a&&!a.isGM)return a}if((t==null?void 0:t.default)>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const o=game.users.filter(s=>!s.isGM)[0];if(o)return o}return null}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredLabel"),o={}){const s={window:{title:e},position:{width:420,height:"auto"},content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.reloadButton"),callback:()=>(d.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(s,o),foundry.applications.api.DialogV2.confirm(s)}static async removeTemplateForItem(e){const t=C(),o=_.get(t.removeTemplate.tag);if(d.log("removeTemplateForItem",[e,o]),!!o){if(!game.user.isGM){d.log("removeTemplateForItem - requesting GM to remove template",[e==null?void 0:e.uuid]),ge.execForGMs("removeTemplate",e==null?void 0:e.uuid);return}try{const s=canvas.templates.objects.children.filter(a=>a.document.flags.dnd5e.item===(e==null?void 0:e.uuid));if(s.length>0){const a=s.map(n=>n.id),i=canvas.scene.templates.filter(n=>a.includes(n.id));i.length>0?(d.log("removeTemplateForItem - removing templates",[e==null?void 0:e.uuid,i.length]),await canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate",i.map(n=>n.id))):d.log("removeTemplateForItem - templates already removed",[e==null?void 0:e.uuid])}}catch(s){d.log("removeTemplateForItem - template not found or already deleted",[e==null?void 0:e.uuid,s.message])}}}static async removeTemplate(e){d.log("removeTemplate",[e]);try{const t=await fromUuid(e);if(t&&game.user.isGM)return nt.removeTemplateForItem(t)}catch(t){d.error("removeTemplate - error",[t])}}static areSkipKeysPressed(e){const{areKeysPressed:t}=game.dnd5e.utils||{};return t?t(e,"skipDialogNormal")||t(e,"skipDialogAdvantage")||t(e,"skipDialogDisadvantage"):e.shiftKey||e.altKey||e.ctrlKey||e.metaKey||!1}};Tt=new WeakSet,Zt=function(e){const t=[],o=[],s=e.split(`
`);let a=null,i=0;for(let n=0;n<s.length;n++){const r=s[n].trim();if(!r)continue;const l=(r.match(/{/g)||[]).length,c=(r.match(/}/g)||[]).length;if(r.includes("{")&&!a){a={selector:r.substring(0,r.indexOf("{")).trim(),content:"",startLine:n},i=1;const g=r.substring(r.indexOf("{")+1).trim();g&&!g.includes("}")&&(a.content+=g+`
`)}else a?(i+=l-c,i>0?a.content+=r+`
`:(a.content=a.content.replace(/}\s*$/,"").trim(),o.push(a),a=null)):!r.includes("{")&&!r.includes("}")&&t.push(r)}return{baseProperties:t,nestedRules:o}},ne(nt,Tt),D(nt,"wrapFontName",e=>{const t=e.replace(/['"`]/g,"");return t.includes(" ")?`"${t}"`:t});let q=nt;function Fo(h,e){var s,a,i,n,r;let t=game.i18n.localize(`FLASH_ROLLS.rollTypes.${h}`)||h;const o=h==null?void 0:h.toLowerCase();if(e)switch(o){case A.SKILL:t+=` (${((s=CONFIG.DND5E.skills[e])==null?void 0:s.label)||e})`;break;case A.SAVE:t+=` (${((a=CONFIG.DND5E.abilities[e])==null?void 0:a.label)||e})`;break;case A.ABILITY:t+=` (${((i=CONFIG.DND5E.abilities[e])==null?void 0:i.label)||e})`;break;case A.TOOL:const l=(r=(n=CONFIG.DND5E.enrichmentLookup)==null?void 0:n.tools)==null?void 0:r[e];if(l!=null&&l.id){const c=dnd5e.documents.Trait.getBaseItem(l.id,{indexOnly:!0});t+=` (${(c==null?void 0:c.name)||e})`}else t+=` (${e})`;break;case A.CUSTOM:t=`${t}: ${e}`;break}return t}function Po(h,e){var o,s,a,i,n;if(!e)return"";switch(h==null?void 0:h.toLowerCase()){case A.SKILL:return((o=CONFIG.DND5E.skills[e])==null?void 0:o.label)||e;case A.SAVE:case A.SAVING_THROW:return((s=CONFIG.DND5E.abilities[e])==null?void 0:s.label)||e;case A.ABILITY:case A.ABILITY_CHECK:return((a=CONFIG.DND5E.abilities[e])==null?void 0:a.label)||e;case A.TOOL:const r=(n=(i=CONFIG.DND5E.enrichmentLookup)==null?void 0:i.tools)==null?void 0:n[e];if(r!=null&&r.id){const l=dnd5e.documents.Trait.getBaseItem(r.id,{indexOnly:!0});return(l==null?void 0:l.name)||e}return e;default:return e}}function Ho(h,e=Fo){if(h.length===0||!(ui!=null&&ui.notifications))return;const t={};for(const s of h){const a=`${s.rollType}_${s.rollKey||""}`;t[a]||(t[a]={rollType:s.rollType,rollKey:s.rollKey,actors:[],gm:s.gm}),t[a].actors.push(s.actor)}const o=Object.values(t);if(o.length===1&&o[0].actors.length===1){const s=o[0];I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestReceived",{gm:s.gm,rollType:e(s.rollType,s.rollKey)}))}else{const s=[];for(const a of o){const i=e(a.rollType,a.rollKey),n=a.actors.join(", ");s.push(`${i} (${n})`)}I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestsReceivedMultiple",{gm:o[0].gm,requests:s.join("; ")}))}}function eo(h){const e=h.ownership||{};for(const[t,o]of Object.entries(e))if(o>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const s=game.users.get(t);if(s&&!s.isGM)return s}return null}function No(h,e=game.user){h!=null&&h.length&&h.forEach((t,o)=>{d.log("applyTargetTokens",[t,canvas.tokens.placeables.map(a=>a.id)]);const s=canvas.tokens.placeables.find(a=>a.id===t);s?s.setTarget(!0,{releaseOthers:o===0}):d.warn("applyTargetTokens - Token not found:",[t])})}function Pt(h){return h.type!=="character"&&h.type!=="npc"?!1:Object.entries(h.ownership).some(([e,t])=>{const o=game.users.get(e);return o&&!o.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}function to(h){if(h.type!=="character"&&h.type!=="npc")return!1;const e=game.scenes.current;return e&&e.tokens.some(t=>t.actorId===h.id)}function Se(h,e,t=null){if(!game.scenes.current)return;let s;if(t){const a=canvas.tokens.placeables.find(i=>i.id===t);s=a?[a]:[]}else s=canvas.tokens.placeables.filter(a=>{var i;return((i=a.actor)==null?void 0:i.id)===h});for(const a of s)e?a.control({releaseOthers:!1}):a.release()}function Rt(h){return new Promise(e=>setTimeout(e,h))}function Bt(){var h;return((h=ui==null?void 0:ui.sidebar)==null?void 0:h.expanded)||!1}function Ut(h){const e=document.querySelector("body");h?e.classList.add("flash-sidebar-expanded"):e.classList.remove("flash-sidebar-expanded"),Ue()}function zt(h,e){var a,i;const t=[];if(!h)return t;const o=W.ROLL_REQUEST_OPTIONS[h];if(!o||!o.subList)return t;const s=CONFIG.DND5E[o.subList];if(s){for(const[n,r]of Object.entries(s)){let l=r.label||r.name||n;if(o.subList==="tools"&&((i=(a=CONFIG.DND5E.enrichmentLookup)==null?void 0:a.tools)!=null&&i[n])){const c=CONFIG.DND5E.enrichmentLookup.tools[n];if(c!=null&&c.id){const u=dnd5e.documents.Trait.getBaseItem(c.id,{indexOnly:!0});l=(u==null?void 0:u.name)||l}}t.push({id:n,name:l,rollable:!0})}t.sort((n,r)=>n.name.localeCompare(r.name))}return t}const re=class re{static notify(e,t,o={}){var s;if(!o.batch){(s=ui==null?void 0:ui.notifications)!=null&&s[e]&&ui.notifications[e](t);return}o.batchData&&(re.pendingNotifications.push(o.batchData),re.notificationTimer&&clearTimeout(re.notificationTimer),re.notificationTimer=setTimeout(()=>{Ho(re.pendingNotifications),re.pendingNotifications=[],re.notificationTimer=null},re.NOTIFICATION_BATCH_DELAY))}static notifyRollRequestsSent(e,t){const o=Object.entries(e);if(o.length!==0)if(o.length===1){const s=Object.values(e)[0],a=s.actors.map(i=>i.name).join(", ");I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentSingle",{rollType:t,actors:a,player:s.player.name}))}else{const s=o.map(([a,i])=>{const n=i.actors.map(r=>r.name).join(", ");return`${i.player.name} (${n})`});I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentMultiple",{rollType:t,count:o.length,players:s.join("; ")}))}}static clearPending(){re.notificationTimer&&(clearTimeout(re.notificationTimer),re.notificationTimer=null),re.pendingNotifications=[]}};D(re,"pendingNotifications",[]),D(re,"notificationTimer",null),D(re,"NOTIFICATION_BATCH_DELAY",500);let ie=re;function Go(h){var o;const e=[],t=[];for(const s of h){const a=((o=s.system.attributes.hp)==null?void 0:o.value)||0,i=s.system.attributes.death||{},n=i.success||0,r=i.failure||0;a<=0&&n<3&&r<3?e.push(s):t.push(s.name)}return t.length>0&&ie.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorsSkippingDeathSave",{actors:t.join(", ")})),e}function xo(h){const e=[],t=[];for(const o of h){const s=eo(o);s?e.push({actor:o,owner:s}):t.push(o)}return{pcActors:e,npcActors:t}}function Ue(h=!0){const e=document.querySelector("#chat-notifications #roll-privacy"),t=e?q.getFullWidth(e):36,o=!!document.querySelector("body.crlngn-tabs");q.addCSSVars("--flash-rolls-menu-offset",(o?t:t+16)+"px")}function Y(h){var s,a;const e=(s=game.scenes.current)==null?void 0:s.tokens.get(h);if(e!=null&&e.actor)return e.actor;const t=(a=canvas.tokens)==null?void 0:a.get(h);return t!=null&&t.actor?t.actor:game.actors.get(h)||null}function $t(){const h=C();switch(_.get(h.consumptionConfigMode.tag)){case 1:return!1;case 2:return game.user.isGM;case 3:return!game.user.isGM;default:return!0}}function Xe(h,e=!0){let t={...h};return game.user.isGM&&(t.action=e?h.action:!1,t.resources=e?h.resources:[],t.spellSlot=e?h.spellSlot:!1),t}function St(h,e=!0){var n;const t=C(),o=_.get(t.placeTemplateForPlayer.tag),s=h.measuredTemplate===!0,a=(n=game.modules.get("midi-qol"))==null?void 0:n.active;let i;return game.user.isGM?i=e||o:a&&o&&s&&!e?i=!0:i=!o,d.log("getCreateConfig",[h,e,o,s,i,a]),{...h,measuredTemplate:s?i:!1}}const P={addSituationalBonus(h,e){var t;return d.log("Config before adding bonus:",[e,h]),e&&((t=h.rolls)!=null&&t[0])&&(h.rolls[0].parts||(h.rolls[0].parts=[]),h.rolls[0].data||(h.rolls[0].data={}),h.rolls[0].data.situational=e,h.rolls[0].parts.includes("@situational")||h.rolls[0].parts.push("@situational"),d.log("Config after adding bonus:",[h])),h},async unsetActivityFlag(h){if(!game.user.isGM||!h)return;const e=h.getFlag(R,"tempActivityConfig");e&&(d.log("updateActivityConfigFlag - cleaning up existing config",[e]),await h.unsetFlag(R,"tempActivityConfig"))},async updateActivityConfigFlag(h,e){d.log("updateActivityConfigFlag - storing new activity config",[e]),await h.setFlag(R,"tempActivityConfig",e)},buildRollConfig(h,e,t={}){var i,n,r,l,c,u,g,f,p;const o={rolls:[{parts:(e==null?void 0:e.parts)??[],data:(e==null?void 0:e.data)??{},options:{...(e==null?void 0:e.options)??{},...((i=e==null?void 0:e.options)==null?void 0:i._fromFlashRolls)&&{_fromFlashRolls:!0}}}],advantage:((n=h==null?void 0:h.config)==null?void 0:n.advantage)||!1,disadvantage:((r=h==null?void 0:h.config)==null?void 0:r.disadvantage)||!1,target:(l=h==null?void 0:h.config)==null?void 0:l.target,subject:null,chatMessage:!0,legacy:!1,...t};let s=(c=h==null?void 0:h.config)==null?void 0:c.situational;const a=(p=(f=(g=(u=h==null?void 0:h.config)==null?void 0:u.rolls)==null?void 0:g[0])==null?void 0:f.data)==null?void 0:p.situational;return game.user.isGM?(!s&&a&&(s=a),s&&this.addSituationalBonus(o,s)):a?o.rolls[0].data.situational||(o.rolls[0].data.situational=a):s&&this.addSituationalBonus(o,s),this.ensureRollFlags(o,h)},ensureRollFlags(h,e){return h.isRollRequest=!game.user.isGM,h._showRequestedBy=!0,h._requestedBy=e.config.requestedBy||"GM",h},validateActors(h){return!h||h.length===0?null:(typeof h[0]=="string"&&(h=h.map(e=>game.actors.get(e)).filter(e=>e)),h.length>0?h:null)},getRollClass(h){const e=h==null?void 0:h.toLowerCase();return[A.DAMAGE,A.HEALING].includes(e)?CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:[A.FORMULA,A.CUSTOM,A.HIT_DIE].includes(e)?CONFIG.Dice.BasicRoll:CONFIG.Dice.D20Roll},shouldShowDC(h){const e=h==null?void 0:h.toLowerCase();return[A.SAVE,A.SAVING_THROW,A.ABILITY,A.ABILITY_CHECK,A.CONCENTRATION,A.SKILL,A.TOOL].includes(e)},createBaseRollConfig(h,e,t){const o=e==null?void 0:e.toLowerCase(),s={data:h.getRollData(),subject:h,rolls:[{parts:[],data:h.getRollData(),options:{}}]};switch(o){case A.SKILL:s.skill=t;break;case A.TOOL:s.tool=t;break;case A.SAVE:case A.SAVING_THROW:case A.ABILITY:case A.ABILITY_CHECK:s.ability=t;break;case A.HIT_DIE:s.rolls[0].options.flavor="Hit Die";break}return s},createMessageConfig(h,e=null){const t={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:h})}};return e&&(t.rollMode=e),t},async triggerRollDialog(h,e,t,o){const s=new h(e,t,o);return await new Promise(i=>{s.addEventListener("close",()=>{i({rolls:s.rolls,config:s.config,message:s.message,sendRequest:s.sendRequest,critical:s.config.critical,isCritical:s.config.isCritical})},{once:!0}),s.render({force:!0})})},processDialogResult(h,e,t,o,s={}){var m,k,y,S,T,b,v;if(!(h!=null&&h.rolls)||h.rolls.length===0)return null;const a=t==null?void 0:t.toLowerCase(),i=h.rolls[0];let n=!1,r=!1;((m=i==null?void 0:i.options)==null?void 0:m.advantageMode)!==void 0&&(n=i.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,r=i.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const l=((k=i==null?void 0:i.data)==null?void 0:k.situational)||"",c=(y=i==null?void 0:i.options)==null?void 0:y.target,u={rolls:[{parts:((S=i==null?void 0:i.parts)==null?void 0:S.slice())||[],data:l?{situational:l}:{},options:c?{target:c}:{}}],subject:e[0],advantage:n,disadvantage:r,target:c,sendRequest:h.sendRequest,isRollRequest:h.sendRequest,skipRollDialog:((T=h.config)==null?void 0:T.skipRollDialog)||s.skipRollDialog||!1,chatMessage:!0},g=C(),f=_.get(g.publicPlayerRolls.tag)===!0,p=this.determineRollMode(f,(b=h.message)==null?void 0:b.rollMode);return u.rollMode=p,(v=h.config)!=null&&v.ability&&[A.SKILL,A.TOOL].includes(a)&&(u.ability=h.config.ability),u},determineRollMode(h,e){return e||game.settings.get("core","rollMode")},isPlayerOwned(h){return Object.entries(h.ownership).some(([e,t])=>{const o=game.users.get(e);return o&&!o.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})},isPlayerOwnerActive(h){const e=eo(h);return e&&e.active},calculateStandardRule(h,e){const t=h.filter(a=>a.total>=e).length,o=h.length-t,s=Math.ceil(h.length/2);return{finalResult:t>=s,successes:t,failures:o,summary:game.i18n.format("FLASH_ROLLS.groupRoll.standardRule.summary",{successes:t,total:h.length,threshold:s}),method:"Standard Rule"}},calculateGroupAverage(h,e){const t=h.reduce((s,a)=>s+a.total,0),o=Math.floor(t/h.length);return{finalResult:o,average:o,success:o>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.groupAverage.summary",{average:o,dc:e}),method:"Group Average"}},calculateLeaderWithHelp(h,e,t,o,s){var k;let a=-999,i=-1,n=null,r=0;for(let y=0;y<h.length;y++){const S=h[y],T=t.find(v=>v.id===S.actorId);if(!T)continue;const b=this._getActorModifier(T,o,s);b>a&&(a=b,i=y,n=T.id,r=b)}if(i===-1)return{finalResult:0,error:"No leader found",method:"Leader with Help"};const l=h[i],c=h.filter((y,S)=>S!==i),u=c.filter(y=>y.total>=e).length,g=c.filter(y=>y.total<e).length,f=l.total+u-g;let p,m={leaderRoll:l.total,adjustedResult:f,dc:e};return u>0&&g>0?(p="FLASH_ROLLS.groupRoll.leaderWithHelp.summary",m.bonus=u,m.penalty=g):u>0?(p="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlySuccess",m.bonus=u,m.successWord=u===1?game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.successPlural")):g>0?(p="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlyFailure",m.penalty=g,m.failureWord=g===1?game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.failureSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.failurePlural")):p="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryNoModifiers",{finalResult:f,leaderRoll:l.total,leaderName:(k=t.find(y=>y.id===n))==null?void 0:k.name,leaderActorId:n,leaderModifier:r,bonus:u,penalty:g,success:f>=e,summary:game.i18n.format(p,m),method:"Leader with Help"}},calculateWeakestLink(h,e,t,o,s){var g;let a=999,i=null,n=0;for(const f of t){const p=this._getActorModifier(f,o,s);p<a&&(a=p,i=f.id,n=p)}const r=h.find(f=>f.actorId===i);if(!r)return{finalResult:0,error:"Weakest link actor did not roll",method:"Weakest Link"};const l=h.filter(f=>f.actorId!==i&&f.total>=e).length,c=r.total+l,u=l===1?game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successPlural");return{finalResult:c,weakestRoll:r.total,weakestName:(g=t.find(f=>f.id===i))==null?void 0:g.name,weakestActorId:i,weakestModifier:n,bonus:l,success:c>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.weakestLink.summary",{weakestRoll:r.total,bonus:l,successWord:u,adjustedResult:c,dc:e}),method:"Weakest Link"}},_getActorModifier(h,e,t){var s,a,i,n,r,l,c;switch(e==null?void 0:e.toLowerCase()){case A.SKILL:return((s=h.system.skills[t])==null?void 0:s.total)||((a=h.system.skills[t])==null?void 0:a.mod)||0;case A.SAVE:case A.SAVING_THROW:return((n=(i=h.system.abilities[t])==null?void 0:i.save)==null?void 0:n.value)||((r=h.system.abilities[t])==null?void 0:r.save)||0;case A.ABILITY:case A.ABILITY_CHECK:return((l=h.system.abilities[t])==null?void 0:l.mod)||0;case A.TOOL:if((c=h.system.tools)!=null&&c[t])return h.system.tools[t].total||h.system.tools[t].mod||0;const u=h.items.find(g=>g.type==="tool"&&g.system.toolType===t);return(u==null?void 0:u.system.bonus)||0;default:return 0}},getGroupResult(h,e,t,o,s){if(!h.every(l=>l.total!==null&&l.total!==void 0))return{complete:!1,success:!1,result:0};const i=C(),n=_.get(i.groupRollResultMode.tag)||1;let r;switch(n){case 1:return r=this.calculateStandardRule(h,e),{complete:!0,success:r.finalResult,result:r.finalResult?1:0,details:r};case 2:return r=this.calculateGroupAverage(h,e),{complete:!0,success:r.success,result:r.finalResult,details:r};case 3:return r=this.calculateLeaderWithHelp(h,e,t,o,s),{complete:!0,success:r.success,result:r.finalResult,details:r};case 4:return r=this.calculateWeakestLink(h,e,t,o,s),{complete:!0,success:r.success,result:r.finalResult,details:r};default:return r=this.calculateStandardRule(h,e),{complete:!0,success:r.finalResult,result:r.finalResult?1:0,details:r}}},consolidateRolls(h){var s,a,i,n,r,l,c,u;if(d.log("RollHelpers.consolidateRolls - BEFORE",[h]),!h||h.length<=1||h._consolidated)return h;const e=((a=(s=h[0])==null?void 0:s.options)==null?void 0:a.type)||((n=(i=h[0])==null?void 0:i.data)==null?void 0:n.damageType);if(e)for(let g=1;g<h.length;g++){const f=((l=(r=h[g])==null?void 0:r.options)==null?void 0:l.type)||((u=(c=h[g])==null?void 0:c.data)==null?void 0:u.damageType);if(f&&f!==e)return d.log("RollHelpers.consolidateRolls - Different damage types detected, skipping consolidation",[e,f]),h}const t=h[0];for(let g=1;g<h.length;g++)if(h[g]){const f=h[g];if(f.parts&&Array.isArray(f.parts)){t.parts=t.parts||[];for(const p of f.parts)t.parts.includes(p)||t.parts.push(p)}if(f.data&&typeof f.data=="object"){t.data=t.data||{};for(const[p,m]of Object.entries(f.data))p in t.data||(t.data[p]=m)}if(f.options&&typeof f.options=="object"){t.options=t.options||{};for(const[p,m]of Object.entries(f.options))p in t.options||(t.options[p]=m)}}const o=[t];return o._consolidated=!0,d.log("RollHelpers.consolidateRolls - AFTER",[o]),o},shouldDisplayChallengeForPlayer(h){var o;if(game.user.isGM)return!0;const e=h._requestedBy;if(e===game.user.name)return!0;switch(game.settings.get("dnd5e","challengeVisibility")){case"all":return!0;case"player":return e!==((o=game.users.find(s=>s.isGM))==null?void 0:o.name);default:return!1}},shouldSkipRollDialog(h=null,{isPC:e=!1,isNPC:t=!1}){const o=C();if(!_.get(o.skipRollDialog.tag))return!1;const a=_.get(o.skipRollDialogOption.tag),i=_.get(o.rollRequestsEnabled.tag);switch(a){case 1:return!0;case 2:return e===!0&&h===!0||e===!0&&h!==!1&&i===!0;case 3:return t===!0;default:return!1}}};class Vt{static async triggerMissingRolls(e,t,o){var i,n,r;d.log("VanillaActivityManager.triggerMissingRolls",[e,t,o]);const s=((n=(i=e.damage)==null?void 0:i.parts)==null?void 0:n.length)>0;e.type===se.SAVE&&s&&!((r=o.damageRolls)!=null&&r.length)&&(d.log("VanillaActivityManager.triggerMissingRolls - Manually triggering damage/healing roll",[e.type]),await e.rollDamage(t,{},{}))}static async executeActivityRoll(e,t,o,s,a){var u,g,f;d.log("ActivityManager.executeActivityRoll",[e,t,o,s,a]);const i=C();game.user.isGM||_.get(i.placeTemplateForPlayer.tag);const n=e.items.get(o);if(!n){d.error("Item not found on actor",[e,o]);return}let r=(s?(u=n.system.activities)==null?void 0:u.get(s):Ae.findActivityForRoll(n,t))||null;if(!r){d.error("Activity not found on item",[n,s,t]);return}const l=t==null?void 0:t.toLowerCase();let c=null;if(r){switch(l){case A.ATTACK:await this.executeAttackActivity(e,r,a);break;case A.DAMAGE:switch(d.log("executeActivityRoll - damage roll #0",[r,a]),c={critical:a.usage.critical||{},situational:a.usage.rolls[0].data.situational||"",rollMode:(g=a.message)==null?void 0:g.rollMode,create:((f=a.message)==null?void 0:f.create)!==!1,scaling:a.usage.scaling,skipRollDialog:a.usage.skipRollDialog,consume:a.usage.consume},a.usage={...a.usage,consume:Xe(a.usage.consume||{},!0),create:St(a.usage.create||{},!0)},await r.item.setFlag(R,"tempDamageConfig",c),d.log("executeActivityRoll - flag set",[c]),r.type===se.DAMAGE||r.type===se.SAVE||r!=null&&r.attack,r.type,se.SAVE,r.type,se.ATTACK,r.type){case se.DAMAGE:await this.executeDamageActivity(e,r,a);break;case se.SAVE:await this.executeSaveActivity(e,r,a);break;case se.HEAL:await this.executeHealActivity(e,r,a);break;case se.ATTACK:await this.executeDamagefromAttack(e,r,a,c);break;default:d.error("executeActivityRoll | untracked activity type",[r.type]);break}}return}throw new Error(`No suitable method found for ${l} on item ${n.name}`)}static async executeAttackActivity(e,t,o){var a,i,n,r;d.log("executeAttackActivity",[o]);const s={attackMode:o.usage.attackMode,ammunition:o.usage.ammunition,mastery:o.usage.mastery,situational:(n=(i=(a=o.usage.rolls)==null?void 0:a[0])==null?void 0:i.data)==null?void 0:n.situational,advantage:o.usage.advantage,disadvantage:o.usage.disadvantage,rollMode:(r=o.message)==null?void 0:r.rollMode,skipRollDialog:o.usage.skipRollDialog,consume:o.usage.consume,create:o.usage.create};o.message.create=!0,await t.item.setFlag(R,"tempAttackConfig",s);try{await t.use(o.usage,o.dialog,o.message)}catch(l){d.error("executeAttackActivity - attack roll error",[l])}finally{await t.item.unsetFlag(R,"tempAttackConfig")}}static async executeSaveActivity(e,t,o,s){try{d.log("executeSaveActivity - calling activity use",[t,o]),await t.use(o.usage,o.dialog,o.message)}catch(a){d.error("executeSaveActivity - save roll error",[a])}finally{await t.item.unsetFlag(R,"tempDamageConfig"),await t.item.unsetFlag(R,"tempSaveConfig")}}static async executeDamageActivity(e,t,o){try{d.log("executeDamageActivity - calling damage use",[t,o]),await t.use(o.usage,o.dialog,o.message)}catch(s){d.error("executeDamageActivity - roll error",[s])}finally{await t.item.unsetFlag(R,"tempDamageConfig")}}static async executeHealActivity(e,t,o){try{d.log("executeHealActivity - calling use",[t,o]),await t.use(o.usage,o.dialog,o.message)}catch(s){d.error("executeHealActivity - roll error",[s])}finally{await t.item.unsetFlag(R,"tempDamageConfig")}}static async executeDamagefromAttack(e,t,o,s){await t.rollDamage(s,o.dialog,o.message)}}class st{static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}static getMidiQOL(){return this.isModuleActive("midi-qol")&&typeof MidiQOL<"u"?MidiQOL:null}}D(st,"midiTimeout",null);var et,oo,so;class $e{static isActive(){return q.isModuleOn("midi-qol")}static shouldHandleRoll(e){return this.isActive()&&e}static shouldVanillaHandleSaveDamage(e){return!this.isActive()}static shouldPlayerTriggerSaveDamage(e,t){var i,n,r;if(!this.isActive())return!0;const o=((i=e.target)==null?void 0:i.template.count)>0,s=t.create.measuredTemplate!==!0,a=((r=(n=e.target)==null?void 0:n.template)==null?void 0:r.type)==="radius";return o&&s&&!a}static onPreRollAttackV2(e,t,o){d.log("MidiActivityManager.onPreRollAttackV2",[e,t,o])}static onPreRollDamageV2(e,t,o){d.log("MidiActivityManager.onPreRollDamageV2",[e,t,o])}static async onPostUseActivityPlayer(e,t,o){d.log("MidiActivityManager.onPostUseActivityPlayer #0",[e,t,o])}static async triggerMissingRolls(e,t,o){var f,p,m,k,y,S,T;d.log("MidiActivityManager.triggerMissingRolls",[e,t,o]);const s=st.getMidiQOL();if(!s)return;const a=(p=(f=s.Workflow)==null?void 0:f.getWorkflowByActivityUuid)==null?void 0:p.call(f,e.uuid),i=(a==null?void 0:a.attackRoll)||((m=a==null?void 0:a.attackRolls)==null?void 0:m.length)>0,n=(a==null?void 0:a.damageRoll)||((k=a==null?void 0:a.damageRolls)==null?void 0:k.length)>0,r=de(this,et,oo).call(this,a);e.type===se.ATTACK&&!i&&!r&&(d.log("MidiActivityManager.triggerMissingRolls - Manually triggering attack roll"),await e.rollAttack(t,{},{}));const l=((S=(y=e.damage)==null?void 0:y.parts)==null?void 0:S.length)>0,c=(T=e.healing)==null?void 0:T.formula,u=de(this,et,so).call(this,a);(e.type===se.SAVE||e.type===se.HEAL||e.type===se.DAMAGE)&&(l||c)&&!n&&!u&&(d.log("MidiActivityManager.triggerMissingRolls - Manually triggering damage/healing roll",[e.type]),await e.rollDamage(t,{},{}))}static async executeActivityRoll(e,t,o,s,a){var l;d.log("MidiActivityManager.executeActivityRoll",[e,t,o,s,a]);const i=e.items.get(o);if(!i){d.error("Item not found on actor",[e,o]);return}const n=s?(l=i.system.activities)==null?void 0:l.get(s):null;if(!n){d.error("Activity not found on item",[i,s]);return}switch(t==null?void 0:t.toLowerCase()){case A.ATTACK:await this.executeAttackActivity(e,n,a);break;case A.DAMAGE:await this.executeDamageActivity(e,n,a);break;case A.ITEM_SAVE:await this.executeSaveActivity(e,n,a);break;default:d.warn("MidiActivityManager: Unhandled roll type",[t]);break}}static async executeAttackActivity(e,t,o){var a,i,n,r;d.log("MidiActivityManager.executeAttackActivity",[t,o]);const s={attackMode:o.usage.attackMode,ammunition:o.usage.ammunition,mastery:o.usage.mastery,situational:(n=(i=(a=o.usage.rolls)==null?void 0:a[0])==null?void 0:i.data)==null?void 0:n.situational,advantage:o.usage.advantage,disadvantage:o.usage.disadvantage,rollMode:(r=o.message)==null?void 0:r.rollMode,skipRollDialog:o.usage.skipRollDialog,consume:o.usage.consume,create:o.usage.create};o.message.create=!0,await t.item.setFlag(R,"tempAttackConfig",s);try{o.usage.consume=Xe(o.usage.consume||{},!0),await this.completeActivityUse(t,o.usage,o.dialog,o.message)}catch(l){d.error("MidiActivityManager.executeAttackActivity - error",[l])}finally{await t.item.unsetFlag(R,"tempAttackConfig")}}static async executeDamageActivity(e,t,o){var i,n,r,l,c,u,g;d.log("MidiActivityManager.executeDamageActivity",[t,o]);const s=t.type===se.ATTACK&&o.usage.rollType===A.DAMAGE,a={critical:o.usage.critical||{},situational:((r=(n=(i=o.usage.rolls)==null?void 0:i[0])==null?void 0:n.data)==null?void 0:r.situational)||"",rollMode:(l=o.message)==null?void 0:l.rollMode,create:((c=o.message)==null?void 0:c.create)!==!1,scaling:o.usage.scaling,skipRollDialog:o.usage.skipRollDialog,consume:o.usage.consume};if(s){const f=st.getMidiQOL(),p=(g=(u=f==null?void 0:f.Workflow)==null?void 0:u.getWorkflowByActivityUuid)==null?void 0:g.call(u,t.uuid),m={...a,workflow:p,midiOptions:this.prepareDamageMidiOptions(o.usage.skipRollDialog)},k=p?{create:!1}:o.message;try{d.log("executeDamageActivity - case #1"),await t.rollDamage(m,o.dialog,k)}catch(y){d.error("MidiActivityManager.executeDamageActivity - error",[y])}}else{o.usage._rollType=A.DAMAGE,o.usage={...o.usage,consume:Xe(o.usage.consume||{},!0),create:St(o.usage.create||{},!0)},await t.item.setFlag(R,"tempDamageConfig",a);try{d.log("executeDamageActivity - case #2"),await this.completeActivityUse(t,o.usage,o.dialog,o.message)}catch(f){d.error("MidiActivityManager.executeDamageActivity - error",[f])}finally{await t.item.unsetFlag(R,"tempDamageConfig")}}}static async executeSaveActivity(e,t,o){d.log("MidiActivityManager.executeSaveActivity",[t,o]);try{o.usage.consume=Xe(o.usage.consume||{},!0),await this.completeActivityUse(t,o.usage,o.dialog,o.message)}catch(s){d.error("MidiActivityManager.executeSaveActivity - error",[s])}finally{await t.item.unsetFlag(R,"tempDamageConfig"),await t.item.unsetFlag(R,"tempSaveConfig")}}static async completeActivityUse(e,t={},o={},s={}){d.log("MidiActivityManager.completeActivityUse #0",[e,t,o,s]);const a=this.prepareUsageConfig(e,t);return d.log("MidiActivityManager.completeActivityUse #1",[a]),await MidiQOL.completeActivityUse(e,a,o,s)}static onPreUseActivityPlayer(e,t,o,s){var r,l;const a=C(),i=_.get(a.placeTemplateForPlayer.tag),n=(l=(r=e.target)==null?void 0:r.template)==null?void 0:l.type;if(i&&n&&t.templateUuid){const c=t.workflow;c&&(c.templateUuid=t.templateUuid,d.log("MidiActivityManager.onPreUseActivityPlayer - Template configured on workflow",[c.id,t.templateUuid]))}}static prepareDamageMidiOptions(e=!1){const t=C(),o=_.get(t.skipRollDialog.tag),s=e??o??!1;return{fastForwardDamage:!game.user.isGM?!1:s,autoRollDamage:"onHit",workflowOptions:{autoRollDamage:"onHit"}}}static prepareUsageConfig(e,t={}){var u,g;const o=C(),s=_.get(o.skipRollDialog.tag),a=t.skipRollDialog??s??!1,i=!game.user.isGM,r=t._rollType===A.DAMAGE||e.type===se.SAVE||e.type===se.HEAL||e.type===se.DAMAGE||e.type===se.ATTACK&&!e.attack;_.get(o.placeTemplateForPlayer.tag),(g=(u=e.target)==null?void 0:u.template)==null||g.type;const l={...t.midiOptions,fastForwardAttack:i?!1:a,fastForwardDamage:i&&r?!1:a,autoRollAttack:!0,workflowOptions:{autoRollAttack:!0,...r&&{autoRollDamage:"onHit"}}};return r&&(l.autoRollDamage="onHit"),{...t,...{consume:{action:!1,resources:[],spellSlot:!1},midiOptions:l}}}}et=new WeakSet,oo=function(e){var s,a;if(e!=null&&e.systemCard)return!1;if(((s=e==null?void 0:e.workflowOptions)==null?void 0:s.autoRollAttack)!==void 0)return e.workflowOptions.autoRollAttack;const t=st.getMidiQOL(),o=t==null?void 0:t.currentConfigSettings;return o?(a=game.user)!=null&&a.isGM?o.gmAutoAttack:o.autoRollAttack:!1},so=function(e){var a,i;if((a=e==null?void 0:e.workflowOptions)!=null&&a.autoRollDamage)return e.workflowOptions.autoRollDamage!=="none";const t=st.getMidiQOL(),o=t==null?void 0:t.currentConfigSettings;return o?((i=game.user)!=null&&i.isGM?o.gmAutoDamage:o.autoRollDamage)!=="none":!1},ne($e,et);class Ae{static get isMidiActive(){return this._isMidiActive===null&&(this._isMidiActive=q.isModuleOn("midi-qol")),this._isMidiActive}static resetMidiCache(){this._isMidiActive=null}static findActivityForRoll(e,t){var a;if(!((a=e==null?void 0:e.system)!=null&&a.activities))return null;const o=e.system.activities;switch(t==null?void 0:t.toLowerCase()){case A.ATTACK:const i=o.getByType("attack");return(i==null?void 0:i[0])||null;case A.DAMAGE:const n=o.getByType("attack");if((n==null?void 0:n.length)>0)return n[0];const r=o.getByType("damage");if((r==null?void 0:r.length)>0)return r[0];const l=o.getByType("save");if((l==null?void 0:l.length)>0)return l[0];const c=o.getByType("heal");return(c==null?void 0:c.length)>0?c[0]:null;case A.ITEM_SAVE:const u=o.getByType("save");return(u==null?void 0:u[0])||null;default:return null}}static getActivitiesByType(e,t){var o;return(o=e==null?void 0:e.system)!=null&&o.activities?e.system.activities.getByType(t):[]}static hasActivityForRoll(e,t){return d.log("hasActivityForRoll",[e,t]),!!this.findActivityForRoll(e,t)}static getActivityDisplayInfo(e){return d.log("getActivityDisplayInfo",[e]),e?{name:e.name||e.constructor.metadata.label,type:e.type,icon:e.constructor.metadata.icon,canAttack:e.type==="attack",canDamage:["attack","damage","save"].includes(e.type),canSave:e.type==="save"}:null}static getDamageFormula(e){var o,s;if(d.log("getDamageFormula",[e]),!((s=(o=e==null?void 0:e.damage)==null?void 0:o.parts)!=null&&s.length))return null;const t=e.damage.parts.map(a=>a.formula).filter(a=>a);return t.length>0?t.join(" + "):null}static async executeActivityRoll(e,t,o,s,a){return d.log("BaseActivityManager.executeActivityRoll - routing",[this.isMidiActive?"Midi":"Vanilla"]),this.isMidiActive?await $e.executeActivityRoll(e,t,o,s,a):await Vt.executeActivityRoll(e,t,o,s,a)}static onPreUseActivityGM(e,t,o,s){d.log("BaseActivityManager.onPreUseActivityGM #0",[e,t,o,s]);const a=C(),i=_.get(a.rollRequestsEnabled.tag),n=_.get(a.rollInterceptionEnabled.tag);if(!i||!n)return;const r=e.actor,l=q.getActorOwner(r),c=Pt(r)&&l.active,u=!c||t.isRollRequest===!1;if(d.log("BaseActivityManager.onPreUseActivityGM - Roll determination",{isMidiActive:this.isMidiActive,isPlayerActor:c,isLocalRoll:u,actorName:r==null?void 0:r.name,ownerActive:l==null?void 0:l.active,isRollRequest:t.isRollRequest}),u){d.log("BaseActivityManager.onPreUseActivityGM - Local roll, returning early to let normal D&D5e flow handle it");return}if(e.item.unsetFlag(R,"tempAttackConfig"),e.item.unsetFlag(R,"tempDamageConfig"),e.item.unsetFlag(R,"tempSaveConfig"),!!r&&(d.log("BaseActivityManager.onPreUseActivityGM #1",[t,u]),l&&l.active&&!l.isGM&&(t._originalConsume=structuredClone(t.consume||{}),t._originalCreate=structuredClone(t.create||{})),t.consume=Xe(t.consume||{},u),t.create=St(t.create||{},u),l&&!l.isGM&&!u))if(this.isMidiActive)d.log("BaseActivityManager.onPreUseActivityGM - Marking Midi message to suppress rendering for player-owned actor",[r.name]),s.data||(s.data={}),s.data.flags||(s.data.flags={}),s.data.flags[R]||(s.data.flags[R]={}),s.data.flags[R].preventRender=!0;else{const g=$t();o.configure=o.configure?g:!1,s.create=!1}}static onPostUseActivityGM(e,t,o){const s=C(),a=_.get(s.rollRequestsEnabled.tag),i=_.get(s.rollInterceptionEnabled.tag),n=e.actor;if(d.log("BaseActivityManager.onPostUseActivityGM #0",[e,t,o,game.user.targets,a,i,n]),!a||!i||!n)return;const r=q.getActorOwner(n),l=r&&r.active&&r.id!==game.user.id,c=!l||t.isRollRequest===!1;if(d.log("BaseActivityManager.onPostUseActivityGM #1 ",[c,l,this.isMidiActive]),this.isMidiActive&&c)return;const u=P.shouldSkipRollDialog(l,{isPC:l,isNPC:!l});if(o.configure=t.skipRollDialog!==void 0?!t.skipRollDialog:l&&!u,d.log("BaseActivityManager.onPostUseActivityGM - skipRollDialog",[u,t.skipRollDialog]),t.skipRollDialog===!1&&(!(r!=null&&r.active)||r.isGM)){d.log("BaseActivityManager.onPostUseActivityGM - Preventing usage message - no owning player for actor",[e.actor]);return}if(e.item){const g={spell:t.spell||{},scaling:t.scaling,consume:t._originalConsume||t.consume||{},create:t._originalCreate||t.create||{}},f=e.item.id,p={config:g,timestamp:Date.now()};Re.activityConfigCache.set(f,p),d.log("BaseActivityManager.onPostUseActivityGM - storing activity config in cache",[f,g])}c||(this.isMidiActive?$e.triggerMissingRolls(e,t,o):Vt.triggerMissingRolls(e,t,o))}static onPreUseActivityPlayer(e,t,o,s){const a=C(),i=_.get(a.rollRequestsEnabled.tag),n=_.get(a.rollInterceptionEnabled.tag);if(!i||!n)return;d.log("BaseActivityManager.onPreUseActivityPlayer",[e,t,o,s]);const r=e.actor;if(e.item.unsetFlag(R,"tempAttackConfig"),e.item.unsetFlag(R,"tempDamageConfig"),e.item.unsetFlag(R,"tempSaveConfig"),!r)return;const l=$t();o.configure=o.configure?l:!1,t.consume=Xe(t.consume||{},!0),t.create=St(t.create||{},!0),this.isMidiActive&&$e.onPreUseActivityPlayer(e,t,o,s)}static onPostUseActivityPlayer(e,t,o){var s,a,i;if(d.log("BaseActivityManager.onPostUseActivityPlayer",[e,t,o,(s=e.target)==null?void 0:s.template.count]),this.isMidiActive){$e.onPostUseActivityPlayer(e,t,o);return}if(e.type===se.SAVE&&((i=(a=e.damage)==null?void 0:a.parts)==null?void 0:i.length)>0){d.log("BaseActivityManager.onPostUseActivityPlayer - triggering vanilla save damage roll",[e,t]);const n=t.skipRollDialog!==void 0?!t.skipRollDialog:!0;e.rollDamage(t,{configure:n},{create:!0})}}}D(Ae,"_isMidiActive",null);const{ApplicationV2:qo,HandlebarsApplicationMixin:Bo}=foundry.applications.api;class Ht extends Bo(qo){constructor(e={}){super(e),this.formula=e.formula||"",this.readonly=e.readonly||!1,this.actor=e.actor,this.callback=e.callback,this.diceCounts={}}static get DEFAULT_OPTIONS(){return foundry.utils.mergeObject(super.DEFAULT_OPTIONS,{classes:["flash5e-dialog","flash5e-custom-roll-dialog"],tag:"div",window:{title:"FLASH_ROLLS.ui.dialogs.customRollTitle",icon:"fas fa-dice-d20",resizable:!1,positioned:!0,frame:!0},position:{width:420,height:"auto"}})}get id(){var e;return`flash5e-custom-roll-dialog-${((e=this.actor)==null?void 0:e.id)||"unknown"}`}get title(){const e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.customRollTitle");return this.actor?`${e} - ${this.actor.name}`:e}_onClickAction(e,t){switch(t.dataset.action){case"rollDice":return this.rollDice(e,t);case"addDie":return this.addDie(e,t);case"cancel":return this.cancel(e,t)}}async _prepareContext(e={}){return{...await super._prepareContext(e),formula:this.formula,readonly:this.readonly}}_attachPartListeners(e,t,o){super._attachPartListeners(e,t,o);const s=t.querySelector("#custom-roll-formula"),a=t.querySelector("#formula-validation-message");s&&!this.readonly&&(s.addEventListener("input",i=>{this.formula=i.target.value.trim(),this.updateValidationMessage(a)}),this.formula&&this.updateValidationMessage(a))}updateValidationMessage(e){if(!e)return;if(!this.formula){e.textContent="&nbsp;",e.classList.remove("error","success");return}this.validateFormula(this.formula)?(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaValid"),e.classList.remove("error"),e.classList.add("success")):(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaInvalid"),e.classList.remove("success"),e.classList.add("error"))}addDie(e,t){const o=t.dataset.die,s=this.element.querySelector("#custom-roll-formula");if(!s)return;const a=s.value.trim();if(a){const i=/(\d*)d(\d+)/g,n=new Map;let r=a,l;for(;(l=i.exec(a))!==null;){const g=parseInt(l[1]||"1"),f=l[2];n.set(f,(n.get(f)||0)+g),r=r.replace(l[0],"").trim()}const c=o.substring(1);n.set(c,(n.get(c)||0)+1);const u=[];for(const[g,f]of n)u.push(`${f}d${g}`);r=r.replace(/^\+\s*|\s*\+\s*$|\s*\+\s*\+/g,"").trim(),r&&r!=="+"?this.formula=`${u.join(" + ")} + ${r}`:this.formula=u.join(" + ")}else this.formula=`1${o}`;s.value=this.formula,s.dispatchEvent(new Event("input"))}validateFormula(e){var t;if(!e||e.trim()==="")return!1;try{return Roll.validate(e)}catch{try{return new Roll(e,((t=this.actor)==null?void 0:t.getRollData())||{}),!0}catch{return!1}}}async rollDice(){if(d.log("rollDice"),!this.validateFormula(this.formula)){ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.invalidFormula",{formula:this.formula||"empty"}));return}this.callback&&await this.callback(this.formula),this.close()}cancel(){this.close()}static async prompt(e={}){return new Promise(t=>{const o=new this({...e,callback:s=>t(s)});o.addEventListener("close",()=>{o._resolved||t(null)}),o.render(!0)})}async close(e={}){return this._resolved=!0,super.close(e)}}D(Ht,"PARTS",{main:{template:`modules/${W.ID}/templates/custom-roll-dialog.hbs`},footer:{template:`modules/${W.ID}/templates/custom-roll-dialog-footer.hbs`}});class Ve{static async handleRequest(e){var s,a;const t=q.isModuleOn("midi-qol");if(d.log("handleRequest",[e]),game.user.isGM)return;let o;if(e.isTokenActor){const i=(s=game.scenes.active)==null?void 0:s.tokens.get(e.actorId);if(o=i==null?void 0:i.actor,!o){d.warn("Token actor not found:",e.actorId);return}}else o=game.actors.get(e.actorId);!o||!o.isOwner||(e.preserveTargets&&((a=e.targetTokenIds)==null?void 0:a.length)>0&&(d.log("handleRequest - applyTargetTokens",[e]),No(e.targetTokenIds)),t&&e.rollProcessConfig.midiOptions&&(e.rollProcessConfig.midiOptions={...e.rollProcessConfig.midiOptions,fastForward:!1,fastForwardAttack:!1,dialogOptions:{...e.rollProcessConfig.midiOptions.dialogOptions,fastForward:!1,fastForwardAttack:!1},workflowOptions:{...e.rollProcessConfig.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1}}),ie.notify("info","",{batch:!0,batchData:{actor:o.name,rollType:e.rollType,rollKey:e.rollKey,gm:e.rollProcessConfig._requestedBy||"GM"}}),this.rollQueue.push({actor:o,requestData:e}),this.isProcessingRoll||(this.isProcessingRoll=!0,this.processNextRoll()))}static async processNextRoll(){var a;if(d.log("processNextRoll - called",[this.rollQueue.length,"in queue",this.isProcessingRoll]),this.rollQueue.length===0){this.isProcessingRoll=!1,d.log("processNextRoll - queue empty, stopping");return}const{actor:e,requestData:t}=this.rollQueue.shift();d.log("processNextRoll - Processing",[e.name,t.rollType,this.rollQueue.length,"remaining"]);const o=(a=t.rollType)==null?void 0:a.toLowerCase();if(o===A.DAMAGE||o===A.ATTACK||o===A.ITEM){this.executePlayerRollRequest(e,t).catch(i=>{d.error("Error processing roll request:",[i])}),this.processNextRoll();return}try{await this.executePlayerRollRequest(e,t)}catch(i){d.error("Error processing roll request:",[i])}this.processNextRoll()}static onRollCompleted(){this.pendingRollResolver&&(this.pendingRollResolver(),this.pendingRollResolver=null,this.pendingRollActorId=null)}static async executePlayerRollRequest(e,t){var s,a;const o=C();_.get(o.publicPlayerRolls.tag);try{const i=(s=t.rollType)==null?void 0:s.toLowerCase();d.log("executePlayerRollRequest - normalized roll type",[i]);const n=!!t.groupRollId,r=_.get(o.disableDialogInPlayerGroupRoll.tag);if(n&&r&&!game.user.isGM){d.log("executePlayerRollRequest - Canceling player roll for group roll (player can use chat card button)",[e.name]);return}const c=((a=t.rollProcessConfig.rolls)==null?void 0:a[0])||{parts:[],data:{},options:{}},f={configure:!(_.get(o.skipToRollResolver.tag)&&Ce.hasNonDigitalDice())},p=t.rollProcessConfig.rollMode,m=game.settings.get("core","rollMode"),k=p||m,y=t.isTokenActor?t.actorId:e.id,S={[R]:{isFlashRollRequest:!0,rollType:t.rollType,rollKey:t.rollKey,actorUniqueId:y}},T=ChatMessage.getSpeaker({actor:e}),b={rollMode:k,create:t.rollProcessConfig.chatMessage!==!1,flags:S,data:{speaker:T},messageData:{speaker:T,flags:S}},v={rollKey:t.rollKey,activityId:t.activityId,config:t.rollProcessConfig,groupRollId:t.groupRollId},L=me[i];L?(d.log("executePlayerRollRequest - calling handler",[i]),await L(e,v,c,f,b),d.log("executePlayerRollRequest - handler completed",[i])):(d.warn(`No handler found for roll type: ${i}`),ie.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"})))}catch(i){d.error("Error executing roll request:",[i]),ie.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"}))}}}D(Ve,"rollQueue",[]),D(Ve,"isProcessingRoll",!1),D(Ve,"pendingRollResolver",null),D(Ve,"pendingRollActorId",null);const pe=class pe{static async initialize(){d.log("ChatMessageManager.initialize"),await this.preloadTemplate()}static onCreateChatMessage(e,t,o,s){d.log("ChatMessageManager.onCreateChatMessage",[e,t,o,s])}static onPreCreateChatMessage(e,t,o,s){var a,i,n,r,l,c,u,g,f,p,m,k,y;if(d.log("ChatMessageManager.onPreCreateChatMessage",[e,t,o,s]),t._showRequestedBy&&((a=t.rolls)==null?void 0:a.length)>0){const S=t._requestedBy||"GM",T=game.i18n.format("FLASH_ROLLS.chat.requestedBy",{gm:S}),b=t.flavor||"";t.flavor=b?`${b} ${T}`:T}if((n=(i=t.flags)==null?void 0:i[R])!=null&&n.groupRollId&&d.log("ChatMessageManager.onPreCreateChatMessage - Found groupRollId in data flags",[t]),((r=t.rolls)==null?void 0:r.length)>0||(c=(l=t.flags)==null?void 0:l.core)!=null&&c.initiativeRoll){const S=t.speaker,T=S==null?void 0:S.actor;if(T){let b=game.actors.get(T);if(!b&&(S!=null&&S.token)){const v=canvas.tokens.get(S.token);v!=null&&v.actor&&(b=v.actor,d.log("ChatMessageManager.onPreCreateChatMessage - Using token actor from speaker",[b.name,b.id]))}if(!b){d.log("ChatMessageManager.onPreCreateChatMessage - No actor found",[T,S]);return}if(game.user.isGM){const v=b.isToken?(u=b.actor)==null?void 0:u.id:b.id,L=[T,v].filter(E=>E);for(const[E,O]of pe.pendingRolls.entries()){const w=O.actorEntries||(O.actors?O.actors.map(M=>({actorId:M})):[]);if(L.some(M=>w.some(F=>F.actorId===M))){t.flags=t.flags||{},t.flags[R]=t.flags[R]||{},t.flags[R].groupRollId=E,t.flags.rsr5e={processed:!0,quickRoll:!1},d.log("ChatMessageManager.onPreCreateChatMessage - Added groupRollId flag (GM)",[E,T]);break}}}else{let v=b.getFlag(R,"tempGroupRollId");if(!v&&b.isToken){const E=game.actors.get((g=b.actor)==null?void 0:g.id);E&&(v=E.getFlag(R,"tempGroupRollId"),d.log("ChatMessageManager.onPreCreateChatMessage - Checking base actor for tempGroupRollId",[E.id,v]))}let L=b.getFlag(R,"tempInitiativeConfig");if(!L&&b.isToken){const E=game.actors.get((f=b.actor)==null?void 0:f.id);E&&(L=E.getFlag(R,"tempInitiativeConfig"))}if((L!=null&&L.groupRollId||v)&&(t.flags=t.flags||{},t.flags[R]=t.flags[R]||{},t.flags[R].groupRollId=v||(L==null?void 0:L.groupRollId)||"",t.flags.rsr5e={processed:!0,quickRoll:!1},v&&(b.unsetFlag(R,"tempGroupRollId"),b.isToken))){const E=game.actors.get((p=b.actor)==null?void 0:p.id);E&&E.unsetFlag(R,"tempGroupRollId")}}}}if(((m=t.rolls)==null?void 0:m.length)>0&&t.rolls[0])try{const S=t.rolls[0];(k=S.options)!=null&&k._customFlavor&&(t.flavor=S.options._customFlavor)}catch(S){d.error("ChatMessageManager.onPreCreateChatMessage - flavor error",[S])}!game.user.isGM&&((y=t.rolls)==null?void 0:y.length)>0&&Ve.pendingRollResolver&&Ve.onRollCompleted()}static onRenderChatMessage(e,t,o){var a,i,n,r,l,c,u,g,f;d.log("ChatMessageManager.onRenderChatMessage #0",[e,t,o]);const s=t instanceof jQuery?t[0]:t[0]||t;if(e.getFlag(R,"preventRender")){d.log("ChatMessageManager.onRenderChatMessage - Hiding message for roll request",[e.id]),s&&(s.style.display="none");return}if(pe.interceptRollMessage(e,t,o),e.getFlag(R,"isGroupRoll")){const p=C(),m=_.get(p.groupRollNPCHidden.tag),k=e.getFlag(R,"npcHiddenOverride"),y=game.user.isGM,S=e.getFlag(R,"showAllResultsToPlayers"),T=(k!==void 0?k:m)&&!y,b=e.getFlag(R,"rollData");b&&b.results&&s.querySelectorAll(".actor-result").forEach((L,E)=>{const O=b.results[E];if(O){const w=game.actors.get(O.actorId),M=T&&w&&!w.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);M?L.classList.add("npc-hidden"):L.classList.remove("npc-hidden");const F=O.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,U=w==null?void 0:w.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER);let z;y||S?z=!1:F===CONST.DICE_ROLL_MODES.BLIND?z=!0:F===CONST.DICE_ROLL_MODES.PRIVATE||F===CONST.DICE_ROLL_MODES.SELF?z=!U:z=!1,d.log("onRenderChatMessage - Roll visibility",[O.actorName,"rollMode:",F,"isGM:",y,"showAllResultsToPlayers:",S,"hasPermission:",U,"shouldHideRoll:",z]),z?L.classList.add("roll-hidden"):L.classList.remove("roll-hidden");const N=_.get(p.concealNPCNames.tag),K=!y&&O.isNPC&&N&&!M;d.log("onRenderChatMessage - Name concealment",[O.actorName,"isNPC:",O.isNPC,"concealNPCNames:",N,"shouldHide:",M,"shouldConcealName:",K]),K?L.classList.add("npc-name-concealed"):L.classList.remove("npc-name-concealed")}}),pe._attachGroupRollListeners(s,e)}if(this._addSelectTargetsButton(e,s),game.user.isGM){let p=(a=o.subject)==null?void 0:a.item;!p&&((r=(n=(i=e.flags)==null?void 0:i.dnd5e)==null?void 0:n.item)!=null&&r.uuid)&&(p=fromUuidSync(e.flags.dnd5e.item.uuid)),p&&setTimeout(()=>{Re.activityConfigCache.delete(p.id),d.log("ChatMessageManager.onRenderChatMessage - cleared activity config cache",[p.id])},1e3)}if(!game.user.isGM&&(((c=(l=e.flags)==null?void 0:l[R])==null?void 0:c.isFlashRollRequest)||((g=(u=e.flags)==null?void 0:u[R])==null?void 0:g.groupRollId)||((f=e.getFlag("dnd5e","roll"))==null?void 0:f._requestedBy))){const m=game.settings.get("dnd5e","challengeVisibility");let k=!0;switch(m){case"none":k=!1;break;case"all":k=!0;break;case"player":k=e.author.id===game.user.id||!e.author.isGM;break;default:k=!0;break}if(k===!1){t.querySelectorAll("[data-display-challenge]").forEach(T=>delete T.dataset.displayChallenge);const S=t.querySelectorAll(".success, .failure, .critical, .fumble");S==null||S.forEach(T=>{T.classList.remove("success","failure","critical","fumble")}),S==null||S.forEach(T=>{var b;return(b=T.querySelector(".icons"))==null?void 0:b.remove()}),t.querySelectorAll(".save-dc, .dc, .target-dc").forEach(T=>{const b=T.textContent;b&&b.includes("DC")&&(T.textContent=b.replace(/DC\s*\d+/gi,""))})}}return!1}static onRenderChatLog(e,t){d.log("ChatMessageManager.onRenderChatLog",[]),t.querySelectorAll(".chat-message").forEach(s=>{var n,r,l,c,u,g;const a=s.dataset.messageId,i=game.messages.get(a);if(((l=(r=(n=i==null?void 0:i.flags)==null?void 0:n.dnd5e)==null?void 0:r.roll)==null?void 0:l.type)==="damage"&&((g=(u=(c=i.flags)==null?void 0:c.dnd5e)==null?void 0:u.item)!=null&&g.uuid)){const f=i.flags.dnd5e.item.uuid,p=fromUuidSync(f);if(p&&!Re.templateRemovalTimers.has(f)){Re.templateRemovalTimers.add(f);const m=C(),y=_.get(m.templateRemovalTimeout.tag)*1e3;setTimeout(()=>{q.removeTemplateForItem(p),Re.templateRemovalTimers.delete(f)},y)}}})}static _addSelectTargetsButton(e,t){var s,a,i;if(!game.user.isGM||(t=t[0]||t,d.log("ChatMessageManager._addSelectTargetsButton #0",[e,t]),((i=(a=(s=e.flags)==null?void 0:s.dnd5e)==null?void 0:a.roll)==null?void 0:i.type)!=="damage"||t.querySelector(".select-targeted")))return;const o=document.createElement("button");o.className="select-targeted",o.type="button",o.setAttribute("data-tooltip-direction","LEFT"),o.setAttribute("data-tooltip","Select Targeted"),o.innerHTML='<i class="fas fa-crosshairs"></i>',o.addEventListener("click",n=>{n.preventDefault(),this._selectTargetedTokens(n)}),t.querySelector(".message-content").appendChild(o),e.update({content:t})}static _selectTargetedTokens(e){const o=e.currentTarget.closest(".chat-message").querySelectorAll("[data-target-uuid]");if(o.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTargetedTokens"));return}for(let s=0;s<o.length;s++){const i=o[s].dataset.targetUuid.split("Actor.")[1];canvas.tokens.placeables.filter(r=>{var l,c;return((l=r.document.actor)==null?void 0:l.id)===i||((c=r.document.baseActor)==null?void 0:c.id)===i}).forEach((r,l)=>{r&&r.control&&r.control({releaseOthers:s===0})})}}static _showTokenVision(e){var a,i;if(!(canvas!=null&&canvas.tokens)||!((a=canvas.scene)!=null&&a.tokenVision)||!game.user.isGM)return;const t=e.dataset.tokenId,o=e.dataset.actorId;let s=t?canvas.tokens.get(t):null;!s&&o&&(s=canvas.tokens.placeables.find(n=>{var r;return((r=n.actor)==null?void 0:r.id)===o})),!(!s||!((i=s.document.sight)!=null&&i.enabled))&&(this._previouslyControlled=[...canvas.tokens.controlled],this._previewToken=s,this._originalControlledGetter=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(s),"controlled"),Object.defineProperty(s,"controlled",{get:()=>!0,configurable:!0}),s.initializeVisionSource(),canvas.perception.update({initializeVision:!0,refreshVision:!0}))}static _hideTokenVision(e){!this._previewToken||!game.user.isGM||(delete this._previewToken.controlled,this._originalControlledGetter&&(Object.defineProperty(this._previewToken,"controlled",this._originalControlledGetter),this._originalControlledGetter=null),this._previewToken.initializeVisionSource(),this._previouslyControlled.forEach(t=>{t.scene===canvas.scene&&t.initializeVisionSource()}),canvas.perception.update({initializeVision:!0,refreshVision:!0}),this._previewToken=null,this._previouslyControlled=[])}static _attachGroupRollListeners(e,t){const o=e.querySelectorAll(".actor-result");d.log("_attachGroupRollListeners - found actor results",[o.length]),o.forEach(n=>{n.addEventListener("click",l=>{if(l.target.closest(".dice-btn.rollable"))return;l.preventDefault(),l.stopPropagation();const c=n;d.log("actor-result click",[n]),c.classList.contains("expanded")?c.classList.remove("expanded"):c.classList.add("expanded")});const r=n.querySelector(".actor-image");r&&(r.addEventListener("mouseenter",l=>{l.stopPropagation(),this._showTokenVision(n)}),r.addEventListener("mouseleave",l=>{l.stopPropagation(),this._hideTokenVision(n)}))}),e.querySelectorAll(".dice-btn.rollable").forEach(n=>{n.addEventListener("click",async r=>{var F,U;r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation();const l=n.dataset,c=l.actorId,u=l.tokenId;let g;if(u){const z=(F=game.scenes.current)==null?void 0:F.tokens.get(u);g=z==null?void 0:z.actor}if(g||(g=game.actors.get(c)),!g){I.notify("warn","Actor not found");return}if(!(game.user.isGM||g.isOwner)){I.notify("warn",`You don't have permission to roll for ${g.name}`);return}const p=(U=l.type)==null?void 0:U.toLowerCase(),m=l.rollKey,k=l.groupRollId,y=l.dc?parseInt(l.dc):null;d.log("Rollable dice clicked",[p,m,c,k]);const{areKeysPressed:S}=game.dnd5e.utils||{};let T=!1,b=!1,v=!1;S?(v=S(r,"skipDialogNormal"),T=S(r,"skipDialogAdvantage"),b=S(r,"skipDialogDisadvantage")):(v=r.shiftKey,T=r.altKey,b=r.ctrlKey||r.metaKey);const L=v||T||b,E={rollKey:m,groupRollId:k,config:{advantage:T&&!b,disadvantage:b&&!T,target:y,rollMode:game.settings.get("core","rollMode")}},O={configure:!L,isRollRequest:!0},w={rollMode:game.settings.get("core","rollMode"),create:!0,isRollRequest:!0},M={parts:[],data:{},options:{}};try{const z=me[p];if(z)await z(g,E,M,O,w);else{let N;switch(p){case A.SKILL:N="rollSkill";break;case A.ABILITY:case A.ABILITY_CHECK:N="rollAbilityTest";break;case A.SAVE:case A.SAVING_THROW:N="rollAbilitySave";break;case A.TOOL:N="rollToolCheck";break;default:I.notify("warn",`Unknown roll type: ${p}`);return}N&&g[N]&&await g[N](m,{...E.config,messageOptions:{"flags.flash-rolls-5e.groupRollId":k}})}}catch(z){d.error("Error executing roll from chat",z),ui.notifications.error(`Failed to execute roll: ${z.message}`)}})});const s=e.querySelector(".group-roll-dc-control"),a=e.querySelector(".dc-input");if(s){const n=s.dataset.showToPlayers==="true";if(game.user.isGM||(s.style.display="none"),!game.user.isGM&&!n){const r=e.querySelector(".group-roll-footer .group-result-details");r&&(r.style.display="none")}}const i=e.querySelector(".group-roll-footer");if(i){const n=i.dataset.showToPlayers==="true",r=t.getFlag(R,"showAllResultsToPlayers");!game.user.isGM&&!n&&!r&&(i.style.display="none")}if(a)if(!game.user.isGM)a.readOnly=!0,a.style.cursor="not-allowed";else{let n=null;const r=async()=>{const l=parseInt(a.value);if(!a.value)return;if(isNaN(l)||l<1||l>99){a.value="";return}const c=a.dataset.messageId,u=game.messages.get(c);u&&await pe.updateGroupRollDC(u,l)};a.addEventListener("input",l=>{n&&clearTimeout(n),n=setTimeout(()=>{r()},750)}),a.addEventListener("keypress",l=>{l.key==="Enter"&&(n&&clearTimeout(n),r())})}}static async preloadTemplate(){d.log("ChatMessageManager.preloadTemplate");try{await q.loadTemplates([this.templatePath])}catch(e){d.error("Failed to preload template",e)}}static async createGroupRollMessage(e,t,o,s,a){var g;d.log("ChatMessageManager.createGroupRollMessage",[e.length,t,o,a]);const i=e.filter(f=>f&&f.actor);let n=this.groupRollMessages.get(a);if(n||(n=game.messages.contents.find(p=>p.getFlag(R,"groupRollId")===a&&p.getFlag(R,"isGroupRoll")),n&&this.groupRollMessages.set(a,n)),n){d.log("createGroupRollMessage - Found existing message, merging actors",[a]);const f=this.pendingRolls.get(a),p=new Set((f==null?void 0:f.actorEntries.map(w=>w.actorId))||[]),m=i.filter(w=>!p.has(w.actor.id));if(m.length===0)return d.log("createGroupRollMessage - All actors already in group, skipping"),n;const k=m.map(w=>({actorId:w.actor.id,uniqueId:w.uniqueId,tokenId:w.tokenId})),y=[...(f==null?void 0:f.actorEntries)||[],...k];f&&(f.actorEntries=y);const S=n.getFlag(R,"rollData"),T=C(),b=_.get(T.groupRollNPCHidden.tag),v=((g=game.user)==null?void 0:g.isGM)===!0,L=m.map(w=>{var U,z,N,K;const M={actorId:w.actor.id,actorUuid:w.actor.uuid,uniqueId:w.uniqueId,tokenId:w.tokenId,actorImg:w.actor.img||((z=(U=w.actor.prototypeToken)==null?void 0:U.texture)==null?void 0:z.src)||"icons/svg/mystery-man.svg",actorName:w.tokenId&&((K=(N=canvas.tokens)==null?void 0:N.get(w.tokenId))==null?void 0:K.name)||w.actor.name,isNPC:w.actor.type==="npc"||!w.actor.hasPlayerOwner,rolled:!1,showDice:!0,total:null,success:!1,failure:!1,rollTypeFlavor:(S==null?void 0:S.flavor)||""};M.shouldHide=M.isNPC&&b&&!v,M.rollMode=CONST.DICE_ROLL_MODES.PUBLIC;const F=w.actor.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);return v?M.shouldHideRoll=!1:M.rollMode===CONST.DICE_ROLL_MODES.BLIND?M.shouldHideRoll=!0:M.rollMode===CONST.DICE_ROLL_MODES.PRIVATE||M.rollMode===CONST.DICE_ROLL_MODES.SELF?M.shouldHideRoll=!F:M.shouldHideRoll=!1,M}),E={...S,results:[...S.results,...L]},O=E.isContestedRoll?"modules/flash-rolls-5e/templates/chat-msg-contested-roll.hbs":this.templatePath;return await n.update({content:await q.renderTemplate(O,E),flags:{[R]:{rollData:E,isGroupRoll:!0,groupRollId:a}}}),n}const r=this.buildGroupRollData(e,t,o,s,null);if(!r)return d.error("createGroupRollMessage - Failed to build group roll data"),null;r.groupRollId=a,r.isContestedRoll=s.isContestedRoll||!1,this.pendingRolls.set(a,{actorEntries:i.map(f=>({actorId:f.actor.id,uniqueId:f.uniqueId,tokenId:f.tokenId})),rollType:t,rollKey:o,config:s,results:new Map});const c=i.some(f=>f.actor.hasPlayerOwner)?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode");return await this.postGroupMessage(r,c)}static buildGroupRollData(e,t,o,s,a=null){var k;const i=e.filter(y=>y&&y.actor);if(i.length===0)return d.error("buildGroupRollData - No valid actor entries found",[e]),null;let n=this._buildFlavorText(t,o,s);const r=(s==null?void 0:s.dc)||(s==null?void 0:s.target),l=i.map(y=>{var v,L,E,O;const S=y.rollType||t,T=y.rollKey||o,b=s!=null&&s.isContestedRoll?this._buildFlavorText(S,T,s):n;return{actorId:y.actor.id,actorUuid:y.actor.uuid,uniqueId:y.uniqueId,tokenId:y.tokenId,actorImg:y.actor.img||((L=(v=y.actor.prototypeToken)==null?void 0:v.texture)==null?void 0:L.src)||"icons/svg/mystery-man.svg",actorName:y.tokenId&&((O=(E=canvas.tokens)==null?void 0:E.get(y.tokenId))==null?void 0:O.name)||y.actor.name,isNPC:y.actor.type==="npc"||!y.actor.hasPlayerOwner,rolled:!1,showDice:!0,total:null,success:!1,failure:!1,rollTypeFlavor:b}}),c=P.shouldShowDC(t),u=C(),g=_.get(u.showGroupDCToPlayers.tag),f=_.get(u.showGroupResultToPlayers.tag),p=_.get(u.groupRollNPCHidden.tag),m=((k=game.user)==null?void 0:k.isGM)===!0;return l.forEach(y=>{var T;y.shouldHide=y.isNPC&&p&&!m,y.rollMode=a||CONST.DICE_ROLL_MODES.PUBLIC;const S=(T=i.find(b=>b.uniqueId===y.uniqueId))==null?void 0:T.actor.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);m?y.shouldHideRoll=!1:y.rollMode===CONST.DICE_ROLL_MODES.BLIND?y.shouldHideRoll=!0:y.rollMode===CONST.DICE_ROLL_MODES.PRIVATE||y.rollMode===CONST.DICE_ROLL_MODES.SELF?y.shouldHideRoll=!S:y.shouldHideRoll=!1,d.log("buildGroupRollData - Roll visibility",[y.actorName,"rollMode:",y.rollMode,"isGM:",m,"hasPermission:",S,"shouldHideRoll:",y.shouldHideRoll])}),{flavor:n,results:l,showDC:r!=null,dc:r,rollType:t,rollKey:o,supportsDC:c,showDCToPlayers:g,showResultToPlayers:f,groupRollNPCHidden:p,isGM:m,isSingleActor:i.length===1,actorEntries:i.map(y=>({actorId:y.actor.id,uniqueId:y.uniqueId,tokenId:y.tokenId})),moduleId:R}}static _calculateContestedResult(e){const t=e.filter(r=>r.rolled&&r.total!==null);if(t.length<2)return{complete:!1};const[o,s]=t,a=o.total>s.total?o:s,i=o.total>s.total?s:o,n=r=>r.tokenId||r.uniqueId||r.actorId;return d.log("_calculateContestedResult - Results",["result1:",{tokenId:o.tokenId,uniqueId:o.uniqueId,actorId:o.actorId,total:o.total},"result2:",{tokenId:s.tokenId,uniqueId:s.uniqueId,actorId:s.actorId,total:s.total},"winnerId:",n(a),"loserId:",n(i)]),{complete:!0,winnerId:n(a),winnerName:a.actorName,winnerTotal:a.total,loserId:n(i),loserName:i.actorName,loserTotal:i.total,isTie:o.total===s.total}}static _buildFlavorText(e,t,o){var a,i,n,r,l,c,u,g;let s="";switch(e==null?void 0:e.toLowerCase()){case A.ABILITY:case A.ABILITY_CHECK:const f=((a=CONFIG.DND5E.abilities[t])==null?void 0:a.label)||t;s=game.i18n.format("DND5E.AbilityPromptTitle",{ability:f});break;case A.SAVE:case A.SAVING_THROW:const p=((i=CONFIG.DND5E.abilities[t])==null?void 0:i.label)||t;s=game.i18n.format("DND5E.SavePromptTitle",{ability:p});break;case A.SKILL:const m=((n=CONFIG.DND5E.skills[t])==null?void 0:n.label)||t,k=(o==null?void 0:o.ability)||((r=CONFIG.DND5E.skills[t])==null?void 0:r.ability)||"int",y=((l=CONFIG.DND5E.abilities[k])==null?void 0:l.label)||k;d.log("buildFlavorText - skill",[o==null?void 0:o.ability,m,k,y]),s=game.i18n.format("DND5E.SkillPromptTitle",{skill:m,ability:y});break;case A.TOOL:const S=(u=(c=CONFIG.DND5E.enrichmentLookup)==null?void 0:c.tools)==null?void 0:u[t];let T=t;if(S!=null&&S.id){const L=dnd5e.documents.Trait.getBaseItem(S.id,{indexOnly:!0});T=(L==null?void 0:L.name)||t}const b=(o==null?void 0:o.ability)||(S==null?void 0:S.ability)||"int",v=((g=CONFIG.DND5E.abilities[b])==null?void 0:g.label)||b;s=game.i18n.format("DND5E.ToolPromptTitle",{tool:T,ability:v});break;case A.CONCENTRATION:s=game.i18n.localize("DND5E.Concentration")||"Concentration";break;case A.DEATH_SAVE:s=game.i18n.localize("DND5E.DeathSave")||"Death Saving Throw";break;case A.HIT_DIE:case"hitdice":s=game.i18n.localize("DND5E.HitDice")||"Hit Dice";break;case A.HEALING:s=(o==null?void 0:o.flavor)||game.i18n.localize("DND5E.Healing")||"Healing";break;case A.CUSTOM:s=(o==null?void 0:o.flavor)||t||game.i18n.localize("DND5E.Roll")||"Custom Roll";break;case A.FORMULA:s=(o==null?void 0:o.flavor)||t||game.i18n.localize("DND5E.Roll")||"Custom Formula";break;case A.ITEM_SAVE:s=(o==null?void 0:o.flavor)||game.i18n.localize("DND5E.SavingThrow")||"Saving Throw";break;case A.INITIATIVE:s=game.i18n.localize("DND5E.Initiative");break;case A.ATTACK:s=(o==null?void 0:o.flavor)||game.i18n.localize("DND5E.Attack")||"Attack Roll";break;case A.DAMAGE:s=(o==null?void 0:o.flavor)||game.i18n.localize("DND5E.Damage")||"Damage Roll";break;default:s=(o==null?void 0:o.flavor)||"Roll"}return s}static async postGroupMessage(e,t=null){d.log("postGroupMessage - groupRollId",[e.groupRollId,t]);try{const o=e.isContestedRoll?"modules/flash-rolls-5e/templates/chat-msg-contested-roll.hbs":this.templatePath,s=await q.renderTemplate(o,e);let a=game.i18n.localize("FLASH_ROLLS.chat.groupRoll");e.isContestedRoll?a=game.i18n.localize("FLASH_ROLLS.chat.contestedRoll"):e.isSingleActor&&(a=game.i18n.localize("FLASH_ROLLS.chat.rollRequest"));const i={content:s,speaker:{alias:a},flags:{[R]:{isGroupRoll:!0,isContestedRoll:e.isContestedRoll||!1,groupRollId:e.groupRollId,rollData:e},rsr5e:{processed:!0,quickRoll:!1}}};t&&ChatMessage.applyRollMode(i,t);const n=await ChatMessage.create(i);return this.groupRollMessages.set(e.groupRollId,n),n}catch(o){return d.error("Failed to post group message",o),null}}static async updateGroupRollMessage(e,t,o,s=CONST.DICE_ROLL_MODES.PUBLIC){if(game.user.isGM)return d.log("ChatMessageManager.updateGroupRollMessage #0",[e,t,o,s]),await this._performGroupRollUpdate(e,t,o,s)}static async _performGroupRollUpdate(e,t,o,s=CONST.DICE_ROLL_MODES.PUBLIC){var g,f,p,m,k,y,S;let a=this.groupRollMessages.get(e),i=this.pendingRolls.get(e);if(!a&&(a=game.messages.contents.find(b=>b.getFlag(R,"groupRollId")===e&&b.getFlag(R,"isGroupRoll")),a&&(this.groupRollMessages.set(e,a),d.log("_performGroupRollUpdate - Found and registered group message",[e]),!i))){const b=a.getFlag(R,"rollData");i={actorEntries:b.actorEntries||b.results.map(v=>({actorId:v.actorId,uniqueId:v.uniqueId,tokenId:v.tokenId})),results:new Map},this.pendingRolls.set(e,i)}if(!a){d.log("No group message found for groupRollId",e);return}i&&i.results&&i.results.set(t,{total:o.total,roll:o});const n=a.getFlag(R,"rollData");d.log("_performGroupRollUpdate - Searching for uniqueId",[t,"in results:",n.results.map(T=>({uniqueId:T.uniqueId,actorId:T.actorId,tokenId:T.tokenId}))]);let r=n.results.findIndex(T=>T.uniqueId===t);if(r===-1){if(r=n.results.findIndex(T=>T.tokenId===t),r!==-1&&d.log("_performGroupRollUpdate - Found by tokenId",[r]),r===-1){const T=((g=canvas.tokens)==null?void 0:g.get(t))||((p=(f=game.scenes.active)==null?void 0:f.tokens)==null?void 0:p.get(t));if(T&&T.actor){const b=T.actor.id;d.log("_performGroupRollUpdate - Trying token actor match",[t,"token actor:",b]),T.actorLink===!1&&(r=n.results.findIndex(v=>v.tokenId===t)),r===-1&&(r=n.results.findIndex(v=>v.actorId===b&&!v.rolled),r===-1&&(r=n.results.findIndex(v=>v.actorId===b))),r!==-1&&d.log("_performGroupRollUpdate - Found by token lookup",[r])}}if(r===-1&&(r=n.results.findIndex(T=>T.actorId===t),r!==-1&&d.log("_performGroupRollUpdate - Found by actorId",[r])),r===-1&&((m=a.speaker)!=null&&m.actor)){const T=a.speaker.actor;r=n.results.findIndex(b=>b.actorId===T),r!==-1&&d.log("_performGroupRollUpdate - Found by speaker actorId",[r])}r===-1&&n.isContestedRoll&&(r=n.results.findIndex(T=>T.actorId===t&&!T.rolled),r!==-1&&d.log("_performGroupRollUpdate - Found first unrolled result for actor in contested roll",[r]))}if(r!==-1){n.results[r].rolled=!0,n.results[r].showDice=!1,n.results[r].total=o.total,n.results[r].roll=o.toJSON(),n.results[r].rollMode=s,d.log("_performGroupRollUpdate - Set roll mode for result",[n.results[r].actorName,"rollMode:",s]);try{let b=await o.render();n.results[r].rollBreakdown=b}catch(b){d.error("Error rendering roll breakdown",[b]),n.results[r].rollBreakdown=null}n.showDC&&n.dc&&(n.results[r].success=o.total>=n.dc,n.results[r].failure=o.total<n.dc);const T={actorUuid:n.results[r].actorUuid,actorId:n.results[r].actorId,tokenId:n.results[r].tokenId,roll:o.toJSON(),total:o.total,rollType:n.rollType,rollKey:n.rollKey,groupRollId:e,dc:n.dc||null,success:n.dc?o.total>=n.dc:null};ge.execForAll(Be.broadcastRollComplete,T)}else{d.error("Group message id not found");return}n.allRolled=n.results.every(T=>T.rolled),n.messageId=a.id,n.supportsDC=P.shouldShowDC(n.rollType);const l=C();if(n.showDCToPlayers=_.get(l.showGroupDCToPlayers.tag),n.showResultToPlayers=_.get(l.showGroupResultToPlayers.tag),n.groupRollNPCHidden=_.get(l.groupRollNPCHidden.tag),n.isGM=((k=game.user)==null?void 0:k.isGM)===!0,n.results&&n.results.forEach(T=>{if(T.isNPC===void 0){const L=game.actors.get(T.actorId);T.isNPC=L?L.type==="npc"||!L.hasPlayerOwner:!1}T.shouldHide=T.isNPC&&n.groupRollNPCHidden&&!n.isGM,T.rollMode===void 0&&(T.rollMode=CONST.DICE_ROLL_MODES.PUBLIC);const b=game.actors.get(T.actorId),v=b==null?void 0:b.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);n.isGM?T.shouldHideRoll=!1:T.rollMode===CONST.DICE_ROLL_MODES.BLIND?T.shouldHideRoll=!0:T.rollMode===CONST.DICE_ROLL_MODES.PRIVATE||T.rollMode===CONST.DICE_ROLL_MODES.SELF?T.shouldHideRoll=!v:T.shouldHideRoll=!1,d.log("_performGroupRollUpdate - Result visibility calculated",[T.actorName,"rollMode:",T.rollMode,"isGM:",n.isGM,"hasPermission:",v,"shouldHideRoll:",T.shouldHideRoll])}),n.isContestedRoll){const T=this._calculateContestedResult(n.results);n.contestedResult=T,T.complete&&T.winnerId&&!T.isTie&&n.results.forEach(b=>{const v=b.tokenId||b.uniqueId||b.actorId;b.isWinner=v===T.winnerId,b.isLoser=v===T.loserId,d.log("updateGroupRollMessage - Setting winner/loser",["resultId:",v,"winnerId:",T.winnerId,"loserId:",T.loserId,"isWinner:",b.isWinner,"isLoser:",b.isLoser])}),d.log("updateGroupRollMessage - Contested Result",[T])}else if(n.supportsDC&&n.showDC&&n.dc){const T=((y=n.actorEntries)==null?void 0:y.map(v=>game.actors.get(v.actorId)).filter(v=>v))||((S=n.actors)==null?void 0:S.map(v=>game.actors.get(v)).filter(v=>v))||[],b=P.getGroupResult(n.results,n.dc,T,n.rollType,n.rollKey);n.groupResult=b,d.log("updateGroupRollMessage - COMPLETE?",[b.complete]),b.complete&&b.details&&(n.groupSummary=b.details.summary)}const c=n.isContestedRoll?"modules/flash-rolls-5e/templates/chat-msg-contested-roll.hbs":this.templatePath,u=await q.renderTemplate(c,n);await a.update({content:u,flags:{[R]:{rollData:n},rsr5e:{processed:!0,quickRoll:!1}}}),i!=null&&i.results&&(i!=null&&i.actorEntries)&&i.results.size===i.actorEntries.length&&(this.pendingRolls.delete(e),setTimeout(()=>{this.groupRollMessages.delete(e),this.updateQueue.delete(e)},6e4))}static async updateGroupRollDC(e,t){var r,l,c;const o=e.getFlag(R,"rollData");if(!o||(o.supportsDC=P.shouldShowDC(o.rollType),!o.supportsDC))return;o.dc=t,o.showDC=!0,o.results.forEach(u=>{u.rolled&&u.total!==null&&(u.success=u.total>=t,u.failure=u.total<t)});const s=((r=o.actorEntries)==null?void 0:r.map(u=>game.actors.get(u.actorId)).filter(u=>u))||((l=o.actors)==null?void 0:l.map(u=>game.actors.get(u)).filter(u=>u))||[],a=P.getGroupResult(o.results,t,s,o.rollType,o.rollKey);o.groupResult=a,a.complete&&a.details&&(o.groupSummary=a.details.summary),o.allRolled=o.results.every(u=>u.rolled),o.messageId=e.id;const i=C();o.showDCToPlayers=_.get(i.showGroupDCToPlayers.tag),o.showResultToPlayers=_.get(i.showGroupResultToPlayers.tag),o.groupRollNPCHidden=_.get(i.groupRollNPCHidden.tag),o.isGM=((c=game.user)==null?void 0:c.isGM)===!0,o.results&&o.results.forEach(u=>{if(u.isNPC===void 0){const g=game.actors.get(u.actorId);u.isNPC=g?!g.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED):!1}u.shouldHide=u.isNPC&&o.groupRollNPCHidden&&!o.isGM});const n=await q.renderTemplate(this.templatePath,o);await e.update({content:n,flags:{[R]:{rollData:o},rsr5e:{processed:!0,quickRoll:!1}}})}static interceptRollMessage(e,t,o){var y,S,T,b,v,L,E,O;const s=C(),a=_.get(s.groupRollsMsgEnabled.tag),i=e.getFlag(R,"actorUniqueId"),n=(y=e.speaker)==null?void 0:y.actor,r=(S=e.speaker)==null?void 0:S.token;d.log("interceptRollMessage - speaker info",["actorUniqueId from flag:",i,"actorId:",n,"tokenId:",r]);let l,c;if(i){const w=(T=game.scenes.active)==null?void 0:T.tokens.get(i);w!=null&&w.actor?(l=w.actor,c=i):(l=game.actors.get(i),c=i)}if(!l){if(r){const w=((b=canvas.tokens)==null?void 0:b.get(r))||((L=(v=game.scenes.active)==null?void 0:v.tokens)==null?void 0:L.get(r));l=w==null?void 0:w.actor}l||(l=game.actors.get(n)),c=r||n}if(!l)return;d.log("interceptRollMessage - using uniqueId:",[c,"for actor:",l.name]);const u=e.getFlag(R,"isFlashRollRequest"),g=e.getFlag(R,"rollType"),f=e.getFlag(R,"rollKey"),p=(E=e.rolls)==null?void 0:E[0];if(!a){u&&p&&this._broadcastIndividualRollComplete(l,p,g,f,r);return}const m=e.getFlag(R,"groupRollId")||l.getFlag(R,"tempGroupRollId")||((O=l.getFlag(R,"tempInitiativeConfig"))==null?void 0:O.groupRollId);if(!m){d.log("interceptRollMessage #2 - no groupRollId in flag",[l.name]),u&&p&&this._broadcastIndividualRollComplete(l,p,g,f,r);return}if(!game.user.isGM&&!this.groupRollMessages.has(m)){const M=game.messages.contents.find(F=>F.getFlag(R,"groupRollId")===m&&F.getFlag(R,"isGroupRoll"));M&&(this.groupRollMessages.set(m,M),d.log("interceptRollMessage - Registered group roll message",[l.name,m]))}if(!this.groupRollMessages.has(m)){const M=game.messages.contents.find(F=>F.getFlag(R,"groupRollId")===m&&F.getFlag(R,"isGroupRoll"));if(M)d.log("interceptRollMessage - Found group message in chat log, registering",[m]),this.groupRollMessages.set(m,M);else{d.log("interceptRollMessage - No group message found in chat log either",[m]);return}}if(!p)return;let k=CONST.DICE_ROLL_MODES.PUBLIC;if(e.blind)k=CONST.DICE_ROLL_MODES.BLIND;else if(e.whisper&&e.whisper.length>0){const w=game.users.filter(F=>F.isGM).map(F=>F.id);e.whisper.every(F=>w.includes(F))&&(k=CONST.DICE_ROLL_MODES.PRIVATE)}if(d.log("interceptRollMessage - Message details",["message.rollMode:",e.rollMode,"message.blind:",e.blind,"message.whisper:",e.whisper,"determined rollMode:",k]),t&&t instanceof HTMLElement&&t.style&&(t.style.display="none"),game.user.isGM){d.log("interceptRollMessage - Updating group message",[m,c,l.name,p.total,"rollMode:",k]),this.updateGroupRollMessage(m,c,p,k);const w=e.id;if(this.messagesScheduledForDeletion.has(w))return;this.messagesScheduledForDeletion.add(w),w&&setTimeout(async()=>{var M;d.log("interceptRollMessage - deletion",[w]);try{game.messages.get(w)?((M=ui.chat)!=null&&M.deleteMessage?await ui.chat.deleteMessage(w):await e.delete(),d.log("interceptRollMessage - Deleted individual message",[w])):d.log("interceptRollMessage - Message already deleted",[w])}catch(F){d.log("interceptRollMessage - Error deleting message",[w,F.message])}finally{this.messagesScheduledForDeletion.delete(w)}},500)}else d.log("interceptRollMessage - Player roll intercepted, GM will handle update",[m])}static isGroupRoll(e){return this.pendingRolls.has(e)||this.groupRollMessages.has(e)}static async addGroupRollFlag(e,t,o=null,s=null){const a=C(),i=_.get(a.groupRollsMsgEnabled.tag);if(d.log("addGroupRollFlag called",[e,t.groupRollId,this.isGroupRoll(t.groupRollId),s]),!game.user.isGM&&t.groupRollId&&o&&(await o.setFlag(R,"tempGroupRollId",t.groupRollId),o.isToken&&o.actor&&(await o.actor.setFlag(R,"tempGroupRollId",t.groupRollId),d.log("addGroupRollFlag - Also stored tempGroupRollId on base actor for player",[t.groupRollId,o.actor.id])),!this.groupRollMessages.has(t.groupRollId))){const r=game.messages.contents.find(l=>l.getFlag(R,"groupRollId")===t.groupRollId&&l.getFlag(R,"isGroupRoll"));r&&(this.groupRollMessages.set(t.groupRollId,r),d.log("addGroupRollFlag - Registered group roll message on player side",[t.groupRollId]))}e.data=e.data||{},e.data.flags=e.data.flags||{},e.data.flags[R]=e.data.flags[R]||{},e.data.flags[R].isFlashRollRequest=!0,s&&(e.data.flags[R].rollType=s),t.rollKey&&(e.data.flags[R].rollKey=t.rollKey),i&&t.groupRollId&&(!game.user.isGM||this.isGroupRoll(t.groupRollId))&&(e.data.flags[R].groupRollId=t.groupRollId,e.data.flags.rsr5e={...e.data.flags.rsr5e,processed:!0,quickRoll:!1},d.log("addGroupRollFlag - Added groupRollId flag to messageConfig",[e]))}static _broadcastIndividualRollComplete(e,t,o,s,a){if(!e||!t)return;const i={actorUuid:e.uuid,actorId:e.id,tokenId:a||null,roll:t.toJSON(),total:t.total,rollType:o||null,rollKey:s||null,groupRollId:null,dc:null,success:null};d.log("_broadcastIndividualRollComplete - Broadcasting hook",[e.name,o,s,t.total]),ge.execForAll(Be.broadcastRollComplete,i)}static cleanup(){const e=Date.now()-3e5;for(const[t,o]of this.groupRollMessages.entries())o.timestamp<e&&(this.groupRollMessages.delete(t),this.pendingRolls.delete(t))}};D(pe,"groupRollMessages",new Map),D(pe,"pendingRolls",new Map),D(pe,"messagesScheduledForDeletion",new Set),D(pe,"updateQueue",new Map),D(pe,"templatePath","modules/flash-rolls-5e/templates/chat-msg-group-roll.hbs"),D(pe,"_previewToken",null),D(pe,"_previouslyControlled",[]),D(pe,"_originalControlledGetter",null);let te=pe;const me={ability:async(h,e,t,o,s)=>{const a=P.buildRollConfig(e,t,{ability:e.rollKey});await te.addGroupRollFlag(s,e,h,A.ABILITY),await h.rollAbilityCheck(a,o,s)},abilitycheck:async(h,e,t,o,s)=>me.ability(h,e,t,o,s),save:async(h,e,t,o,s)=>{var i;const a=P.buildRollConfig(e,t,{ability:((i=e.config)==null?void 0:i.ability)||e.rollKey});await te.addGroupRollFlag(s,e,h,A.SAVE),await h.rollSavingThrow(a,o,s)},savingthrow:async(h,e,t,o,s)=>me.save(h,e,t,o,s),skill:async(h,e,t,o,s)=>{var n,r,l,c;const a=((r=(n=h.system.skills)==null?void 0:n[e.rollKey])==null?void 0:r.ability)||((c=(l=CONFIG.DND5E.skills)==null?void 0:l[e.rollKey])==null?void 0:c.ability)||void 0,i=P.buildRollConfig(e,t,{skill:e.rollKey,chooseAbility:o.configure!==!1,ability:e.config.ability||a});await te.addGroupRollFlag(s,e,h,A.SKILL),await h.rollSkill(i,o,s)},tool:async(h,e,t,o,s)=>{var r,l,c,u;const a=(r=h.system.tools)==null?void 0:r[e.rollKey],i=(a==null?void 0:a.ability)||((u=(c=(l=CONFIG.DND5E.enrichmentLookup)==null?void 0:l.tools)==null?void 0:c[e.rollKey])==null?void 0:u.ability)||"int",n=P.buildRollConfig(e,t,{tool:e.rollKey,chooseAbility:o.configure!==!1,ability:e.config.ability||i});d.log("RollHandlers.tool #2",[n,o,s]),await te.addGroupRollFlag(s,e,h,A.TOOL),await h.rollToolCheck(n,o,s)},concentration:async(h,e,t,o,s)=>{const a=P.buildRollConfig(e,t);await te.addGroupRollFlag(s,e,h,A.CONCENTRATION),await h.rollConcentration(a,o,s)},attack:async(h,e,t,o,s)=>{await me.handleActivityRoll(h,A.ATTACK,e,t,o,s)},damage:async(h,e,t,o,s)=>{await me.handleActivityRoll(h,A.DAMAGE,e,t,o,s)},itemsave:async(h,e,t,o,s)=>{await me.handleActivityRoll(h,A.ITEM_SAVE,e,t,o,s)},initiative:async(h,e,t,o,s)=>{var i,n,r;if(!game.combat){I.notify("warn",game.i18n.localize("COMBAT.NoneActive"));return}e.config.situational||(i=t.data)!=null&&i.situational,e.groupRollId;let a=h;if(!h.isToken){const l=canvas.tokens.placeables.find(c=>{var u;return((u=c.actor)==null?void 0:u.id)===h.id});if(l)a=l.actor;else{I.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.noTokensForInitiative"));return}}await te.addGroupRollFlag(s,e,h,A.INITIATIVE);try{if(o.configure){if(d.log("RollHandlers.initiative - Dialog",[]),e.config){const l=P.buildRollConfig(e,t,{ability:((r=(n=h.system.attributes)==null?void 0:n.init)==null?void 0:r.ability)||"dex"}),c={advantage:e.config.advantage||!1,disadvantage:e.config.disadvantage||!1,rollMode:e.config.rollMode||game.settings.get("core","rollMode"),rolls:l.rolls,groupRollId:e.groupRollId};await h.setFlag(R,"tempInitiativeConfig",c),await a.setFlag(R,"tempInitiativeConfig",c)}await a.rollInitiativeDialog(),await a.unsetFlag(R,"tempInitiativeConfig"),await h.unsetFlag(R,"tempInitiativeConfig")}else{const l={rollMode:e.config.rollMode||game.settings.get("core","rollMode"),groupRollId:e.groupRollId};await h.setFlag(R,"tempInitiativeConfig",l),await a.setFlag(R,"tempInitiativeConfig",l);const c={createCombatants:!0,rerollInitiative:!0};await a.rollInitiative(c),await a.unsetFlag(R,"tempInitiativeConfig"),await h.unsetFlag(R,"tempInitiativeConfig")}}catch(l){d.error("RollHandlers.initiative - Error",[l]),ie.notify("error",`Initiative roll failed: ${l.message}`)}},initiativedialog:async(h,e,t,o,s)=>me.initiative(h,e,t,o,s),deathsave:async(h,e,t,o,s)=>{const a=P.buildRollConfig(e,t);await te.addGroupRollFlag(s,e,h,A.DEATH_SAVE),await h.rollDeathSave(a,o,s)},hitdie:async(h,e,t,o,s)=>{o.configure=game.user.isGM?o.configure:!0;const a=P.buildRollConfig(e,t,{denomination:e.rollKey});d.log("RollHandlers.hitdie",[a,o,s]),await te.addGroupRollFlag(s,e,h,A.HIT_DIE),await h.rollHitDie(a,o,s)},custom:async(h,e,t,o,s)=>{await me.handleCustomRoll(h,e,o,s)},async handleActivityRoll(h,e,t,o,s,a){var i,n;if(d.log("RollHandlers.handleActivityRoll",[e,t,o]),t.rollKey){const r=P.buildRollConfig(t,o),l=((n=(i=r.rolls)==null?void 0:i[0])==null?void 0:n.options)||{},c={usage:{...t.config,rollType:e,rolls:r.rolls,...l.attackMode&&{attackMode:l.attackMode},...l.ammunition&&{ammunition:l.ammunition},...l.mastery!==void 0&&{mastery:l.mastery},...t.config.spell&&{spell:t.config.spell},...t.config.scaling!==void 0&&{scaling:t.config.scaling},...t.config.consume&&{consume:t.config.consume},...t.config.create&&{create:t.config.create}},dialog:{...s,configure:game.user.isGM&&t.config.skipRollDialog!==void 0?!t.config.skipRollDialog:s.configure},message:a};d.log("handleActivityRoll - final activity config",[c]),await Ae.executeActivityRoll(h,e,t.rollKey,t.activityId,c)}},async handleCustomRoll(h,e,t,o){var i,n,r,l;const s=e.rollKey;if((t==null?void 0:t.configure)===!1){try{const c=new Roll(s,h.getRollData());c.options=c.options||{},c.options.isRollRequest=((i=e.config)==null?void 0:i.isRollRequest)!==!1,await c.evaluate(),await te.addGroupRollFlag(o,e,h),await c.toMessage({speaker:ChatMessage.getSpeaker({actor:h}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${A.CUSTOM}`),rollMode:(o==null?void 0:o.rollMode)||((n=e.config)==null?void 0:n.rollMode)||game.settings.get("core","rollMode"),isRollRequest:((r=e.config)==null?void 0:r.isRollRequest)!==!1,create:(o==null?void 0:o.create)!==!1,flags:(l=o==null?void 0:o.data)==null?void 0:l.flags})}catch{I.notify("error",game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:s}))}return}new Ht({formula:s,readonly:!0,actor:h,callback:async c=>{var u;try{const g=new Roll(c,h.getRollData());g.options=g.options||{},g.options.isRollRequest=!0,await g.evaluate(),await te.addGroupRollFlag(o,e,h),await g.toMessage({speaker:ChatMessage.getSpeaker({actor:h}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${A.CUSTOM}`),rollMode:e.config.rollMode,isRollRequest:!0,_showRequestedBy:!0,_requestedBy:e.config.requestedBy||"GM",flags:(u=o==null?void 0:o.data)==null?void 0:u.flags})}catch{I.notify("error",game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:c}))}}}).render(!0)},async handleHitDieRecovery(h){const e=foundry.utils.mergeObject({type:"long",deltas:{hitDice:0},newDay:!1,rolls:[],updateData:{},updateItems:[]},{});"dhd"in e&&(e.deltas.hitDice=e.dhd),h._getRestHitDiceRecovery({maxHitDice:h.system.attributes.hd.max,type:"long"},e),e.dhd=e.deltas.hitDice,e.longRest=!0;try{if(e.updateData&&Object.keys(e.updateData).length>0){const t=await h.update(e.updateData,{isRest:!1})}else d.log("No actor updates to perform",[]);if(e.updateItems&&e.updateItems.length>0){const t=await h.updateEmbeddedDocuments("Item",e.updateItems,{isRest:!1})}else d.log("No item updates to perform",[])}catch(t){throw d.error("Error during updates in handleHitDieRecovery:",[t]),t}return d.log("handleHitDieRecovery #3",[e]),e}};async function ao(){return game.combat||(await(await Combat.create({scene:game.scenes.active.id})).activate(),ie.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.combatCreated"))),game.combat}async function io(h,e){if(!e.combat)return h;const t=h.map(a=>e.actors.get(a)).filter(a=>a),o=[],s=new Set;for(const a of t)e.combat.getCombatantsByActor(a.id).some(r=>r.initiative!==null)&&(o.push(a.name),s.add(a.id));if(d.log("filterActorsForInitiative",[o]),o.length>0)if(await foundry.applications.api.DialogV2.confirm({window:{title:e.i18n.localize("FLASH_ROLLS.ui.dialogs.rerollInitiativeTitle"),classes:["flash5e-dialog"]},position:{width:420,height:"auto"},content:"<p>"+e.i18n.format("FLASH_ROLLS.ui.dialogs.rerollInitiative",{actors:o.join(", ")})+"</p>",rejectClose:!1,modal:!0})){if(e.user.isGM)for(const i of s){const n=e.combat.getCombatantsByActor(i);d.log("filterActorsForInitiative - resetting initiative for combatants",[n]);for(const r of n)await r.update({initiative:null})}else d.log("filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll");return h}else{const i=h.filter(n=>!s.has(n));return i.length===0&&ie.notify("info",e.i18n.localize("FLASH_ROLLS.notifications.allActorsHaveInitiative")),i}return h}Hooks.once(H.READY,()=>{dnd5e.applications.dice.DamageRollConfigurationDialog||d.warn("DamageRollConfigurationDialog not found in dnd5e.applications.dice")});function ut(h){return class extends h{constructor(e={},t={},o={}){var s,a;super(e,t,o),this.actors=o.actors||[],this.sendRequest=o.sendRequest??o.isRollRequest??!1,this.showDC=o.showDC||!1,this.dcValue=o.dcValue??o.dc??null,this.rollKey=o.rollKey||e.skill||e.ability||null,this.rollTypeString=o.rollTypeString||null,this.windowTitle=((s=o.window)==null?void 0:s.title)||"",this.windowSubtitle=((a=o.window)==null?void 0:a.subtitle)||""}_buildConfig(e,t,o){const s=t==null?void 0:t.get("ability"),a=t==null?void 0:t.get("dc");s&&(e.ability=s,this.config.ability=s);const i=super._buildConfig(e,t,o);if(a){const n=parseInt(a);isNaN(n)||(i.options=i.options||{},i.options.target=n)}else this.dcValue!==void 0&&this.dcValue!==null&&(i.options=i.options||{},i.options.target=this.dcValue);return d.log(`${this.constructor.name}._buildConfig`,[this.config,t,i]),i}_onChangeForm(e,t){var a;d.log("_onChangeForm",[(a=t.target)==null?void 0:a.value]),super._onChangeForm(e,t);const o=this.element.querySelector('input[name="flash5e-send-request"]');o&&(this.sendRequest=o.checked);const s=this.element.querySelector('input[name="dc"]');s&&s.value&&(this.dcValue=parseInt(s.value)||null)}_finalizeRolls(e){const t=super._finalizeRolls(e);if(d.log("_finalizeRolls #1",[t,this.sendRequest]),this.dcValue!==void 0&&this.dcValue!==null)for(const o of t)o.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,this.config.skipRollDialog=this.sendRequest?this.config.skipRollDialog||!1:!0,t}async _onCreateMacroClick(e){var c;if(e.preventDefault(),e.stopPropagation(),d.log("_onCreateMacroClick",[this]),!this.rollTypeString){ui.notifications.error("Cannot create macro: roll type not defined");return}const t=new foundry.applications.ux.FormDataExtended(this.form),o=t.get("roll.0.situational")||t.get("rolls.0.situational")||"",s=t.get("dc"),a=t.get("flash5e-send-request"),i=t.get("rollMode")||game.settings.get("core","rollMode"),n=t.get("ability"),r=((c=this.actors)==null?void 0:c.map(u=>u.id))||[],l={requestType:this.rollTypeString,rollKey:this.rollKey,actorIds:r,config:{...o&&{situationalBonus:o},...s&&{dc:parseInt(s)},...i!==game.settings.get("core","rollMode")&&{rollMode:i},...n&&{ability:n},sendAsRequest:!!a,skipRollDialog:!0,advantage:!1,disadvantage:!1}};try{await I.createMacro(l),this.close()}catch(u){d.error("Failed to create macro:",[u]),ui.notifications.error(`Failed to create macro: ${u.message}`)}}async _onRender(e,t){var o,s,a;await super._onRender(e,t),((a=(s=(o=this.config.rolls)==null?void 0:o[0])==null?void 0:s.data)!=null&&a.situational||this.config.situational)&&(d.log(`${this.constructor.name}._onRender`,["Triggering rebuild for initial situational bonus"]),this.element&&(this.element.style.transition="none",this.element.style.opacity="1"),requestAnimationFrame(()=>{this.rebuild(),this.element&&requestAnimationFrame(()=>{this.element.style.transition=""})}))}}}class ve extends ut(dnd5e.applications.dice.D20RollConfigurationDialog){constructor(e={},t={},o={}){o.rollType=o.rollType||CONFIG.Dice.D20Roll,super(e,t,o),d.log("constructor - initializing GM Dialog",[e,t,o])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}get title(){return this.windowTitle||super.title}_prepareConfigurationData(e,t,o,s){d.log("_prepareConfigurationData",[e,t,o,s]);const a=super._prepareConfigurationData(e,t,o,s);return a.showDC=this.showDC,a.dcValue=this.dcValue,a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,o){return d.log("_preparePartContext",[e,t,o]),t=await super._preparePartContext(e,t,o),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(d.log("_onRender",[e,t]),super._onRender(e,t),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let o=this.element.querySelector(".rolls .formulas");if(o&&(this.showDC||this.actors.length>0)){const s={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},a=await q.renderTemplate(`modules/${R}/templates/gm-roll-config-fields.hbs`,s),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,o.parentNode.insertBefore(i,o)}this._attachButtonListeners()}_attachButtonListeners(){d.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,o,s={}){var S,T,b,v,L,E,O,w,M;if(e=P.validateActors(e),!e)return null;const a=e[0];d.log("GMRollConfigDialog.initConfiguration",[t,o,s]);const i=t==null?void 0:t.toLowerCase(),n=C(),r=_.get(n.publicPlayerRolls.tag)===!0,l=P.determineRollMode(r),c=P.shouldShowDC(i),u=P.getRollClass(i),g=P.createBaseRollConfig(a,t,o),f=P.createMessageConfig(a,l);s.situationalBonus&&(g.rolls[0].data.situational=s.situationalBonus),s.advantage===!0?g.rolls[0].options.advantage=!0:s.disadvantage===!0&&(g.rolls[0].options.disadvantage=!0);const p={options:{actors:e,sendRequest:e.some(F=>P.isPlayerOwned(F)),showDC:c,rollKey:o,rollType:u,rollTypeString:i,window:{title:ve._getRollTitle(i,o,a),subtitle:ve._getSubtitle(e)},position:{width:420,height:"auto"},...s}},m=await P.triggerRollDialog(this,g,f,p.options),k=P.processDialogResult(m,e,t,o,s);if(!k)return null;if((S=m.config)!=null&&S.ability&&[A.SKILL,A.TOOL].includes(i)){const F=((b=(T=a.system.skills)==null?void 0:T[o])==null?void 0:b.ability)||((L=(v=CONFIG.DND5E.skills)==null?void 0:v[o])==null?void 0:L.ability);m.config.ability!==F&&(k.ability=m.config.ability)}let y=p.options.window.title;if(m.config.ability&&[A.SKILL,A.TOOL].includes(i)){const F=((E=CONFIG.DND5E.abilities[m.config.ability])==null?void 0:E.label)||m.config.ability;if(i===A.SKILL){const U=((O=CONFIG.DND5E.skills[o])==null?void 0:O.label)||o;y=game.i18n.format("DND5E.SkillPromptTitle",{skill:U,ability:F})}else if(i===A.TOOL){const U=(M=(w=CONFIG.DND5E.enrichmentLookup)==null?void 0:w.tools)==null?void 0:M[o];let z=o;if(U!=null&&U.id){const N=dnd5e.documents.Trait.getBaseItem(U.id,{indexOnly:!0});z=(N==null?void 0:N.name)||o}y=game.i18n.format("DND5E.ToolPromptTitle",{tool:z,ability:F})}}return k.rollTitle=y,k.rollType=i,k.rollKey=o,k}static _getRollTitle(e,t,o){var i,n,r,l,c,u,g,f,p,m,k,y,S;let s="";const a=e==null?void 0:e.toLowerCase();switch([A.SAVE,A.ABILITY,A.ABILITY_CHECK].includes(a)&&!t&&d.warn("Missing rollKey for roll type",[a,t]),a){case A.SKILL:const T=((i=CONFIG.DND5E.skills[t])==null?void 0:i.label)||t,b=(n=o==null?void 0:o.system.skills)==null?void 0:n[t],v=(b==null?void 0:b.ability)||((r=CONFIG.DND5E.skills[t])==null?void 0:r.ability)||"int",L=((l=CONFIG.DND5E.abilities[v])==null?void 0:l.label)||v;s=game.i18n.format("DND5E.SkillPromptTitle",{skill:T,ability:L});break;case A.SAVE:case A.SAVING_THROW:const E=((c=CONFIG.DND5E.abilities[t])==null?void 0:c.label)||t;s=game.i18n.format("DND5E.SavePromptTitle",{ability:E});break;case A.ABILITY:case A.ABILITY_CHECK:const O=((u=CONFIG.DND5E.abilities[t])==null?void 0:u.label)||t;s=game.i18n.format("DND5E.AbilityPromptTitle",{ability:O});break;case A.CONCENTRATION:s=game.i18n.localize("DND5E.Concentration");break;case A.TOOL:const w=(f=(g=CONFIG.DND5E.enrichmentLookup)==null?void 0:g.tools)==null?void 0:f[t];let M=t;if(w!=null&&w.id){const N=dnd5e.documents.Trait.getBaseItem(w.id,{indexOnly:!0});M=(N==null?void 0:N.name)||t}const F=(p=o==null?void 0:o.system.tools)==null?void 0:p[t],U=(F==null?void 0:F.ability)||((y=(k=(m=CONFIG.DND5E.enrichmentLookup)==null?void 0:m.tools)==null?void 0:k[t])==null?void 0:y.ability)||"int",z=((S=CONFIG.DND5E.abilities[U])==null?void 0:S.label)||U;s=game.i18n.format("DND5E.ToolPromptTitle",{tool:M,ability:z});break;case A.DEATH_SAVE:s=game.i18n.localize("DND5E.DeathSave");break;case A.INITIATIVE:case A.INITIATIVE_DIALOG:s=game.i18n.localize("DND5E.Initiative");break;default:s=game.i18n.localize("DND5E.Roll")}return d.log("_getRollTitle",[a,s]),s}static _getSubtitle(e=[]){return e.length===1?e[0].name:e.length>1?game.i18n.localize("FLASH_ROLLS.ui.dialogs.multipleActors"):""}}class no extends ut(dnd5e.applications.dice.RollConfigurationDialog){constructor(e={},t={},o={}){o.rollType=CONFIG.Dice.BasicRoll||Roll,o.showDC=!1,super(e,t,o),d.log("constructor",[e,t,o])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config","hit-die-config"]})}_prepareConfigurationData(e,t,o,s){const a=super._prepareConfigurationData(e,t,o,s);return d.log("GMHitDieConfigDialog._prepareConfigurationData",[a]),a.formula="Hit Die (varies by actor)",a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,o){return t=await super._preparePartContext(e,t,o),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length,t.formula="Hit Die (varies by actor)"),t}async _onRender(e,t){if(super._onRender(e,t),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let o=this.element.querySelector(".rolls .formulas");if(o&&this.actors.length>0){const s={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},a=await q.renderTemplate(`modules/${R}/templates/gm-roll-config-fields.hbs`,s),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,o.parentNode.insertBefore(i,o)}this._attachButtonListeners()}_attachButtonListeners(){d.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}async _processSubmitData(e,t,o){await super._processSubmitData(e,t,o),this.sendRequest=o.get("flash5e-send-request")!=="false",d.log("_processSubmitData",[o,this.config])}_finalizeRolls(e){const t=super._finalizeRolls(e);return this.config.sendRequest=this.sendRequest,t}static async initConfiguration(e,t,o,s={}){var p;if(e=P.validateActors(e),!e)return null;const a=e[0];d.log("GMHitDieConfigDialog, initConfiguration",[]);const i=C(),n=_.get(i.publicPlayerRolls.tag)===!0,r=P.determineRollMode(n),l={data:a.getRollData(),subject:a,rolls:[{parts:[],data:a.getRollData(),options:{flavor:"Hit Die Roll"}}]};s.situationalBonus&&(l.rolls[0].data.situational=s.situationalBonus);const c=P.createMessageConfig(a,r),u={options:{actors:e,sendRequest:e.some(m=>P.isPlayerOwned(m)),rollKey:o,rollType:CONFIG.Dice.BasicRoll||Roll,window:{title:game.i18n.localize("DND5E.HitDice"),subtitle:ve._getSubtitle(e)},position:{width:420,height:"auto"},...s}},g=await P.triggerRollDialog(this,l,c,u.options);if(!(g!=null&&g.rolls)||g.rolls.length===0)return null;d.log("GMHitDieConfigDialog - dialog result",[g.rolls]);const f=P.processDialogResult(g,e,t,o,s);return f?((p=g.config)!=null&&p.ability&&(f.ability=g.config.ability),f):null}}class ro extends ut(dnd5e.applications.dice.SkillToolRollConfigurationDialog){constructor(e={},t={},o={}){const s=foundry.utils.mergeObject(e,{chooseAbility:!0});o.rollType=o.rollType||CONFIG.Dice.D20Roll,super(s,t,o),d.log("constructor",[e,t,o])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,o,s){d.log("_prepareConfigurationData",[e,t,o,s]);const a=super._prepareConfigurationData(e,t,o,s);return a.showDC=this.showDC,a.dcValue=this.dcValue,a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,o){return d.log("_preparePartContext",[e,t,o]),t=await super._preparePartContext(e,t,o),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(d.log("_onRender",[e,t]),super._onRender(e,t),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let o=this.element.querySelector(".rolls .formulas");if(o&&(this.showDC||this.actors.length>0)){const s={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},a=await q.renderTemplate(`modules/${R}/templates/gm-roll-config-fields.hbs`,s),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,o.parentNode.insertBefore(i,o)}this._attachButtonListeners()}_attachButtonListeners(){d.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,o,s={}){var S,T,b,v,L,E;if(e=P.validateActors(e),!e)return null;const a=e[0];d.log("GMSkillToolConfigDialog.initConfiguration",[t,o,s]);const i=t==null?void 0:t.toLowerCase(),n=C(),r=_.get(n.publicPlayerRolls.tag)===!0,l=P.determineRollMode(r),c=P.shouldShowDC(i),u=CONFIG.Dice.D20Roll;let g=null;if(i===A.SKILL){const O=a.system.skills[o];g=(O==null?void 0:O.ability)||((S=CONFIG.DND5E.skills[o])==null?void 0:S.ability)||"int"}else if(i===A.TOOL){const O=(T=a.system.tools)==null?void 0:T[o];g=(O==null?void 0:O.ability)||((L=(v=(b=CONFIG.DND5E.enrichmentLookup)==null?void 0:b.tools)==null?void 0:v[o])==null?void 0:L.ability)||"int"}const f={data:a.getRollData(),subject:a,ability:g,chooseAbility:!0,rolls:[{parts:[],data:a.getRollData(),options:{}}]};s.situationalBonus&&(f.rolls[0].data.situational=s.situationalBonus),s.advantage===!0?f.rolls[0].options.advantage=!0:s.disadvantage===!0&&(f.rolls[0].options.disadvantage=!0),i===A.SKILL?f.skill=o:i===A.TOOL&&(f.tool=o);const p=P.createMessageConfig(a,l),m={options:{actors:e,sendRequest:e.some(O=>P.isPlayerOwned(O)),showDC:c,rollKey:o,rollType:u,rollTypeString:i,window:{title:ve._getRollTitle(i,o,a),subtitle:ve._getSubtitle(e)},position:{width:420,height:"auto"},...s}},k=await P.triggerRollDialog(this,f,p,m.options),y=P.processDialogResult(k,e,t,o,s);return y?((E=k.config)!=null&&E.ability&&[A.SKILL,A.TOOL].includes(i)&&(y.ability=k.config.ability),y.rollTitle=m.options.window.title,y.rollType=i,y.rollKey=o,y):null}}class Uo extends ut(dnd5e.applications.dice.DamageRollConfigurationDialog){constructor(e={},t={},o={}){const s=foundry.utils.mergeObject({configure:!0},e);super(s,t,o),d.log("GMDamageConfigDialog.constructor",[s,t,o])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","damage-roll","gm-roll-config"]})}_prepareConfigurationData(e,t,o,s){d.log("GMDamageConfigDialog._prepareConfigurationData",[e,t,o,s]);const a=super._prepareConfigurationData(e,t,o,s);return a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _onRender(e,t){if(await super._onRender(e,t),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields")||(q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields")))return;let o=this.element.querySelector(".rolls .formulas");if(o&&(this.showDC||this.actors.length>0)){const s={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!1},a=await q.renderTemplate(`modules/${R}/templates/gm-roll-config-fields.hbs`,s),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,o.parentNode.insertBefore(i,o)}this._attachButtonListeners()}_attachButtonListeners(){d.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,o,s={},a={},i={}){var F,U,z,N,K,Ee;if(e=P.validateActors(e),d.log("GMDamageConfigDialog, initConfiguration",[e,a,i]),!e)return null;const n=e[0],r=(F=a.subject)==null?void 0:F.item,l=n.items.get(o),c=(l==null?void 0:l.id)||(r==null?void 0:r.id);let u={};c&&(u=Re.getActivityConfigFromCache(c)||{}),d.log("GMDamageConfigDialog - retrieved activity config from cache",[c,u]);const g=C(),f=_.get(g.publicPlayerRolls.tag)===!0,p=P.determineRollMode(f,a.rollMode),m=t==null?void 0:t.toLowerCase(),k={subject:a.subject||n,data:n.getRollData(),critical:a.critical||{},rolls:a.rolls||[{parts:[],data:n.getRollData(),options:{}}]};s.situationalBonus&&(k.rolls[0].data.situational=s.situationalBonus),d.log("GMDamageConfigDialog, initConfiguration #1",[k]);const y=P.createMessageConfig(n,p);d.log("GMDamageConfigDialog, initConfiguration #2",[y]);const{position:S,...T}=(i==null?void 0:i.options)||{},b={options:{actors:e,sendRequest:e.some(_e=>P.isPlayerOwned(_e)),rollKey:o,rollType:CONFIG.Dice.DamageRoll,rollTypeString:m,window:{title:game.i18n.localize("DND5E.DamageRoll"),subtitle:ve._getSubtitle(e)},...T,...s}},v=await P.triggerRollDialog(this,k,y,b.options);if(!(v!=null&&v.rolls)||v.rolls.length===0)return null;const L=v.rolls[0],E=((U=L==null?void 0:L.data)==null?void 0:U.situational)||"",O=(z=L==null?void 0:L.options)==null?void 0:z.target,w={rolls:[{parts:[],data:E?{situational:E}:{},options:{...O&&{target:O},isCritical:((N=L==null?void 0:L.options)==null?void 0:N.isCritical)||(L==null?void 0:L.isCritical)||!1}}],subject:a.subject||n,target:O,isCritical:((K=L==null?void 0:L.options)==null?void 0:K.isCritical)||(L==null?void 0:L.isCritical)||!1,sendRequest:v.sendRequest,isRollRequest:v.sendRequest,skipRollDialog:v.sendRequest?s.skipRollDialog||!1:!0,chatMessage:!0,spell:u.spell||a.spell||{},scaling:u.scaling!==void 0?u.scaling:a.scaling,consume:u.consume||a.consume||{},create:u.create||a.create||{}};d.log("GMDamageConfigDialog, initConfiguration #6",[w]);const M=P.determineRollMode(f,(Ee=v.message)==null?void 0:Ee.rollMode);return w.rollMode=M,w.rollTitle=b.options.window.title,w.rollType=m,w.rollKey=o,d.log("GMDamageConfigDialog, initConfiguration - result",[w]),w}}class zo extends ut(dnd5e.applications.dice.AttackRollConfigurationDialog){constructor(e={},t={},o={}){super(e,t,o),d.log("GMAttackConfigDialog.constructor",[e,t,o])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,o,s){d.log("GMAttackConfigDialog._prepareConfigurationData",[e,t,o,s]);const a=super._prepareConfigurationData(e,t,o,s);return a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(e,t,o){return t=await super._preparePartContext(e,t,o),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(await super._onRender(e,t),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let o=this.element.querySelector(".rolls .formulas");if(o&&this.actors.length>0){const s={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!1},a=await q.renderTemplate(`modules/${R}/templates/gm-roll-config-fields.hbs`,s),i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=a,o.parentNode.insertBefore(i,o)}this._attachButtonListeners()}_attachButtonListeners(){d.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}_finalizeRolls(e){return this.config.sendRequest=this.sendRequest,!this.sendRequest&&this.config.isRollRequest&&(this.config.isRollRequest=!1),super._finalizeRolls(e)}static async initConfiguration(e,t,o,s={},a={},i={}){var z,N,K,Ee,_e,we,gt,ft;if(e=P.validateActors(e),!e)return null;const n=e[0];d.log("GMAttackConfigDialog, initConfiguration",[]);const r=(z=a.subject)==null?void 0:z.item,l=n.items.get(o),c=(l==null?void 0:l.id)||(r==null?void 0:r.id);let u={};c&&(u=Re.getActivityConfigFromCache(c)||{}),d.log("GMAttackConfigDialog - retrieved activity config from cache",[c,u]);const g=C(),f=_.get(g.publicPlayerRolls.tag)===!0,p=t==null?void 0:t.toLowerCase(),m={subject:a.subject||n,data:n.getRollData(),rolls:[{parts:[],data:n.getRollData(),options:{}}]};s.situationalBonus&&(m.rolls[0].data.situational=s.situationalBonus);const k=P.determineRollMode(f),y=P.createMessageConfig(n,k),{position:S,...T}=(i==null?void 0:i.options)||{},b={options:{actors:e,sendRequest:e.some(Lt=>P.isPlayerOwned(Lt)),rollKey:o,rollType:CONFIG.Dice.D20Roll,rollTypeString:p,window:{title:game.i18n.localize("DND5E.Attack"),subtitle:ve._getSubtitle(e)},...T,...s}},v=await P.triggerRollDialog(this,m,y,b.options);if(d.log("GMAttackConfigDialog, initConfiguration",[v==null?void 0:v.sendRequest]),!(v!=null&&v.rolls)||v.rolls.length===0)return null;const L=v.rolls[0];let E=!1,O=!1;((N=L==null?void 0:L.options)==null?void 0:N.advantageMode)!==void 0&&(E=L.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,O=L.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const w=((K=L==null?void 0:L.data)==null?void 0:K.situational)||"",M=(Ee=L==null?void 0:L.options)==null?void 0:Ee.target,F={rolls:[{parts:[],data:w?{situational:w}:{},options:{...M&&{target:M},...((_e=L==null?void 0:L.options)==null?void 0:_e.ammunition)&&{ammunition:L.options.ammunition},...((we=L==null?void 0:L.options)==null?void 0:we.attackMode)&&{attackMode:L.options.attackMode},...((gt=L==null?void 0:L.options)==null?void 0:gt.mastery)!==void 0&&{mastery:L.options.mastery}}}],subject:a.subject||n,advantage:E,disadvantage:O,target:M,sendRequest:v.sendRequest,isRollRequest:v.sendRequest,skipRollDialog:v.sendRequest?s.skipRollDialog||!1:!0,chatMessage:!q.isModuleOn("midi-qol")||!0,spell:(u==null?void 0:u.spell)||(a==null?void 0:a.spell)||{},scaling:(u==null?void 0:u.scaling)!==void 0?u==null?void 0:u.scaling:a==null?void 0:a.scaling,consume:(u==null?void 0:u.consume)||(a==null?void 0:a.consume)||{},create:(u==null?void 0:u.create)||(a==null?void 0:a.create)||{}},U=P.determineRollMode(f,(ft=v.message)==null?void 0:ft.rollMode);return F.rollMode=U,F.rollTitle=b.options.window.title,F.rollType=p,F.rollKey=o,d.log("GMAttackConfigDialog, initConfiguration - SIMPLIFIED result",[F]),F}}class jt{static async getRollConfiguration(e,t,o,s,a,i={}){const n=C(),r=_.get(n.rollRequestsEnabled.tag),l=i.hasOwnProperty("sendAsRequest")?i.sendAsRequest:void 0,c=e.filter(g=>a.includes(g.id));let u;if(i.hasOwnProperty("skipRollDialog")?u=i.skipRollDialog:u=P.shouldSkipRollDialog(l,{isPC:a.length>0,isNPC:c.length>0}),d.log("getRollConfiguration",[i]),!u&&t!==A.CUSTOM){let g;[A.SKILL,A.TOOL].includes(t)?g=ro:t===A.HIT_DIE?g=no:g=ve;const f=await g.initConfiguration(e,t,o,{confirmedSkipDialog:u,sendRequest:r&&(l===!0||l===void 0&&a.length>0),...i,advantage:i.advantage===!0,disadvantage:i.disadvantage===!0,situationalBonus:i.situationalBonus});return d.log("getRollConfiguration B",[f]),f&&i.groupRollId&&(f.groupRollId=i.groupRollId,f.isContestedRoll=i.isContestedRoll||!1),f}else{const g={rolls:[{parts:[],data:i.situationalBonus?{situational:i.situationalBonus}:{},options:i.dc?{target:i.dc}:{}}],advantage:i.advantage===!0,disadvantage:i.disadvantage===!0,situationalBonus:i.situationalBonus,rollMode:i.rollMode||game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:u,sendRequest:r&&(i.hasOwnProperty("sendAsRequest")?i.sendAsRequest:a.length>0)};return i.dc&&(g.target=i.dc),t===A.DEATH_SAVE&&(g.target=10),i.groupRollId&&(g.groupRollId=i.groupRollId,g.isContestedRoll=i.isContestedRoll||!1),g}}static async handleCustomRoll(){return await this.showCustomRollDialog()}static async showCustomRollDialog(){return d.log("showCustomRollDialog"),Ht.prompt({formula:"",readonly:!1})}}class Nt{static initialize(){d.log("RollInterceptor.initialize"),game.user.isGM&&this.registerHooks()}static registerHooks(){d.log("RollInterceptor.registerHooks"),this._registerHook(ee.PRE_ROLL_ABILITY_CHECK,this._onPreRollIntercept.bind(this,A.ABILITY)),this._registerHook(ee.PRE_ROLL_SAVING_THROW,this._onPreRollIntercept.bind(this,A.SAVE)),this._registerHook(ee.PRE_ROLL_SKILL_V2,this._onPreRollIntercept.bind(this,A.SKILL)),this._registerHook(ee.PRE_ROLL_TOOL_V2,this._onPreRollIntercept.bind(this,A.TOOL)),this._registerHook(ee.PRE_ROLL_ATTACK_V2,this._onPreRollIntercept.bind(this,A.ATTACK)),this._registerHook(ee.PRE_ROLL_DAMAGE_V2,this._onPreRollIntercept.bind(this,A.DAMAGE)),this._registerHook(ee.PRE_ROLL_DEATH_SAVE_V2,this._onPreRollIntercept.bind(this,A.DEATH_SAVE)),this._registerHook(ee.PRE_ROLL_HIT_DIE_V2,this._onPreRollIntercept.bind(this,A.HIT_DIE)),this._registerHook(ee.PRE_ROLL_INITIATIVE,this._onPreRollInterceptInitiative.bind(this,A.INITIATIVE)),this._registerHook(ee.PRE_ROLL_INITIATIVE_DIALOG,this._onPreRollInterceptInitiative.bind(this,A.INITIATIVE))}static _registerHook(e,t){d.log("RollInterceptor._registerHook");const o=Hooks.on(e,t);this.registeredHooks.add({hookName:e,hookId:o})}static unregisterHooks(){d.log("RollInterceptor.unregisterHooks");for(const{hookName:e,hookId:t}of this.registeredHooks)Hooks.off(e,t);this.registeredHooks.clear()}static _onPreRollInterceptInitiative(e,t,o){}static _onPreRollIntercept(e,t,o,s){var S,T,b,v,L,E,O,w,M;d.log("_onPreRollIntercept #0",[e,t,o,s]);const a=C(),i=_.get(a.rollRequestsEnabled.tag),n=_.get(a.rollInterceptionEnabled.tag),r=q.isModuleOn("midi-qol");let l;if(e===A.INITIATIVE&&t instanceof Actor){if(l=t,(o==null?void 0:o.isRollRequest)===!1||(s==null?void 0:s.isRollRequest)===!1)return}else e===A.HIT_DIE?l=((S=o==null?void 0:o.subject)==null?void 0:S.actor)||(o==null?void 0:o.subject)||(o==null?void 0:o.actor):e===A.ATTACK||e===A.DAMAGE?l=(T=t.subject)==null?void 0:T.actor:l=((b=t.subject)==null?void 0:b.actor)||t.subject||t.actor;const c=q.getActorOwner(l);(c==null?void 0:c.id)===game.user.id&&(c==null||c.active);const u=q.areSkipKeysPressed(t.event),f=_.get(a.skipToRollResolver.tag)&&Ce.hasNonDigitalDice(),p=u||_.get(a.skipRollDialog.tag)||f;if(!i||!n||t.isRollRequest===!1){if(!r){const F=u||t.isRollRequest===void 0&&p;o.configure=!F}return}if(s.data={...s.data,flags:{...s.data.flags,rsr5e:{...s.data.flags.rsr5e,processed:!0,quickRoll:!1}}},d.log("_onPreRollIntercept #1",[i,n,t,s]),!game.user.isGM||r&&(c!=null&&c.isGM||!(c!=null&&c.active)))return;const m=(t==null?void 0:t.hookNames)||(o==null?void 0:o.hookNames)||(s==null?void 0:s.hookNames)||[],k=m.includes("initiativeDialog")||m.includes("initiative");if(e===A.ATTACK||e===A.DAMAGE){const F=((L=(v=t.subject)==null?void 0:v.item)==null?void 0:L.getFlag(R,"tempAttackConfig"))||((O=(E=t.subject)==null?void 0:E.item)==null?void 0:O.getFlag(R,"tempDamageConfig"));if(o.configure=!p,d.log("_onPreRollIntercept - attack / damage - flag",[F,t.subject,c]),F){d.log("_onPreRollIntercept - found module flags, skipping interception",[F]);return}if(((w=t.subject)!=null&&w.activity||(M=t.subject)!=null&&M.item)&&!(c!=null&&c.active)){d.log("_onPreRollIntercept - activity-based attack/damage roll with offline owner, skip interception",[t.subject,c]);return}}if(k&&e===A.ABILITY&&(d.log("RollInterceptor._onPreRollIntercept - Overriding ability to initiative",[m]),e=A.INITIATIVE),t!=null&&t.isRollRequest||t.sendRequest===!1||o!=null&&o.isRollRequest||s!=null&&s.isRollRequest){d.log("_onPreRollIntercept - skipping interception (roll request)",[t,o,s]);return}if(!n||!l||l.documentName!=="Actor")return;e===A.ATTACK&&(s={...s,rollMode:CONST.DICE_ROLL_MODES.PUBLIC});const y=r&&t.midiOptions;if(t.sendRequest===!1||t.skipRollDialog===!0){d.log("_onPreRollIntercept - skipping interception",[o.configure,t.sendRequest]);return}return y&&game.user.isGM?(d.log("_onPreRollIntercept - MidiActive",[t.midiOptions]),this._showGMConfigDialog(l,c,e,t,o,s),!1):(d.log("_onPreRollIntercept - intercepting roll #1",[t,o,s]),this._showGMConfigDialog(l,c,e,t,o,s),!1)}static async _handleInitiativePreChecks(e){return!game.combat&&!await ao()?!1:(await io([e.id],game)).length>0}static _getDialogClass(e){const t=e==null?void 0:e.toLowerCase();return[A.SKILL,A.TOOL].includes(t)?ro:t===A.HIT_DIE?no:t===A.ATTACK?zo:t===A.DAMAGE?Uo:ve}static _extractRollConfiguration(e,t,o,s){var r,l,c,u,g,f,p,m,k,y,S;const a=e==null?void 0:e.toLowerCase();let i=null;const n={rolls:[{parts:[],data:{},options:{}}]};switch(a){case A.SKILL:n.skill=t.skill,n.ability=t.ability||((r=t.subject)==null?void 0:r.ability),i=n.skill;break;case A.TOOL:n.tool=t.tool,n.ability=t.ability||((l=t.subject)==null?void 0:l.ability),i=n.tool;break;case A.ABILITY:case A.SAVE:n.ability=t.ability||((c=t.subject)==null?void 0:c.ability),i=n.ability,n.ability==="con"&&t.targetValue!==void 0&&(e=A.CONCENTRATION);break;case A.CONCENTRATION:n.ability="con",i="con";break;case A.INITIATIVE:case A.INITIATIVE_DIALOG:i=((g=(u=s.system.attributes)==null?void 0:u.init)==null?void 0:g.ability)||"dex";break;case A.HIT_DIE:n.denomination=typeof t=="string"?t:t.denomination||((f=t.subject)==null?void 0:f.denomination),i=n.denomination;break;case A.ATTACK:o!=null&&o.options&&(n.ammunition=o.options.ammunition,n.attackMode=o.options.attackMode,n.mastery=o.options.mastery),i=(m=(p=t.subject)==null?void 0:p.item)==null?void 0:m.id;break;case A.DAMAGE:n.item=(k=t.subject)==null?void 0:k.item,n.subject=t.subject,n.critical=t.critical||{},i=(S=(y=t.subject)==null?void 0:y.item)==null?void 0:S.id;break}return{rollKey:i,rollConfig:n}}static async _getDialogResult(e,t,o,s,a,i,n,r){const l=o==null?void 0:o.toLowerCase();if(d.log("_getDialogResult",[t,o,s,n,r]),a)return{sendRequest:!0,advantage:!1,disadvantage:!1,skipRollDialog:!1,situational:"",rollMode:game.settings.get("core","rollMode")};if(!e.initConfiguration)throw d.error("DialogClass.initConfiguration not found",[e,e.name]),new Error(`DialogClass ${e.name} does not have initConfiguration method`);const c={skipRollDialog:!1,sendRequest:i&&n.isRollRequest!==!1};return d.log("_getDialogResult - normalizedRollType",[l,A.DAMAGE,A.ATTACK]),l===A.ATTACK||l===A.DAMAGE?(d.log("DialogClass.initConfiguration A",[t,l,s,c,n,r]),await e.initConfiguration([t],l,s,c,n,r)):(d.log("DialogClass.initConfiguration B",[t,l,s,c,n,r]),await e.initConfiguration([t],l,s,c,n,r))}static async _showGMConfigDialog(e,t,o,s,a,i){d.log("_showGMConfigDialog - config",[o,a,s,i]);const n=C(),r=_.get(n.rollRequestsEnabled.tag),l=q.areSkipKeysPressed(s.event);try{if((o==null?void 0:o.toLowerCase())===A.INITIATIVE&&!await this._handleInitiativePreChecks(e))return;const u=this._getDialogClass(o),{rollKey:g,rollConfig:f}=this._extractRollConfiguration(o,s,a,e),p=t&&(t==null?void 0:t.active)&&!(t!=null&&t.isGM);let m;const k=a.configure===!0?!1:l||a.configure===!1||P.shouldSkipRollDialog(p?r:!1,{isPC:p,isNPC:!p});if(d.log("_showGMConfigDialog - rollConfig",[f,g,k,p,t]),k?m={sendRequest:p?r:!1,advantage:!1,disadvantage:!1,skipRollDialog:!0,situational:"",rollMode:game.settings.get("core","rollMode")}:(m=await this._getDialogResult(u,e,o,g,k,r,s,a),d.log("_showGMConfigDialog - _getDialogResult",[m])),!m){d.log("_showGMConfigDialog - Dialog cancelled");return}if(!m.sendRequest||!r){d.log("_showGMConfigDialog - triggering _executeInterceptedRoll",[o,s,m]),await this._executeInterceptedRoll(e,o,s,m);return}delete s.event;const y=s.subject,S={...s,...m,subject:y,rolls:m.rolls,requestedBy:game.user.name,...o===A.ATTACK&&{chatMessage:!1}};d.log("_showGMConfigDialog - triggering _sendRollRequest",[o,S]),this._sendRollRequest(e,t,o,S)}catch(c){d.error("RollInterceptor._showGMConfigDialog - Error",[c])}}static async _executeInterceptedRoll(e,t,o,s){var g,f,p,m,k,y,S,T,b,v,L,E,O,w;d.log("RollInterceptor._executeInterceptedRoll",[e,t,o,s]);const a=t==null?void 0:t.toLowerCase(),i=((g=s.rolls)==null?void 0:g[0])||{parts:[],data:{},options:{}},n=((f=i.data)==null?void 0:f.situational)||s.situational||"";let r;switch(a){case A.SKILL:r=o.skill;break;case A.TOOL:r=o.tool;break;case A.ABILITY:case A.SAVE:r=o.ability||((p=o.subject)==null?void 0:p.ability);break;case A.HIT_DIE:r=o.denomination;break;default:r=o.ability||o.skill||o.tool||o.denomination}const l={rollKey:r,config:{advantage:s.advantage||o.advantage,disadvantage:s.disadvantage||o.disadvantage,target:s.target||s.dc||o.target,rollMode:s.rollMode||o.rollMode,situational:n,isRollRequest:!1,skipRollDialog:s.skipRollDialog,ability:o.ability}};if(a===A.SKILL&&!l.config.ability)l.config.ability=((k=(m=e.system.skills)==null?void 0:m[l.rollKey])==null?void 0:k.ability)||((S=(y=CONFIG.DND5E.skills)==null?void 0:y[l.rollKey])==null?void 0:S.ability);else if(a===A.TOOL&&!l.config.ability){const M=(T=e.system.tools)==null?void 0:T[l.rollKey];l.config.ability=(M==null?void 0:M.ability)||((L=(v=(b=CONFIG.DND5E.enrichmentLookup)==null?void 0:b.tools)==null?void 0:v[l.rollKey])==null?void 0:L.ability)||"int"}else(a===A.ABILITY||a===A.SAVE)&&!l.config.ability&&(l.config.ability=l.rollKey);d.log("RollInterceptor._executeInterceptedRoll - requestData",[l,o,s]);const c={configure:!1,isRollRequest:!1},u={rollMode:l.config.rollMode,create:!0,isRollRequest:!1};try{const M=A,F=me[a];F?((a===A.ATTACK||a===A.DAMAGE||a===A.SAVE)&&(l.rollKey=(O=(E=o.subject)==null?void 0:E.item)==null?void 0:O.id,l.activityId=(w=o.subject)==null?void 0:w.id,l.config.skipRollDialog=!0),await F(e,l,i,c,u)):d.warn(`No handler found for roll type: ${a}`)}catch(M){d.error("RollInterceptor._executeInterceptedRoll",[M])}}static async _sendRollRequest(e,t,o,s){var f,p,m,k;d.log("_sendRollRequest",[e,t,o,s]);const a=C();let i=o==null?void 0:o.toLowerCase();const n=t&&t.active&&t.id!==game.user.id;i===A.INITIATIVE&&(i=A.INITIATIVE_DIALOG);let r=null,l=null;switch(i){case A.ABILITY:case A.SAVE:r=s.ability;break;case A.SKILL:r=s.skill;break;case A.TOOL:r=s.tool;break;case A.ATTACK:case A.DAMAGE:d.log("_sendRollRequest - Attack/Damage roll config",[o,s]),r=(f=s.subject.item)==null?void 0:f.id,l=s.subject.id,d.log("_sendRollRequest - resolved rollKey and activityId",[r,l]);break;case A.HIT_DIE:r=typeof s=="string"?s:s.denomination;break;case A.INITIATIVE_DIALOG:case A.INITIATIVE:r=null;break;case A.DEATH_SAVE:r=null;break;default:d.warn(`Unknown roll type: ${o}`);return}const c={...s};if(c.midiOptions&&c.activity&&c.activity.type===se.DAMAGE&&(d.log("_sendRollRequest - Damage activity",[c]),c.midiOptions={...c.midiOptions,workflowOptions:{...c.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1,fastForwardDamage:!1}}),r&&(i===A.ATTACK||i===A.DAMAGE)){const y=s.subject,S=(p=game.modules.get("midi-qol"))==null?void 0:p.api;if(S&&y){const T=(k=(m=S.Workflow)==null?void 0:m.getWorkflowByActivityUuid)==null?void 0:k.call(m,y.uuid);T!=null&&T.templateUuid&&(c.templateUuid=T.templateUuid,d.log("_sendRollRequest - Added templateUuid from GM workflow",[T.templateUuid]))}}delete c.subject,delete c.workflow,delete c.item,delete c.activity;const u={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:e.id,rollType:i,rollKey:r,activityId:l,rollProcessConfig:{...c,_requestedBy:game.user.name},skipRollDialog:!1,targetTokenIds:Array.from(game.user.targets).map(y=>y.id),preserveTargets:_.get(a.useGMTargetTokens.tag)};if(d.log("_sendRollRequest - requestData",[t,u]),!n){d.log("_sendRollRequest - No valid active owner, executing locally",[t==null?void 0:t.name,t==null?void 0:t.active]);const y={...c,rollMode:s.rollMode||game.settings.get("core","rollMode"),skipRollDialog:P.shouldSkipRollDialog(!1,{isPC:!1,isNPC:!0})};await this._executeInterceptedRoll(e,o,s,y);return}await Ct.handleOfflinePlayer(t,e,o,s,{...s,sendRequest:!1})||(ge.execForUser("handleRollRequest",t.id,u),I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:(t==null?void 0:t.name)||"Unknown",actor:e.name||"Unknown"})))}}D(Nt,"registeredHooks",new Set);class Ct{static async handleOfflinePlayer(e,t,o,s,a=null){if(d.log("OfflinePlayerManager.handleOfflinePlayer",[e==null?void 0:e.name,t==null?void 0:t.name,o]),!e||!s)return I.notify("warn","Flash Token Bar: No owner found for actor "+t.name),!0;if(!e.active){const i=C();return _.get(i.showOfflineNotifications.tag)&&I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:e.name})),await Nt._executeInterceptedRoll(t,o,s,a||{...s,sendRequest:!1}),!0}return!1}static categorizeActorsByOnlineStatus(e){const t=[],o=[],s=new Map;for(const{actor:a,owner:i}of e)s.has(a.id)||s.set(a.id,{actor:a,owners:[]}),s.get(a.id).owners.push(i);for(const{actor:a,owners:i}of s.values()){const n=i.find(r=>r.active&&!r.isGM);n?t.push({actor:a,owner:n}):o.push(a)}return{onlinePlayerActors:t,offlinePlayerActors:o}}static async processOfflineActors(e,t,o,s){for(const a of e){const i=a.ownership||{};let n=null;for(const[f,p]of Object.entries(i))if(p>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER&&f!=="default"){const m=game.users.get(f);if(m&&!m.isGM){n=m;break}}if(!n){d.warn("OfflinePlayerManager.processOfflineActors - No owner found for actor",[a.name]);continue}const r={rollKey:o,groupRollId:s.groupRollId,config:{...s,...t==="ability"||t==="abilitycheck"||t==="save"||t==="savingthrow"?{ability:o}:{},sendRequest:!1,isGroupRoll:!!s.groupRollId}},l={parts:[],data:s.situational?{situational:s.situational}:{},options:s.dc?{target:s.dc}:{}},c={configure:!1,isRollRequest:!0},u={rollMode:s.rollMode||game.settings.get("core","rollMode"),create:!0,isRollRequest:!0,groupRollId:s.groupRollId},g=me[t.toLowerCase()];g&&await g(a,r,l,c,u),await new Promise(f=>setTimeout(f,200))}}}class at{static async handleGMRolls(e,t,o,s){d.log("RollMenuExecutor.handleGMRolls",[e,t,o,s]);for(const a of e)await this.initiateRoll(a,t,o,s),await Rt(100)}static async handleGMRollsWithTokens(e,t,o,s){var a,i;d.log("RollMenuExecutor.handleGMRollsWithTokens",[e,t,o,s]);for(const n of e){if(n.tokenId){const r=((a=canvas.tokens)==null?void 0:a.get(n.tokenId))||((i=game.scenes.active)==null?void 0:i.tokens.get(n.tokenId));r?await this.initiateRollForToken(n.actor,r,t,o,s):await this.initiateRoll(n.actor,t,o,s)}else await this.initiateRoll(n.actor,t,o,s);await Rt(100)}}static async initiateRollForToken(e,t,o,s,a){d.log("RollMenuExecutor.initiateRollForToken",[e.name,t.name,o,s,a]);const i=t.controlled;i||t.control({releaseOthers:!1});try{await this.initiateRoll(e,o,s,a)}finally{i||t.release()}}static async initiateRoll(e,t,o,s){var a;d.log("RollMenuExecutor.initiateRoll",[e,t,o,s]);try{const i=t.toLowerCase();let n=o;if(i===A.HIT_DIE){const y=e.system.attributes.hd;if(y.value>0&&(n=y.largestAvailable),!n){d.warn("RollMenuExecutor.initiateRoll - No hit dice available after orchestration refill",[e.name]),ie.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.noHitDice",{actor:e.name})||`No hit dice available for ${e.name}`);return}}const r={rollKey:n,groupRollId:s.groupRollId,config:{...s,rollMode:s.rollMode||game.settings.get("core","rollMode"),advantage:s.advantage||!1,disadvantage:s.disadvantage||!1,target:s.target}},l={configure:!s.fastForward&&!s.skipRollDialog,isRollRequest:!0};let c=s.rollMode||game.settings.get("core","rollMode");const u=C(),g=_.get(u.publicPlayerRolls.tag)===!0;(!(_.get(u.groupRollsMsgEnabled.tag)===!0)||!s.groupRollId)&&!s.rollMode&&g&&e&&P.isPlayerOwned(e)&&(c=CONST.DICE_ROLL_MODES.PUBLIC);const p={rollMode:c,create:s.chatMessage!==!1,isRollRequest:!0},m=((a=s.rolls)==null?void 0:a[0])||{};d.log("RollMenuExecutor.initiateRoll - rollConfig before handler",["parts:",m.parts,"data:",m.data,"rollProcessConfig:",s]);const k=me[i];k?await k(e,r,m,l,p):ie.notify("warn",`Unknown roll type: ${t}`)}catch(i){d.error("RollMenuExecutor.initiateRoll error",[i]),ie.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name}))}}}class Ye{static async orchestrateRollsForActors(e,t,o,s,a,i){const n=C(),r=[],l=[],c=[];let u=e.groupRollId||foundry.utils.randomID();d.log("RollMenuOrchestrator.orchestrateRollsForActors",["groupRollId:",u,"config.groupRollId:",e.groupRollId,"config.isContestedRoll:",e.isContestedRoll,"config.sendRequest:",e.sendRequest,"pcActors:",t.map(b=>{var v;return`${b.actor.name}(${(v=b.owner)==null?void 0:v.name})`}),"npcActors:",o.map(b=>b.name)]);const g=[],f=[];if(e.sendRequest){const{onlinePlayerActors:b,offlinePlayerActors:v}=Ct.categorizeActorsByOnlineStatus(t);if(c.push(...b),l.push(...v),v.length>0){const L=C();_.get(L.showOfflineNotifications.tag)&&v.forEach(E=>{var w;const O=(w=t.find(M=>M.actor.id===E.id))==null?void 0:w.owner;O&&ie.notify("info",game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:O.name}))})}f.push(...c.map(({actor:L})=>L))}else o.push(...t.map(({actor:b})=>b));f.push(...l,...o);const p=f.map(b=>b.id);g.push(...i.filter(b=>b&&b.actor&&p.includes(b.actor.id)));const m=_.get(n.groupRollsMsgEnabled.tag),k=_.get(n.useCondensedRollMessage.tag),y=f.length>1,S=u&&te.groupRollMessages.has(u);if(m&&!S&&(y||k||e.groupRollId)&&(await te.createGroupRollMessage(g,s,a,e,u),await Rt(100)),l.length>0&&(e.skipRollDialog=!0,e.groupRollId=u,await Ct.processOfflineActors(l,s,a,e)),s===A.HIT_DIE){const b=[];if(c.forEach(({actor:L})=>b.push(L)),l.forEach(L=>b.push(L)),o.forEach(L=>b.push(L)),!await this.handleHitDieRefill(b))return}for(const{actor:b,owner:v}of c){const L=m&&(y||k||e.isContestedRoll)?u:null;d.log("orchestrateRollsForActors - Sending to player",{actor:b.name,owner:v.name,useGroupId:L,groupRollId:u,"allActorEntries.length":g.length,"config.isContestedRoll":e.isContestedRoll,groupRollsMsgEnabled:m});let E=a;s===A.HIT_DIE&&(E=b.system.attributes.hd.largestAvailable,!E)||(await this.sendRollRequestToPlayer(b,v,s,E,e,!0,L),r.push({actor:b,owner:v}),await Rt(100))}if(r.length>0&&this.showConsolidatedNotification(r,s,a),o.length>0){e.skipRollDialog=!0,e.groupRollId=m&&(y||k||e.isContestedRoll)?u:null;const b=o.map(L=>L.id),v=i.filter(L=>L&&L.actor&&b.includes(L.actor.id));await at.handleGMRollsWithTokens(v,s,a,e)}}static async handleHitDieRefill(e){const o=(Array.isArray(e)?e:[e]).filter(i=>i.system.attributes.hd.value===0);if(o.length===0)return!0;const s=o.map(i=>i.name).join(", ");if(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessage",{actors:s})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){for(const i of o)try{const n=await me.handleHitDieRecovery(i);if(i.isToken&&i._actor)try{await me.handleHitDieRecovery(i._actor)}catch(r){d.error("Error updating base actor:",[r])}}catch(n){d.error("Error calling handleHitDieRecovery:",[n])}return ie.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:s})||`Hit dice refilled for ${s}`),!0}return!1}static async triggerRoll(e,t,o,s={}){var k;const a=C(),i=Array.from(o.selectedActors),n=s.skipRollDialog!==void 0?s.skipRollDialog:_.get(a.skipRollDialog.tag);let r=i.map(y=>{const S=Y(y);if(!S)return null;let T=null;return game.actors.get(y)?T=null:T=y,{actor:S,uniqueId:y,tokenId:T}}).filter(y=>y),l=r.map(y=>y.actor);const c=W.ROLL_REQUEST_OPTIONS[e],u=(k=(c==null?void 0:c.name)||e)==null?void 0:k.toLowerCase(),g=t;if(t=await this.handleSpecialRollTypes(u,t,i,r,l,o),t===null&&g!==null)return;if(!l.length){ie.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}const{pcActors:f,npcActors:p}=xo(l),m=await jt.getRollConfiguration(l,u,t,n,f,s);d.log("RollMenuOrchestrator.triggerRoll",[m]),m&&(await this.orchestrateRollsForActors(m,f,p,u,t,r),!(o!=null&&o.isLocked)&&typeof(o==null?void 0:o.close)=="function"&&setTimeout(()=>o.close(),500))}static async handleSpecialRollTypes(e,t,o,s,a,i){const n=C();switch(e){case A.CUSTOM:if(!t&&(t=await jt.handleCustomRoll(),!t))return null;break;case A.INITIATIVE:case A.INITIATIVE_DIALOG:if(!(await this.handleInitiativeRoll(o,s,a)).success)return null;_.get(n.initiateCombatOnRequest.tag)&&game.combat.startCombat();break;case A.DEATH_SAVE:const c=await Go(a);a.length=0,a.push(...c),s=s.filter(g=>c.includes(g.actor));break;case A.HIT_DIE:const u=a.filter(g=>g.type==="character");if(u.length===0)return ie.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noCharactersForHitDie")||"Hit dice can only be rolled for player characters, not NPCs."),null;a.length=0,a.push(...u),s=s.filter(g=>g.actor.type==="character");break}return t}static async handleInitiativeRoll(e,t,o){var u,g;if(!await ao())return{success:!1};const a=[],i=[];for(const f of e){const p=Y(f);if(!p)continue;let m=null;if(!game.actors.get(f))m=f,i.push(p.name);else{if(m=((g=(u=p.getActiveTokens())==null?void 0:u[0])==null?void 0:g.id)||null,!m){a.push(p.name);continue}i.push(p.name),game.combat.combatants.find(y=>y.tokenId===m)||await game.combat.createEmbeddedDocuments("Combatant",[{actorId:p.id,tokenId:m}])}}if(i.length===0)return{success:!1};a.length>0&&I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorsSkippedInitiative",{actors:a.join(", ")})||`Initiative skipped for actors without tokens: ${a.join(", ")}`);const n=t.filter(f=>{var m;return f.tokenId?!0:!!((m=f.actor.getActiveTokens())==null?void 0:m[0])});t.length=0,t.push(...n),o=n.map(f=>f.actor);const r=[...new Set(o.map(f=>f.id))],l=await io(r,game);if(!l.length)return{success:!1};const c=t.filter(f=>f&&f.actor&&l.includes(f.actor.id));return o.length=0,o.push(...l.map(f=>game.actors.get(f)).filter(f=>f)),t.length=0,t.push(...c),{success:!0}}static async sendRollRequestToPlayer(e,t,o,s,a,i=!1,n=null){var f;const r=C();let l=o==null?void 0:o.toLowerCase();if(l===A.ABILITY_CHECK?l=A.ABILITY:l===A.SAVING_THROW?l=A.SAVE:l===A.INITIATIVE_DIALOG&&(l=A.INITIATIVE),l===A.HIT_DIE&&(s=e.system.attributes.hd.largestAvailable,!s)){d.warn(`No hit dice available for ${e.name}.`);return}const c={...a};delete c.subject,delete c.workflow,delete c.item,delete c.activity;const u=_.get(r.publicPlayerRolls.tag)===!0;_.get(r.groupRollsMsgEnabled.tag),u&&(c.rollMode=CONST.DICE_ROLL_MODES.PUBLIC);const g={type:"rollRequest",groupRollId:n,actorId:e.isToken?e.token.id:e.id,isTokenActor:e.isToken,baseActorId:e.isToken?(f=e._actor)==null?void 0:f.id:e.id,rollType:l,rollKey:s,activityId:null,rollProcessConfig:{...c,_requestedBy:game.user.name},skipRollDialog:a.skipRollDialog||!1,targetTokenIds:Array.from(game.user.targets).map(p=>p.id),preserveTargets:_.get(r.useGMTargetTokens.tag)};d.log("RollMenuOrchestrator.sendRollRequestToPlayer - sending request",{actor:e.name,owner:t.name,groupRollId:g.groupRollId}),ge.execForUser("handleRollRequest",t.id,g),i||ie.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:t.name,actor:e.name}))}static showConsolidatedNotification(e,t,o){var i,n,r,l,c;const s={};for(const{actor:u,owner:g}of e)s[g.id]||(s[g.id]={player:g,actors:[]}),s[g.id].actors.push(u);let a=game.i18n.localize(`FLASH_ROLLS.rollTypes.${t}`)||t;if(o){const u=t.toLowerCase();if(u===A.SKILL)a=`${a} (${((i=CONFIG.DND5E.skills[o])==null?void 0:i.label)||o})`;else if(u===A.SAVING_THROW)a=`${a} (${((n=CONFIG.DND5E.abilities[o])==null?void 0:n.label)||o})`;else if(u===A.ABILITY_CHECK)a=`${a} (${((r=CONFIG.DND5E.abilities[o])==null?void 0:r.label)||o})`;else if(u===A.TOOL){const g=(c=(l=CONFIG.DND5E.enrichmentLookup)==null?void 0:l.tools)==null?void 0:c[o];if(g!=null&&g.id){const f=dnd5e.documents.Trait.getBaseItem(g.id,{indexOnly:!0});a=`${a} (${(f==null?void 0:f.name)||o})`}else a=`${a} (${o})`}else u===A.CUSTOM&&(a=`${a}: ${o}`)}ie.notifyRollRequestsSent(s,a)}}class At{static addSidebarControls(e,t){if(d.log("addSidebarControls",[e,t]),!game.user.isGM||!e||e.id!=="sidebar")return;const o=document.querySelector("#roll-privacy");if(!o||o.querySelector(".flash-rolls-icon"))return;const s=C(),a=_.get(s.rollRequestsEnabled.tag),i=document.createElement("button");i.id="flash-rolls-icon",i.setAttribute("data-tooltip-direction","RIGHT"),i.className=`ui-control icon chat-control-icon flash-rolls-icon${a?" active":""}`,i.title=game.i18n.localize("FLASH_ROLLS.ui.menus.rollRequestsTitle"),i.innerHTML=`<i class="fas fa-bolt${a?"":"-slash"}"></i>`;const n=o.firstChild;n?n.parentNode.insertBefore(i,n):o.insertBefore(i,o.firstChild),d.log("addSidebarControls",[n,i]),i.addEventListener("click",r=>{r.stopPropagation(),r.preventDefault(),x.toggle()})}static updateRollRequestsIcon(e){const t=document.querySelector("#flash-rolls-icon i");t&&(t.className=`fas fa-bolt${e?"":"-slash"}`)}}class Wt{static getActorStats(e){var a,i,n,r,l,c;const t=e.system,o=[];(a=t.attributes)!=null&&a.hp&&o.push({abbrev:"HP",value:t.attributes.hp.value}),(i=t.attributes)!=null&&i.ac&&o.push({abbrev:"AC",value:t.attributes.ac.value});const s=(r=(n=t.attributes)==null?void 0:n.spell)==null?void 0:r.dc;return s&&o.push({abbrev:"DC",value:s}),(c=(l=t.skills)==null?void 0:l.prc)!=null&&c.passive&&o.push({abbrev:"PRC",value:t.skills.prc.passive}),o}static getActorHPData(e){var a;const t=(a=e.system.attributes)==null?void 0:a.hp;if(!t||!t.max)return{hpPercent:100,hpColor:"var(--fr5e-color-hp-high)"};const o=Math.round(t.value/t.max*100),s=o>50?"var(--fr5e-color-hp-high)":"var(--fr5e-color-hp-low)";return{hpPercent:o,hpColor:s}}static getValidActorIds(e,t){return e.filter(o=>{const s=game.actors.get(o);if(!s)return!1;const a=Pt(s),i=!a&&to(s);return t==="pc"&&a||t==="npc"&&i})}}class Le{static initializeDrag(e){const t=e.element.querySelector(this.DRAG_HANDLE_SELECTOR);if(!t){d.error("RollMenuDragManager.initializeDrag - No drag handle found!");return}t.addEventListener("mousedown",o=>{this.handleDragStart(o,e)})}static async handleDragStart(e,t){var p;const o=C();if(_.get(o.lockMenuPosition.tag)&&t.isLocked){e.preventDefault(),e.stopPropagation();return}if(e.preventDefault(),e.stopPropagation(),t.isDragging=!0,!t.element)return;t.element.classList.add("dragging");const a=e.clientX,i=e.clientY;t.element.classList.contains("docked-bottom");const n=((p=t.element.parentElement)==null?void 0:p.id)==="ui-bottom";t.element.classList.remove("docked-right","docked-bottom","faded-ui"),t.element.offsetHeight;const r=t.element.getBoundingClientRect();let l=r.left,c=i;if(n){const m=t.element.querySelector(this.DRAG_HANDLE_SELECTOR);if(m){const k=m.getBoundingClientRect(),y=k.left-r.left+k.width/2;l=a-y}else l=a-r.width/2;c=i}t.element.parentElement,document.body.appendChild(t.element),t.element.style.position="fixed",t.element.style.inset="",t.element.style.transform="",t.element.style.top=`${c}px`,t.element.style.left=`${l}px`,t.element.style.right="auto",t.element.style.bottom="auto",t.element.style.zIndex="var(--z-index-app)",t.element.offsetHeight;const u={startX:a,startY:i,initialLeft:l,initialTop:c,currentLeft:l,currentTop:c},g=m=>this.handleDragMove(m,t,u),f=m=>this.handleDragEnd(m,t,u,g,f);document.addEventListener("mousemove",g),document.addEventListener("mouseup",f)}static handleDragMove(e,t,o){if(!t.isDragging||!t.element)return;const s=e.clientX-o.startX,a=e.clientY-o.startY;o.currentLeft=o.initialLeft+s,o.currentTop=o.initialTop+a,t.element.style.inset="",t.element.style.right="auto",t.element.style.bottom="auto",t.element.style.position="fixed",t.element.style.top=`${o.currentTop}px`,t.element.style.left=`${o.currentLeft}px`;const i=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;o.currentLeft<i?t.element.classList.add("left-edge"):t.element.classList.remove("left-edge"),t.element.hasAttribute("data-layout")&&t.element.getAttribute("data-layout")==="horizontal"&&o.currentTop<400?t.element.classList.add("top-edge"):t.element.classList.remove("top-edge"),window.getComputedStyle(t.element);const r=this.calculateSnapDistance(t);(t.element.classList.contains("near-snap-both")?"both-edges":t.element.classList.contains("near-snap-right")?"right-edge":t.element.classList.contains("near-snap-bottom")?"bottom-edge":"none")!==r.type&&(t.element.classList.remove("near-snap","near-snap-right","near-snap-bottom","near-snap-both"),r.type==="both-edges"?t.element.classList.add("near-snap","near-snap-both"):r.type==="right-edge"?t.element.classList.add("near-snap","near-snap-right"):r.type==="bottom-edge"&&t.element.classList.add("near-snap","near-snap-bottom"))}static async handleDragEnd(e,t,o,s,a){if(d.log("RollMenuDragManager.handleDragEnd"),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a),!(t!=null&&t.element)){d.error("RollMenuDragManager.handleDragEnd - Menu element is null");return}t.isDragging=!1,t.element.classList.remove("dragging"),t.element.classList.remove("near-snap","near-snap-right","near-snap-bottom","near-snap-both"),t.element.style.zIndex="";const i=this.calculateSnapDistance(t);if(i.type==="both-edges"){const n=document.querySelector("#chat-notifications");n&&t.element&&n.insertBefore(t.element,n.firstChild),await this.snapToDefault(t)}else if(i.type==="bottom-edge")await this.snapToBottomEdge(t);else if(i.type==="right-edge"){const n=document.querySelector("#chat-notifications");n&&t.element&&n.insertBefore(t.element,n.firstChild),await this.snapToRightEdge(t,o.currentTop)}else{t.isCustomPosition=!0,t.customPosition={x:o.currentLeft,y:o.currentTop,isCustom:!0,dockedRight:!1,dockedBottom:!1};const n=!!document.querySelector("body.crlngn-tabs");q.addCSSVars("--flash-rolls-menu-offset",n?"0px":"16px"),await this.saveCustomPosition(t.customPosition),t.element.classList.add("custom-position");const r=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;o.currentLeft<r&&t.element.classList.add("left-edge"),t.element.hasAttribute("data-layout")&&t.element.getAttribute("data-layout")==="horizontal"&&o.currentTop<400&&t.element.classList.add("top-edge")}}static calculateSnapDistance(e){if(!(e!=null&&e.element))return d.error("RollMenuDragManager.calculateSnapDistance - Menu element is null"),{type:"none",distance:1/0};const t=document.querySelector(this.LIGHTNING_BOLT_SELECTOR),o=document.querySelector("#hotbar");if(!t&&!o)return{type:"none",distance:1/0};const s=e.element.getBoundingClientRect();if(o){const a=o.getBoundingClientRect(),i=Math.abs(a.top-s.bottom),n=s.left,r=s.right,l=a.left,c=a.right;if(n<c&&r>l&&i<=this.SNAP_DISTANCE)return{type:"bottom-edge",distance:0}}if(t){const a=t.getBoundingClientRect(),i=Math.abs(a.left-s.right),n=window.innerHeight-s.bottom;if(i<=this.SNAP_DISTANCE)return n<=this.SNAP_DISTANCE?{type:"both-edges",distance:0}:{type:"right-edge",distance:0}}return{type:"none",distance:1/0}}static async snapToRightEdge(e,t){if(d.log("RollMenuDragManager.snapToRightEdge",[t]),!(e!=null&&e.element)){d.error("RollMenuDragManager.snapToRightEdge - Menu element is null");return}e.isCustomPosition=!0,e.customPosition={y:t,isCustom:!0,dockedRight:!0},e.element.classList.remove("custom-position","left-edge","top-edge","docked-bottom","faded-ui","offset"),e.element.classList.add("docked-right","snapping"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t<400?e.element.classList.add("top-edge"):e.element.classList.remove("top-edge"),e.element.style.position="fixed",e.element.style.inset="",e.element.style.left="",e.element.style.right="",e.element.style.bottom="",e.element.style.top=`${t}px`,e.element.style.zIndex="",Ue(),await this.saveCustomPosition(e.customPosition),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static async snapToBottomEdge(e){if(d.log("RollMenuDragManager.snapToBottomEdge"),!(e!=null&&e.element)){d.error("RollMenuDragManager.snapToBottomEdge - Menu element is null");return}e.isCustomPosition=!0,e.customPosition={isCustom:!0,dockedBottom:!0},e.element.classList.remove("custom-position","left-edge","top-edge","docked-right","offset"),e.element.classList.add("docked-bottom","snapping");const t=document.querySelector("#ui-bottom");t&&e.element&&!t.contains(e.element)&&t.prepend(e.element);const o=document.querySelector("#ui-bottom #hotbar");o&&o.classList.contains("faded-ui")&&e.element.classList.add("faded-ui"),this.syncOffsetClass(e),Ue(),await this.saveCustomPosition(e.customPosition),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static syncOffsetClass(e){const t=document.querySelector("#hotbar");if(t&&t.classList.contains("offset")){e.element.classList.add("offset");const o=t.style.getPropertyValue("--offset");o&&e.element.style.setProperty("--offset",o)}else e.element.classList.remove("offset"),e.element.style.removeProperty("--offset")}static syncFadedUIClass(e){if(!e.element.classList.contains("docked-bottom")){e.element.classList.remove("faded-ui");return}const t=document.querySelector("#ui-bottom #hotbar");t&&t.classList.contains("faded-ui")?e.element.classList.add("faded-ui"):e.element.classList.remove("faded-ui")}static async snapToDefault(e){if(d.log("RollMenuDragManager.snapToDefault"),!(e!=null&&e.element)){d.error("RollMenuDragManager.snapToDefault - Menu element is null");return}e.isCustomPosition=!1,e.customPosition=null;const t=C();_.get(t.menuLayout.tag),e.element.classList.remove("custom-position","left-edge","top-edge","docked-bottom","docked-right","faded-ui","offset"),e.element.classList.add("snapping"),e.element.style.position="",e.element.style.inset="",e.element.style.left="",e.element.style.top="",e.element.style.right="",e.element.style.bottom="",e.element.style.zIndex="",e.element.style.removeProperty("--offset"),Ue(),await this.saveCustomPosition(null),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static applyCustomPosition(e,t){if(!t||!t.isCustom||!(e!=null&&e.element))return;const o=e.element.getBoundingClientRect();if(d.log("RollMenuDragManager.applyCustomPosition",[t]),t.x<0?t.x=0:t.x>window.innerWidth-o.width&&(t.x=window.innerWidth-o.width),t.y<0?t.y=0:t.y>window.innerHeight-o.height&&(t.y=window.innerHeight-o.height),e.isCustomPosition=!0,e.customPosition=t,t.dockedRight){const s=document.querySelector("#chat-notifications");s&&s.insertBefore(e.element,s.firstChild),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${t.y}px`,e.element.style.left="",e.element.style.right="",e.element.style.bottom="",e.element.classList.add("docked-right"),e.element.classList.remove("custom-position","left-edge","faded-ui","offset"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t.y<400?e.element.classList.add("top-edge"):e.element.classList.remove("top-edge"),Ue()}else if(t.dockedBottom){const s=document.querySelector("#ui-bottom");s&&!s.contains(e.element)&&s.prepend(e.element),e.element.classList.add("docked-bottom"),e.element.classList.remove("custom-position","left-edge","top-edge","docked-right","faded-ui","offset");const a=document.querySelector("#ui-bottom #hotbar");a&&a.classList.contains("faded-ui")&&e.element.classList.add("faded-ui"),this.syncOffsetClass(e),Ue()}else{document.body.appendChild(e.element),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${t.y}px`,e.element.style.left=`${t.x}px`,e.element.style.right="auto",e.element.style.bottom="auto";const s=!!document.querySelector("body.crlngn-tabs");q.addCSSVars("--flash-rolls-menu-offset",s?"0px":"16px"),e.element.classList.add("custom-position"),e.element.classList.remove("docked-right","faded-ui","offset");const a=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;t.x<a&&e.element.classList.add("left-edge"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t.y<400&&e.element.classList.add("top-edge")}}static async saveCustomPosition(e){if(!e){await game.user.setFlag(W.ID,"menuCustomPosition",null);return}const t=document.querySelector(".flash-rolls-menu");if(t){const o=t.getBoundingClientRect();e.x<0?e.x=0:e.x>window.innerWidth-o.width&&(e.x=window.innerWidth-o.width),e.y<0?e.y=0:e.y>window.innerHeight-o.height&&(e.y=window.innerHeight-o.height)}await game.user.setFlag(W.ID,"menuCustomPosition",e)}static loadCustomPosition(){return game.user.getFlag(W.ID,"menuCustomPosition")||null}static async resetPosition(e){await this.snapToDefault(e)}}D(Le,"SNAP_DISTANCE",50),D(Le,"DRAG_HANDLE_SELECTOR",".drag-handle"),D(Le,"LIGHTNING_BOLT_SELECTOR","#flash-rolls-icon");class ae{static isFavorite(e){try{const t=typeof e=="string"?game.actors.get(e):e;return!t||!t.getFlag?!1:t.getFlag(R,this.FLAGS.FAVORITE)===!0}catch(t){return d.error("Error checking favorite status",[t,e]),!1}}static isBlocked(e){const t=typeof e=="string"?game.actors.get(e):e;return t?t.getFlag(R,this.FLAGS.BLOCKED)===!0:!1}static async setFavorite(e,t){const o=typeof e=="string"?game.actors.get(e):e;if(!o){d.error("Actor not found",[e]);return}d.log("ActorStatusManager.setFavorite",[o.name,t]),t?(await o.setFlag(R,this.FLAGS.FAVORITE,!0),await o.unsetFlag(R,this.FLAGS.BLOCKED)):await o.unsetFlag(R,this.FLAGS.FAVORITE),this._refreshMenu()}static async setBlocked(e,t){const o=typeof e=="string"?game.actors.get(e):e;if(!o){d.error("Actor not found",[e]);return}t?(await o.setFlag(R,this.FLAGS.BLOCKED,!0),await o.unsetFlag(R,this.FLAGS.FAVORITE)):await o.unsetFlag(R,this.FLAGS.BLOCKED),this._refreshMenu()}static async toggleFavorite(e,t){const o=t?!0:!this.isFavorite(e);await this.setFavorite(e,o)}static async toggleBlocked(e,t){const o=t?!0:!this.isBlocked(e);await this.setBlocked(e,o)}static async blockActor(e){await this.setBlocked(e,!0)}static getFavoriteActors(){return game.actors.filter(e=>this.isFavorite(e))}static getBlockedActors(){return game.actors.filter(e=>this.isBlocked(e))}static filterBlocked(e){return e.filter(t=>!this.isBlocked(t))}static getActorStatus(e){return{isFavorite:this.isFavorite(e),isBlocked:this.isBlocked(e)}}static async clearActorStatus(e){const t=typeof e=="string"?game.actors.get(e):e;t&&(await t.unsetFlag(R,this.FLAGS.FAVORITE),await t.unsetFlag(R,this.FLAGS.BLOCKED),this._refreshMenu())}static _refreshMenu(){x.refreshIfOpen()}static getContextMenuOptions(e,t){return game.user.isGM&&(t.push({name:"FLASH_ROLLS.contextMenu.toggleFavorite",icon:'<i class="fas fa-bolt"></i>',callback:o=>{const s=o.data("documentId")||o.dataset.entryId;s&&this.toggleFavorite(s)},condition:o=>game.user.isGM}),t.push({name:"FLASH_ROLLS.contextMenu.toggleBlocked",icon:'<i class="fas fa-ban"></i>',callback:o=>{const s=o.data("documentId")||o.dataset.entryId;s&&this.toggleBlocked(s)},condition:o=>game.user.isGM})),t}}D(ae,"FLAGS",{FAVORITE:"isFavorite",BLOCKED:"isBlocked"});class $o{static initializeActorDrag(e){e.element.querySelectorAll('.actor-list .actor.drag-wrapper[draggable="true"]').forEach(s=>{s.addEventListener("dragstart",a=>this.handleDragStart(a,e)),s.addEventListener("dragend",a=>this.handleDragEnd(a,e))});const o=e.element;o.addEventListener("dragover",s=>this.handleDragOver(s)),o.addEventListener("drop",s=>this.handleDrop(s,e)),document.addEventListener("dragover",s=>this.handleGlobalDragOver(s,e)),document.addEventListener("drop",s=>this.handleGlobalDrop(s,e))}static handleDragStart(e,t){const o=e.currentTarget,s=o.dataset.actorId,a=game.actors.get(s);if(!a){e.preventDefault();return}d.log("ActorDragUtil.handleDragStart",[a.name,s]),e.dataTransfer.setData("text/plain",s),e.dataTransfer.setData("application/json",JSON.stringify({actorId:s,actorName:a.name,uniqueId:o.dataset.id,tokenId:o.dataset.tokenId||null})),e.dataTransfer.effectAllowed="move",o.classList.add("dragging");const i=o.getBoundingClientRect(),n=document.createElement("div");n.style.width=i.width+"px",n.style.height=i.height+"px",n.style.backgroundColor="rgba(0, 0, 0, 0.1)",n.style.border="2px dashed rgba(255, 255, 255, 0.3)",n.style.borderRadius="4px",n.style.opacity="0.6",n.style.position="absolute",n.style.top="-1000px",n.style.left="-1000px",n.style.pointerEvents="none",document.body.appendChild(n),e.dataTransfer.setDragImage(n,i.width/2,i.height/2),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},0),t._currentDragData={actorId:s,actorElement:o,startTime:Date.now()}}static createGroupDragImage(e,t){const o=document.createElement("div");o.className="actor actor-group drag-wrapper",o.style.background=getComputedStyle(e).background,o.style.border=getComputedStyle(e).border,o.style.borderRadius=getComputedStyle(e).borderRadius,o.style.padding=getComputedStyle(e).padding;const s=e.querySelector(".actor-img");if(s){const i=s.cloneNode(!0);o.appendChild(i)}const a=document.createElement("div");return a.className="actor-name",a.textContent=t.name,a.style.color=getComputedStyle(e.querySelector(".actor-name")||e).color,a.style.fontSize=getComputedStyle(e.querySelector(".actor-name")||e).fontSize,a.style.fontWeight="bold",a.style.textAlign="center",a.style.marginTop="4px",o.appendChild(a),o}static createStandardDragImage(e){const t=document.createElement("div");t.className=e.className,t.style.background=getComputedStyle(e).background,t.style.border=getComputedStyle(e).border,t.style.borderRadius=getComputedStyle(e).borderRadius,t.style.padding=getComputedStyle(e).padding,t.style.display="flex",t.style.alignItems="center",t.style.gap="8px";const o=e.querySelector(".actor-img");if(o){const a=o.cloneNode(!0);t.appendChild(a)}const s=e.querySelector(".actor-name");if(s){const a=s.cloneNode(!0);t.appendChild(a)}return t}static handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="none"}static handleDrop(e,t){e.preventDefault(),d.log("ActorDragUtil.handleDrop - dropped within menu, canceling remove"),this.cleanupDrag(t)}static handleGlobalDragOver(e,t){if(!t._currentDragData)return;const o=t.element,s=document.elementFromPoint(e.clientX,e.clientY);o&&(o.contains(s)||o===s)?(e.dataTransfer.dropEffect="none",t._currentDragData.actorElement&&t._currentDragData.actorElement.classList.remove("drag-remove-zone")):(e.preventDefault(),e.dataTransfer.dropEffect="move",t._currentDragData.actorElement&&t._currentDragData.actorElement.classList.add("drag-remove-zone"))}static handleGlobalDrop(e,t){if(!t._currentDragData)return;const o=t.element,s=document.elementFromPoint(e.clientX,e.clientY);if(!(o&&(o.contains(s)||o===s))){e.preventDefault();const i=JSON.parse(e.dataTransfer.getData("application/json"));d.log("ActorDragUtil.handleGlobalDrop - blocking actor",[i.actorName]),this.blockActor(i.actorId,t)}this.cleanupDrag(t)}static handleDragEnd(e,t){d.log("ActorDragUtil.handleDragEnd"),setTimeout(()=>{this.cleanupDrag(t)},100)}static async blockActor(e,t){try{await ae.blockActor(e);const o=t.element.querySelector(`[data-actor-id="${e}"]`);if(o){const s=o.dataset.id;t.selectedActors.delete(s)}}catch(o){d.error("Error blocking actor",[o]),ui.notifications.error(`Failed to block actor: ${o.message}`)}}static cleanupDrag(e){var t;(t=e._currentDragData)!=null&&t.actorElement&&e._currentDragData.actorElement.classList.remove("dragging","drag-remove-zone"),e._currentDragData=null}static removeDragListeners(e){document.removeEventListener("dragover",this.handleGlobalDragOver),document.removeEventListener("drop",this.handleGlobalDrop)}}class ot{static canDrop(e){return d.log("ActorDropUtil.canDrop",[e]),game.user.isGM}static handleDragOver(e,t){d.log("ActorDropUtil.handleDragOver",[e,e.currentTarget,e.target]),e.preventDefault(),e.stopPropagation(),e.dataTransfer&&(e.dataTransfer.dropEffect="copy",d.log("ActorDropUtil.handleDragOver - dataTransfer types:",[e.dataTransfer.types]));const o=e.currentTarget.closest(".actor-list, .actors");return o&&(o.classList.add("drag-over"),d.log("ActorDropUtil.handleDragOver - added drag-over class")),!1}static handleDragLeave(e){if(d.log("ActorDropUtil.handleDragLeave",[e,e.currentTarget,e.target]),!e.currentTarget||typeof e.currentTarget.getBoundingClientRect!="function"){document.querySelectorAll(".drag-over").forEach(a=>{a.classList.remove("drag-over")}),d.log("ActorDropUtil.handleDragLeave - removed drag-over class from all elements (global cleanup)");return}const t=e.currentTarget.getBoundingClientRect();if(e.clientX<t.left||e.clientX>t.right||e.clientY<t.top||e.clientY>t.bottom){const s=e.currentTarget.closest(".actor-list, .actors");s&&(s.classList.remove("drag-over"),d.log("ActorDropUtil.handleDragLeave - removed drag-over class"))}}static async handleDrop(e,t){e.preventDefault(),e.stopPropagation();for(let s=0;s<e.dataTransfer.types.length;s++){const a=e.dataTransfer.types[s],i=e.dataTransfer.getData(a);d.log(`ActorDropUtil.handleDrop - ${a}:`,[i])}t.element.querySelectorAll(".drag-over").forEach(s=>{s.classList.remove("drag-over")}),d.log("ActorDropUtil.handleDrop - removed drag-over class from all elements");try{const s=this.parseDragData(e);if(!s||s.type!=="Actor"){d.log("ActorDropUtil.handleDrop - Invalid drag data",[s]);return}const a=await this.getActorFromDragData(s);if(!a){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.actorNotFound")||"Actor not found");return}const n=Pt(a)?"pc":"npc";t.currentTab!==n&&(t.currentTab=n),await this.addActorToMenu(a,t)}catch(s){d.error("ActorDropUtil.handleDrop - Error processing drop",[s]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.dropError")||"Error adding actor to menu")}}static parseDragData(e){try{const t=e.dataTransfer.getData("application/json");if(t)return JSON.parse(t);const o=e.dataTransfer.getData("text/plain");if(o){if(o.startsWith("Actor."))return{type:"Actor",uuid:o};try{return JSON.parse(o)}catch{d.log("ActorDropUtil.parseDragData - Text is not JSON")}}return null}catch(t){return d.error("ActorDropUtil.parseDragData - Error parsing drag data",[t]),null}}static async getActorFromDragData(e){try{return e.uuid?await fromUuid(e.uuid):e.id?game.actors.get(e.id):null}catch(t){return d.error("ActorDropUtil.getActorFromDragData - Error getting actor",[t]),null}}static async addActorToMenu(e,t){const o=ae.isBlocked(e);if(ae.isFavorite(e)&&!o){I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorAlreadyAdded",{actor:e.name})||`${e.name} is already in the menu`);return}await ae.setFavorite(e,!0)}}const Vo="modulepreload",jo=function(h){return"/modules/flash-rolls-5e/"+h},Kt={},ht=function(e,t,o){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),n=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));s=Promise.allSettled(t.map(r=>{if(r=jo(r),r in Kt)return;Kt[r]=!0;const l=r.endsWith(".css"),c=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${r}"]${c}`))return;const u=document.createElement("link");if(u.rel=l?"stylesheet":Vo,l||(u.as="script"),u.crossOrigin="",u.href=r,n&&u.setAttribute("nonce",n),document.head.appendChild(u),l)return new Promise((g,f)=>{u.addEventListener("load",g),u.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${r}`)))})}))}function a(i){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=i,window.dispatchEvent(n),!n.defaultPrevented)throw i}return s.then(i=>{for(const n of i||[])n.status==="rejected"&&a(n.reason);return e().catch(a)})};class Te{static async toggleMovementForSelected(e){if(e.selectedActors.size===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const t=[];for(const i of e.selectedActors){const n=Y(i);if(!n){d.log(`TokenMovementManager: No actor found for uniqueId: ${i}`);continue}const r=this.getTokensForActor(n.id,i);d.log(`TokenMovementManager: Found ${r.length} tokens for actor ${n.name} (${n.id})`),t.push(...r)}if(t.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensForMovementLock"));return}const o=this.getMovementStatus(t),s=o.restricted<o.unrestricted;d.log(`TokenMovementManager: Before toggle - ${o.restricted} restricted, ${o.unrestricted} unrestricted, shouldLock: ${s}`),await this.setMovementRestriction(t,s),x.refreshIfOpen();const a=s?"movementLocked":"movementUnlocked";I.notify("info",game.i18n.format(`FLASH_ROLLS.notifications.${a}`,{count:t.length})),d.log(`TokenMovementManager: ${s?"Locked":"Unlocked"} movement for ${t.length} tokens`)}static async _setMovementForSelected(e,t){if(e.selectedActors.size===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const o=[];for(const a of e.selectedActors){const i=Y(a);if(!i)continue;const n=this.getTokensForActor(i.id,a);o.push(...n)}if(o.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensForMovementLock"));return}await this.setMovementRestriction(o,t);const s=t?"movementLocked":"movementUnlocked";I.notify("info",game.i18n.format(`FLASH_ROLLS.notifications.${s}`,{count:o.length})),d.log(`TokenMovementManager: ${t?"Locked":"Unlocked"} movement for ${o.length} tokens`)}static getTokensForActor(e,t){const o=[],s=game.scenes.current;if(!s)return o;if(t!==e){const a=s.tokens.get(t);a&&a.actorId===e&&o.push(a)}else{const a=s.tokens.filter(i=>i.actorId===e);o.push(...a)}return o}static async setMovementRestriction(e,t){const o=e.map(s=>{let a;if(t){const i={type:"manual",enabled:!0,source:"gm",metadata:{restrictedAt:Date.now(),restrictedBy:game.user.id}};a={_id:s.id,flags:{[R]:{movementRestriction:i}}}}else a={_id:s.id,[`flags.${R}.-=movementRestriction`]:null};return a});if(o.length>0)try{d.log(`TokenMovementManager: Updating ${o.length} tokens with updates:`,o),await game.scenes.current.updateEmbeddedDocuments("Token",o),d.log(`TokenMovementManager: Successfully updated ${o.length} tokens with movement restriction: ${t}`);for(const s of o){const a=game.scenes.current.tokens.get(s._id);if(a){const i=a.getFlag(R,"movementRestriction");d.log(`TokenMovementManager: After update, token ${a.name} restriction is:`,i)}}}catch(s){d.error("TokenMovementManager: Failed to update token movement restrictions",[s]),ui.notifications.error("Failed to update token movement restrictions")}}static isMovementRestricted(e){const t=e.getFlag(R,"movementRestriction");return(t==null?void 0:t.enabled)===!0}static isMovementAllowed(e,t,o){if(t.isGM||!(o.x!==void 0||o.y!==void 0))return!0;const a=e.getFlag(R,"movementRestriction");return a!=null&&a.enabled?(d.log(`TokenMovementManager: Movement blocked for token ${e.name} by user ${t.name}`),!1):!0}static getMovementStatus(e){let t=0,o=0;return e.forEach(s=>{this.isMovementRestricted(s)?t++:o++}),{restricted:t,unrestricted:o,total:e.length,hasRestricted:t>0,hasUnrestricted:o>0,allRestricted:t===e.length,allUnrestricted:o===e.length}}static getStatusIcon(e){return e.allRestricted?"fa-user-lock":e.allUnrestricted?"fa-person-walking":"fa-user-slash"}static async clearAllRestrictions(e){await this.setMovementRestriction(e,!1)}static async onCombatStart(e,t){var n;const o=C();if(!_.get((n=o.autoBlockMovementInCombat)==null?void 0:n.tag))return;d.log("TokenMovementManager: Combat started, applying movement restrictions");const a=e.combatant,i=[];for(const r of e.combatants){if(r.id===(a==null?void 0:a.id))continue;const l=r.token;l&&i.push(l)}i.length>0&&(await this.setCombatMovementRestriction(i,!0),d.log(`TokenMovementManager: Blocked movement for ${i.length} combatants`))}static async onCombatTurnChange(e,t,o){var n;const s=C();if(!_.get((n=s.autoBlockMovementInCombat)==null?void 0:n.tag))return;d.log("TokenMovementManager: Combat turn changed",[e,t,o]);const i=e.combatant;d.log("TokenMovementManager: Current combatant",[i]);for(const r of e.combatants){const l=r.token;if(!l)continue;const c=r.tokenId===(i==null?void 0:i.tokenId),u=!c;d.log(`TokenMovementManager: ${r.name} - isCurrentTurn: ${c}, shouldRestrict: ${u}`,[r]),await this.setCombatMovementRestriction([l],u)}d.log("TokenMovementManager: Updated movement restrictions for all combatants")}static async onCombatEnd(e){d.log("TokenMovementManager: Combat ended, removing movement restrictions");const t=[];for(const o of e.combatants){const s=o.token;if(s){const a=s.getFlag(R,"movementRestriction");(a==null?void 0:a.type)==="combat"&&t.push(s)}}t.length>0&&(await this.setCombatMovementRestriction(t,!1),d.log(`TokenMovementManager: Unblocked movement for ${t.length} combatants`))}static async setCombatMovementRestriction(e,t){const o=e.map(s=>{var i;let a;if(t){const n={type:"combat",enabled:!0,source:"system",metadata:{restrictedAt:Date.now(),combatId:(i=game.combat)==null?void 0:i.id}};a={_id:s.id,flags:{[R]:{movementRestriction:n}}}}else{const n=s.getFlag(R,"movementRestriction");if((n==null?void 0:n.type)==="combat")a={_id:s.id,[`flags.${R}.-=movementRestriction`]:null};else return null}return a}).filter(s=>s!==null);if(o.length>0)try{await game.scenes.current.updateEmbeddedDocuments("Token",o),d.log(`TokenMovementManager: Updated ${o.length} tokens with combat movement restriction: ${t}`)}catch(s){d.error("TokenMovementManager: Failed to update combat movement restrictions",[s])}}static async onCreateCombatant(e,t,o){var l;const s=C();if(!_.get((l=s.autoBlockMovementInCombat)==null?void 0:l.tag))return;const i=e.combat;if(!(i!=null&&i.started))return;const n=e.token;if(!n)return;const r=i.combatant;if(e.id===(r==null?void 0:r.id)){d.log(`TokenMovementManager: New combatant ${e.name} is current turn, allowing movement`);return}d.log(`TokenMovementManager: Blocking movement for newly added combatant ${e.name}`),await this.setCombatMovementRestriction([n],!0)}static async initializeCombatMovementRestrictions(){var a;const e=C();if(!_.get((a=e.autoBlockMovementInCombat)==null?void 0:a.tag))return;const o=game.combat;if(!(o!=null&&o.started))return;d.log("TokenMovementManager: Initializing movement restrictions for active combat");const s=o.combatant;d.log("TokenMovementManager: Current combatant on init",[s]);for(const i of o.combatants){const n=i.token;if(!n)continue;const r=i.id===(s==null?void 0:s.id),l=!r;d.log(`TokenMovementManager: Init - ${i.name} - isCurrentTurn: ${r}, shouldRestrict: ${l}`),await this.setCombatMovementRestriction([n],l)}d.log("TokenMovementManager: Initialized movement restrictions for active combat")}}class Pe{static mergeWithDefaultLayout(e,t){if(!e)return t;const o={};for(const s of["moduleActions","actorActions"]){const a=e[s]||[],i=t[s]||[],n=new Set(a.map(c=>c.id)),r=[...a];let l=a.length>0?Math.max(...a.map(c=>c.order)):-1;for(const c of i)n.has(c.id)||(l++,r.push({...c,enabled:!0,order:l}));r.sort((c,u)=>c.order-u.order),o[s]=r.map((c,u)=>({...c,order:u}))}return o}static getIconLayout(){const e=C(),t=_.get(e.menuIconsLayout.tag),o=yt();return this.mergeWithDefaultLayout(t,o)}static initializeDragAndDrop(e){e.querySelectorAll(".sortable-icon-list").forEach(s=>{this.setupListEventListeners(s)}),e.querySelectorAll(".icon-toggle").forEach(s=>{s.addEventListener("change",this.handleIconToggle.bind(this))})}static setupListEventListeners(e){e.addEventListener("dragover",this.handleDragOver.bind(this)),e.addEventListener("drop",this.handleDrop.bind(this)),e.addEventListener("dragenter",this.handleDragEnter.bind(this)),e.addEventListener("dragleave",this.handleDragLeave.bind(this)),e.querySelectorAll(".icon-item").forEach(o=>{o.addEventListener("dragstart",this.handleDragStart.bind(this)),o.addEventListener("dragend",this.handleDragEnd.bind(this))})}static handleDragStart(e){const t=e.target.closest(".icon-item");t&&(t.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",t.outerHTML),e.dataTransfer.setData("text/plain",JSON.stringify({iconId:t.dataset.iconId,iconType:t.closest(".sortable-icon-list").dataset.iconType,order:parseInt(t.dataset.order)})))}static handleDragEnd(e){const t=e.target.closest(".icon-item");t&&(t.classList.remove("dragging"),document.querySelectorAll(".sortable-icon-list").forEach(o=>{o.classList.remove("drag-over")}),document.querySelectorAll(".drag-placeholder").forEach(o=>{o.remove()}))}static handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.currentTarget,o=document.querySelector(".icon-item.dragging");if(!o)return;const s=o.closest(".sortable-icon-list").dataset.iconType,a=t.dataset.iconType;if(s!==a){e.dataTransfer.dropEffect="none";return}const i=this.getDragAfterElement(t,e.clientY);i==null?t.appendChild(o):t.insertBefore(o,i)}static handleDragEnter(e){e.preventDefault(),e.currentTarget.classList.add("drag-over")}static handleDragLeave(e){const t=e.currentTarget,o=t.getBoundingClientRect();(e.clientX<o.left||e.clientX>o.right||e.clientY<o.top||e.clientY>o.bottom)&&t.classList.remove("drag-over")}static handleDrop(e){e.preventDefault();const t=e.currentTarget;t.classList.remove("drag-over"),this.updateIconOrder(t)}static getDragAfterElement(e,t){return[...e.querySelectorAll(".icon-item:not(.dragging)")].reduce((s,a)=>{const i=a.getBoundingClientRect(),n=t-i.top-i.height/2;return n<0&&n>s.offset?{offset:n,element:a}:s},{offset:Number.NEGATIVE_INFINITY}).element}static handleIconToggle(e){const t=e.target,o=t.closest(".icon-item"),s=t.checked;o.dataset.enabled=s,s?o.classList.remove("disabled"):o.classList.add("disabled");const a=o.closest(".sortable-icon-list");this.updateIconOrder(a)}static async updateIconOrder(e){var r;const t=e.dataset.iconType,s=[...e.querySelectorAll(".icon-item")].map((l,c)=>({id:l.dataset.iconId,icon:this.getIconClass(l.dataset.iconId,t),enabled:l.dataset.enabled==="true",order:c})),a=C(),n={...this.getIconLayout(),[t]:s};await _.set(a.menuIconsLayout.tag,n),(r=game.flashRolls)!=null&&r.menu&&game.flashRolls.menu.render(!1)}static getIconClass(e,t){const o=mt(e,t);return o?o.icon:""}static getEnabledIcons(e){return(this.getIconLayout()[e]||[]).filter(s=>s.enabled).sort((s,a)=>s.order-a.order)}static getAllIcons(e){return(this.getIconLayout()[e]||[]).sort((s,a)=>s.order-a.order)}static getIconConfigurations(){return{moduleActions:Xt,actorActions:Qt}}static async resetToDefault(e=null){const t=C(),o=yt();if(e){const a={..._.get(t.menuIconsLayout.tag)||{},[e]:o[e]};await _.set(t.menuIconsLayout.tag,a)}else await _.set(t.menuIconsLayout.tag,o)}static async removeIcon(e,t){var r,l;const o=C(),s=this.getIconLayout();if(!s[t]){LogUtil.error("IconLayoutUtil.removeIcon - Invalid icon type:",[t]);return}if(s[t].findIndex(c=>c.id===e)===-1){LogUtil.error("IconLayoutUtil.removeIcon - Icon not found:",[e,t]);return}const i={...s,[t]:s[t].map(c=>c.id===e?{...c,enabled:!1}:c)};await _.set(o.menuIconsLayout.tag,i);const n=(l=(r=game.modules.get("flash-rolls-5e"))==null?void 0:r.api)==null?void 0:l.RollRequestsMenu;n&&n.refreshIfOpen()}}var je;class lo{static show(e,t,o,s){if(e.preventDefault(),e.stopPropagation(),this.close(),!mt(t,o)){d.error("IconContextMenu: Icon configuration not found",[t,o]);return}const i=document.createElement("div");i.className="icon-context-menu",i.style.position="fixed",i.style.left=`${e.clientX}px`,i.style.top=`${e.clientY}px`,i.style.zIndex="10000";const n=`
      <ul>
        <li class="context-menu-item" data-action="remove">
          <i class="fas fa-times"></i>
          <span>${game.i18n.localize("FLASH_ROLLS.ui.contextMenu.removeIcon")}</span>
        </li>
        <li class="context-menu-item" data-action="create-macro">
          <i class="fas fa-code"></i>
          <span>${game.i18n.localize("FLASH_ROLLS.ui.contextMenu.createMacro")}</span>
        </li>
      </ul>
    `;i.innerHTML=n,i.querySelector('[data-action="remove"]').addEventListener("click",async()=>{await this._handleRemoveIcon(t,o),this.close()}),i.querySelector('[data-action="create-macro"]').addEventListener("click",async()=>{await this._handleCreateMacro(t,o,s),this.close()}),document.body.appendChild(i),ye(this,je,i);const c=u=>{i.contains(u.target)||(this.close(),document.removeEventListener("click",c))};setTimeout(()=>{document.addEventListener("click",c)},10),this._adjustPosition(i)}static _adjustPosition(e){const t=e.getBoundingClientRect(),o=window.innerWidth,s=window.innerHeight;t.right>o&&(e.style.left=`${o-t.width-10}px`),t.bottom>s&&(e.style.top=`${s-t.height-10}px`)}static async _handleRemoveIcon(e,t){var o;try{await Pe.removeIcon(e,t),I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.iconRemoved",{iconName:game.i18n.localize(((o=mt(e,t))==null?void 0:o.labelKey)||e)}))}catch(s){d.error("Failed to remove icon",[s]),I.notify("error",game.i18n.localize("FLASH_ROLLS.notifications.iconRemoveFailed"))}}static async _handleCreateMacro(e,t,o){try{const s=C(),a=_.get(s.addMacrosToFolder.tag),i=mt(e,t);let n=Array.from((o==null?void 0:o.selectedActors)||[]);e==="place-tokens"&&(n=n.map(g=>{const f=game.actors.get(g);if(f)return f.id;const p=canvas.tokens.placeables.find(m=>m.id===g);return p!=null&&p.actor?p.actor.id:g})),e==="teleport-tokens"&&(n=n.map(g=>{const f=canvas.tokens.placeables.find(m=>m.id===g);if(f)return f.id;const p=game.actors.get(g);if(p){const m=canvas.tokens.placeables.find(k=>{var y;return((y=k.actor)==null?void 0:y.id)===p.id});if(m)return m.id}return null}).filter(g=>g!==null),n.length===0&&(n=null));let r="",l=game.i18n.localize(i.labelKey);switch(e){case"lock-menu":r=this._generateToggleMacro("toggleLockMenu","Toggle Menu Lock");break;case"toggle-requests":r=this._generateToggleMacro("toggleRollRequests","Toggle Roll Requests");break;case"skip-dialogs":r=this._generateToggleMacro("toggleSkipDialogs","Toggle Skip Dialogs");break;case"group-rolls":r=this._generateToggleMacro("toggleGroupRolls","Toggle Group Rolls");break;case"show-options":r=this._generateToggleMacro("toggleShowOptions","Toggle Show Options on Hover");break;case"open-settings":r=this._generateActionMacro("openSettings","Open Flash Rolls Settings");break;case"select-all":r=this._generateSelectAllMacro();break;case"filter-actors":r=this._generateFilterActorsMacro();break;case"toggle-targets":r=this._generateToggleTargetsMacro(n);break;case"heal-all":r=this._generateActorActionMacro("healAll","Heal All",n);break;case"kill-all":r=this._generateActorActionMacro("killAll","Kill All",n);break;case"remove-status":r=this._generateActorActionMacro("removeStatusEffects","Remove Status Effects",n);break;case"open-sheets":r=this._generateActorActionMacro("openSheets","Open Sheets",n);break;case"group-selected":r=this._generateActorActionMacro("groupSelected","Create Group",n);break;case"movement":r=this._generateActorActionMacro("toggleMovement","Toggle Movement",n);break;case"contested-roll":r=this._generateActorActionMacro("openContestedRoll","Contested Roll",n);break;case"place-tokens":r=this._generatePlaceTokensMacro(n);break;case"teleport-tokens":r=this._generateTeleportTokensMacro(n);break;case"transform":r=this._generateTransformActorsMacro(n);break;default:I.notify("warn",`No macro generation configured for icon: ${e}`);return}let c=null;a&&(c=await this._ensureFlashRollsFolder());const u=await Macro.create({name:`FTB: ${l}`,type:"script",command:r,img:"modules/flash-rolls-5e/assets/bolt-circle.svg",...c&&{folder:c},flags:{"flash-rolls-5e":{iconId:e,iconType:t}}});I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.macroCreated",{macroName:u.name})),u.sheet.render(!0)}catch(s){d.error("Failed to create macro",[s]),I.notify("error",game.i18n.localize("FLASH_ROLLS.notifications.macroCreationFailed"))}}static _generateToggleMacro(e,t){return`// Flash Token Bar: ${t}
try {
  FlashAPI.${e}();
} catch (error) {
  ui.notifications.error("Failed to execute ${t}: " + error.message);
}`}static _generateActionMacro(e,t){return`// Flash Token Bar: ${t}
try {
  FlashAPI.${e}();
} catch (error) {
  ui.notifications.error("Failed to execute ${t}: " + error.message);
}`}static _generateActorActionMacro(e,t,o){return o&&o.length>0?`// Flash Token Bar: ${t}
// Uses specific actors: ${o.join(", ")}
try {
  FlashAPI.${e}(${JSON.stringify(o)});
} catch (error) {
  ui.notifications.error("Failed to execute ${t}: " + error.message);
}`:`// Flash Token Bar: ${t}
// Uses currently selected actors
try {
  const actorIds = FlashAPI.getSelectedActors();
  if (actorIds.length === 0) {
    FlashAPI.notify('warn',"No actors selected");
  } else {
    FlashAPI.${e}(actorIds);
  }
} catch (error) {
  ui.notifications.error("Failed to execute ${t}: " + error.message);
}`}static _generateSelectAllMacro(){return`// Flash Token Bar: Toggle Select All Actors
// Toggles between selecting all and deselecting all actors
// Optional parameter - specify which tab to select from:
//   'pc'    - Player Characters tab
//   'npc'   - NPCs tab
//   'group' - Groups/Encounters tab
// Examples:
//   FlashAPI.selectAllActors();        // Toggle selection in current tab
//   FlashAPI.selectAllActors('pc');    // Switch to PC tab and toggle
//   FlashAPI.selectAllActors('npc');   // Switch to NPC tab and toggle

try {
  FlashAPI.selectAllActors();
} catch (error) {
  ui.notifications.error("Failed to execute Toggle Select All: " + error.message);
}`}static _generateFilterActorsMacro(){return`// Flash Token Bar: Filter Actors
// Available filter options (all are optional, defaults to false):
//   inCombat: true/false    - Show only actors in combat
//   visible: true/false     - Show only visible tokens
//   removeDead: true/false  - Hide dead actors (HP = 0)
//
// Examples:
//   FlashAPI.filterActors({ inCombat: true });
//   FlashAPI.filterActors({ visible: true, removeDead: true });
//   FlashAPI.filterActors();  // Opens filter dialog
//
// Toggle filters:
//   const current = FlashAPI.getActorFilters();
//   FlashAPI.filterActors({ ...current, inCombat: !current.inCombat });

try {
  // Customize the filters below or leave empty to open dialog
  FlashAPI.filterActors();
} catch (error) {
  ui.notifications.error("Failed to execute Filter Actors: " + error.message);
}`}static _generateToggleTargetsMacro(e){return e&&e.length>0?`// Flash Token Bar: Toggle Targets
// Uses specific actors: ${e.join(", ")}
try {
  FlashAPI.toggleTargets(${JSON.stringify(e)});
} catch (error) {
  ui.notifications.error("Failed to execute Toggle Targets: " + error.message);
}`:`// Flash Token Bar: Toggle Targets
// Uses currently selected actors, or clears all targets if none selected
try {
  const actorIds = FlashAPI.getSelectedActors();
  if (actorIds.length === 0 && game.user.targets.size === 0) {
    FlashAPI.notify('warn',"No actors selected and no targets to clear");
  } else {
    FlashAPI.toggleTargets(actorIds);
  }
} catch (error) {
  ui.notifications.error("Failed to execute Toggle Targets: " + error.message);
}`}static _generatePlaceTokensMacro(e){return e&&e.length>0?`// Flash Token Bar: Place Tokens
// Uses specific actors: ${e.join(", ")}
// Optional second parameter: location object {x: number, y: number}
// Examples:
//   FlashAPI.placeTokens(${JSON.stringify(e)});                    // Interactive placement
//   FlashAPI.placeTokens(${JSON.stringify(e)}, {x: 1000, y: 1000}); // Auto-place at coordinates

try {
  FlashAPI.placeTokens(${JSON.stringify(e)});
} catch (error) {
  ui.notifications.error("Failed to execute Place Tokens: " + error.message);
}`:`// Flash Token Bar: Place Tokens
// Uses currently selected actors
// Optional second parameter: location object {x: number, y: number}
// Examples:
//   FlashAPI.placeTokens(actorIds);                    // Interactive placement
//   FlashAPI.placeTokens(actorIds, {x: 1000, y: 1000}); // Auto-place at coordinates

try {
  const actorIds = FlashAPI.getSelectedActors();
  if (actorIds.length === 0) {
    FlashAPI.notify('warn',"No actors selected");
  } else {
    FlashAPI.placeTokens(actorIds);
  }
} catch (error) {
  ui.notifications.error("Failed to execute Place Tokens: " + error.message);
}`}static _generateTeleportTokensMacro(e){return e&&e.length>0?`// Flash Token Bar: Teleport Tokens
// Uses specific token IDs: ${e.join(", ")}
// Optional parameters:
//   destinationScene: Scene ID, name, or scene object
//   centerLocation: Object {x: number, y: number}
// Examples:
//   FlashAPI.teleportTokens(${JSON.stringify(e)});                                    // Interactive teleport
//   FlashAPI.teleportTokens(${JSON.stringify(e)}, 'sceneId', {x: 1000, y: 1000});     // Auto-teleport by scene ID
//   FlashAPI.teleportTokens(${JSON.stringify(e)}, 'Scene Name', {x: 1000, y: 1000});  // Auto-teleport by scene name

try {
  FlashAPI.teleportTokens(${JSON.stringify(e)});
} catch (error) {
  ui.notifications.error("Failed to execute Teleport Tokens: " + error.message);
}`:`// Flash Token Bar: Teleport Tokens
// Uses currently selected actors (converted to token IDs)
// Optional parameters:
//   destinationScene: Scene ID, name, or scene object
//   centerLocation: Object {x: number, y: number}
// Examples:
//   FlashAPI.teleportTokens(tokenIds);                                    // Interactive teleport
//   FlashAPI.teleportTokens(tokenIds, 'sceneId', {x: 1000, y: 1000});     // Auto-teleport by scene ID
//   FlashAPI.teleportTokens(tokenIds, 'Scene Name', {x: 1000, y: 1000});  // Auto-teleport by scene name

try {
  const tokenIds = FlashAPI.getSelectedActors(true);
  if (tokenIds.length === 0) {
    FlashAPI.notify('warn',"No tokens found for selected actors");
  } else {
    FlashAPI.teleportTokens(tokenIds);
  }
} catch (error) {
  ui.notifications.error("Failed to execute Teleport Tokens: " + error.message);
}`}static _generateTransformActorsMacro(e){return e&&e.length>0?`// Flash Token Bar: Transform Actors
// targetActorUuid: UUID of actor to transform into (shows dialog if omitted)
// options: Object with preset ('wildshape', 'polymorph', 'appearance'), settings, and renderSheet
// Example - transformation into specific actor as wildshape:
// FlashAPI.transformActors(actorIds, 'Compendium.dnd5e.monsters.Actor.xyz', { preset: 'wildshape' });

// Option 1: Use specific actors
const actorIds = ${JSON.stringify(e)};
// Option 2: Use currently selected actors in Flash Token Bar menu
// const actorIds = FlashAPI.getSelectedActors();

try {
  FlashAPI.transformActors(actorIds);
} catch (error) {
  ui.notifications.error("Failed to execute Transform Actors: " + error.message);
}`:`// Flash Token Bar: Transform Actors
// targetActorUuid: UUID of actor to transform into (shows dialog if omitted)
// options: Object with preset ('wildshape', 'polymorph', 'appearance'), settings, and renderSheet
// Example - transformation into specific actor as wildshape:
// FlashAPI.transformActors(actorIds, 'Compendium.dnd5e.monsters.Actor.xyz', { preset: 'wildshape' });

try {
  // Option 1: Use currently selected actors in Flash Token Bar menu
  const actorIds = FlashAPI.getSelectedActors();
  // Option 2: Use specific actors
  // const actorIds = ["8sKqJT1gcAUvko53","6xvOSmZnNUcP5Gyh"];

  if (actorIds.length === 0) {
    FlashAPI.notify('warn',"No actors selected");
  } else {
    FlashAPI.transformActors(actorIds);
  }
} catch (error) {
  ui.notifications.error("Failed to execute Transform Actors: " + error.message);
}`}static async _ensureFlashRollsFolder(){const e="Flash Token Bar";let t=game.folders.find(o=>o.type==="Macro"&&o.name===e);if(!t)try{t=await Folder.create({name:e,type:"Macro",color:"#302437",sort:0}),d.log("Created Flash Token Bar macro folder",[t])}catch(o){return d.error("Failed to create Flash Token Bar macro folder:",[o]),I.notify("warn","Failed to create Flash Token Bar macro folder. Macro will be created without folder organization."),null}return(t==null?void 0:t.id)||null}static close(){B(this,je)&&(B(this,je).remove(),ye(this,je,null))}}je=new WeakMap,ne(lo,je,null);const Oe=class Oe{static attachListeners(e,t){d.log("RollMenuEventManager.attachListeners"),this.activeMenu=e,t.querySelectorAll(".actor").length===0?(this.cleanupActorTooltips(),t.classList.add("no-actors")):t.classList.remove("no-actors"),this.attachToggleHandlers(e,t),this.attachDragHandlers(e,t),this.attachTabHandlers(e,t),this.attachActorHandlers(e,t),this.attachActionIconHandlers(e,t),this.attachIconContextMenuHandlers(e,t),this.attachCompactTooltipHandlers(e,t),this.attachSearchHandlers(e,t),this.attachAccordionHandlers(e,t),this.attachSubmenuHandlers(e,t),this.attachStatusEffectHandlers(e,t),this.attachGroupHandlers(e,t),this.attachOutsideClickHandler(e)}static attachToggleHandlers(e,t){var o,s,a,i,n,r,l,c;(o=t.querySelector("#flash-rolls-toggle"))==null||o.addEventListener("change",e._onToggleRollRequests.bind(e)),(s=t.querySelector("#flash5e-skip-dialogs"))==null||s.addEventListener("change",e._onToggleSkipDialogs.bind(e)),(a=t.querySelector("#flash5e-group-rolls-msg"))==null||a.addEventListener("change",e._onToggleGroupRollsMsg.bind(e)),(i=t.querySelector("#flash5e-actors-all"))==null||i.addEventListener("change",e._onToggleSelectAll.bind(e)),(n=t.querySelector("#flash5e-filter-actors"))==null||n.addEventListener("click",e._onToggleActorFilter.bind(e)),(r=t.querySelector("#flash5e-actors-lock"))==null||r.addEventListener("click",e._onToggleLock.bind(e)),(l=t.querySelector(".options-toggle-btn"))==null||l.addEventListener("click",e._onToggleOptions.bind(e)),(c=t.querySelector("#flash5e-open-settings"))==null||c.addEventListener("click",e._onOpenSettings.bind(e))}static attachDragHandlers(e,t){const o=t.querySelector(Le.DRAG_HANDLE_SELECTOR);o&&!o.hasAttribute("data-drag-initialized")&&(o.setAttribute("data-drag-initialized","true"),o.addEventListener("mousedown",s=>{Le.handleDragStart(s,e)}))}static attachTabHandlers(e,t){const o=t.querySelectorAll(".actor-tab");d.log("RollMenuEventManager.attachTabHandlers - found tabs:",[o.length]),o.forEach(s=>{d.log("RollMenuEventManager.attachTabHandlers - attaching to tab:",[s.dataset.tab]),s.addEventListener("click",e._onTabClick.bind(e)),s.addEventListener("dblclick",e._onTabDoubleClick.bind(e))})}static attachActionIconHandlers(e,t){var a,i,n,r,l,c,u,g,f,p,m,k;(a=t.querySelector("#flash5e-targets"))==null||a.addEventListener("click",()=>{this.toggleTargetsForSelected(e)}),(i=t.querySelector("#flash5e-heal-selected"))==null||i.addEventListener("click",()=>{this.healSelectedActors(e)}),(n=t.querySelector("#flash5e-kill-selected"))==null||n.addEventListener("click",()=>{this.killSelectedActors(e)}),(r=t.querySelector("#flash5e-sheets"))==null||r.addEventListener("click",()=>{this.openSheetsForSelected(e)}),(l=t.querySelector("#flash5e-toggle-list"))==null||l.addEventListener("change",()=>{this.toggleOptionsListOnHover(e)}),(c=t.querySelector("#flash5e-remove-effects"))==null||c.addEventListener("click",()=>{this.removeAllStatusEffectsFromSelected(e)}),(u=t.querySelector("#flash5e-group-selected"))==null||u.addEventListener("click",()=>{this.createGroupFromSelected(e)}),(g=t.querySelector("#flash5e-lock-movement"))==null||g.addEventListener("click",()=>{this.toggleMovementForSelected(e)}),(f=t.querySelector("#flash5e-contested-roll"))==null||f.addEventListener("click",()=>{this.openContestedRollDialog(e)}),(p=t.querySelector("#flash5e-place-tokens"))==null||p.addEventListener("click",()=>{this.placeTokensForSelected(e)}),(m=t.querySelector("#flash5e-teleport-tokens"))==null||m.addEventListener("click",()=>{this.teleportTokensForSelected(e)}),(k=t.querySelector("#flash5e-transform"))==null||k.addEventListener("click",()=>{this.transformSelectedActors(e)}),t.querySelectorAll(".actor-actions-nav").forEach(y=>{y.addEventListener("click",S=>{this.scrollActorActions(S.currentTarget,t)})});const s=t.querySelector(".actor-actions-scrollable");s&&(this.updateActorActionsContainerHeight(t),this.updateActorActionsNavState(t),this.restoreActorActionsScrollPosition(s),s.addEventListener("scroll",()=>{this.updateActorActionsNavState(t),this.saveActorActionsScrollPosition(s)}))}static saveActorActionsScrollPosition(e){if(!e)return;const t=C();_.get(t.menuLayout.tag);const o={left:e.scrollLeft,top:e.scrollTop};game.user.setFlag(R,"actorActionsScrollPosition",o)}static restoreActorActionsScrollPosition(e){if(!e)return;const t=game.user.getFlag(R,"actorActionsScrollPosition");t&&(e.scrollLeft=t.left||0,e.scrollTop=t.top||0)}static updateActorActionsContainerHeight(e){const t=e.querySelector(".actor-actions-scrollable");if(!t)return;const o=t.closest(".actor-actions-container");if(!o||o.classList.contains("no-scroll"))return;const s=t.querySelector("li.bulk-action");if(!s)return;const a=C(),i=_.get(a.menuLayout.tag)||"vertical",n=_.get(a.maxIconsPerRow.tag)||5;if(i==="horizontal"){const l=s.offsetWidth*n;t.style.maxWidth=`${l}px`,t.style.maxHeight=""}else{const l=s.offsetHeight*n;t.style.maxHeight=`${l}px`,t.style.maxWidth=""}}static scrollActorActions(e,t){const o=e.dataset.direction,s=t.querySelector(".actor-actions-scrollable");if(!s)return;const a=s.querySelector("li.bulk-action");if(!a)return;const i=C(),n=_.get(i.menuLayout.tag)||"vertical",r=_.get(i.maxIconsPerRow.tag)||5,l=Math.max(1,r-1);if(n==="horizontal"){const c=a.offsetWidth,u=o==="left"?-(c*l):c*l;s.scrollBy({left:u,behavior:"smooth"})}else{const c=a.offsetHeight,u=o==="up"?-(c*l):c*l;s.scrollBy({top:u,behavior:"smooth"})}setTimeout(()=>{this.updateActorActionsNavState(t)},300)}static updateActorActionsNavState(e){const t=e.querySelector(".actor-actions-scrollable");if(!t)return;const o=C(),s=_.get(o.menuLayout.tag)||"vertical";let a,i,n,r;if(s==="horizontal"){if(a=e.querySelector(".actor-actions-nav-left"),i=e.querySelector(".actor-actions-nav-right"),!a||!i)return;const l=t.scrollLeft,c=t.scrollWidth,u=t.clientWidth;n=l<=1,r=l+u>=c-1}else{if(a=e.querySelector(".actor-actions-nav-up"),i=e.querySelector(".actor-actions-nav-down"),!a||!i)return;const l=t.scrollTop,c=t.scrollHeight,u=t.clientHeight;n=l<=1,r=l+u>=c-1}n?(a.classList.add("disabled"),a.setAttribute("disabled","true")):(a.classList.remove("disabled"),a.removeAttribute("disabled")),r?(i.classList.add("disabled"),i.setAttribute("disabled","true")):(i.classList.remove("disabled"),i.removeAttribute("disabled"))}static attachIconContextMenuHandlers(e,t){const o=t.querySelectorAll('[data-icon-id][data-icon-type="moduleActions"]'),s=t.querySelectorAll('[data-icon-id][data-icon-type="actorActions"]');[...o,...s].forEach(i=>{const n=i.dataset.iconId,r=i.dataset.iconType;!n||!r||i.addEventListener("contextmenu",l=>{l.preventDefault(),l.stopPropagation(),lo.show(l,n,r,e)})})}static attachActorHandlers(e,t){t.querySelectorAll(".actor.drag-wrapper").forEach(o=>{o.addEventListener("click",n=>{o.hasAttribute("data-non-selectable")||e._onActorClick.call(e,n)});const s=o.querySelector(".icon-sheet");s&&s.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const r=o.dataset.actorId,l=o.dataset.tokenId;this.openActorSheetById(r,l)});const a=o.querySelector(".icon-target");a&&a.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const r=o.dataset.actorId,l=o.dataset.tokenId;this.toggleActorTargetById(r,l)});const i=o.querySelector(".actor-img");i&&(i.addEventListener("contextmenu",n=>{n.preventDefault(),n.stopPropagation();const r=o.dataset.tokenId,l=o.dataset.actorId;let c=r?canvas.tokens.get(r):null;!c&&l&&(c=canvas.tokens.placeables.find(u=>{var g;return((g=u.actor)==null?void 0:g.id)===l})),c&&canvas.animatePan({x:c.x,y:c.y,duration:250})}),i.addEventListener("mouseenter",n=>{this.showTokenSelectionPreview(o,e)}),i.addEventListener("mouseleave",n=>{this.hideTokenSelectionPreview(o,e)}))})}static cleanupActorTooltips(){document.querySelectorAll(".actor-data-tooltip").forEach(t=>t.remove())}static attachCompactTooltipHandlers(e,t){if(this.cleanupActorTooltips(),!t.classList.contains("compact"))return;t.querySelectorAll("#flash-rolls-menu.compact .actor").forEach(s=>{const a=s.querySelector(".actor-data");if(!a)return;let i=null;const n=async c=>{const u=document.querySelector(".actor-data-tooltip");u&&u.remove(),i=a.cloneNode(!0);const g=s.getBoundingClientRect(),f=t.getBoundingClientRect(),p=t.classList.contains("left-edge");if(t.hasAttribute("data-layout")&&t.getAttribute("data-layout")==="horizontal"){const k=s.querySelector(".actor-img"),y=k?k.getBoundingClientRect():g,S=y.left+y.width/2-f.left-16;i.style.left=`${S}px`,i.style.transform="translateX(-50%)",i.style.bottom=`${f.bottom-g.top+8}px`,i.style.top="auto",i.style.right="auto"}else p?i.style.left=`${g.right-f.left-8}px`:i.style.right=`${f.right-g.left-8}px`,i.style.top=`${g.top-f.top}px`;i.className="actor-data-tooltip",document.querySelector("#flash-rolls-menu").appendChild(i),setTimeout(()=>{i==null||i.classList.add("visible")},e.selectedActors.size>0?300:0)},r=()=>{i&&(i.remove(),i=null)};s.addEventListener("mouseenter",n),s.addEventListener("mouseleave",r);const l=s.closest("ul");l&&l.addEventListener("scroll",r)})}static attachSearchHandlers(e,t){const o=t.querySelector(".search-input");o&&(o.addEventListener("input",e._onSearchInput.bind(e)),o.addEventListener("click",s=>{s.target.select()}),o.addEventListener("focus",s=>{s.target.select(),e.isSearchFocused=!0,game.user.setFlag(R,"searchFocused",!0)}),o.addEventListener("blur",()=>{e.isSearchFocused=!1,game.user.setFlag(R,"searchFocused",!1);const s=t.querySelector(".request-types-accordion");s&&!t.matches(":hover")&&s.classList.remove("hover-visible")}))}static attachAccordionHandlers(e,t){const o=C(),s=_.get(o.showOptionsListOnHover.tag),a=t.querySelector(".request-types-accordion");if(a){const n=()=>{const l=_.get(o.showOptionsListOnHover.tag);d.log("Accordion mouseEnter",[e.isSearchFocused]),e.selectedActors.size>0&&l&&(a==null||a.classList.add("hover-visible"))},r=()=>{d.log("Accordion mouseLeave",[e.isSearchFocused]),e.isSearchFocused||a==null||a.classList.remove("hover-visible")};e._accordionMouseEnter=n,e._accordionMouseLeave=r,s?(t.addEventListener("mouseenter",n),t.addEventListener("mouseleave",r),e._accordionListenersAttached=!0):e._accordionListenersAttached=!1}const i=t.querySelector(".request-types");d.log("RollMenuEventManager.attachAccordionHandlers",[i]),i&&i.addEventListener("click",n=>{if(n.target.classList.contains("btn-macro")){n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation();const u=n.target.closest(".sub-item")||n.target.closest(".request-type-item");if(u){const g={...n,currentTarget:u};e._onMacroButtonClick(g)}return}const r=n.target.closest(".btn-macro");if(r){n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation();const u=r.closest(".sub-item")||r.closest(".request-type-item");if(u){const g={...n,currentTarget:u};e._onMacroButtonClick(g)}return}const l=n.target.closest(".request-type-header");if(l){const u=l.closest(".request-type-item");if(l.classList.contains("accordion-header")){e._onAccordionToggle(n);return}if(l.classList.contains("toggle")&&u&&u.classList.contains("rollable")){const g={...n,currentTarget:u};e._onRequestTypeClick(g);return}}const c=n.target.closest(".sub-item");if(c&&c.dataset.id){const u={...n,currentTarget:c};e._onRollTypeClick(u)}})}static attachSubmenuHandlers(e,t){try{t.querySelectorAll(".submenu-tabs li[data-tab]").forEach(s=>{s.addEventListener("click",e._onSubmenuTabClick.bind(e))})}catch(o){d.error("RollMenuEventManager.attachSubmenuHandlers error:",[o])}}static attachStatusEffectHandlers(e,t){try{t.querySelectorAll(".status-effects .status-effect").forEach(s=>{s.dataset.listenerAttached||(s.dataset.listenerAttached="true",s.addEventListener("click",e._onStatusEffectClick.bind(e)))})}catch(o){d.error("RollMenuEventManager.attachStatusEffectHandlers error:",[o])}}static attachGroupHandlers(e,t){t.querySelectorAll(".group-expand-btn").forEach(s=>{s.addEventListener("click",async a=>{a.preventDefault(),a.stopPropagation();const i=s.dataset.groupId,n=e.groupExpansionStates[i]??!1;e.groupExpansionStates[i]=!n,await game.user.setFlag(R,"groupExpansionStates",e.groupExpansionStates),e.render()})})}static attachOutsideClickHandler(e){setTimeout(()=>{document.addEventListener("click",e._onClickOutside,!0)},100)}static toggleTargetsForSelected(e){if(e.selectedActors.size>0)e.selectedActors.forEach(t=>{const o=Y(t);if(!o)return;const s=o.id,a=game.actors.get(t)?null:t;this.toggleActorTargetById(s,a)});else if(game.user.targets.size>0){const t=game.user.targets.size;game.user.targets.forEach(o=>{o.setTarget(!1,{releaseOthers:!1})}),I.notify("info",`Cleared ${t} target(s)`)}}static openSheetsForSelected(e){e.currentTab==="group"?this.openGroupSheetsForSelected(e):e.selectedActors.forEach(t=>{const o=Y(t);if(!o)return;const s=o.id,a=game.actors.get(t)?null:t;this.openActorSheetById(s,a)})}static openGroupSheetsForSelected(e){const o=(e._lastPreparedContext||{}).actors||[],s=new Set;o.forEach(a=>{a.isGroup&&a.members&&a.members.some(n=>e.selectedActors.has(n.uniqueId))&&!s.has(a.id)&&(this.openActorSheetById(a.id,a.tokenId),s.add(a.id))})}static healSelectedActors(e){e.selectedActors.forEach(t=>{const o=Y(t);if(!o)return;const s=o.id,a=game.actors.get(t)?null:t;this.healActorById(s,a)})}static killSelectedActors(e){e.selectedActors.forEach(t=>{const o=Y(t);if(!o)return;const s=o.id,a=game.actors.get(t)?null:t;this.killActorById(s,a)})}static async removeAllStatusEffectsFromSelected(e){if(e.selectedActors.size===0){I.notify("warn","No actors selected");return}let t=0,o=0;for(const s of e.selectedActors){const a=Y(s);if(!a)continue;o++;const i=a.appliedEffects.filter(n=>{var r,l,c;return((r=n.statuses)==null?void 0:r.size)>0||((c=(l=n.flags)==null?void 0:l.core)==null?void 0:c.statusId)});if(i.length>0)for(const n of i)try{await n.delete(),t++}catch(r){d.error(`Failed to remove status effect from ${a.name}`,[r])}}t>0?I.notify("info",`Removed ${t} status effects from ${o} actor(s)`):I.notify("info","No status effects to remove from selected actors")}static toggleActorTarget(e){const t=e.dataset.tokenId,o=e.dataset.actorId;let s=t?canvas.tokens.get(t):null;if(!s&&o&&(s=canvas.tokens.placeables.find(a=>{var i;return((i=a.actor)==null?void 0:i.id)===o})),s){const a=game.user.targets.has(s);s.setTarget(!a,{releaseOthers:!1})}}static openActorSheet(e){const t=e.dataset.actorId,o=e.dataset.tokenId;if(t){let s;if(o){const a=canvas.tokens.get(o);s=(a==null?void 0:a.actor)||game.actors.get(t)}else s=game.actors.get(t);s==null||s.sheet.render(!0)}}static healActor(e){var a,i;const t=e.dataset.actorId,o=e.dataset.tokenId;let s;if(o){const n=canvas.tokens.get(o);s=(n==null?void 0:n.actor)||game.actors.get(t)}else s=game.actors.get(t);if(s&&((i=(a=s.system)==null?void 0:a.attributes)!=null&&i.hp)){const n=s.system.attributes.hp.max;s.update({"system.attributes.hp.value":n})}}static killActor(e){var a,i;const t=e.dataset.actorId,o=e.dataset.tokenId;let s;if(o){const n=canvas.tokens.get(o);s=(n==null?void 0:n.actor)||game.actors.get(t)}else s=game.actors.get(t);s&&((i=(a=s.system)==null?void 0:a.attributes)!=null&&i.hp)&&s.update({"system.attributes.hp.value":0})}static toggleActorTargetById(e,t){let o=t?canvas.tokens.get(t):null;if(!o&&e&&(o=canvas.tokens.placeables.find(s=>{var a;return((a=s.actor)==null?void 0:a.id)===e})),o){const s=game.user.targets.has(o);o.setTarget(!s,{releaseOthers:!1})}}static openActorSheetById(e,t){if(e){let o;if(t){const s=canvas.tokens.get(t);o=(s==null?void 0:s.actor)||game.actors.get(e)}else o=game.actors.get(e);o==null||o.sheet.render(!0)}}static healActorById(e,t){var s,a;let o;if(t){const i=canvas.tokens.get(t);o=(i==null?void 0:i.actor)||game.actors.get(e)}else o=game.actors.get(e);if(o&&((a=(s=o.system)==null?void 0:s.attributes)!=null&&a.hp)){const i=o.system.attributes.hp.max;o.update({"system.attributes.hp.value":i})}}static killActorById(e,t){var s,a;let o;if(t){const i=canvas.tokens.get(t);o=(i==null?void 0:i.actor)||game.actors.get(e)}else o=game.actors.get(e);o&&((a=(s=o.system)==null?void 0:s.attributes)!=null&&a.hp)&&o.update({"system.attributes.hp.value":0})}static showTokenSelectionPreview(e,t){var i,n;const o=e.dataset.tokenId,s=e.dataset.actorId;let a=o?canvas.tokens.get(o):null;if(!a&&s&&(a=canvas.tokens.placeables.find(r=>{var l;return((l=r.actor)==null?void 0:l.id)===s})),a&&!a.hover){a.hover=!0,a.renderFlags.set({refreshState:!0}),this._hoveredTokens.add(a);const r=C();_.get(r.showTokenVisionOnHover.tag)&&((i=canvas.scene)!=null&&i.tokenVision)&&((n=a.document.sight)!=null&&n.enabled)&&game.user.isGM&&(this._previouslyControlledTokens=[...canvas.tokens.controlled],this._previewControlToken=a,this._originalControlledGetter=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(a),"controlled"),Object.defineProperty(a,"controlled",{get:()=>!0,configurable:!0}),a.initializeVisionSource(),canvas.perception.update({initializeVision:!0,refreshVision:!0}))}}static async toggleOptionsListOnHover(e){const t=C(),o=_.get(t.showOptionsListOnHover.tag),s=e.element.querySelector(".request-types-accordion");s==null||s.classList.contains("hover-visible");const a=!o;await _.set(t.showOptionsListOnHover.tag,a),Oe.updateAccordionHoverBehaviorNoRender(e,a),a===!1||e.selectedActors.size===0?s==null||s.classList.remove("hover-visible"):a===!0&&e.selectedActors.size>0&&(s==null||s.classList.add("hover-visible"))}static updateAccordionHoverBehavior(e,t){e.render()}static updateAccordionHoverBehaviorNoRender(e,t){const o=e.element,s=o.querySelector(".request-types-accordion");!s||!e._accordionMouseEnter||(o.removeEventListener("mouseenter",e._accordionMouseEnter),o.removeEventListener("mouseleave",e._accordionMouseLeave),s.classList.remove("hover-visible"),t&&(o.addEventListener("mouseenter",e._accordionMouseEnter),o.addEventListener("mouseleave",e._accordionMouseLeave)))}static hideTokenSelectionPreview(e,t){const o=e.dataset.tokenId,s=e.dataset.actorId;let a=o?canvas.tokens.get(o):null;!a&&s&&(a=canvas.tokens.placeables.find(i=>{var n;return((n=i.actor)==null?void 0:n.id)===s})),a&&this._hoveredTokens.has(a)&&(a.hover=!1,a.renderFlags.set({refreshState:!0}),this._hoveredTokens.delete(a),this._previewControlToken===a&&game.user.isGM&&(delete a.controlled,this._originalControlledGetter&&(Object.defineProperty(a,"controlled",this._originalControlledGetter),this._originalControlledGetter=null),a.initializeVisionSource(),this._previouslyControlledTokens.forEach(i=>{i.scene===canvas.scene&&i.initializeVisionSource()}),canvas.perception.update({initializeVision:!0,refreshVision:!0}),this._previewControlToken=null,this._previouslyControlledTokens=[]))}static async createGroupFromSelected(e){var u;if(e.selectedActors.size===0){I.notify("warn","No actors selected");return}const t=new Map,o={},s=(u=game.scenes.current)==null?void 0:u.id;let a=0,i=0;for(const g of e.selectedActors){const f=Y(g);if(!f)continue;i++;const p=f.id;if(t.has(p)){const m=t.get(p);m.count++,f.tokenId&&m.tokenIds.push(f.tokenId)}else t.set(p,{actor:f,count:1,tokenIds:f.tokenId?[f.tokenId]:[]}),Object.entries(f.ownership||{}).some(([k,y])=>{if(k==="default")return!1;const S=game.users.get(k);return S&&!S.isGM&&y>=CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED})&&a++;if(g!==f.id&&s){const m=`Scene.${s}.Token.${g}`;o[s]||(o[s]={}),o[s][p]||(o[s][p]=[]),o[s][p].push(m)}}if(t.size===0){I.notify("warn","No valid actors found");return}const n=a/t.size,r=n>=.5?"group":"encounter",l=r==="group"?"New Group":"New Encounter",c=[];if(r==="group")for(const[g,{actor:f,count:p}]of t)game.actors.get(g)&&c.push({actor:g});else for(const[g,{actor:f,count:p}]of t)c.push({uuid:`Actor.${g}`,quantity:{value:p,formula:""}});try{const g=await Actor.create({name:l,type:r,img:"icons/svg/mystery-man.svg",system:{members:c},flags:{"flash-rolls-5e":{tokenAssociationsByScene:o}},ownership:{default:CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER,[game.user.id]:CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER}});if(g){g.sheet.render(!0);const f=Array.from(t.values()).map(({actor:p,count:m})=>m>1?`${p.name} (x${m})`:p.name).join(", ");I.notify("info",`Created ${r} "${g.name}" (${i} tokens, ${t.size} unique: ${f})`),d.log(`createGroupFromSelected - Created ${r}:`,{newActor:g,totalSelectedCount:i,uniqueActorCount:t.size,playerOwnedCount:a,playerOwnedRatio:n,tokenAssociationsByScene:o,members:Array.from(t.entries()).map(([p,{actor:m,count:k,tokenUuids:y}])=>({id:p,name:m.name,quantity:k,tokenUuids:y}))})}}catch(g){d.error("Failed to create group/encounter actor:",g),I.notify("warn",`Failed to create ${r}: ${g.message}`)}}static async toggleMovementForSelected(e){await Te.toggleMovementForSelected(e)}static async openContestedRollDialog(e){var i,n;const t=e||this.activeMenu;if(!t||t.selectedActors.size===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}const o=[];for(const r of t.selectedActors){const l=Y(r);if(l){const c=(i=game.scenes.current)==null?void 0:i.tokens.get(r),u=(n=canvas.tokens)==null?void 0:n.get(r),g=c||u?r:null;o.push({actor:l,uniqueId:r,tokenId:g})}}if(o.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}if(o.length<2){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.twoActorsRequired"));return}const s=o.slice(0,2),{ContestedRollDialog:a}=await ht(async()=>{const{ContestedRollDialog:r}=await Promise.resolve().then(()=>cs);return{ContestedRollDialog:r}},void 0);await a.show(s)}static async placeTokensForSelected(e){const{TokenPlacementManager:t}=await ht(async()=>{const{TokenPlacementManager:o}=await Promise.resolve().then(()=>Jo);return{TokenPlacementManager:o}},void 0);await t.placeTokensForSelectedActors(e)}static async teleportTokensForSelected(e){const{TokenTeleportManager:t}=await ht(async()=>{const{TokenTeleportManager:o}=await Promise.resolve().then(()=>Xo);return{TokenTeleportManager:o}},void 0);await t.teleportSelectedTokens(e)}static async transformSelectedActors(e){const{TransformationManager:t}=await ht(async()=>{const{TransformationManager:o}=await Promise.resolve().then(()=>ts);return{TransformationManager:o}},void 0);await t.transformSelectedActors(e)}};D(Oe,"_hoveredTokens",new Set),D(Oe,"_previewControlToken",null),D(Oe,"_previouslyControlledTokens",[]),D(Oe,"_originalControlledGetter",null),D(Oe,"activeMenu",null);let ce=Oe;class co{static async applyStatusToSelected(e,t){const o=CONFIG.statusEffects.find(i=>i.id===e);if(!o){I.notify("warn",`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){I.notify("warn","No actors selected");return}let s=0,a=0;for(const i of t.selectedActors){const n=Y(i);if(!n)continue;a++,await this.applyStatusToActor(o,n)&&s++}if(s>0){const i=o.name||o.label||o.id;I.notify("info",`Applied "${i}" to ${s}/${a} actors`)}}static async applyStatusToActor(e,t){try{if(t.appliedEffects.find(a=>{var i,n,r;return((i=a.statuses)==null?void 0:i.has(e.id))||((r=(n=a.flags)==null?void 0:n.core)==null?void 0:r.statusId)===e.id}))return d.log(`RollMenuStatusManager: Actor ${t.name} already has status effect ${e.id}`),!1;if(t.toggleStatusEffect)return t.appliedEffects.some(i=>{var n;return(n=i.statuses)==null?void 0:n.has(e.id)})?!1:(await t.toggleStatusEffect(e.id,{active:!0}),d.log(`RollMenuStatusManager: Applied ${e.id} to ${t.name}`),!0);const s={name:e.name||e.label||e.id,icon:e.icon||e.img,statuses:[e.id],flags:{core:{statusId:e.id}}};return e.changes&&(s.changes=e.changes),await t.createEmbeddedDocuments("ActiveEffect",[s]),d.log(`RollMenuStatusManager: Applied ${e.id} to ${t.name}`),!0}catch(o){return d.error(`RollMenuStatusManager: Failed to apply status effect to ${t.name}`,[o]),!1}}static async removeStatusFromSelected(e,t){const o=CONFIG.statusEffects.find(i=>i.id===e);if(!o){I.notify("warn",`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){I.notify("warn","No actors selected");return}let s=0,a=0;for(const i of t.selectedActors){const n=Y(i);if(!n)continue;a++,await this.removeStatusFromActor(o,n)&&s++}if(s>0){const i=o.name||o.label||o.id;I.notify("info",`Removed "${i}" from ${s}/${a} actors`)}}static async removeStatusFromActor(e,t){try{if(t.toggleStatusEffect)return t.appliedEffects.some(a=>{var i;return(i=a.statuses)==null?void 0:i.has(e.id)})?(await t.toggleStatusEffect(e.id,{active:!1}),d.log(`RollMenuStatusManager: Removed ${e.id} from ${t.name}`),!0):!1;const o=t.appliedEffects.find(s=>{var a,i,n;return((a=s.statuses)==null?void 0:a.has(e.id))||((n=(i=s.flags)==null?void 0:i.core)==null?void 0:n.statusId)===e.id});return o?(await o.delete(),d.log(`RollMenuStatusManager: Removed ${e.id} from ${t.name}`),!0):(d.log(`RollMenuStatusManager: Actor ${t.name} does not have status effect ${e.id}`),!1)}catch(o){return d.error(`RollMenuStatusManager: Failed to remove status effect from ${t.name}`,[o]),!1}}static async toggleStatusOnSelected(e,t){const o=CONFIG.statusEffects.find(a=>a.id===e);if(!o){I.notify("warn",`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){I.notify("warn","No actors selected");return}let s=!1;for(const a of t.selectedActors){const i=Y(a);if(!i)continue;if(i.appliedEffects.find(r=>{var l,c,u;return((l=r.statuses)==null?void 0:l.has(o.id))||((u=(c=r.flags)==null?void 0:c.core)==null?void 0:u.statusId)===o.id})){s=!0;break}}s?await this.removeStatusFromSelected(e,t):await this.applyStatusToSelected(e,t)}static getStatusEffectsForTemplate(){try{return!CONFIG.statusEffects||!Array.isArray(CONFIG.statusEffects)?(d.warn("RollMenuStatusManager: CONFIG.statusEffects not available or not an array"),[]):CONFIG.statusEffects.map(e=>({...e,displayName:e.name||e.label||e.id,iconPath:e.icon||e.img||"icons/svg/aura.svg"})).sort((e,t)=>e.displayName.localeCompare(t.displayName,void 0,{sensitivity:"base"}))}catch(e){return d.error("RollMenuStatusManager: Error getting status effects for template",[e]),[]}}}class Z{static async handleToggleRollRequests(e){const t=C(),o=e.target.checked;await _.set(t.rollRequestsEnabled.tag,o),At.updateRollRequestsIcon(o)}static async handleToggleSkipDialogs(e){const t=C(),o=e.target.checked;await _.set(t.skipRollDialog.tag,o)}static async handleToggleGroupRollsMsg(e){const t=C(),o=e.target.checked;await _.set(t.groupRollsMsgEnabled.tag,o)}static handleToggleSelectAll(e,t){const o=C(),s=e.target.checked;t._ignoreTokenControl=!0;const a=t._lastPreparedContext||{};(t.currentTab==="group"?a.groups||[]:a.actors||[]).forEach(l=>{if(l.isGroup&&l.members)l.members.forEach(c=>{const u=c.uniqueId;s?(t.selectedActors.add(u),c.tokenId?Se(c.id,!0,c.tokenId):Se(c.id,!0)):(t.selectedActors.delete(u),c.tokenId?Se(c.id,!1,c.tokenId):Se(c.id,!1))});else{const c=l.uniqueId;s?(t.selectedActors.add(c),l.tokenId?Se(l.id,!0,l.tokenId):Se(l.id,!0)):(t.selectedActors.delete(c),l.tokenId?Se(l.id,!1,l.tokenId):Se(l.id,!1))}}),setTimeout(()=>{t._ignoreTokenControl=!1},200),t._updateGroupSelectionUI(),this.updateSelectAllState(t),t.render(),this.updateRequestTypesVisibility(t);const n=_.get(o.showOptionsListOnHover.tag),r=t.element.querySelector(".request-types-accordion");r&&(t.selectedActors.size>0&&n?r.classList.add("hover-visible"):r.classList.remove("hover-visible"))}static async handleToggleLock(e,t){var i;e.preventDefault(),t.isLocked=!t.isLocked,await game.user.setFlag(W.ID,"menuLocked",t.isLocked);const o=e.currentTarget||((i=t.element)==null?void 0:i.querySelector("#flash5e-actors-lock"));o&&(o.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),o.classList.add(t.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open"));const s=C();_.get(s.lockMenuPosition.tag)&&t.element&&(t.isLocked?t.element.classList.add("position-locked"):t.element.classList.remove("position-locked"))}static async handleToggleActorFilter(e,t){e.preventDefault(),e.stopPropagation();const o=e.currentTarget,s=t.element.querySelector(".actor-filter-tooltip");if(s){s.remove();return}const a=await Z.createActorFilterTooltip(t);t.element.appendChild(a);const i=o.getBoundingClientRect(),n=t.element.getBoundingClientRect(),r=t.element.dataset.layout,l=a.getBoundingClientRect(),c=i.top-n.top,g=i.left-n.left+i.width/2-l.width/2;if(r==="horizontal")a.style.top=`${c-l.height-8}px`,a.style.left=`${g}px`;else{const f=t.element.classList.contains("left-edge"),p=i.left-n.left,k=c+i.height-l.height;f?(a.style.top=`${k}px`,a.style.left=`${p+i.width+20}px`):(a.style.top=`${k}px`,a.style.left=`${p-l.width-20}px`)}}static async handleToggleOptions(e,t){e.preventDefault(),e.stopPropagation(),t.optionsExpanded=!t.optionsExpanded,await game.user.setFlag(W.ID,"menuOptionsExpanded",t.optionsExpanded);const o=t.element.querySelector(".options-toggle");o&&o.classList.toggle("expanded",t.optionsExpanded);const s=t.element.querySelector("li.options");s&&s.classList.toggle("expanded",t.optionsExpanded)}static toggleActorSelection(e,t,o,s){const a=C();s._ignoreTokenControl=!0,s.selectedActors.has(e)?(s.selectedActors.delete(e),o?Se(t,!1,o):Se(t,!1)):(s.selectedActors.add(e),o?Se(t,!0,o):Se(t,!0)),setTimeout(()=>{s._ignoreTokenControl=!1},100),this.updateActorSelectionUI(e,s),this.updateSelectAllState(s),this.updateRequestTypesVisibilityNoRender(s);const i=_.get(a.showOptionsListOnHover.tag),n=s.element.querySelector(".request-types-accordion");n&&(s.selectedActors.size>0&&i?n.classList.add("hover-visible"):n.classList.remove("hover-visible"))}static updateActorSelectionUI(e,t){const o=t.element.querySelector(`.actor.drag-wrapper[data-id="${e}"]`);if(!o)return;const s=o.closest(".actor");if(!s)return;const a=s.querySelector(".actor-select"),i=t.selectedActors.has(e);a&&(a.checked=i),o.classList.toggle("selected",i),o.dataset.selected=i.toString()}static updateRequestTypesVisibility(e){e.render()}static updateRequestTypesVisibilityNoRender(e){const t=e.selectedActors.size>0,o=e.element.querySelector(".request-types");if(o){o.querySelectorAll(".request-type-item").forEach(n=>{n.classList.toggle("disabled",!t)});const a=Array.from(e.selectedActors).some(n=>{const r=Y(n);return(r==null?void 0:r.type)==="character"}),i=o.querySelector('[data-id="HIT_DIE"]');i&&(i.style.display=a?"":"none")}}static updateSelectAllState(e){const t=e.element.querySelector("#flash5e-actors-all");let o=0,s=0;if(e.currentTab==="group"){const i=(e._lastPreparedContext||{}).groups||[],n=[];i.forEach(r=>{r.isGroup&&r.members&&n.push(...r.members)}),s=n.length,o=n.filter(r=>e.selectedActors.has(r.uniqueId)).length}else{const a=e.currentTab==="pc"?"pc":"npc",i=e.element.querySelectorAll(`.${a}-actors .actor-item input[type="checkbox"]`);s=i.length,o=Array.from(i).filter(n=>n.checked).length}t&&(t.checked=o>0&&o===s,t.indeterminate=o>0&&o<s)}static async createActorFilterTooltip(e){const t=game.user.getFlag(W.ID,"actorFilters")||{inCombat:!1,visible:!1,removeDead:!1};e.actorFilters=t;const s=await renderTemplate("modules/flash-rolls-5e/templates/actor-filter-tooltip.hbs",{filters:t}),a=document.createElement("div");a.innerHTML=s;const i=a.firstElementChild;return i.querySelectorAll('input[type="checkbox"]').forEach(n=>{n.addEventListener("change",r=>{Z.applyActorFilters(e)})}),i}static async applyActorFilters(e){const t=e.element.querySelector(".actor-filter-tooltip");if(!t)return;const o={inCombat:t.querySelector('[data-filter="inCombat"]').checked,visible:t.querySelector('[data-filter="visible"]').checked,removeDead:t.querySelector('[data-filter="removeDead"]').checked};e.actorFilters=o,await game.user.setFlag(W.ID,"actorFilters",o),e.render()}static doesActorPassFilters(e,t,o=null){return!t.inCombat&&!t.visible&&!t.removeDead?!0:!(t.inCombat&&!(o?o.inCombat:e.inCombat)||t.visible&&o&&o.hidden||t.removeDead&&e.appliedEffects.some(a=>{var i,n,r;return((i=a.statuses)==null?void 0:i.has("dead"))||((r=(n=a.flags)==null?void 0:n.core)==null?void 0:r.statusId)==="dead"}))}}class Wo{static async prepareActorContext(e,t){const o=C(),s=game.actors.contents,a=[],i=[],n=[],r=game.scenes.current;for(const T of s){if(T.type==="group"||T.type==="encounter"){const L=await this.processGroupActor(T,r,e);n.push(...L);continue}if(T.type!=="character"&&T.type!=="npc")continue;const b=this.isPlayerOwnedActor(T),v=await this.processActor(T,r,e,b);b?a.push(...v):i.push(...v)}const l=e.actorFilters||{};if(l.inCombat||l.visible||l.removeDead){const T=a.filter(L=>{const E=L.tokenId?r==null?void 0:r.tokens.get(L.tokenId):null,O=(E==null?void 0:E.actor)||game.actors.get(L.id);return O?Z.doesActorPassFilters(O,l,E):!1});a.length=0,a.push(...T);const b=i.filter(L=>{const E=L.tokenId?r==null?void 0:r.tokens.get(L.tokenId):null,O=(E==null?void 0:E.actor)||game.actors.get(L.id);return O?Z.doesActorPassFilters(O,l,E):!1});i.length=0,i.push(...b);const v=n.filter(L=>{if(L.isGroup){const E=game.actors.get(L.id),O=L.tokenId?r==null?void 0:r.tokens.get(L.tokenId):null,w={inCombat:l.inCombat,visible:l.visible,removeDead:!1};return E&&Z.doesActorPassFilters(E,w,O)||L.members&&L.members.length>0}else{const E=game.actors.get(L.id);if(!E)return!1;const O=L.tokenId?r==null?void 0:r.tokens.get(L.tokenId):null;return Z.doesActorPassFilters(E,l,O)}});n.length=0,n.push(...v)}n.sort((T,b)=>{var M;const v=game.actors.get(T.id),L=game.actors.get(b.id);if(!v||!L)return 0;const E=(M=game.settings.get("dnd5e","primaryParty"))==null?void 0:M.actor,O=(E==null?void 0:E.id)===v.id,w=(E==null?void 0:E.id)===L.id;return O&&!w?-1:!O&&w?1:v.type==="group"&&L.type==="encounter"?-1:v.type==="encounter"&&L.type==="group"?1:0});const c=_.get(o.rollRequestsEnabled.tag),u=_.get(o.skipRollDialog.tag),g=_.get(o.groupRollsMsgEnabled.tag);_.get(o.showOnlyPCsWithToken.tag);const f=_.get(o.showOptionsListOnHover.tag)??o.showOptionsListOnHover.default;d.log("Template context showOptionsListOnHover:",[f,typeof f,"tag:",o.showOptionsListOnHover.tag]);const p=e.currentTab==="pc"?a:e.currentTab==="npc"?i:n;let m=!1;if(p.length>0)if(e.currentTab==="group"){const T=[];p.forEach(b=>{b.isGroup&&b.members&&T.push(...b.members)}),m=T.length>0&&T.every(b=>e.selectedActors.has(b.uniqueId))}else m=p.every(T=>e.selectedActors.has(T.uniqueId));const k=this.buildRequestTypes(e),y=zt(e.selectedRequestType,e.selectedActors),S=co.getStatusEffectsForTemplate();return{...t,actors:e.currentTab==="group"?[]:p,groups:e.currentTab==="group"?p:[],currentTab:e.currentTab,isPCTab:e.currentTab==="pc",isNPCTab:e.currentTab==="npc",isGroupTab:e.currentTab==="group",selectedTab:e.currentTab,selectedSubmenu:e.selectedSubmenu,rollRequestsEnabled:c,skipRollDialog:u,groupRollsMsgEnabled:g,showOptionsListOnHover:f,selectAllOn:m,hasSelectedActors:e.selectedActors.size>0,requestTypes:k,rollTypes:y,statusEffects:S,showNames:!0,actorsLocked:e.isLocked,optionsExpanded:e.optionsExpanded,isGM:game.user.isGM,isCompact:_.get(o.compactMode.tag)}}static isPlayerOwnedActor(e){return Object.entries(e.ownership).some(([t,o])=>{const s=game.users.get(t);return s&&!s.isGM&&o>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}static async processActor(e,t,o,s){var c;if(ae.isBlocked(e))return[];const a=C(),i=_.get((c=a.showOnlyPCsWithToken)==null?void 0:c.tag),n=ae.isFavorite(e),r=(t==null?void 0:t.tokens.filter(u=>u.actorId===e.id))||[],l=[];return s?n?l.push(...this.processFavoriteActor(e,r,o)):i?l.push(...this.processTokenOnlyActor(e,r,o)):l.push(...this.processRegularActor(e,r,o)):n?l.push(...this.processFavoriteActor(e,r,o)):l.push(...this.processTokenOnlyActor(e,r,o)),l}static processFavoriteActor(e,t,o){const s=[];if(t.length>0)t.forEach(a=>{const i=this.createActorData(e,a,o);i.isFavorite=!0,s.push(i)});else{const a=this.createActorData(e,null,o);a.isFavorite=!0,s.push(a)}return s}static processTokenOnlyActor(e,t,o){const s=[];return t.length>0&&t.forEach(a=>{const i=this.createActorData(e,a,o);s.push(i)}),s}static processRegularActor(e,t,o){const s=[];if(t.length>0)t.forEach(a=>{const i=this.createActorData(e,a,o);s.push(i)});else{const a=this.createActorData(e,null,o);s.push(a)}return s}static createActorData(e,t,o){const s=(t==null?void 0:t.actor)||e,a=Wt.getActorHPData(s);return{id:e.id,uuid:e.uuid,name:t?t.name:e.name,img:e.img,selected:o.selectedActors.has((t==null?void 0:t.id)||e.id),crlngnStats:Wt.getActorStats(s),hpPercent:a.hpPercent,hpColor:a.hpColor,tokenId:(t==null?void 0:t.id)||null,isToken:!!t,uniqueId:(t==null?void 0:t.id)||e.id,movementRestricted:t?Te.isMovementRestricted(t):!1}}static async processGroupActor(e,t,o){var g,f,p;if(ae.isBlocked(e))return[];const s=C(),a=_.get((g=s.showOnlyPCsWithToken)==null?void 0:g.tag),i=(t==null?void 0:t.tokens.filter(m=>m.actorId===e.id))||[],n=[],r=[];let l=!1;const c=o.actorFilters||{},u=c.inCombat||c.visible||c.removeDead;if(e.type==="group"){const k=(e.getFlag(R,"tokenAssociationsByScene")||{})[t==null?void 0:t.id]||{};for(const y of e.system.members||[])if(y.actor&&!ae.isBlocked(y.actor)){const S=y.actor.id,T=k[S]||[];if(T.length>0){let b=!1;for(const v of T)try{const L=fromUuidSync(v);if(L&&L.actorId===y.actor.id&&L.parent===t){if(u){const O=L.actor||y.actor;if(!Z.doesActorPassFilters(O,c,L))continue}l=!0,b=!0;const E=this.createActorData(y.actor,L,o);r.push(E)}}catch{}if(!b&&!a){if(u&&!Z.doesActorPassFilters(y.actor,c,null))continue;const v=this.createActorData(y.actor,null,o);r.push(v)}}else{const b=(t==null?void 0:t.tokens.filter(v=>v.actorId===y.actor.id))||[];if(b.length>0)l=!0,b.forEach(v=>{if(u){const E=v.actor||y.actor;if(!Z.doesActorPassFilters(E,c,v))return}const L=this.createActorData(y.actor,v,o);r.push(L)});else if(!a){if(u&&!Z.doesActorPassFilters(y.actor,c,null))continue;const v=this.createActorData(y.actor,null,o);r.push(v)}}}}else if(e.type==="encounter"){const k=(e.getFlag(R,"tokenAssociationsByScene")||{})[t==null?void 0:t.id]||{};for(const y of e.system.members||[])try{const S=await fromUuid(y.uuid);if(S&&!ae.isBlocked(S)){const T=S.id,b=k[T]||[];if(b.length>0)for(const v of b)try{const L=fromUuidSync(v);if(L&&L.actorId===S.id&&L.parent===t){if(u){const O=L.actor||S;if(!Z.doesActorPassFilters(O,c,L))continue}l=!0;const E=this.createActorData(S,L,o);E.quantity=1,r.push(E)}}catch{}else{const v=(t==null?void 0:t.tokens.filter(L=>L.actorId===S.id))||[];if(v.length>0)l=!0,v.forEach(L=>{if(u){const O=L.actor||S;if(!Z.doesActorPassFilters(O,c,L))return}const E=this.createActorData(S,L,o);E.quantity=1,r.push(E)});else if(!a){if(u&&!Z.doesActorPassFilters(S,c,null))continue;const L=this.createActorData(S,null,o);L.quantity=y.quantity||1,r.push(L)}}}}catch(S){d.log(`Failed to resolve member UUID: ${y.uuid}`,[S])}}if(a&&!(i.length>0)&&!l)return[];if(r.length===0&&!a){let m=[];e.type==="group"?m=(e.system.members||[]).map(S=>S.actor).filter(S=>S):e.type==="encounter"&&(m=(await Promise.all((e.system.members||[]).map(async T=>{try{return await fromUuid(T.uuid)}catch{return null}}))).filter(T=>T));const k=m.map(S=>ae.isBlocked(S)||u&&!Z.doesActorPassFilters(S,c,null)?null:this.createActorData(S,null,o)).filter(S=>S!==null),y=this.createActorData(e,null,o);return y.members=k,y.isGroup=!0,y.isExpanded=((f=o.groupExpansionStates)==null?void 0:f[e.id])??!1,y.memberImages=k.slice(0,4).map(S=>S.img),y.selected=!1,n.push(y),n}if(r.length===0)return[];if(i.length>0)i.forEach(m=>{var S;const k=this.createActorData(e,m,o);k.members=r,k.isGroup=!0,k.isExpanded=((S=o.groupExpansionStates)==null?void 0:S[e.id])??!1,k.memberImages=r.slice(0,4).map(T=>T.img);const y=r.filter(T=>o.selectedActors.has(T.uniqueId));y.length===0?k.selected="false":y.length===r.length?k.selected="true":k.selected="partial",n.push(k)});else{const m=this.createActorData(e,null,o);m.members=r,m.isGroup=!0,m.isExpanded=((p=o.groupExpansionStates)==null?void 0:p[e.id])??!1,m.memberImages=r.slice(0,4).map(y=>y.img);const k=r.filter(y=>o.selectedActors.has(y.uniqueId));k.length===0?m.selected="false":k.length===r.length?m.selected="true":m.selected="partial",n.push(m)}return n}static buildRequestTypes(e){const t=[];for(const[o,s]of Object.entries(W.ROLL_REQUEST_OPTIONS)){const a={id:o,name:game.i18n.localize(`FLASH_ROLLS.rollTypes.${s.name}`)||s.label,rollable:s.subList==null,hasSubList:!!s.subList,selected:e.selectedRequestType===o,expanded:e.accordionStates[o]??!1,subItems:[]};s.subList&&(a.subItems=zt(o,e.selectedActors)),t.push(a)}return t}}const{ApplicationV2:Ko,HandlebarsApplicationMixin:Yo}=foundry.applications.api;var X,We,kt;const be=class be extends Yo(Ko){constructor(t={}){d.log("RollRequestsMenu.constructor",[t]);super(t);D(this,"_onClickOutside",t=>{const o=this.element;if(!o)return;const s=o.querySelector(".actor-filter-tooltip");if(s&&!t.target.closest(".actor-filter-tooltip")&&!t.target.closest("#flash5e-filter-actors")){s.remove();return}this.isLocked||t.target.closest(".flash-rolls-menu")||o.contains(t.target)||this.close()});this.selectedActors=new Set,this.currentTab="pc",this.selectedSubmenu="request-types",this.selectedRequestType=null,this.isLocked=game.user.getFlag(W.ID,"menuLocked")??!1,this.optionsExpanded=game.user.getFlag(W.ID,"menuOptionsExpanded")??!1,this.accordionStates=game.user.getFlag(W.ID,"menuAccordionStates")??{},this.groupExpansionStates=game.user.getFlag(W.ID,"groupExpansionStates")??{},this.isSearchFocused=game.user.getFlag("flash-rolls-5e","searchFocused")??!1,this.actorFilters=game.user.getFlag(W.ID,"actorFilters")??{inCombat:!1,visible:!1,removeDead:!1},this.isDragging=!1,this.isCustomPosition=!1,this.customPosition=Le.loadCustomPosition()}static get DEFAULT_OPTIONS(){_.updateColorScheme();const t=["flash-rolls-menu","themed"];return _.coreColorScheme&&t.push(`theme-${_.coreColorScheme}`),{id:"flash-rolls-menu",classes:t,tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:{},dragDrop:[{dropSelector:".actor-list"}]}}async _prepareContext(t){const o=await super._prepareContext(t),s=await Wo.prepareActorContext(this,o),a=C();return s.menuLayout=_.get(a.menuLayout.tag),s.maxIconsPerRow=_.get(a.maxIconsPerRow.tag)||5,s.enabledModuleIcons=Pe.getEnabledIcons("moduleActions"),s.enabledActorIcons=Pe.getEnabledIcons("actorActions"),s.iconConfigs=Pe.getIconConfigurations(),this._lastPreparedContext=s,s}async _renderFrame(t){const o=await super._renderFrame(t),s=this.customPosition||Le.loadCustomPosition();s!=null&&s.isCustom&&(this.isCustomPosition=!0,this.customPosition=s);const a=document.querySelector("#chat-notifications");return a&&o&&a.insertBefore(o,a.firstChild),o}_onRender(t,o){super._onRender(t,o);const s=document.querySelector("#flash-rolls-menu");if(s){const i=C();_.get(i.compactMode.tag)?s.classList.add("compact"):s.classList.remove("compact");const r=_.get(i.menuLayout.tag);s.setAttribute("data-layout",r),_.get(i.lockMenuPosition.tag)&&this.isLocked?s.classList.add("position-locked"):s.classList.remove("position-locked")}Le.applyCustomPosition(this,this.customPosition);const a=this.element.querySelectorAll(".actor-list");if(this._boundGlobalDragEnd&&document.removeEventListener("dragend",this._boundGlobalDragEnd),a.forEach((i,n)=>{i.removeEventListener("dragover",this._boundDragOver),i.removeEventListener("drop",this._boundDrop),i.removeEventListener("dragenter",this._boundDragEnter),i.removeEventListener("dragleave",this._boundDragLeave),this._boundDragOver=r=>{this._onDragOver(r)},this._boundDrop=r=>{this._onDrop(r)},this._boundDragEnter=r=>{r.preventDefault()},this._boundDragLeave=r=>{ot.handleDragLeave(r)},i.addEventListener("dragover",this._boundDragOver),i.addEventListener("drop",this._boundDrop),i.addEventListener("dragenter",this._boundDragEnter),i.addEventListener("dragleave",this._boundDragLeave)}),this._boundGlobalDragEnd=i=>{this._onGlobalDragEnd(i)},document.addEventListener("dragend",this._boundGlobalDragEnd),Ue(),this.optionsExpanded){const i=this.element.querySelector(".options-toggle"),n=this.element.querySelector("li.options");this.element.querySelector(".options-toggle-btn"),i==null||i.classList.add("expanded"),n==null||n.classList.add("expanded")}this._tokenControlHook=Hooks.on(H.CONTROL_TOKEN,this._onTokenControlChange.bind(this)),this._updateItemHook=Hooks.on(H.UPDATE_ITEM,this._onItemUpdate.bind(this)),this._createItemHook=Hooks.on(H.CREATE_ITEM,this._onItemUpdate.bind(this)),this._deleteItemHook=Hooks.on(H.DELETE_ITEM,this._onItemUpdate.bind(this)),$o.initializeActorDrag(this),this._updateRequestTypesVisibilityNoRender(),ce.attachListeners(this,this.element)}_onTokenControlChange(t,o){this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{const s=new Set(this.selectedActors);this._initializeFromSelectedTokens();const a=new Set([...s,...this.selectedActors]);for(const i of a)this._updateActorSelectionUI(i);this._updateGroupSelectionUI(),this._updateSelectAllState(),this._updateRequestTypesVisibilityNoRender(),o&&(t!=null&&t.id)&&this._scrollToActor(t.id),this._tokenUpdateTimeout=null},100)))}_scrollToActor(t){var n;if(!this.element)return;const o=(n=canvas.tokens)==null?void 0:n.get(t);if(!o)return;const s=o.document.getFlag(R,"groupId");if(s&&this.currentTab==="group"){const r=this.element.querySelector(`.actor.actor-group[data-actor-id="${s}"]`);r&&this._scrollElementIntoView(r);return}let a=this.element.querySelector(`.actor.drag-wrapper[data-id="${t}"]`);if(!a)return;if(a.closest(".group-members")){const r=a.closest(".actor.actor-group");r&&(a=r)}this._scrollElementIntoView(a)}_scrollElementIntoView(t){if(!t||!this.element)return;const o=this.element.querySelector(".main-content ul.actors > li.actor-list");if(!o)return;const s=o.getBoundingClientRect(),a=t.getBoundingClientRect();(this.element.dataset.layout==="horizontal"?a.left<s.left||a.right>s.right:a.top<s.top||a.bottom>s.bottom)&&t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}_onItemUpdate(t,o,s,a){var u,g;if(!this.rendered||!(t.type==="equipment"||((u=o.system)==null?void 0:u.equipped)!==void 0||((g=o.system)==null?void 0:g.attunement)!==void 0))return;const n=t.parent;if(!n||n.documentName!=="Actor")return;const r=this.currentTab,l=Object.entries(n.ownership).some(([f,p])=>{const m=game.users.get(f);return m&&!m.isGM&&p>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER});(r==="pc"&&l||r==="npc"&&!l&&to(n)||r==="group")&&(this._itemUpdateTimeout&&clearTimeout(this._itemUpdateTimeout),this._itemUpdateTimeout=setTimeout(()=>{this.render(),this._itemUpdateTimeout=null},500))}async _onToggleRollRequests(t){return Z.handleToggleRollRequests(t)}async _onToggleSkipDialogs(t){return Z.handleToggleSkipDialogs(t)}async _onToggleGroupRollsMsg(t){return Z.handleToggleGroupRollsMsg(t)}_onToggleSelectAll(t){return Z.handleToggleSelectAll(t,this)}_onToggleActorFilter(t){return Z.handleToggleActorFilter(t,this)}_onToggleLock(t){return Z.handleToggleLock(t,this)}async _onToggleOptions(t){return Z.handleToggleOptions(t,this)}async _onOpenSettings(t){t.preventDefault(),t.stopPropagation(),new lt().render(!0)}_canDragDrop(t){return ot.canDrop(t)}_onDragOver(t){ot.handleDragOver(t,this)}async _onDrop(t){await ot.handleDrop(t,this)}_onGlobalDragEnd(t){ot.handleDragLeave(t)}async close(t={}){return this._boundGlobalDragEnd&&(document.removeEventListener("dragend",this._boundGlobalDragEnd),this._boundGlobalDragEnd=null),super.close(t)}_initializeFromSelectedTokens(){var o,s,a;d.log("_initializeFromSelectedTokens called",{_ignoreTokenControl:this._ignoreTokenControl,currentSelectedActors:Array.from(this.selectedActors),controlledTokensCount:((s=(o=canvas.tokens)==null?void 0:o.controlled)==null?void 0:s.length)||0});const t=((a=canvas.tokens)==null?void 0:a.controlled)||[];this.selectedActors.clear();for(const i of t)if(i.actor){const n=i.id;this.selectedActors.add(n)}}async _onTabClick(t){const o=t.currentTarget.dataset.tab;d.log("_onTabClick #0",[o]),this.selectedRequestType=null,this.currentTab=o,await this.render()}async _onTabDoubleClick(t){var o;t.preventDefault(),t.stopPropagation(),this._ignoreTokenControl=!0,this.selectedActors.clear(),(o=canvas.tokens)==null||o.releaseAll(),this.selectedRequestType=null,setTimeout(()=>{this._ignoreTokenControl=!1},200),await this.render(),this._updateRequestTypesVisibility()}async _onSubmenuTabClick(t){const o=t.currentTarget.dataset.tab;if(d.log("_onSubmenuTabClick",[o]),o===this.selectedSubmenu)return;this.selectedSubmenu=o,await this.render();const s=this.element.querySelector(".request-types-accordion");s&&this.selectedActors.size>0&&s.classList.add("hover-visible")}async _onStatusEffectClick(t){t.preventDefault(),t.stopPropagation();const o=t.currentTarget.dataset.id;d.log("_onStatusEffectClick",[o]),await co.toggleStatusOnSelected(o,this)}_onActorClick(t){if(t.target.closest(".actor-select"))return;const o=t.currentTarget,s=o.dataset.id,a=o.dataset.actorId,i=o.dataset.tokenId;o.classList.contains("actor-group")?this._toggleGroupSelection(a):this._toggleActorSelection(s,a,i)}_toggleActorSelection(t,o,s){return Z.toggleActorSelection(t,o,s,this)}async _toggleGroupSelection(t){const o=game.actors.get(t);if(!o||o.type!=="group"&&o.type!=="encounter")return;const s=game.scenes.current,i=(o.getFlag(R,"tokenAssociationsByScene")||{})[s==null?void 0:s.id]||{},n=[],r=Object.entries(i).some(([c,u])=>!Array.isArray(u)||u.length===0?!1:u.some(g=>{try{const f=fromUuidSync(g);return f&&f.actorId===c&&f.parent===s}catch{return!1}}));if(o.type==="group"){for(const c of o.system.members||[])if(c.actor){const u=c.actor.id,g=i[u]||[];if(r&&g.length>0)for(const f of g)try{const p=fromUuidSync(f);p&&p.actorId===c.actor.id&&p.parent===s&&n.push({actor:c.actor,uniqueId:p.id})}catch(p){d.log(`Failed to resolve token UUID: ${f}`,[p])}else if(!r){const f=(s==null?void 0:s.tokens.filter(p=>p.actorId===c.actor.id))||[];f.length>0?f.forEach(p=>{n.push({actor:c.actor,uniqueId:p.id})}):n.push({actor:c.actor,uniqueId:c.actor.id})}}}else if(o.type==="encounter")for(const c of o.system.members||[])try{const u=await fromUuid(c.uuid);if(u){const g=u.id,f=i[g]||[];if(r&&f.length>0)for(const p of f)try{const m=fromUuidSync(p);m&&m.actorId===u.id&&m.parent===s&&n.push({actor:u,uniqueId:m.id})}catch(m){console.warn(`Failed to resolve token UUID: ${p}`,m)}else if(!r){const p=(s==null?void 0:s.tokens.filter(m=>m.actorId===u.id))||[];p.length>0?p.forEach(m=>{n.push({actor:u,uniqueId:m.id})}):n.push({actor:u,uniqueId:u.id})}}}catch(u){console.warn(`Failed to resolve member UUID: ${c.uuid}`,u)}if(n.length===0)return;const l=n.every(c=>this.selectedActors.has(c.uniqueId));for(const c of n){const u=c.uniqueId!==c.actor.id?c.uniqueId:null;l?this.selectedActors.has(c.uniqueId)&&this._toggleActorSelection(c.uniqueId,c.actor.id,u):this.selectedActors.has(c.uniqueId)||this._toggleActorSelection(c.uniqueId,c.actor.id,u)}this._updateGroupSelectionUI(t,n)}_updateActorSelectionUI(t){return Z.updateActorSelectionUI(t,this)}_updateGroupSelectionUI(t=null,o=null){t&&o?this._updateSingleGroupSelection(t,o):((this._lastPreparedContext||{}).groups||[]).forEach(i=>{i.isGroup&&i.members&&this._updateSingleGroupSelection(i.id,i.members)})}_updateSingleGroupSelection(t,o){this.element.querySelectorAll(`[data-actor-id="${t}"].actor-group`).forEach(a=>{const i=o.filter(r=>this.selectedActors.has(r.uniqueId)).length;let n;i===0?n="false":i===o.length?n="true":n="partial",a.setAttribute("data-group-selected",n),a.classList.remove("selected")})}_updateRequestTypesVisibility(){return Z.updateRequestTypesVisibility(this)}_updateRequestTypesVisibilityNoRender(){return Z.updateRequestTypesVisibilityNoRender(this)}_updateSelectAllState(){return Z.updateSelectAllState(this)}_onSearchInput(t){const o=t.target.value.toLowerCase().trim();if(this.selectedSubmenu==="request-types"){const s=this.element.querySelector(".request-types");if(!s)return;s.querySelectorAll(".request-type-item").forEach(i=>{var c;const n=((c=i.querySelector(".request-type-name"))==null?void 0:c.textContent.toLowerCase())||"",r=i.querySelectorAll(".sub-item");let l=!1;if(r.length>0){r.forEach(f=>{var k;const m=(((k=f.querySelector(".sub-item-name"))==null?void 0:k.textContent.toLowerCase())||"").includes(o);f.classList.toggle("hidden",!m),m&&(l=!0)});const u=n.includes(o),g=o===""||u||l;if(i.classList.toggle("hidden",!g),o&&l){const f=i.querySelector(".roll-types-nested"),p=i.querySelector(".accordion-toggle");f&&p&&(f.style.display="block",p.classList.add("expanded"))}}else{const u=o===""||n.includes(o);i.classList.toggle("hidden",!u)}})}else if(this.selectedSubmenu==="status-effects"){const s=this.element.querySelector(".status-effects");if(!s)return;s.querySelectorAll(".status-effect").forEach(i=>{var c,u;const n=((c=i.querySelector(".status-effect-name"))==null?void 0:c.textContent.toLowerCase())||"",r=((u=i.dataset.id)==null?void 0:u.toLowerCase())||"",l=o===""||n.includes(o)||r.includes(o);i.classList.toggle("hidden",!l)})}}async _onAccordionToggle(t){t.stopPropagation();const s=t.target.closest(".request-type-header").closest(".request-type-item"),a=s.dataset.id,i=s.querySelector(".accordion-toggle"),n=s.querySelector(".roll-types-nested");if(!n)return;const r=i.classList.contains("expanded");i.classList.toggle("expanded",!r),n.style.display=r?"none":"flex",this.accordionStates[a]=!r,await game.user.setFlag(W.ID,"menuAccordionStates",this.accordionStates)}async _onRequestTypeClick(t){const s=t.currentTarget.dataset.id,a=W.ROLL_REQUEST_OPTIONS[s];if(!a){d.error("Unknown request type:",[s]);return}this.selectedRequestType===s?this.selectedRequestType=null:this.selectedRequestType=s,a.subList?await this.render():this.selectedRequestType&&this._triggerRoll(s,null)}_onRollTypeClick(t){d.log("_onRollTypeClick");const o=t.currentTarget.dataset.id,a=t.currentTarget.dataset.parent||this.selectedRequestType;this._triggerRoll(a,o)}async _onMacroButtonClick(t){d.log("_onMacroButtonClick");const o=t.currentTarget,s=o.dataset.id||null,a=o.dataset.parent;let i,n;if(a?(i=a,n=s):(i=s,n=null),!i){I.notify("warn","No roll type selected for macro creation");return}const r=Array.from(this.selectedActors);if(r.length===0){I.notify("warn","No actors selected for macro creation");return}const l={requestType:i,rollKey:n,actorIds:r,config:{}};try{await I.createMacro(l)}catch(c){d.error("Failed to create macro",[c]),ui.notifications.error("Failed to create macro: "+c.message)}}async _orchestrateRollsForActors(t,o,s,a,i,n){return Ye.orchestrateRollsForActors(t,o,s,a,i,n)}async _handleHitDieRefill(t){return Ye.handleHitDieRefill(t)}async _triggerRoll(t,o){return Ye.triggerRoll(t,o,this)}async _sendRollRequestToPlayer(t,o,s,a,i,n=!1,r=null){return Ye.sendRollRequestToPlayer(t,o,s,a,i,n,r)}_showConsolidatedNotification(t,o,s){return Ye.showConsolidatedNotification(t,o,s)}async _handleGMRolls(t,o,s,a){return at.handleGMRolls(t,o,s,a)}async _handleGMRollsWithTokens(t,o,s,a){return at.handleGMRollsWithTokens(t,o,s,a)}async _initiateRollForToken(t,o,s,a,i){return at.initiateRollForToken(t,o,s,a,i)}async _initiateRoll(t,o,s,a){return at.initiateRoll(t,o,s,a)}async _onClose(t){if(d.log("_onClose",[t]),!!this.element){if(this.isCustomPosition&&this.element.parentElement===document.body){const o=document.querySelector("#chat-notifications");o&&o.insertBefore(this.element,o.firstChild),this.element.style.position="",this.element.style.inset="",this.element.style.top="",this.element.style.left="",this.element.style.right="",this.element.style.bottom="",this.element.classList.remove("custom-position")}await super._onClose(t),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),game.user.setFlag(R,"searchFocused",!1),this._cleanupHooks(),this._cleanupTimeouts(),B(be,X)===this&&ye(be,X,null)}}setPosition(t={}){return d.log("setPosition"),this}_cleanupHooks(){[{hook:H.CONTROL_TOKEN,property:"_tokenControlHook"},{hook:H.UPDATE_ITEM,property:"_updateItemHook"},{hook:H.CREATE_ITEM,property:"_createItemHook"},{hook:H.DELETE_ITEM,property:"_deleteItemHook"}].forEach(({hook:o,property:s})=>{this[s]&&(Hooks.off(o,this[s]),this[s]=null)})}_cleanupTimeouts(){["_tokenUpdateTimeout","_actorUpdateTimeout","_itemUpdateTimeout"].forEach(o=>{this[o]&&(clearTimeout(this[o]),this[o]=null)})}static toggle(){document.querySelectorAll("#flash-rolls-menu").forEach(o=>{o.remove()}),B(this,X)?B(this,X).rendered?B(this,X).close():(B(this,X)._initializeFromSelectedTokens(),B(this,X).render(!0)):(ye(this,X,new be),B(this,X)._initializeFromSelectedTokens(),B(this,X).render(!0))}static refreshIfOpen(t=!1){if(!(!B(this,X)||!B(this,X).rendered)){if(t){this._performRefresh();return}B(this,We)&&clearTimeout(B(this,We)),ye(this,We,setTimeout(()=>{this._performRefresh(),ye(this,We,null)},B(this,kt)))}}static _performRefresh(){!B(this,X)||!B(this,X).rendered||B(this,X).render()}static getInstance(){return B(this,X)}getSelectedActorElements(){return this.element?Array.from(this.element.querySelectorAll(".actor.drag-wrapper.selected")):[]}static showOnLoadIfEnabled(){var s;const t=C();_.get(t.showMenuOnLoad.tag)&&game.user.isGM&&(document.querySelectorAll("#flash-rolls-menu").forEach(i=>{i.remove()}),B(this,X)?B(this,X).rendered||B(this,X)._initializeFromSelectedTokens():(ye(this,X,new be),B(this,X)._initializeFromSelectedTokens()),(s=B(this,X))==null||s.render(!0),B(this,X)&&(B(this,X).isLocked=!0))}};X=new WeakMap,We=new WeakMap,kt=new WeakMap,ne(be,X,null),ne(be,We,null),ne(be,kt,250),D(be,"PARTS",{main:{template:`modules/${W.ID}/templates/requests-menu.hbs`}});let x=be;class he{static async placeTokensForSelectedActors(e){if(!game.user.isGM){I.notify("warn","Only GMs can place tokens");return}if(e.selectedActors.size===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelectedForPlacement"));return}if(this._isPlacingTokens){I.notify("warn","Token placement already in progress");return}const t=[];for(const o of e.selectedActors){const s=Y(o);if(s)if(s.type==="group"||s.type==="encounter"){const a=s.system.members||[];for(const i of a){const n=i.actor||(i.uuid?await fromUuid(i.uuid):null);n&&t.push(n)}}else t.push(s)}if(t.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelectedForPlacement"));return}this._actorsToPlace=t,this._placementIndex=0,this._isPlacingTokens=!0,await this._createPreviewTokens(),this._attachCanvasHandlers(),I.notify("info",`Click to place ${t.length} token(s) one at a time, right-click to skip current token`)}static async _createPreviewTokens(){this._previewTokens=[];for(const e of this._actorsToPlace){const t=e.isToken?e.baseActor:e,s={...(await t.getTokenDocument()).toObject(),x:0,y:0,alpha:.5,actorLink:!1};this._previewTokens.push({actor:t,data:s})}}static _attachCanvasHandlers(){this._canvasMoveHandler=e=>this._onCanvasMouseMove(e),this._canvasClickHandler=e=>this._onCanvasClick(e),this._canvasRightClickHandler=e=>this._onCanvasRightClick(e),this._canvasRightDownHandler=e=>{this._rightMouseDown=!0},this._canvasRightUpHandler=e=>{this._rightMouseDown=!1},canvas.stage.on("mousemove",this._canvasMoveHandler),canvas.stage.on("click",this._canvasClickHandler),canvas.stage.on("rightclick",this._canvasRightClickHandler),canvas.stage.on("rightdown",this._canvasRightDownHandler),canvas.stage.on("rightup",this._canvasRightUpHandler)}static async _onCanvasMouseMove(e){var n;if(!this._isPlacingTokens||this._placementIndex>=this._previewTokens.length)return;const t=e.data.getLocalPosition(canvas.tokens),o=canvas.grid.getSnappedPoint({x:t.x,y:t.y},{mode:CONST.GRID_SNAPPING_MODES.CENTER});if((n=canvas.controls)!=null&&n.children)try{const r=Array.from(canvas.controls.children);for(const l of r)l._flashRollsPlacementPreview&&(canvas.controls.removeChild(l),l.destroy&&l.destroy())}catch(r){d.warn("Error clearing preview graphics",r)}const a=this._previewTokens[this._placementIndex].data,i=canvas.grid.size;try{const r=await foundry.canvas.loadTexture(a.texture.src),l=new PIXI.Sprite(r),c=a.width*i,u=a.height*i;l.anchor.set(0),l.x=o.x-c/2,l.y=o.y-u/2,l.width=c,l.height=u,l.alpha=.5,l.tint=52479,l._flashRollsPlacementPreview=!0,canvas.controls&&canvas.controls.addChild(l);const g=`${this._placementIndex+1}/${this._previewTokens.length}`,f=new PIXI.Text(g,{fontSize:20,fill:16777215,stroke:0,strokeThickness:4});f.anchor.set(.5),f.x=o.x,f.y=o.y-u/2-20,f._flashRollsPlacementPreview=!0,canvas.controls&&canvas.controls.addChild(f)}catch(r){d.warn("Error drawing placement preview",r)}}static async _onCanvasClick(e){if(!this._isPlacingTokens||this._placementIndex>=this._previewTokens.length)return;const t=e.data.getLocalPosition(canvas.tokens),o=canvas.grid.getSnappedPoint({x:t.x,y:t.y},{mode:CONST.GRID_SNAPPING_MODES.CENTER}),s=canvas.grid.size,a=this._previewTokens[this._placementIndex],i={...a.data,x:o.x-a.data.width*s/2,y:o.y-a.data.height*s/2,alpha:1,actorLink:!1};try{if(await canvas.scene.createEmbeddedDocuments("Token",[i]),this._placementIndex++,this._placementIndex>=this._previewTokens.length){const n=this._previewTokens.length;this._cleanup(),I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.tokensPlaced",{count:n}))}}catch(n){d.error("Failed to create token",[n,a.actor.name])}}static _onCanvasRightClick(e){this._isPlacingTokens&&(this._placementIndex>=this._previewTokens.length||this._rightMouseDown||(e.stopPropagation(),this._previewTokens.splice(this._placementIndex,1),this._actorsToPlace.splice(this._placementIndex,1),this._previewTokens.length===0||this._placementIndex>=this._previewTokens.length?(this._cleanup(),I.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.tokenPlacementCancelled"))):this._clearPreviewGraphics()))}static _clearPreviewGraphics(){var e;if((e=canvas.controls)!=null&&e.children)try{const t=Array.from(canvas.controls.children);for(const o of t)o._flashRollsPlacementPreview&&(canvas.controls.removeChild(o),o.destroy&&o.destroy())}catch(t){d.warn("Error clearing preview graphics",t)}}static _cleanup(){this._isPlacingTokens=!1,this._previewTokens=[],this._actorsToPlace=[],this._placementIndex=0,this._canvasMoveHandler&&(canvas.stage.off("mousemove",this._canvasMoveHandler),this._canvasMoveHandler=null),this._canvasClickHandler&&(canvas.stage.off("click",this._canvasClickHandler),this._canvasClickHandler=null),this._canvasRightClickHandler&&(canvas.stage.off("rightclick",this._canvasRightClickHandler),this._canvasRightClickHandler=null),this._canvasRightDownHandler&&(canvas.stage.off("rightdown",this._canvasRightDownHandler),this._canvasRightDownHandler=null),this._canvasRightUpHandler&&(canvas.stage.off("rightup",this._canvasRightUpHandler),this._canvasRightUpHandler=null),this._rightMouseDown=!1,this._clearPreviewGraphics()}static isPlacing(){return this._isPlacingTokens}static async placeTokensAtLocation(e,t){if(!game.user.isGM){I.notify("warn","Only GMs can place tokens");return}if(!e||e.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelectedForPlacement"));return}if(!t||typeof t.x!="number"||typeof t.y!="number"){ui.notifications.error("Invalid location provided for token placement");return}const o=[];for(const n of e){const r=Y(n);if(!r){d.warn(`Could not find actor for ID: ${n}`);continue}if(r.type==="group"||r.type==="encounter"){const l=r.system.members||[];for(const c of l){const u=c.actor||(c.uuid?await fromUuid(c.uuid):null);u&&o.push(u)}}else o.push(r)}if(o.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelectedForPlacement")),d.warn("No valid actors found for placement",e);return}const s=canvas.grid.getSnappedPoint({x:t.x,y:t.y},{mode:CONST.GRID_SNAPPING_MODES.CENTER}),a=canvas.grid.size,i=[];for(const n of o){const r=n.isToken?n.baseActor:n,l=await r.getTokenDocument(),c={...l.toObject(),x:s.x-l.width*a/2,y:s.y-l.height*a/2,alpha:1,actorLink:!1};try{const u=await canvas.scene.createEmbeddedDocuments("Token",[c]);i.push(...u)}catch(u){d.error("Failed to create token",[u,r.name])}}}}D(he,"_isPlacingTokens",!1),D(he,"_previewTokens",[]),D(he,"_actorsToPlace",[]),D(he,"_placementIndex",0),D(he,"_canvasClickHandler",null),D(he,"_canvasRightClickHandler",null),D(he,"_canvasMoveHandler",null),D(he,"_canvasRightDownHandler",null),D(he,"_canvasRightUpHandler",null),D(he,"_rightMouseDown",!1);const Jo=Object.freeze(Object.defineProperty({__proto__:null,TokenPlacementManager:he},Symbol.toStringTag,{value:"Module"}));class Q{static async teleportSelectedTokens(e){if(!game.user.isGM){I.notify("warn","Only GMs can teleport tokens");return}if(e.selectedActors.size===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensSelectedForTeleport"));return}if(this._isTeleporting){I.notify("warn","Teleportation already in progress");return}const t=[],o=[];for(const s of e.selectedActors){const a=Y(s);if(!a)continue;const i=game.actors.get(s)?null:s,n=i?canvas.tokens.get(i):canvas.tokens.placeables.find(r=>{var l;return((l=r.actor)==null?void 0:l.id)===a.id});n&&(t.push(n),o.push({id:n.id,sceneId:canvas.scene.id,x:n.document.x,y:n.document.y,width:n.document.width,height:n.document.height,documentData:n.document.toObject()}))}if(t.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensSelectedForTeleport"));return}this._tokensToTeleport=t,this._tokenDataToTeleport=o,this._sourceScene=canvas.scene,this._targetScene=canvas.scene,this._isTeleporting=!0,await this._enterPlacementMode()}static _getTokensFromData(){const e=[];for(const t of this._tokenDataToTeleport){const o=game.scenes.get(t.sceneId);if(!o)continue;const s=o.tokens.get(t.id);if(s){const a=canvas.scene.id===t.sceneId?canvas.tokens.get(t.id):null;e.push(a||{document:s,id:t.id})}}return e}static async _enterPlacementMode(e=!0){var s;this._targetScene.id===this._sourceScene.id&&this._getTokensFromData().forEach(i=>{i.alpha!==void 0&&(i.alpha=.5)}),this._attachCanvasHandlers();const t=((s=this._tokenDataToTeleport)==null?void 0:s.length)||0,o=this._targetScene.name;d.log(`Teleport ready with ${t} tokens on scene: ${o}`,this._tokenDataToTeleport),e&&I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.teleportReady",{count:t}))}static async _onSceneChange(){var e,t,o,s,a,i;if(!this._isTeleporting){d.log("_onSceneChange called but not teleporting");return}if(((e=this._targetScene)==null?void 0:e.id)===((t=canvas.scene)==null?void 0:t.id)){d.log("_onSceneChange - Same scene, skipping");return}d.log("_onSceneChange - Before cleanup",{currentScene:(o=canvas.scene)==null?void 0:o.name,targetScene:(s=this._targetScene)==null?void 0:s.name,tokenCount:(a=this._tokenDataToTeleport)==null?void 0:a.length,hasHandlers:{move:!!this._canvasMoveHandler,click:!!this._canvasClickHandler,rightclick:!!this._canvasRightClickHandler}}),this._targetScene=canvas.scene,d.log(`Scene changed to ${this._targetScene.name} during teleport`,this._tokenDataToTeleport),this._removeCanvasHandlers(),this._clearPreviewGraphics(),d.log("_onSceneChange - About to re-enter placement mode",{canvasReady:!!(canvas!=null&&canvas.stage),sceneId:(i=this._targetScene)==null?void 0:i.id}),setTimeout(async()=>{await this._enterPlacementMode(!1),d.log("_onSceneChange - After re-entering placement mode",{hasHandlers:{move:!!this._canvasMoveHandler,click:!!this._canvasClickHandler,rightclick:!!this._canvasRightClickHandler}})},100)}static _attachCanvasHandlers(){if(d.log("Attaching canvas handlers for teleportation"),this._canvasMoveHandler=e=>this._onCanvasMouseMove(e),this._canvasClickHandler=e=>this._onCanvasClick(e),this._canvasRightClickHandler=e=>this._onCanvasRightClick(e),this._canvasRightDownHandler=e=>{const t=e.data.getLocalPosition(canvas.tokens);this._rightMouseDownPosition={x:t.x,y:t.y},this._hasDragged=!1},this._canvasRightUpHandler=e=>{setTimeout(()=>{this._rightMouseDownPosition=null,this._hasDragged=!1},300)},this._escapeKeyHandler=e=>{e.key==="Escape"&&this._isTeleporting&&(e.preventDefault(),e.stopPropagation(),d.log("Cancelling teleport via ESC key"),this._cleanup(),I.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.teleportCancelled")))},!(canvas!=null&&canvas.stage)){d.warn("Canvas stage not available");return}canvas.stage.on("mousemove",this._canvasMoveHandler),canvas.stage.on("click",this._canvasClickHandler),canvas.stage.on("rightclick",this._canvasRightClickHandler),canvas.stage.on("rightdown",this._canvasRightDownHandler),canvas.stage.on("rightup",this._canvasRightUpHandler),document.addEventListener("keydown",this._escapeKeyHandler),d.log("Canvas handlers attached successfully")}static async _onCanvasMouseMove(e){var l;if(this._rightMouseDownPosition){const c=e.data.getLocalPosition(canvas.tokens);Math.sqrt(Math.pow(c.x-this._rightMouseDownPosition.x,2)+Math.pow(c.y-this._rightMouseDownPosition.y,2))>5&&(this._hasDragged=!0)}if(!this._isTeleporting||!this._targetScene||this._tokenDataToTeleport.length===0||this._isPerformingTeleport||!(canvas!=null&&canvas.controls))return;const t=e.data.getLocalPosition(canvas.tokens),o=this._snapToHalfGrid(t.x,t.y);if((l=canvas.controls)!=null&&l.children)try{const c=Array.from(canvas.controls.children);for(const u of c)u!==this._cursorIndicator&&u._flashRollsTeleportPreview&&(canvas.controls.removeChild(u),u.destroy&&u.destroy())}catch(c){d.warn("Error clearing preview graphics",c)}const s=this._sourceScene.grid.size,a=canvas.grid.size,i=this._calculateBoundingBox(this._tokenDataToTeleport,s),n=i.x+i.width/2,r=i.y+i.height/2;this._targetScene.id,this._sourceScene.id;try{for(let c=0;c<this._tokenDataToTeleport.length;c++){const u=this._tokenDataToTeleport[c],g=this._sourceScene.tokens.get(u.id);if(!g)continue;const f=u.width*s,p=u.height*s,m=u.x+f/2,k=u.y+p/2,y=(m-n)/s,S=(k-r)/s,T=o.x+y*a,b=o.y+S*a,v=u.width*a,L=u.height*a,E=T-v/2,O=b-L/2,w=await foundry.canvas.loadTexture(g.texture.src),M=new PIXI.Sprite(w);M.anchor.set(0),M.x=E,M.y=O,M.width=v,M.height=L,M.alpha=.5,M.tint=52479,M._flashRollsTeleportPreview=!0,canvas.controls.addChild(M)}}catch(c){d.warn("Error drawing teleport preview",c);return}}static async _onCanvasClick(e){if(!this._isTeleporting||this._isPerformingTeleport)return;const t=e.data.getLocalPosition(canvas.tokens),o=this._snapToHalfGrid(t.x,t.y);await this._performTeleport(o)}static async _performTeleport(e){this._isPerformingTeleport=!0;const t=this._sourceScene.grid.size,o=this._calculateBoundingBox(this._tokenDataToTeleport,t),s=o.x+o.width/2,a=o.y+o.height/2,i=this._targetScene.id===this._sourceScene.id;try{i?await this._performSameSceneTeleport(e,s,a,t):await this._performCrossSceneTeleport(e,s,a,t)}catch(n){d.error("Failed to teleport tokens",[n]),ui.notifications.error("Failed to teleport tokens"),this._isPerformingTeleport=!1,this._cleanup()}}static async _performSameSceneTeleport(e,t,o,s){const a=C(),i=_.get(a.teleportAnimationPath.tag),n=this._getTokensFromData();if(n.length===0)return I.notify("warn","No valid tokens found for teleportation"),this._cleanup(),[];const r=this._tokenDataToTeleport.map(f=>({_id:f.id,alpha:.3}));await this._sourceScene.updateEmbeddedDocuments("Token",r,{animate:!1}),(i||this._hasJB2A())&&await this._playDepartureAnimations(n);const l=[],c=[];for(const f of this._tokenDataToTeleport){const p=f.width*s,m=f.height*s,k=f.x+p/2,y=f.y+m/2,S=k-t,T=y-o,b=e.x+S,v=e.y+T,L=this._sourceScene.grid.getSnappedPoint({x:b,y:v},{mode:CONST.GRID_SNAPPING_MODES.CENTER}),E=L.x-p/2,O=L.y-m/2;l.push({_id:f.id,x:E,y:O,alpha:.3}),c.push({x:L.x,y:L.y})}await this._sourceScene.updateEmbeddedDocuments("Token",l,{animate:!1}),(i||this._hasJB2A())&&await this._playArrivalAnimations(c);const u=this._tokenDataToTeleport.map(f=>({_id:f.id,alpha:1}));await this._sourceScene.updateEmbeddedDocuments("Token",u,{animate:!1});const g=this._tokenDataToTeleport.map(f=>f.id);return this._tokenDataToTeleport.length,this._cleanup(),g}static async _performCrossSceneTeleport(e,t,o,s){const a=C(),i=_.get(a.teleportAnimationPath.tag),n=this._getTokensFromData();if(n.length===0)return I.notify("warn","No valid tokens found for teleportation"),this._cleanup(),[];const r=this._tokenDataToTeleport.map(p=>({_id:p.id,alpha:.3}));await this._sourceScene.updateEmbeddedDocuments("Token",r,{animate:!1}),(i||this._hasJB2A())&&await this._playDepartureAnimations(n),await this._sourceScene.deleteEmbeddedDocuments("Token",this._tokenDataToTeleport.map(p=>p.id));const l=this._targetScene.grid.size,c=[],u=[];for(const p of this._tokenDataToTeleport){const m=p.width*s,k=p.height*s,y=p.x+m/2,S=p.y+k/2,T=(y-t)/s,b=(S-o)/s,v=e.x+T*l,L=e.y+b*l,E=this._targetScene.grid.getSnappedPoint({x:v,y:L},{mode:CONST.GRID_SNAPPING_MODES.CENTER}),O=p.width*l,w=p.height*l,M=E.x-O/2,F=E.y-w/2,U=foundry.utils.duplicate(p.documentData);U.x=M,U.y=F,c.push(U),u.push({x:E.x,y:E.y})}const g=await this._targetScene.createEmbeddedDocuments("Token",c.map(p=>({...p,alpha:.3})));(i||this._hasJB2A())&&await this._playArrivalAnimations(u),await this._targetScene.updateEmbeddedDocuments("Token",g.map(p=>({_id:p.id,alpha:1})));const f=g.map(p=>p.id);return this._cleanup(),f}static async _playTeleportAnimations(e,t,o){await this._playDepartureAnimations(e),await new Promise(a=>setTimeout(a,100));const s=e.map(a=>{const i=a.document.x-o.x,n=a.document.y-o.y;return{x:t.x+i+a.document.width*canvas.grid.size/2,y:t.y+n+a.document.height*canvas.grid.size/2}});await this._playArrivalAnimations(s)}static async _playDepartureAnimations(e){const t=C();let o=_.get(t.teleportAnimationPath.tag);if(!o&&this._hasJB2A()&&(o=await this._getDefaultJB2APath()),!!o&&this._hasSequencer()){const s=canvas.grid.size;for(const a of e){const i=a.document.x+a.document.width*s/2,n=a.document.y+a.document.height*s/2;new Sequence().effect().file(o).atLocation({x:i,y:n}).scale(.5).fadeIn(50).fadeOut(100).forUsers(game.users.map(r=>r.id)).play()}await new Promise(a=>setTimeout(a,400))}}static async _playArrivalAnimations(e){const t=C();let o=_.get(t.teleportAnimationPath.tag);if(!o&&this._hasJB2A()&&(o=await this._getDefaultJB2APath()),!!o&&this._hasSequencer()){for(const s of e)new Sequence().effect().file(o).atLocation(s).scale(.5).fadeIn(50).fadeOut(100).forUsers(game.users.map(a=>a.id)).play();await new Promise(s=>setTimeout(s,250))}}static _getJB2AModule(){return game.modules.get("JB2A_DnD5e")||game.modules.get("jb2a_patreon")}static _hasJB2A(){const e=this._getJB2AModule();return e==null?void 0:e.active}static _hasSequencer(){var e;return(e=game.modules.get("sequencer"))==null?void 0:e.active}static async _getDefaultJB2APath(){var t;if(this._hasSequencer()&&((t=window.Sequencer)!=null&&t.Database)){const o=["jb2a.teleportation.circle.blue","jb2a.teleport.circle.blue","jb2a.teleportation.blue"];for(const s of o)if(Sequencer.Database.entryExists(s))return d.log(`Found JB2A teleport animation via Sequencer: ${s}`),s}const e=this._getJB2AModule();if(e!=null&&e.active){const s=`modules/${e.id}/Library/Generic/Energy/Teleport/Teleport01_01_Regular_Blue_500x300.webm`;return d.log(`Using JB2A teleport animation file path: ${s}`),s}return d.warn("JB2A module not found, animations disabled"),null}static _createCursorIndicator(){var a;if(!((a=canvas==null?void 0:canvas.controls)!=null&&a.ruler)){d.warn("Canvas controls not ready for cursor indicator");return}if(this._cursorIndicator&&(this._cursorIndicator.destroy({children:!0}),this._cursorIndicator=null),this._cursorAnimation&&(clearInterval(this._cursorAnimation),this._cursorAnimation=null),!(canvas!=null&&canvas.controls)){d.warn("Canvas controls not available for cursor indicator");return}this._cursorIndicator=new PIXI.Container,this._cursorIndicator.zIndex=1e3,canvas.controls.addChild(this._cursorIndicator);const e=new PIXI.Graphics;e.lineStyle(3,65280,1),e.drawCircle(0,0,20),this._cursorIndicator.addChild(e);const t=new PIXI.Graphics;t.lineStyle(3,65280,.6),t.drawCircle(0,0,30),this._cursorIndicator.addChild(t);const o=new PIXI.Graphics;o.lineStyle(3,65280,.3),o.drawCircle(0,0,40),this._cursorIndicator.addChild(o);let s=0;this._cursorAnimation=setInterval(()=>{if(!this._cursorIndicator||!this._cursorIndicator.parent){this._cursorAnimation&&(clearInterval(this._cursorAnimation),this._cursorAnimation=null);return}s+=.05;const i=1+Math.sin(s)*.3,n=1+Math.sin(s+1)*.3,r=1+Math.sin(s+2)*.3;e.alpha=.8+Math.sin(s)*.2,t.alpha=.5+Math.sin(s+1)*.3,o.alpha=.3+Math.sin(s+2)*.2,e.scale.set(i),t.scale.set(n),o.scale.set(r)},50),d.log("Cursor indicator created and animation started")}static _onCanvasRightClick(e){if(this._isTeleporting){if(this._hasDragged){d.log("Ignoring right-click due to drag");return}e.stopPropagation(),d.log("Cancelling teleport via right-click"),this._cleanup(),I.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.teleportCancelled"))}}static _calculateCenterPoint(e){if(e.length===0)return{x:0,y:0};const t=e.reduce((o,s)=>({x:o.x+s.x,y:o.y+s.y}),{x:0,y:0});return{x:t.x/e.length,y:t.y/e.length}}static _snapToHalfGrid(e,t){const s=canvas.grid.size/2,a=Math.round(e/s)*s,i=Math.round(t/s)*s;return{x:a,y:i}}static _calculateBoundingBox(e,t){if(e.length===0)return{x:0,y:0,width:0,height:0};let o=1/0,s=1/0,a=-1/0,i=-1/0;for(const n of e){const r=n.width*t,l=n.height*t;o=Math.min(o,n.x),s=Math.min(s,n.y),a=Math.max(a,n.x+r),i=Math.max(i,n.y+l)}return{x:o,y:s,width:a-o,height:i-s}}static _calculateRelativePositions(e){const t=e.map(s=>({x:s.document.x,y:s.document.y})),o=this._calculateCenterPoint(t);return e.map(s=>({token:s,relativeX:s.document.x-o.x,relativeY:s.document.y-o.y}))}static _removeCanvasHandlers(){var e,t,o,s,a;this._canvasMoveHandler&&((e=canvas.stage)==null||e.off("mousemove",this._canvasMoveHandler),this._canvasMoveHandler=null),this._canvasClickHandler&&((t=canvas.stage)==null||t.off("click",this._canvasClickHandler),this._canvasClickHandler=null),this._canvasRightClickHandler&&((o=canvas.stage)==null||o.off("rightclick",this._canvasRightClickHandler),this._canvasRightClickHandler=null),this._canvasRightDownHandler&&((s=canvas.stage)==null||s.off("rightdown",this._canvasRightDownHandler),this._canvasRightDownHandler=null),this._canvasRightUpHandler&&((a=canvas.stage)==null||a.off("rightup",this._canvasRightUpHandler),this._canvasRightUpHandler=null),this._escapeKeyHandler&&(document.removeEventListener("keydown",this._escapeKeyHandler),this._escapeKeyHandler=null)}static _cleanup(){this._getTokensFromData().forEach(t=>{t.alpha!==void 0&&(t.alpha=1)}),this._clearPreviewGraphics(),this._isTeleporting=!1,this._isPerformingTeleport=!1,this._tokensToTeleport=[],this._tokenDataToTeleport=[],this._sourceScene=null,this._targetScene=null,this._rightMouseDown=!1,this._rightMouseDownPosition=null,this._removeCanvasHandlers()}static _clearPreviewGraphics(){var e;if((e=canvas==null?void 0:canvas.controls)!=null&&e.children){try{const t=Array.from(canvas.controls.children);for(const o of t)o._flashRollsTeleportPreview&&(canvas.controls.removeChild(o),o.destroy())}catch(t){d.warn("Error clearing preview graphics",t)}this._rightMouseDown=!1,this._rightMouseDownPosition=null}}static isTeleporting(){return this._isTeleporting}static async teleportToDestination(e,t,o){if(!game.user.isGM){I.notify("warn","Only GMs can teleport tokens");return}if(this._isPerformingTeleport&&(d.log("Teleport already in progress, queueing..."),await new Promise(p=>{const m=setInterval(()=>{this._isPerformingTeleport||(clearInterval(m),p())},50)})),!e||e.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensSelectedForTeleport"));return}if(!t||!o||typeof o.x!="number"||typeof o.y!="number"){ui.notifications.error("Invalid destination scene or location provided for teleportation");return}let s;if(typeof t=="string"){if(s=game.scenes.get(t)||game.scenes.getName(t),!s){ui.notifications.error(`Scene "${t}" not found`);return}}else if(t instanceof Scene)s=t;else{ui.notifications.error("Invalid destination scene provided");return}const a=[],i=[],n=[];for(const p of e){const m=canvas.tokens.get(p);m?(a.push(m),i.push({id:m.id,sceneId:canvas.scene.id,x:m.document.x,y:m.document.y,width:m.document.width,height:m.document.height,documentData:m.document.toObject()})):n.push(p)}if(n.length>0)if(d.warn(`Invalid token IDs provided: ${n.join(", ")}`),a.length===0){ui.notifications.error("No valid tokens found. Ensure you're using token IDs, not actor IDs.");return}else I.notify("warn",`Some token IDs were invalid and skipped. ${a.length} token(s) will be teleported.`);if(a.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTokensSelectedForTeleport"));return}this._tokensToTeleport=a,this._tokenDataToTeleport=i,this._sourceScene=canvas.scene,this._targetScene=s,this._isTeleporting=!0,this._isPerformingTeleport=!0;const r=s.grid.getSnappedPoint(o,{mode:CONST.GRID_SNAPPING_MODES.CENTER}),l=canvas.scene.grid.size,c=this._calculateBoundingBox(i,l),u=c.x+c.width/2,g=c.y+c.height/2;let f=[];try{s.id===canvas.scene.id?f=await this._performSameSceneTeleport(r,u,g,l):(await s.view(),f=await this._performCrossSceneTeleport(r,u,g,l))}catch(p){throw d.error("Error during teleportation",[p]),this._cleanup(),p}if(f.length>0){await new Promise(m=>setTimeout(m,50));const p=f.map(m=>canvas.tokens.get(m)).filter(m=>m);if(p.length>0){canvas.tokens.releaseAll(),p.forEach(y=>y.control({releaseOthers:!1}));const m=p.reduce((y,S)=>y+S.center.x,0)/p.length,k=p.reduce((y,S)=>y+S.center.y,0)/p.length;await canvas.animatePan({x:m,y:k,duration:150})}}}}D(Q,"_isTeleporting",!1),D(Q,"_isPerformingTeleport",!1),D(Q,"_tokensToTeleport",[]),D(Q,"_tokenDataToTeleport",[]),D(Q,"_sourceScene",null),D(Q,"_canvasClickHandler",null),D(Q,"_canvasRightClickHandler",null),D(Q,"_canvasMoveHandler",null),D(Q,"_canvasRightDownHandler",null),D(Q,"_canvasRightUpHandler",null),D(Q,"_escapeKeyHandler",null),D(Q,"_targetScene",null),D(Q,"_rightMouseDown",!1),D(Q,"_rightMouseDownPosition",null),D(Q,"_hasDragged",!1);const Xo=Object.freeze(Object.defineProperty({__proto__:null,TokenTeleportManager:Q},Symbol.toStringTag,{value:"Module"})),{ApplicationV2:Qo,HandlebarsApplicationMixin:Zo}=foundry.applications.api,{FormDataExtended:es}=foundry.applications.ux;var Ne,uo,go,fo;const De=class De extends Zo(Qo){static async show(e){return new Promise(t=>{new this({actors:e,resolve:t}).render(!0)})}constructor(e={}){super(e),this.actors=e.actors||[],this.resolve=e.resolve,this.selectedActorUuid=null,this.selectedActorName="",this.selectedPreset="polymorph",this.showCustomSettings=!1}async _prepareContext(e){return await super._prepareContext(e)}async _preparePartContext(e,t,o){switch(t=await super._preparePartContext(e,t,o),e){case"content":{t.actors=this.actors,t.actorCount=this.actors.length,t.actorNames=this.actors.map(i=>i.name).join(", "),t.selectedActorName=this.selectedActorName;const s=game.settings.get("flash-rolls-5e","transform-favorites")||[],a=new Set(s);t.favorites=[];for(const i of s){const n=await fromUuid(i);n&&t.favorites.push({uuid:i,name:n.name,img:n.img})}if(this.selectedActorUuid){const i=await fromUuid(this.selectedActorUuid);t.selectedActor={uuid:this.selectedActorUuid,name:this.selectedActorName,img:i==null?void 0:i.img,isFavorite:a.has(this.selectedActorUuid)}}else t.selectedActor=null;t.selectedPreset=this.selectedPreset,t.showCustomSettings=this.showCustomSettings,t.presets=[{value:"polymorph",label:"FLASH_ROLLS.ui.dialogs.transformation.presets.polymorph",description:"FLASH_ROLLS.ui.dialogs.transformation.presets.polymorphDesc"},{value:"wildshape",label:"FLASH_ROLLS.ui.dialogs.transformation.presets.wildshape",description:"FLASH_ROLLS.ui.dialogs.transformation.presets.wildshapeDesc"},{value:"appearance",label:"FLASH_ROLLS.ui.dialogs.transformation.presets.appearance",description:"FLASH_ROLLS.ui.dialogs.transformation.presets.appearanceDesc"},{value:"custom",label:"FLASH_ROLLS.ui.dialogs.transformation.presets.custom",description:"FLASH_ROLLS.ui.dialogs.transformation.presets.customDesc"}];break}case"footer":{t.buttons=[{type:"button",icon:"fa-solid fa-times",label:"FLASH_ROLLS.ui.buttons.cancelButton",action:"cancel"},{type:"button",icon:"fa-solid fa-wand-magic-sparkles",label:"FLASH_ROLLS.ui.dialogs.transformation.transform",action:"transform"}];break}}return t}_onRender(e,t){super._onRender(e,t);const o=this.element.querySelector(".select-actor-btn"),s=this.element.querySelector(".actor-image-container"),a=this.element.querySelector(".actor-image-placeholder"),i=this.element.querySelector(".clear-actor-btn"),n=this.element.querySelector(".preset-selector"),r=this.element.querySelectorAll(".favorite-item"),l=this.element.querySelectorAll(".toggle-favorite-btn"),c=this.element.querySelector(".form-group.favorites-section"),u=this.element.querySelector(".selected-actor-preview .actor-image-container img");o&&o.addEventListener("click",g=>{g.preventDefault(),this._onSelectActor()}),s&&s.addEventListener("click",g=>{g.target.closest(".toggle-favorite-btn")||(g.preventDefault(),this._onSelectActor())}),a&&a.addEventListener("click",g=>{g.preventDefault(),this._onSelectActor()}),i&&i.addEventListener("click",g=>{g.preventDefault(),this._onClearActor()}),n&&n.addEventListener("change",g=>this._onPresetChange(g)),r.forEach(g=>{g.addEventListener("click",f=>{f.target.closest(".toggle-favorite-btn")||this._onSelectFavorite(g.dataset.uuid)})}),l.forEach(g=>{const f=g.dataset.isFavorite==="true";g.title=f?game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.removeFromFavorites"):game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.addToFavorites"),g.addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),this._onToggleFavorite(g.dataset.uuid)})}),c&&this._setupDragAndDrop(c),u&&u.addEventListener("error",()=>{u.classList.add("hidden")})}_setupDragAndDrop(e){e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="copy",e.classList.add("drag-over")}),e.addEventListener("dragleave",t=>{t.target===e&&e.classList.remove("drag-over")}),e.addEventListener("drop",async t=>{t.preventDefault(),e.classList.remove("drag-over");const o=TextEditor.getDragEventData(t);if(o.type==="Actor"){const s=await fromUuid(o.uuid);s&&s.type==="npc"?await this._onToggleFavorite(o.uuid):s&&s.type!=="npc"&&I.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.onlyNPCs"))}})}async _onSelectActor(){const e=await this._showActorBrowser();if(e){this.selectedActorUuid=e;const t=await fromUuid(e);t&&(this.selectedActorName=t.name,this.render(!0))}}async _showActorBrowser(){return dnd5e.applications.CompendiumBrowser.selectOne({tab:"monsters",filters:{locked:{documentClass:"Actor",types:new Set(["npc"])}}})}_onClearActor(){this.selectedActorUuid=null,this.selectedActorName="",this.render(!0)}async _onSelectFavorite(e){const t=await fromUuid(e);if(t){const o=!this.selectedActorUuid;if(this.selectedActorUuid=e,this.selectedActorName=t.name,o){this.render(!0);return}const s=this.element.querySelector(".selected-actor-preview .actor-image-container"),a=s==null?void 0:s.querySelector("img"),i=this.element.querySelector(".selected-actor-preview .toggle-favorite-btn"),n=this.element.querySelector(".selected-actor-preview");if(a&&s&&(a.src=t.img,a.alt=t.name,a.classList.remove("hidden")),i){i.dataset.uuid=e;const r=i.querySelector("i"),c=(game.settings.get("flash-rolls-5e","transform-favorites")||[]).includes(e);r&&(c?r.classList.remove("faded"):r.classList.add("faded")),i.title=game.i18n.localize(c?"FLASH_ROLLS.ui.dialogs.transformation.removeFromFavorites":"FLASH_ROLLS.ui.dialogs.transformation.addToFavorites")}n&&(n.dataset.tooltip=t.name)}}async _onToggleFavorite(e){const t=game.settings.get("flash-rolls-5e","transform-favorites")||[],o=new Set(t),s=o.has(e);if(s?o.delete(e):o.add(e),await game.settings.set("flash-rolls-5e","transform-favorites",Array.from(o)),s)this.render(!0);else{const a=this.element.querySelector(`.toggle-favorite-btn[data-uuid="${e}"]`);if(a){const i=a.querySelector("i");i&&i.classList.remove("faded"),a.title=game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.removeFromFavorites")}this.render(!0)}}_onPresetChange(e){this.selectedPreset=e.target.value,this.showCustomSettings=this.selectedPreset==="custom",this.render(!0)}_createPresetSettings(e){switch(e){case"wildshape":return new dnd5e.dataModels.settings.TransformationSetting({preset:"wildshape"});case"appearance":return new dnd5e.dataModels.settings.TransformationSetting({effects:new Set(["all"]),keep:new Set(["self"])});case"polymorph":default:return new dnd5e.dataModels.settings.TransformationSetting({keep:new Set(["mental"]),transformTokens:!0})}}};Ne=new WeakSet,uo=async function(e,t,o){e.preventDefault()},go=async function(e,t){const o=this;if(!o.selectedActorUuid){I.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.noActorSelected"));return}const s=await fromUuid(o.selectedActorUuid);if(!s){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidActorUuid"));return}const a=new es(o.element).object,i=a.renderSheet||!1;let n;if(o.selectedPreset==="custom"){const r=new Set;a["keep-mental"]&&r.add("mental"),a["keep-physical"]&&r.add("physical"),a["keep-saves"]&&r.add("saves"),a["keep-skills"]&&r.add("skills"),a["keep-spells"]&&r.add("spells"),a["keep-items"]&&r.add("items"),a["keep-hp"]&&r.add("hp"),n=new dnd5e.dataModels.settings.TransformationSetting({keep:r,transformTokens:!!a["transform-tokens"]})}else n=o._createPresetSettings(o.selectedPreset);o.resolve&&o.resolve({targetActor:s,settings:n,renderSheet:i}),o.close()},fo=function(){const e=this;e.resolve&&e.resolve(null),e.close()},ne(De,Ne),D(De,"DEFAULT_OPTIONS",{id:"flash5e-transformation-dialog",tag:"form",window:{title:"",icon:"fa-solid fa-frog",contentClasses:["standard-form","crlngn","flash5e","transformation-dialog"]},position:{width:560,height:"auto"},form:{handler:de(De,Ne,uo),submitOnChange:!1,closeOnSubmit:!1},actions:{transform:de(De,Ne,go),cancel:de(De,Ne,fo)}}),D(De,"PARTS",{content:{template:`modules/${R}/templates/transformation-dialog.hbs`},footer:{template:"templates/generic/form-footer.hbs"}});let Et=De;class it{static async transformSelectedActors(e){if(!e||!e.selectedActors||e.selectedActors.size===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}const t=Array.from(e.selectedActors);await this.transformActors(t)}static async transformActors(e,t=null,o={}){if(d.log("TransformationManager.transformActors",[e,t,o]),!e||e.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}if(!game.user.isGM){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.gmOnly"));return}const s=e.map(r=>Y(r)).filter(r=>r);if(s.length===0){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const a=s.filter(r=>r.getFlag("dnd5e","isPolymorphed"));if(a.length>0&&!o.skipRevertCheck&&await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.revertTitle")},content:`<p>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.revertConfirm")}</p>`,rejectClose:!1,modal:!0})){const l=a.map(c=>{const u=canvas.tokens.placeables.find(g=>g.actor===c);return u?u.document.id:c.id});await this.revertTransformation(l);return}let i,n;if(t){if(i=await fromUuid(t),!i){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidActorUuid"));return}n=this._createTransformSettings(o.preset,o.settings)}else{const r=await Et.show(s);if(!r)return;i=r.targetActor,n=r.settings,o.renderSheet=r.renderSheet??!1}await this._performTransformations(s,i,n,o)}static async revertTransformation(e){if(d.log("TransformationManager.revertTransformation",[e]),!e||e.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}const t=e.map(i=>Y(i)).filter(i=>i);if(t.length===0){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const o=t.filter(i=>i.getFlag("dnd5e","isPolymorphed"));if(o.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.notTransformed"));return}const s=this._getTokensForActors(o);s.length>0&&(this._hasJB2A()||this._hasCustomAnimation())&&await this._playTransformationAnimation(s);let a=0;for(const i of o)try{await i.revertOriginalForm(),a++}catch(n){d.error(`Failed to revert ${i.name}:`,[n]),ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.transformationFailed",{name:i.name,error:n.message}))}a>0&&I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.reversionSuccess",{count:a}))}static async _performTransformations(e,t,o,s={}){const a=this._getTokensForActors(e);a.length>0&&(this._hasJB2A()||this._hasCustomAnimation())&&this._playTransformationAnimation(a);let i=0;for(const n of e)try{const r=this._sanitizeTargetActor(n,t);await n.transformInto(r,o,{renderSheet:s.renderSheet??!1}),i++,await new Promise(l=>setTimeout(l,200))}catch(r){d.error(`Failed to transform ${n.name}:`,[r]),ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.transformationFailed",{name:n.name,error:r.message}))}i>0&&I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.transformationSuccess",{count:i,target:t.name}))}static async _playTransformationAnimation(e){if(!e||e.length===0)return;let t=this._getAnimationPath();if(!t&&this._hasJB2A()&&(t=await this._getDefaultJB2APath()),!!t)try{for(const o of e){const{x:s,y:a}=o.center;new Sequence().effect().file(t).atLocation({x:s,y:a}).scale(.6).fadeIn(200).fadeOut(400).duration(1500).forUsers(game.users.map(i=>i.id)).play(),await new Promise(i=>setTimeout(i,200))}await new Promise(o=>setTimeout(o,1e3))}catch(o){d.warn(`Transformation animation file not found: ${t}`,[o]),I.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.animationFileNotFound",{path:t}))}}static _getTokensForActors(e){const t=[];for(const o of e){const s=canvas.tokens.placeables.find(a=>a.actor===o);s&&t.push(s)}return t}static _createTransformSettings(e,t){if(t)return new dnd5e.dataModels.settings.TransformationSetting(t);switch(e){case"wildshape":return new dnd5e.dataModels.settings.TransformationSetting({preset:"wildshape"});case"polymorph":return new dnd5e.dataModels.settings.TransformationSetting({keep:new Set(["mental"]),transformTokens:!0});default:return new dnd5e.dataModels.settings.TransformationSetting({keep:new Set(["mental"]),transformTokens:!0})}}static _getJB2AModule(){return game.modules.get("JB2A_DnD5e")||game.modules.get("jb2a_patreon")}static _hasJB2A(){const e=this._getJB2AModule();return e==null?void 0:e.active}static _hasSequencer(){var e;return(e=game.modules.get("sequencer"))==null?void 0:e.active}static async _getDefaultJB2APath(){var t;if(this._hasSequencer()&&((t=window.Sequencer)!=null&&t.Database)){const o=["jb2a.smoke.puff.centered.grey.1","jb2a.smoke.puff.centered.grey","jb2a.smoke.puff.grey"];for(const s of o)if(Sequencer.Database.entryExists(s))return d.log(`Found JB2A transformation animation via Sequencer: ${s}`),s}const e=this._getJB2AModule();if(e!=null&&e.active){const s=`modules/${e.id}/Library/Generic/Smoke/SmokePuff01_02_Regular_Grey_400x400.webm`;return d.log(`Using JB2A transformation animation file path: ${s}`),s}return d.warn("JB2A module not found, transformation animations disabled"),null}static _hasCustomAnimation(){return!!this._getAnimationPath()}static _getAnimationPath(){var e;try{const t=C();if(!((e=t.transformAnimationPath)!=null&&e.tag))return null;const o=game.settings.get("flash-rolls-5e",t.transformAnimationPath.tag);return o&&o.trim()!==""?o:null}catch{return null}}static _sanitizeTargetActor(e,t){var c,u;if(!((c=e==null?void 0:e.system)!=null&&c.abilities)||!((u=t==null?void 0:t.system)!=null&&u.abilities))return t;const o=e.toObject(),s=t.toObject(),a=Object.keys(o.system.abilities),i=Object.keys(s.system.abilities);d.log(`Sanitization check - Source (${e.name}) toObject:`,a),d.log(`Sanitization check - Target (${t.name}) toObject:`,i);const n=i.filter(g=>!a.includes(g));if(n.length===0)return d.log("No extra abilities found in serialized data - skipping sanitization"),t;d.log(`Sanitizing target actor ${t.name}: removing abilities not present in source toObject`,n);for(const g of n)delete s.system.abilities[g];d.log("Sanitized data abilities:",Object.keys(s.system.abilities));const r=CONFIG.Actor.documentClass,l=new r(s,{temporary:!0});return d.log("Temp actor abilities after creation:",Object.keys(l.system.abilities)),l}}const ts=Object.freeze(Object.defineProperty({__proto__:null,TransformationManager:it},Symbol.toStringTag,{value:"Module"}));class I{static async requestRoll(e={}){try{if(!e||typeof e!="object"){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidMacroData"));return}const{requestType:t,rollKey:o=null,actorIds:s=[],dc:a,situationalBonus:i,advantage:n,disadvantage:r,rollMode:l,skipRollDialog:c,sendAsRequest:u=!0,groupRollId:g=null,isContestedRoll:f=!1}=e;if(!t){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.missingRequestType"));return}const p={dc:a,situationalBonus:i,advantage:n,disadvantage:r,rollMode:l,skipRollDialog:c,sendAsRequest:u,groupRollId:g,isContestedRoll:f};d.log("FlashAPI.requestRoll",[t,o,s,p]);let m=W.ROLL_REQUEST_OPTIONS[t];if(m||(m=Object.values(W.ROLL_REQUEST_OPTIONS).find(v=>v.name===t)),!m){ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.unknownRequestType",{requestType:t}));return}const k=m.name;if(s.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}if(!Array.isArray(s)){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidActorIdsFormat"));return}const y=[],S=[];for(const b of s){const v=Y(b);if(!v){y.push(b);continue}let L=null;game.actors.get(b)||(L=b),S.push({actor:v,uniqueId:b,tokenId:L})}if(y.length>0){const b=y.join(", ");I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.invalidActorIds",{numIds:y.length,invalidIds:b}))}if(S.length===0){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const T={selectedActors:new Set(s),selectedRequestType:t,isLocked:!0,close:()=>{}};return Ye.triggerRoll(k,o,T,p)}catch(t){d.error("FlashAPI.requestRoll - Execution error:",[t]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.macroExecutionFailed"));return}}static getAvailableRollTypes(){const e={};for(const[t,o]of Object.entries(W.ROLL_REQUEST_OPTIONS))e[t]={name:o.name,label:o.label};return e}static getSelectedActors(e=!1){const t=x.getInstance();if(t&&t.selectedActors){const o=Array.from(t.selectedActors);return e?o.map(s=>{const a=canvas.tokens.placeables.find(n=>n.id===s);if(a)return a.id;const i=game.actors.get(s);if(i){const n=canvas.tokens.placeables.find(r=>{var l;return((l=r.actor)==null?void 0:l.id)===i.id});if(n)return n.id}return null}).filter(s=>s!==null):o}return[]}static isMenuOpen(){const e=x.getInstance();return e&&e.rendered}static async createMacro(e){const t=C(),o=_.get(t.addMacrosToFolder.tag);d.log("FlashAPI.createMacro",[e]);const{requestType:s,rollKey:a=null,actorIds:i=[],config:n={}}=e;let r=W.ROLL_REQUEST_OPTIONS[s];if(r||(r=Object.values(W.ROLL_REQUEST_OPTIONS).find(k=>k.name===s)),!r){I.notify("warn",`Unknown request type: ${s}`);return}let l=r.label;if(d.log("FlashAPI.createMacro",[l,r.subList]),a&&r.subList&&Array.isArray(r.subList)){const m=r.subList.find(k=>k.id===a);m&&(l=m.name)}else a&&(l=Po(r.name,a));const c={requestType:r.name,...a&&{rollKey:a},...i.length>0&&{actorIds:i},...n};c.advantage===void 0&&(c.advantage=!1),c.disadvantage===void 0&&(c.disadvantage=!1);const u=`// Flash Token Bar: ${l} - ${a||""}
    try {
      FlashAPI.requestRoll(${JSON.stringify(c,null,2)});
    } catch (error) {
      ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.macroDataMalformed"));
    }`;let g=null;o&&(g=await this._ensureFlashRollsFolder());const f={name:`Flash Token Bar: ${l}`,type:"script",command:u,img:"modules/flash-rolls-5e/assets/bolt-circle.svg",...g&&{folder:g},flags:{"flash-rolls-5e":{requestType:s,rollKey:a,actorIds:i,config:n}}},p=await Macro.create(f);return I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.macroCreated",{macroName:p.name})),p.sheet.render(!0),p}static async _ensureFlashRollsFolder(){const e="Flash Token Bar";let t=game.folders.find(o=>o.type==="Macro"&&o.name===e);if(!t)try{t=await Folder.create({name:e,type:"Macro",color:"#302437",sort:0}),d.log("Created Flash Token Bar macro folder",[t])}catch(o){return d.error("Failed to create Flash Token Bar macro folder:",[o]),I.notify("warn","Failed to create Flash Token Bar macro folder. Macro will be created without folder organization."),null}return(t==null?void 0:t.id)||null}static calculateGroupRoll(e={}){const{rollResults:t,dc:o,rollType:s,rollKey:a}=e;let{method:i,actors:n}=e;const r={"standard rule":1,"group average":2,"leader with help":3,"weakest link":4};if(typeof i=="string"){const c=i.toLowerCase();if(i=r[c],!i)return ui.notifications.error(`Invalid method name: "${e.method}". Valid options: "Standard Rule", "Group Average", "Leader with Help", "Weakest Link", or numbers 1-4`),null}if(!i||![1,2,3,4].includes(i))return ui.notifications.error("Method must be 1-4 or valid method name: 'Standard Rule', 'Group Average', 'Leader with Help', 'Weakest Link'"),null;if(!Array.isArray(t)||t.length===0)return ui.notifications.error("rollResults must be a non-empty array"),null;if(typeof o!="number"||o<0)return ui.notifications.error("dc must be a positive number"),null;const l=[];for(let c=0;c<t.length;c++){const u=t[c];if(!u.hasOwnProperty("total")||typeof u.total!="number")return ui.notifications.error(`rollResults[${c}] must have a 'total' property with a numeric value`),null;if(!u.actorId)return ui.notifications.error(`rollResults[${c}] must have an 'actorId' property`),null;let g=u.actorName;if(!g){const f=Y(u.actorId);g=(f==null?void 0:f.name)||u.actorId}l.push({...u,actorName:g,passed:u.total>=o})}if([3,4].includes(i)){if(!s)return ui.notifications.error("rollType is required for Leader with Help and Weakest Link methods"),null;if(!a)return ui.notifications.error("rollKey is required for Leader with Help and Weakest Link methods"),null;if(!Array.isArray(n)||n.length===0){n=[];for(const c of l){const u=Y(c.actorId);u&&n.push(u)}if(n.length===0)return ui.notifications.error("No valid actors could be resolved from the rollResults for Leader with Help and Weakest Link methods"),null}}try{let c,u;switch(i){case 1:return c=P.calculateStandardRule(t,o),u="Standard Rule",{success:c.finalResult,result:c.finalResult?1:0,details:c,method:u,actorResults:l};case 2:return c=P.calculateGroupAverage(t,o),u="Group Average",{success:c.success,result:c.finalResult,details:c,method:u,actorResults:l};case 3:c=P.calculateLeaderWithHelp(t,o,n,s,a),u="Leader with Help";const g=l.map(p=>({...p,isLeadRoll:p.actorId===c.leaderActorId}));return{success:c.success,result:c.finalResult,details:c,method:u,actorResults:g};case 4:c=P.calculateWeakestLink(t,o,n,s,a),u="Weakest Link";const f=l.map(p=>({...p,isLeadRoll:p.actorId===c.weakestActorId}));return{success:c.success,result:c.finalResult,details:c,method:u,actorResults:f};default:return ui.notifications.error(`Invalid calculation method: ${i}`),null}}catch(c){return d.error("FlashAPI.calculateGroupRoll - Error:",[c]),ui.notifications.error(`Error calculating group roll: ${c.message}`),null}}static async createGroupRollMessage(e,t,o,s={},a){return te.createGroupRollMessage(e,t,o,s,a)}static async toggleLockMenu(){var s;const t=!(game.user.getFlag(W.ID,"menuLocked")??!1);await game.user.setFlag(W.ID,"menuLocked",t);const o=x.getInstance();if(o&&o.rendered){o.isLocked=t;const a=(s=o.element)==null?void 0:s.querySelector("#flash5e-actors-lock");a&&(a.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),a.classList.add(t?"fa-lock-keyhole":"fa-lock-keyhole-open"))}}static async toggleRollRequests(){const e=C(),o=!_.get(e.rollRequestsEnabled.tag);await _.set(e.rollRequestsEnabled.tag,o),At.updateRollRequestsIcon(o),_.applyRollRequestsEnabled(o);const s=x.getInstance();s&&s.rendered&&await s.render()}static async toggleSkipDialogs(){const e=C(),t=_.get(e.skipRollDialog.tag);await _.set(e.skipRollDialog.tag,!t);const o=x.getInstance();o&&o.rendered&&await o.render()}static async toggleGroupRolls(){const e=C(),t=_.get(e.groupRollsMsgEnabled.tag);await _.set(e.groupRollsMsgEnabled.tag,!t);const o=x.getInstance();o&&o.rendered&&await o.render()}static async toggleShowOptions(){const e=C(),t=_.get(e.showOptionsListOnHover.tag);await _.set(e.showOptionsListOnHover.tag,!t);const o=x.getInstance();o&&o.rendered&&await o.render()}static openSettings(){new lt().render(!0)}static async selectAllActors(e){var s;const t=x.getInstance();if(!t||!t.rendered){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.menuNotOpen"));return}e&&["pc","npc","group"].includes(e)&&t.currentTab!==e&&(t.currentTab=e,await t.render());const o=(s=t.element)==null?void 0:s.querySelector("#flash5e-actors-all");o&&(o.checked=!o.checked,o.dispatchEvent(new Event("change")))}static async filterActors(e){var o;const t=x.getInstance();if(!t||!t.rendered){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.menuNotOpen"));return}if(e&&typeof e=="object"){const s={inCombat:!!e.inCombat,visible:!!e.visible,removeDead:!!e.removeDead};t.actorFilters=s,await game.user.setFlag(W.ID,"actorFilters",s),t.render()}else{const s=(o=t.element)==null?void 0:o.querySelector("#flash5e-filter-actors");s&&s.click()}}static getActorFilters(){return game.user.getFlag(W.ID,"actorFilters")||{inCombat:!1,visible:!1,removeDead:!1}}static toggleTargets(e){const t=x.getInstance();e&&e.length>0?e.forEach(o=>{const s=Y(o);if(!s)return;const a=s.id,i=game.actors.get(o)?null:o;ce.toggleActorTargetById(a,i)}):t&&t.rendered&&ce.toggleTargetsForSelected(t)}static healAll(e){const t=x.getInstance();e&&e.length>0?e.forEach(o=>{const s=Y(o);if(!s)return;const a=s.id,i=game.actors.get(o)?null:o;ce.healActorById(a,i)}):t&&t.rendered&&ce.healSelectedActors(t)}static killAll(e){const t=x.getInstance();e&&e.length>0?e.forEach(o=>{const s=Y(o);if(!s)return;const a=s.id,i=game.actors.get(o)?null:o;ce.killActorById(a,i)}):t&&t.rendered&&ce.killSelectedActors(t)}static async removeStatusEffects(e){const t=x.getInstance();if(e&&e.length>0){let o=0;for(const s of e){const a=Y(s);if(!a)continue;const i=a.appliedEffects.filter(n=>{var r,l,c;return((r=n.statuses)==null?void 0:r.size)>0||((c=(l=n.flags)==null?void 0:l.core)==null?void 0:c.statusId)});for(const n of i)try{await n.delete(),o++}catch(r){d.error(`Failed to remove status effect from ${a.name}`,[r])}}o>0&&I.notify("info",`Removed ${o} status effects`)}else t&&t.rendered&&await ce.removeAllStatusEffectsFromSelected(t)}static openSheets(e){const t=x.getInstance();e&&e.length>0?e.forEach(o=>{const s=Y(o);if(!s)return;const a=s.id,i=game.actors.get(o)?null:o;ce.openActorSheetById(a,i)}):t&&t.rendered&&ce.openSheetsForSelected(t)}static async groupSelected(e){const t=x.getInstance();if(e&&e.length>0){const o={selectedActors:new Set(e)};await ce.createGroupFromSelected(o)}else t&&t.rendered?await ce.createGroupFromSelected(t):I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async toggleMovement(e){const t=x.getInstance();if(e&&e.length>0){const o={selectedActors:new Set(e)};await Te.toggleMovementForSelected(o)}else t&&t.rendered?await Te.toggleMovementForSelected(t):I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async openContestedRoll(e){const t=x.getInstance();if(e&&e.length>0){const o={selectedActors:new Set(e)};await ce.openContestedRollDialog(o)}else t&&t.rendered?await ce.openContestedRollDialog(t):I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async placeTokens(e,t=null){const o=x.getInstance();if(e&&e.length>0)if(t&&typeof t=="object"&&typeof t.x=="number"&&typeof t.y=="number")await he.placeTokensAtLocation(e,t);else{const s={selectedActors:new Set(e)};await he.placeTokensForSelectedActors(s)}else o&&o.rendered?await he.placeTokensForSelectedActors(o):I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async teleportTokens(e,t=null,o=null){const s=x.getInstance();if(e&&e.length>0)if(t&&o&&typeof o=="object"&&typeof o.x=="number"&&typeof o.y=="number")await Q.teleportToDestination(e,t,o);else{const a={selectedActors:new Set(e)};await Q.teleportSelectedTokens(a)}else s&&s.rendered?await Q.teleportSelectedTokens(s):I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async transformActors(e,t=null,o={}){const s=x.getInstance();e&&e.length>0?await it.transformActors(e,t,o):s&&s.rendered?await it.transformSelectedActors(s):I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static async revertTransformation(e){const t=x.getInstance();if(e&&e.length>0)await it.revertTransformation(e);else if(t&&t.rendered){const o=Array.from(t.selectedActors);await it.revertTransformation(o)}else I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"))}static notify(e,t){q.notify(e,t)}}var Fe,ct,dt;class Qe{static isAvailable(){var e;return B(this,ct)||(ye(this,dt,((e=game.modules.get("lib-wrapper"))==null?void 0:e.active)??!1),ye(this,ct,!0)),B(this,dt)}static register(e,t,o="WRAPPER",s={}){if(!this.isAvailable())return s.required&&d.warn(`LibWrapperUtil.register - libWrapper required but not available for: ${e}`),!1;try{return libWrapper.register(R,e,t,o),B(this,Fe).add(e),d.log(`LibWrapperUtil.register - Successfully registered: ${e}`),!0}catch(a){return d.error(`LibWrapperUtil.register - Failed to register ${e}:`,a),!1}}static unregister(e){if(this.isAvailable())try{libWrapper.unregister(R,e),B(this,Fe).delete(e),d.log(`LibWrapperUtil.unregister - Successfully unregistered: ${e}`)}catch(t){d.error(`LibWrapperUtil.unregister - Failed to unregister ${e}:`,t)}}static unregisterAll(){if(this.isAvailable()){for(const e of B(this,Fe))this.unregister(e);B(this,Fe).clear(),d.log("LibWrapperUtil.unregisterAll - All wrappers unregistered")}}static getRegisteredWrappers(){return Array.from(B(this,Fe))}static showMissingLibWrapperNotification(){if(!game.user.isGM)return;const e=C();if(this.isAvailable()){_.get(e.libWrapperNotificationShown.tag)&&_.set(e.libWrapperNotificationShown.tag,!1);return}_.get(e.libWrapperNotificationShown.tag)||(I.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.libWrapperRecommended"),{permanent:!0,console:!1}),_.set(e.libWrapperNotificationShown.tag,!0))}}Fe=new WeakMap,ct=new WeakMap,dt=new WeakMap,ne(Qe,Fe,new Set),ne(Qe,ct,!1),ne(Qe,dt,!1);const{FormDataExtended:us}=foundry.applications.ux,{ApplicationV2:os,HandlebarsApplicationMixin:ss}=foundry.applications.api;var Jt,ke,Ze,Ft,tt,po,ho,Ge,mo,yo,Ro;const j=class j extends ss(os){constructor(){super(...arguments);ne(this,tt);D(this,"_onRender",(t,o)=>{C(),ye(j,ke,this.element),B(j,ke).querySelectorAll(".toggle-hint").forEach(n=>{n.addEventListener("click",()=>{B(j,ke).querySelectorAll("p.hint").forEach(r=>r.classList.toggle("shown"))})});const a=B(j,ke).querySelector(".icon-arrangement-container");a&&Pe.initializeDragAndDrop(a),B(j,ke).querySelectorAll("select[data-current-value]").forEach(n=>{const r=String(n.dataset.currentValue),l=n.querySelector(`option[value="${r}"]`);l&&(l.selected=!0)}),de(this,tt,po).call(this)})}_configureRenderParts(t){const o=super._configureRenderParts(t),s=j.getRestrictedTabs();return game.user.isGM||s.forEach(a=>{delete o[a]}),o}async _prepareContext(t){const o=await super._prepareContext(t);return o.activeTab=t.activeTab||Object.keys(o.tabs)[0],o.isGM=game.user.isGM,o.interceptWarning=q.isModuleOn("midi-qol"),o.interceptWarning=game.i18n.localize("FLASH_ROLLS.notifications.interceptWarning"),o}async _preparePartContext(t,o,s){var n,r,l;const a=await super._preparePartContext(t,o,s);t in o.tabs&&(a.tab=a.tabs[t]),C(),So();const i=j.getRestrictedTabs();switch(game.user.isGM||i.forEach(c=>{delete a.tabs[c]}),t){case"tabs":break;case"footer":{a.buttons=[{type:"button",icon:"",label:"FLASH_ROLLS.ui.buttons.reset",action:"redefine"},{type:"submit",icon:"",label:"FLASH_ROLLS.ui.buttons.save"}];break}default:{a.tab=a.tabs[t];const c=((n=j.PARTS[t])==null?void 0:n.menuKey)||null;if(c){const u=j.getMenuContext(c);if(u.fields&&(a.fields={...a.fields,...u.fields}),u.fieldDefaults&&(a.fieldDefaults={...a.fieldDefaults,...u.fieldDefaults}),u.fieldValues&&Object.assign(a,u.fieldValues),t==="interfaceSettings"){a.iconConfigs=Pe.getIconConfigurations();const g=Pe.getIconConfigurations(),p=C().menuIconsLayout.default,m=a.menuIconsLayout||{},k=(y,S)=>{const T=p[y]||[],b=m[y]||[],v=new Map(T.map(O=>[O.id,O])),L=new Map(b.map(O=>[O.id,O]));return Object.keys(S).map((O,w)=>{const M=S[O],F=v.get(O),U=L.get(O);return{id:O,icon:M.icon,enabled:U?U.enabled:F?F.enabled:!1,order:U?U.order:F?F.order:w,label:game.i18n.localize(M.labelKey||O)}}).sort((O,w)=>O.order-w.order)};a.menuIconsLayout={moduleActions:k("moduleActions",g.moduleActions),actorActions:k("actorActions",g.actorActions)}}a.sidebarTabs=Object.values(((l=(r=foundry.applications)==null?void 0:r.sidebar)==null?void 0:l.tabs)||{}).map(g=>({tabName:g.tabName,name:g.name,hideForGM:!1,hideForPlayer:!1,localizedName:`FLASH_ROLLS.settings.sidebarTabs.${g.name}`}))}break}}return d.log("_preparePartContext",[a,t]),a}static getMenuContext(t){var r;const o=C(),s=((r=o[t])==null?void 0:r.fields)||null;if(!s)return{};const a={},i={},n={};return s.forEach(l=>{if(o[l]){const c=_.get(o[l].tag);a[l]=o[l],i[l]=c!==void 0?c:o[l].default,n[l]=o[l].default}}),{fields:a,fieldValues:i,fieldDefaults:n}}static getRestrictedTabs(){const t=[];return Object.entries(j.PARTS).forEach((o,s)=>{o[0]!=="tabs"&&o[0]!=="footer"&&o[1].isGMOnly&&t.push(o[0])}),t}static updateSettings(t){let o=!1;const s=C(),n=B(j,ke).querySelector(".form-content.active").dataset.tab;if(ye(j,Ze,n),!t)return;let r;return t.object&&(r=foundry.utils.expandObject(t.object)),Object.entries(r).forEach(([l,c])=>{var u;if(!l.endsWith("_value")&&(d.log("updateSettings #1",[s,s[l]]),r[l]!==void 0&&s[l])){const g=_.get(s[l].tag);_.set(s[l].tag,r[l]),(u=s[l])!=null&&u.requiresReload&&g!==r[l]&&(o=!0)}}),I.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.settingsUpdated")),o}changeTab(t,o,s){super.changeTab(t,o,s),ye(j,Ze,t)}};ke=new WeakMap,Ze=new WeakMap,Ft=new WeakMap,tt=new WeakSet,po=function(){B(j,ke).querySelectorAll(".form-group.range").forEach(o=>{const s=o.querySelector('input[type="range"]'),a=o.querySelector('input[type="number"]');de(this,tt,ho).call(this,s,a)})},ho=function(t,o){if(t&&o){const s=parseInt(t.min,10),a=parseInt(t.max,10);t.addEventListener("input",()=>{o.value=t.value}),o.addEventListener("input",()=>{const i=o.value;if(i===""||i==="-")return;const n=parseInt(i,10);!isNaN(n)&&n>=s&&n<=a&&(t.value=n)}),o.addEventListener("change",()=>{let i=parseInt(o.value,10);isNaN(i)||i<s?i=s:i>a&&(i=a),o.value=i,t.value=i}),o.value=t.value}},Ge=new WeakSet,mo=async function(t,o,s){t.preventDefault(),t.stopPropagation(),j.updateSettings(s)&&q.confirmReload()},yo=async function(t,o){const s=C(),i=B(j,ke).querySelector(".form-content.active"),n=i.dataset.tab,r=j.PARTS[n].menuKey,l=s[r].default;if(n==="interfaceSettings"){Pe.resetToDefault();const u=foundry.applications.instances.get("flash-rolls-settings");if(u){await u.renderPart("interfaceSettings",{force:!0});return}}i.querySelectorAll("input, select").forEach(u=>{u.value=l[u.name],u.type==="checkbox"&&(u.checked=l[u.name])}),d.log("#onReset",[B(j,Ze),n,t,o])},Ro=function(){const t=[];return Object.entries(j.PARTS).forEach(([o,s])=>{s.menuKey&&t.push({id:o,icon:"",group:"primary-tabs",label:`FLASH_ROLLS.settings.moduleSettingsMenu.tabs.${o}`})}),t},ne(j,Ge),ne(j,ke),ne(j,Ze),ne(j,Ft),D(j,"selectedTheme"),D(j,"DEFAULT_OPTIONS",{id:"flash-rolls-settings",tag:"form",window:{icon:"fas fa-cog",title:"FLASH_ROLLS.settings.moduleSettingsMenu.title",contentClasses:["standard-form","crlngn","flash5e","tabbed-settings"],resizable:!0},position:{width:700,height:"auto"},actions:{redefine:de(j,Ge,yo)},form:{handler:de(j,Ge,mo),closeOnSubmit:!0}}),D(j,"PARTS",{tabs:{template:"templates/generic/tab-navigation.hbs",isGMOnly:!1},generalSettings:{menuKey:"generalSettings",template:"modules/flash-rolls-5e/templates/settings-general.hbs",isGMOnly:!0},interfaceSettings:{menuKey:"interfaceSettings",template:"modules/flash-rolls-5e/templates/settings-interface.hbs",isGMOnly:!0},groupRolls:{menuKey:"groupRollsSettings",template:"modules/flash-rolls-5e/templates/settings-group-rolls.hbs",isGMOnly:!0},rollRequests:{menuKey:"rollRequestsSettings",template:"modules/flash-rolls-5e/templates/settings-roll-requests.hbs",isGMOnly:!0},footer:{template:"templates/generic/form-footer.hbs",isGMOnly:!1}}),D(j,"TABS",{primary:{initial:"interfaceSettings",tabs:de(Jt=j,Ge,Ro).call(Jt),labelPrefix:""}});let lt=j;class as extends FormApplication{constructor(...e){super(...e),window.open("https://www.patreon.com/c/carolingiandev/membership","_blank"),this.close()}render(){return this.close(),this}}function So(){return{moduleSettingsMenu:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),name:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),icon:"fas fa-cog",propType:lt,restricted:!0},supportPatreon:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.label"),name:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.label"),label:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.buttonLabel"),hint:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.hint"),icon:"fas fa-heart",propType:as,restricted:!1}}}const J=class J{static registerSettings(){const e=C();var t=J.get(e.debugMode.tag);t&&(CONFIG.debug.hooks=!0),Object.entries(e).forEach(s=>{const a=s[1],i={name:a.label,hint:a.hint,default:a.default,type:a.propType,scope:a.scope,config:a.config,requiresReload:a.requiresReload||!1,restricted:a.scope===G.world,onChange:n=>J.apply(a.tag,n)};a.choices&&(i.choices=a.choices),d.log("registerSettings",[i,i.scope]);try{game.settings.register(R,a.tag,i)}catch(n){d.log(`Setting ${a.tag} already registered or error:`,n)}})}static registerSettingsMenu(){var t;const e=Object.entries(So());for(const[o,s]of e)if(s.restricted&&((t=game.user)!=null&&t.isGM)||!s.restricted){const a={name:s.tag,label:s.label,hint:s.hint,icon:s.icon,type:s.propType,restricted:s.restricted};game.settings.registerMenu(R,s.tag,a)}J.updateColorScheme(),J.validateAndUpdateIconLayout(),J.checkMidiQol(),J.initializeMaxIconsPerRow()}static checkMidiQol(){const e=C(),t=q.isModuleOn("midi-qol"),o=J.get(e.rollInterceptionEnabled.tag);d.log("checkMidiQol",[t,o])}static updateColorScheme(){var o;const e=game.settings.get("core","uiConfig");let t=(o=e==null?void 0:e.colorScheme)==null?void 0:o.interface;t||(matchMedia("(prefers-color-scheme: dark)").matches?t="dark":matchMedia("(prefers-color-scheme: light)").matches&&(t="light")),J.coreColorScheme=t,d.log("SettingsUtil.updateColorScheme",[e,J.coreColorScheme])}static get(e,t=R){if(!e)return null;let o=!1;try{if(t===R)o=game.settings.get(t,e);else{let a=game.settings.storage.get("client")[`${t}.${e}`];a===void 0&&(a=game.settings.storage.get("world").getSetting(`${t}.${e}`),o=a==null?void 0:a.value)}}catch{return d.log(`Setting ${t}.${e} not found, returning false`),!1}return o}static async set(e,t,o=R){if(!e)return!1;let s=game.settings.storage.get("client")[`${o}.${e}`];s||(s=game.settings.storage.get("world").getSetting(`${o}.${e}`),d.log("SettingsUtil.set - world Setting?",[s]));try{await game.settings.set(o,e,t),d.log("SettingsUtil.set - success",[o,e,t])}catch(a){d.error("SettingsUtil.set - error",[a])}return!0}static apply(e,t){const o=C();switch(e){case o.rollRequestsEnabled.tag:J.applyRollRequestsEnabled(t);break;case o.rollInterceptionEnabled.tag:J.applyRollInterceptionEnabled(t);break;case o.compactMode.tag:J.applyCompactMode(t);break;case o.menuLayout.tag:J.applyMenuLayout(t);break;case o.menuIconsLayout.tag:J.applyMenuIconsLayout(t);break;case o.maxIconsPerRow.tag:J.applyMaxIconsPerRow(t);break;case o.autoBlockMovementInCombat.tag:J.applyAutoBlockMovementInCombat(t);break}}static applyRollInterceptionEnabled(e){J.checkMidiQol()}static applyRollRequestsEnabled(e){const t=document.querySelector(".chat-controls .flash-rolls-icon");t&&(e?t.classList.add("active"):t.classList.remove("active"))}static applyCompactMode(e){const t=C(),o=e||J.get(t.compactMode.tag);d.log("applyCompactMode",[o]),x.refreshIfOpen()}static applyMenuLayout(e){const t=C(),o=e||J.get(t.menuLayout.tag);d.log("applyMenuLayout",[o]),x.refreshIfOpen()}static applyMenuIconsLayout(e){const t=C(),o=e||J.get(t.menuIconsLayout.tag);d.log("applyMenuIconsLayout",[o]),x.refreshIfOpen()}static initializeMaxIconsPerRow(){const e=C(),t=J.get(e.maxIconsPerRow.tag)||5;q.addCSSVars("--fr5e-menu-icons-limit",t),d.log("initializeMaxIconsPerRow",[t])}static applyMaxIconsPerRow(e){var a,i;const t=C();let o=e||J.get(t.maxIconsPerRow.tag)||5;const s=(i=(a=game.modules.get(R))==null?void 0:a.api)==null?void 0:i.IconLayoutUtil;if(s){const n=s.getEnabledIcons("actorActions");n&&o>n.length&&(o=n.length)}o<1&&(o=1),d.log("applyMaxIconsPerRow",[o,e]),q.addCSSVars("--fr5e-menu-icons-limit",o),x.refreshIfOpen()}static async validateAndUpdateIconLayout(){const e=C(),t=J.get(e.menuIconsLayout.tag),o=yt();if(!t){d.log("validateAndUpdateIconLayout - no current layout found, using default");return}let s=!1;const a=foundry.utils.deepClone(t);for(const[i,n]of Object.entries(o)){a[i]||(a[i]=[]);const r=new Set(n.map(u=>u.id));a[i].length,a[i]=a[i].filter(u=>r.has(u.id)?!0:(d.log(`validateAndUpdateIconLayout - removed obsolete icon: ${u.id} from ${i}`),s=!0,!1));const l=new Set(a[i].map(u=>u.id));let c=Math.max(...a[i].map(u=>u.order||0),-1);for(const u of n)l.has(u.id)||(c++,a[i].push({...u,order:c}),s=!0,d.log(`validateAndUpdateIconLayout - added missing icon: ${u.id} to ${i}`))}s?(await J.set(e.menuIconsLayout.tag,a),d.log("validateAndUpdateIconLayout - updated layout",a)):d.log("validateAndUpdateIconLayout - no changes needed")}static applyAutoBlockMovementInCombat(e){if(!game.user.isGM)return;const t=game.combat;t&&(d.log("applyAutoBlockMovementInCombat",[e,t]),e?Te.onCombatStart(t,{}):Te.onCombatEnd(t))}};D(J,"coreColorScheme","dark");let _=J;class is{static initialize(){d.log("ActorDirectoryIconUtil.initialize"),Hooks.on(H.RENDER_ACTOR_DIRECTORY,this.onRenderActorDirectory.bind(this)),Hooks.on(H.UPDATE_ACTOR,this.onUpdateActor.bind(this)),this.updateExistingDirectory()}static updateExistingDirectory(){const e=ui.actors;e&&e.rendered&&e.element?(d.log("ActorDirectoryIconUtil.updateExistingDirectory - Found rendered directory, adding icons"),this.onRenderActorDirectory(e,e.element)):d.log("ActorDirectoryIconUtil.updateExistingDirectory - No rendered directory found")}static onRenderActorDirectory(e,t){t.querySelectorAll(".directory-item.actor").forEach(s=>{const a=s.dataset.entryId||s.dataset.documentId;a&&this.updateActorIcon(s,a)})}static onUpdateActor(e,t){var s;const o=(s=t.flags)==null?void 0:s["flash-rolls-5e"];o&&(d.log("ActorDirectoryIconUtil.onUpdateActor - Flash Token Bar flags changed",[e.name,o]),this.refreshActorIcon(e.id))}static updateActorIcon(e,t){const o=e.querySelector("span.fas.fa-bolt, span.fas.fa-bolt-slash");o&&o.remove();const s=game.actors.get(t);if(!s)return;const a=ae.isFavorite(s),i=ae.isBlocked(s);if(!a&&!i)return;const n=document.createElement("span");i?(n.className="fas fa-bolt-slash",n.dataset.tooltip=game.i18n.localize("FLASH_ROLLS.contextMenu.unblockFromMenu"),n.dataset.tooltipDirection="LEFT",n.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),ae.toggleBlocked(t,!1)})):a&&(n.className="fas fa-bolt",n.dataset.tooltip=game.i18n.localize("FLASH_ROLLS.contextMenu.blockFromMenu"),n.dataset.tooltipDirection="LEFT",n.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),ae.toggleFavorite(t,!1)})),n.style.cursor="pointer",e.appendChild(n)}static refreshActorIcon(e){const t=document.querySelector(`.directory-item.actor[data-entry-id="${e}"], .directory-item.actor[data-document-id="${e}"]`);t&&this.updateActorIcon(t,e)}static refreshAllIcons(){d.log("ActorDirectoryIconUtil.refreshAllIcons"),document.querySelectorAll(".directory-item.actor").forEach(t=>{const o=t.dataset.entryId||t.dataset.documentId;o&&this.updateActorIcon(t,o)})}}class le{static onPreRollGM(e,t,o){var s;if(!(e._flashRollsProcessed||Ae.isMidiActive)&&(e._flashRollsProcessed=!0,d.log("RollHooksHandler.onPreRollGM",[e,t,o]),(s=e.subject)!=null&&s.item)){e.rolls=P.consolidateRolls(e.rolls);const a=q.areSkipKeysPressed(e.event),i=e.subject.item.getFlag(R,"tempAttackConfig")||e.subject.item.getFlag(R,"tempDamageConfig")||e.subject.item.getFlag(R,"tempSaveConfig");d.log("RollHooksHandler.onPreRollGM - flag",[i]),((i==null?void 0:i.skipRollDialog)===!0||a)&&(t.configure=!1,d.log("RollHooksHandler.onPreRollGM - Local GM roll, skipping dialog via stored flag"))}}static onPreRollInitiativeDialog(e,t,o){var i,n,r,l,c;if(e._flashRollsProcessed)return;e._flashRollsProcessed=!0;const s=e.subject;q.areSkipKeysPressed(e.event);const a=s.getFlag(R,"tempInitiativeConfig");if(d.log("RollHooksHandler.onPreRollInitiativeDialog triggered",[e,a,t,o]),!a){d.log("RollHooksHandler.onPreRollInitiativeDialog - No stored config, player-initiated roll, returning early");return}t.configure=!0,d.log("RollHooksHandler.onPreRollInitiativeDialog - Player roll request, always showing dialog"),e.advantage=(a==null?void 0:a.advantage)||e.advantage||!1,e.disadvantage=(a==null?void 0:a.disadvantage)||e.disadvantage||!1,e.rollMode=(a==null?void 0:a.rollMode)||e.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,o.rollMode=(a==null?void 0:a.rollMode)||o.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,(r=(n=(i=a==null?void 0:a.rolls)==null?void 0:i[0])==null?void 0:n.data)!=null&&r.situational&&((c=(l=e.rolls)==null?void 0:l[0])!=null&&c.data)&&(e.rolls[0].data.situational=a.rolls[0].data.situational)}static onPreRollAttackV2(e,t,o){var i,n;if(e._flashRollsProcessed)return;e._flashRollsProcessed=!0,d.log("RollHooksHandler.onPreRollAttackV2 triggered",[e,t,o]);const s=(n=(i=e.subject)==null?void 0:i.item)==null?void 0:n.getFlag(R,"tempAttackConfig");if(!s){d.log("RollHooksHandler.onPreRollAttackV2 - No stored config, player-initiated roll, returning early");return}q.isModuleOn("midi-qol")&&e.midiOptions&&$e.onPreRollAttackV2(e,t,o),t.configure=!0,d.log("RollHooksHandler.onPreRollAttackV2 - Player roll request, always showing dialog"),s.attackMode&&(e.attackMode=s.attackMode),s.ammunition&&(e.ammunition=s.ammunition),s.mastery!==void 0&&(e.mastery=s.mastery),e.advantage=s.advantage||!1,e.disadvantage=s.disadvantage||!1,o.rollMode=s.rollMode||o.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,s.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=s.situational),d.log("RollHooksHandler.onPreRollAttackV2 - Applied stored configuration to attack roll",[e,o])}static onPreRollDamageV2(e,t,o){var i,n;if(e._flashRollsProcessed)return;e._flashRollsProcessed=!0,d.log("RollHooksHandler.onPreRollDamageV2 triggered",[e,t,o]);const s=(n=(i=e.subject)==null?void 0:i.item)==null?void 0:n.getFlag(R,"tempDamageConfig");if(!s){d.log("RollHooksHandler.onPreRollDamageV2 - No stored config, player-initiated roll, returning early");return}const a=q.isModuleOn("midi-qol");e.rolls=P.consolidateRolls(e.rolls),a&&e.midiOptions&&$e.onPreRollDamageV2(e,t,o),t.configure=!0,d.log("RollHooksHandler.onPreRollDamageV2 - Found stored request config from flag",[s,s.situational]),s.critical&&(e.critical=s.critical),o.rollMode=s.rollMode||o.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,d.log("RollHooksHandler.onPreRollDamageV2 triggered #1",[e,t,o]),s.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=s.situational,e._flashRollsSituational=s.situational),d.log("RollHooksHandler.onPreRollDamageV2 - Applied stored configuration to damage roll",[e,o])}static onPreRollAbilityCheck(e,t,o){e._flashRollsProcessed||(e._flashRollsProcessed=!0,d.log("RollHooksHandler.onPreRollAbilityCheck",[e,t,o]),e.isRollRequest&&(t.configure=!0))}static onPreRollHitDieV2(e,t,o){if(!e._flashRollsProcessed&&(e._flashRollsProcessed=!0,d.log("RollHooksHandler.onPreRollHitDieV2 triggered",[e,t,o]),e.rolls&&e.rolls.length>1)){const s=[];for(let a=0;a<e.rolls.length;a++){const i=e.rolls[a];i&&i.data&&i.data.situational&&s.push(i.data.situational)}if(s.length>0){e.rolls[0].data||(e.rolls[0].data={});const a=[...new Set(s)];e.rolls[0].data.situational=a.map(i=>{const n=i.toString().trim();return n.startsWith("-")?`(${n})`:n.startsWith("+")?`${n.substring(1)}`:`${n}`}).join(" + "),game.user.isGM&&!e.rolls[0].parts.find(i=>i.includes("@situational"))&&e.rolls[0].parts.push("@situational")}e.rolls=e.rolls.slice(0,1),d.log("RollHooksHandler.onPreRollHitDieV2 - Cleaned up hit die rolls",e.rolls)}}static onPostRollConfig(e,t,o,s){t._showRequestedBy&&e.length>0&&(s.data=s.data||{},s.data._showRequestedBy=!0,s.data._requestedBy=t._requestedBy)}static onRollDamageV2(e,t,o,s){var l;const a=(l=t.subject)==null?void 0:l.item;if(d.log("RollHooksHandler.onRollDamageV2 - scheduled template removal",[a==null?void 0:a.name,a==null?void 0:a.uuid]),!a)return;if(Re.templateRemovalTimers.has(a.uuid)){d.log("RollHooksHandler.onRollDamageV2 - template removal already scheduled for item",[a.uuid]);return}Re.templateRemovalTimers.add(a.uuid);const i=C(),r=_.get(i.templateRemovalTimeout.tag)*1e3;setTimeout(()=>{q.removeTemplateForItem(a),Re.templateRemovalTimers.delete(a.uuid)},r)}}const Me=class Me{static initialize(){d.log("GroupTokenTracker.initialize"),this.setupPlaceMembersTracking(),Hooks.on(H.CREATE_TOKEN,this.onCreateToken.bind(this)),Hooks.on(H.DELETE_TOKEN,this.onDeleteToken.bind(this)),Hooks.on(H.DELETE_ACTOR,this.onDeleteActor.bind(this)),Hooks.on(H.UPDATE_ACTOR,this.onUpdateActor.bind(this)),Hooks.on(H.CANVAS_READY,this.onCanvasReady.bind(this)),Hooks.on(ee.RENDER_GROUP_ACTOR_SHEET,this.onRenderActorSheet.bind(this)),Hooks.on(ee.RENDER_ENCOUNTER_ACTOR_SHEET,this.onRenderActorSheet.bind(this)),game.user.isGM&&setTimeout(()=>this.migrateLegacyAssociationsForAllGroups(),500)}static async migrateLegacyAssociationsForAllGroups(){const e=C();let t=!1;try{t=game.settings.get(R,e.legacyTokenAssociationsMigrated.tag)}catch{d.log("GroupTokenTracker: Migration setting not yet registered, proceeding with migration check")}if(t){d.log("GroupTokenTracker: Legacy migration already completed globally");return}if(!game.actors.some(a=>(a.type==="group"||a.type==="encounter")&&a.getFlag(R,"tokenAssociations")&&!a.getFlag(R,"tokenAssociationsByScene"))){d.log("GroupTokenTracker: No legacy associations to migrate, setting global flag");try{await game.settings.set(R,e.legacyTokenAssociationsMigrated.tag,!0)}catch{d.log("GroupTokenTracker: Could not set migration flag, setting may not be registered yet")}return}const s=game.actors.filter(a=>(a.type==="group"||a.type==="encounter")&&a.getFlag(R,"tokenAssociations")&&!a.getFlag(R,"tokenAssociationsByScene"));for(const a of s)await this.migrateLegacyAssociations(a);try{await game.settings.set(R,e.legacyTokenAssociationsMigrated.tag,!0),d.log(`GroupTokenTracker: Migrated legacy associations for ${s.length} group actors and set global completion flag`)}catch{d.log(`GroupTokenTracker: Migrated legacy associations for ${s.length} group actors but could not set completion flag`)}}static setupPlaceMembersTracking(){Hooks.on(H.PRE_CREATE_TOKEN,(e,t,o,s)=>{if(!(s!==game.user.id||!game.user.isGM)){d.log("preCreateToken",[e,t,o,s]);for(const[a,i]of this.pendingPlacements.entries())i.memberActorIds.includes(t.actorId)&&i.isPlacing&&e.updateSource({flags:{[R]:{groupId:a,fromGroupPlacement:!0}}})}}),this._wrapPlaceMembersMethod()}static _wrapPlaceMembersMethod(){if(!Qe.register("CONFIG.Actor.dataModels.group.prototype.placeMembers",async function(t,...o){const s=this.parent;return await Me._trackPlaceMembers(s),t(...o)},"WRAPPER")){d.log("GroupTokenTracker: libWrapper not available, using fallback wrapping for group.placeMembers");const t=CONFIG.Actor.dataModels.group.prototype.placeMembers;CONFIG.Actor.dataModels.group.prototype.placeMembers=async function(...o){const s=this.parent;return await Me._trackPlaceMembers(s),t.call(this,...o)}}if(CONFIG.Actor.dataModels.encounter&&!Qe.register("CONFIG.Actor.dataModels.encounter.prototype.placeMembers",async function(o,...s){const a=this.parent;return await Me._trackPlaceMembers(a),o(...s)},"WRAPPER")){d.log("GroupTokenTracker: libWrapper not available, using fallback wrapping for encounter.placeMembers");const o=CONFIG.Actor.dataModels.encounter.prototype.placeMembers;CONFIG.Actor.dataModels.encounter.prototype.placeMembers=async function(...s){const a=this.parent;return await Me._trackPlaceMembers(a),o.call(this,...s)}}}static async _trackPlaceMembers(e){d.log("GroupTokenTracker: placeMembers clicked for",e.name);const t=game.scenes.current;t&&await this.removeGroupAssociations(e,t);const o=await e.system.getPlaceableMembers(),s=o.map(n=>n.actor.id),a=o.reduce((n,r)=>{var c;const l=((c=r.quantity)==null?void 0:c.value)||1;return n+l},0);this.pendingPlacements.set(e.id,{groupActor:e,memberActorIds:s,expectedTokenCount:a,placedTokenCount:0,timestamp:Date.now(),isPlacing:!0});const i=e.getFlag(R,"tokenAssociationsByScene")||{};this.activeAssociations.set(e.id,JSON.parse(JSON.stringify(i))),setTimeout(()=>{const n=this.pendingPlacements.get(e.id);n&&(n.isPlacing=!0,d.log(`GroupTokenTracker: Token placement phase active for group ${e.name}`))},100),setTimeout(()=>{var r;const n=this.pendingPlacements.get(e.id);n&&n.timestamp===((r=this.pendingPlacements.get(e.id))==null?void 0:r.timestamp)&&(d.log(`GroupTokenTracker: Timeout reached for group ${e.name}, cleaning up`),this.pendingPlacements.delete(e.id),this.activeAssociations.delete(e.id))},12e4)}static async onCreateToken(e,t,o){if(o!==game.user.id||(await this.cleanupCopiedTokenFlags(e),!game.user.isGM))return;const s=e.getFlag(R,"fromGroupPlacement"),a=e.getFlag(R,"groupId");if(!s||!a){await this.cleanupDanglingAssociations();return}const i=this.pendingPlacements.get(a);if(!i)return;const n=e.actorId,r=e.parent.id,l=e.uuid,c=this.activeAssociations.get(a)||{};c[r]||(c[r]={}),c[r][n]||(c[r][n]=[]);const u=[...c[r][n]];u.includes(l)||(u.push(l),c[r][n]=u,this.activeAssociations.set(a,c),await i.groupActor.setFlag(R,"tokenAssociationsByScene",c),await e.unsetFlag(R,"fromGroupPlacement"),i.placedTokenCount++,i.placedTokenCount>=i.expectedTokenCount?(i.isPlacing=!1,d.log(`GroupTokenTracker: All tokens placed for group ${i.groupActor.name}, cleaning up`),this.pendingPlacements.delete(a),this.activeAssociations.delete(a),setTimeout(()=>{this._reRenderGroupSheets(a)},100)):this._reRenderGroupSheets(a)),await this.cleanupDanglingAssociations()}static async onDeleteActor(e,t,o){if(e.type!=="group"&&e.type!=="encounter"||!game.user.isGM)return;d.log(`GroupTokenTracker: Group/encounter ${e.name} deleted, cleaning up token flags`);const s=e.getFlag(R,"tokenAssociationsByScene");if(!s){d.log(`GroupTokenTracker: No associations found for deleted group ${e.name}`);return}d.log(`GroupTokenTracker: Found associations for ${Object.keys(s).length} scene(s)`);let a=0,i=0;for(const[n,r]of Object.entries(s)){const l=game.scenes.get(n);d.log("GroupTokenTracker: Processing scene",[(l==null?void 0:l.name)||n,r]);for(const[c,u]of Object.entries(r)){d.log("GroupTokenTracker: Processing tokens for actor",[c,u]);for(const g of u)try{const f=await fromUuid(g);f?(await f.unsetFlag(R,"groupId"),d.log(`GroupTokenTracker: Removed groupId flag from token ${f.name} in scene ${(l==null?void 0:l.name)||n}`),a++):(d.log(`GroupTokenTracker: Token ${g} no longer exists`),i++)}catch(f){d.log(`GroupTokenTracker: Failed to remove flag from token ${g}`,f),i++}}}d.log(`GroupTokenTracker: Cleaned up token flags for deleted group ${e.name} - ${a} succeeded, ${i} failed`)}static async onUpdateActor(e,t,o,s){var l,c;if(e.type!=="group"&&e.type!=="encounter"||!game.user.isGM||!((l=t.system)!=null&&l.members))return;d.log(`GroupTokenTracker: Group/encounter ${e.name} updated, checking for removed members`);const a=e.getFlag(R,"tokenAssociationsByScene");if(!a)return;const i=new Set;if(e.type==="group")for(const u of e.system.members||[])(c=u.actor)!=null&&c.id&&i.add(u.actor.id);else for(const u of e.system.members||[])try{const g=await fromUuid(u.uuid);g!=null&&g.id&&i.add(g.id)}catch(g){d.log(`GroupTokenTracker: Failed to resolve member UUID ${u.uuid}`,g)}let n=!1;const r={...a};for(const[u,g]of Object.entries(r)){for(const f of Object.keys(g))if(!i.has(f)){d.log(`GroupTokenTracker: Member ${f} removed from group ${e.name}, cleaning up associations`);const p=g[f];for(const m of p)try{const k=await fromUuid(m);k&&(await k.unsetFlag(R,"groupId"),d.log(`GroupTokenTracker: Removed groupId flag from token ${k.name}`))}catch(k){d.log(`GroupTokenTracker: Failed to remove flag from token ${m}`,k)}delete g[f],n=!0}Object.keys(g).length===0&&delete r[u]}n&&(Object.keys(r).length===0?await e.unsetFlag(R,"tokenAssociationsByScene"):await e.setFlag(R,"tokenAssociationsByScene",r),d.log(`GroupTokenTracker: Cleaned up associations for removed members from group ${e.name}`),this._reRenderGroupSheets(e.id))}static async onDeleteToken(e,t,o){const s=e.getFlag(R,"groupId");if(!s)return;const a=game.actors.get(s);if(!a)return;const i=e.actorId,n=e.parent.id,r=e.uuid;d.log(`GroupTokenTracker: onDeleteToken - Token ${e.name} deleted from scene ${n}, group ${a.name}`);const l=a.getFlag(R,"tokenAssociationsByScene");if(!l||!l[n]||!l[n][i]){d.log("GroupTokenTracker: No associations found for this token");return}const c=l[n][i].indexOf(r);if(c===-1){d.log("GroupTokenTracker: Token UUID not found in associations");return}d.log(`GroupTokenTracker: Removing deleted token ${r} from group ${s}`),l[n][i].splice(c,1),l[n][i].length===0&&delete l[n][i],Object.keys(l[n]).length===0&&delete l[n],Object.keys(l).length===0?await a.unsetFlag(R,"tokenAssociationsByScene"):await a.setFlag(R,"tokenAssociationsByScene",l),await this.cleanupDanglingAssociations(),this._reRenderGroupSheets(s)}static _reRenderGroupSheets(e=null){var t,o,s,a;if(foundry.applications.instances)for(const i of foundry.applications.instances.values())(((t=i.document)==null?void 0:t.type)==="group"||((o=i.document)==null?void 0:o.type)==="encounter")&&(!e||i.document.id===e)&&(d.log(`GroupTokenTracker: Re-rendering ApplicationV2 sheet for ${i.document.name}`),i.render({force:!0}));if(ui.windows)for(const i of Object.values(ui.windows))(((s=i.document)==null?void 0:s.type)==="group"||((a=i.document)==null?void 0:a.type)==="encounter")&&(!e||i.document.id===e)&&(d.log(`GroupTokenTracker: Re-rendering legacy sheet for ${i.document.name}`),i.render(!1))}static cleanupOldPendingPlacements(){const e=Date.now(),t=5e3;for(const[o,s]of this.pendingPlacements.entries())e-s.timestamp>t&&(d.log(`GroupTokenTracker: Cleaning up old pending placement for group ${o}`),this.pendingPlacements.delete(o))}static async cleanupInvalidTokens(e){if(e.type!=="group"&&e.type!=="encounter")return;const t=e.getFlag(R,"tokenAssociationsByScene");if(!t)return;let o=!1;const s={};for(const[a,i]of Object.entries(t)){if(!game.scenes.get(a)){d.log(`GroupTokenTracker: Scene ${a} no longer exists, removing associations`),o=!0;continue}const r={};for(const[l,c]of Object.entries(i)){const u=c.filter(g=>{try{const f=fromUuidSync(g);return f&&f.actorId===l&&f.parent.id===a}catch{return d.log(`GroupTokenTracker: Invalid token UUID ${g}, removing`),!1}});u.length>0&&(r[l]=u),u.length!==c.length&&(o=!0)}Object.keys(r).length>0&&(s[a]=r)}o&&(Object.keys(s).length===0?await e.unsetFlag(R,"tokenAssociationsByScene"):await e.setFlag(R,"tokenAssociationsByScene",s),d.log(`GroupTokenTracker: Cleaned invalid tokens for group ${e.name}`))}static async cleanupDanglingAssociations(){const e=game.actors.filter(t=>(t.type==="group"||t.type==="encounter")&&t.getFlag(R,"tokenAssociationsByScene"));for(const t of e)await this.cleanupInvalidTokens(t);d.log(`GroupTokenTracker: Cleaned dangling associations for ${e.length} group actors`)}static getGroupForToken(e){const t=e.getFlag(R,"groupId");return t&&game.actors.get(t)||null}static getGroupTokens(e,t=null){const o=t||game.scenes.active,s=new Map;if(!o)return s;const i=(e.getFlag(R,"tokenAssociationsByScene")||{})[o.id];if(!i)return s;for(const[n,r]of Object.entries(i)){const l=r.map(c=>{try{return fromUuidSync(c)}catch{return d.log(`GroupTokenTracker: Invalid token UUID ${c}`),null}}).filter(c=>c&&c.actorId===n&&c.parent.id===o.id);l.length>0&&s.set(n,l)}return s}static getAllGroupTokens(e){const t=e.getFlag(R,"tokenAssociationsByScene")||{},o=new Map;for(const[s,a]of Object.entries(t)){if(!game.scenes.get(s))continue;const n=new Map;for(const[r,l]of Object.entries(a)){const c=l.map(u=>{try{return fromUuidSync(u)}catch{return null}}).filter(u=>u&&u.actorId===r);c.length>0&&n.set(r,c)}n.size>0&&o.set(s,n)}return o}static async cleanupCopiedTokenFlags(e){var n,r;const t=e.getFlag(R);if(!t)return;const o=t.groupId;if(t.fromGroupPlacement)return;let a=!1;const i=[];if(o){const l=game.actors.get(o),c=e.parent.id,u=e.uuid;if(!l)a=!0,i.push("group actor no longer exists");else{const g=l.getFlag(R,"tokenAssociationsByScene");((r=(n=g==null?void 0:g[c])==null?void 0:n[e.actorId])==null?void 0:r.includes(u))||(a=!0,i.push("not in group associations"))}}t.movementRestriction&&!o&&(a=!0,i.push("orphaned movement restriction")),a&&(d.log(`GroupTokenTracker: Cleaning up invalid module flags from token ${e.name} (${e.id})`),d.log("GroupTokenTracker: Cleanup reasons:",i),d.log("GroupTokenTracker: Removing flags:",Object.keys(t)),await e.unsetFlag(R))}static async migrateLegacyAssociations(e){const t=e.getFlag(R,"tokenAssociations"),o=e.getFlag(R,"tokenAssociationsByScene");if(!t||o)return;d.log(`GroupTokenTracker: Migrating legacy associations for group ${e.name}`);const s={};let a=0;for(const i of game.scenes){const n={};for(const[r,l]of Object.entries(t)){const c=l.map(u=>{const g=i.tokens.get(u);return g&&g.actorId===r?g.uuid:null}).filter(u=>u!==null);c.length>0&&(n[r]=c,a+=c.length)}Object.keys(n).length>0&&(s[i.id]=n)}Object.keys(s).length>0?(await e.setFlag(R,"tokenAssociationsByScene",s),d.log(`GroupTokenTracker: Migrated ${a} tokens across ${Object.keys(s).length} scenes for group ${e.name}`)):d.log(`GroupTokenTracker: No valid tokens found to migrate for group ${e.name}`),await e.unsetFlag(R,"tokenAssociations")}static async checkAndSyncAssociations(e,t){const o=e.type==="group"?(e.system.members||[]).map(n=>({actor:n.actor,quantity:1})):await Promise.all((e.system.members||[]).map(async n=>{var c;const r=await fromUuid(n.uuid),l=typeof n.quantity=="object"?((c=n.quantity)==null?void 0:c.value)||1:n.quantity||1;return{actor:r,quantity:l}})),s=e.getFlag(R,"tokenAssociationsByScene")||{},a=s[t.id]||{};let i=!1;for(const{actor:n,quantity:r}of o){if(!n)continue;const l=n.id,c=a[l]||[],u=c.filter(k=>{try{const y=fromUuidSync(k);return y&&y.parent.id===t.id}catch{return!1}}),g=t.tokens.filter(k=>{var y,S;return k.actorId===l?!0:k.actorLink?!1:((S=(y=k.actor)==null?void 0:y.prototypeToken)==null?void 0:S.actorId)===l}),f=r,p=u.length,m=g.length;if(p!==f&&m>=f){i=!0;break}if(u.length!==c.length){i=!0;break}}i&&await this.autoSyncTokens(e,t),d.log("checkAndSyncAssociations",[s])}static async onRenderActorSheet(e,t,o){if(d.log("onRenderActorSheet",[e,t,o]),!e.document||!game.user.isGM||e.document.type!=="group"&&e.document.type!=="encounter")return;const s=this._getMainContentElement(t);if(!s)return;const a=game.scenes.current;if(!a)return;await this._cleanupInvalidAssociations(e.document);const i=this._countValidTokens(e.document,a),n=this._createTokenAssociationUI(e.document,a,i);this._removeExistingContainers(s),s.appendChild(n)}static _getMainContentElement(e){let t=e.querySelector('[data-container-id="main"]');return t||(t=e),t}static _removeExistingContainers(e){e.querySelectorAll(".flash5e-token-associations").forEach(o=>o.remove())}static async _cleanupInvalidAssociations(e){var a;const t=e.getFlag(R,"tokenAssociationsByScene")||{};let o=!1;d.log("onRenderActorSheet - tokenAssociationsByScene",[t]);const s=new Set;if(e.type==="group")for(const i of e.system.members||[])(a=i.actor)!=null&&a.id&&s.add(i.actor.id);else for(const i of e.system.members||[])try{const n=await fromUuid(i.uuid);n!=null&&n.id&&s.add(n.id)}catch(n){d.log(`GroupTokenTracker: Failed to resolve member UUID ${i.uuid}`,n)}for(const i of Object.keys(t)){if(!game.scenes.get(i)){delete t[i],o=!0;continue}const r=t[i];for(const[l,c]of Object.entries(r)){if(!s.has(l)){d.log(`GroupTokenTracker: Actor ${l} is not a member of group ${e.name}, removing stale associations`);for(const g of c)try{const f=await fromUuid(g);f&&(await f.unsetFlag(R,"groupId"),d.log(`GroupTokenTracker: Removed groupId flag from token ${f.name}`))}catch(f){d.log(`GroupTokenTracker: Failed to remove flag from token ${g}`,f)}delete r[l],o=!0;continue}const u=c.filter(g=>{try{const f=fromUuidSync(g);return f&&f.parent.id===i}catch{return!1}});u.length!==c.length&&(o=!0),u.length>0?r[l]=u:delete r[l]}Object.keys(r).length===0&&(delete t[i],o=!0)}o&&(Object.keys(t).length===0?await e.unsetFlag(R,"tokenAssociationsByScene"):await e.setFlag(R,"tokenAssociationsByScene",t),x.refreshIfOpen())}static _countValidTokens(e,t){const s=(e.getFlag(R,"tokenAssociationsByScene")||{})[t.id]||{};let a=0;for(const[i,n]of Object.entries(s))for(const r of n)try{const l=fromUuidSync(r);l&&l.parent.id===t.id&&a++}catch{}return a}static _createTokenAssociationUI(e,t,o){const s=document.createElement("div");s.classList.add("sheet-body","flash5e-token-associations"),o===0&&s.classList.add("no-tokens");const a=document.createElement("div");if(a.textContent=o>0?game.i18n.format("FLASH_ROLLS.ui.tokenAssociations.associatedTokens",{count:o}):game.i18n.localize("FLASH_ROLLS.ui.tokenAssociations.noTokensInScene"),s.appendChild(a),o>0){const i=document.createElement("div");i.className="button-group";const n=document.createElement("button");n.type="button",n.className="flash5e-select-tokens",n.textContent=game.i18n.localize("FLASH_ROLLS.ui.inputs.selectTokens"),n.addEventListener("click",async()=>{await this.selectGroupTokens(e,t)}),i.appendChild(n),s.appendChild(i)}return s}static async removeGroupAssociations(e,t){const o=e.getFlag(R,"tokenAssociationsByScene")||{},s=o[t.id]||{};if(Object.keys(s).length===0)return;const a=[];for(const i of Object.values(s))a.push(...i);for(const i of a)try{const n=fromUuidSync(i);n&&n.parent.id===t.id&&await n.unsetFlag(R,"groupId")}catch(n){d.log(`GroupTokenTracker: Failed to remove groupId flag from token ${i}`,n)}delete o[t.id],Object.keys(o).length===0?await e.unsetFlag(R,"tokenAssociationsByScene"):await e.setFlag(R,"tokenAssociationsByScene",o)}static async selectGroupTokens(e,t){const s=(e.getFlag(R,"tokenAssociationsByScene")||{})[t.id]||{},a=[];for(const i of Object.values(s))for(const n of i)try{const r=fromUuidSync(n);if(r&&r.parent.id===t.id){const l=canvas.tokens.get(r.id);l&&a.push(l)}}catch(r){d.log(`GroupTokenTracker: Failed to resolve token ${n}`,r)}if(a.length===0){I.notify("warn",`No tokens found for ${e.name} in ${t.name}`);return}canvas.tokens.releaseAll();for(const i of a)i.control({releaseOthers:!1});a.length>0&&canvas.animatePan({x:a[0].center.x,y:a[0].center.y,duration:250})}static async onCanvasReady(e){if(!game.user.isGM)return;const t=game.scenes.current;if(!t)return;const o=game.actors.filter(s=>s.type==="group"||s.type==="encounter");await Promise.all(o.map(s=>this.autoSyncTokens(s,t))),x.refreshIfOpen(),setTimeout(()=>{this._reRenderGroupSheets()},500)}static async autoSyncTokens(e,t){const o=e.getFlag(R,"tokenAssociationsByScene")||{},s=o[t.id]||{},a=e.type==="group"?(e.system.members||[]).map(n=>({actor:n.actor,quantity:1})):await Promise.all((e.system.members||[]).map(async n=>{var c;const r=await fromUuid(n.uuid),l=typeof n.quantity=="object"?((c=n.quantity)==null?void 0:c.value)||1:n.quantity||1;return{actor:r,quantity:l}}));let i=!1;for(const{actor:n,quantity:r}of a){if(!n)continue;const l=n.id,c=s[l]||[],u=c.filter(y=>{try{const S=fromUuidSync(y);return S&&S.parent.id===t.id}catch{return!1}}),g=t.tokens.filter(y=>{var b,v;const S=y.actorId===l,T=!y.actorLink&&((v=(b=y.actor)==null?void 0:b.prototypeToken)==null?void 0:v.actorId)===l;return S||T}),f=r,p=u.length;if(p>=f){u.length!==c.length&&(s[l]=u,i=!0);continue}const m=[];for(const y of g){const S=y.getFlag(R,"groupId"),T=u.includes(y.uuid);if(S&&S!==e.id){const b=game.actors.get(S);if(!b)d.log(`GroupTokenTracker: Clearing stale groupId flag from token ${y.name}`),await y.unsetFlag(R,"groupId");else{d.log(`GroupTokenTracker: Token ${y.name} belongs to different group ${b.name}, skipping`);continue}}T||m.push(y)}const k=m.slice(0,f-p);if(k.length>0){const y=[...u,...k.map(S=>S.uuid)];s[l]=y,i=!0;for(const S of k)await S.setFlag(R,"groupId",e.id)}}i&&(o[t.id]=s,await e.setFlag(R,"tokenAssociationsByScene",o),d.log(`GroupTokenTracker: Auto-sync completed for group ${e.name}`))}};D(Me,"pendingPlacements",new Map),D(Me,"activeAssociations",new Map);let fe=Me;class ns{static initialize(){const e=foundry.canvas.placeables.Token,t=e.prototype.animate;e.prototype.animate=async function(o,s={}){const a=C(),i=_.get(a.tokenMovementSpeed.tag);return i&&!s.movementSpeed&&(s.movementSpeed=i),t.call(this,o,s)}}}var xe,Ao,To,ko;const Ie=class Ie{static initialize(){this.originalActivationMS=game.tooltip.constructor.TOOLTIP_ACTIVATION_MS,de(this,xe,Ao).call(this),de(this,xe,To).call(this),de(this,xe,ko).call(this)}static setupAutoDismiss(e,t){t>0&&Ie.scheduleAutoDismiss(e,t*1e3)}static scheduleAutoDismiss(e,t){this.clearAutoDismiss(e);const o=setTimeout(()=>{game.tooltip.element===e&&game.tooltip.deactivate(),this.dismissTimers.delete(e)},t);this.dismissTimers.set(e,o)}static clearAutoDismiss(e){const t=this.dismissTimers.get(e);t&&(clearTimeout(t),this.dismissTimers.delete(e))}};xe=new WeakSet,Ao=function(){const e=game.tooltip,t=e.constructor,o=t.TOOLTIP_ACTIVATION_MS;e._frCustomDelayElement=null,window.addEventListener("pointerenter",s=>{var a;(a=s.target.dataset)!=null&&a.tooltip&&(e._frCustomDelayElement=s.target)},{capture:!0}),Object.defineProperty(t,"TOOLTIP_ACTIVATION_MS",{get(){var a;const s=e._frCustomDelayElement;if((a=s==null?void 0:s.closest)!=null&&a.call(s,"#flash-rolls-menu")&&s.dataset.tooltipDelay){const i=parseInt(s.dataset.tooltipDelay);if(!isNaN(i)&&i>0)return i}return o},configurable:!0})},To=function(){const e=game.tooltip.activate.bind(game.tooltip);game.tooltip.activate=function(t,o={}){if(t==null?void 0:t.closest("#flash-rolls-menu")){const a=C(),i=_.get(a.tooltipAutoDismiss.tag);if(i===0)return;const n=e(t,o);return Ie.setupAutoDismiss(t,i),n}return e(t,o)}},ko=function(){const e=game.tooltip.deactivate.bind(game.tooltip);game.tooltip.deactivate=function(){const t=e();return Ie.clearAutoDismiss(game.tooltip.element),Ie.lastHoveredElement=null,t}},ne(Ie,xe),D(Ie,"dismissTimers",new Map),D(Ie,"originalActivationMS",null);let wt=Ie;const rt=class rt{static getUpdateNewsUrl(){var o;const e=(o=game.modules.get("flash-rolls-5e"))==null?void 0:o.version,t=e?`https://github.com/crlngn/flash-rolls-5e/releases/download/v${e}/module-updates.json`:"";return`https://proxy.carolingian.io/proxy?url=${encodeURIComponent(t)}&v=${e}`}static init(){var e;(e=game.user)!=null&&e.isGM&&this.checkForUpdates()}static async cleanSetting(){const e=C();await _.set(e.lastUpdateId.tag,"")}static async checkForUpdates(){const e=C();try{const t=new AbortController,o=setTimeout(()=>t.abort(),1e4);try{const s=await _.get(e.lastUpdateId.tag),a=await rt.getIdFromRawJson();if(d.log("checkForUpdates...",[a,s]),s===a)return;const i=await fetch(rt.getUpdateNewsUrl(),{signal:t.signal,mode:"cors",credentials:"omit"});if(clearTimeout(o),!i.ok){d.warn("checkForUpdates | Failed to fetch update news",[i.status,i.statusText]);return}const n=await i.json();await this.displayUpdateNews(n),await _.set(e.lastUpdateId.tag,a),d.log("checkForUpdates | SUCCESS",[a])}catch(s){clearTimeout(o),s.name==="AbortError"?d.warn("checkForUpdates | Request timed out",[s]):d.warn("checkForUpdates | Fetch error",[s.message])}}catch(t){d.warn("checkForUpdates | Unexpected error",[t])}}static async displayUpdateNews(e){try{const t=`
        <div class="crlngn-news">
          <h3>${e.title}</h3>
          ${e.imageUrl?`<img src="${e.imageUrl}" alt="Update Preview" />`:""}
          ${e.videoUrl?`<div class="updates-media-container"><video controls autoplay loop src="${e.videoUrl}" alt="Update Preview" style="width: 100%"></video></div>`:""}
          <div class="crlngn-news-content">
          ${e.content}
          </div>
        </div>
      `;d.log("displayUpdateNews | Creating chat message",[e]);const o=await ChatMessage.create({content:t,whisper:[game.user.id],speaker:{alias:"Flash Token Bar 5e"}});d.log("displayUpdateNews | Chat message created",[o,e])}catch(t){d.error("displayUpdateNews | Error creating chat message",[t])}}};D(rt,"getIdFromRawJson",async()=>{const t=await fetch("https://raw.githubusercontent.com/crlngn/flash-rolls-5e/refs/heads/main/news/module-updates.json"),o=t.ok?await t.json():null;return o&&o.id||""});let Ot=rt;const Yt={d4:"d4",d6:"d6",d8:"d8",d10:"d10",d12:"d12",d20:"d20",d100:"d100"},bt=class bt{static initialize(){var e;if(!((e=game.modules.get("monks-active-tiles"))!=null&&e.active)){d.log("MonksActiveTilesIntegration: Monk's Active Tiles not active, skipping integration");return}Hooks.on("setupTileActions",t=>{d.log("MonksActiveTilesIntegration: Registering Flash Rolls 5e tile actions"),t.registerTileGroup(R,"Flash Rolls 5e"),this._registerRequestRollAction(t),this._registerHealAllAction(t),this._registerKillAllAction(t),this._registerToggleMovementAction(t),this._registerTeleportTokensAction(t),this._registerTransformActorsAction(t)})}static _registerRequestRollAction(e){e.registerTileAction(R,"request-roll",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.requestRoll"),group:R,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"},{id:"requestType",name:"Roll Type",type:"list",list:()=>{const t={};for(const[o,s]of Object.entries(Ke))t[s.name]=s.label;return t},required:!0,defvalue:A.SKILL,onChange:async(t,o,s,a)=>{var l,c,u;const i=$(o).val(),n=Object.values(Ke).find(g=>g.name===i),r=$('select[name="data.rollKey"]',t.element);if(r.length>0){if(r.empty(),i===A.CUSTOM)for(const[g,f]of Object.entries(Yt))r.append($("<option>",{value:g,text:f}));else if(n&&n.subList){const g=n.subList;let f={};if(g==="abilities"){f=((l=CONFIG.DND5E)==null?void 0:l.abilities)||{};for(const[p,m]of Object.entries(f))r.append($("<option>",{value:p,text:m.label}))}else if(g==="skills"){f=((c=CONFIG.DND5E)==null?void 0:c.skills)||{};for(const[p,m]of Object.entries(f))r.append($("<option>",{value:p,text:m.label}))}else if(g==="tools"){f=((u=CONFIG.DND5E)==null?void 0:u.tools)||{};for(const[p,m]of Object.entries(f)){const k=await this._getToolName(p,m);r.append($("<option>",{value:p,text:k}))}}}}t.checkConditional()}},{id:"rollKey",name:"Roll Name",type:"list",list:async t=>{var n,r,l,c,u;const o=(r=(n=t.element)==null?void 0:n.querySelector('select[name="data.requestType"]'))==null?void 0:r.value;if(!o)return{};if(o===A.CUSTOM)return Yt;const s=Object.values(Ke).find(g=>g.name===o);if(!s||!s.subList)return{};const a=s.subList,i={};if(a==="abilities")for(const[g,f]of Object.entries(((l=CONFIG.DND5E)==null?void 0:l.abilities)||{}))i[g]=f.label;else if(a==="skills")for(const[g,f]of Object.entries(((c=CONFIG.DND5E)==null?void 0:c.skills)||{}))i[g]=f.label;else if(a==="tools")for(const[g,f]of Object.entries(((u=CONFIG.DND5E)==null?void 0:u.tools)||{}))i[g]=await bt._getToolName(g,f);return i},conditional:t=>{var a,i;const o=(i=(a=t.element)==null?void 0:a.querySelector('select[name="data.requestType"]'))==null?void 0:i.value;if(!o)return!1;if(o===A.CUSTOM)return!0;const s=Object.values(Ke).find(n=>n.name===o);return s&&s.subList!==null}},{id:"dc",name:"Difficulty Class (DC)",type:"number",defvalue:10,min:0,max:50},{id:"advantage",name:"Advantage/Disadvantage",type:"list",list:()=>({normal:"Normal",advantage:"Advantage",disadvantage:"Disadvantage"}),defvalue:"normal"},{id:"bonus",name:"Situational Bonus",type:"text",help:"Enter a bonus/penalty (e.g., '+2', '-1', '1d4')"},{id:"skipRollDialog",name:"Skip Roll Dialog",type:"checkbox",defvalue:!1}],fn:async t=>{var u,g,f,p,m,k;const{action:o,tokens:s,tile:a}=t;if(Q._isTeleporting)return d.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=s;if(((g=(u=o.data)==null?void 0:u.entity)==null?void 0:g.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const y=a.entitiesWithin({collection:"tokens"});Array.isArray(y)&&y.length>0&&(i=y)}else if(((p=(f=o.data)==null?void 0:f.entity)==null?void 0:p.id)==="players")i=canvas.tokens.placeables.filter(y=>{var S;return(S=y.actor)==null?void 0:S.hasPlayerOwner});else if((k=(m=o.data)==null?void 0:m.entity)!=null&&k.id&&typeof o.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(o.data.entity.id)){const y=o.data.entity.id,S=await fromUuid(y);S&&(i=[S])}const n=this._resolveActorIds(null,i);if(!n||n.length===0)return I.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{};const r=this._generateGroupRollId(a,o);if(this._pendingGroupRolls.has(r)){const y=this._pendingGroupRolls.get(r);for(const S of n)y.actorIds.includes(S)||y.actorIds.push(S);return{}}this._pendingGroupRolls.set(r,{actorIds:[...n],action:o,tile:a}),await new Promise(y=>setTimeout(y,50));const l=this._pendingGroupRolls.get(r);this._pendingGroupRolls.delete(r);const c={requestType:o.data.requestType,actorIds:l.actorIds,dc:o.data.dc,advantage:o.data.advantage==="advantage",disadvantage:o.data.advantage==="disadvantage",skipRollDialog:o.data.skipRollDialog===!0,sendAsRequest:!0,groupRollId:r};return o.data.rollKey&&(c.rollKey=o.data.rollKey),o.data.bonus&&(c.situationalBonus=o.data.bonus),await I.requestRoll(c),{}},content:async(t,o)=>{var f,p,m,k,y,S;const s=(f=o.data)==null?void 0:f.requestType,a=Object.values(Ke).find(T=>T.name===s),i=(a==null?void 0:a.label)||s||"Unknown";let n="";(p=o.data)!=null&&p.rollKey&&(o.data.rollKey.length===3?n=` (${this._getSkillName(o.data.rollKey)||this._getAbilityName(o.data.rollKey)||o.data.rollKey})`:n=` (${o.data.rollKey})`);const r=(m=o.data)!=null&&m.dc?` DC ${o.data.dc}`:"",l=((k=o.data)==null?void 0:k.advantage)||"normal",c=this._getAdvantageLabel(l),u=(y=o.data)!=null&&y.bonus?` (${o.data.bonus})`:"",g=(S=o.data)!=null&&S.skipRollDialog?" [Skip Dialog]":"";return`<div>Request <span class="value">${i}${n}</span>${r}${c?" "+c:""}${u}${g}</div>`}})}static _registerHealAllAction(e){e.registerTileAction(R,"heal-all",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.healAll"),group:R,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"}],fn:async t=>{var r,l,c,u,g,f;const{action:o,tokens:s,tile:a}=t;if(Q._isTeleporting)return d.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=s;if(((l=(r=o.data)==null?void 0:r.entity)==null?void 0:l.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const p=a.entitiesWithin({collection:"tokens"});Array.isArray(p)&&p.length>0&&(i=p)}else if(((u=(c=o.data)==null?void 0:c.entity)==null?void 0:u.id)==="players")i=canvas.tokens.placeables.filter(p=>{var m;return(m=p.actor)==null?void 0:m.hasPlayerOwner});else if((f=(g=o.data)==null?void 0:g.entity)!=null&&f.id&&typeof o.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(o.data.entity.id)){const p=o.data.entity.id,m=await fromUuid(p);m&&(i=[m])}const n=this._resolveActorIds(null,i);return!n||n.length===0?(I.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{}):(await I.healAll(n),{})},content:async(t,o)=>`<div>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.content.healAll")}</div>`})}static _registerKillAllAction(e){e.registerTileAction(R,"kill-all",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.killAll"),group:R,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"}],fn:async t=>{var r,l,c,u,g,f;const{action:o,tokens:s,tile:a}=t;if(Q._isTeleporting)return d.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=s;if(((l=(r=o.data)==null?void 0:r.entity)==null?void 0:l.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const p=a.entitiesWithin({collection:"tokens"});Array.isArray(p)&&p.length>0&&(i=p)}else if(((u=(c=o.data)==null?void 0:c.entity)==null?void 0:u.id)==="players")i=canvas.tokens.placeables.filter(p=>{var m;return(m=p.actor)==null?void 0:m.hasPlayerOwner});else if((f=(g=o.data)==null?void 0:g.entity)!=null&&f.id&&typeof o.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(o.data.entity.id)){const p=o.data.entity.id,m=await fromUuid(p);m&&(i=[m])}const n=this._resolveActorIds(null,i);return!n||n.length===0?(I.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{}):(await I.killAll(n),{})},content:async(t,o)=>`<div>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.content.killAll")}</div>`})}static _registerOpenSheetsAction(e){e.registerTileAction(R,"open-sheets",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.openSheets"),group:R,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"}],fn:async t=>{var r,l,c,u,g,f;const{action:o,tokens:s,tile:a}=t;if(Q._isTeleporting)return d.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=s;if(((l=(r=o.data)==null?void 0:r.entity)==null?void 0:l.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const p=a.entitiesWithin({collection:"tokens"});Array.isArray(p)&&p.length>0&&(i=p)}else if(((u=(c=o.data)==null?void 0:c.entity)==null?void 0:u.id)==="players")i=canvas.tokens.placeables.filter(p=>{var m;return(m=p.actor)==null?void 0:m.hasPlayerOwner});else if((f=(g=o.data)==null?void 0:g.entity)!=null&&f.id&&typeof o.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(o.data.entity.id)){const p=o.data.entity.id,m=await fromUuid(p);m&&(i=[m])}const n=this._resolveActorIds(null,i);return!n||n.length===0?(I.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{}):(await I.openSheets(n),{})},content:async(t,o)=>`<div>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.content.openSheets")}</div>`})}static _registerToggleMovementAction(e){e.registerTileAction(R,"toggle-movement",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.toggleMovement"),group:R,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"}],fn:async t=>{var r,l,c,u,g,f;const{action:o,tokens:s,tile:a}=t;if(Q._isTeleporting)return d.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=s;if(((l=(r=o.data)==null?void 0:r.entity)==null?void 0:l.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const p=a.entitiesWithin({collection:"tokens"});Array.isArray(p)&&p.length>0&&(i=p)}else if(((u=(c=o.data)==null?void 0:c.entity)==null?void 0:u.id)==="players")i=canvas.tokens.placeables.filter(p=>{var m;return(m=p.actor)==null?void 0:m.hasPlayerOwner});else if((f=(g=o.data)==null?void 0:g.entity)!=null&&f.id&&typeof o.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(o.data.entity.id)){const p=o.data.entity.id,m=await fromUuid(p);m&&(i=[m])}const n=this._resolveActorIds(null,i);return!n||n.length===0?(I.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{}):(await I.toggleMovement(n),{})},content:async(t,o)=>`<div>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.content.toggleMovement")}</div>`})}static _registerTeleportTokensAction(e){e.registerTileAction(R,"teleport-tokens",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.teleportTokens"),group:R,ctrls:[{id:"entity",name:"Actors",type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"},{id:"location",name:"Select Coordinates",type:"select",subtype:"either",options:{show:["either","tile","previous"]},restrict:(t,o)=>t instanceof foundry.canvas.placeables.Tile||t instanceof Scene,required:!0,placeholder:"Select a location"},{id:"snap",name:"Snap to Grid",type:"checkbox",defvalue:!0}],fn:async t=>{var m,k,y,S,T,b,v,L,E,O,w,M,F,U,z;const{action:o,tokens:s,tile:a,value:i}=t;d.log("MATT Teleport - Initial args:",[{actionEntityId:(k=(m=o.data)==null?void 0:m.entity)==null?void 0:k.id,tokensCount:s==null?void 0:s.length,valueTokensCount:(y=i==null?void 0:i.tokens)==null?void 0:y.length}]);let n=[];if(((T=(S=o.data)==null?void 0:S.entity)==null?void 0:T.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const N=a.entitiesWithin({collection:"tokens"}),K=a.document?a:canvas.tiles.get(a.id);n=this._filterTokensWithinTileBounds(N,K)}else if(((v=(b=o.data)==null?void 0:b.entity)==null?void 0:v.id)==="players")n=canvas.tokens.placeables.filter(N=>{var K;return(K=N.actor)==null?void 0:K.hasPlayerOwner});else if((E=(L=o.data)==null?void 0:L.entity)!=null&&E.id&&typeof o.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(o.data.entity.id)){const N=o.data.entity.id,K=await fromUuid(N);K&&(n=[K])}else i!=null&&i.tokens&&Array.isArray(i.tokens)&&i.tokens.length>0?n=i.tokens:s&&Array.isArray(s)&&s.length>0&&(n=s);const r=[];for(const N of n)(N instanceof foundry.canvas.placeables.Token||N instanceof TokenDocument||N!=null&&N.id)&&r.push(N.id);if(!r||r.length===0)return I.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{};const l=(O=o.data)==null?void 0:O.location;if(!l)return await I.teleportTokens(r),{};let c,u=l.sceneId||null,g=null;if((w=i==null?void 0:i.stopdata)!=null&&w.tile)g=i.stopdata.tile,u=((F=(M=g.document)==null?void 0:M.parent)==null?void 0:F.id)||canvas.scene.id;else if(l.id&&typeof l.id=="string"&&!l.x&&!l.y){const N=await fromUuid(l.id);N instanceof foundry.canvas.placeables.Tile&&(g=N,u=((U=N.document.parent)==null?void 0:U.id)||canvas.scene.id)}if(!g&&(l.x!==void 0&&l.y!==void 0?c={x:l.x,y:l.y}:i!=null&&i.location&&(c={x:i.location.x,y:i.location.y},i.location.sceneId&&(u=i.location.sceneId)),!c))return d.warn("No valid location coordinates found, entering interactive mode",l),await I.teleportTokens(r),{};const f=u?game.scenes.get(u):canvas.scene;if(!f)return ui.notifications.error(`Scene not found: ${u}`),{};const p=((z=o.data)==null?void 0:z.snap)!==!1;if(g){const N=g.document,K={x:N.x,y:N.y,width:N.width,height:N.height},Ee=[];for(const _e of r){const we=canvas.tokens.get(_e);if(!we)continue;const gt=we.document.width*f.grid.size,ft=we.document.height*f.grid.size,Lt=K.x+K.width-gt,bo=K.y+K.height-ft,Lo=K.x+Math.random()*(Lt-K.x),vo=K.y+Math.random()*(bo-K.y);let vt={x:Lo,y:vo};p&&(vt=f.grid.getSnappedPoint(vt,{mode:CONST.GRID_SNAPPING_MODES.CENTER})),Ee.push({tokenId:_e,finalLocation:vt})}for(const{tokenId:_e,finalLocation:we}of Ee)await I.teleportTokens([_e],f,we)}else await I.teleportTokens(r,f,c);return{}},content:async(t,o)=>{var l,c,u;const s=(l=o.data)==null?void 0:l.location;let a="coordinates";(s==null?void 0:s.id)==="previous"?a="previous location":(s==null?void 0:s.id)==="origin"?a="trigger origin":s!=null&&s.id&&(a=s.id);let i="";if(s!=null&&s.sceneId&&s.sceneId!==((c=canvas.scene)==null?void 0:c.id)){const g=game.scenes.get(s.sceneId);i=g?` in <span class="value">${g.name}</span>`:" in Unknown Scene"}const r=((u=o.data)==null?void 0:u.snap)??!0?" (snap to grid)":"";return`<div>${game.i18n.format("FLASH_ROLLS.ui.dialogs.matt.content.teleport",{location:`<span class="value">${a}</span>`,scene:i,snap:r})}</div>`}})}static _registerTransformActorsAction(e){e.registerTileAction(R,"transform-actors",{name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.actions.transformActors"),group:R,ctrls:[{id:"entity",name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.transform.actors"),type:"select",subtype:"entity",options:{show:["token","within","players","previous"]},restrict:t=>t instanceof foundry.canvas.placeables.Token,defaultType:"tokens"},{id:"targetActorUuid",name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.transform.targetCreature"),type:"select",subtype:"entity",options:{show:["actor"]},restrict:t=>t instanceof Actor,required:!1,help:"Leave empty to show selection dialog"},{id:"preset",name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.transform.preset"),type:"list",list:()=>({polymorph:game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.presets.polymorph"),wildshape:game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.presets.wildshape"),appearance:game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.presets.appearance"),custom:game.i18n.localize("FLASH_ROLLS.ui.dialogs.transformation.presets.custom")}),defvalue:"polymorph"},{id:"revert",name:game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.transform.revert"),type:"checkbox",defvalue:!1}],fn:async t=>{var r,l,c,u,g,f,p,m,k;const{action:o,tokens:s,tile:a}=t;if(Q._isTeleporting)return d.log("MATT Action - Skipping action because teleportation is in progress"),{};let i=s;if(((l=(r=o.data)==null?void 0:r.entity)==null?void 0:l.id)==="within"&&a&&typeof a.entitiesWithin=="function"){const y=a.entitiesWithin({collection:"tokens"});Array.isArray(y)&&y.length>0&&(i=y)}else if(((u=(c=o.data)==null?void 0:c.entity)==null?void 0:u.id)==="players")i=canvas.tokens.placeables.filter(y=>{var S;return(S=y.actor)==null?void 0:S.hasPlayerOwner});else if((f=(g=o.data)==null?void 0:g.entity)!=null&&f.id&&typeof o.data.entity.id=="string"&&!["tokens","within","players","previous"].includes(o.data.entity.id)){const y=o.data.entity.id,S=await fromUuid(y);S&&(i=[S])}const n=[];for(const y of i){let S=null;if(y instanceof TokenDocument)S=y;else if(y instanceof foundry.canvas.placeables.Token)S=y.document;else if(y instanceof Actor){const T=canvas.tokens.placeables.find(b=>{var v;return((v=b.actor)==null?void 0:v.id)===y.id});T&&(S=T.document)}S&&!n.includes(S)&&n.push(S)}if(!n||n.length===0)return I.notify("warn",game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound")),{};if(n.map(y=>y.actor).filter(y=>y),(p=o.data)!=null&&p.revert){const y=n.filter(S=>{var T;return(T=S.actor)==null?void 0:T.getFlag("dnd5e","isPolymorphed")}).map(S=>S.id);y.length>0&&await I.revertTransformation(y)}else{const y=n.filter(v=>{var L;return!((L=v.actor)!=null&&L.getFlag("dnd5e","isPolymorphed"))}).map(v=>v.id);if(y.length===0)return{};let S=null;if((m=o.data)!=null&&m.targetActorUuid){if(typeof o.data.targetActorUuid=="string")S=o.data.targetActorUuid.trim()||null;else if(o.data.targetActorUuid.id){const v=await fromUuid(o.data.targetActorUuid.id);S=(v==null?void 0:v.uuid)||null}}const T=((k=o.data)==null?void 0:k.preset)||"polymorph";await I.transformActors(y,S,{preset:T,skipRevertCheck:!0})}return{}},content:async(t,o)=>{var r,l,c;if((r=o.data)==null?void 0:r.revert)return`<div>${game.i18n.localize("FLASH_ROLLS.ui.dialogs.matt.content.revertTransformation")}</div>`;let a=null;(l=o.data)!=null&&l.targetActorUuid&&(typeof o.data.targetActorUuid=="string"?a=o.data.targetActorUuid.trim()||null:o.data.targetActorUuid.id&&(a=o.data.targetActorUuid.id));const i=((c=o.data)==null?void 0:c.preset)||"polymorph";let n="selection dialog";if(a)try{const u=await fromUuid(a);n=(u==null?void 0:u.name)||"Unknown Actor"}catch{n="Invalid UUID"}return`<div>${game.i18n.format("FLASH_ROLLS.ui.dialogs.matt.content.transform",{target:`<span class="value">${n}</span>`,preset:i})}</div>`}})}static _filterTokensWithinTileBounds(e,t){if(!Array.isArray(e)||e.length===0||!t||!t.document)return[];const o=t.document,s={x:o.x,y:o.y,x2:o.x+o.width,y2:o.y+o.height};return e.filter(a=>{const i=a instanceof foundry.canvas.placeables.Token?a:canvas.tokens.get(a.id);if(!i)return!1;const n=i.document.x,r=i.document.y,l=i.document.width*canvas.grid.size,c=i.document.height*canvas.grid.size,u=n+l/2,g=r+c/2;return u>=s.x&&u<=s.x2&&g>=s.y&&g<=s.y2})}static _resolveActorIds(e,t){var s,a,i,n,r;const o=[];if(!t||t.length===0)return o;for(let l=0;l<t.length;l++){const c=t[l];let u=null;c instanceof TokenDocument||(c==null?void 0:c.documentName)==="Token"?u=(s=c.actor)==null?void 0:s.id:c instanceof foundry.canvas.placeables.Token?u=((i=(a=c.document)==null?void 0:a.actor)==null?void 0:i.id)||((n=c.actor)==null?void 0:n.id):c instanceof Actor?u=c.id:c!=null&&c.actorId?u=c.actorId:(r=c==null?void 0:c.actor)!=null&&r.id&&(u=c.actor.id),u&&!o.includes(u)&&o.push(u)}return o}static _getSkillName(e){var t,o,s;return e&&((s=(o=(t=CONFIG.DND5E)==null?void 0:t.skills)==null?void 0:o[e])==null?void 0:s.label)||null}static _getAbilityName(e){var t,o,s;return e&&((s=(o=(t=CONFIG.DND5E)==null?void 0:t.abilities)==null?void 0:o[e])==null?void 0:s.label)||null}static async _getToolName(e,t){var a,i,n;if(!e)return e;const o=((a=game.actors)==null?void 0:a.contents)||[];for(const r of o){const l=(n=(i=r.system)==null?void 0:i.tools)==null?void 0:n[e];if(l!=null&&l.label)return l.label}if(t!=null&&t.id)try{const r=await fromUuid(t.id);if(r!=null&&r.name)return r.name}catch(r){d.log(`MonksActiveTilesIntegration: Failed to fetch tool name for ${e}`,r)}return e.charAt(0).toUpperCase()+e.slice(1)}static _getAdvantageLabel(e){switch(e){case"advantage":return"with Advantage";case"disadvantage":return"with Disadvantage";default:return""}}static _generateGroupRollId(e,t){if(!(e!=null&&e.id))return foundry.utils.randomID();const o=Math.floor(Date.now()/100);return`matt-${e.id}-${t._id||"action"}-${o}`}};D(bt,"_pendingGroupRolls",new Map);let Dt=bt;const ue=class ue{static getActivityConfigFromCache(e){const t=ue.activityConfigCache.get(e);return t?Date.now()-t.timestamp>ue.CACHE_EXPIRY_MS?(ue.activityConfigCache.delete(e),d.log("getActivityConfigFromCache - deleted expired entry",[e]),null):t.config:null}static initialize(){Hooks.once(H.INIT,this._onInit.bind(this)),Hooks.once(H.READY,this._onReady.bind(this)),Hooks.on(H.CANVAS_READY,this._onCanvasReady.bind(this)),Hooks.on(Mo.READY,()=>{d.log("flash-rolls-5e.ready hook",[])}),Hooks.on(H.GET_CHAT_MESSAGE_CONTEXT_OPTIONS,(e,t)=>{d.log("getChatMessageContextOptions hook",[e,t]),game.user.isGM&&this._addGroupRollContextOptions(e,t)}),Hooks.on(H.CLIENT_SETTING_CHANGED,this._onClientSettingChanged.bind(this)),this._registerTidy5eHooks(),Hooks.once(H.GET_ACTOR_CONTEXT_OPTIONS,(e,t)=>{d.log("getActorContextOptions hook",[e,t]),game.user.isGM&&(t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.unblockFromMenu"),icon:'<i class="fas fa-bolt"></i>',callback:o=>{const s=o.dataset.entryId;return s&&ae.toggleBlocked(s,!1),s},condition:o=>{var i;const s=(i=o==null?void 0:o.dataset)==null?void 0:i.entryId;return ae.isBlocked(s)}}),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.blockFromMenu"),icon:'<i class="fas fa-bolt-slash"></i>',callback:o=>{const s=o.dataset.entryId;return s&&ae.toggleBlocked(s,!0),s},condition:o=>{var i;const s=(i=o==null?void 0:o.dataset)==null?void 0:i.entryId;return!ae.isBlocked(s)}}))})}static _addGroupRollContextOptions(e,t){d.log("_addGroupRollContextOptions",[e,t]),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.hideNPCsFromPlayers"),icon:'<i class="fas fa-eye-slash"></i>',callback:o=>{const s=o.dataset.messageId,a=game.messages.get(s);a&&(a.setFlag(R,"npcHiddenOverride",!0),I.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.npcHiddenFromPlayers")))},condition:o=>{const s=o.dataset.messageId;if(!s)return!1;const a=game.messages.get(s);if(!a||!a.getFlag(R,"isGroupRoll"))return!1;const i=C(),n=_.get(i.groupRollNPCHidden.tag),r=a.getFlag(R,"npcHiddenOverride");return!(r!==void 0?r:n)}}),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.showNPCsToPlayers"),icon:'<i class="fas fa-eye"></i>',callback:o=>{const s=o.dataset.messageId,a=game.messages.get(s);if(a){const i=C();_.get(i.groupRollNPCHidden.tag)?a.setFlag(R,"npcHiddenOverride",!1):a.unsetFlag(R,"npcHiddenOverride"),I.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.npcVisibleToPlayers"))}},condition:o=>{const s=o.dataset.messageId;if(!s)return!1;const a=game.messages.get(s);if(!a||!a.getFlag(R,"isGroupRoll"))return!1;const i=C(),n=_.get(i.groupRollNPCHidden.tag),r=a.getFlag(R,"npcHiddenOverride");return r!==void 0?r:n}}),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.showAllResultsToPlayers"),icon:'<i class="fas fa-eye"></i>',callback:o=>{const s=o.dataset.messageId,a=game.messages.get(s);a&&a.setFlag(R,"showAllResultsToPlayers",!0)},condition:o=>{const s=o.dataset.messageId;if(!s)return!1;const a=game.messages.get(s);return!a||!a.getFlag(R,"isGroupRoll")?!1:!a.getFlag(R,"showAllResultsToPlayers")}})}static _onInit(){C(),document.body.classList.add("flash5e"),_.registerSettings(),Ce.initialize(),this._registerHook(H.RENDER_CHAT_MESSAGE,te.onRenderChatMessage.bind(te)),this._registerHook(H.RENDER_ROLL_RESOLVER,this._onRenderRollResolver.bind(this)),Dt.initialize()}static _onReady(){var e;d.log("CONFIG.DND5E",[CONFIG.DND5E]),_.registerSettingsMenu(),is.initialize(),At.addSidebarControls(ui.sidebar,(e=ui.sidebar)==null?void 0:e.element),Ot.init(),game.user.isGM&&Qe.showMissingLibWrapperNotification(),matchMedia&&matchMedia("(prefers-color-scheme: dark)").addEventListener("change",this._onBrowserColorSchemeChanged.bind(this)),q.isModuleOn("midi-qol")?Hooks.once(Do.READY,this._initModule.bind(this)):this._initModule(),d.log("HooksManager.ready",[canvas])}static async _initModule(){const e=C();_.get(e.debugMode.tag)&&(CONFIG.debug.hooks=!0),await te.initialize(),this._registerHooks(),ns.initialize(),wt.initialize(),game.user.isGM?(Nt.initialize(),x.showOnLoadIfEnabled(),fe.initialize(),game.users.forEach(s=>{this._onUserConnected(s)})):Ce.getDiceConfig(),Ut(Bt()),Te.initializeCombatMovementRestrictions();const o=game.modules.get("flash-rolls-5e");o&&(o.api=I),globalThis.FlashAPI=I,globalThis.FlashRolls5e=I,Hooks.call("flash-rolls-5e.ready")}static _registerHooks(){this._registerCommonHooks(),game.user.isGM?this._registerGMOnlyHooks():this._registerPlayerOnlyHooks()}static _registerCommonHooks(){this._registerHook(H.RENDER_SIDEBAR,this._onRenderSidebar.bind(this)),this._registerHook(H.CHANGE_SIDEBAR_TAB,this._onSidebarUpdate.bind(this)),this._registerHook(H.COLLAPSE_SIDE_BAR,this._onSidebarUpdate.bind(this)),this._registerHook(H.REFRESH_MEASURED_TEMPLATE,this.onRefreshTemplate.bind(this)),this._registerHook(H.CANVAS_READY,this._onCanvasReady.bind(this)),this._registerHook(H.CREATE_CHAT_MESSAGE,te.onCreateChatMessage.bind(te)),this._registerHook(H.PRE_CREATE_CHAT_MESSAGE,te.onPreCreateChatMessage.bind(te)),this._registerHook(H.RENDER_CHAT_LOG,te.onRenderChatLog.bind(te)),this._registerHook(H.PRE_UPDATE_TOKEN,this._onPreUpdateToken.bind(this)),this._registerHook(ee.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this)),this._registerHook(ee.RENDER_SKILL_TOOL_ROLL_DIALOG,this._onRenderSkillToolDialog.bind(this)),this._registerHook(ee.PRE_ROLL_HIT_DIE_V2,le.onPreRollHitDieV2.bind(le)),this._registerHook(ee.POST_ROLL_CONFIG,le.onPostRollConfig.bind(le)),this._registerHook(ee.ROLL_DAMAGE_V2,le.onRollDamageV2.bind(le))}static _registerGMOnlyHooks(){this._registerHook(H.USER_CONNECTED,this._onUserConnected.bind(this)),this._registerHook(ee.PRE_ROLL_V2,le.onPreRollGM.bind(le)),this._registerHook(ee.PRE_USE_ACTIVITY,Ae.onPreUseActivityGM.bind(Ae)),this._registerHook(ee.POST_USE_ACTIVITY,Ae.onPostUseActivityGM.bind(Ae)),this._registerHook(H.CREATE_COMBATANT,this._onCombatChange.bind(this)),this._registerHook(H.DELETE_COMBATANT,this._onCombatChange.bind(this)),this._registerHook(H.UPDATE_COMBAT,this._onCombatChange.bind(this)),this._registerHook(H.DELETE_COMBAT,this._onCombatChange.bind(this)),this._registerHook(H.COMBAT_START,this._onCombatStart.bind(this)),this._registerHook(H.COMBAT_TURN_CHANGE,this._onCombatTurnChange.bind(this)),this._registerHook(H.DELETE_COMBAT,this._onDeleteCombat.bind(this)),this._registerHook(H.CREATE_COMBATANT,this._onCreateCombatant.bind(this)),this._registerHook(H.CREATE_ACTIVE_EFFECT,this._onActiveEffectChange.bind(this)),this._registerHook(H.DELETE_ACTIVE_EFFECT,this._onActiveEffectChange.bind(this)),this._registerHook(H.UPDATE_ACTIVE_EFFECT,this._onActiveEffectChange.bind(this)),this._registerHook(H.UPDATE_SETTING,this._onSettingUpdate.bind(this)),this._registerHook(H.UPDATE_SCENE,this._onSceneUpdate.bind(this)),this._registerHook(H.UPDATE_ACTOR,this._onActorUpdate.bind(this)),this._registerHook(H.UPDATE_TOKEN,this._onTokenUpdate.bind(this)),this._registerHook(H.CREATE_TOKEN,this._onCreateToken.bind(this)),this._registerHook(H.DELETE_TOKEN,this._onDeleteToken.bind(this)),this._registerHook(H.CREATE_ACTOR,this._onCreateActor.bind(this)),this._registerHook(H.DELETE_ACTOR,this._onDeleteActor.bind(this)),this._registerHook(H.RENDER_CHAT_INPUT,this._onRenderChatInput.bind(this))}static _registerPlayerOnlyHooks(){this._registerHook(ee.PRE_ROLL_INITIATIVE_DIALOG,le.onPreRollInitiativeDialog.bind(le)),this._registerHook(ee.PRE_ROLL_ATTACK_V2,le.onPreRollAttackV2.bind(le)),this._registerHook(ee.PRE_ROLL_DAMAGE_V2,le.onPreRollDamageV2.bind(le)),Hooks.on(ee.PRE_ROLL_ABILITY_CHECK,le.onPreRollAbilityCheck.bind(le)),this._registerHook(ee.PRE_USE_ACTIVITY,Ae.onPreUseActivityPlayer.bind(Ae)),this._registerHook(ee.POST_USE_ACTIVITY,Ae.onPostUseActivityPlayer.bind(Ae))}static _onSidebarUpdate(e){d.log("_onSidebarUpdate",[e]),Ut(Bt())}static _onRenderChatInput(){d.log("_onRenderChatInput - syncing offset and faded-ui classes");const e=document.querySelector("#flash-rolls-menu");e&&e.classList.contains("docked-bottom")&&setTimeout(async()=>{const t={element:e};Le.syncOffsetClass(t),Le.syncFadedUIClass(t)},50)}static _onRenderRollConfigDialog(e,t,o){var a,i,n,r,l;if(d.log("_onRenderRollConfigDialog #0",[e,o]),e._flashRollsApplied)return;if(((i=(a=e.config)==null?void 0:a.hookNames)==null?void 0:i.includes("initiativeDialog"))||((r=(n=e.element)==null?void 0:n.id)==null?void 0:r.includes("initiative"))){const c=(l=e.config)==null?void 0:l.subject;if(!c)return;if(e._flashRollsTitleApplied||(t.querySelector(".window-title").textContent=game.i18n.localize("DND5E.Initiative"),t.querySelector(".window-subtitle").textContent=c.name,e._flashRollsTitleApplied=!0),c.getFlag(R,"tempInitiativeConfig")){e._flashRollsApplied=!0;const g=t.querySelector('input[name*="situational"]');setTimeout(()=>{g.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},50)}return}else t.querySelectorAll('input[name*="situational"]').forEach((u,g)=>{var f,p,m,k,y,S,T;d.log("_onRenderRollConfigDialog - processing input",[g,u.name,u.value]),!u.value&&((k=(m=(p=(f=e.config)==null?void 0:f.rolls)==null?void 0:p[0])==null?void 0:m.data)!=null&&k.situational)&&(u.value=e.config.rolls[0].data.situational),e.config.scaling=!0,u.value&&(e._flashRollsApplied=!0,(T=(S=(y=e.config)==null?void 0:y.rolls)==null?void 0:S[0])!=null&&T.data&&delete e.config.rolls[0].data.situational,setTimeout(()=>{u.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},150))})}static _onRenderRollResolver(e,t){var o,s,a,i,n,r,l;try{const c=e.roll;if(!c)return;d.log("_onRenderRollResolver - roll options:",[c.options]);const u=(o=c.options)==null?void 0:o.messageData;if(!((s=u==null?void 0:u.flags)!=null&&s[R])){d.log("_onRenderRollResolver - no metadata found in messageData");return}const{rollType:g,rollKey:f}=u.flags[R];if(!g){d.log("_onRenderRollResolver - no rollType found");return}d.log("_onRenderRollResolver - found metadata",[g,f]);const p=t[0].querySelector(".window-title");if(!p){d.log("_onRenderRollResolver - no title element found");return}let m;switch(g.toLowerCase()){case"ability":case"abilitycheck":m=`${game.i18n.localize(((a=CONFIG.DND5E.abilities[f])==null?void 0:a.label)||f)} ${game.i18n.localize("DND5E.AbilityCheck")}`;break;case"save":case"savingthrow":m=`${game.i18n.localize(((i=CONFIG.DND5E.abilities[f])==null?void 0:i.label)||f)} ${game.i18n.localize("DND5E.SavingThrow")}`;break;case"skill":m=game.i18n.localize(((n=CONFIG.DND5E.skills[f])==null?void 0:n.label)||f);break;case"tool":m=game.i18n.localize(((l=(r=CONFIG.DND5E.tools)==null?void 0:r[f])==null?void 0:l.label)||f);break;case"initiative":case"initiativedialog":m=game.i18n.localize("DND5E.Initiative");break;case"deathsave":m=game.i18n.localize("DND5E.DeathSave");break;case"hitdie":m=`${game.i18n.localize("DND5E.HitDie")} (${f})`;break;default:return}p.textContent=m}catch(c){d.error("Error customizing Roll Resolver title:",[c])}}static _onPreCreateChatMessageGM(e,t,o,s){d.log("_onPreCreateChatMessageGM",[e,t,o,s])}static _addSelectTargetsButton(e,t){var s,a,i;if(!game.user.isGM||(d.log("_addSelectTargetsButton #0",[e,t,t.querySelector(".message-content")]),((i=(a=(s=e.flags)==null?void 0:s.dnd5e)==null?void 0:a.roll)==null?void 0:i.type)!=="damage"||t.querySelector(".select-targeted")))return;const o=document.createElement("button");o.className="select-targeted",o.type="button",o.setAttribute("data-tooltip-direction","LEFT"),o.setAttribute("data-tooltip","Select Targeted"),o.innerHTML='<i class="fas fa-crosshairs"></i>',o.addEventListener("click",n=>{n.preventDefault(),this._selectTargetedTokens(n)}),t.querySelector(".message-content").appendChild(o),e.update({content:t})}static _selectTargetedTokens(e){const o=e.currentTarget.closest(".chat-message").querySelectorAll("[data-target-uuid]");if(o.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noTargetedTokens"));return}for(let s=0;s<o.length;s++){const i=o[s].dataset.targetUuid.split("Actor.")[1];canvas.tokens.placeables.filter(r=>{var l,c;return((l=r.document.actor)==null?void 0:l.id)===i||((c=r.document.baseActor)==null?void 0:c.id)===i}).forEach((r,l)=>{r&&r.control&&r.control({releaseOthers:s===0})})}}static _onUserConnected(e){e.active&&e.id!==game.user.id&&setTimeout(()=>{e.active&&Ce.requestDiceConfigFromUser(e.id)},500)}static _registerTidy5eHooks(){Hooks.once(qe.READY,()=>{d.log("Tidy5e Sheets ready - registering hooks"),Hooks.on(qe.PRE_PROMPT_GROUP_SKILL_ROLL,this._onTidy5eGroupSkillRoll.bind(this)),Hooks.on(qe.RENDER_ACTOR_SHEET,fe.onRenderActorSheet.bind(fe)),Hooks.on(qe.RENDER_GROUP_SHEET_QUADRONE,fe.onRenderActorSheet.bind(fe)),Hooks.on(qe.RENDER_GROUP_SHEET_CLASSIC,fe.onRenderActorSheet.bind(fe)),Hooks.on(qe.RENDER_ENCOUNTER_SHEET_QUADRONE,fe.onRenderActorSheet.bind(fe)),Hooks.on(qe.RENDER_ENCOUNTER_SHEET_CLASSIC,fe.onRenderActorSheet.bind(fe))})}static _onTidy5eGroupSkillRoll(e,t){var g,f;if(d.log("HooksManager._onTidy5eGroupSkillRoll",[e,t]),!game.user.isGM)return!0;const o=C();if(!_.get(o.interceptTidySheetsGroupRolls.tag))return d.log("Tidy5e group roll interception disabled",[]),!0;const{skill:a,ability:i,event:n}=t;if(!((f=(g=e==null?void 0:e.actor)==null?void 0:g.system)!=null&&f.members))return d.warn("Tidy5e group roll: No members found",[e]),!0;const r=e.actor.system.members,l=r.map(p=>p.actor.id).filter(p=>p);if(l.length===0)return d.warn("Tidy5e group roll: No valid actor IDs",[r]),!0;const c=_.get(o.skipRollDialog.tag),u=foundry.utils.randomID();return I.requestRoll({requestType:"skill",rollKey:a,actorIds:l,ability:i,skipRollDialog:c,groupRollId:u,sendAsRequest:!0}),!1}static _onCreateToken(e,t,o){x.refreshIfOpen()}static _onPreUpdateToken(e,t,o,s){var n;d.log("HooksManager._onPreUpdateToken called",{tokenDoc:e,updateData:t,options:o,userId:s,userIsGM:(n=game.users.get(s))==null?void 0:n.isGM});const a=game.users.get(s);if(!a)return;const i=Te.isMovementAllowed(e,a,t);if(d.log("Movement check result:",{isMovementAllowed:i,user:a.name,token:e.name}),!i)return I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.movementRestricted")),d.log("Movement blocked for token:",e.name),!1}static _onDeleteToken(e,t,o){fe.onDeleteToken(e,t,o),x.refreshIfOpen()}static _onCreateActor(e,t,o){x.refreshIfOpen()}static _onDeleteActor(e,t,o){x.refreshIfOpen()}static _onSettingUpdate(e,t,o,s){const a=C(),i={ID:"flash-rolls-5e"};e.key===`${i.ID}.${a.showOnlyPCsWithToken.tag}`||e.key===`${i.ID}.${a.compactMode.tag}`||e.key===`${i.ID}.${a.menuLayout.tag}`?(d.log("HooksManager._onSettingUpdate - Re-rendering roll requests menu due to setting change",[e.key]),x.refreshIfOpen()):e.key==="core.uiConfig"&&(_.updateColorScheme(),x.refreshIfOpen())}static _onSceneUpdate(e,t,o,s){t.active===!0&&(d.log("HooksManager._onSceneUpdate - Re-rendering roll requests menu due to active scene change"),x.refreshIfOpen())}static _onCanvasReady(e){d.log("HooksManager._onCanvasReady - Re-rendering roll requests menu due to scene view change"),x.refreshIfOpen();const t=Q.isTeleporting();d.log("HooksManager._onCanvasReady - Checking for teleport",{isTeleporting:t}),t&&(d.log("HooksManager._onCanvasReady - Calling TokenTeleportManager._onSceneChange"),Q._onSceneChange())}static _onActorUpdate(e,t,o,s){var r,l,c,u,g,f,p,m,k,y,S,T;d.log("HooksManager._onActorUpdate",[e,t]),d.log("HooksManager._onActorUpdate - changes.effects:",[t.effects]);const a=t["==ownership"]!==void 0,i=((l=(r=t.system)==null?void 0:r.attributes)==null?void 0:l.hp)||((u=(c=t.system)==null?void 0:c.attributes)==null?void 0:u.ac)||((p=(f=(g=t.system)==null?void 0:g.attributes)==null?void 0:f.spell)==null?void 0:p.dc)||((k=(m=t.system)==null?void 0:m.skills)==null?void 0:k.prc)||((y=t.system)==null?void 0:y.abilities)||((T=(S=t.system)==null?void 0:S.attributes)==null?void 0:T.prof),n=t.effects!==void 0;d.log("HooksManager._onActorUpdate - triggers:",["statsChanged:",i,"ownershipChanged:",a,"effectsChanged:",n]),!(!i&&!a&&!n)&&x.refreshIfOpen()}static _onTokenUpdate(e,t,o,s){d.log("HooksManager._onTokenUpdate",[e,t]),t.hidden!==void 0&&x.refreshIfOpen()}static _onCombatChange(...e){d.log("HooksManager._onCombatChange",e),d.log("HooksManager._onCombatChange - Re-rendering roll requests menu due to combat status change"),x.refreshIfOpen()}static _onActiveEffectChange(e,t,o,s){if(d.log("HooksManager._onActiveEffectChange",[e,t,o,s]),!e.parent||e.parent.documentName!=="Actor"){d.log("HooksManager._onActiveEffectChange - Effect not on actor, skipping");return}d.log("HooksManager._onActiveEffectChange - Re-rendering roll requests menu due to status effect change"),d.log("HooksManager._onActiveEffectChange - Effect statuses:",e.statuses),x.refreshIfOpen()}static _onRenderApplicationV2(e,t,o){d.log("_onRenderApplicationV2",[e,t,o])}static _onRenderSidebar(e,t,o){d.log("_onRenderSidebar",[e,t]),game.ready&&At.addSidebarControls(e,t)}static _registerHook(e,t){const o=Hooks.on(e,t);return this.registeredHooks.set(`${e}_${o}`,o),o}static unregisterAll(){this.registeredHooks.forEach((e,t)=>{const o=t.split("_")[0];Hooks.off(o,e)}),this.registeredHooks.clear()}static isRegistered(e){for(const t of this.registeredHooks.keys())if(t.startsWith(`${e}_`))return!0;return!1}static _onRenderSkillToolDialog(e,t,o){var a,i;if(d.log("_onRenderSkillToolDialog triggered",[e]),e._abilityFlavorFixed)return;const s=t.querySelector('select[name="ability"]');if(s&&(a=e.config)!=null&&a.isRollRequest&&(i=e.config)!=null&&i.ability){const n=s.value,r=e.config.ability;n===r&&(e._abilityFlavorFixed=!0,setTimeout(()=>{const l=new Event("change",{bubbles:!0,cancelable:!0});s.dispatchEvent(l)},50))}}static onRefreshTemplate(e,t){if(!e.isOwner)return;const o=`refresh-template-${e.id}`,s=C(),a=_.get(s.templateAutoTarget.tag);ue.throttleTimers[o]&&clearTimeout(ue.throttleTimers[o]),ue.throttleTimers[o]=setTimeout(()=>{let i=3;switch(a){case 1:i=3;break;case 2:i=0;break;default:return}game.user.targets.forEach(r=>r.setTarget(!1,{releaseOthers:!1}));const n=[];for(let r of canvas.tokens.placeables)r.document.disposition<=i&&e.shape.contains(r.center.x-e.x,r.center.y-e.y)&&n.push(r);n.forEach((r,l)=>{r.setTarget(!0,{releaseOthers:l===0,groupSelection:!0})}),n.length>0&&game.user.broadcastActivity({targets:game.user.targets.ids}),delete ue.throttleTimers[o]},50)}static _onClientSettingChanged(e,t,o){d.log("HooksManager._onClientSettingChanged",[e,t,o]),e==="core.uiConfig"&&this._updateMenuColorScheme()}static _onBrowserColorSchemeChanged(){var t;d.log("HooksManager._onBrowserColorSchemeChanged - Browser color scheme changed");const e=game.settings.get("core","uiConfig");(t=e==null?void 0:e.colorScheme)!=null&&t.interface||this._updateMenuColorScheme()}static _updateMenuColorScheme(){const e=_.coreColorScheme;_.updateColorScheme();const t=_.coreColorScheme,o=x.getInstance();o!=null&&o.rendered&&o.classList&&(e&&o.classList.remove(`theme-${e}`),t&&o.classList.add(`theme-${t}`))}static _onCombatStart(e,t){Te.onCombatStart(e,t)}static _onCombatTurnChange(e,t,o){Te.onCombatTurnChange(e,t,o)}static _onDeleteCombat(e){Te.onCombatEnd(e)}static _onCreateCombatant(e,t,o){Te.onCreateCombatant(e,t,o)}};D(ue,"registeredHooks",new Map),D(ue,"midiTimeout",null),D(ue,"throttleTimers",{}),D(ue,"activityConfigCache",new Map),D(ue,"CACHE_EXPIRY_MS",3e4),D(ue,"templateRemovalTimers",new Set);let Re=ue;class ze{static init(){ge.initialize(ze.registerSocketCalls),Re.initialize()}static getDiceConfig(){return Ce.getDiceConfig()}static receiveDiceConfig(e,t){Ce.receiveDiceConfig(e,t)}static async handleRollRequest(e){return d.log("Main.handleRollRequest",e),Ve.handleRequest(e)}static registerSocketCalls(){ge.registerCall(Be.getDiceConfig,ze.getDiceConfig),ge.registerCall(Be.receiveDiceConfig,ze.receiveDiceConfig),ge.registerCall(Be.handleRollRequest,ze.handleRollRequest),ge.registerCall(Be.removeTemplate,q.removeTemplate),ge.registerCall(Be.broadcastRollComplete,ze.handleBroadcastRollComplete)}static handleBroadcastRollComplete(e){d.log("Main.handleBroadcastRollComplete",[e]),e.roll&&!(e.roll instanceof Roll)&&(e.roll=Roll.fromJSON(JSON.stringify(e.roll))),Hooks.callAll("flash-rolls-5e.rollComplete",e)}}ze.init();const{ApplicationV2:rs,HandlebarsApplicationMixin:ls}=foundry.applications.api,Je=class Je extends ls(rs){constructor(e={}){super(e),this.actors=e.actors||[],this.rollSelections=new Map,this.rollMode="publicroll",this.flavor="",this.hideNpcNames=!1}async _prepareContext(e={}){const t=await super._prepareContext(e),o={};for(const[a,i]of Object.entries(CONFIG.DND5E.abilities))o[a]={label:game.i18n.localize(i.label),abbreviation:game.i18n.localize(i.abbreviation)};const s={};for(const[a,i]of Object.entries(CONFIG.DND5E.skills))s[a]={label:game.i18n.localize(i.label)};return{...t,actors:this.actors.map(a=>{const i=a.actor||a;return{id:i.id,name:i.name,img:i.img}}),abilities:o,skills:s,rollMode:this.rollMode,flavor:this.flavor,hideNpcNames:this.hideNpcNames}}_attachPartListeners(e,t,o){super._attachPartListeners(e,t,o);const s=t.querySelector(".roll-mode-select");s&&s.addEventListener("change",r=>{this.rollMode=r.target.value});const a=t.querySelector('input[name="flavor"]');a&&a.addEventListener("input",r=>{this.flavor=r.target.value});const i=t.querySelector('input[name="hideNpcNames"]');i&&i.addEventListener("change",r=>{this.hideNpcNames=r.target.checked}),t.querySelectorAll(".actor-roll-type").forEach(r=>{const l=r.dataset.actorId;r.value&&this.rollSelections.set(l,r.value),r.addEventListener("change",c=>{const u=c.target.dataset.actorId;this.rollSelections.set(u,c.target.value)})})}async _onRequest(e,t){if(this.actors.length===0){I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}for(const s of this.actors){const a=s.actor||s;if(!this.rollSelections.get(a.id)){I.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.noRollSelected",{name:a.name}));return}}const o={actors:this.actors.map(s=>{const a=s.actor||s;return{actor:a,uniqueId:s.uniqueId||a.id,tokenId:s.tokenId||null,rollType:this.rollSelections.get(a.id)}}),rollMode:this.rollMode,flavor:this.flavor,hideNpcNames:this.hideNpcNames};await this._executeContestedRolls(o),this.close()}async _executeContestedRolls(e){d.log("_executeContestedRolls",[e]);const t=C(),s=_.get(t.groupRollsMsgEnabled.tag)?foundry.utils.randomID():null;d.log("ContestedRoll - groupRollId",[s]);const a={...e,isContestedRoll:!0};if(s){const i=e.actors.map(c=>{const u=c.actor,g=c.uniqueId||u.id,f=c.tokenId||null,[p,m]=c.rollType.split(":");return{actor:u,uniqueId:g,tokenId:f,rollType:p,rollKey:m}}),n=e.actors[0].rollType.split(":"),r=n[0],l=n[1];await te.createGroupRollMessage(i,r,l,a,s)}for(const i of e.actors)await this._executeRollForActor(i,a,s)}async _executeRollForActor(e,t,o=null){var u,g,f;const s=e.actor,a=e.tokenId,[i,n]=e.rollType.split(":");d.log("_executeRollForActor",[s.name,i,n,"tokenId:",a,"groupRollId:",o]);const r=C(),l=_.get(r.skipRollDialog.tag),c=_.get(r.rollRequestsEnabled.tag);try{if(i==="dice"){const p=await new Roll(n,s.getRollData()).evaluate(),m={actor:s};if(a){const T=((u=canvas.tokens)==null?void 0:u.get(a))||((f=(g=game.scenes.active)==null?void 0:g.tokens)==null?void 0:f.get(a));T&&(m.token=T)}const k=ChatMessage.implementation.getSpeaker(m),y=t.flavor||game.i18n.localize("FLASH_ROLLS.ui.dialogs.contestedRoll.customRoll"),S={speaker:k,flavor:y};t.rollMode&&(S.rollMode=t.rollMode),o&&(S.flags={"flash-rolls-5e":{groupRollId:o,isContestedRoll:!0}}),await p.toMessage(S)}else{const p=i==="ability"?"abilitycheck":i,m=P.isPlayerOwned(s),k=a||s.id;await I.requestRoll({requestType:p,rollKey:n,actorIds:[k],sendAsRequest:m&&c,skipRollDialog:l,groupRollId:o,isContestedRoll:t.isContestedRoll||!1})}}catch(p){d.error("Error executing roll",[p]),ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.rollFailed",{name:s.name}),[p])}}async _onShowCode(e,t){d.log("ContestedRollDialog _onShowCode",[]);for(const s of this.actors){const a=s.actor||s;if(!this.rollSelections.get(a.id)){I.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.noRollSelected",{name:a.name}));return}}const o=this._generateMacroCode();d.log("Generated macro code:",[o]);try{await this._createContestedRollMacro(o),this.close()}catch(s){d.error("Failed to create macro:",[s]),ui.notifications.error(`Failed to create macro: ${s.message}`)}}_generateMacroCode(){const e=this.actors[0].actor||this.actors[0],t=this.rollSelections.get(e.id);if(!t)return I.notify("warn","Please select a roll type for all actors before creating a macro."),null;const o=t.split(":"),s=o[0]==="ability"?"abilitycheck":o[0],a=o[1],i=this.actors.map(l=>{const c=l.actor||l,u=this.rollSelections.get(c.id);if(!u)return null;const[g,f]=u.split(":"),p=g==="ability"?"abilitycheck":g;return g==="dice"?`  // ${c.name}: Custom Dice Roll
  const actor${c.id} = game.actors.get("${c.id}");
  if (actor${c.id}) {
    const roll = await new Roll("${f}", actor${c.id}.getRollData()).evaluate();
    await roll.toMessage({
      speaker: ChatMessage.implementation.getSpeaker({ actor: actor${c.id} }),
      flavor: "${this.flavor||"Custom Roll"}",
      rollMode: "${this.rollMode}",
      flags: {
        "flash-rolls-5e": {
          groupRollId: groupRollId,
          isContestedRoll: true
        }
      }
    });
  }`:`  // ${c.name}: ${g}:${f}
  await FlashAPI.requestRoll({
    requestType: "${p}",
    rollKey: "${f}",
    actorIds: ["${c.id}"],
    skipRollDialog: true,
    groupRollId: groupRollId,
    isContestedRoll: true
  });`});if(i.includes(null))return null;const n=i.join(`

`),r=this.actors.map(l=>{const c=l.actor||l;return`    {
      actor: game.actors.get("${c.id}"),
      uniqueId: "${c.id}",
      tokenId: null
    }`}).join(`,
`);return`// Flash Token Bar: Contested Roll
// Roll Mode: ${this.rollMode}
${this.flavor?`// Flavor: ${this.flavor}`:""}

(async () => {
  try {
    const groupRollId = foundry.utils.randomID();

    const actorEntries = [
${r}
    ];

    await FlashAPI.createGroupRollMessage(
      actorEntries,
      "${s}",
      "${a}",
      { rollMode: "${this.rollMode}", flavor: "${this.flavor}", isContestedRoll: true },
      groupRollId
    );

${n}
  } catch (error) {
    ui.notifications.error("Failed to execute contested roll: " + error.message);
  }
})();`}async _createContestedRollMacro(e){const t=C(),o=_.get(t.addMacrosToFolder.tag);let s=null;o&&(s=await this._ensureFlashRollsFolder());const n={name:`Contested Roll: ${this.actors.map(l=>(l.actor||l).name).join(" vs ")}`,type:"script",command:e,img:"modules/flash-rolls-5e/assets/bolt-circle.svg",...s&&{folder:s},flags:{"flash-rolls-5e":{type:"contested-roll",actors:this.actors.map(l=>(l.actor||l).id),rollSelections:Array.from(this.rollSelections.entries()),rollMode:this.rollMode,flavor:this.flavor}}},r=await Macro.create(n);return I.notify("info",game.i18n.format("FLASH_ROLLS.notifications.macroCreated",{macroName:r.name})),r.sheet.render(!0),r}async _ensureFlashRollsFolder(){const e="Flash Token Bar";let t=game.folders.find(o=>o.type==="Macro"&&o.name===e);if(!t)try{t=await Folder.create({name:e,type:"Macro",color:"#302437",sort:0}),d.log("Created Flash Token Bar macro folder",[t])}catch(o){return d.error("Failed to create Flash Token Bar macro folder:",[o]),I.notify("warn","Failed to create Flash Token Bar macro folder. Macro will be created without folder organization."),null}return(t==null?void 0:t.id)||null}async _onDeleteActor(e,t){const o=t.dataset.actorId;d.log("ContestedRollDialog _onDeleteActor",[o]),this.actors=this.actors.filter(s=>s.id!==o),this.rollSelections.delete(o),await this.render(!0)}static async show(e){if(!e||e.length===0)return I.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected")),null;const t=new this({actors:e});return t.render(!0),t}};D(Je,"DEFAULT_OPTIONS",{id:"flash5e-contested-roll-dialog",classes:["flash5e-dialog","flash5e-contested-roll-dialog"],tag:"div",window:{title:"FLASH_ROLLS.ui.dialogs.contestedRoll.title",icon:"fas fa-swords",resizable:!1,positioned:!0,frame:!0},position:{width:540,height:"auto"},actions:{request:Je.prototype._onRequest,"show-code":Je.prototype._onShowCode}}),D(Je,"PARTS",{main:{template:`modules/${R}/templates/contested-roll-dialog.hbs`}});let Mt=Je;const cs=Object.freeze(Object.defineProperty({__proto__:null,ContestedRollDialog:Mt},Symbol.toStringTag,{value:"Module"}));
//# sourceMappingURL=flash-rolls-5e.js.map
