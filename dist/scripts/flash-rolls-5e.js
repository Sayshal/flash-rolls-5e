var Lt=Object.defineProperty;var Ze=u=>{throw TypeError(u)};var bt=(u,e,t)=>e in u?Lt(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var D=(u,e,t)=>bt(u,typeof e!="symbol"?e+"":e,t),Pe=(u,e,t)=>e.has(u)||Ze("Cannot "+t);var F=(u,e,t)=>(Pe(u,e,"read from private field"),t?t.call(u):e.get(u)),re=(u,e,t)=>e.has(u)?Ze("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(u):e.set(u,t),ce=(u,e,t,s)=>(Pe(u,e,"write to private field"),s?s.call(u,t):e.set(u,t),t),Te=(u,e,t)=>(Pe(u,e,"access private method"),t);const z={select:"select",checkbox:"checkbox"},G={client:"client",world:"world"},O=()=>({generalSettings:{tag:"flash5e-general-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["showMenuOnLoad","rollInterceptionEnabled","useGMTargetTokens","templateAutoTarget","removeTemplate","consumptionConfigMode","placeTemplateForPlayer","showOfflineNotifications","initiateCombatOnRequest","showOnlyPCsWithToken","compactMode","menuLayout","showOptionsListOnHover","publicPlayerRolls","addMacrosToFolder"],default:{showMenuOnLoad:!1,rollInterceptionEnabled:!0,useGMTargetTokens:!0,templateAutoTarget:1,removeTemplate:!0,consumptionConfigMode:2,placeTemplateForPlayer:!1,showOfflineNotifications:!0,initiateCombatOnRequest:!0,showOnlyPCsWithToken:!0,compactMode:!0,menuLayout:"vertical",showOptionsListOnHover:!0,publicPlayerRolls:!0,addMacrosToFolder:!0},scope:G.world,config:!1,requiresReload:!1},groupRollsSettings:{tag:"flash5e-group-rolls-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["groupRollsMsgEnabled","groupRollResultMode","showGroupDCToPlayers","groupRollNPCHidden"],default:{groupRollsMsgEnabled:!0,groupRollResultMode:1,showGroupDCToPlayers:!1,groupRollNPCHidden:!0},scope:G.world,config:!1,requiresReload:!1},showGroupDCToPlayers:{tag:"show-group-dc-to-players",label:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:G.world,config:!1},groupRollNPCHidden:{tag:"group-roll-npc-hidden",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollNPCHidden.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollNPCHidden.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!1},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!0},groupRollsMsgEnabled:{tag:"group-roll-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!1},groupRollResultMode:{tag:"group-roll-result-mode",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.hint"),propType:Number,inputType:z.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.4")},default:1,scope:G.world,config:!1},consumptionConfigMode:{tag:"consumption-config",label:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.hint"),propType:Number,inputType:z.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.4")},default:2,scope:G.world,config:!1},placeTemplateForPlayer:{tag:"place-template-for-player",label:game.i18n.localize("FLASH_ROLLS.settings.placeTemplateForPlayer.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.placeTemplateForPlayer.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:G.world,config:!1},skipRollDialog:{tag:"skip-roll-dialog",label:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:G.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!1},rollInterceptionEnabled:{tag:"roll-interception-on",label:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:G.world,config:!1},publicPlayerRolls:{tag:"public-player-rolls",label:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!1},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!1},showRequestNotifications:{tag:"show-request-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!1},initiateCombatOnRequest:{tag:"initiate-combat-on-request",label:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!1},showOnlyPCsWithToken:{tag:"show-only-pcs-with-token",label:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!1},compactMode:{tag:"compact-mode",label:game.i18n.localize("FLASH_ROLLS.settings.compactMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.compactMode.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!1},menuLayout:{tag:"menu-layout",label:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.hint"),propType:String,inputType:z.select,choices:{vertical:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.choices.vertical"),horizontal:game.i18n.localize("FLASH_ROLLS.settings.menuLayout.choices.horizontal")},default:"vertical",scope:G.world,config:!1},showOptionsListOnHover:{tag:"show-list-on-hover",label:game.i18n.localize("FLASH_ROLLS.settings.showOptionsListOnHover.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOptionsListOnHover.hint"),propType:Boolean,default:!0,scope:G.world,config:!1},templateAutoTarget:{tag:"template-auto-target",label:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.hint"),propType:Number,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.all.label"),2:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.notFriendly.label"),3:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.none.label")},inputType:z.select,default:1,scope:G.world,config:!1},removeTemplate:{tag:"remove-template",label:game.i18n.localize("FLASH_ROLLS.settings.removeTemplate.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.removeTemplate.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!1},debugMode:{tag:"debug-mode-on",label:game.i18n.localize("FLASH_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:G.client,config:!0},showMenuOnLoad:{tag:"show-menu-on-world-load",label:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.hint"),propType:Boolean,inputType:z.checkbox,default:!1,scope:G.world,config:!1},addMacrosToFolder:{tag:"add-macros-to-folder",label:game.i18n.localize("FLASH_ROLLS.settings.addMacrosToFolder.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.addMacrosToFolder.hint"),propType:Boolean,inputType:z.checkbox,default:!0,scope:G.world,config:!1}}),b="flash-rolls-5e",De=["%cFlash Rolls 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],qe={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest"},ae={ATTACK:"attack",CAST:"cast",CHECK:"check",DAMAGE:"damage",ENCHANT:"enchant",FORWARD:"forward",HEAL:"heal",ORDER:"order",SAVE:"save",SUMMON:"summon",TRANSFORM:"transform",UTILITY:"utility"},p={ABILITY:"ability",ABILITY_CHECK:"abilitycheck",ATTACK:"attack",CONCENTRATION:"concentration",CUSTOM:"custom",DEATH_SAVE:"deathsave",FORMULA:"formula",DAMAGE:"damage",HEALING:"healing",HIT_DIE:"hitdie",INITIATIVE:"initiative",INITIATIVE_DIALOG:"initiativedialog",ITEM_SAVE:"itemsave",SAVE:"save",SAVING_THROW:"savingthrow",SKILL:"skill",TOOL:"tool"},Tt={ABILITY_CHECK:{name:p.ABILITY_CHECK,label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:p.SAVING_THROW,label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:p.SKILL,label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:p.TOOL,label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:p.CONCENTRATION,label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:p.INITIATIVE,label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:p.DEATH_SAVE,label:"Death Save",subList:null,actorPath:""},HIT_DIE:{name:p.HIT_DIE,label:"Hit Die",subList:null,actorPath:""},CUSTOM:{name:p.CUSTOM,label:"Custom Roll",subList:null,actorPath:""}},V={ID:b,ROLL_REQUEST_OPTIONS:Tt},w={INIT:"init",READY:"ready",RENDER_CHAT_MESSAGE:"renderChatMessageHTML",RENDER_CHAT_LOG:"renderChatLog",CHANGE_SIDEBAR_TAB:"changeSidebarTab",RENDER_SIDEBAR:"renderSidebar",UPDATE_SCENE:"updateScene",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",COLLAPSE_SIDE_BAR:"collapseSidebar",REFRESH_MEASURED_TEMPLATE:"refreshMeasuredTemplate",CONTROL_TOKEN:"controlToken",DELETE_TOKEN:"deleteToken",CREATE_TOKEN:"createToken",UPDATE_ACTOR:"updateActor",UPDATE_ITEM:"updateItem",CREATE_ITEM:"createItem",DELETE_ITEM:"deleteItem",UPDATE_SETTING:"updateSetting",GET_ACTOR_CONTEXT_OPTIONS:"getActorContextOptions",GET_CHAT_MESSAGE_CONTEXT_OPTIONS:"getChatMessageContextOptions",RENDER_ACTOR_DIRECTORY:"renderActorDirectory"},At={READY:"socketlib.ready"},It={READY:"midi-qol.ready"},B={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_USE_ACTIVITY:"dnd5e.preUseActivity",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE_DIALOG:"dnd5e.preRollInitiativeDialog",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog",RENDER_SKILL_TOOL_ROLL_DIALOG:"renderSkillToolRollConfigurationDialog"},Ee=class Ee{static log(e="",t=[],s=!1){try{const o=game.settings.get(b,"debug-mode-on")||Ee.debugOn;if(!(s||o))return;const a=Array.isArray(t)?t:[t];console.log(...De,e,...a)}catch{if(s||Ee.debugOn){const i=Array.isArray(t)?t:[t];console.log(...De,e,...i)}}}static warn(e="",t=[]){const s=Array.isArray(t)?t:[t];console.warn(...De,e,...s)}static error(e,t=[],s={ui:!1,console:!0,permanent:!1}){var i;const o=Array.isArray(t)?t:[t];s.ui&&((i=ui.notifications)==null||i.error(e,{localize:!0,permanent:s.permanent})),s.console&&console.error(...De,e,...o)}};D(Ee,"debugOn",!1);let c=Ee;const x=class x{static serializeForTransport(e,t=!1){return c.log("serializeForTransport",[e,t]),e==null||t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(s=>s instanceof Roll?s.toJSON():s)),e}static deserializeFromTransport(e,t=!1){c.log("deserializeFromTransport",[e,t]);let s={...e};if(!e)return s;if(t&&e.rolls&&e.rolls.length>0){const o=s.rolls.map(i=>{let a=i;return typeof i=="string"?a=Roll.fromJSON(i):i instanceof Roll?a=i:a=Roll.fromJSON(JSON.stringify(i)),a});return s.rolls=[...o],s}return s}};D(x,"socket"),D(x,"_activeExecutions",new Map),D(x,"initialize",e=>{c.log("initialize",[e]),Hooks.once(At.READY,()=>{if(typeof socketlib>"u"){c.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{x.socket=socketlib.registerModule(b),e&&e()}catch{}})}),D(x,"registerCall",(e,t)=>{c.log("registerCall",[e]),x.socket&&x.socket.register(e,t)}),D(x,"sendMessage",(e,t)=>{c.log("sendMessage",[e]),t&&t()}),D(x,"execForGMs",async(e,...t)=>{if(c.log("execForGMs",[e,...t]),!!x.socket)return await x.socket.executeForAllGMs(e,...t)}),D(x,"execForAll",async(e,...t)=>{if(x.socket)return await x.socket.executeForEveryone(e,...t)}),D(x,"execForUser",async(e,t,...s)=>{if(c.log("execForUser #0",[e,t,...s]),!x.socket)return;if(c.log("execForUser #1",[t===game.user.id]),t===game.user.id)return null;const o=`${e}-${t}`;if(c.log("execForUser #2",[x._activeExecutions.has(o)]),x._activeExecutions.has(o))return null;x._activeExecutions.set(o,!0);try{const i=await x.socket.executeAsUser(e,t,...s);return c.log("execForUser #3 - response",[i]),i}catch(i){return c.error("execForUser #4 - error",[i]),null}finally{c.log("execForUser #5 - success",[]),x._activeExecutions.delete(o)}});let le=x;class me{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const e=game.settings.storage.get("client");return this.diceConfig=e["core.diceConfiguration"]||"",this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){le.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(e,t){var s,o;((s=game.user)!=null&&s.isGM||e===((o=game.user)==null?void 0:o.id))&&(this.playerDiceConfigs[e]=t?JSON.parse(t):{})}static getUserDiceConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?this.diceConfig:this.playerDiceConfigs[e]||{}}static requestDiceConfigFromUser(e){le.execForUser("getDiceConfig",e)}static requestDiceConfigFromAllPlayers(){var e;(e=game.user)!=null&&e.isGM&&game.users.forEach(t=>{t.active&&!t.isGM&&t.id!==game.user.id&&this.requestDiceConfigFromUser(t.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?!!this.diceConfig:!!this.playerDiceConfigs[e]}}D(me,"diceConfig",{}),D(me,"playerDiceConfigs",{});var Fe,lt;class H{static isModuleOn(e){var s;const t=(s=game.modules)==null?void 0:s.get(e);return!!(t!=null&&t.active)}static html(e,t){return e.querySelector(t)}static getFullWidth(e){return window.getComputedStyle(e).width==="0px"?0:e.offsetWidth}static preventDialogFlicker(e,t=100){e&&(e.style.opacity="0",e.style.transition="opacity 0.15s ease-in",setTimeout(()=>{e&&(e.style.opacity="1")},t))}static addCSSVars(e,t){let s=document.querySelector("style#flash5e-vars");if(!s){const f=document.querySelector("body.flash5e");if(!f)return;const h=f.querySelector("style#flash5e-vars");h&&h.remove(),s=document.createElement("style"),s.id="flash5e-vars",s.textContent=`body.flash5e {
}
`,f.prepend(s)}let o=s.textContent,i=o.indexOf("body.flash5e {"),a=o.indexOf("}",i);i===-1&&(o=`body.flash5e {
}
`,i=0,a=o.indexOf("}"));const n=o.substring(i+14,a).split(";").map(f=>f.trim()).filter(f=>f!==""),r={};n.forEach(f=>{const h=f.split(":");if(h.length>=2){const R=h[0].trim(),y=h.slice(1).join(":").trim();R&&(r[R]=y)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),r[e]=t;const d=Object.entries(r).map(([f,h])=>`  ${f}: ${h};`).join(`
`),g=o.substring(0,i)+`body.flash5e {
`+d+`
}`+o.substring(a+1);s.textContent=g}static getOffsetBottom(e){const t=e.offsetTop,s=e.offsetHeight;return window.innerHeight-(t+s)}static async getAllFonts(){const e=new Set(Object.keys(CONFIG.fontDefinitions)),t=game.settings.get("core","fonts")||{},s=Object.entries(t).map(([a])=>a),o=await this.processStyleSheets();return Array.from(new Set([...e,...s,...o])).filter(a=>!/FontAwesome|Font Awesome|FoundryVTT/.test(a)).map(a=>a.replace(/['"]/g,"").trim()).sort((a,l)=>a.toLowerCase().localeCompare(l.toLowerCase()))||[]}static addCustomCSS(e,t="flash5e-custom-css",s=!0){if(!e)return;let o=document.querySelector("#"+t);o||(o=document.createElement("style"),o.id=t,o.textContent="",document.head.appendChild(o));const i=/@import\s+(?:url\()?\s*['"]?[^'")]+['"]?\s*\)?\s*;/g,a=[];let l=e,n;for(;(n=i.exec(e))!==null;)a.push(n[0]);if(l=e.replace(i,"").trim(),!s){o.textContent=a.join(`
`)+(a.length?`

`:"")+l;return}if(!o.textContent.includes(l)){const r=o.textContent,d=[];let g;for(;(g=i.exec(r))!==null;)d.push(g[0]);const f=r.replace(i,"").trim(),h=a.filter(y=>!d.includes(y)),R=[...d,...h];o.textContent=R.join(`
`)+(R.length?`

`:"")+f+(f&&l?`

`:"")+l}}static smoothScrollTo(e,t,s="horizontal",o=300,i=null){const a=e.dataset.scrollAnimationId;a&&cancelAnimationFrame(Number(a));const l=s==="horizontal",n=l?e.scrollLeft:e.scrollTop,r=t-n;if(r===0)return i&&i(),null;const d=performance.now(),g=h=>{const R=h-d;if(R>=o){l?e.scrollLeft=t:e.scrollTop=t,delete e.dataset.scrollAnimationId,i&&i();return}const y=R/o,S=y<.5?2*y*y:1-Math.pow(-2*y+2,2)/2;l?e.scrollLeft=n+r*S:e.scrollTop=n+r*S;const m=requestAnimationFrame(g);return e.dataset.scrollAnimationId=m,m},f=requestAnimationFrame(g);return e.dataset.scrollAnimationId=f,f}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredLabel"),s={}){const o={window:{title:e},position:{width:420,height:"auto"},content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.reloadButton"),callback:()=>(c.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(o,s),foundry.applications.api.DialogV2.confirm(o)}static renderTemplate(e,t){return foundry.applications.handlebars.renderTemplate(e,t)}static loadTemplate(e){return foundry.applications.handlebars.loadTemplate(e)}static loadTemplates(e){return Array.isArray(e)||(e=[e]),foundry.applications.handlebars.loadTemplates(e)}static isValidCSSRule(e){if(!e||typeof e!="string")return!1;const t=e.trim();if(!t)return!1;try{const s=document.createElement("style"),o=`${t} { color: inherit; }`;s.textContent=o,document.head.appendChild(s);const i=!!(s.sheet&&s.sheet.cssRules&&s.sheet.cssRules.length>0);return document.head.removeChild(s),i}catch(s){return c.log("CSS validation error:",[s,e]),!1}}static processCSSRules(e,t){if(!e||!t)return"";const s=Te(this,Fe,lt).call(this,e),o=t+` {
`+s.baseProperties.join(`
`)+`
}`,i=[],a=new Map;return s.nestedRules.forEach(l=>{const{selector:n,content:r}=l;if(n.startsWith("&")){const f=n.substring(1),h=t.split(",").map(R=>R.trim()).filter(Boolean).map(R=>R+f).join(", ");i.push(`${h} {
${r}
}`);return}a.has(r)||a.set(r,[]);const d=n.split(",").map(f=>f.trim()),g=t.split(",").map(f=>f.trim()).filter(Boolean);d.forEach(f=>{g.forEach(h=>{a.get(r).push(`${h} ${f}`)})})}),a.forEach((l,n)=>{i.push(`${l.join(", ")} {
${n}
}`)}),o+`

`+i.join(`

`)}static getActorOwner(e){const t=e.ownership||{};for(const[s,o]of Object.entries(t))if(o>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const i=game.users.get(s);if(i&&!i.isGM)return i}if((t==null?void 0:t.default)>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const s=game.users.filter(o=>!o.isGM)[0];if(s)return s}return null}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredLabel"),s={}){const o={window:{title:e},position:{width:420,height:"auto"},content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.reloadButton"),callback:()=>(c.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(o,s),foundry.applications.api.DialogV2.confirm(o)}static removeTemplateForItem(e){const t=O(),s=A.get(t.removeTemplate.tag);if(c.log("removeTemplateForItem",[e,s]),!s)return;const o=canvas.templates.objects.children.filter(i=>i.document.flags.dnd5e.item===(e==null?void 0:e.uuid));o.length>0&&canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate",o.map(i=>i.id))}}Fe=new WeakSet,lt=function(e){const t=[],s=[],o=e.split(`
`);let i=null,a=0;for(let l=0;l<o.length;l++){const n=o[l].trim();if(!n)continue;const r=(n.match(/{/g)||[]).length,d=(n.match(/}/g)||[]).length;if(n.includes("{")&&!i){i={selector:n.substring(0,n.indexOf("{")).trim(),content:"",startLine:l},a=1;const f=n.substring(n.indexOf("{")+1).trim();f&&!f.includes("}")&&(i.content+=f+`
`)}else i?(a+=r-d,a>0?i.content+=n+`
`:(i.content=i.content.replace(/}\s*$/,"").trim(),s.push(i),i=null)):!n.includes("{")&&!n.includes("}")&&t.push(n)}return{baseProperties:t,nestedRules:s}},re(H,Fe),D(H,"wrapFontName",e=>{const t=e.replace(/['"`]/g,"");return t.includes(" ")?`"${t}"`:t});const{FormDataExtended:$t}=foundry.utils,{ApplicationV2:Et,HandlebarsApplicationMixin:Ct}=foundry.applications.api;var at,de,Se,We,pe,nt,rt,ct;const v=class v extends Ct(Et){constructor(){super(...arguments);D(this,"_onRender",(t,s)=>{O(),ce(v,de,this.element),F(v,de).querySelectorAll(".toggle-hint").forEach(a=>{a.addEventListener("click",()=>{F(v,de).querySelectorAll("p.hint").forEach(l=>l.classList.toggle("shown"))})}),F(v,de).querySelectorAll("select[data-current-value]").forEach(a=>{const l=String(a.dataset.currentValue),n=a.querySelector(`option[value="${l}"]`);n&&(n.selected=!0)})})}_configureRenderParts(t){const s=super._configureRenderParts(t),o=v.getRestrictedTabs();return game.user.isGM||o.forEach(i=>{delete s[i]}),s}async _prepareContext(t){const s=await super._prepareContext(t);return s.activeTab=t.activeTab||Object.keys(s.tabs)[0],s.isGM=game.user.isGM,s}async _preparePartContext(t,s,o){var l,n,r;const i=await super._preparePartContext(t,s,o);t in s.tabs&&(i.tab=i.tabs[t]),O(),dt();const a=v.getRestrictedTabs();switch(game.user.isGM||a.forEach(d=>{delete i.tabs[d]}),t){case"tabs":break;case"footer":{i.buttons=[{type:"button",icon:"",label:"FLASH_ROLLS.ui.buttons.reset",action:"redefine"},{type:"submit",icon:"",label:"FLASH_ROLLS.ui.buttons.save"}];break}default:{i.tab=i.tabs[t];const d=((l=v.PARTS[t])==null?void 0:l.menuKey)||null;if(d){const g=v.getMenuContext(d);g.fields&&(i.fields={...i.fields,...g.fields}),g.fieldDefaults&&(i.fieldDefaults={...i.fieldDefaults,...g.fieldDefaults}),g.fieldValues&&Object.assign(i,g.fieldValues),i.sidebarTabs=Object.values(((r=(n=foundry.applications)==null?void 0:n.sidebar)==null?void 0:r.tabs)||{}).map(f=>({tabName:f.tabName,name:f.name,hideForGM:!1,hideForPlayer:!1,localizedName:`FLASH_ROLLS.settings.sidebarTabs.${f.name}`}))}break}}return c.log("_preparePartContext",[i,t]),i}static getMenuContext(t){var n;const s=O(),o=((n=s[t])==null?void 0:n.fields)||null;if(!o)return{};const i={},a={},l={};return o.forEach(r=>{if(s[r]){const d=A.get(s[r].tag);i[r]=s[r],a[r]=d!==void 0?d:s[r].default,l[r]=s[r].default}}),{fields:i,fieldValues:a,fieldDefaults:l}}static getRestrictedTabs(){const t=[];return Object.entries(v.PARTS).forEach((s,o)=>{s[0]!=="tabs"&&s[0]!=="footer"&&s[1].isGMOnly&&t.push(s[0])}),t}static updateSettings(t){let s=!1;const o=O(),l=F(v,de).querySelector(".form-content.active").dataset.tab;if(ce(v,Se,l),!t)return;let n;return t.object&&(n=foundry.utils.expandObject(t.object)),Object.entries(n).forEach(([r,d])=>{var g;if(!r.endsWith("_value")&&(c.log("updateSettings #1",[o,o[r]]),n[r]!==void 0&&o[r])){const f=A.get(o[r].tag);A.set(o[r].tag,n[r]),(g=o[r])!=null&&g.requiresReload&&f!==n[r]&&(s=!0)}}),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.settingsUpdated")),s}changeTab(t,s,o){super.changeTab(t,s,o),ce(v,Se,t)}};de=new WeakMap,Se=new WeakMap,We=new WeakMap,pe=new WeakSet,nt=async function(t,s,o){t.preventDefault(),t.stopPropagation(),v.updateSettings(o)&&H.confirmReload()},rt=async function(t,s){const o=O(),a=F(v,de).querySelector(".form-content.active"),l=a.dataset.tab,n=v.PARTS[l].menuKey,r=o[n].default;a.querySelectorAll("input, select").forEach(g=>{g.value=r[g.name],g.type==="checkbox"&&(g.checked=r[g.name])}),c.log("#onReset",[F(v,Se),l,t,s])},ct=function(){const t=[];return Object.entries(v.PARTS).forEach(([s,o])=>{o.menuKey&&t.push({id:s,icon:"",group:"primary-tabs",label:`FLASH_ROLLS.settings.moduleSettingsMenu.tabs.${s}`})}),t},re(v,pe),re(v,de),re(v,Se),re(v,We),D(v,"selectedTheme"),D(v,"DEFAULT_OPTIONS",{id:"flash-rolls-settings",tag:"form",window:{icon:"fas fa-cog",title:"FLASH_ROLLS.settings.moduleSettingsMenu.title",contentClasses:["standard-form","crlngn","flash5e","tabbed-settings"],resizable:!0},position:{width:700,height:"auto"},actions:{redefine:Te(v,pe,rt)},form:{handler:Te(v,pe,nt),closeOnSubmit:!0}}),D(v,"PARTS",{tabs:{template:"templates/generic/tab-navigation.hbs",isGMOnly:!1},generalSettings:{menuKey:"generalSettings",template:"modules/flash-rolls-5e/templates/settings-general.hbs",isGMOnly:!0},groupRolls:{menuKey:"groupRollsSettings",template:"modules/flash-rolls-5e/templates/settings-group-rolls.hbs",isGMOnly:!0},rollInterception:{menuKey:"rollInterceptionSettings",template:"modules/flash-rolls-5e/templates/settings-roll-interception.hbs",isGMOnly:!0},footer:{template:"templates/generic/form-footer.hbs",isGMOnly:!1}}),D(v,"TABS",{primary:{initial:"generalSettings",tabs:Te(at=v,pe,ct).call(at),labelPrefix:""}});let xe=v;class Ot extends FormApplication{constructor(...e){super(...e),window.open("https://www.patreon.com/c/carolingiandev/membership","_blank"),this.close()}render(){return this.close(),this}}function dt(){return{moduleSettingsMenu:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),name:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),icon:"fas fa-cog",propType:xe,restricted:!0},supportPatreon:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.label"),name:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.label"),label:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.buttonLabel"),hint:game.i18n.localize("FLASH_ROLLS.settings.supportPatreon.hint"),icon:"fas fa-heart",propType:Ot,restricted:!1}}}class Ae{static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}static getMidiQOL(){return this.isModuleActive("midi-qol")&&typeof MidiQOL<"u"?MidiQOL:null}}D(Ae,"midiTimeout",null);function _t(u,e){var o,i,a,l,n;let t=game.i18n.localize(`FLASH_ROLLS.rollTypes.${u}`)||u;const s=u==null?void 0:u.toLowerCase();if(e)switch(s){case p.SKILL:t+=` (${((o=CONFIG.DND5E.skills[e])==null?void 0:o.label)||e})`;break;case p.SAVE:t+=` (${((i=CONFIG.DND5E.abilities[e])==null?void 0:i.label)||e})`;break;case p.ABILITY:t+=` (${((a=CONFIG.DND5E.abilities[e])==null?void 0:a.label)||e})`;break;case p.TOOL:const r=(n=(l=CONFIG.DND5E.enrichmentLookup)==null?void 0:l.tools)==null?void 0:n[e];if(r!=null&&r.id){const d=dnd5e.documents.Trait.getBaseItem(r.id,{indexOnly:!0});t+=` (${(d==null?void 0:d.name)||e})`}else t+=` (${e})`;break;case p.CUSTOM:t=`${t}: ${e}`;break}return t}function Dt(u,e){var s,o,i,a,l;if(!e)return"";switch(u==null?void 0:u.toLowerCase()){case p.SKILL:return((s=CONFIG.DND5E.skills[e])==null?void 0:s.label)||e;case p.SAVE:case p.SAVING_THROW:return((o=CONFIG.DND5E.abilities[e])==null?void 0:o.label)||e;case p.ABILITY:case p.ABILITY_CHECK:return((i=CONFIG.DND5E.abilities[e])==null?void 0:i.label)||e;case p.TOOL:const n=(l=(a=CONFIG.DND5E.enrichmentLookup)==null?void 0:a.tools)==null?void 0:l[e];if(n!=null&&n.id){const r=dnd5e.documents.Trait.getBaseItem(n.id,{indexOnly:!0});return(r==null?void 0:r.name)||e}return e;default:return e}}function kt(u,e=_t){if(u.length===0)return;const t={};for(const o of u){const i=`${o.rollType}_${o.rollKey||""}`;t[i]||(t[i]={rollType:o.rollType,rollKey:o.rollKey,actors:[],gm:o.gm}),t[i].actors.push(o.actor)}const s=Object.values(t);if(s.length===1&&s[0].actors.length===1){const o=s[0];ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestReceived",{gm:o.gm,rollType:e(o.rollType,o.rollKey)}))}else{const o=[];for(const i of s){const a=e(i.rollType,i.rollKey),l=i.actors.join(", ");o.push(`${a} (${l})`)}ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsReceivedMultiple",{gm:s[0].gm,requests:o.join("; ")}))}}function ut(u){const e=u.ownership||{};for(const[t,s]of Object.entries(e))if(s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const o=game.users.get(t);if(o&&!o.isGM)return o}return null}function vt(u,e=game.user){u!=null&&u.length&&u.forEach((t,s)=>{c.log("applyTargetTokens",[t,canvas.tokens.placeables.map(i=>i.id)]);const o=canvas.tokens.placeables.find(i=>i.id===t);o?o.setTarget(!0,{releaseOthers:s===0}):c.warn("applyTargetTokens - Token not found:",[t])})}function Ge(u){return u.type!=="character"&&u.type!=="npc"?!1:Object.entries(u.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}function gt(u){if(u.type!=="character"&&u.type!=="npc")return!1;const e=game.scenes.active;return e&&e.tokens.some(t=>t.actorId===u.id)}function ue(u,e,t=null){if(!game.scenes.active)return;let o;if(t){const i=canvas.tokens.placeables.find(a=>a.id===t);o=i?[i]:[]}else o=canvas.tokens.placeables.filter(i=>{var a;return((a=i.actor)==null?void 0:a.id)===u});for(const i of o)e?i.control({releaseOthers:!1}):i.release()}function Me(u){return new Promise(e=>setTimeout(e,u))}function et(){var u;return((u=ui==null?void 0:ui.sidebar)==null?void 0:u.expanded)||!1}function tt(u){const e=document.querySelector("body");u?e.classList.add("flash5e-sidebar-expanded"):e.classList.remove("flash5e-sidebar-expanded"),Ie()}function st(u,e){var i,a;const t=[];if(!u)return t;const s=V.ROLL_REQUEST_OPTIONS[u];if(!s||!s.subList)return t;const o=CONFIG.DND5E[s.subList];if(o){for(const[l,n]of Object.entries(o)){let r=n.label||n.name||l;if(s.subList==="tools"&&((a=(i=CONFIG.DND5E.enrichmentLookup)==null?void 0:i.tools)!=null&&a[l])){const d=CONFIG.DND5E.enrichmentLookup.tools[l];if(d!=null&&d.id){const g=dnd5e.documents.Trait.getBaseItem(d.id,{indexOnly:!0});r=(g==null?void 0:g.name)||r}}t.push({id:l,name:r,rollable:!0})}t.sort((l,n)=>l.name.localeCompare(n.name))}return t}const W=class W{static notify(e,t,s={}){if(!s.batch){ui.notifications[e](t);return}s.batchData&&(W.pendingNotifications.push(s.batchData),W.notificationTimer&&clearTimeout(W.notificationTimer),W.notificationTimer=setTimeout(()=>{kt(W.pendingNotifications),W.pendingNotifications=[],W.notificationTimer=null},W.NOTIFICATION_BATCH_DELAY))}static notifyRollRequestsSent(e,t){const s=Object.entries(e);if(s.length!==0)if(s.length===1){const o=Object.values(e)[0],i=o.actors.map(a=>a.name).join(", ");ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentSingle",{rollType:t,actors:i,player:o.player.name}))}else{const o=s.map(([i,a])=>{const l=a.actors.map(n=>n.name).join(", ");return`${a.player.name} (${l})`});ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentMultiple",{rollType:t,count:s.length,players:o.join("; ")}))}}static clearPending(){W.notificationTimer&&(clearTimeout(W.notificationTimer),W.notificationTimer=null),W.pendingNotifications=[]}};D(W,"pendingNotifications",[]),D(W,"notificationTimer",null),D(W,"NOTIFICATION_BATCH_DELAY",500);let j=W;function wt(u){var s;const e=[],t=[];for(const o of u){const i=((s=o.system.attributes.hp)==null?void 0:s.value)||0,a=o.system.attributes.death||{},l=a.success||0,n=a.failure||0;i<=0&&l<3&&n<3?e.push(o):t.push(o.name)}return t.length>0&&j.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorsSkippingDeathSave",{actors:t.join(", ")})),e}function Mt(u){const e=[],t=[];for(const s of u){const o=ut(s);o?e.push({actor:s,owner:o}):t.push(s)}return{pcActors:e,npcActors:t}}function Ie(u=!0){const e=document.querySelector("#chat-notifications #roll-privacy"),t=e?H.getFullWidth(e):36,s=!!document.querySelector("body.crlngn-tabs");H.addCSSVars("--flash-rolls-menu-offset",(s?t:t+16)+"px")}function Q(u){var o,i;const e=game.actors.get(u);if(e)return e;const t=(o=canvas.tokens)==null?void 0:o.get(u),s=(i=game.scenes.active)==null?void 0:i.tokens.get(u);return e||(t==null?void 0:t.actor)||(s==null?void 0:s.actor)||null}function ft(){const u=O();switch(A.get(u.consumptionConfigMode.tag)){case 1:return!1;case 2:return game.user.isGM;case 3:return!game.user.isGM;default:return!0}}function we(u){const e=ft();return{action:e,resources:e?u.resources:[],spellSlot:e}}function ze(u,e=!0){const t=O(),s=A.get(t.placeTemplateForPlayer.tag),o=game.user.isGM?s||e:e||!s;return{...u,measuredTemplate:u.measuredTemplate?o:!1}}const _={addSituationalBonus(u,e){var t;return c.log("Config before adding bonus:",[e,u]),e&&((t=u.rolls)!=null&&t[0])&&(u.rolls[0].parts||(u.rolls[0].parts=[]),u.rolls[0].data||(u.rolls[0].data={}),u.rolls[0].data.situational=e,u.rolls[0].parts.includes("@situational")||u.rolls[0].parts.push("@situational"),c.log("Config after adding bonus:",[u])),u},async unsetActivityFlag(u){if(!game.user.isGM||!u)return;const e=u.getFlag(b,"tempActivityConfig");e&&(c.log("updateActivityConfigFlag - cleaning up existing config",[e]),await u.unsetFlag(b,"tempActivityConfig"))},async updateActivityConfigFlag(u,e){c.log("updateActivityConfigFlag - storing new activity config",[e]),await u.setFlag(b,"tempActivityConfig",e)},buildRollConfig(u,e,t={}){var i;c.log("RollHelpers.buildRollConfig - incoming rollConfig",["parts:",e.parts,"data:",e.data,"requestData.config.situational:",u.config.situational]);const s={rolls:[{parts:e.parts||[],data:e.data||{},options:{...e.options||{},...((i=e.options)==null?void 0:i._fromFlashRolls)&&{_fromFlashRolls:!0}}}],advantage:u.config.advantage||!1,disadvantage:u.config.disadvantage||!1,target:u.config.target,subject:null,chatMessage:!0,legacy:!1,...u.config.rollMode&&{rollMode:u.config.rollMode},...t},o=u.config.situational;return o&&this.addSituationalBonus(s,o),this.ensureRollFlags(s,u)},ensureRollFlags(u,e){return u.isRollRequest=!game.user.isGM,u._showRequestedBy=!0,u._requestedBy=e.config.requestedBy||"GM",u},validateActors(u){return!u||u.length===0?null:(typeof u[0]=="string"&&(u=u.map(e=>game.actors.get(e)).filter(e=>e)),u.length>0?u:null)},getRollClass(u){const e=u==null?void 0:u.toLowerCase();return[p.DAMAGE,p.HEALING].includes(e)?CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:[p.FORMULA,p.CUSTOM,p.HIT_DIE].includes(e)?CONFIG.Dice.BasicRoll:CONFIG.Dice.D20Roll},shouldShowDC(u){const e=u==null?void 0:u.toLowerCase();return[p.SAVE,p.SAVING_THROW,p.ABILITY,p.ABILITY_CHECK,p.CONCENTRATION,p.SKILL,p.TOOL].includes(e)},createBaseRollConfig(u,e,t){const s=e==null?void 0:e.toLowerCase(),o={data:u.getRollData(),subject:u,rolls:[{parts:[],data:u.getRollData(),options:{}}]};switch(s){case p.SKILL:o.skill=t;break;case p.TOOL:o.tool=t;break;case p.SAVE:case p.SAVING_THROW:case p.ABILITY:case p.ABILITY_CHECK:o.ability=t;break;case p.HIT_DIE:o.rolls[0].options.flavor="Hit Die";break}return o},createMessageConfig(u,e=null){const t={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:u})}};return e&&(t.rollMode=e),t},async triggerRollDialog(u,e,t,s){const o=new u(e,t,s);return await new Promise(a=>{o.addEventListener("close",()=>{a({rolls:o.rolls,config:o.config,message:o.message,sendRequest:o.sendRequest,critical:o.config.critical,isCritical:o.config.isCritical})},{once:!0}),o.render({force:!0})})},processDialogResult(u,e,t,s,o={}){var y,S,m,L,T,I,E;if(!(u!=null&&u.rolls)||u.rolls.length===0)return null;const i=t==null?void 0:t.toLowerCase(),a=u.rolls[0];let l=!1,n=!1;((y=a==null?void 0:a.options)==null?void 0:y.advantageMode)!==void 0&&(l=a.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,n=a.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const r=((S=a==null?void 0:a.data)==null?void 0:S.situational)||"",d=(m=a==null?void 0:a.options)==null?void 0:m.target,g={rolls:[{parts:((L=a==null?void 0:a.parts)==null?void 0:L.slice())||[],data:r?{situational:r}:{},options:d?{target:d}:{}}],subject:e[0],advantage:l,disadvantage:n,target:d,sendRequest:u.sendRequest,isRollRequest:u.sendRequest,skipRollDialog:((T=u.config)==null?void 0:T.skipRollDialog)||o.skipRollDialog||!1,chatMessage:!0},f=O(),h=A.get(f.publicPlayerRolls.tag)===!0,R=this.determineRollMode(h,(I=u.message)==null?void 0:I.rollMode);return g.rollMode=R,(E=u.config)!=null&&E.ability&&[p.SKILL,p.TOOL].includes(i)&&(g.ability=u.config.ability),g},determineRollMode(u,e){return e||game.settings.get("core","rollMode")},isPlayerOwned(u){return Object.entries(u.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})},isPlayerOwnerActive(u){const e=ut(u);return e&&e.active},calculateStandardRule(u,e){const t=u.filter(i=>i.total>=e).length,s=u.length-t,o=Math.ceil(u.length/2);return{finalResult:t>=o,successes:t,failures:s,summary:game.i18n.format("FLASH_ROLLS.groupRoll.standardRule.summary",{successes:t,total:u.length,threshold:o}),method:"Standard Rule"}},calculateGroupAverage(u,e){const t=u.reduce((o,i)=>o+i.total,0),s=Math.floor(t/u.length);return{finalResult:s,average:s,success:s>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.groupAverage.summary",{average:s,dc:e}),method:"Group Average"}},calculateLeaderWithHelp(u,e,t,s,o){var S;let i=-999,a=-1,l=null,n=0;for(let m=0;m<u.length;m++){const L=u[m],T=t.find(E=>E.id===L.actorId);if(!T)continue;const I=this._getActorModifier(T,s,o);I>i&&(i=I,a=m,l=T.id,n=I)}if(a===-1)return{finalResult:0,error:"No leader found",method:"Leader with Help"};const r=u[a],d=u.filter((m,L)=>L!==a),g=d.filter(m=>m.total>=e).length,f=d.filter(m=>m.total<e).length,h=r.total+g-f;let R,y={leaderRoll:r.total,adjustedResult:h,dc:e};return g>0&&f>0?(R="FLASH_ROLLS.groupRoll.leaderWithHelp.summary",y.bonus=g,y.penalty=f):g>0?(R="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlySuccess",y.bonus=g,y.successWord=g===1?game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.successPlural")):f>0?(R="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlyFailure",y.penalty=f,y.failureWord=f===1?game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.failureSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.leaderWithHelp.failurePlural")):R="FLASH_ROLLS.groupRoll.leaderWithHelp.summaryNoModifiers",{finalResult:h,leaderRoll:r.total,leaderName:(S=t.find(m=>m.id===l))==null?void 0:S.name,leaderActorId:l,leaderModifier:n,bonus:g,penalty:f,success:h>=e,summary:game.i18n.format(R,y),method:"Leader with Help"}},calculateWeakestLink(u,e,t,s,o){var f;let i=999,a=null,l=0;for(const h of t){const R=this._getActorModifier(h,s,o);R<i&&(i=R,a=h.id,l=R)}const n=u.find(h=>h.actorId===a);if(!n)return{finalResult:0,error:"Weakest link actor did not roll",method:"Weakest Link"};const r=u.filter(h=>h.actorId!==a&&h.total>=e).length,d=n.total+r,g=r===1?game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successPlural");return{finalResult:d,weakestRoll:n.total,weakestName:(f=t.find(h=>h.id===a))==null?void 0:f.name,weakestActorId:a,weakestModifier:l,bonus:r,success:d>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.weakestLink.summary",{weakestRoll:n.total,bonus:r,successWord:g,adjustedResult:d,dc:e}),method:"Weakest Link"}},_getActorModifier(u,e,t){var o,i,a,l,n,r,d;switch(e==null?void 0:e.toLowerCase()){case p.SKILL:return((o=u.system.skills[t])==null?void 0:o.total)||((i=u.system.skills[t])==null?void 0:i.mod)||0;case p.SAVE:case p.SAVING_THROW:return((l=(a=u.system.abilities[t])==null?void 0:a.save)==null?void 0:l.value)||((n=u.system.abilities[t])==null?void 0:n.save)||0;case p.ABILITY:case p.ABILITY_CHECK:return((r=u.system.abilities[t])==null?void 0:r.mod)||0;case p.TOOL:if((d=u.system.tools)!=null&&d[t])return u.system.tools[t].total||u.system.tools[t].mod||0;const g=u.items.find(f=>f.type==="tool"&&f.system.toolType===t);return(g==null?void 0:g.system.bonus)||0;default:return 0}},getGroupResult(u,e,t,s,o){if(!u.every(r=>r.total!==null&&r.total!==void 0))return{complete:!1,success:!1,result:0};const a=O(),l=A.get(a.groupRollResultMode.tag)||1;let n;switch(l){case 1:return n=this.calculateStandardRule(u,e),{complete:!0,success:n.finalResult,result:n.finalResult?1:0,details:n};case 2:return n=this.calculateGroupAverage(u,e),{complete:!0,success:n.success,result:n.finalResult,details:n};case 3:return n=this.calculateLeaderWithHelp(u,e,t,s,o),{complete:!0,success:n.success,result:n.finalResult,details:n};case 4:return n=this.calculateWeakestLink(u,e,t,s,o),{complete:!0,success:n.success,result:n.finalResult,details:n};default:return n=this.calculateStandardRule(u,e),{complete:!0,success:n.finalResult,result:n.finalResult?1:0,details:n}}},consolidateRolls(u){if(!u||u.length===0||u.length===1)return u;let e=u[0];for(let t=1;t<u.length;t++)u[t]&&(e=foundry.utils.mergeObject(e,u[t],{insertKeys:!0,insertValues:!0,overwrite:!1,inplace:!0}));return[e]},shouldDisplayChallengeForPlayer(u){var s;if(game.user.isGM)return!0;const e=u._requestedBy;if(e===game.user.name)return!0;switch(game.settings.get("dnd5e","challengeVisibility")){case"all":return!0;case"player":return e!==((s=game.users.find(o=>o.isGM))==null?void 0:s.name);default:return!1}}};class Ft{static findActivityForRoll(e,t){var i;if(!((i=e==null?void 0:e.system)!=null&&i.activities))return null;const s=e.system.activities;switch(t==null?void 0:t.toLowerCase()){case p.ATTACK:const a=s.getByType("attack");return(a==null?void 0:a[0])||null;case p.DAMAGE:const l=s.getByType("attack");if((l==null?void 0:l.length)>0)return l[0];const n=s.getByType("damage");if((n==null?void 0:n.length)>0)return n[0];const r=s.getByType("save");return(r==null?void 0:r.length)>0?r[0]:null;case p.ITEM_SAVE:const d=s.getByType("save");return(d==null?void 0:d[0])||null;default:return null}}static getActivitiesByType(e,t){var s;return(s=e==null?void 0:e.system)!=null&&s.activities?e.system.activities.getByType(t):[]}static hasActivityForRoll(e,t){return c.log("hasActivityForRoll",[e,t]),!!this.findActivityForRoll(e,t)}static async executeActivityRoll(e,t,s,o,i){var f,h,R,y,S,m,L,T;c.log("executeActivityRoll",[e,t,s,o,i]);const a=O();game.user.isGM&&A.get(a.placeTemplateForPlayer.tag)||game.user.isGM;const l=Ae.isModuleActive("midi-qol"),n=e.items.get(s);if(!n){c.error("Item not found on actor",[e,s]);return}let r=null,d=null;if(o&&(r=(f=n.system.activities)==null?void 0:f.get(o)),r=r||this.findActivityForRoll(n,t),!r)throw new Error(`Activity not found on item ${n.name}`);c.log("executeActivityRoll - activity",[r,t]);const g=t==null?void 0:t.toLowerCase();if(r)switch(g){case p.ATTACK:c.log("executeActivityRoll - is attack activity",[i]);const I={attackMode:i.usage.attackMode,ammunition:i.usage.ammunition,mastery:i.usage.mastery,situational:(y=(R=(h=i.usage.rolls)==null?void 0:h[0])==null?void 0:R.data)==null?void 0:y.situational,advantage:i.usage.advantage,disadvantage:i.usage.disadvantage,rollMode:(S=i.message)==null?void 0:S.rollMode,skipRollDialog:i.usage.skipRollDialog,consume:i.usage.consume,create:i.usage.create};await r.item.setFlag(b,"tempAttackConfig",I),c.log("executeActivityRoll - stored temp config as flag",[I]);try{i.message.create=!0,l&&(i.usage.consume=we(i.usage.consume||{})),await r.use(i.usage,i.dialog,i.message)}catch(k){c.error("executeActivityRoll - attack roll error",[k])}finally{await r.item.unsetFlag(b,"tempAttackConfig")}return;case p.DAMAGE:c.log("executeActivityRoll - damage roll #0",[r,i]),l?i.dialog.configure=!game.user.isGM:i.message.create=!0,d={critical:i.usage.critical||{},situational:i.usage.rolls[0].data.situational||"",rollMode:(m=i.message)==null?void 0:m.rollMode,create:((L=i.message)==null?void 0:L.create)!==!1,scaling:i.usage.scaling,skipRollDialog:i.usage.skipRollDialog,consume:i.usage.consume},i.usage={...i.usage,consume:we(i.usage.consume||{}),create:ze(i.usage.create||{})};const E=r.type===ae.DAMAGE||r.type===ae.SAVE||!(r!=null&&r.attack),C=r.type===ae.SAVE,N=r.type===ae.ATTACK;l&&E?await this.midiActivityRoll(r,i.usage):!game.user.isGM&&E&&await r.use(i.usage,{...i.dialog,configure:!0},i.message),await r.item.setFlag(b,"tempDamageConfig",d),c.log("executeActivityRoll - damage config with situational",[d]);try{if(l){const k=Ae.getMidiQOL();if(k){const M=(T=k.Workflow)==null?void 0:T.getWorkflow(r.uuid);if(M.midiOptions={fastForward:!1,autoFastDamage:!1,autoRollDamage:!1},c.log("executeActivityRoll - workflow",[damageHandledByUse]),M&&C){const U=await M.activity.rollDamage({...d,workflow:M},{...i.dialog,configure:!0},{})}return}}else c.log("executeActivityRoll - isDamageOnlyActivity",[E,r,d,i]),E&&i.usage.skipRollDialog&&await r.use(i.usage,{...i.dialog,configure:!i.usage.skipRollDialog},i.message),(E&&!C||C&&i.usage.skipRollDialog||N)&&(i.usage.consume=we(i.usage.consume||{}),i.usage.create=ze(i.usage.create||{}),r.type!==ae.DAMAGE&&await r.rollDamage(d,i.dialog,i.message))}catch(k){c.error("executeActivityRoll - damage roll error",[k])}finally{await r.item.unsetFlag(b,"tempDamageConfig")}return;default:c.log("executeActivityRoll - unknown roll type",[g]),await r.use(i.usage,i.dialog,i.message);return}throw new Error(`No suitable method found for ${g} on item ${n.name}`)}static getActivityDisplayInfo(e){return c.log("getActivityDisplayInfo",[e]),e?{name:e.name||e.constructor.metadata.label,type:e.type,icon:e.constructor.metadata.icon,canAttack:e.type==="attack",canDamage:["attack","damage","save"].includes(e.type),canSave:e.type==="save"}:null}static getDamageFormula(e){var s,o;if(c.log("getDamageFormula",[e]),!((o=(s=e==null?void 0:e.damage)==null?void 0:s.parts)!=null&&o.length))return null;const t=e.damage.parts.map(i=>i.formula).filter(i=>i);return t.length>0?t.join(" + "):null}static async midiActivityRoll(e,t={}){c.log("midiActivityRoll",[e,t]);const s=Ae.getMidiQOL();if(!s){c.warn("MidiQOL is not active");return}let o={consume:{action:!1,resources:[],spellSlot:!1},fastForward:!1,fastForwardAttack:!1,dialogOptions:{fastForward:!1,fastForwardAttack:!1,fastForwardDamage:!1},configureDialog:!0,midiOptions:{autoRollAttack:!1,autoFastAttack:!1,autoRollDamage:"none",autoFastDamage:!1,fastForward:!1,fastForwardAttack:!1,fastForwardDamage:!1,autoConsumeResource:"none"}};return e.midiProperties={...e.midiProperties,forceDamageDialog:"always"},t={...o,...t},c.log("midiActivityRoll - config",[t]),await s.completeActivityUse(e,t,{})}}class Be{static addSidebarControls(e,t){if(c.log("addSidebarControls",[e,t]),!game.user.isGM||!e||e.id!=="sidebar")return;const s=document.querySelector("#roll-privacy");if(c.log("addSidebarControls",[s]),!s||s.querySelector(".flash-rolls-icon"))return;const o=O(),i=A.get(o.rollRequestsEnabled.tag),a=document.createElement("button");a.id="flash-rolls-icon",a.setAttribute("data-tooltip-direction","RIGHT"),a.className=`ui-control icon chat-control-icon flash-rolls-icon${i?" active":""}`,a.title=game.i18n.localize("FLASH_ROLLS.ui.menus.rollRequestsTitle"),a.innerHTML=`<i class="fas fa-bolt${i?"":"-slash"}"></i>`;const l=s.firstChild;l?l.parentNode.insertBefore(a,l):s.insertBefore(a,s.firstChild),c.log("addSidebarControls",[l,a]),a.addEventListener("click",n=>{n.stopPropagation(),n.preventDefault(),Z.toggle()})}static updateRollRequestsIcon(e){const t=document.querySelector("#flash-rolls-icon i");t&&(t.className=`fas fa-bolt${e?"":"-slash"}`)}}const{ApplicationV2:Ht,HandlebarsApplicationMixin:Nt}=foundry.applications.api;class Ye extends Nt(Ht){constructor(e={}){super(e),this.formula=e.formula||"",this.readonly=e.readonly||!1,this.actor=e.actor,this.callback=e.callback,this.diceCounts={}}static get DEFAULT_OPTIONS(){return foundry.utils.mergeObject(super.DEFAULT_OPTIONS,{classes:["flash5e-dialog","flash5e-custom-roll-dialog"],tag:"div",window:{title:"FLASH_ROLLS.ui.dialogs.customRollTitle",icon:"fas fa-dice-d20",resizable:!1,positioned:!0,frame:!0},position:{width:420,height:"auto"}})}get id(){var e;return`flash5e-custom-roll-dialog-${((e=this.actor)==null?void 0:e.id)||"unknown"}`}get title(){const e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.customRollTitle");return this.actor?`${e} - ${this.actor.name}`:e}_onClickAction(e,t){switch(t.dataset.action){case"rollDice":return this.rollDice(e,t);case"addDie":return this.addDie(e,t);case"cancel":return this.cancel(e,t)}}async _prepareContext(e={}){return{...await super._prepareContext(e),formula:this.formula,readonly:this.readonly}}_attachPartListeners(e,t,s){super._attachPartListeners(e,t,s);const o=t.querySelector("#custom-roll-formula"),i=t.querySelector("#formula-validation-message");o&&!this.readonly&&(o.addEventListener("input",a=>{this.formula=a.target.value.trim(),this.updateValidationMessage(i)}),this.formula&&this.updateValidationMessage(i))}updateValidationMessage(e){if(!e)return;if(!this.formula){e.textContent="&nbsp;",e.classList.remove("error","success");return}this.validateFormula(this.formula)?(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaValid"),e.classList.remove("error"),e.classList.add("success")):(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaInvalid"),e.classList.remove("success"),e.classList.add("error"))}addDie(e,t){const s=t.dataset.die,o=this.element.querySelector("#custom-roll-formula");if(!o)return;const i=o.value.trim();if(i){const a=/(\d*)d(\d+)/g,l=new Map;let n=i,r;for(;(r=a.exec(i))!==null;){const f=parseInt(r[1]||"1"),h=r[2];l.set(h,(l.get(h)||0)+f),n=n.replace(r[0],"").trim()}const d=s.substring(1);l.set(d,(l.get(d)||0)+1);const g=[];for(const[f,h]of l)g.push(`${h}d${f}`);n=n.replace(/^\+\s*|\s*\+\s*$|\s*\+\s*\+/g,"").trim(),n&&n!=="+"?this.formula=`${g.join(" + ")} + ${n}`:this.formula=g.join(" + ")}else this.formula=`1${s}`;o.value=this.formula,o.dispatchEvent(new Event("input"))}validateFormula(e){var t;if(!e||e.trim()==="")return!1;try{return Roll.validate(e)}catch{try{return new Roll(e,((t=this.actor)==null?void 0:t.getRollData())||{}),!0}catch{return!1}}}async rollDice(){if(c.log("rollDice"),!this.validateFormula(this.formula)){ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.invalidFormula",{formula:this.formula||"empty"}));return}this.callback&&await this.callback(this.formula),this.close()}cancel(){this.close()}static async prompt(e={}){return new Promise(t=>{const s=new this({...e,callback:o=>t(o)});s.addEventListener("close",()=>{s._resolved||t(null)}),s.render(!0)})}async close(e={}){return this._resolved=!0,super.close(e)}}D(Ye,"PARTS",{main:{template:`modules/${V.ID}/templates/custom-roll-dialog.hbs`},footer:{template:`modules/${V.ID}/templates/custom-roll-dialog-footer.hbs`}});const ge=class ge{static async initialize(){c.log("ChatMessageUtils.initialize"),await this.preloadTemplate()}static _attachGroupRollListeners(e,t){e.querySelectorAll(".actor-result").forEach(i=>{i.addEventListener("click",a=>{if(a.target.closest(".dice-btn.rollable"))return;a.preventDefault(),a.stopPropagation();const l=i;c.log("actor-result click",[i]),l.classList.contains("expanded")?l.classList.remove("expanded"):l.classList.add("expanded")})}),e.querySelectorAll(".dice-btn.rollable").forEach(i=>{i.addEventListener("click",async a=>{var T;a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation();const l=i.dataset,n=l.actorId,r=game.actors.get(n);if(!r){ui.notifications.warn("Actor not found");return}if(!(game.user.isGM||r.isOwner)){ui.notifications.warn(`You don't have permission to roll for ${r.name}`);return}const g=(T=l.type)==null?void 0:T.toLowerCase(),f=l.rollKey,h=l.groupRollId,R=l.dc?parseInt(l.dc):null;c.log("Rollable dice clicked",[g,f,n,h]);const y={rollKey:f,groupRollId:h,config:{advantage:!1,disadvantage:!1,target:R,rollMode:game.settings.get("core","rollMode")}},S={configure:!0,isRollRequest:!0},m={rollMode:game.settings.get("core","rollMode"),create:!0,isRollRequest:!0},L={parts:[],data:{},options:{}};try{const I=K[g];if(I)await I(r,y,L,S,m);else{let E;switch(g){case p.SKILL:E="rollSkill";break;case p.ABILITY:case p.ABILITY_CHECK:E="rollAbilityTest";break;case p.SAVE:case p.SAVING_THROW:E="rollAbilitySave";break;case p.TOOL:E="rollToolCheck";break;default:ui.notifications.warn(`Unknown roll type: ${g}`);return}E&&r[E]&&await r[E](f,{...y.config,messageOptions:{"flags.flash-rolls-5e.groupRollId":h}})}}catch(I){c.error("Error executing roll from chat",I),ui.notifications.error(`Failed to execute roll: ${I.message}`)}})});const s=e.querySelector(".group-roll-dc-control"),o=e.querySelector(".dc-input");if(s){const i=s.dataset.showToPlayers==="true";if(game.user.isGM||(s.style.display="none"),!game.user.isGM&&!i){const a=e.querySelector(".group-roll-footer .group-result-details");a&&(a.style.display="none")}}if(o)if(!game.user.isGM)o.readOnly=!0,o.style.cursor="not-allowed";else{let i=null;const a=async()=>{const l=parseInt(o.value);if(!o.value)return;if(isNaN(l)||l<1||l>99){o.value="";return}const n=o.dataset.messageId,r=game.messages.get(n);r&&await ge.updateGroupRollDC(r,l)};o.addEventListener("input",l=>{i&&clearTimeout(i),i=setTimeout(()=>{a()},750)}),o.addEventListener("keypress",l=>{l.key==="Enter"&&(i&&clearTimeout(i),a())})}}static async preloadTemplate(){c.log("ChatMessageUtils.preloadTemplate");try{await H.loadTemplates([this.templatePath])}catch(e){c.error("Failed to preload template",e)}}static async createGroupRollMessage(e,t,s,o,i){c.log("ChatMessageUtils.createGroupRollMessage",[e.length,t,s,i]);const a=this.buildGroupRollData(e,t,s,o);if(!a)return c.error("createGroupRollMessage - Failed to build group roll data"),null;a.groupRollId=i;const l=e.filter(g=>g&&g.actor),r=l.some(g=>_.isPlayerOwnerActive(g.actor))?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode");return this.pendingRolls.set(i,{actorEntries:l.map(g=>({actorId:g.actor.id,uniqueId:g.uniqueId,tokenId:g.tokenId})),rollType:t,rollKey:s,config:o,results:new Map}),await this.postGroupMessage(a,r)}static buildGroupRollData(e,t,s,o){const i=e.filter(R=>R&&R.actor);if(i.length===0)return c.error("buildGroupRollData - No valid actor entries found",[e]),null;let a=this._buildFlavorText(t,s,o);const l=(o==null?void 0:o.dc)||(o==null?void 0:o.target),n=i.map(R=>{var y,S,m,L;return{actorId:R.actor.id,uniqueId:R.uniqueId,tokenId:R.tokenId,actorImg:R.actor.img||((S=(y=R.actor.prototypeToken)==null?void 0:y.texture)==null?void 0:S.src)||"icons/svg/mystery-man.svg",actorName:R.tokenId&&((L=(m=canvas.tokens)==null?void 0:m.get(R.tokenId))==null?void 0:L.name)||R.actor.name,isNPC:!R.actor.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER),rolled:!1,showDice:!0,total:null,success:!1,failure:!1}}),r=_.shouldShowDC(t),d=O(),g=A.get(d.showGroupDCToPlayers.tag),f=A.get(d.groupRollNPCHidden.tag),h=game.user.isGM;return n.forEach(R=>{R.shouldHide=R.isNPC&&f&&!h}),{flavor:a,results:n,showDC:l!=null,dc:l,rollType:t,rollKey:s,supportsDC:r,showDCToPlayers:g,groupRollNPCHidden:f,isGM:h,actorEntries:i.map(R=>({actorId:R.actor.id,uniqueId:R.uniqueId,tokenId:R.tokenId})),moduleId:b}}static _buildFlavorText(e,t,s){var i,a,l,n,r,d,g,f;let o="";switch(e==null?void 0:e.toLowerCase()){case p.ABILITY:case p.ABILITY_CHECK:const h=((i=CONFIG.DND5E.abilities[t])==null?void 0:i.label)||t;o=game.i18n.format("DND5E.AbilityPromptTitle",{ability:h});break;case p.SAVE:case p.SAVING_THROW:const R=((a=CONFIG.DND5E.abilities[t])==null?void 0:a.label)||t;o=game.i18n.format("DND5E.SavePromptTitle",{ability:R});break;case p.SKILL:const y=((l=CONFIG.DND5E.skills[t])==null?void 0:l.label)||t,S=(s==null?void 0:s.ability)||((n=CONFIG.DND5E.skills[t])==null?void 0:n.ability)||"int",m=((r=CONFIG.DND5E.abilities[S])==null?void 0:r.label)||S;c.log("buildFlavorText - skill",[s==null?void 0:s.ability,y,S,m]),o=game.i18n.format("DND5E.SkillPromptTitle",{skill:y,ability:m});break;case p.TOOL:const L=(g=(d=CONFIG.DND5E.enrichmentLookup)==null?void 0:d.tools)==null?void 0:g[t];let T=t;if(L!=null&&L.id){const C=dnd5e.documents.Trait.getBaseItem(L.id,{indexOnly:!0});T=(C==null?void 0:C.name)||t}const I=(s==null?void 0:s.ability)||(L==null?void 0:L.ability)||"int",E=((f=CONFIG.DND5E.abilities[I])==null?void 0:f.label)||I;o=game.i18n.format("DND5E.ToolPromptTitle",{tool:T,ability:E});break;case p.CONCENTRATION:o=game.i18n.localize("DND5E.Concentration")||"Concentration";break;case p.DEATH_SAVE:o=game.i18n.localize("DND5E.DeathSave")||"Death Saving Throw";break;case p.HIT_DIE:case"hitdice":o=game.i18n.localize("DND5E.HitDice")||"Hit Dice";break;case p.HEALING:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Healing")||"Healing";break;case p.CUSTOM:o=(s==null?void 0:s.flavor)||t||game.i18n.localize("DND5E.Roll")||"Custom Roll";break;case p.FORMULA:o=(s==null?void 0:s.flavor)||t||game.i18n.localize("DND5E.Roll")||"Custom Formula";break;case p.ITEM_SAVE:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.SavingThrow")||"Saving Throw";break;case p.INITIATIVE:o=game.i18n.localize("DND5E.Initiative");break;case p.ATTACK:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Attack")||"Attack Roll";break;case p.DAMAGE:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Damage")||"Damage Roll";break;default:o=(s==null?void 0:s.flavor)||"Roll"}return o}static async postGroupMessage(e,t=null){c.log("postGroupMessage - groupRollId",[e.groupRollId,t]);try{const o={content:await H.renderTemplate(this.templatePath,e),speaker:{alias:"Group Roll"},flags:{[b]:{isGroupRoll:!0,groupRollId:e.groupRollId,rollData:e},rsr5e:{processed:!0,quickRoll:!1}}};t&&ChatMessage.applyRollMode(o,t);const i=await ChatMessage.create(o);return this.groupRollMessages.set(e.groupRollId,i),i}catch(s){return c.error("Failed to post group message",s),null}}static async updateGroupRollMessage(e,t,s){if(game.user.isGM)return c.log("ChatMessageUtils.updateGroupRollMessage #0",[e,t,s]),await this._performGroupRollUpdate(e,t,s)}static async _performGroupRollUpdate(e,t,s){var d,g,f,h,R,y;let o=this.groupRollMessages.get(e),i=this.pendingRolls.get(e);if(!o&&(o=game.messages.contents.find(m=>m.getFlag(b,"groupRollId")===e&&m.getFlag(b,"isGroupRoll")),o&&(this.groupRollMessages.set(e,o),c.log("_performGroupRollUpdate - Found and registered group message",[e]),!i))){const m=o.getFlag(b,"rollData");i={actorEntries:m.actorEntries||m.results.map(L=>({actorId:L.actorId,uniqueId:L.uniqueId,tokenId:L.tokenId})),results:new Map},this.pendingRolls.set(e,i)}if(!o){c.log("No group message found for groupRollId",e);return}i&&i.results&&i.results.set(t,{total:s.total,roll:s});const a=o.getFlag(b,"rollData");c.log("_performGroupRollUpdate - Searching for uniqueId",[t,"in results:",a.results.map(S=>({uniqueId:S.uniqueId,actorId:S.actorId,tokenId:S.tokenId}))]);let l=a.results.findIndex(S=>S.uniqueId===t);if(l===-1){if(l=a.results.findIndex(S=>S.actorId===t),l===-1&&(l=a.results.findIndex(S=>S.tokenId===t)),l===-1&&((d=o.speaker)!=null&&d.actor)){const S=o.speaker.actor;l=a.results.findIndex(m=>m.actorId===S)}if(l===-1){const S=((g=canvas.tokens)==null?void 0:g.get(t))||((h=(f=game.scenes.active)==null?void 0:f.tokens)==null?void 0:h.get(t));if(S&&S.actor){const m=S.actor.id;c.log("_performGroupRollUpdate - Trying token actor match",[t,"token actor:",m]),l=a.results.findIndex(L=>L.actorId===m||L.uniqueId===m)}}}if(l!==-1){a.results[l].rolled=!0,a.results[l].showDice=!1,a.results[l].total=s.total;try{let S=await s.render();a.results[l].rollBreakdown=S}catch(S){c.error("Error rendering roll breakdown",[S]),a.results[l].rollBreakdown=null}a.showDC&&a.dc&&(a.results[l].success=s.total>=a.dc,a.results[l].failure=s.total<a.dc)}else{c.error("Group message id not found");return}a.allRolled=a.results.every(S=>S.rolled),a.messageId=o.id,a.supportsDC=_.shouldShowDC(a.rollType);const n=O();if(a.showDCToPlayers=A.get(n.showGroupDCToPlayers.tag),a.groupRollNPCHidden=A.get(n.groupRollNPCHidden.tag),a.isGM=game.user.isGM,a.results&&a.results.forEach(S=>{if(S.isNPC===void 0){const m=game.actors.get(S.actorId);S.isNPC=m?!m.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER):!1}S.shouldHide=S.isNPC&&a.groupRollNPCHidden&&!a.isGM}),a.supportsDC&&a.showDC&&a.dc){const S=((R=a.actorEntries)==null?void 0:R.map(L=>game.actors.get(L.actorId)).filter(L=>L))||((y=a.actors)==null?void 0:y.map(L=>game.actors.get(L)).filter(L=>L))||[],m=_.getGroupResult(a.results,a.dc,S,a.rollType,a.rollKey);a.groupResult=m,c.log("updateGroupRollMessage - COMPLETE?",[m.complete]),m.complete&&m.details&&(a.groupSummary=m.details.summary)}const r=await H.renderTemplate(this.templatePath,a);await o.update({content:r,flags:{[b]:{rollData:a}}}),i!=null&&i.results&&(i!=null&&i.actorEntries)&&i.results.size===i.actorEntries.length&&(this.pendingRolls.delete(e),setTimeout(()=>{this.groupRollMessages.delete(e),this.updateQueue.delete(e)},6e4))}static async updateGroupRollDC(e,t){var n,r;const s=e.getFlag(b,"rollData");if(!s||(s.supportsDC=_.shouldShowDC(s.rollType),!s.supportsDC))return;s.dc=t,s.showDC=!0,s.results.forEach(d=>{d.rolled&&d.total!==null&&(d.success=d.total>=t,d.failure=d.total<t)});const o=((n=s.actorEntries)==null?void 0:n.map(d=>game.actors.get(d.actorId)).filter(d=>d))||((r=s.actors)==null?void 0:r.map(d=>game.actors.get(d)).filter(d=>d))||[],i=_.getGroupResult(s.results,t,o,s.rollType,s.rollKey);s.groupResult=i,i.complete&&i.details&&(s.groupSummary=i.details.summary),s.allRolled=s.results.every(d=>d.rolled),s.messageId=e.id;const a=O();s.showDCToPlayers=A.get(a.showGroupDCToPlayers.tag),s.groupRollNPCHidden=A.get(a.groupRollNPCHidden.tag),s.isGM=game.user.isGM,s.results&&s.results.forEach(d=>{if(d.isNPC===void 0){const g=game.actors.get(d.actorId);d.isNPC=g?!g.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER):!1}d.shouldHide=d.isNPC&&s.groupRollNPCHidden&&!s.isGM});const l=await H.renderTemplate(this.templatePath,s);await e.update({content:l,flags:{[b]:{rollData:s}}})}static interceptRollMessage(e,t,s){var f,h,R,y,S,m,L;const o=O();if(!A.get(o.groupRollsMsgEnabled.tag))return;const a=(f=e.speaker)==null?void 0:f.actor,l=(h=e.speaker)==null?void 0:h.token;let n;if(l){const T=((R=canvas.tokens)==null?void 0:R.get(l))||((S=(y=game.scenes.active)==null?void 0:y.tokens)==null?void 0:S.get(l));n=T==null?void 0:T.actor}if(n||(n=game.actors.get(a)),!n)return;const r=l||a,d=e.getFlag(b,"groupRollId")||((m=n.getFlag(b,"tempInitiativeConfig"))==null?void 0:m.groupRollId);if(!d){c.log("interceptRollMessage #2 - no groupRollId in flag",[n.name]);return}if(!game.user.isGM&&!this.groupRollMessages.has(d)){const I=game.messages.contents.find(E=>E.getFlag(b,"groupRollId")===d&&E.getFlag(b,"isGroupRoll"));I&&(this.groupRollMessages.set(d,I),c.log("interceptRollMessage - Registered group roll message",[n.name,d]))}if(!this.groupRollMessages.has(d)){const I=game.messages.contents.find(E=>E.getFlag(b,"groupRollId")===d&&E.getFlag(b,"isGroupRoll"));if(I)c.log("interceptRollMessage - Found group message in chat log, registering",[d]),this.groupRollMessages.set(d,I);else{c.log("interceptRollMessage - No group message found in chat log either",[d]);return}}const g=(L=e.rolls)==null?void 0:L[0];if(g)if(t&&t instanceof HTMLElement&&t.style&&(t.style.display="none"),game.user.isGM){c.log("interceptRollMessage - Updating group message",[d,r,n.name,g.total]),this.updateGroupRollMessage(d,r,g);const T=e.id;if(this.messagesScheduledForDeletion.has(T))return;this.messagesScheduledForDeletion.add(T),T&&setTimeout(async()=>{c.log("interceptRollMessage - deletion",[T]);try{game.messages.get(T)?(await e.delete(),c.log("interceptRollMessage - Deleted individual message",[T])):c.log("interceptRollMessage - Message already deleted",[T])}catch(I){c.log("interceptRollMessage - Error deleting message",[T,I.message])}finally{this.messagesScheduledForDeletion.delete(T)}},500)}else c.log("interceptRollMessage - Player roll intercepted, GM will handle update",[d])}static isGroupRoll(e){return this.pendingRolls.has(e)||this.groupRollMessages.has(e)}static async addGroupRollFlag(e,t,s=null){const o=O(),i=A.get(o.groupRollsMsgEnabled.tag);if(c.log("addGroupRollFlag called",[e,t.groupRollId,this.isGroupRoll(t.groupRollId)]),!game.user.isGM&&t.groupRollId&&s&&(await s.setFlag(b,"tempGroupRollId",t.groupRollId),s.isToken&&s.actor&&(await s.actor.setFlag(b,"tempGroupRollId",t.groupRollId),c.log("addGroupRollFlag - Also stored tempGroupRollId on base actor for player",[t.groupRollId,s.actor.id])),!this.groupRollMessages.has(t.groupRollId))){const l=game.messages.contents.find(n=>n.getFlag(b,"groupRollId")===t.groupRollId&&n.getFlag(b,"isGroupRoll"));l&&(this.groupRollMessages.set(t.groupRollId,l),c.log("addGroupRollFlag - Registered group roll message on player side",[t.groupRollId]))}i&&t.groupRollId&&(!game.user.isGM||this.isGroupRoll(t.groupRollId))&&(e.data=e.data||{},e.data.flags=e.data.flags||{},e.data.flags[b]=e.data.flags[b]||{},e.data.flags[b].groupRollId=t.groupRollId,e.data.flags.rsr5e={processed:!0,quickRoll:!1},c.log("addGroupRollFlag - Added flag to messageConfig",[e]))}static cleanup(){const e=Date.now()-3e5;for(const[t,s]of this.groupRollMessages.entries())s.timestamp<e&&(this.groupRollMessages.delete(t),this.pendingRolls.delete(t))}};D(ge,"groupRollMessages",new Map),D(ge,"pendingRolls",new Map),D(ge,"messagesScheduledForDeletion",new Set),D(ge,"updateQueue",new Map),D(ge,"templatePath","modules/flash-rolls-5e/templates/chat-msg-group-roll.hbs");let $=ge;const K={ability:async(u,e,t,s,o)=>{const i=_.buildRollConfig(e,t,{ability:e.rollKey});await $.addGroupRollFlag(o,e,u),await u.rollAbilityCheck(i,s,o)},abilitycheck:async(u,e,t,s,o)=>K.ability(u,e,t,s,o),save:async(u,e,t,s,o)=>{var a;const i=_.buildRollConfig(e,t,{ability:((a=e.config)==null?void 0:a.ability)||e.rollKey});await $.addGroupRollFlag(o,e,u),await u.rollSavingThrow(i,s,o)},savingthrow:async(u,e,t,s,o)=>K.save(u,e,t,s,o),skill:async(u,e,t,s,o)=>{var l,n,r,d;const i=((n=(l=u.system.skills)==null?void 0:l[e.rollKey])==null?void 0:n.ability)||((d=(r=CONFIG.DND5E.skills)==null?void 0:r[e.rollKey])==null?void 0:d.ability)||void 0,a=_.buildRollConfig(e,t,{skill:e.rollKey,chooseAbility:s.configure!==!1,ability:e.config.ability||i});await $.addGroupRollFlag(o,e,u),await u.rollSkill(a,s,o)},tool:async(u,e,t,s,o)=>{var n,r,d,g;const i=(n=u.system.tools)==null?void 0:n[e.rollKey],a=(i==null?void 0:i.ability)||((g=(d=(r=CONFIG.DND5E.enrichmentLookup)==null?void 0:r.tools)==null?void 0:d[e.rollKey])==null?void 0:g.ability)||"int",l=_.buildRollConfig(e,t,{tool:e.rollKey,chooseAbility:s.configure!==!1,ability:e.config.ability||a});c.log("RollHandlers.tool #2",[l,s,o]),await $.addGroupRollFlag(o,e,u),await u.rollToolCheck(l,s,o)},concentration:async(u,e,t,s,o)=>{const i=_.buildRollConfig(e,t);await $.addGroupRollFlag(o,e,u),await u.rollConcentration(i,s,o)},attack:async(u,e,t,s,o)=>{await K.handleActivityRoll(u,p.ATTACK,e,t,s,o)},damage:async(u,e,t,s,o)=>{await K.handleActivityRoll(u,p.DAMAGE,e,t,s,o)},itemsave:async(u,e,t,s,o)=>{await K.handleActivityRoll(u,p.ITEM_SAVE,e,t,s,o)},initiative:async(u,e,t,s,o)=>{var a,l,n;if(!game.combat){ui.notifications.warn(game.i18n.localize("COMBAT.NoneActive"));return}e.config.situational||(a=t.data)!=null&&a.situational,e.groupRollId;let i=u;if(!u.isToken){const r=canvas.tokens.placeables.find(d=>{var g;return((g=d.actor)==null?void 0:g.id)===u.id});if(r)i=r.actor;else{ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.noTokensForInitiative"));return}}await $.addGroupRollFlag(o,e,u);try{if(s.configure){if(c.log("RollHandlers.initiative - Dialog",[]),e.config){const r=_.buildRollConfig(e,t,{ability:((n=(l=u.system.attributes)==null?void 0:l.init)==null?void 0:n.ability)||"dex"}),d={advantage:e.config.advantage||!1,disadvantage:e.config.disadvantage||!1,rollMode:e.config.rollMode||game.settings.get("core","rollMode"),rolls:r.rolls,groupRollId:e.groupRollId};await u.setFlag(b,"tempInitiativeConfig",d),await i.setFlag(b,"tempInitiativeConfig",d)}await i.rollInitiativeDialog(),await i.unsetFlag(b,"tempInitiativeConfig"),await u.unsetFlag(b,"tempInitiativeConfig")}else{const r={rollMode:e.config.rollMode||game.settings.get("core","rollMode"),groupRollId:e.groupRollId};await u.setFlag(b,"tempInitiativeConfig",r),await i.setFlag(b,"tempInitiativeConfig",r);const d={createCombatants:!0,rerollInitiative:!0};await i.rollInitiative(d),await i.unsetFlag(b,"tempInitiativeConfig"),await u.unsetFlag(b,"tempInitiativeConfig")}}catch(r){c.error("RollHandlers.initiative - Error",[r]),j.notify("error",`Initiative roll failed: ${r.message}`)}},initiativedialog:async(u,e,t,s,o)=>K.initiative(u,e,t,s,o),deathsave:async(u,e,t,s,o)=>{const i=_.buildRollConfig(e,t);await $.addGroupRollFlag(o,e,u),await u.rollDeathSave(i,s,o)},hitdie:async(u,e,t,s,o)=>{s.configure=game.user.isGM?s.configure:!0;const i=_.buildRollConfig(e,t,{denomination:e.rollKey});c.log("RollHandlers.hitdie",[i,s,o]),await $.addGroupRollFlag(o,e,u),await u.rollHitDie(i,s,o)},custom:async(u,e,t,s,o)=>{await K.handleCustomRoll(u,e,s,o)},async handleActivityRoll(u,e,t,s,o,i){var a,l;if(c.log("RollHandlers.handleActivityRoll",[e,t,s]),t.rollKey){const n=_.buildRollConfig(t,s),r=((l=(a=n.rolls)==null?void 0:a[0])==null?void 0:l.options)||{},d={usage:{...t.config,rolls:n.rolls,...r.attackMode&&{attackMode:r.attackMode},...r.ammunition&&{ammunition:r.ammunition},...r.mastery!==void 0&&{mastery:r.mastery},...t.config.spell&&{spell:t.config.spell},...t.config.scaling!==void 0&&{scaling:t.config.scaling},...t.config.consume&&{consume:t.config.consume},...t.config.create&&{create:t.config.create}},dialog:{...o,configure:game.user.isGM&&t.config.skipRollDialog!==void 0?!t.config.skipRollDialog:o.configure},message:i};c.log("handleActivityRoll - final activity config",[d]),await Ft.executeActivityRoll(u,e,t.rollKey,t.activityId,d)}},async handleCustomRoll(u,e,t,s){var a,l,n,r;const o=e.rollKey;if((t==null?void 0:t.configure)===!1){try{const d=new Roll(o,u.getRollData());d.options=d.options||{},d.options.isRollRequest=((a=e.config)==null?void 0:a.isRollRequest)!==!1,await d.evaluate(),await $.addGroupRollFlag(s,e,u),await d.toMessage({speaker:ChatMessage.getSpeaker({actor:u}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${p.CUSTOM}`),rollMode:(s==null?void 0:s.rollMode)||((l=e.config)==null?void 0:l.rollMode)||game.settings.get("core","rollMode"),isRollRequest:((n=e.config)==null?void 0:n.isRollRequest)!==!1,create:(s==null?void 0:s.create)!==!1,flags:(r=s==null?void 0:s.data)==null?void 0:r.flags})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:o}))}return}new Ye({formula:o,readonly:!0,actor:u,callback:async d=>{var g;try{const f=new Roll(d,u.getRollData());f.options=f.options||{},f.options.isRollRequest=!0,await f.evaluate(),await $.addGroupRollFlag(s,e,u),await f.toMessage({speaker:ChatMessage.getSpeaker({actor:u}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${p.CUSTOM}`),rollMode:e.config.rollMode,isRollRequest:!0,_showRequestedBy:!0,_requestedBy:e.config.requestedBy||"GM",flags:(g=s==null?void 0:s.data)==null?void 0:g.flags})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:d}))}}}).render(!0)},async handleHitDieRecovery(u){const e=foundry.utils.mergeObject({type:"long",deltas:{hitDice:0},newDay:!1,rolls:[],updateData:{},updateItems:[]},{});"dhd"in e&&(e.deltas.hitDice=e.dhd),u._getRestHitDiceRecovery({maxHitDice:u.system.attributes.hd.max,type:"long"},e),e.dhd=e.deltas.hitDice,e.longRest=!0;try{if(e.updateData&&Object.keys(e.updateData).length>0){const t=await u.update(e.updateData,{isRest:!1})}else c.log("No actor updates to perform",[]);if(e.updateItems&&e.updateItems.length>0){const t=await u.updateEmbeddedDocuments("Item",e.updateItems,{isRest:!1})}else c.log("No item updates to perform",[])}catch(t){throw c.error("Error during updates in handleHitDieRecovery:",[t]),t}return c.log("handleHitDieRecovery #3",[e]),e}};async function pt(){return game.combat||(await(await Combat.create({scene:game.scenes.active.id})).activate(),j.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.combatCreated"))),game.combat}async function ht(u,e){if(!e.combat)return u;const t=u.map(i=>e.actors.get(i)).filter(i=>i),s=[],o=new Set;for(const i of t)e.combat.getCombatantsByActor(i.id).some(n=>n.initiative!==null)&&(s.push(i.name),o.add(i.id));if(c.log("filterActorsForInitiative",[s]),s.length>0)if(await foundry.applications.api.DialogV2.confirm({window:{title:e.i18n.localize("FLASH_ROLLS.ui.dialogs.rerollInitiativeTitle"),classes:["flash5e-dialog"]},position:{width:420,height:"auto"},content:"<p>"+e.i18n.format("FLASH_ROLLS.ui.dialogs.rerollInitiative",{actors:s.join(", ")})+"</p>",rejectClose:!1,modal:!0})){if(e.user.isGM)for(const a of o){const l=e.combat.getCombatantsByActor(a);c.log("filterActorsForInitiative - resetting initiative for combatants",[l]);for(const n of l)await n.update({initiative:null})}else c.log("filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll");return u}else{const a=u.filter(l=>!o.has(l));return a.length===0&&j.notify("info",e.i18n.localize("FLASH_ROLLS.notifications.allActorsHaveInitiative")),a}return u}class ot{static getActorStats(e){var i,a,l,n,r,d;const t=e.system,s=[];(i=t.attributes)!=null&&i.hp&&s.push({abbrev:"HP",value:t.attributes.hp.value}),(a=t.attributes)!=null&&a.ac&&s.push({abbrev:"AC",value:t.attributes.ac.value});const o=(n=(l=t.attributes)==null?void 0:l.spell)==null?void 0:n.dc;return o&&s.push({abbrev:"DC",value:o}),(d=(r=t.skills)==null?void 0:r.prc)!=null&&d.passive&&s.push({abbrev:"PRC",value:t.skills.prc.passive}),s}static getActorHPData(e){var i;const t=(i=e.system.attributes)==null?void 0:i.hp;if(!t||!t.max)return{hpPercent:100,hpColor:"var(--fr5e-color-hp-high)"};const s=Math.round(t.value/t.max*100),o=s>50?"var(--fr5e-color-hp-high)":"var(--fr5e-color-hp-low)";return{hpPercent:s,hpColor:o}}static getValidActorIds(e,t){return e.filter(s=>{const o=game.actors.get(s);if(!o)return!1;const i=Ge(o),a=!i&&gt(o);return t==="pc"&&i||t==="npc"&&a})}}class Ke{static initialize(){c.log("RollInterceptor.initialize"),game.user.isGM&&this.registerHooks()}static registerHooks(){c.log("RollInterceptor.registerHooks"),this._registerHook(B.PRE_ROLL_ABILITY_CHECK,this._onPreRollIntercept.bind(this,p.ABILITY)),this._registerHook(B.PRE_ROLL_SAVING_THROW,this._onPreRollIntercept.bind(this,p.SAVE)),this._registerHook(B.PRE_ROLL_SKILL_V2,this._onPreRollIntercept.bind(this,p.SKILL)),this._registerHook(B.PRE_ROLL_TOOL_V2,this._onPreRollIntercept.bind(this,p.TOOL)),this._registerHook(B.PRE_ROLL_ATTACK_V2,this._onPreRollIntercept.bind(this,p.ATTACK)),this._registerHook(B.PRE_ROLL_DAMAGE_V2,this._onPreRollIntercept.bind(this,p.DAMAGE)),this._registerHook(B.PRE_ROLL_DEATH_SAVE_V2,this._onPreRollIntercept.bind(this,p.DEATH_SAVE)),this._registerHook(B.PRE_ROLL_HIT_DIE_V2,this._onPreRollIntercept.bind(this,p.HIT_DIE)),this._registerHook(B.PRE_ROLL_INITIATIVE,this._onPreRollInterceptInitiative.bind(this,p.INITIATIVE)),this._registerHook(B.PRE_ROLL_INITIATIVE_DIALOG,this._onPreRollInterceptInitiative.bind(this,p.INITIATIVE))}static _registerHook(e,t){c.log("RollInterceptor._registerHook");const s=Hooks.on(e,t);this.registeredHooks.add({hookName:e,hookId:s})}static unregisterHooks(){c.log("RollInterceptor.unregisterHooks");for(const{hookName:e,hookId:t}of this.registeredHooks)Hooks.off(e,t);this.registeredHooks.clear()}static _onPreRollInterceptInitiative(e,t,s){}static _onPreRollIntercept(e,t,s,o){var R,y,S,m,L,T,I,E;c.log("_onPreRollIntercept #0",[e,t,s,o]);const i=O(),a=A.get(i.rollRequestsEnabled.tag),l=A.get(i.rollInterceptionEnabled.tag),n=A.get(i.skipRollDialog.tag);if(c.log("_onPreRollIntercept #1",[a,l,t.isRollRequest]),!a||!l||t.isRollRequest===!1){s.configure=t.isRollRequest!==void 0?!1:!n;return}if(!game.user.isGM)return;H.isModuleOn(b,"midi-qol");const r=(t==null?void 0:t.hookNames)||(s==null?void 0:s.hookNames)||(o==null?void 0:o.hookNames)||[],d=r.includes("initiativeDialog")||r.includes("initiative");if(e===p.ATTACK||e===p.DAMAGE){const C=((y=(R=t.subject)==null?void 0:R.item)==null?void 0:y.getFlag(b,"tempAttackConfig"))||((m=(S=t.subject)==null?void 0:S.item)==null?void 0:m.getFlag(b,"tempDamageConfig"));if(s.configure=!1,c.log("_onPreRollIntercept - attack / damage - flag",[C]),C){c.log("_onPreRollIntercept - found module flags, skipping interception",[C]);return}}if(d&&e===p.ABILITY&&(c.log("RollInterceptor._onPreRollIntercept - Overriding ability to initiative",[r]),e=p.INITIATIVE),t!=null&&t.isRollRequest||t.sendRequest===!1||s!=null&&s.isRollRequest||o!=null&&o.isRollRequest){c.log("_onPreRollIntercept - skipping interception (roll request)",[t,s,o]);return}let g;if(e===p.INITIATIVE&&t instanceof Actor){if(g=t,c.log("_onPreRollIntercept - Initiative",[t,s,o]),(s==null?void 0:s.isRollRequest)===!1||(o==null?void 0:o.isRollRequest)===!1)return}else e===p.HIT_DIE?g=((L=s==null?void 0:s.subject)==null?void 0:L.actor)||(s==null?void 0:s.subject)||(s==null?void 0:s.actor):e===p.ATTACK||e===p.DAMAGE?g=(T=t.subject)==null?void 0:T.actor:g=((I=t.subject)==null?void 0:I.actor)||t.subject||t.actor;if(!l||!g||g.documentName!=="Actor")return;const f=H.getActorOwner(g);c.log("_onPreRollIntercept - ownership",[f]),!f||!f.active||f.id===game.user.id?(c.log("_onPreRollIntercept - skipping interception (ownership)",[f==null?void 0:f.name,f==null?void 0:f.active]),t.isRollRequest=!1):t.isRollRequest=!0,e===p.ATTACK&&(o={...o,rollMode:CONST.DICE_ROLL_MODES.PUBLIC});const h=t.midiOptions!==null&&t.midiOptions!==void 0;if((E=t.midiOptions)!=null&&E.fastForward&&(t.midiOptions={...t.midiOptions,consume:{spellSlot:!1}}),t.sendRequest===!1||t.skipRollDialog===!0){c.log("_onPreRollIntercept - skipping interception",[s.configure,t.sendRequest]);return}return h&&game.user.isGM?(c.log("_onPreRollIntercept - isMidiActive",[h]),this._showGMConfigDialog(g,f,e,t,s,o),!1):(c.log("_onPreRollIntercept - intercepting roll #1",[t,o]),this._showGMConfigDialog(g,f,e,t,s,o),!1)}static async _handleInitiativePreChecks(e){return!game.combat&&!await pt()?!1:(await ht([e.id],game)).length>0}static _getDialogClass(e){const t=e==null?void 0:e.toLowerCase();return[p.SKILL,p.TOOL].includes(t)?Rt:t===p.HIT_DIE?mt:t===p.ATTACK?Pt:t===p.DAMAGE?Gt:ne}static _extractRollConfiguration(e,t,s,o){var n,r,d,g,f,h,R,y,S,m,L;const i=e==null?void 0:e.toLowerCase();let a=null;const l={rolls:[{parts:[],data:{},options:{}}]};switch(i){case p.SKILL:l.skill=t.skill,l.ability=t.ability||((n=t.subject)==null?void 0:n.ability),a=l.skill;break;case p.TOOL:l.tool=t.tool,l.ability=t.ability||((r=t.subject)==null?void 0:r.ability),a=l.tool;break;case p.ABILITY:case p.SAVE:l.ability=t.ability||((d=t.subject)==null?void 0:d.ability),a=l.ability,l.ability==="con"&&t.targetValue!==void 0&&(e=p.CONCENTRATION);break;case p.CONCENTRATION:l.ability="con",a="con";break;case p.INITIATIVE:case p.INITIATIVE_DIALOG:a=((f=(g=o.system.attributes)==null?void 0:g.init)==null?void 0:f.ability)||"dex";break;case p.HIT_DIE:l.denomination=typeof t=="string"?t:t.denomination||((h=t.subject)==null?void 0:h.denomination),a=l.denomination;break;case p.ATTACK:s!=null&&s.options&&(l.ammunition=s.options.ammunition,l.attackMode=s.options.attackMode,l.mastery=s.options.mastery),a=(y=(R=t.subject)==null?void 0:R.item)==null?void 0:y.id;break;case p.DAMAGE:l.item=(S=t.subject)==null?void 0:S.item,l.subject=t.subject,l.critical=t.critical||{},a=(L=(m=t.subject)==null?void 0:m.item)==null?void 0:L.id;break}return{rollKey:a,rollConfig:l}}static async _getDialogResult(e,t,s,o,i,a,l,n){const r=s==null?void 0:s.toLowerCase();if(c.log("_getDialogResult",[t,s,o,l,n]),i)return{sendRequest:!0,advantage:!1,disadvantage:!1,situational:"",rollMode:game.settings.get("core","rollMode")};if(!e.initConfiguration)throw c.error("DialogClass.initConfiguration not found",[e,e.name]),new Error(`DialogClass ${e.name} does not have initConfiguration method`);const d={skipRollDialog:!1,sendRequest:a&&l.isRollRequest};return r===p.ATTACK||r===p.DAMAGE?await e.initConfiguration([t],r,o,d,l,n):await e.initConfiguration([t],r,o,d)}static async _showGMConfigDialog(e,t,s,o,i,a){c.log("_showGMConfigDialog - config",[s,o]);const l=O(),n=A.get(l.rollRequestsEnabled.tag),r=A.get(l.skipRollDialog.tag);try{if((s==null?void 0:s.toLowerCase())===p.INITIATIVE&&!await this._handleInitiativePreChecks(e))return;const g=this._getDialogClass(s),{rollKey:f,rollConfig:h}=this._extractRollConfiguration(s,o,i,e);c.log("_showGMConfigDialog - rollConfig",[h,f]);const R=await this._getDialogResult(g,e,s,f,r,n,o,i);if(!R){c.log("_showGMConfigDialog - Dialog cancelled");return}if(!R.sendRequest||!n){c.log("_showGMConfigDialog - triggering _executeInterceptedRoll",[s,o,R]),await this._executeInterceptedRoll(e,s,o,R);return}delete o.event;const y={...o,...R,rolls:R.rolls,requestedBy:game.user.name,...s===p.ATTACK&&{chatMessage:!1}};c.log("_showGMConfigDialog - triggering _sendRollRequest",[s,y]),this._sendRollRequest(e,t,s,y)}catch(d){c.error("RollInterceptor._showGMConfigDialog - Error",[d])}}static async _executeInterceptedRoll(e,t,s,o){var f,h,R,y,S,m,L,T,I,E,C,N,k,M;c.log("RollInterceptor._executeInterceptedRoll",[e,t,s,o]);const i=t==null?void 0:t.toLowerCase(),a=((f=o.rolls)==null?void 0:f[0])||{parts:[],data:{},options:{}},l=((h=a.data)==null?void 0:h.situational)||o.situational||"";let n;switch(i){case p.SKILL:n=s.skill;break;case p.TOOL:n=s.tool;break;case p.ABILITY:case p.SAVE:n=s.ability||((R=s.subject)==null?void 0:R.ability);break;case p.HIT_DIE:n=s.denomination;break;default:n=s.ability||s.skill||s.tool||s.denomination}const r={rollKey:n,config:{advantage:o.advantage||s.advantage,disadvantage:o.disadvantage||s.disadvantage,target:o.target||o.dc||s.target,rollMode:o.rollMode||s.rollMode,situational:l,isRollRequest:!1,skipRollDialog:o.skipRollDialog,ability:s.ability}};if(i===p.SKILL&&!r.config.ability)r.config.ability=((S=(y=e.system.skills)==null?void 0:y[r.rollKey])==null?void 0:S.ability)||((L=(m=CONFIG.DND5E.skills)==null?void 0:m[r.rollKey])==null?void 0:L.ability);else if(i===p.TOOL&&!r.config.ability){const U=(T=e.system.tools)==null?void 0:T[r.rollKey];r.config.ability=(U==null?void 0:U.ability)||((C=(E=(I=CONFIG.DND5E.enrichmentLookup)==null?void 0:I.tools)==null?void 0:E[r.rollKey])==null?void 0:C.ability)||"int"}else(i===p.ABILITY||i===p.SAVE)&&!r.config.ability&&(r.config.ability=r.rollKey);c.log("RollInterceptor._executeInterceptedRoll - requestData",[r,s,o]);const d={configure:!1,isRollRequest:!1},g={rollMode:r.config.rollMode,create:!0,isRollRequest:!1};try{const U=p,q=K[i];q?((i===p.ATTACK||i===p.DAMAGE||i===p.SAVE)&&(r.rollKey=(k=(N=s.subject)==null?void 0:N.item)==null?void 0:k.id,r.activityId=(M=s.subject)==null?void 0:M.id,r.config.skipRollDialog=!0),await q(e,r,a,d,g)):c.warn(`No handler found for roll type: ${i}`)}catch(U){c.error("RollInterceptor._executeInterceptedRoll",[U])}}static async _sendRollRequest(e,t,s,o){var h;c.log("_sendRollRequest",[e,t,s,o]),c.log("_sendRollRequest - config.rolls",[o.rolls]);const i=O(),a=A.get(i.skipRollDialog.tag);let l=s==null?void 0:s.toLowerCase();l===p.INITIATIVE&&(l=p.INITIATIVE_DIALOG);let n=null,r=null;switch(l){case p.ABILITY:case p.SAVE:n=o.ability;break;case p.SKILL:n=o.skill;break;case p.TOOL:n=o.tool;break;case p.ATTACK:case p.DAMAGE:c.log("_sendRollRequest - Attack/Damage roll config",[s,o]),n=(h=o.subject.item)==null?void 0:h.id,r=o.subject.id;break;case p.HIT_DIE:n=typeof o=="string"?o:o.denomination;break;case p.INITIATIVE_DIALOG:case p.INITIATIVE:n=null;break;case p.DEATH_SAVE:n=null;break;default:c.warn(`Unknown roll type: ${s}`);return}const d={...o};d.midiOptions&&d.activity&&d.activity.type===ae.DAMAGE&&(c.log("_sendRollRequest - Damage activity",[d]),d.midiOptions={...d.midiOptions,workflowOptions:{...d.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1,fastForwardDamage:!1}}),delete d.subject,delete d.workflow,delete d.item,delete d.activity;const g={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:e.id,rollType:l,rollKey:n,activityId:r,rollProcessConfig:{...d,_requestedBy:game.user.name},skipRollDialog:a,targetTokenIds:Array.from(game.user.targets).map(R=>R.id),preserveTargets:A.get(i.useGMTargetTokens.tag)};if(c.log("_sendRollRequest - requestData",[t,g]),!t||!t.active||t.id===game.user.id){c.log("_sendRollRequest - No valid active owner, executing locally",[t==null?void 0:t.name,t==null?void 0:t.active]),await this._executeInterceptedRoll(e,s,o,o);return}await Ue.handleOfflinePlayer(t,e,s,o,{...o,sendRequest:!1})||(le.execForUser("handleRollRequest",t.id,g),ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:(t==null?void 0:t.name)||"Unknown",actor:e.name||"Unknown"})))}}D(Ke,"registeredHooks",new Set);class Ue{static async handleOfflinePlayer(e,t,s,o,i=null){if(c.log("OfflinePlayerUtil.handleOfflinePlayer",[e==null?void 0:e.name,t==null?void 0:t.name,s]),!e||!o)return ui.notifications.warn("Flash Rolls: No owner found for actor "+t.name),!0;if(!e.active){const a=O();return A.get(a.showOfflineNotifications.tag)&&ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:e.name})),await Ke._executeInterceptedRoll(t,s,o,i||{...o,sendRequest:!1}),setTimeout(()=>{var n,r,d;if((n=o.subject)!=null&&n.item){const g=(d=(r=game.modules.get("flash-rolls-5e"))==null?void 0:r.api)==null?void 0:d.GeneralUtil;g&&g.removeTemplateForItem(o.subject.item)}},3e3),!0}return!1}static categorizeActorsByOnlineStatus(e){const t=[],s=[],o=new Map;for(const{actor:i,owner:a}of e)o.has(i.id)||o.set(i.id,{actor:i,owners:[]}),o.get(i.id).owners.push(a);for(const{actor:i,owners:a}of o.values()){const l=a.find(n=>n.active&&!n.isGM);l?t.push({actor:i,owner:l}):s.push(i)}return{onlinePlayerActors:t,offlinePlayerActors:s}}static async processOfflineActors(e,t,s,o){c.log("OfflinePlayerUtil.processOfflineActors",[e.map(i=>i.name),t,s]);for(const i of e){const a=i.ownership||{};let l=null;for(const[h,R]of Object.entries(a))if(R>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER&&h!=="default"){const y=game.users.get(h);if(y&&!y.isGM){l=y;break}}if(!l){c.warn("OfflinePlayerUtil.processOfflineActors - No owner found for actor",[i.name]);continue}const n={rollKey:s,groupRollId:o.groupRollId,config:{...o,...t==="ability"||t==="abilitycheck"||t==="save"||t==="savingthrow"?{ability:s}:{},sendRequest:!1,isGroupRoll:!!o.groupRollId}},r={parts:[],data:o.situational?{situational:o.situational}:{},options:o.dc?{target:o.dc}:{}},d={configure:!1,isRollRequest:!0},g={rollMode:o.rollMode||game.settings.get("core","rollMode"),create:!0,isRollRequest:!0,groupRollId:o.groupRollId},f=K[t.toLowerCase()];f&&await f(i,n,r,d,g),await new Promise(h=>setTimeout(h,200))}}}class Re{static async orchestrateRollsForActors(e,t,s,o,i,a,l){const n=O(),r=[],d=[],g=[];let f=foundry.utils.randomID();c.log("RollMenuOrchestrationUtil.orchestrateRollsForActors",["config.sendRequest:",e.sendRequest,"pcActors:",t.map(m=>{var L;return`${m.actor.name}(${(L=m.owner)==null?void 0:L.name})`}),"npcActors:",s.map(m=>m.name)]);const h=[],R=[];if(e.sendRequest){const{onlinePlayerActors:m,offlinePlayerActors:L}=Ue.categorizeActorsByOnlineStatus(t);if(g.push(...m),d.push(...L),L.length>0){const T=O();A.get(T.showOfflineNotifications.tag)&&L.forEach(I=>{var C;const E=(C=t.find(N=>N.actor.id===I.id))==null?void 0:C.owner;E&&j.notify("info",game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:E.name}))})}R.push(...g.map(({actor:T})=>T))}else s.push(...t.map(({actor:m})=>m));R.push(...d,...s);const y=R.map(m=>m.id);h.push(...a.filter(m=>m&&m.actor&&y.includes(m.actor.id)));const S=A.get(n.groupRollsMsgEnabled.tag);if(S&&R.length>1&&(await $.createGroupRollMessage(h,o,i,e,f),await Me(100)),d.length>0&&(e.skipRollDialog=!0,e.groupRollId=f,await Ue.processOfflineActors(d,o,i,e)),o===p.HIT_DIE){const m=[];if(g.forEach(({actor:T})=>m.push(T)),d.forEach(T=>m.push(T)),s.forEach(T=>m.push(T)),!await this.handleHitDieRefill(m))return}for(const{actor:m,owner:L}of g){const T=S&&R.length>1?f:null;let I=i;o===p.HIT_DIE&&(I=m.system.attributes.hd.largestAvailable,!I)||(await this.sendRollRequestToPlayer(m,L,o,I,e,!0,T),r.push({actor:m,owner:L}),await Me(250))}if(r.length>0&&this.showConsolidatedNotification(r,o,i),s.length>0){e.skipRollDialog=!0,e.groupRollId=S&&R.length>1?f:null;const m=s.map(T=>T.id),L=a.filter(T=>T&&T.actor&&m.includes(T.actor.id));await l._handleGMRollsWithTokens(L,o,i,e)}}static async handleHitDieRefill(e){const s=(Array.isArray(e)?e:[e]).filter(a=>a.system.attributes.hd.value===0);if(s.length===0)return!0;const o=s.map(a=>a.name).join(", ");if(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessage",{actors:o})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){for(const a of s)try{const l=await K.handleHitDieRecovery(a);if(a.isToken&&a._actor)try{await K.handleHitDieRecovery(a._actor)}catch(n){c.error("Error updating base actor:",[n])}}catch(l){c.error("Error calling handleHitDieRecovery:",[l])}return j.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:o})||`Hit dice refilled for ${o}`),!0}return!1}static async triggerRoll(e,t,s,o={}){var S;const i=O(),a=Array.from(s.selectedActors),l=o.skipRollDialog!==void 0?o.skipRollDialog:A.get(i.skipRollDialog.tag);let n=a.map(m=>{const L=Q(m);if(!L)return null;let T=null;return game.actors.get(m)?T=null:T=m,{actor:L,uniqueId:m,tokenId:T}}).filter(m=>m),r=n.map(m=>m.actor);const d=V.ROLL_REQUEST_OPTIONS[e],g=(S=(d==null?void 0:d.name)||e)==null?void 0:S.toLowerCase(),f=t;if(t=await this.handleSpecialRollTypes(g,t,a,n,r,s),t===null&&f!==null)return;if(!r.length){j.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}const{pcActors:h,npcActors:R}=Mt(r),y=await it.getRollConfiguration(r,g,t,l,h,o);y&&(await this.orchestrateRollsForActors(y,h,R,g,t,n,s),!s.isLocked&&typeof s.close=="function"&&setTimeout(()=>s.close(),500))}static async handleSpecialRollTypes(e,t,s,o,i,a){const l=O();switch(e){case p.CUSTOM:if(t=await it.handleCustomRoll(),!t)return null;break;case p.INITIATIVE:case p.INITIATIVE_DIALOG:if(!(await this.handleInitiativeRoll(s,o,i)).success)return null;A.get(l.initiateCombatOnRequest.tag)&&game.combat.startCombat();break;case p.DEATH_SAVE:const d=await wt(i);i.length=0,i.push(...d),o=o.filter(f=>d.includes(f.actor));break;case p.HIT_DIE:const g=i.filter(f=>f.type==="character");if(g.length===0)return j.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noCharactersForHitDie")||"Hit dice can only be rolled for player characters, not NPCs."),null;i.length=0,i.push(...g),o=o.filter(f=>f.actor.type==="character");break}return t}static async handleInitiativeRoll(e,t,s){var g,f;if(!await pt())return{success:!1};const i=[],a=[];for(const h of e){const R=Q(h);if(!R)continue;let y=null;if(!game.actors.get(h))y=h,a.push(R.name);else{if(y=((f=(g=R.getActiveTokens())==null?void 0:g[0])==null?void 0:f.id)||null,!y){i.push(R.name);continue}a.push(R.name),game.combat.combatants.find(m=>m.tokenId===y)||await game.combat.createEmbeddedDocuments("Combatant",[{actorId:R.id,tokenId:y}])}}if(a.length===0)return{success:!1};i.length>0&&ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.actorsSkippedInitiative",{actors:i.join(", ")})||`Initiative skipped for actors without tokens: ${i.join(", ")}`);const l=t.filter(h=>{var y;return h.tokenId?!0:!!((y=h.actor.getActiveTokens())==null?void 0:y[0])});t.length=0,t.push(...l),s=l.map(h=>h.actor);const n=[...new Set(s.map(h=>h.id))],r=await ht(n,game);if(!r.length)return{success:!1};const d=t.filter(h=>h&&h.actor&&r.includes(h.actor.id));return s.length=0,s.push(...r.map(h=>game.actors.get(h)).filter(h=>h)),t.length=0,t.push(...d),{success:!0}}static async sendRollRequestToPlayer(e,t,s,o,i,a=!1,l=null){var h;const n=O();let r=s==null?void 0:s.toLowerCase();if(r===p.ABILITY_CHECK?r=p.ABILITY:r===p.SAVING_THROW?r=p.SAVE:r===p.INITIATIVE_DIALOG&&(r=p.INITIATIVE),r===p.HIT_DIE&&(o=e.system.attributes.hd.largestAvailable,!o)){c.warn(`No hit dice available for ${e.name}.`);return}const d={...i};delete d.subject,delete d.workflow,delete d.item,delete d.activity;const g=A.get(n.publicPlayerRolls.tag)===!0;A.get(n.groupRollsMsgEnabled.tag),g&&(d.rollMode=CONST.DICE_ROLL_MODES.PUBLIC);const f={type:"rollRequest",groupRollId:l||foundry.utils.randomID(),actorId:e.isToken?e.token.id:e.id,isTokenActor:e.isToken,baseActorId:e.isToken?(h=e._actor)==null?void 0:h.id:e.id,rollType:r,rollKey:o,activityId:null,rollProcessConfig:{...d,_requestedBy:game.user.name},skipRollDialog:!1,targetTokenIds:Array.from(game.user.targets).map(R=>R.id),preserveTargets:A.get(n.useGMTargetTokens.tag)};c.log("RollMenuOrchestrationUtil.sendRollRequestToPlayer - sending request",[]),le.execForUser("handleRollRequest",t.id,f),a||j.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:t.name,actor:e.name}))}static showConsolidatedNotification(e,t,s){var a,l,n,r,d;const o={};for(const{actor:g,owner:f}of e)o[f.id]||(o[f.id]={player:f,actors:[]}),o[f.id].actors.push(g);let i=game.i18n.localize(`FLASH_ROLLS.rollTypes.${t}`)||t;if(s){const g=t.toLowerCase();if(g===p.SKILL)i=`${i} (${((a=CONFIG.DND5E.skills[s])==null?void 0:a.label)||s})`;else if(g===p.SAVING_THROW)i=`${i} (${((l=CONFIG.DND5E.abilities[s])==null?void 0:l.label)||s})`;else if(g===p.ABILITY_CHECK)i=`${i} (${((n=CONFIG.DND5E.abilities[s])==null?void 0:n.label)||s})`;else if(g===p.TOOL){const f=(d=(r=CONFIG.DND5E.enrichmentLookup)==null?void 0:r.tools)==null?void 0:d[s];if(f!=null&&f.id){const h=dnd5e.documents.Trait.getBaseItem(f.id,{indexOnly:!0});i=`${i} (${(h==null?void 0:h.name)||s})`}else i=`${i} (${s})`}else g===p.CUSTOM&&(i=`${i}: ${s}`)}j.notifyRollRequestsSent(o,i)}}class Ve{static async requestRoll(e={}){try{if(!e||typeof e!="object"){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidMacroData"));return}const{requestType:t,rollKey:s=null,actorIds:o=[],dc:i,situationalBonus:a,advantage:l,disadvantage:n,skipRollDialog:r,sendAsRequest:d=!0}=e;if(!t){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.missingRequestType"));return}const g={dc:i,situationalBonus:a,advantage:l,disadvantage:n,skipRollDialog:r,sendAsRequest:d};c.log("FlashRollsAPI.requestRoll",[t,s,o,g]);let f=V.ROLL_REQUEST_OPTIONS[t];if(f||(f=Object.values(V.ROLL_REQUEST_OPTIONS).find(L=>L.name===t)),!f){ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.unknownRequestType",{requestType:t}));return}const h=f.name;if(o.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noActorsSelected"));return}if(!Array.isArray(o)){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.invalidActorIdsFormat"));return}const R=[],y=[];for(const m of o){const L=Q(m);if(!L){R.push(m);continue}let T=null;game.actors.get(m)||(T=m),y.push({actor:L,uniqueId:m,tokenId:T})}if(R.length>0){const m=R.join(", ");ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.invalidActorIds",{numIds:R.length,invalidIds:m}))}if(y.length===0){ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.noValidActorsSelected"));return}const S={selectedActors:new Set(o),selectedRequestType:t,isLocked:!0,close:()=>{}};return Re.triggerRoll(h,s,S,g)}catch(t){c.error("FlashRollsAPI.requestRoll - Execution error:",[t]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.macroExecutionFailed"));return}}static getAvailableRollTypes(){const e={};for(const[t,s]of Object.entries(V.ROLL_REQUEST_OPTIONS))e[t]={name:s.name,label:s.label};return e}static getSelectedActors(){const e=Z.getInstance();return e&&e.selectedActors?Array.from(e.selectedActors):[]}static isMenuOpen(){const e=Z.getInstance();return e&&e.rendered}static async createMacro(e){const t=O(),s=A.get(t.addMacrosToFolder.tag);c.log("FlashRollsAPI.createMacro",[e]);const{requestType:o,rollKey:i=null,actorIds:a=[],config:l={}}=e;let n=V.ROLL_REQUEST_OPTIONS[o];if(n||(n=Object.values(V.ROLL_REQUEST_OPTIONS).find(S=>S.name===o)),!n){ui.notifications.warn(`Unknown request type: ${o}`);return}let r=n.label;if(c.log("FlashRollsAPI.createMacro",[r,n.subList]),i&&n.subList&&Array.isArray(n.subList)){const y=n.subList.find(S=>S.id===i);y&&(r=y.name)}else i&&(r=Dt(n.name,i));const d={requestType:n.name,...i&&{rollKey:i},...a.length>0&&{actorIds:a},...l};d.advantage===void 0&&(d.advantage=!1),d.disadvantage===void 0&&(d.disadvantage=!1);const g=`// Flash Rolls: ${r} - ${i||""}
try {
  FlashRolls5e.requestRoll(${JSON.stringify(d,null,2)});
} catch (error) {
  ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.macroDataMalformed"));
}`;let f=null;s&&(f=await this._ensureFlashRollsFolder());const h={name:`Flash Rolls: ${r}`,type:"script",command:g,img:"modules/flash-rolls-5e/assets/bolt-circle.svg",...f&&{folder:f},flags:{"flash-rolls-5e":{requestType:o,rollKey:i,actorIds:a,config:l}}},R=await Macro.create(h);return ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.macroCreated",{macroName:R.name})),R.sheet.render(!0),R}static async _ensureFlashRollsFolder(){const e="Flash Rolls";let t=game.folders.find(s=>s.type==="Macro"&&s.name===e);if(!t)try{t=await Folder.create({name:e,type:"Macro",color:"#302437",sort:0}),c.log("Created Flash Rolls macro folder",[t])}catch(s){return c.error("Failed to create Flash Rolls macro folder:",[s]),ui.notifications.warn("Failed to create Flash Rolls macro folder. Macro will be created without folder organization."),null}return(t==null?void 0:t.id)||null}static calculateGroupRoll(e={}){const{rollResults:t,dc:s,rollType:o,rollKey:i}=e;let{method:a,actors:l}=e;const n={"standard rule":1,"group average":2,"leader with help":3,"weakest link":4};if(typeof a=="string"){const d=a.toLowerCase();if(a=n[d],!a)return ui.notifications.error(`Invalid method name: "${e.method}". Valid options: "Standard Rule", "Group Average", "Leader with Help", "Weakest Link", or numbers 1-4`),null}if(!a||![1,2,3,4].includes(a))return ui.notifications.error("Method must be 1-4 or valid method name: 'Standard Rule', 'Group Average', 'Leader with Help', 'Weakest Link'"),null;if(!Array.isArray(t)||t.length===0)return ui.notifications.error("rollResults must be a non-empty array"),null;if(typeof s!="number"||s<0)return ui.notifications.error("dc must be a positive number"),null;const r=[];for(let d=0;d<t.length;d++){const g=t[d];if(!g.hasOwnProperty("total")||typeof g.total!="number")return ui.notifications.error(`rollResults[${d}] must have a 'total' property with a numeric value`),null;if(!g.actorId)return ui.notifications.error(`rollResults[${d}] must have an 'actorId' property`),null;let f=g.actorName;if(!f){const h=Q(g.actorId);f=(h==null?void 0:h.name)||g.actorId}r.push({...g,actorName:f,passed:g.total>=s})}if([3,4].includes(a)){if(!o)return ui.notifications.error("rollType is required for Leader with Help and Weakest Link methods"),null;if(!i)return ui.notifications.error("rollKey is required for Leader with Help and Weakest Link methods"),null;if(!Array.isArray(l)||l.length===0){l=[];for(const d of r){const g=Q(d.actorId);g&&l.push(g)}if(l.length===0)return ui.notifications.error("No valid actors could be resolved from the rollResults for Leader with Help and Weakest Link methods"),null}}try{let d,g;switch(a){case 1:return d=_.calculateStandardRule(t,s),g="Standard Rule",{success:d.finalResult,result:d.finalResult?1:0,details:d,method:g,actorResults:r};case 2:return d=_.calculateGroupAverage(t,s),g="Group Average",{success:d.success,result:d.finalResult,details:d,method:g,actorResults:r};case 3:d=_.calculateLeaderWithHelp(t,s,l,o,i),g="Leader with Help";const f=r.map(R=>({...R,isLeadRoll:R.actorId===d.leaderActorId}));return{success:d.success,result:d.finalResult,details:d,method:g,actorResults:f};case 4:d=_.calculateWeakestLink(t,s,l,o,i),g="Weakest Link";const h=r.map(R=>({...R,isLeadRoll:R.actorId===d.weakestActorId}));return{success:d.success,result:d.finalResult,details:d,method:g,actorResults:h};default:return ui.notifications.error(`Invalid calculation method: ${a}`),null}}catch(d){return c.error("FlashRollsAPI.calculateGroupRoll - Error:",[d]),ui.notifications.error(`Error calculating group roll: ${d.message}`),null}}}Hooks.once(w.READY,()=>{dnd5e.applications.dice.DamageRollConfigurationDialog||c.warn("DamageRollConfigurationDialog not found in dnd5e.applications.dice")});function Oe(u){return class extends u{constructor(e={},t={},s={}){var o,i;super(e,t,s),this.actors=s.actors||[],this.sendRequest=s.sendRequest??s.sendRequest??!0,this.showDC=s.showDC||!1,this.dcValue=s.dcValue||null,this.rollKey=s.rollKey||e.skill||e.ability||null,this.rollTypeString=s.rollTypeString||null,this.windowTitle=((o=s.window)==null?void 0:o.title)||"",this.windowSubtitle=((i=s.window)==null?void 0:i.subtitle)||""}_buildConfig(e,t,s){const o=t==null?void 0:t.get("ability"),i=t==null?void 0:t.get("dc"),a=t==null?void 0:t.get(`rolls.${s}.situational`);if(c.log("_buildConfig",[a,t,e]),a)e.parts||(e.parts=[]),e.parts.push("@situational"),e.data||(e.data={}),e.data.situational=a;else if(e.parts){const n=e.parts.indexOf("@situational");n!==-1&&e.parts.splice(n,1)}o&&(e.ability=o,this.config.ability=o);const l=super._buildConfig(e,t,s);if(i){const n=parseInt(i);isNaN(n)||(l.options=l.options||{},l.options.target=n)}else this.dcValue!==void 0&&this.dcValue!==null&&(l.options=l.options||{},l.options.target=this.dcValue);return c.log(`${this.constructor.name}._buildConfig`,[this.config,t,l]),l}_onChangeForm(e,t){c.log("_onChangeForm",[t.target.value]),super._onChangeForm(e,t);const s=this.element.querySelector('input[name="flash5e-send-request"]');s&&(this.sendRequest=s.checked);const o=this.element.querySelector('input[name="dc"]');o&&o.value&&(this.dcValue=parseInt(o.value)||null)}_finalizeRolls(e){const t=super._finalizeRolls(e);if(c.log("_finalizeRolls #1",[t,this.sendRequest]),this.dcValue!==void 0&&this.dcValue!==null)for(const s of t)s.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,this.config.skipRollDialog=this.sendRequest?this.config.skipRollDialog||!1:!0,t}async _onCreateMacroClick(e){var d;if(e.preventDefault(),e.stopPropagation(),c.log("_onCreateMacroClick",[this]),!this.rollTypeString){ui.notifications.error("Cannot create macro: roll type not defined");return}const t=new FormDataExtended(this.form),s=t.get("roll.0.situational")||t.get("rolls.0.situational")||"",o=t.get("dc"),i=t.get("flash5e-send-request"),a=t.get("rollMode")||game.settings.get("core","rollMode"),l=t.get("ability"),n=((d=this.actors)==null?void 0:d.map(g=>g.id))||[],r={requestType:this.rollTypeString,rollKey:this.rollKey,actorIds:n,config:{...s&&{situationalBonus:s},...o&&{dc:parseInt(o)},...a!==game.settings.get("core","rollMode")&&{rollMode:a},...l&&{ability:l},sendAsRequest:!!i,skipRollDialog:!0,advantage:!1,disadvantage:!1}};try{await Ve.createMacro(r),this.close()}catch(g){c.error("Failed to create macro:",[g]),ui.notifications.error(`Failed to create macro: ${g.message}`)}}async _onRender(e,t){var s,o,i;await super._onRender(e,t),((i=(o=(s=this.config.rolls)==null?void 0:s[0])==null?void 0:o.data)!=null&&i.situational||this.config.situational)&&(c.log(`${this.constructor.name}._onRender`,["Triggering rebuild for initial situational bonus"]),setTimeout(()=>{this.rebuild()},100))}}}class ne extends Oe(dnd5e.applications.dice.D20RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(e,t,s),c.log("constructor - initializing GM Dialog",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}get title(){return this.windowTitle||super.title}_prepareConfigurationData(e,t,s,o){c.log("_prepareConfigurationData",[e,t,s,o]);const i=super._prepareConfigurationData(e,t,s,o);return i.showDC=this.showDC,i.dcValue=this.dcValue,i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(e,t,s){return c.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(c.log("_onRender",[e,t]),super._onRender(e,t),H.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},i=await H.renderTemplate(`modules/${b}/templates/gm-roll-config-fields.hbs`,o),a=document.createElement("div");a.className="gm-roll-config-fields",a.innerHTML=i,s.parentNode.insertBefore(a,s)}this._attachButtonListeners()}_attachButtonListeners(){c.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,s,o={}){var L,T,I,E,C,N,k,M,U;if(e=_.validateActors(e),!e)return null;const i=e[0];c.log("GMRollConfigDialog, initConfiguration",[]);const a=t==null?void 0:t.toLowerCase(),l=O(),n=A.get(l.publicPlayerRolls.tag)===!0,r=_.determineRollMode(n),d=_.shouldShowDC(a),g=_.getRollClass(a),f=_.createBaseRollConfig(i,t,s),h=_.createMessageConfig(i,r),R={options:{actors:e,sendRequest:e.some(q=>_.isPlayerOwned(q)),showDC:d,rollKey:s,rollType:g,rollTypeString:a,window:{title:ne._getRollTitle(a,s,i),subtitle:ne._getSubtitle(e)},position:{width:420,height:"auto"},...o}},y=await _.triggerRollDialog(this,f,h,R.options),S=_.processDialogResult(y,e,t,s,o);if(!S)return null;if((L=y.config)!=null&&L.ability&&[p.SKILL,p.TOOL].includes(a)){const q=((I=(T=i.system.skills)==null?void 0:T[s])==null?void 0:I.ability)||((C=(E=CONFIG.DND5E.skills)==null?void 0:E[s])==null?void 0:C.ability);y.config.ability!==q&&(S.ability=y.config.ability)}let m=R.options.window.title;if(y.config.ability&&[p.SKILL,p.TOOL].includes(a)){const q=((N=CONFIG.DND5E.abilities[y.config.ability])==null?void 0:N.label)||y.config.ability;if(a===p.SKILL){const Y=((k=CONFIG.DND5E.skills[s])==null?void 0:k.label)||s;m=game.i18n.format("DND5E.SkillPromptTitle",{skill:Y,ability:q})}else if(a===p.TOOL){const Y=(U=(M=CONFIG.DND5E.enrichmentLookup)==null?void 0:M.tools)==null?void 0:U[s];let ie=s;if(Y!=null&&Y.id){const X=dnd5e.documents.Trait.getBaseItem(Y.id,{indexOnly:!0});ie=(X==null?void 0:X.name)||s}m=game.i18n.format("DND5E.ToolPromptTitle",{tool:ie,ability:q})}}return S.rollTitle=m,S.rollType=a,S.rollKey=s,S}static _getRollTitle(e,t,s){var a,l,n,r,d,g,f,h,R,y,S,m,L;let o="";const i=e==null?void 0:e.toLowerCase();switch([p.SAVE,p.ABILITY,p.ABILITY_CHECK].includes(i)&&!t&&c.warn("Missing rollKey for roll type",[i,t]),i){case p.SKILL:const T=((a=CONFIG.DND5E.skills[t])==null?void 0:a.label)||t,I=(l=s==null?void 0:s.system.skills)==null?void 0:l[t],E=(I==null?void 0:I.ability)||((n=CONFIG.DND5E.skills[t])==null?void 0:n.ability)||"int",C=((r=CONFIG.DND5E.abilities[E])==null?void 0:r.label)||E;o=game.i18n.format("DND5E.SkillPromptTitle",{skill:T,ability:C});break;case p.SAVE:case p.SAVING_THROW:const N=((d=CONFIG.DND5E.abilities[t])==null?void 0:d.label)||t;o=game.i18n.format("DND5E.SavePromptTitle",{ability:N});break;case p.ABILITY:case p.ABILITY_CHECK:const k=((g=CONFIG.DND5E.abilities[t])==null?void 0:g.label)||t;o=game.i18n.format("DND5E.AbilityPromptTitle",{ability:k});break;case p.CONCENTRATION:o=game.i18n.localize("DND5E.Concentration");break;case p.TOOL:const M=(h=(f=CONFIG.DND5E.enrichmentLookup)==null?void 0:f.tools)==null?void 0:h[t];let U=t;if(M!=null&&M.id){const X=dnd5e.documents.Trait.getBaseItem(M.id,{indexOnly:!0});U=(X==null?void 0:X.name)||t}const q=(R=s==null?void 0:s.system.tools)==null?void 0:R[t],Y=(q==null?void 0:q.ability)||((m=(S=(y=CONFIG.DND5E.enrichmentLookup)==null?void 0:y.tools)==null?void 0:S[t])==null?void 0:m.ability)||"int",ie=((L=CONFIG.DND5E.abilities[Y])==null?void 0:L.label)||Y;o=game.i18n.format("DND5E.ToolPromptTitle",{tool:U,ability:ie});break;case p.DEATH_SAVE:o=game.i18n.localize("DND5E.DeathSave");break;case p.INITIATIVE:case p.INITIATIVE_DIALOG:o=game.i18n.localize("DND5E.Initiative");break;default:o=game.i18n.localize("DND5E.Roll")}return c.log("_getRollTitle",[i,o]),o}static _getSubtitle(e=[]){return e.length===1?e[0].name:e.length>1?game.i18n.localize("FLASH_ROLLS.ui.dialogs.multipleActors"):""}}class mt extends Oe(dnd5e.applications.dice.RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=CONFIG.Dice.BasicRoll||Roll,s.showDC=!1,super(e,t,s),c.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config","hit-die-config"]})}_prepareConfigurationData(e,t,s,o){const i=super._prepareConfigurationData(e,t,s,o);return c.log("GMHitDieConfigDialog._prepareConfigurationData",[i]),i.formula="Hit Die (varies by actor)",i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length,t.formula="Hit Die (varies by actor)"),t}async _onRender(e,t){if(super._onRender(e,t),H.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},i=await H.renderTemplate(`modules/${b}/templates/gm-roll-config-fields.hbs`,o),a=document.createElement("div");a.className="gm-roll-config-fields",a.innerHTML=i,s.parentNode.insertBefore(a,s)}this._attachButtonListeners()}_attachButtonListeners(){c.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}async _processSubmitData(e,t,s){await super._processSubmitData(e,t,s),this.sendRequest=s.get("flash5e-send-request")!=="false",c.log("_processSubmitData",[s,this.config])}_finalizeRolls(e){const t=super._finalizeRolls(e);return this.config.sendRequest=this.sendRequest,t}static async initConfiguration(e,t,s,o={}){var R;if(e=_.validateActors(e),!e)return null;const i=e[0];c.log("GMHitDieConfigDialog, initConfiguration",[]);const a=O(),l=A.get(a.publicPlayerRolls.tag)===!0,n=_.determineRollMode(l),r={data:i.getRollData(),subject:i,rolls:[{parts:[],data:i.getRollData(),options:{flavor:"Hit Die Roll"}}]},d=_.createMessageConfig(i,n),g={options:{actors:e,sendRequest:e.some(y=>_.isPlayerOwned(y)),rollKey:s,rollType:CONFIG.Dice.BasicRoll||Roll,window:{title:game.i18n.localize("DND5E.HitDice"),subtitle:ne._getSubtitle(e)},position:{width:420,height:"auto"},...o}},f=await _.triggerRollDialog(this,r,d,g.options);if(!(f!=null&&f.rolls)||f.rolls.length===0)return null;c.log("GMHitDieConfigDialog - dialog result",[f.rolls]);const h=_.processDialogResult(f,e,t,s,o);return h?((R=f.config)!=null&&R.ability&&(h.ability=f.config.ability),h):null}}class Rt extends Oe(dnd5e.applications.dice.SkillToolRollConfigurationDialog){constructor(e={},t={},s={}){const o=foundry.utils.mergeObject(e,{chooseAbility:!0});s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(o,t,s),c.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){c.log("_prepareConfigurationData",[e,t,s,o]);const i=super._prepareConfigurationData(e,t,s,o);return i.showDC=this.showDC,i.dcValue=this.dcValue,i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(e,t,s){return c.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(c.log("_onRender",[e,t]),super._onRender(e,t),H.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!0},i=await H.renderTemplate(`modules/${b}/templates/gm-roll-config-fields.hbs`,o),a=document.createElement("div");a.className="gm-roll-config-fields",a.innerHTML=i,s.parentNode.insertBefore(a,s)}this._attachButtonListeners()}_attachButtonListeners(){c.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,s,o={}){var L,T,I,E,C,N;if(e=_.validateActors(e),!e)return null;const i=e[0];c.log("GMSkillToolConfigDialog, initConfiguration",[]);const a=t==null?void 0:t.toLowerCase(),l=O(),n=A.get(l.publicPlayerRolls.tag)===!0,r=_.determineRollMode(n),d=_.shouldShowDC(a),g=CONFIG.Dice.D20Roll;let f=null;if(a===p.SKILL){const k=i.system.skills[s];f=(k==null?void 0:k.ability)||((L=CONFIG.DND5E.skills[s])==null?void 0:L.ability)||"int"}else if(a===p.TOOL){const k=(T=i.system.tools)==null?void 0:T[s];f=(k==null?void 0:k.ability)||((C=(E=(I=CONFIG.DND5E.enrichmentLookup)==null?void 0:I.tools)==null?void 0:E[s])==null?void 0:C.ability)||"int"}const h={data:i.getRollData(),subject:i,ability:f,chooseAbility:!0,rolls:[{parts:[],data:i.getRollData(),options:{}}]};a===p.SKILL?h.skill=s:a===p.TOOL&&(h.tool=s);const R=_.createMessageConfig(i,r),y={options:{actors:e,sendRequest:e.some(k=>_.isPlayerOwned(k)),showDC:d,rollKey:s,rollType:g,rollTypeString:a,window:{title:ne._getRollTitle(a,s,i),subtitle:ne._getSubtitle(e)},position:{width:420,height:"auto"},...o}},S=await _.triggerRollDialog(this,h,R,y.options),m=_.processDialogResult(S,e,t,s,o);return m?((N=S.config)!=null&&N.ability&&[p.SKILL,p.TOOL].includes(a)&&(m.ability=S.config.ability),m.rollTitle=y.options.window.title,m.rollType=a,m.rollKey=s,m):null}}class Gt extends Oe(dnd5e.applications.dice.DamageRollConfigurationDialog){constructor(e={},t={},s={}){const o=foundry.utils.mergeObject({configure:!0},e);super(o,t,s),c.log("GMDamageConfigDialog.constructor",[o,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","damage-roll","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){c.log("GMDamageConfigDialog._prepareConfigurationData",[e,t,s,o]);const i=super._prepareConfigurationData(e,t,s,o);return i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _onRender(e,t){if(await super._onRender(e,t),H.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields")||(H.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields")))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!1},i=await H.renderTemplate(`modules/${b}/templates/gm-roll-config-fields.hbs`,o),a=document.createElement("div");a.className="gm-roll-config-fields",a.innerHTML=i,s.parentNode.insertBefore(a,s)}this._attachButtonListeners()}_attachButtonListeners(){c.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}static async initConfiguration(e,t,s,o={},i={},a={}){var q,Y,ie,X,Le,be;if(e=_.validateActors(e),c.log("GMDamageConfigDialog, initConfiguration actors",[e]),!e)return null;const l=e[0],n=(q=i.subject)==null?void 0:q.item,r=l.items.get(s),d=(r==null?void 0:r.id)||(n==null?void 0:n.id);let g={};d&&(g=Ce.activityConfigCache.get(d)||{}),c.log("GMDamageConfigDialog - retrieved activity config from cache",[d,g]);const f=O(),h=A.get(f.publicPlayerRolls.tag)===!0,R=_.determineRollMode(h,i.rollMode),y=t==null?void 0:t.toLowerCase(),S={subject:i.subject||l,data:l.getRollData(),critical:i.critical||{},rolls:i.rolls||[{parts:[],data:l.getRollData(),options:{}}]};c.log("GMDamageConfigDialog, initConfiguration #1",[S]);const m=_.createMessageConfig(l,R);c.log("GMDamageConfigDialog, initConfiguration #2",[m]);const{position:L,...T}=(a==null?void 0:a.options)||{},I={options:{actors:e,sendRequest:e.some(_e=>_.isPlayerOwned(_e)),rollKey:s,rollType:CONFIG.Dice.DamageRoll,rollTypeString:y,window:{title:game.i18n.localize("DND5E.DamageRoll"),subtitle:ne._getSubtitle(e)},...T,...o}},E=await _.triggerRollDialog(this,S,m,I.options);if(!(E!=null&&E.rolls)||E.rolls.length===0)return null;const C=E.rolls[0],N=((Y=C==null?void 0:C.data)==null?void 0:Y.situational)||"",k=(ie=C==null?void 0:C.options)==null?void 0:ie.target,M={rolls:[{parts:[],data:N?{situational:N}:{},options:{...k&&{target:k},isCritical:((X=C==null?void 0:C.options)==null?void 0:X.isCritical)||(C==null?void 0:C.isCritical)||!1}}],subject:i.subject||l,target:k,isCritical:((Le=C==null?void 0:C.options)==null?void 0:Le.isCritical)||(C==null?void 0:C.isCritical)||!1,sendRequest:E.sendRequest,isRollRequest:E.sendRequest,skipRollDialog:E.sendRequest?o.skipRollDialog||!1:!0,chatMessage:!0,spell:g.spell||i.spell||{},scaling:g.scaling!==void 0?g.scaling:i.scaling,consume:g.consume||i.consume||{},create:g.create||i.create||{}};c.log("GMDamageConfigDialog, initConfiguration #6",[M]);const U=_.determineRollMode(h,(be=E.message)==null?void 0:be.rollMode);return M.rollMode=U,M.rollTitle=I.options.window.title,M.rollType=y,M.rollKey=s,c.log("GMDamageConfigDialog, initConfiguration - result",[M]),M}}class Pt extends Oe(dnd5e.applications.dice.AttackRollConfigurationDialog){constructor(e={},t={},s={}){super(e,t,s),c.log("GMAttackConfigDialog.constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){c.log("GMAttackConfigDialog._prepareConfigurationData",[e,t,s,o]);const i=super._prepareConfigurationData(e,t,s,o);return i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(await super._onRender(e,t),H.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest,showMacroButton:!1},i=await H.renderTemplate(`modules/${b}/templates/gm-roll-config-fields.hbs`,o),a=document.createElement("div");a.className="gm-roll-config-fields",a.innerHTML=i,s.parentNode.insertBefore(a,s)}this._attachButtonListeners()}_attachButtonListeners(){c.log("_attachButtonListeners",[]);const e=this.element.querySelector(".flash5e-macro-button");e&&e.addEventListener("click",this._onCreateMacroClick.bind(this))}_finalizeRolls(e){return this.config.sendRequest=this.sendRequest,!this.sendRequest&&this.config.isRollRequest&&(this.config.isRollRequest=!1),super._finalizeRolls(e)}static async initConfiguration(e,t,s,o={},i={},a={}){var ie,X,Le,be,_e,Qe,Xe,Je;if(e=_.validateActors(e),!e)return null;const l=e[0];c.log("GMAttackConfigDialog, initConfiguration",[]);const n=(ie=i.subject)==null?void 0:ie.item,r=l.items.get(s),d=(r==null?void 0:r.id)||(n==null?void 0:n.id);let g={};d&&(g=Ce.activityConfigCache.get(d)||{}),c.log("GMAttackConfigDialog - retrieved activity config from cache",[d,g]);const f=O(),h=A.get(f.publicPlayerRolls.tag)===!0,R=t==null?void 0:t.toLowerCase(),y={subject:i.subject||l,data:l.getRollData(),rolls:[{parts:[],data:l.getRollData(),options:{}}]},S=_.determineRollMode(h),m=_.createMessageConfig(l,S),{position:L,...T}=(a==null?void 0:a.options)||{},I={options:{actors:e,sendRequest:e.some(St=>_.isPlayerOwned(St)),rollKey:s,rollType:CONFIG.Dice.D20Roll,rollTypeString:R,window:{title:game.i18n.localize("DND5E.Attack"),subtitle:ne._getSubtitle(e)},...T,...o}},E=await _.triggerRollDialog(this,y,m,I.options);if(c.log("GMAttackConfigDialog, initConfiguration",[E==null?void 0:E.sendRequest]),!(E!=null&&E.rolls)||E.rolls.length===0)return null;const C=E.rolls[0];let N=!1,k=!1;((X=C==null?void 0:C.options)==null?void 0:X.advantageMode)!==void 0&&(N=C.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,k=C.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const M=((Le=C==null?void 0:C.data)==null?void 0:Le.situational)||"",U=(be=C==null?void 0:C.options)==null?void 0:be.target,q={rolls:[{parts:[],data:M?{situational:M}:{},options:{...U&&{target:U},...((_e=C==null?void 0:C.options)==null?void 0:_e.ammunition)&&{ammunition:C.options.ammunition},...((Qe=C==null?void 0:C.options)==null?void 0:Qe.attackMode)&&{attackMode:C.options.attackMode},...((Xe=C==null?void 0:C.options)==null?void 0:Xe.mastery)!==void 0&&{mastery:C.options.mastery}}}],subject:i.subject||l,advantage:N,disadvantage:k,target:U,sendRequest:E.sendRequest,isRollRequest:E.sendRequest,skipRollDialog:E.sendRequest?o.skipRollDialog||!1:!0,chatMessage:!H.isModuleOn("midi-qol")||!0,spell:(g==null?void 0:g.spell)||(i==null?void 0:i.spell)||{},scaling:(g==null?void 0:g.scaling)!==void 0?g==null?void 0:g.scaling:i==null?void 0:i.scaling,consume:(g==null?void 0:g.consume)||(i==null?void 0:i.consume)||{},create:(g==null?void 0:g.create)||(i==null?void 0:i.create)||{}},Y=_.determineRollMode(h,(Je=E.message)==null?void 0:Je.rollMode);return q.rollMode=Y,q.rollTitle=I.options.window.title,q.rollType=R,q.rollKey=s,c.log("GMAttackConfigDialog, initConfiguration - SIMPLIFIED result",[q]),q}}class it{static async getRollConfiguration(e,t,s,o,i,a={}){const l=O(),n=A.get(l.rollRequestsEnabled.tag);if(c.log("RollMenuConfigUtil.getRollConfiguration",["configOverrides.sendAsRequest:",a.sendAsRequest,"hasOwnProperty sendAsRequest:",a.hasOwnProperty("sendAsRequest"),"rollRequestsEnabled:",n,"pcActors.length:",i.length]),!o&&t!==p.CUSTOM){let r;[p.SKILL,p.TOOL].includes(t)?r=Rt:t===p.HIT_DIE?r=mt:r=ne;const d=await r.initConfiguration(e,t,s,{skipRollDialog:o,sendRequest:n||!1});return c.log("getRollConfiguration",[d]),d}else{const r={rolls:[{parts:[],data:a.situationalBonus?{situational:a.situationalBonus}:{},options:a.dc?{target:a.dc}:{}}],advantage:a.advantage||!1,disadvantage:a.disadvantage||!1,rollMode:a.rollMode||game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:!0,sendRequest:a.hasOwnProperty("sendAsRequest")?a.sendAsRequest:n&&i.length>0};return t===p.DEATH_SAVE&&(r.target=10),r}}static async handleCustomRoll(){return await this.showCustomRollDialog()}static async showCustomRollDialog(){return c.log("showCustomRollDialog"),Ye.prompt({formula:"",readonly:!1})}}class fe{static initializeDrag(e){const t=e.element.querySelector(this.DRAG_HANDLE_SELECTOR);if(!t){c.error("RollMenuDragUtil.initializeDrag - No drag handle found!");return}t.addEventListener("mousedown",s=>{this.handleDragStart(s,e)})}static handleDragStart(e,t){if(e.preventDefault(),e.stopPropagation(),t.isDragging=!0,!t.element)return;t.element.classList.add("dragging"),t.element.classList.remove("docked-right");const s=t.element.getBoundingClientRect(),o=e.clientX,i=e.clientY,a=s.left,l=s.top;t.element.parentElement,document.body.appendChild(t.element),t.element.style.position="fixed",t.element.style.inset="",t.element.style.top=`${l}px`,t.element.style.left=`${a}px`,t.element.style.right="auto",t.element.style.bottom="auto",t.element.style.zIndex="var(--z-index-app)",t.element.offsetHeight;const n={startX:o,startY:i,initialLeft:a,initialTop:l,currentLeft:a,currentTop:l},r=g=>this.handleDragMove(g,t,n),d=g=>this.handleDragEnd(g,t,n,r,d);document.addEventListener("mousemove",r),document.addEventListener("mouseup",d)}static handleDragMove(e,t,s){if(!t.isDragging||!t.element)return;const o=e.clientX-s.startX,i=e.clientY-s.startY;s.currentLeft=s.initialLeft+o,s.currentTop=s.initialTop+i,t.element.style.inset="",t.element.style.right="auto",t.element.style.bottom="auto",t.element.style.position="fixed",t.element.style.top=`${s.currentTop}px`,t.element.style.left=`${s.currentLeft}px`;const a=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<a?t.element.classList.add("left-edge"):t.element.classList.remove("left-edge"),t.element.hasAttribute("data-layout")&&t.element.getAttribute("data-layout")==="horizontal"&&s.currentTop<400?t.element.classList.add("top-edge"):t.element.classList.remove("top-edge"),window.getComputedStyle(t.element),this.calculateSnapDistance(t).type!=="none"?t.element.classList.add("near-snap"):t.element.classList.remove("near-snap")}static async handleDragEnd(e,t,s,o,i){c.log("RollMenuDragUtil.handleDragEnd"),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i),t.isDragging=!1,t.element.classList.remove("dragging"),t.element.classList.remove("near-snap"),t.element.style.zIndex="";const a=this.calculateSnapDistance(t);if(a.type==="both-edges"){const l=document.querySelector("#chat-notifications");l&&l.insertBefore(t.element,l.firstChild),await this.snapToDefault(t)}else if(a.type==="right-edge"){const l=document.querySelector("#chat-notifications");l&&l.insertBefore(t.element,l.firstChild),await this.snapToRightEdge(t,s.currentTop)}else{t.isCustomPosition=!0,t.customPosition={x:s.currentLeft,y:s.currentTop,isCustom:!0,dockedRight:!1};const l=!!document.querySelector("body.crlngn-tabs");H.addCSSVars("--flash-rolls-menu-offset",l?"0px":"16px"),await this.saveCustomPosition(t.customPosition),t.element.classList.add("custom-position");const n=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<n&&t.element.classList.add("left-edge"),t.element.hasAttribute("data-layout")&&t.element.getAttribute("data-layout")==="horizontal"&&s.currentTop<400&&t.element.classList.add("top-edge")}}static calculateSnapDistance(e){const t=document.querySelector(this.LIGHTNING_BOLT_SELECTOR);if(!t)return{type:"none",distance:1/0};const s=e.element.getBoundingClientRect(),o=t.getBoundingClientRect(),i=Math.abs(o.left-s.right),a=window.innerHeight-s.bottom;return i<=this.SNAP_DISTANCE?a<=this.SNAP_DISTANCE?{type:"both-edges",distance:0}:{type:"right-edge",distance:0}:{type:"none",distance:1/0}}static async snapToRightEdge(e,t){c.log("RollMenuDragUtil.snapToRightEdge",[t]),e.isCustomPosition=!0,e.customPosition={y:t,isCustom:!0,dockedRight:!0},e.element.classList.remove("custom-position","left-edge"),e.element.classList.add("docked-right","snapping"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t<400?e.element.classList.add("top-edge"):e.element.classList.remove("top-edge"),e.element.style.position="fixed",e.element.style.inset="",e.element.style.left="",e.element.style.right="",e.element.style.bottom="",e.element.style.top=`${t}px`,e.element.style.zIndex="",Ie(),await this.saveCustomPosition(e.customPosition),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static async snapToDefault(e){c.log("RollMenuDragUtil.snapToDefault"),e.isCustomPosition=!1,e.customPosition=null,e.element.classList.remove("custom-position"),e.element.classList.remove("left-edge"),e.element.classList.remove("top-edge"),e.element.classList.add("snapping"),e.element.style.position="",e.element.style.inset="",e.element.style.left="",e.element.style.top="",e.element.style.right="",e.element.style.bottom="",e.element.style.zIndex="",Ie(),await this.saveCustomPosition(null),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static applyCustomPosition(e,t){if(!t||!t.isCustom)return;const s=e.element.getBoundingClientRect();if(c.log("RollMenuDragUtil.applyCustomPosition",[t]),t.x<0?t.x=0:t.x>window.innerWidth-s.width&&(t.x=window.innerWidth-s.width),t.y<0?t.y=0:t.y>window.innerHeight-s.height&&(t.y=window.innerHeight-s.height),e.isCustomPosition=!0,e.customPosition=t,t.dockedRight){const o=document.querySelector("#chat-notifications");o&&o.insertBefore(e.element,o.firstChild),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${t.y}px`,e.element.style.left="",e.element.style.right="",e.element.style.bottom="",e.element.classList.add("docked-right"),e.element.classList.remove("custom-position","left-edge"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t.y<400?e.element.classList.add("top-edge"):e.element.classList.remove("top-edge"),Ie()}else{document.body.appendChild(e.element),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${t.y}px`,e.element.style.left=`${t.x}px`,e.element.style.right="auto",e.element.style.bottom="auto";const o=!!document.querySelector("body.crlngn-tabs");H.addCSSVars("--flash-rolls-menu-offset",o?"0px":"16px"),e.element.classList.add("custom-position"),e.element.classList.remove("docked-right");const i=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;t.x<i&&e.element.classList.add("left-edge"),e.element.hasAttribute("data-layout")&&e.element.getAttribute("data-layout")==="horizontal"&&t.y<400&&e.element.classList.add("top-edge")}}static async saveCustomPosition(e){if(!e){await game.user.setFlag(V.ID,"menuCustomPosition",null);return}const t=document.querySelector(".flash-rolls-menu");if(t){const s=t.getBoundingClientRect();e.x<0?e.x=0:e.x>window.innerWidth-s.width&&(e.x=window.innerWidth-s.width),e.y<0?e.y=0:e.y>window.innerHeight-s.height&&(e.y=window.innerHeight-s.height)}await game.user.setFlag(V.ID,"menuCustomPosition",e)}static loadCustomPosition(){return game.user.getFlag(V.ID,"menuCustomPosition")||null}static async resetPosition(e){await this.snapToDefault(e)}}D(fe,"SNAP_DISTANCE",50),D(fe,"DRAG_HANDLE_SELECTOR",".drag-handle"),D(fe,"LIGHTNING_BOLT_SELECTOR","#flash-rolls-icon");class ee{static isFavorite(e){try{const t=typeof e=="string"?game.actors.get(e):e;return!t||!t.getFlag?!1:t.getFlag(b,this.FLAGS.FAVORITE)===!0}catch(t){return c.error("Error checking favorite status",[t,e]),!1}}static isBlocked(e){const t=typeof e=="string"?game.actors.get(e):e;return t?t.getFlag(b,this.FLAGS.BLOCKED)===!0:!1}static async setFavorite(e,t){const s=typeof e=="string"?game.actors.get(e):e;if(!s){c.error("Actor not found",[e]);return}c.log("ActorStatusUtil.setFavorite",[s.name,t]),t?(await s.setFlag(b,this.FLAGS.FAVORITE,!0),await s.unsetFlag(b,this.FLAGS.BLOCKED)):await s.unsetFlag(b,this.FLAGS.FAVORITE),this._refreshMenu()}static async setBlocked(e,t){const s=typeof e=="string"?game.actors.get(e):e;if(!s){c.error("Actor not found",[e]);return}c.log("ActorStatusUtil.setBlocked",[s.name,t]),t?(await s.setFlag(b,this.FLAGS.BLOCKED,!0),await s.unsetFlag(b,this.FLAGS.FAVORITE)):await s.unsetFlag(b,this.FLAGS.BLOCKED),this._refreshMenu()}static async toggleFavorite(e,t){const s=t?!0:!this.isFavorite(e);await this.setFavorite(e,s)}static async toggleBlocked(e,t){const s=t?!0:!this.isBlocked(e);await this.setBlocked(e,s)}static async blockActor(e){await this.setBlocked(e,!0)}static getFavoriteActors(){return game.actors.filter(e=>this.isFavorite(e))}static getBlockedActors(){return game.actors.filter(e=>this.isBlocked(e))}static filterBlocked(e){return e.filter(t=>!this.isBlocked(t))}static getActorStatus(e){return{isFavorite:this.isFavorite(e),isBlocked:this.isBlocked(e)}}static async clearActorStatus(e){const t=typeof e=="string"?game.actors.get(e):e;t&&(await t.unsetFlag(b,this.FLAGS.FAVORITE),await t.unsetFlag(b,this.FLAGS.BLOCKED),this._refreshMenu())}static _refreshMenu(){Z.refreshIfOpen()}static getContextMenuOptions(e,t){return game.user.isGM&&(t.push({name:"FLASH_ROLLS.contextMenu.toggleFavorite",icon:'<i class="fas fa-bolt"></i>',callback:s=>{const o=s.data("documentId")||s.dataset.entryId;o&&this.toggleFavorite(o)},condition:s=>game.user.isGM}),t.push({name:"FLASH_ROLLS.contextMenu.toggleBlocked",icon:'<i class="fas fa-ban"></i>',callback:s=>{const o=s.data("documentId")||s.dataset.entryId;o&&this.toggleBlocked(o)},condition:s=>game.user.isGM})),t}}D(ee,"FLAGS",{FAVORITE:"isFavorite",BLOCKED:"isBlocked"});class qt{static initializeActorDrag(e){e.element.querySelectorAll('.actor-list .actor.drag-wrapper[draggable="true"]').forEach(o=>{o.addEventListener("dragstart",i=>this.handleDragStart(i,e)),o.addEventListener("dragend",i=>this.handleDragEnd(i,e))});const s=e.element;s.addEventListener("dragover",o=>this.handleDragOver(o)),s.addEventListener("drop",o=>this.handleDrop(o,e)),document.addEventListener("dragover",o=>this.handleGlobalDragOver(o,e)),document.addEventListener("drop",o=>this.handleGlobalDrop(o,e))}static handleDragStart(e,t){const s=e.currentTarget,o=s.dataset.actorId,i=game.actors.get(o);if(!i){e.preventDefault();return}c.log("ActorDragUtil.handleDragStart",[i.name,o]),e.dataTransfer.setData("text/plain",o),e.dataTransfer.setData("application/json",JSON.stringify({actorId:o,actorName:i.name,uniqueId:s.dataset.id,tokenId:s.dataset.tokenId||null})),e.dataTransfer.effectAllowed="move",s.classList.add("dragging");const a=s.getBoundingClientRect(),l=s.cloneNode(!0);l.style.opacity="0.6",l.style.position="absolute",l.style.top="-1000px",l.style.left="-1000px",l.style.width=a.width+"px",l.style.pointerEvents="none",document.body.appendChild(l),e.dataTransfer.setDragImage(l,a.width/2,a.height/2),setTimeout(()=>{l.parentNode&&l.parentNode.removeChild(l)},0),t._currentDragData={actorId:o,actorElement:s,startTime:Date.now()}}static handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="none"}static handleDrop(e,t){e.preventDefault(),c.log("ActorDragUtil.handleDrop - dropped within menu, canceling remove"),this.cleanupDrag(t)}static handleGlobalDragOver(e,t){if(!t._currentDragData)return;const s=t.element.getBoundingClientRect();e.clientX>=s.left&&e.clientX<=s.right&&e.clientY>=s.top&&e.clientY<=s.bottom?t._currentDragData.actorElement&&t._currentDragData.actorElement.classList.remove("drag-remove-zone"):(e.preventDefault(),e.dataTransfer.dropEffect="move",t._currentDragData.actorElement&&t._currentDragData.actorElement.classList.add("drag-remove-zone"))}static handleGlobalDrop(e,t){if(!t._currentDragData)return;const s=t.element.getBoundingClientRect();if(!(e.clientX>=s.left&&e.clientX<=s.right&&e.clientY>=s.top&&e.clientY<=s.bottom)){e.preventDefault();const i=JSON.parse(e.dataTransfer.getData("application/json"));c.log("ActorDragUtil.handleGlobalDrop - blocking actor",[i.actorName]),this.blockActor(i.actorId,t)}this.cleanupDrag(t)}static handleDragEnd(e,t){c.log("ActorDragUtil.handleDragEnd"),setTimeout(()=>{this.cleanupDrag(t)},100)}static async blockActor(e,t){try{await ee.blockActor(e);const s=t.element.querySelector(`[data-actor-id="${e}"]`);if(s){const o=s.dataset.id;t.selectedActors.delete(o)}}catch(s){c.error("Error blocking actor",[s]),ui.notifications.error(`Failed to block actor: ${s.message}`)}}static cleanupDrag(e){var t;(t=e._currentDragData)!=null&&t.actorElement&&e._currentDragData.actorElement.classList.remove("dragging","drag-remove-zone"),e._currentDragData=null}static removeDragListeners(e){document.removeEventListener("dragover",this.handleGlobalDragOver),document.removeEventListener("drop",this.handleGlobalDrop)}}class ke{static canDrop(e){return c.log("ActorDropUtil.canDrop",[e]),game.user.isGM}static handleDragOver(e,t){c.log("ActorDropUtil.handleDragOver",[e,e.currentTarget,e.target]),e.preventDefault(),e.stopPropagation(),e.dataTransfer&&(e.dataTransfer.dropEffect="copy",c.log("ActorDropUtil.handleDragOver - dataTransfer types:",[e.dataTransfer.types]));const s=e.currentTarget.closest(".actor-list, .actors");return s&&(s.classList.add("drag-over"),c.log("ActorDropUtil.handleDragOver - added drag-over class")),!1}static handleDragLeave(e){c.log("ActorDropUtil.handleDragLeave",[e,e.currentTarget,e.target]);const t=e.currentTarget.getBoundingClientRect();if(e.clientX<t.left||e.clientX>t.right||e.clientY<t.top||e.clientY>t.bottom){const o=e.currentTarget.closest(".actor-list, .actors");o&&(o.classList.remove("drag-over"),c.log("ActorDropUtil.handleDragLeave - removed drag-over class"))}}static async handleDrop(e,t){e.preventDefault(),e.stopPropagation();for(let o=0;o<e.dataTransfer.types.length;o++){const i=e.dataTransfer.types[o],a=e.dataTransfer.getData(i);c.log(`ActorDropUtil.handleDrop - ${i}:`,[a])}t.element.querySelectorAll(".drag-over").forEach(o=>{o.classList.remove("drag-over")}),c.log("ActorDropUtil.handleDrop - removed drag-over class from all elements");try{const o=this.parseDragData(e);if(!o||o.type!=="Actor"){c.log("ActorDropUtil.handleDrop - Invalid drag data",[o]);return}const i=await this.getActorFromDragData(o);if(!i){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.actorNotFound")||"Actor not found");return}const l=Ge(i)?"pc":"npc";t.currentTab!==l&&(t.currentTab=l),await this.addActorToMenu(i,t)}catch(o){c.error("ActorDropUtil.handleDrop - Error processing drop",[o]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.dropError")||"Error adding actor to menu")}}static parseDragData(e){try{const t=e.dataTransfer.getData("application/json");if(t)return JSON.parse(t);const s=e.dataTransfer.getData("text/plain");if(s){if(s.startsWith("Actor."))return{type:"Actor",uuid:s};try{return JSON.parse(s)}catch{c.log("ActorDropUtil.parseDragData - Text is not JSON")}}return null}catch(t){return c.error("ActorDropUtil.parseDragData - Error parsing drag data",[t]),null}}static async getActorFromDragData(e){try{return e.uuid?await fromUuid(e.uuid):e.id?game.actors.get(e.id):null}catch(t){return c.error("ActorDropUtil.getActorFromDragData - Error getting actor",[t]),null}}static async addActorToMenu(e,t){const s=ee.isBlocked(e);if(ee.isFavorite(e)&&!s){ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.actorAlreadyAdded",{actor:e.name})||`${e.name} is already in the menu`);return}await ee.setFavorite(e,!0)}}const He=class He{static attachListeners(e,t){c.log("RollMenuEventUtil.attachListeners"),this.attachToggleHandlers(e,t),this.attachDragHandlers(e,t),this.attachTabHandlers(e,t),this.attachActorHandlers(e,t),this.attachActionIconHandlers(e,t),this.attachCompactTooltipHandlers(e,t),this.attachSearchHandlers(e,t),this.attachAccordionHandlers(e,t),this.attachSubmenuHandlers(e,t),this.attachStatusEffectHandlers(e,t),this.attachOutsideClickHandler(e)}static attachToggleHandlers(e,t){var s,o,i,a,l,n;(s=t.querySelector("#flash-rolls-toggle"))==null||s.addEventListener("change",e._onToggleRollRequests.bind(e)),(o=t.querySelector("#flash5e-skip-dialogs"))==null||o.addEventListener("change",e._onToggleSkipDialogs.bind(e)),(i=t.querySelector("#flash5e-group-rolls-msg"))==null||i.addEventListener("change",e._onToggleGroupRollsMsg.bind(e)),(a=t.querySelector("#flash5e-actors-all"))==null||a.addEventListener("change",e._onToggleSelectAll.bind(e)),(l=t.querySelector("#flash5e-actors-lock"))==null||l.addEventListener("click",e._onToggleLock.bind(e)),(n=t.querySelector(".options-toggle-btn"))==null||n.addEventListener("click",e._onToggleOptions.bind(e))}static attachDragHandlers(e,t){const s=t.querySelector(fe.DRAG_HANDLE_SELECTOR);s&&!s.hasAttribute("data-drag-initialized")&&(s.setAttribute("data-drag-initialized","true"),s.addEventListener("mousedown",o=>{fe.handleDragStart(o,e)}))}static attachTabHandlers(e,t){const s=t.querySelectorAll(".actor-tab");c.log("RollMenuEventUtil.attachTabHandlers - found tabs:",[s.length]),s.forEach(o=>{c.log("RollMenuEventUtil.attachTabHandlers - attaching to tab:",[o.dataset.tab]),o.addEventListener("click",e._onTabClick.bind(e)),o.addEventListener("dblclick",e._onTabDoubleClick.bind(e))})}static attachActionIconHandlers(e,t){var s,o,i,a,l,n;(s=t.querySelector("#flash5e-targets"))==null||s.addEventListener("click",()=>{this.toggleTargetsForSelected(e)}),(o=t.querySelector("#flash5e-heal-selected"))==null||o.addEventListener("click",()=>{this.healSelectedActors(e)}),(i=t.querySelector("#flash5e-kill-selected"))==null||i.addEventListener("click",()=>{this.killSelectedActors(e)}),(a=t.querySelector("#flash5e-sheets"))==null||a.addEventListener("click",()=>{this.openSheetsForSelected(e)}),(l=t.querySelector("#flash5e-toggle-list"))==null||l.addEventListener("change",()=>{this.toggleOptionsListOnHover(e)}),(n=t.querySelector("#flash5e-remove-effects"))==null||n.addEventListener("click",()=>{this.removeAllStatusEffectsFromSelected(e)})}static attachActorHandlers(e,t){t.querySelectorAll(".actor.drag-wrapper").forEach(s=>{s.addEventListener("click",e._onActorClick.bind(e));const o=s.querySelector(".icon-sheet");o&&o.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const n=s.dataset.actorId,r=s.dataset.tokenId;this.openActorSheetById(n,r)});const i=s.querySelector(".icon-target");i&&i.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const n=s.dataset.actorId,r=s.dataset.tokenId;this.toggleActorTargetById(n,r)});const a=s.querySelector(".actor-img");a&&(a.addEventListener("contextmenu",l=>{l.preventDefault(),l.stopPropagation();const n=s.dataset.tokenId,r=s.dataset.actorId;let d=n?canvas.tokens.get(n):null;!d&&r&&(d=canvas.tokens.placeables.find(g=>{var f;return((f=g.actor)==null?void 0:f.id)===r})),d&&canvas.animatePan({x:d.x,y:d.y,duration:250})}),a.addEventListener("mouseenter",l=>{this.showTokenSelectionPreview(s,e)}),a.addEventListener("mouseleave",l=>{this.hideTokenSelectionPreview(s,e)}))})}static attachCompactTooltipHandlers(e,t){if(!t.classList.contains("compact"))return;t.querySelectorAll("#flash-rolls-menu.compact .actor").forEach(o=>{const i=o.querySelector(".actor-data");if(!i)return;let a=null;const l=async d=>{const g=document.querySelector(".actor-data-tooltip");g&&g.remove(),a=i.cloneNode(!0);const f=o.getBoundingClientRect(),h=t.getBoundingClientRect(),R=t.classList.contains("left-edge");if(t.hasAttribute("data-layout")&&t.getAttribute("data-layout")==="horizontal"){const S=o.querySelector(".actor-img"),m=S?S.getBoundingClientRect():f,L=m.left+m.width/2-h.left-16;a.style.left=`${L}px`,a.style.transform="translateX(-50%)",a.style.bottom=`${h.bottom-f.top+8}px`,a.style.top="auto",a.style.right="auto"}else R?a.style.left=`${f.right-h.left-8}px`:a.style.right=`${h.right-f.left-8}px`,a.style.top=`${f.top-h.top}px`;a.className="actor-data-tooltip",document.querySelector("#flash-rolls-menu").appendChild(a),setTimeout(()=>{a==null||a.classList.add("visible")},e.selectedActors.size>0?300:0)},n=()=>{a&&(a.remove(),a=null)};o.addEventListener("mouseenter",l),o.addEventListener("mouseleave",n);const r=o.closest("ul");r&&r.addEventListener("scroll",n)})}static attachSearchHandlers(e,t){const s=t.querySelector(".search-input");s&&(s.addEventListener("input",e._onSearchInput.bind(e)),s.addEventListener("click",o=>{o.target.select()}),s.addEventListener("focus",o=>{o.target.select(),e.isSearchFocused=!0,game.user.setFlag("flash-rolls-5e","searchFocused",!0)}),s.addEventListener("blur",()=>{e.isSearchFocused=!1,game.user.setFlag("flash-rolls-5e","searchFocused",!1);const o=t.querySelector(".request-types-accordion");o&&!t.matches(":hover")&&o.classList.remove("hover-visible")}))}static attachAccordionHandlers(e,t){const s=O(),o=A.get(s.showOptionsListOnHover.tag),i=t.querySelector(".request-types-accordion");if(i){const l=()=>{const r=A.get(s.showOptionsListOnHover.tag);c.log("Accordion mouseEnter",[e.isSearchFocused]),e.selectedActors.size>0&&r&&(i==null||i.classList.add("hover-visible"))},n=()=>{c.log("Accordion mouseLeave",[e.isSearchFocused]),e.isSearchFocused||i==null||i.classList.remove("hover-visible")};e._accordionMouseEnter=l,e._accordionMouseLeave=n,o?(t.addEventListener("mouseenter",l),t.addEventListener("mouseleave",n),e._accordionListenersAttached=!0):e._accordionListenersAttached=!1}const a=t.querySelector(".request-types");c.log("RollMenuEventUtil.attachAccordionHandlers",[a]),a&&a.addEventListener("click",l=>{if(c.log("requestTypes click",[l.target]),l.target.classList.contains("btn-macro")){l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation();const g=l.target.closest(".sub-item")||l.target.closest(".request-type-item");if(g){const f={...l,currentTarget:g};e._onMacroButtonClick(f)}return}const n=l.target.closest(".btn-macro");if(n){l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation();const g=n.closest(".sub-item")||n.closest(".request-type-item");if(g){const f={...l,currentTarget:g};e._onMacroButtonClick(f)}return}const r=l.target.closest(".request-type-header");if(r){const g=r.closest(".request-type-item");if(r.classList.contains("accordion-header")){e._onAccordionToggle(l);return}if(r.classList.contains("toggle")&&g&&g.classList.contains("rollable")){const f={...l,currentTarget:g};e._onRequestTypeClick(f);return}}const d=l.target.closest(".sub-item");if(d&&d.dataset.id){const g={...l,currentTarget:d};e._onRollTypeClick(g)}})}static attachSubmenuHandlers(e,t){try{const s=t.querySelectorAll(".submenu-tabs li[data-tab]");c.log("RollMenuEventUtil.attachSubmenuHandlers - found tabs:",[s.length]),s.forEach(o=>{o.addEventListener("click",e._onSubmenuTabClick.bind(e))})}catch(s){c.error("RollMenuEventUtil.attachSubmenuHandlers error:",[s])}}static attachStatusEffectHandlers(e,t){try{const s=t.querySelectorAll(".status-effects .status-effect");c.log("RollMenuEventUtil.attachStatusEffectHandlers - found effects:",[s.length]),s.forEach(o=>{o.dataset.listenerAttached||(o.dataset.listenerAttached="true",o.addEventListener("click",e._onStatusEffectClick.bind(e)))})}catch(s){c.error("RollMenuEventUtil.attachStatusEffectHandlers error:",[s])}}static attachOutsideClickHandler(e){setTimeout(()=>{document.addEventListener("click",e._onClickOutside,!0)},100)}static toggleTargetsForSelected(e){e.selectedActors.forEach(t=>{const s=Q(t);if(!s)return;const o=s.id,i=game.actors.get(t)?null:t;this.toggleActorTargetById(o,i)})}static openSheetsForSelected(e){e.selectedActors.forEach(t=>{const s=Q(t);if(!s)return;const o=s.id,i=game.actors.get(t)?null:t;this.openActorSheetById(o,i)})}static healSelectedActors(e){e.selectedActors.forEach(t=>{const s=Q(t);if(!s)return;const o=s.id,i=game.actors.get(t)?null:t;this.healActorById(o,i)})}static killSelectedActors(e){e.selectedActors.forEach(t=>{const s=Q(t);if(!s)return;const o=s.id,i=game.actors.get(t)?null:t;this.killActorById(o,i)})}static async removeAllStatusEffectsFromSelected(e){if(e.selectedActors.size===0){ui.notifications.warn("No actors selected");return}let t=0,s=0;for(const o of e.selectedActors){const i=Q(o);if(!i)continue;s++;const a=i.effects.filter(l=>{var n,r,d;return((n=l.statuses)==null?void 0:n.size)>0||((d=(r=l.flags)==null?void 0:r.core)==null?void 0:d.statusId)});if(a.length>0)for(const l of a)try{await l.delete(),t++}catch(n){c.error(`Failed to remove status effect from ${i.name}`,[n])}}t>0?ui.notifications.info(`Removed ${t} status effects from ${s} actor(s)`):ui.notifications.info("No status effects to remove from selected actors")}static toggleActorTarget(e){const t=e.dataset.tokenId,s=e.dataset.actorId;let o=t?canvas.tokens.get(t):null;if(!o&&s&&(o=canvas.tokens.placeables.find(i=>{var a;return((a=i.actor)==null?void 0:a.id)===s})),o){const i=game.user.targets.has(o);o.setTarget(!i,{releaseOthers:!1})}}static openActorSheet(e){const t=e.dataset.actorId,s=e.dataset.tokenId;if(t){let o;if(s){const i=canvas.tokens.get(s);o=(i==null?void 0:i.actor)||game.actors.get(t)}else o=game.actors.get(t);o==null||o.sheet.render(!0)}}static healActor(e){var i,a;const t=e.dataset.actorId,s=e.dataset.tokenId;let o;if(s){const l=canvas.tokens.get(s);o=(l==null?void 0:l.actor)||game.actors.get(t)}else o=game.actors.get(t);if(o&&((a=(i=o.system)==null?void 0:i.attributes)!=null&&a.hp)){const l=o.system.attributes.hp.max;o.update({"system.attributes.hp.value":l})}}static killActor(e){var i,a;const t=e.dataset.actorId,s=e.dataset.tokenId;let o;if(s){const l=canvas.tokens.get(s);o=(l==null?void 0:l.actor)||game.actors.get(t)}else o=game.actors.get(t);o&&((a=(i=o.system)==null?void 0:i.attributes)!=null&&a.hp)&&o.update({"system.attributes.hp.value":0})}static toggleActorTargetById(e,t){let s=t?canvas.tokens.get(t):null;if(!s&&e&&(s=canvas.tokens.placeables.find(o=>{var i;return((i=o.actor)==null?void 0:i.id)===e})),s){const o=game.user.targets.has(s);s.setTarget(!o,{releaseOthers:!1})}}static openActorSheetById(e,t){if(e){let s;if(t){const o=canvas.tokens.get(t);s=(o==null?void 0:o.actor)||game.actors.get(e)}else s=game.actors.get(e);s==null||s.sheet.render(!0)}}static healActorById(e,t){var o,i;let s;if(t){const a=canvas.tokens.get(t);s=(a==null?void 0:a.actor)||game.actors.get(e)}else s=game.actors.get(e);if(s&&((i=(o=s.system)==null?void 0:o.attributes)!=null&&i.hp)){const a=s.system.attributes.hp.max;s.update({"system.attributes.hp.value":a})}}static killActorById(e,t){var o,i;let s;if(t){const a=canvas.tokens.get(t);s=(a==null?void 0:a.actor)||game.actors.get(e)}else s=game.actors.get(e);s&&((i=(o=s.system)==null?void 0:o.attributes)!=null&&i.hp)&&s.update({"system.attributes.hp.value":0})}static showTokenSelectionPreview(e,t){const s=e.dataset.tokenId,o=e.dataset.actorId,i=e.dataset.id;let a=s?canvas.tokens.get(s):null;if(!a&&o&&(a=canvas.tokens.placeables.find(l=>{var n;return((n=l.actor)==null?void 0:n.id)===o})),a){const l=t.selectedActors.has(i);a._controlled||(t._ignoreTokenControl=!0,a.control({releaseOthers:!1}),setTimeout(()=>{t._ignoreTokenControl=!1},50),this._hoveredTokens.add(a),a._flashRollsWasSelected=l)}}static async toggleOptionsListOnHover(e){const t=O(),s=A.get(t.showOptionsListOnHover.tag),o=e.element.querySelector(".request-types-accordion");o==null||o.classList.contains("hover-visible");const i=!s;await A.set(t.showOptionsListOnHover.tag,i),He.updateAccordionHoverBehaviorNoRender(e,i),i===!1||e.selectedActors.size===0?o==null||o.classList.remove("hover-visible"):i===!0&&e.selectedActors.size>0&&(o==null||o.classList.add("hover-visible"))}static updateAccordionHoverBehavior(e,t){e.render()}static updateAccordionHoverBehaviorNoRender(e,t){const s=e.element,o=s.querySelector(".request-types-accordion");!o||!e._accordionMouseEnter||(s.removeEventListener("mouseenter",e._accordionMouseEnter),s.removeEventListener("mouseleave",e._accordionMouseLeave),o.classList.remove("hover-visible"),t&&(s.addEventListener("mouseenter",e._accordionMouseEnter),s.addEventListener("mouseleave",e._accordionMouseLeave)))}static hideTokenSelectionPreview(e,t){const s=e.dataset.tokenId,o=e.dataset.actorId,i=e.dataset.id;let a=s?canvas.tokens.get(s):null;if(!a&&o&&(a=canvas.tokens.placeables.find(l=>{var n;return((n=l.actor)==null?void 0:n.id)===o})),a&&this._hoveredTokens.has(a)){const l=t.selectedActors.has(i),n=a._flashRollsWasSelected;!l&&!n&&(t._ignoreTokenControl=!0,a.release(),setTimeout(()=>{t._ignoreTokenControl=!1},50)),this._hoveredTokens.delete(a),delete a._flashRollsWasSelected}}};D(He,"_hoveredTokens",new Set);let $e=He;class yt{static async applyStatusToSelected(e,t){const s=CONFIG.statusEffects.find(a=>a.id===e);if(!s){ui.notifications.warn(`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){ui.notifications.warn("No actors selected");return}let o=0,i=0;for(const a of t.selectedActors){const l=Q(a);if(!l)continue;i++,await this.applyStatusToActor(s,l)&&o++}if(o>0){const a=s.name||s.label||s.id;ui.notifications.info(`Applied "${a}" to ${o}/${i} actors`)}}static async applyStatusToActor(e,t){try{if(t.effects.find(i=>{var a,l,n;return((a=i.statuses)==null?void 0:a.has(e.id))||((n=(l=i.flags)==null?void 0:l.core)==null?void 0:n.statusId)===e.id}))return c.log(`RollMenuStatusUtil: Actor ${t.name} already has status effect ${e.id}`),!1;if(t.toggleStatusEffect)return t.effects.some(a=>{var l;return(l=a.statuses)==null?void 0:l.has(e.id)})?!1:(await t.toggleStatusEffect(e.id,{active:!0}),c.log(`RollMenuStatusUtil: Applied ${e.id} to ${t.name}`),!0);const o={name:e.name||e.label||e.id,icon:e.icon||e.img,statuses:[e.id],flags:{core:{statusId:e.id}}};return e.changes&&(o.changes=e.changes),await t.createEmbeddedDocuments("ActiveEffect",[o]),c.log(`RollMenuStatusUtil: Applied ${e.id} to ${t.name}`),!0}catch(s){return c.error(`RollMenuStatusUtil: Failed to apply status effect to ${t.name}`,[s]),!1}}static async removeStatusFromSelected(e,t){const s=CONFIG.statusEffects.find(a=>a.id===e);if(!s){ui.notifications.warn(`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){ui.notifications.warn("No actors selected");return}let o=0,i=0;for(const a of t.selectedActors){const l=Q(a);if(!l)continue;i++,await this.removeStatusFromActor(s,l)&&o++}if(o>0){const a=s.name||s.label||s.id;ui.notifications.info(`Removed "${a}" from ${o}/${i} actors`)}}static async removeStatusFromActor(e,t){try{if(t.toggleStatusEffect)return t.effects.some(i=>{var a;return(a=i.statuses)==null?void 0:a.has(e.id)})?(await t.toggleStatusEffect(e.id,{active:!1}),c.log(`RollMenuStatusUtil: Removed ${e.id} from ${t.name}`),!0):!1;const s=t.effects.find(o=>{var i,a,l;return((i=o.statuses)==null?void 0:i.has(e.id))||((l=(a=o.flags)==null?void 0:a.core)==null?void 0:l.statusId)===e.id});return s?(await s.delete(),c.log(`RollMenuStatusUtil: Removed ${e.id} from ${t.name}`),!0):(c.log(`RollMenuStatusUtil: Actor ${t.name} does not have status effect ${e.id}`),!1)}catch(s){return c.error(`RollMenuStatusUtil: Failed to remove status effect from ${t.name}`,[s]),!1}}static async toggleStatusOnSelected(e,t){const s=CONFIG.statusEffects.find(i=>i.id===e);if(!s){ui.notifications.warn(`Status effect "${e}" not found`);return}if(t.selectedActors.size===0){ui.notifications.warn("No actors selected");return}let o=!1;for(const i of t.selectedActors){const a=Q(i);if(!a)continue;if(a.effects.find(n=>{var r,d,g;return((r=n.statuses)==null?void 0:r.has(s.id))||((g=(d=n.flags)==null?void 0:d.core)==null?void 0:g.statusId)===s.id})){o=!0;break}}o?await this.removeStatusFromSelected(e,t):await this.applyStatusToSelected(e,t)}static getStatusEffectsForTemplate(){try{return!CONFIG.statusEffects||!Array.isArray(CONFIG.statusEffects)?(c.warn("RollMenuStatusUtil: CONFIG.statusEffects not available or not an array"),[]):CONFIG.statusEffects.map(e=>({...e,displayName:e.name||e.label||e.id,iconPath:e.icon||e.img||"icons/svg/aura.svg"})).sort((e,t)=>e.displayName.localeCompare(t.displayName,void 0,{sensitivity:"base"}))}catch(e){return c.error("RollMenuStatusUtil: Error getting status effects for template",[e]),[]}}}class xt{static async prepareActorContext(e,t){const s=O(),o=game.actors.contents,i=[],a=[],l=game.scenes.active;for(const m of o){if(m.type!=="character"&&m.type!=="npc")continue;const L=this.isPlayerOwnedActor(m),T=await this.processActor(m,l,e,L);L?i.push(...T):a.push(...T)}const n=A.get(s.rollRequestsEnabled.tag),r=A.get(s.skipRollDialog.tag),d=A.get(s.groupRollsMsgEnabled.tag);A.get(s.showOnlyPCsWithToken.tag);const g=A.get(s.showOptionsListOnHover.tag)??s.showOptionsListOnHover.default;c.log("Template context showOptionsListOnHover:",[g,typeof g,"tag:",s.showOptionsListOnHover.tag]);const f=e.currentTab==="pc"?i:a,h=f.length>0&&f.every(m=>e.selectedActors.has(m.uniqueId)),R=this.buildRequestTypes(e),y=st(e.selectedRequestType,e.selectedActors),S=yt.getStatusEffectsForTemplate();return{...t,actors:f,currentTab:e.currentTab,isPCTab:e.currentTab==="pc",isNPCTab:e.currentTab==="npc",selectedTab:e.currentTab,selectedSubmenu:e.selectedSubmenu,rollRequestsEnabled:n,skipRollDialog:r,groupRollsMsgEnabled:d,showOptionsListOnHover:g,selectAllOn:h,hasSelectedActors:e.selectedActors.size>0,requestTypes:R,rollTypes:y,statusEffects:S,showNames:!0,actorsLocked:e.isLocked,optionsExpanded:e.optionsExpanded,isGM:game.user.isGM,isCompact:A.get(s.compactMode.tag)}}static isPlayerOwnedActor(e){return Object.entries(e.ownership).some(([t,s])=>{const o=game.users.get(t);return o&&!o.isGM&&s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}static async processActor(e,t,s,o){var d;if(ee.isBlocked(e))return[];const i=O(),a=A.get((d=i.showOnlyPCsWithToken)==null?void 0:d.tag),l=ee.isFavorite(e),n=(t==null?void 0:t.tokens.filter(g=>g.actorId===e.id))||[],r=[];return o?l?r.push(...this.processFavoriteActor(e,n,s)):a?r.push(...this.processTokenOnlyActor(e,n,s)):r.push(...this.processRegularActor(e,n,s)):l?r.push(...this.processFavoriteActor(e,n,s)):r.push(...this.processTokenOnlyActor(e,n,s)),r}static processFavoriteActor(e,t,s){const o=[];if(t.length>0)t.forEach(i=>{const a=this.createActorData(e,i,s);a.isFavorite=!0,o.push(a)});else{const i=this.createActorData(e,null,s);i.isFavorite=!0,o.push(i)}return o}static processTokenOnlyActor(e,t,s){const o=[];return t.length>0&&t.forEach(i=>{const a=this.createActorData(e,i,s);o.push(a)}),o}static processRegularActor(e,t,s){const o=[];if(t.length>0)t.forEach(i=>{const a=this.createActorData(e,i,s);o.push(a)});else{const i=this.createActorData(e,null,s);o.push(i)}return o}static createActorData(e,t,s){const o=(t==null?void 0:t.actor)||e,i=ot.getActorHPData(o);return{id:e.id,uuid:e.uuid,name:t?t.name:e.name,img:e.img,selected:s.selectedActors.has((t==null?void 0:t.id)||e.id),crlngnStats:ot.getActorStats(o),hpPercent:i.hpPercent,hpColor:i.hpColor,tokenId:(t==null?void 0:t.id)||null,isToken:!!t,uniqueId:(t==null?void 0:t.id)||e.id}}static buildRequestTypes(e){const t=[];for(const[s,o]of Object.entries(V.ROLL_REQUEST_OPTIONS)){const i={id:s,name:game.i18n.localize(`FLASH_ROLLS.rollTypes.${o.name}`)||o.label,rollable:o.subList==null,hasSubList:!!o.subList,selected:e.selectedRequestType===s,expanded:e.accordionStates[s]??!1,subItems:[]};o.subList&&(i.subItems=st(s,e.selectedActors)),t.push(i)}return t}}class ve{static async handleGMRolls(e,t,s,o){c.log("RollMenuExecutionUtil.handleGMRolls",[e,t,s,o]);for(const i of e)await this.initiateRoll(i,t,s,o),await Me(100)}static async handleGMRollsWithTokens(e,t,s,o){var i,a;c.log("RollMenuExecutionUtil.handleGMRollsWithTokens",[e,t,s,o]);for(const l of e){if(l.tokenId){const n=((i=canvas.tokens)==null?void 0:i.get(l.tokenId))||((a=game.scenes.active)==null?void 0:a.tokens.get(l.tokenId));n?await this.initiateRollForToken(l.actor,n,t,s,o):await this.initiateRoll(l.actor,t,s,o)}else await this.initiateRoll(l.actor,t,s,o);await Me(100)}}static async initiateRollForToken(e,t,s,o,i){c.log("RollMenuExecutionUtil.initiateRollForToken",[e.name,t.name,s,o,i]);const a=t.controlled;a||t.control({releaseOthers:!1});try{await this.initiateRoll(e,s,o,i)}finally{a||t.release()}}static async initiateRoll(e,t,s,o){var i;c.log("RollMenuExecutionUtil.initiateRoll",[e,t,s,o]);try{const a=t.toLowerCase();let l=s;if(a===p.HIT_DIE){const m=e.system.attributes.hd;if(m.value>0&&(l=m.largestAvailable),!l){c.warn("RollMenuExecutionUtil.initiateRoll - No hit dice available after orchestration refill",[e.name]),j.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.noHitDice",{actor:e.name})||`No hit dice available for ${e.name}`);return}}const n={rollKey:l,groupRollId:o.groupRollId,config:{...o,rollMode:o.rollMode||game.settings.get("core","rollMode"),advantage:o.advantage||!1,disadvantage:o.disadvantage||!1,target:o.target}},r={configure:!o.fastForward&&!o.skipRollDialog,isRollRequest:!0};let d=o.rollMode||game.settings.get("core","rollMode");const g=O(),f=A.get(g.publicPlayerRolls.tag)===!0;(!(A.get(g.groupRollsMsgEnabled.tag)===!0)||!o.groupRollId)&&!o.rollMode&&f&&e&&_.isPlayerOwned(e)&&(d=CONST.DICE_ROLL_MODES.PUBLIC);const R={rollMode:d,create:o.chatMessage!==!1,isRollRequest:!0},y=((i=o.rolls)==null?void 0:i[0])||{};c.log("RollMenuExecutionUtil.initiateRoll - rollConfig before handler",["parts:",y.parts,"data:",y.data,"rollProcessConfig:",o]);const S=K[a];S?await S(e,n,y,r,R):j.notify("warn",`Unknown roll type: ${t}`)}catch(a){c.error("RollMenuExecutionUtil.initiateRoll error",[a]),j.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name}))}}}class te{static async handleToggleRollRequests(e){const t=O(),s=e.target.checked;await A.set(t.rollRequestsEnabled.tag,s),Be.updateRollRequestsIcon(s)}static async handleToggleSkipDialogs(e){const t=O(),s=e.target.checked;await A.set(t.skipRollDialog.tag,s)}static async handleToggleGroupRollsMsg(e){const t=O(),s=e.target.checked;await A.set(t.groupRollsMsgEnabled.tag,s)}static handleToggleSelectAll(e,t){const s=O(),o=e.target.checked;t._ignoreTokenControl=!0,((t._lastPreparedContext||{}).actors||[]).forEach(r=>{const d=r.uniqueId;o?(t.selectedActors.add(d),r.tokenId?ue(r.id,!0,r.tokenId):ue(r.id,!0)):(t.selectedActors.delete(d),r.tokenId?ue(r.id,!1,r.tokenId):ue(r.id,!1))}),setTimeout(()=>{t._ignoreTokenControl=!1},200),t.render(),this.updateRequestTypesVisibility(t);const l=A.get(s.showOptionsListOnHover.tag),n=t.element.querySelector(".request-types-accordion");n&&(t.selectedActors.size>0&&l?n.classList.add("hover-visible"):n.classList.remove("hover-visible"))}static handleToggleLock(e,t){e.preventDefault(),t.isLocked=!t.isLocked;const s=e.currentTarget;s.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),s.classList.add(t.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open")}static async handleToggleOptions(e,t){e.preventDefault(),e.stopPropagation(),t.optionsExpanded=!t.optionsExpanded,await game.user.setFlag(V.ID,"menuOptionsExpanded",t.optionsExpanded);const s=t.element.querySelector(".options-toggle");s&&s.classList.toggle("expanded",t.optionsExpanded);const o=t.element.querySelector("li.options");o&&o.classList.toggle("expanded",t.optionsExpanded)}static toggleActorSelection(e,t,s,o){const i=O();o._ignoreTokenControl=!0,o.selectedActors.has(e)?(o.selectedActors.delete(e),s?ue(t,!1,s):ue(t,!1)):(o.selectedActors.add(e),s?ue(t,!0,s):ue(t,!0)),setTimeout(()=>{o._ignoreTokenControl=!1},100),this.updateActorSelectionUI(e,o),this.updateSelectAllState(o),this.updateRequestTypesVisibilityNoRender(o);const a=A.get(i.showOptionsListOnHover.tag),l=o.element.querySelector(".request-types-accordion");l&&(o.selectedActors.size>0&&a?l.classList.add("hover-visible"):l.classList.remove("hover-visible"))}static updateActorSelectionUI(e,t){const s=t.element.querySelector(`.actor.drag-wrapper[data-id="${e}"]`);if(!s)return;const o=s.closest(".actor");if(!o)return;const i=o.querySelector(".actor-select"),a=t.selectedActors.has(e);i&&(i.checked=a),s.classList.toggle("selected",a),s.dataset.selected=a.toString()}static updateRequestTypesVisibility(e){e.render()}static updateRequestTypesVisibilityNoRender(e){const t=e.selectedActors.size>0,s=e.element.querySelector(".request-types");if(s){s.querySelectorAll(".request-type-item").forEach(l=>{l.classList.toggle("disabled",!t)});const i=Array.from(e.selectedActors).some(l=>{const n=Q(l);return(n==null?void 0:n.type)==="character"}),a=s.querySelector('[data-id="HIT_DIE"]');a&&(a.style.display=i?"":"none")}e.element.querySelector(".status-effects")}static updateSelectAllState(e){const t=e.element.querySelector("#flash5e-actors-all"),s=e.currentTab==="pc"?"pc":"npc",o=e.element.querySelectorAll(`.${s}-actors .actor-item input[type="checkbox"]`),i=Array.from(o).filter(a=>a.checked).length;t.checked=i>0&&i===o.length,t.indeterminate=i>0&&i<o.length}}const{ApplicationV2:zt,HandlebarsApplicationMixin:Bt}=foundry.applications.api;var P,he,Ne;const se=class se extends Bt(zt){constructor(t={}){c.log("RollRequestsMenu.constructor",[t]);super(t);D(this,"_onClickOutside",t=>{if(this.isLocked)return;const s=this.element;s&&(t.target.closest(".flash-rolls-menu")||s.contains(t.target)||this.close())});this.selectedActors=new Set,this.currentTab="pc",this.selectedSubmenu="request-types",this.selectedRequestType=null,this.isLocked=!1,this.optionsExpanded=game.user.getFlag(V.ID,"menuOptionsExpanded")??!1,this.accordionStates=game.user.getFlag(V.ID,"menuAccordionStates")??{},this.isSearchFocused=game.user.getFlag("flash-rolls-5e","searchFocused")??!1,this.isDragging=!1,this.isCustomPosition=!1,this.customPosition=fe.loadCustomPosition(),this._initializeFromSelectedTokens()}async _prepareContext(t){const s=await super._prepareContext(t),o=await xt.prepareActorContext(this,s),i=O();return o.menuLayout=A.get(i.menuLayout.tag),this._lastPreparedContext=o,o}async _renderFrame(t){const s=await super._renderFrame(t),o=this.customPosition||fe.loadCustomPosition();o!=null&&o.isCustom&&(this.isCustomPosition=!0,this.customPosition=o);const i=document.querySelector("#chat-notifications");return i&&s&&i.insertBefore(s,i.firstChild),s}_onRender(t,s){super._onRender(t,s);const o=document.querySelector("#flash-rolls-menu");if(o){const a=O();A.get(a.compactMode.tag)?o.classList.add("compact"):o.classList.remove("compact");const n=A.get(a.menuLayout.tag);o.setAttribute("data-layout",n)}if(fe.applyCustomPosition(this,this.customPosition),this._dragDrop&&this._dragDrop.length>0&&this._dragDrop.forEach((a,l)=>{c.log(`_onRender - DragDrop handler ${l}:`,[a,a.dropSelector,a.callbacks])}),this.element.querySelectorAll(".actor-list").forEach((a,l)=>{a.removeEventListener("dragover",this._boundDragOver),a.removeEventListener("drop",this._boundDrop),a.removeEventListener("dragenter",this._boundDragEnter),a.removeEventListener("dragleave",this._boundDragLeave),this._boundDragOver=n=>{this._onDragOver(n)},this._boundDrop=n=>{this._onDrop(n)},this._boundDragEnter=n=>{n.preventDefault()},this._boundDragLeave=n=>{ke.handleDragLeave(n)},a.addEventListener("dragover",this._boundDragOver),a.addEventListener("drop",this._boundDrop),a.addEventListener("dragenter",this._boundDragEnter),a.addEventListener("dragleave",this._boundDragLeave)}),Ie(),A.updateColorScheme(),this.element.classList.add("theme-"+A.coreColorScheme),this.optionsExpanded){const a=this.element.querySelector(".options-toggle"),l=this.element.querySelector("li.options");this.element.querySelector(".options-toggle-btn"),a==null||a.classList.add("expanded"),l==null||l.classList.add("expanded")}this._tokenControlHook=Hooks.on(w.CONTROL_TOKEN,this._onTokenControlChange.bind(this)),this._updateItemHook=Hooks.on(w.UPDATE_ITEM,this._onItemUpdate.bind(this)),this._createItemHook=Hooks.on(w.CREATE_ITEM,this._onItemUpdate.bind(this)),this._deleteItemHook=Hooks.on(w.DELETE_ITEM,this._onItemUpdate.bind(this)),qt.initializeActorDrag(this),this._updateRequestTypesVisibilityNoRender(),$e.attachListeners(this,this.element)}_onTokenControlChange(t,s){this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{const o=new Set(this.selectedActors);this._initializeFromSelectedTokens();const i=new Set([...o,...this.selectedActors]);for(const a of i)this._updateActorSelectionUI(a);this._updateSelectAllState(),this._updateRequestTypesVisibilityNoRender(),this._tokenUpdateTimeout=null},100)))}_onItemUpdate(t,s,o,i){var g,f;if(!this.rendered||!(t.type==="equipment"||((g=s.system)==null?void 0:g.equipped)!==void 0||((f=s.system)==null?void 0:f.attunement)!==void 0))return;const l=t.parent;if(!l||l.documentName!=="Actor")return;const n=this.currentTab,r=Object.entries(l.ownership).some(([h,R])=>{const y=game.users.get(h);return y&&!y.isGM&&R>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER});(n==="pc"&&r||n==="npc"&&!r&&gt(l))&&(this._itemUpdateTimeout&&clearTimeout(this._itemUpdateTimeout),this._itemUpdateTimeout=setTimeout(()=>{this.render(),this._itemUpdateTimeout=null},500))}async _onToggleRollRequests(t){return te.handleToggleRollRequests(t)}async _onToggleSkipDialogs(t){return te.handleToggleSkipDialogs(t)}async _onToggleGroupRollsMsg(t){return te.handleToggleGroupRollsMsg(t)}_onToggleSelectAll(t){return te.handleToggleSelectAll(t,this)}_onToggleLock(t){return te.handleToggleLock(t,this)}async _onToggleOptions(t){return te.handleToggleOptions(t,this)}_canDragDrop(t){return ke.canDrop(t)}_onDragOver(t){ke.handleDragOver(t,this)}async _onDrop(t){await ke.handleDrop(t,this)}_initializeFromSelectedTokens(){var s;const t=((s=canvas.tokens)==null?void 0:s.controlled)||[];this.selectedActors.clear();for(const o of t)if(o.actor){const i=o.id;if(this.selectedActors.add(i),this.selectedActors.size===1){const a=Ge(o.actor);this.currentTab=a?"pc":"npc"}}}async _onTabClick(t){const s=t.currentTarget.dataset.tab;c.log("_onTabClick #0",[s]),this.selectedRequestType=null,this.currentTab=s,await this.render()}async _onTabDoubleClick(t){var s;t.preventDefault(),t.stopPropagation(),this._ignoreTokenControl=!0,this.selectedActors.clear(),(s=canvas.tokens)==null||s.releaseAll(),this.selectedRequestType=null,setTimeout(()=>{this._ignoreTokenControl=!1},200),await this.render(),this._updateRequestTypesVisibility()}async _onSubmenuTabClick(t){const s=t.currentTarget.dataset.tab;if(c.log("_onSubmenuTabClick",[s]),s===this.selectedSubmenu)return;this.selectedSubmenu=s,await this.render();const o=this.element.querySelector(".request-types-accordion");o&&this.selectedActors.size>0&&o.classList.add("hover-visible")}async _onStatusEffectClick(t){t.preventDefault(),t.stopPropagation();const s=t.currentTarget.dataset.id;c.log("_onStatusEffectClick",[s]),await yt.toggleStatusOnSelected(s,this)}_onActorClick(t){if(t.target.closest(".actor-select"))return;const s=t.currentTarget,o=s.dataset.id,i=s.dataset.actorId,a=s.dataset.tokenId;this._toggleActorSelection(o,i,a)}_toggleActorSelection(t,s,o){return te.toggleActorSelection(t,s,o,this)}_updateActorSelectionUI(t){return te.updateActorSelectionUI(t,this)}_updateRequestTypesVisibility(){return te.updateRequestTypesVisibility(this)}_updateRequestTypesVisibilityNoRender(){return te.updateRequestTypesVisibilityNoRender(this)}_updateSelectAllState(){return te.updateSelectAllState(this)}_onSearchInput(t){const s=t.target.value.toLowerCase().trim();if(this.selectedSubmenu==="request-types"){const o=this.element.querySelector(".request-types");if(!o)return;o.querySelectorAll(".request-type-item").forEach(a=>{var d;const l=((d=a.querySelector(".request-type-name"))==null?void 0:d.textContent.toLowerCase())||"",n=a.querySelectorAll(".sub-item");let r=!1;if(n.length>0){n.forEach(h=>{var S;const y=(((S=h.querySelector(".sub-item-name"))==null?void 0:S.textContent.toLowerCase())||"").includes(s);h.classList.toggle("hidden",!y),y&&(r=!0)});const g=l.includes(s),f=s===""||g||r;if(a.classList.toggle("hidden",!f),s&&r){const h=a.querySelector(".roll-types-nested"),R=a.querySelector(".accordion-toggle");h&&R&&(h.style.display="block",R.classList.add("expanded"))}}else{const g=s===""||l.includes(s);a.classList.toggle("hidden",!g)}})}else if(this.selectedSubmenu==="status-effects"){const o=this.element.querySelector(".status-effects");if(!o)return;o.querySelectorAll(".status-effect").forEach(a=>{var d,g;const l=((d=a.querySelector(".status-effect-name"))==null?void 0:d.textContent.toLowerCase())||"",n=((g=a.dataset.id)==null?void 0:g.toLowerCase())||"",r=s===""||l.includes(s)||n.includes(s);a.classList.toggle("hidden",!r)})}}async _onAccordionToggle(t){t.stopPropagation();const o=t.target.closest(".request-type-header").closest(".request-type-item"),i=o.dataset.id,a=o.querySelector(".accordion-toggle"),l=o.querySelector(".roll-types-nested");if(!l)return;const n=a.classList.contains("expanded");a.classList.toggle("expanded",!n),l.style.display=n?"none":"flex",this.accordionStates[i]=!n,await game.user.setFlag(V.ID,"menuAccordionStates",this.accordionStates)}async _onRequestTypeClick(t){const o=t.currentTarget.dataset.id,i=V.ROLL_REQUEST_OPTIONS[o];if(!i){c.error("Unknown request type:",[o]);return}this.selectedRequestType===o?this.selectedRequestType=null:this.selectedRequestType=o,i.subList?await this.render():this.selectedRequestType&&this._triggerRoll(o,null)}_onRollTypeClick(t){c.log("_onRollTypeClick");const s=t.currentTarget.dataset.id,i=t.currentTarget.dataset.parent||this.selectedRequestType;this._triggerRoll(i,s)}async _onMacroButtonClick(t){c.log("_onMacroButtonClick");const s=t.currentTarget,o=s.dataset.id||null,i=s.dataset.parent;let a,l;if(i?(a=i,l=o):(a=o,l=null),!a){ui.notifications.warn("No roll type selected for macro creation");return}const n=Array.from(this.selectedActors);if(n.length===0){ui.notifications.warn("No actors selected for macro creation");return}const r={requestType:a,rollKey:l,actorIds:n,config:{}};try{await FlashRolls5e.createMacro(r)}catch(d){c.error("Failed to create macro",[d]),ui.notifications.error("Failed to create macro: "+d.message)}}async _orchestrateRollsForActors(t,s,o,i,a,l){return Re.orchestrateRollsForActors(t,s,o,i,a,l,this)}async _handleHitDieRefill(t){return Re.handleHitDieRefill(t)}async _triggerRoll(t,s){return Re.triggerRoll(t,s,this)}async _sendRollRequestToPlayer(t,s,o,i,a,l=!1,n=null){return Re.sendRollRequestToPlayer(t,s,o,i,a,l,n)}_showConsolidatedNotification(t,s,o){return Re.showConsolidatedNotification(t,s,o)}async _handleGMRolls(t,s,o,i){return ve.handleGMRolls(t,s,o,i)}async _handleGMRollsWithTokens(t,s,o,i){return ve.handleGMRollsWithTokens(t,s,o,i)}async _initiateRollForToken(t,s,o,i,a){return ve.initiateRollForToken(t,s,o,i,a)}async _initiateRoll(t,s,o,i){return ve.initiateRoll(t,s,o,i)}async _onClose(t){if(c.log("_onClose",[t]),!!this.element){if(this.isCustomPosition&&this.element.parentElement===document.body){const s=document.querySelector("#chat-notifications");s&&s.insertBefore(this.element,s.firstChild),this.element.style.position="",this.element.style.inset="",this.element.style.top="",this.element.style.left="",this.element.style.right="",this.element.style.bottom="",this.element.classList.remove("custom-position")}await super._onClose(t),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),game.user.setFlag("flash-rolls-5e","searchFocused",!1),this._cleanupHooks(),this._cleanupTimeouts(),F(se,P)===this&&ce(se,P,null)}}setPosition(t={}){return c.log("setPosition"),this}_cleanupHooks(){[{hook:w.CONTROL_TOKEN,property:"_tokenControlHook"},{hook:w.UPDATE_ITEM,property:"_updateItemHook"},{hook:w.CREATE_ITEM,property:"_createItemHook"},{hook:w.DELETE_ITEM,property:"_deleteItemHook"}].forEach(({hook:s,property:o})=>{this[o]&&(Hooks.off(s,this[o]),this[o]=null)})}_cleanupTimeouts(){["_tokenUpdateTimeout","_actorUpdateTimeout","_itemUpdateTimeout"].forEach(s=>{this[s]&&(clearTimeout(this[s]),this[s]=null)})}static toggle(){document.querySelectorAll("#flash-rolls-menu").forEach(s=>{s.remove()}),F(this,P)?F(this,P).rendered?F(this,P).close():(F(this,P)._initializeFromSelectedTokens(),F(this,P).render(!0)):(ce(this,P,new se),F(this,P).render(!0))}static refreshIfOpen(t=!1){if(!(!F(this,P)||!F(this,P).rendered)){if(t){this._performRefresh();return}F(this,he)&&clearTimeout(F(this,he)),ce(this,he,setTimeout(()=>{this._performRefresh(),ce(this,he,null)},F(this,Ne)))}}static _performRefresh(){!F(this,P)||!F(this,P).rendered||(F(this,P).render(),A.updateColorScheme(),F(this,P).element.classList.add("theme-"+A.coreColorScheme))}getSelectedActorElements(){return this.element?Array.from(this.element.querySelectorAll(".actor.drag-wrapper.selected")):[]}static showOnLoadIfEnabled(){var o;const t=O();A.get(t.showMenuOnLoad.tag)&&game.user.isGM&&(document.querySelectorAll("#flash-rolls-menu").forEach(a=>{a.remove()}),F(this,P)?F(this,P).rendered||F(this,P)._initializeFromSelectedTokens():ce(this,P,new se),(o=F(this,P))==null||o.render(!0),F(this,P)&&(F(this,P).isLocked=!0))}};P=new WeakMap,he=new WeakMap,Ne=new WeakMap,re(se,P,null),re(se,he,null),re(se,Ne,250),D(se,"DEFAULT_OPTIONS",{id:"flash-rolls-menu",classes:["flash-rolls-menu","placeable-hud"],tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:{},dragDrop:[{dropSelector:".actor-list"}]}),D(se,"PARTS",{main:{template:`modules/${V.ID}/templates/requests-menus.hbs`}});let Z=se;const oe=class oe{static registerSettings(){const e=O();var t=oe.get(e.debugMode.tag);t&&(CONFIG.debug.hooks=!0),Object.entries(e).forEach(o=>{const i=o[1],a={name:i.label,hint:i.hint,default:i.default,type:i.propType,scope:i.scope,config:i.config,requiresReload:i.requiresReload||!1,restricted:i.scope===G.world,onChange:l=>oe.apply(i.tag,l)};i.choices&&(a.choices=i.choices),c.log("registerSettings",[a,a.scope]);try{game.settings.register(b,i.tag,a)}catch(l){c.log(`Setting ${i.tag} already registered or error:`,l)}})}static registerSettingsMenu(){var t;const e=Object.entries(dt());for(const[s,o]of e)if(o.restricted&&((t=game.user)!=null&&t.isGM)||!o.restricted){const i={name:o.tag,label:o.label,hint:o.hint,icon:o.icon,type:o.propType,restricted:o.restricted};game.settings.registerMenu(b,o.tag,i)}oe.updateColorScheme()}static updateColorScheme(){var t;const e=game.settings.get("core","uiConfig");oe.coreColorScheme=((t=e==null?void 0:e.colorScheme)==null?void 0:t.interface)||"dark",c.log("SettingsUtil.updateColorScheme",[e,oe.coreColorScheme])}static get(e,t=b){if(!e)return null;let s=!1;try{if(t===b)s=game.settings.get(t,e);else{let i=game.settings.storage.get("client")[`${t}.${e}`];i===void 0&&(i=game.settings.storage.get("world").getSetting(`${t}.${e}`),s=i==null?void 0:i.value)}}catch{return c.log(`Setting ${t}.${e} not found, returning false`),!1}return s}static set(e,t,s=b){if(!e)return!1;let o=game.settings.storage.get("client")[`${s}.${e}`];o||(o=game.settings.storage.get("world").getSetting(`${s}.${e}`),c.log("SettingsUtil.set - world Setting?",[o]));try{game.settings.set(s,e,t),c.log("SettingsUtil.set - success",[s,e,t])}catch(i){c.error("SettingsUtil.set - error",[i])}return!0}static apply(e,t){const s=O();switch(e){case s.rollRequestsEnabled.tag:oe.applyRollRequestsEnabled(t);break;case s.compactMode.tag:oe.applyCompactMode(t);break}}static applyRollRequestsEnabled(e){const t=document.querySelector(".chat-controls .flash-rolls-icon");t&&(e?t.classList.add("active"):t.classList.remove("active"))}static applyCompactMode(e){const t=O(),s=e||oe.get(t.compactMode.tag);c.log("applyCompactMode",[s]),Z.refreshIfOpen()}};D(oe,"coreColorScheme","dark");let A=oe;class Ut{static initialize(){c.log("ActorDirectoryIconUtil.initialize"),Hooks.on(w.RENDER_ACTOR_DIRECTORY,this.onRenderActorDirectory.bind(this)),Hooks.on(w.UPDATE_ACTOR,this.onUpdateActor.bind(this)),this.updateExistingDirectory()}static updateExistingDirectory(){const e=ui.actors;e&&e.rendered&&e.element?(c.log("ActorDirectoryIconUtil.updateExistingDirectory - Found rendered directory, adding icons"),this.onRenderActorDirectory(e,e.element)):c.log("ActorDirectoryIconUtil.updateExistingDirectory - No rendered directory found")}static onRenderActorDirectory(e,t){t.querySelectorAll(".directory-item.actor").forEach(o=>{const i=o.dataset.entryId||o.dataset.documentId;i&&this.updateActorIcon(o,i)})}static onUpdateActor(e,t){var o;const s=(o=t.flags)==null?void 0:o["flash-rolls-5e"];s&&(c.log("ActorDirectoryIconUtil.onUpdateActor - Flash Rolls flags changed",[e.name,s]),this.refreshActorIcon(e.id))}static updateActorIcon(e,t){const s=e.querySelector("span.fas.fa-bolt, span.fas.fa-bolt-slash");s&&s.remove();const o=game.actors.get(t);if(!o)return;const i=ee.isFavorite(o),a=ee.isBlocked(o);if(!i&&!a)return;const l=document.createElement("span");a?(l.className="fas fa-bolt-slash",l.title="Blocked from Flash Rolls menu"):i&&(l.className="fas fa-bolt",l.title="Added to Flash Rolls menu"),e.appendChild(l)}static refreshActorIcon(e){const t=document.querySelector(`.directory-item.actor[data-entry-id="${e}"], .directory-item.actor[data-document-id="${e}"]`);t&&this.updateActorIcon(t,e)}static refreshAllIcons(){c.log("ActorDirectoryIconUtil.refreshAllIcons"),document.querySelectorAll(".directory-item.actor").forEach(t=>{const s=t.dataset.entryId||t.dataset.documentId;s&&this.updateActorIcon(t,s)})}}const J=class J{static initialize(){Hooks.once(w.INIT,this._onInit.bind(this)),Hooks.once(w.READY,this._onReady.bind(this)),Hooks.on("flash-rolls-5e.ready",()=>{c.log("flash-rolls-5e.ready hook",[])}),Hooks.on(w.GET_CHAT_MESSAGE_CONTEXT_OPTIONS,(e,t)=>{c.log("getChatMessageContextOptions hook",[e,t]),game.user.isGM&&this._addGroupRollContextOptions(e,t)}),Hooks.once(w.GET_ACTOR_CONTEXT_OPTIONS,(e,t)=>{c.log("getActorContextOptions hook",[e,t]),game.user.isGM&&(t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.unblockFromMenu"),icon:'<i class="fas fa-bolt"></i>',callback:s=>{const o=s.dataset.entryId;return o&&ee.toggleBlocked(o,!1),o},condition:s=>{var a;const o=(a=s==null?void 0:s.dataset)==null?void 0:a.entryId;return ee.isBlocked(o)}}),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.blockFromMenu"),icon:'<i class="fas fa-bolt-slash"></i>',callback:s=>{const o=s.dataset.entryId;return o&&ee.toggleBlocked(o,!0),o},condition:s=>{var a;const o=(a=s==null?void 0:s.dataset)==null?void 0:a.entryId;return!ee.isBlocked(o)}}))})}static _addGroupRollContextOptions(e,t){c.log("_addGroupRollContextOptions",[e,t]),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.hideNPCsFromPlayers"),icon:'<i class="fas fa-eye-slash"></i>',callback:s=>{const o=s.dataset.messageId,i=game.messages.get(o);i&&(i.setFlag(b,"npcHiddenOverride",!0),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.npcHiddenFromPlayers")))},condition:s=>{const o=s.dataset.messageId;if(!o)return!1;const i=game.messages.get(o);if(!i||!i.getFlag(b,"isGroupRoll"))return!1;const a=O(),l=A.get(a.groupRollNPCHidden.tag),n=i.getFlag(b,"npcHiddenOverride");return!(n!==void 0?n:l)}}),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.showNPCsToPlayers"),icon:'<i class="fas fa-eye"></i>',callback:s=>{const o=s.dataset.messageId,i=game.messages.get(o);if(i){const a=O();A.get(a.groupRollNPCHidden.tag)?i.setFlag(b,"npcHiddenOverride",!1):i.unsetFlag(b,"npcHiddenOverride"),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.npcVisibleToPlayers"))}},condition:s=>{const o=s.dataset.messageId;if(!o)return!1;const i=game.messages.get(o);if(!i||!i.getFlag(b,"isGroupRoll"))return!1;const a=O(),l=A.get(a.groupRollNPCHidden.tag),n=i.getFlag(b,"npcHiddenOverride");return n!==void 0?n:l}})}static _onInit(){O(),document.body.classList.add("flash5e"),A.registerSettings(),me.initialize(),this._registerHooks()}static _onReady(){var e;A.registerSettingsMenu(),Ut.initialize(),Be.addSidebarControls(ui.sidebar,(e=ui.sidebar)==null?void 0:e.element),Ae.isModuleActive("midi-qol")?Hooks.once(It.READY,this._initModule.bind(this)):this._initModule(),c.log("HooksUtil.ready",[CONFIG.statusEffects])}static async _initModule(){const e=O();A.get(e.debugMode.tag)&&(CONFIG.debug.hooks=!0),await $.initialize(),game.user.isGM?(Ke.initialize(),this._registerGMHooks(),Z.showOnLoadIfEnabled()):(me.getDiceConfig(),this._registerPlayerHooks()),tt(et());const s=game.modules.get("flash-rolls-5e");s&&(s.api=Ve),globalThis.FlashRolls5e=Ve,Hooks.call("flash-rolls-5e.ready")}static _registerHooks(){this._registerHook(w.RENDER_SIDEBAR,this._onRenderSidebar.bind(this)),this._registerHook(w.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessage.bind(this)),this._registerHook(w.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageFlavor.bind(this)),this._registerHook(w.RENDER_CHAT_MESSAGE,this._onRenderChatMessageHTML.bind(this)),this._registerHook(w.RENDER_CHAT_LOG,this._onRenderChatLog.bind(this)),this._registerHook(w.CHANGE_SIDEBAR_TAB,this._onSidebarUpdate.bind(this)),this._registerHook(w.COLLAPSE_SIDE_BAR,this._onSidebarUpdate.bind(this)),this._registerHook(w.REFRESH_MEASURED_TEMPLATE,this.onRefreshTemplate.bind(this)),this._registerHook(B.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this)),this._registerHook(B.RENDER_SKILL_TOOL_ROLL_DIALOG,this._onRenderSkillToolDialog.bind(this)),this._registerHook(B.PRE_USE_ACTIVITY,this._onPreUseActivity.bind(this)),this._registerHook(B.POST_USE_ACTIVITY,this._onPostUseActivity.bind(this)),this._registerHook(B.PRE_ROLL_HIT_DIE_V2,this._onPreRollHitDieV2.bind(this)),this._registerHook(B.POST_ROLL_CONFIG,this._onPostRollConfig.bind(this))}static _registerGMHooks(){this._registerHook(w.USER_CONNECTED,this._onUserConnected.bind(this)),this._registerHook(w.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageGM.bind(this)),this._registerHook(B.PRE_ROLL_V2,this._onPreRoll.bind(this)),this._registerHook(w.CREATE_TOKEN,this._onTokenChange.bind(this)),this._registerHook(w.DELETE_TOKEN,this._onTokenChange.bind(this)),this._registerHook(w.UPDATE_SETTING,this._onSettingUpdate.bind(this)),this._registerHook(w.UPDATE_SCENE,this._onSceneUpdate.bind(this)),this._registerHook(w.UPDATE_ACTOR,this._onActorUpdate.bind(this)),game.users.forEach(e=>{this._onUserConnected(e)})}static _registerPlayerHooks(){this._registerHook(B.PRE_ROLL_INITIATIVE_DIALOG,this._onPreRollInitiativeDialog.bind(this)),this._registerHook(B.PRE_ROLL_ATTACK_V2,this._onPreRollAttackV2.bind(this)),this._registerHook(B.PRE_ROLL_DAMAGE_V2,this._onPreRollDamageV2.bind(this)),Hooks.on(B.PRE_ROLL_ABILITY_CHECK,(e,t,s)=>{c.log("_onPreRollAbilityCheckV2",[e,t,s]),e.isRollRequest&&(t.configure=!0)})}static _onSidebarUpdate(e){c.log("_onSidebarUpdate",[e]),tt(et())}static _onPostRollConfig(e,t,s,o){t._showRequestedBy&&e.length>0&&(o.data=o.data||{},o.data._showRequestedBy=!0,o.data._requestedBy=t._requestedBy)}static _onPreCreateChatMessage(e,t,s,o){var i,a,l,n,r,d,g,f,h,R;if(t._showRequestedBy&&((i=t.rolls)==null?void 0:i.length)>0){const y=t._requestedBy||"GM",S=game.i18n.format("FLASH_ROLLS.chat.requestedBy",{gm:y}),m=t.flavor||"";t.flavor=m?`${m} ${S}`:S}if((l=(a=t.flags)==null?void 0:a[b])!=null&&l.groupRollId&&c.log("_onPreCreateChatMessage - Found groupRollId in data flags",[t]),((n=t.rolls)==null?void 0:n.length)>0||(d=(r=t.flags)==null?void 0:r.core)!=null&&d.initiativeRoll){const y=t.speaker,S=y==null?void 0:y.actor;if(S){let m=game.actors.get(S);if(!m&&(y!=null&&y.token)){const L=canvas.tokens.get(y.token);L!=null&&L.actor&&(m=L.actor,c.log("_onPreCreateChatMessage - Using token actor from speaker",[m.name,m.id]))}if(!m){c.log("_onPreCreateChatMessage - No actor found",[S,y]);return}if(game.user.isGM){const L=m.isToken?(g=m.actor)==null?void 0:g.id:m.id,T=[S,L].filter(I=>I);for(const[I,E]of $.pendingRolls.entries()){const C=E.actorEntries||(E.actors?E.actors.map(N=>({actorId:N})):[]);if(T.some(N=>C.some(k=>k.actorId===N))){t.flags=t.flags||{},t.flags[b]=t.flags[b]||{},t.flags[b].groupRollId=I,t.flags.rsr5e={processed:!0,quickRoll:!1},c.log("_onPreCreateChatMessage - Added groupRollId flag (GM)",[I,S]);break}}}else{let L=m.getFlag(b,"tempGroupRollId");if(!L&&m.isToken){const I=game.actors.get((f=m.actor)==null?void 0:f.id);I&&(L=I.getFlag(b,"tempGroupRollId"),c.log("_onPreCreateChatMessage - Checking base actor for tempGroupRollId",[I.id,L]))}if(L&&(m.unsetFlag(b,"tempGroupRollId"),m.isToken)){const I=game.actors.get((h=m.actor)==null?void 0:h.id);I&&I.unsetFlag(b,"tempGroupRollId")}let T=m.getFlag(b,"tempInitiativeConfig");if(!T&&m.isToken){const I=game.actors.get((R=m.actor)==null?void 0:R.id);I&&(T=I.getFlag(b,"tempInitiativeConfig"))}(T!=null&&T.groupRollId||L)&&(t.flags=t.flags||{},t.flags[b]=t.flags[b]||{},t.flags[b].groupRollId=L||(T==null?void 0:T.groupRollId)||"",t.flags.rsr5e={processed:!0,quickRoll:!1})}}}}static _onPreCreateChatMessageFlavor(e,t,s,o){var i,a;if(((i=t.rolls)==null?void 0:i.length)>0&&t.rolls[0])try{const l=t.rolls[0];(a=l.options)!=null&&a._customFlavor&&(t.flavor=l.options._customFlavor)}catch(l){c.error("_onPreCreateChatMessageFlavor",[l])}}static _onRenderRollConfigDialog(e,t,s){var i,a,l,n,r;if(c.log("_onRenderRollConfigDialog #0",[e,s]),e._flashRollsApplied)return;if(((a=(i=e.config)==null?void 0:i.hookNames)==null?void 0:a.includes("initiativeDialog"))||((n=(l=e.element)==null?void 0:l.id)==null?void 0:n.includes("initiative"))){const d=(r=e.config)==null?void 0:r.subject;if(!d)return;if(e._flashRollsTitleApplied||(t.querySelector(".window-title").textContent=game.i18n.localize("DND5E.Initiative"),t.querySelector(".window-subtitle").textContent=d.name,e._flashRollsTitleApplied=!0),d.getFlag(b,"tempInitiativeConfig")){e._flashRollsApplied=!0;const f=t.querySelector('input[name*="situational"]');setTimeout(()=>{f.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},50)}return}else t.querySelectorAll('input[name*="situational"]').forEach((g,f)=>{var h,R,y,S,m,L,T;c.log("_onRenderRollConfigDialog - processing input",[f,g.name,g.value]),!g.value&&((S=(y=(R=(h=e.config)==null?void 0:h.rolls)==null?void 0:R[0])==null?void 0:y.data)!=null&&S.situational)&&(g.value=e.config.rolls[0].data.situational),e.config.scaling=!0,g.value&&(e._flashRollsApplied=!0,(T=(L=(m=e.config)==null?void 0:m.rolls)==null?void 0:L[0])!=null&&T.data&&delete e.config.rolls[0].data.situational,setTimeout(()=>{g.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},150))})}static _onPreCreateChatMessageGM(e,t,s,o){}static _onRenderChatMessageHTML(e,t,s){var o,i,a,l,n,r,d,g,f,h,R;if($.interceptRollMessage(e,t,s),!game.user.isGM&&e.author===game.user&&(((i=(o=e.flags)==null?void 0:o[b])==null?void 0:i.isFlashRollRequest)||((l=(a=e.flags)==null?void 0:a[b])==null?void 0:l.groupRollId)||((n=e.getFlag("dnd5e","roll"))==null?void 0:n._requestedBy))&&game.settings.get("dnd5e","challengeVisibility")==="hide"){t.find("[data-display-challenge]").each((T,I)=>{delete I.dataset.displayChallenge});const L=t.find(".dice-total");L.removeClass("success failure critical fumble"),L.find(".icons").remove(),t.find(".save-dc, .dc, .target-dc").each((T,I)=>{const E=I.textContent;E&&E.includes("DC")&&(I.textContent=E.replace(/DC\s*\d+/gi,"DC ?"))})}if(e.getFlag(b,"isGroupRoll")){const y=O(),S=A.get(y.groupRollNPCHidden.tag),m=e.getFlag(b,"npcHiddenOverride"),L=game.user.isGM;if((m!==void 0?m:S)&&!L){const I=e.getFlag(b,"rollData");I&&I.results&&t.querySelectorAll(".actor-result").forEach((C,N)=>{const k=I.results[N];if(k){const M=game.actors.get(k.actorId);M&&!M.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER)&&C.classList.add("npc-hidden")}})}$._attachGroupRollListeners(t,e)}if(this._addSelectTargetsButton(e,t),game.user.isGM){let y=(r=s.subject)==null?void 0:r.item;!y&&((f=(g=(d=e.flags)==null?void 0:d.dnd5e)==null?void 0:g.item)!=null&&f.uuid)&&(y=fromUuidSync(e.flags.dnd5e.item.uuid)),c.log("_onRenderChatMessageHTML - item",[y,s,(R=(h=e.flags)==null?void 0:h.dnd5e)==null?void 0:R.item]),y&&setTimeout(()=>{J.activityConfigCache.delete(y.id),c.log("_onRenderChatMessageHTML - cleared activity config cache",[y.id]),H.removeTemplateForItem(y)},3e3)}return c.log("_onRenderChatMessageHTML",[e,t,s]),!1}static _addSelectTargetsButton(e,t){var o,i,a;if(!game.user.isGM||(c.log("_addSelectTargetsButton #0",[e,t,t.querySelector(".message-content")]),((a=(i=(o=e.flags)==null?void 0:o.dnd5e)==null?void 0:i.roll)==null?void 0:a.type)!=="damage"||t.querySelector(".select-targeted")))return;const s=document.createElement("button");s.className="select-targeted",s.type="button",s.setAttribute("data-tooltip-direction","LEFT"),s.setAttribute("data-tooltip","Select Targeted"),s.innerHTML='<i class="fas fa-crosshairs"></i>',s.addEventListener("click",l=>{l.preventDefault(),this._selectTargetedTokens(l)}),t.querySelector(".message-content").appendChild(s),e.update({content:t})}static _selectTargetedTokens(e){const t=e.currentTarget.closest(".chat-message"),s=t.querySelectorAll("[data-target-uuid]");if(s.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noTargetedTokens"));return}c.log("_selectTargetedTokens",[t,s,canvas.tokens.placeables,game.scenes.active]);for(let o=0;o<s.length;o++){const a=s[o].dataset.targetUuid.split("Actor.")[1],l=canvas.tokens.placeables.find(n=>n.document.actorId===a);l==null||l.control({releaseOthers:o===0})}}static _onUserConnected(e){e.active&&e.id!==game.user.id&&me.requestDiceConfigFromUser(e.id)}static _onTokenChange(e,t,s){c.log("HooksUtil._onTokenChange - Re-rendering roll requests menu due to token create/delete"),Z.refreshIfOpen()}static _onSettingUpdate(e,t,s,o){const i=O(),a={ID:"flash-rolls-5e"};e.key===`${a.ID}.${i.showOnlyPCsWithToken.tag}`?(c.log("HooksUtil._onSettingUpdate - Re-rendering roll requests menu due to setting change",[e.key]),Z.refreshIfOpen()):e.key==="core.uiConfig"&&(A.updateColorScheme(),Z.refreshIfOpen())}static _onSceneUpdate(e,t,s,o){t.active===!0&&(c.log("HooksUtil._onSceneUpdate - Re-rendering roll requests menu due to active scene change"),Z.refreshIfOpen())}static _onActorUpdate(e,t,s,o){var l,n,r,d,g,f,h,R,y,S,m,L;c.log("HooksUtil._onActorUpdate",[e,t]);const i=t["==ownership"]!==void 0;!((n=(l=t.system)==null?void 0:l.attributes)!=null&&n.hp||(d=(r=t.system)==null?void 0:r.attributes)!=null&&d.ac||(h=(f=(g=t.system)==null?void 0:g.attributes)==null?void 0:f.spell)!=null&&h.dc||(y=(R=t.system)==null?void 0:R.skills)!=null&&y.prc||(S=t.system)!=null&&S.abilities||(L=(m=t.system)==null?void 0:m.attributes)!=null&&L.prof)&&!i||(c.log("HooksUtil._onActorUpdate - Re-rendering roll requests menu due to actor update",[e,t]),Z.refreshIfOpen())}static _onRenderApplicationV2(e,t,s){c.log("_onRenderApplicationV2",[e,t,s])}static _onRenderChatLog(e,t){t.querySelectorAll(".flash5e-group-roll").forEach(o=>{const i=o.closest(".chat-message");if(i){const a=i.dataset.messageId,l=game.messages.get(a);if(l&&l.getFlag(b,"isGroupRoll")){const n=O(),r=A.get(n.groupRollNPCHidden.tag),d=l.getFlag(b,"npcHiddenOverride"),g=game.user.isGM;if((d!==void 0?d:r)&&!g){const h=l.getFlag(b,"rollData");h&&h.results&&o.querySelectorAll(".actor-result").forEach((y,S)=>{const m=h.results[S];if(m){const L=game.actors.get(m.actorId);L&&!L.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER)&&y.classList.add("npc-hidden")}})}$._attachGroupRollListeners(o,l)}}})}static _onRenderSidebar(e,t,s){c.log("_onRenderSidebar",[e,t]),game.ready&&Be.addSidebarControls(e,t)}static _registerHook(e,t){const s=Hooks.on(e,t);return this.registeredHooks.set(`${e}_${s}`,s),s}static unregisterAll(){this.registeredHooks.forEach((e,t)=>{const s=t.split("_")[0];Hooks.off(s,e)}),this.registeredHooks.clear()}static isRegistered(e){for(const t of this.registeredHooks.keys())if(t.startsWith(`${e}_`))return!0;return!1}static _onPreRoll(e,t,s,o){var i;if(c.log("_onPreRoll #0",[e,t,s,o]),(i=e.subject)!=null&&i.item){const a=e.subject.item.getFlag(b,"tempAttackConfig");c.log("_onPreRoll - flag",[a]),(a==null?void 0:a.skipRollDialog)===!0&&(t.configure=!1,c.log("_onPreRoll - Local GM roll, skipping dialog via stored flag"))}}static _onPreRollHitDieV2(e,t,s){if(c.log("_onPreRollHitDieV2 triggered",[e,t,s]),e.rolls&&e.rolls.length>1){const o=[];for(let i=0;i<e.rolls.length;i++){const a=e.rolls[i];a&&a.data&&a.data.situational&&o.push(a.data.situational)}if(o.length>0){e.rolls[0].data||(e.rolls[0].data={});const i=[...new Set(o)];e.rolls[0].data.situational=i.map(a=>{const l=a.toString().trim();return l.startsWith("-")?`(${l})`:l.startsWith("+")?`${l.substring(1)}`:`${l}`}).join(" + "),game.user.isGM&&!e.rolls[0].parts.find(a=>a.includes("@situational"))&&e.rolls[0].parts.push("@situational")}e.rolls=e.rolls.slice(0,1),c.log("Cleaned up hit die rolls",e.rolls)}}static _onPreRollInitiativeDialog(e,t,s){var a,l,n,r,d;const i=e.subject.getFlag(b,"tempInitiativeConfig");c.log("_onPreRollInitiativeDialog triggered",[e,i,t,s]),e.advantage=(i==null?void 0:i.advantage)||e.advantage||!1,e.disadvantage=(i==null?void 0:i.disadvantage)||e.disadvantage||!1,e.rollMode=(i==null?void 0:i.rollMode)||e.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,s.rollMode=(i==null?void 0:i.rollMode)||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,(n=(l=(a=i.rolls)==null?void 0:a[0])==null?void 0:l.data)!=null&&n.situational&&((d=(r=e.rolls)==null?void 0:r[0])!=null&&d.data)&&(e.rolls[0].data.situational=i.rolls[0].data.situational)}static _onPreRollAttackV2(e,t,s){var i,a;c.log("_onPreRollAttackV2 triggered",[e,t,s]);const o=(a=(i=e.subject)==null?void 0:i.item)==null?void 0:a.getFlag(b,"tempAttackConfig");o&&(c.log("_onPreRollAttackV2 - flag",[o]),o.attackMode&&(e.attackMode=o.attackMode),o.ammunition&&(e.ammunition=o.ammunition),o.mastery!==void 0&&(e.mastery=o.mastery),e.advantage=o.advantage||!1,e.disadvantage=o.disadvantage||!1,s.rollMode=o.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,o.skipRollDialog===!0&&(t.configure=!1,c.log("_onPreRollAttackV2 - Local GM roll, skipping dialog",[o])),o.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=o.situational),c.log("_onPreRollAttackV2 - Applied stored configuration to attack roll",[e,s]))}static _onPreRollDamageV2(e,t,s){var i,a,l;const o=(a=(i=e.subject)==null?void 0:i.item)==null?void 0:a.getFlag(b,"tempDamageConfig");c.log("_onPreRollDamageV2 triggered #0",[e,t,s]),e.rolls=_.consolidateRolls(e.rolls),e.midiOptions&&!game.user.isGM&&((l=e.subject)==null?void 0:l.type)===ae.DAMAGE&&(t.configure=!0),o&&(c.log("_onPreRollDamageV2 - Found stored request config from flag",[o,o.situational]),o.critical&&(e.critical=o.critical),s.rollMode=o.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,o.skipRollDialog===!0&&(t.configure=!1,c.log("_onPreRollDamageV2 - Local GM roll, skipping dialog",[o])),c.log("_onPreRollDamageV2 triggered #1",[e,t,s]),o.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=o.situational,e._flashRollsSituational=o.situational),c.log("_onPreRollDamageV2 - Applied stored configuration to damage roll",[e,s]))}static _onPreUseActivity(e,t,s,o){c.log("_onPreUseActivity #0",[e,t,s,o]);const i=O(),a=A.get(i.rollRequestsEnabled.tag),l=A.get(i.rollInterceptionEnabled.tag);if(!a||!l)return;const n=e.actor,r=H.getActorOwner(n),d=Ge(n)&&r.active,g=game.users.isGM&&!d||!t.isRollRequest;if(c.log("_onPreUseActivity #1 - isLocalRoll",[t.create,g]),e.item.unsetFlag(b,"tempAttackConfig"),e.item.unsetFlag(b,"tempDamageConfig"),e.item.unsetFlag(b,"tempSaveConfig"),!n)return;const f=ft();s.configure=s.configure?f:!1,t.consume=we(t.consume||{}),t.create=ze(t.create||{},g),t.midiOptions&&(e.type===ae.DAMAGE||e.type===ae.SAVE)&&(s.configure=!1,e.midiOptions={...t.midiOptions,fastForwardDamage:!1,workflowOptions:{fastForwardDamage:!1,autoRollAttack:!1,autoRollDamage:!1,forceCompletion:!1}},t.midiOptions={...t.midiOptions,fastForwardDamage:!1,workflowOptions:{...t.midiOptions.workflowOptions,fastForwardDamage:!1,autoRollAttack:!1,autoRollDamage:!1}},c.log("_onPreUseActivity - activity",[e])),game.user.isGM&&r&&r.active&&!r.isGM&&s.configure===!0&&(c.log("Preventing usage message for player-owned actor",[n.name]),o.create=!1)}static _onPostUseActivity(e,t,s){var d,g;const o=O(),i=A.get(o.skipRollDialog.tag),a=A.get(o.rollRequestsEnabled.tag),l=A.get(o.rollInterceptionEnabled.tag);if(game.user.isGM,c.log("_onPostUseActivity #0",[e,t,s]),!game.user.isGM&&t.midiOptions&&(t.midiOptions={...t.midiOptions,fastForwardDamage:!1,workflowOptions:{...t.midiOptions.workflowOptions,fastForwardDamage:!1,autoRollAttack:!1,autoRollDamage:!1,forceCompletion:!1}}),!a||!l)return;const n=H.getActorOwner(e.actor),r=n&&n.active&&!n.isGM;if(s.configure=game.user.isGM&&t.skipRollDialog!==void 0?!t.skipRollDialog:!game.user.isGM||r&&!i,t.skipRollDialog===!1&&(!(n!=null&&n.active)||n.isGM)){c.log("Preventing usage message - no owning player for actor",[e.actor]);return}if(game.user.isGM&&e.item){const f={spell:t.spell||{},scaling:t.scaling,consume:t.consume||{},create:t.create||{}},h=e.item.id;J.activityConfigCache.set(h,f),c.log("_onPostUseActivity - storing activity config in cache",[h,f]),setTimeout(()=>{J.activityConfigCache.delete(h),c.log("_onPostUseActivity - cleared old cache entry",[h])},3e4)}e.type===ae.SAVE&&((g=(d=e.damage)==null?void 0:d.parts)==null?void 0:g.length)>0&&(c.log("_onPostUseActivity #1 - roll triggered",[e,t]),e.rollDamage(t,{configure:t.skipRollDialog!==void 0?!t.skipRollDialog:!game.user.isGM||r&&!i},{}))}static _onRenderSkillToolDialog(e,t,s){var i,a;if(c.log("_onRenderSkillToolDialog triggered",[e]),e._abilityFlavorFixed)return;const o=t.querySelector('select[name="ability"]');if(o&&(i=e.config)!=null&&i.isRollRequest&&(a=e.config)!=null&&a.ability){const l=o.value,n=e.config.ability;l===n&&(e._abilityFlavorFixed=!0,setTimeout(()=>{const r=new Event("change",{bubbles:!0,cancelable:!0});o.dispatchEvent(r)},50))}}static onRefreshTemplate(e,t){if(!e.isOwner)return;const s=`refresh-template-${e.id}`,o=O(),i=A.get(o.templateAutoTarget.tag);J.throttleTimers[s]&&clearTimeout(J.throttleTimers[s]),J.throttleTimers[s]=setTimeout(()=>{let a=3;switch(i){case 1:a=3;break;case 2:a=0;break;default:return}game.user.targets.forEach(n=>n.setTarget(!1,{releaseOthers:!1}));const l=[];for(let n of canvas.tokens.placeables)n.document.disposition<=a&&e.shape.contains(n.center.x-e.x,n.center.y-e.y)&&l.push(n);l.forEach((n,r)=>{n.setTarget(!0,{releaseOthers:r===0,groupSelection:!0})}),l.length>0&&game.user.broadcastActivity({targets:game.user.targets.ids}),delete J.throttleTimers[s]},50)}};D(J,"registeredHooks",new Map),D(J,"midiTimeout",null),D(J,"throttleTimers",{}),D(J,"activityConfigCache",new Map);let Ce=J;class je{static async handleRequest(e){var o,i;const t=H.isModuleOn(b,"midi-qol");if(c.log("handleRequest",[e]),game.user.isGM)return;let s;if(e.isTokenActor){const a=(o=game.scenes.active)==null?void 0:o.tokens.get(e.actorId);if(s=a==null?void 0:a.actor,!s){c.warn("Token actor not found:",e.actorId);return}}else s=game.actors.get(e.actorId);!s||!s.isOwner||(e.preserveTargets&&((i=e.targetTokenIds)==null?void 0:i.length)>0&&(c.log("handleRequest - applyTargetTokens",[e]),vt(e.targetTokenIds)),t&&e.rollProcessConfig.midiOptions&&(e.rollProcessConfig.midiOptions={...e.rollProcessConfig.midiOptions,fastForward:!1,fastForwardAttack:!1,dialogOptions:{...e.rollProcessConfig.midiOptions.dialogOptions,fastForward:!1,fastForwardAttack:!1},workflowOptions:{...e.rollProcessConfig.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1}}),j.notify("info","",{batch:!0,batchData:{actor:s.name,rollType:e.rollType,rollKey:e.rollKey,gm:e.rollProcessConfig._requestedBy||"GM"}}),this.rollQueue.push({actor:s,requestData:e}),c.log("handleRequest - Added to queue",[this.rollQueue.length,this.isProcessingRoll]),this.isProcessingRoll||this.processNextRoll())}static async processNextRoll(){if(this.rollQueue.length===0){this.isProcessingRoll=!1;return}this.isProcessingRoll=!0;const{actor:e,requestData:t}=this.rollQueue.shift();c.log("processNextRoll - Processing",[e.name,this.rollQueue.length,"remaining"]);try{await this.executePlayerRollRequest(e,t)}catch(s){c.error("Error processing roll request:",[s])}setTimeout(()=>{this.processNextRoll()},500)}static async executePlayerRollRequest(e,t){var o,i;const s=O();A.get(s.publicPlayerRolls.tag),c.log("executePlayerRollRequest",[e,t]),c.log("executePlayerRollRequest - groupRollId check",[t.groupRollId,typeof t.groupRollId]);try{const a=(o=t.rollType)==null?void 0:o.toLowerCase(),l=((i=t.rollProcessConfig.rolls)==null?void 0:i[0])||{parts:[],data:{},options:{}},r={configure:!(game.user.isGM?t.skipRollDialog:!1)},d=t.rollProcessConfig.rollMode,g=game.settings.get("core","rollMode"),h={rollMode:d||g,create:t.rollProcessConfig.chatMessage!==!1,flags:{[b]:{isFlashRollRequest:!0}}},R={rollKey:t.rollKey,activityId:t.activityId,config:t.rollProcessConfig,groupRollId:t.groupRollId},y=K[a];y?await y(e,R,l,r,h):(c.warn(`No handler found for roll type: ${a}`),j.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"})))}catch(a){c.error("Error executing roll request:",[a]),j.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"}))}}}D(je,"rollQueue",[]),D(je,"isProcessingRoll",!1);class ye{static init(){le.initialize(ye.registerSocketCalls),Ce.initialize()}static getDiceConfig(){return me.getDiceConfig()}static receiveDiceConfig(e,t){me.receiveDiceConfig(e,t)}static async handleRollRequest(e){return c.log("Main.handleRollRequest",e),je.handleRequest(e)}static registerSocketCalls(){le.registerCall(qe.getDiceConfig,ye.getDiceConfig),le.registerCall(qe.receiveDiceConfig,ye.receiveDiceConfig),le.registerCall(qe.handleRollRequest,ye.handleRollRequest)}}ye.init();
//# sourceMappingURL=flash-rolls-5e.js.map
