{"version":3,"mappings":"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","names":["libWrapper","TGT_SPLIT_RE","TGT_CLEANUP_RE","package_id","target","fn","type","chain","bind","_a","is_setter","split","x","root_nm","fn_name","obj","fn_nm","_eval","y","iObj","descriptor","original","wrapper","args","ICON_TYPES","MODULE_ACTION_ICONS","ACTOR_ACTION_ICONS","getIconConfigurations","getIconConfiguration","iconId","getDefaultIconLayout","SETTING_INPUT","SETTING_SCOPE","iconsMenuDefault","getSettings","MODULE_ID","DEBUG_TAG","SOCKET_CALLS","ACTIVITY_TYPES","DICE_OPTIONS","ROLL_TYPES","ROLL_REQUEST_OPTIONS","MODULE","HOOKS_CORE","HOOKS_SOCKET","HOOKS_MIDI_QOL","HOOKS_DND5E","HOOKS_TIDY5E","HOOKS_MODULE","LogUtil$1","ref","data","bypassSettings","debugSetting","dataArray","strRef","options","__publicField","_SocketUtil","hasRolls","LogUtil","r","result","rolls","roll","callbackFunc","e","name","func","value","callback","handler","parameters","userId","resp","error","SocketUtil","DiceConfigUtil","clientSettings","diceConfig","_b","user","config","configObj","allMethods","method","methodConfig","_GeneralUtil_static","parseCSS_fn","_GeneralUtil","message","SETTINGS","SettingsUtil","moduleName","module","_c","_d","_e","parent","selector","element","delay","varName","varValue","bodyStyle","body","existingStyle","cssText","ruleStart","ruleEnd","declarations","decl","varsMap","parts","newRuleContent","newCss","offsetTop","elementHeight","foundryFonts","customFontsObj","customFonts","fontFamily","cssImportedFonts","f","a","b","content","id","checkForDuplicates","customStyle","importRegex","imports","contentWithoutImports","match","currentContent","existingImports","currentMatch","currentContentWithoutImports","newImports","imp","allImports","to","direction","duration","onComplete","animationId","isHorizontal","start","change","startTime","animateScroll","currentTime","elapsedTime","progress","easeProgress","newAnimationId","title","dialogConfig","templatePath","templatePaths","cssString","trimmedCSS","style","testCSS","isValid","cssRules","targetSelectors","parsedCSS","__privateMethod","mainStyle","processedRules","rulesByContent","rule","pseudoSelector","combinedSelectors","s","selectors","targetList","nestedSelector","targetSelector","actor","ownership","level","item","removeTemplateSettingOn","templates","mt","templateIds","t","existingTemplates","itemUuid","event","areKeysPressed","css","baseProperties","nestedRules","lines","currentNested","braceCount","i","line","openBraces","closeBraces","contentAfterBrace","__privateAdd","fontName","cleanName","GeneralUtil","getRollTypeDisplay","rollType","rollKey","display","normalizedRollType","toolData","toolItem","getFullRollName","showBatchedNotifications","pendingNotifications","getRollTypeDisplayFn","notificationsByType","notif","key","entries","entry","FlashAPI","messages","rollTypeDisplay","actorNames","getPlayerOwner","assignedUser","offlineAssignedUser","owners","applyTargetTokens","tokenIds","index","token","getTargetDescriptors","targets","img","system","uuid","statuses","ac","isPlayerOwned","hasTokenInScene","currentScene","updateCanvasTokenSelection","actorId","selected","tokenId","tokens","specificToken","ms","resolve","isSidebarExpanded","updateSidebarClass","isExpanded","adjustMenuOffset","buildRollTypes","selectedRequestType","selectedActors","rollTypes","selectedOption","configData","label","_NotificationManager","requestsByPlayer","rollTypeName","successfulRequests","playerData","playerSummaries","playerId","NotificationManager","filterActorsForDeathSaves","actors","actorsNeedingDeathSaves","actorsSkippingDeathSaves","hp","deathSaves","successes","failures","categorizeActorsByOwnership","pcActors","npcActors","owner","rollPrivacyVertical","controlsWidth","isCrlngnUIOn","getActorData","uniqueId","tokenDoc","showConsumptionConfig","getConsumptionConfig","consume","isLocalRoll","response","getCreateConfig","createConfig","placeTemplateForPlayer","withTemplate","isMidiActive","isDnDBRoll","promptForTemplate","DnDBRollParser","rollData","_f","_g","firstRoll","messageScope","messageTarget","action","actionLower","abilityAbbrev","skillAbbrev","valueLower","abilities","abbrev","skillName","nameLower","skills","notation","set","formula","sign","results","die","actionName","activities","targetType","act","Die","DnDBRollUtil","replacer","replacerDice","noDice","ddbRoll","terms","faces","OperatorTerm","NumericTerm","operator","operatorTerm","numericTerm","d","foundryRoll","ddbDiceIndex","allDnDBDice","term","DnDBActivityUtil","activity","usage","dialog","_h","usageConfig","messageConfig","updates","effect","deleted","context","card","tooltipHtml","hasTarget","isSuccess","isFailure","activityType","ModuleHelpers","DnDBIntegration","rollInfo","workflow","DnDBRollExecutor","pendingRoll","MidiQOL","itemRequiresAttack","workflowByActivity","workflowWaiting","recentWorkflow","_i","workflows","workflowRef","matchesActivity","matchesItem","mostRecentWorkflow","hasDamage","recentMessages","flags","msgItemUuid","rollConfig","isWorkflowCompleted","total","hasTemplate","rollMode","gmIds","u","category","whisper","tool","toolConfig","initiativeTotal","combat","tokenActor","combatants","messageData","oldTemplate","usageResults","consumeSpellSlot","usageResult","speaker","typeLabel","flavor","diceHtml","advantageLabel","abilityConfig","abbr","skillConfig","abilityAbbr","abilityLabel","RollHelpers","situational","addToParts","existingConfig","newConfig","requestData","additionalConfig","dialogWillHandle","_j","_k","alreadyInRolls","normalizedType","DialogClass","dialogOptions","app","advantage","disadvantage","rollProcessConfig","isPublicRollsOn","messageRollMode","playerOwner","rollResults","dc","halfThreshold","sum","acc","average","highestModifier","leaderIndex","leaderActorId","leaderModifier","modifier","leaderResult","otherResults","adjustedResult","summaryKey","summaryData","lowestModifier","weakestActorId","weakestModifierValue","weakestResult","successWord","resultMode","calculationResult","firstDamageType","rollDamageType","consolidatedRoll","sourceRoll","part","requestedBy","isPC","isNPC","sendRequest","hasNonDigitalDice","forceSkip","forceShow","configSendRequest","configSkipRollDialog","isRollRequest","skipRollDialogOption","rollRequestsEnabled","VanillaActivityManager","hasDamageParts","itemId","activityId","BaseActivityManager","damageConfig","rollRequestConfig","_MidiActivityManager_static","isAutoAttack_fn","isAutoDamage_fn","MidiActivityManager","templateNotPlaced","isEmanation","messageOptions","hasWorkflowAttackRoll","hasWorkflowDamageRoll","isAutoAttack","hasHealingFormula","isAutoDamage","isAttackActivityDamageRequest","baseDamageConfig","skipRollDialog","skipDialogsSetting","skipDialogs","isPlayerSide","shouldForceAutoRollDamage","midiOptions","configSettings","attackActivities","damageAttackActivities","damageActivities","saveActivities","healActivities","itemSaveActivities","formulas","requestsEnabled","rollInterceptionEnabled","actorOwner","isPlayerActor","showConsumptionDialog","isOwnerActive","activityConfig","cacheKey","cacheEntry","HooksManager","shouldShowDialog","pendingRollInfo","err","ApplicationV2","HandlebarsApplicationMixin","CustomRollDialog","baseTitle","rollModes","partId","htmlElement","formulaInput","validationMessage","rollModeSelect","messageElement","currentFormula","diceRegex","diceMap","remainingFormula","count","dieType","newDieType","diceParts","RollRequestManager","isMidiRequest","actorUniqueId","showRequestPrompt","isActivityRoll","timeoutSeconds","hasWorkflow","rollModeFromGM","defaultRollMode","finalRollMode","rollMetadata","handlerRequestData","RollHandlers","playerRollSaves","timeout","timeoutId","autoRollDialogConfig","pending","_ChatMessageManager","_l","_m","requestedText","currentFlavor","baseActorId","checkIds","groupRollId","pendingData","actorEntries","storedGroupRollId","baseActor","storedInitConfig","html","midiRequestId","dnd5eRollType","globalHidden","messageHidden","isGM","showAllResultsToPlayers","shouldHideNPCs","flagData","shouldHide","hasPermission","shouldHideRoll","concealNPCNames","shouldConcealName","challengeVisibility","showDC","el","diceTotals","text","messageId","timeoutMs","button","j","actorElement","actorResults","actorResult","actorImg","advBtn","advantageMode","diceBtn","hasAdvantage","hasDisadvantage","skipNormal","shouldSkipDialog","dataset","gmAdvantage","gmDisadvantage","situationalBonus","finalAdvantage","finalDisadvantage","rollMethod","rollOptions","dcControl","dcInput","showToPlayers","groupFooterDetails","groupFooter","showResultToPlayers","debounceTimer","handleDCChange","newDC","targetMessage","selectionButtons","btn","selectType","tokensToSelect","shouldSelect","matchingTokens","validEntries","existingMessage","existingActorIds","newEntries","newEntriesData","mergedEntries","existingFlagData","groupRollNPCHidden","newResults","updatedData","entryRollType","entryRollKey","entryFlavor","supportsDC","showDCToPlayers","groupCalculationForSaves","showGroupCalculation","fromMidiWorkflow","rolledResults","result1","result2","winner","loser","getResultId","saveLabel","skillLabel","skillAbility","skillAbilityLabel","toolLabel","toolAbility","toolAbilityLabel","speakerAlias","msg","m","resultIndex","tokenActorId","speakerActorId","rollBreakdown","hookData","isSaveRoll","contestedResult","resultId","groupResult","newContent","autoSelectMode","groupRollsMsgEnabled","actorUniqueIdFromFlag","isFlashRollRequest","matchingGroupRollId","groupMessage","gmUserIds","requestId","msgId","logPrefix","hideMessage","msgElement","hookId","msgToDelete","dnd5eRoll","isInitiativeRoll","dndRollType","pendingType","matchesType","fiveMinutesAgo","ChatMessageManager","defaultAbility","initiativeConfig","tempConfig","effectiveDialogConfigure","processConfig","confirmedFormula","confirmedRollMode","updateResult","itemUpdateResult","ensureCombatForInitiative","filterActorsForInitiative","actorIds","game","actorsNamesWithInitiative","actorIdsWithInitiative","c","filteredIds","GMRollConfigMixin","Base","formData","abilityFromForm","dcFromForm","dcValue","formConfig","sendRequestCheckbox","finalizedRolls","hasPC","hasNPC","ability","macroData","GMRollConfigDialog","configSection","templateData","template","macroButton","rollClass","finalTitle","selectedAbilityLabel","skill","saveAbility","checkAbility","toolDefaultAbility","GMHitDieConfigDialog","form","GMSkillToolConfigDialog","GMDamageConfigDialog","originalConfig","originalDialog","subjectItem","actorItem","storedActivityConfig","position","GMAttackConfigDialog","RollInterceptor","hookName","_n","_o","_p","_q","_r","_s","_t","_u","_v","_w","_x","isMidiOn","ddbGameLogFlag","flash5eFlags","monksTokenBarFlags","eventTarget","isMonksTokenBarButton","isRollRequestFlag","moduleFlags","hookNames","originalSubject","finalConfig","dialogResult","handlerMap","cleanConfig","useCondensedRollMessage","actorEntry","defaultDialogResult","OfflinePlayerManager","onlinePlayerActors","offlinePlayerActors","actorMap","onlineNonGMOwner","offlineActors","rollMethodName","potentialOwner","RollMenuConfig","configOverrides","sendAsRequest","pc","hasOnlinePlayers","allActorsAreLocalRolls","confirmedSkipDialog","RollMenuExecutor","requestType","wasControlled","actualRollKey","hdData","RollMenuOrchestrator","actorsData","p","n","allActorEntries","allActors","online","offline","allActorIds","isMultiActorRoll","groupMessageAlreadyExists","allActorsForHitDie","useGroupId","currentRollKey","npcActorIds","npcActorEntries","actorsToRefill","actorsNeedingRefill","hitDieResult","baseActorError","menu","selectedUniqueIds","rollOption","originalRollKey","customResult","filteredActors","characterActors","actorsWithoutTokens","actorsWithTokens","entriesWithTokens","uniqueActorIds","filteredActorIds","filteredActorsData","suppressNotification","normalizedRollTypeKey","SidebarController","chatControls","rollRequestIcon","firstChatControlIcon","RollRequestsMenu","enabled","icon","RollMenuActorUtil","statsToShow","stats","spellDC","hpPercent","hpColor","selectedActorIds","currentTab","RollMenuDragManager","dragHandle","startX","startY","isDraggedFromBottomDock","menuRect","initialLeft","initialTop","handleRect","handleCenterOffset","dragData","handleMove","handleUp","deltaX","deltaY","remInPixels","snapInfo","moveHandler","upHandler","chatNotifications","lightningBolt","hotbar","hotbarRect","bottomDistance","menuLeft","menuRight","hotbarLeft","hotbarRight","boltRect","horizontalDistance","verticalDistance","currentTop","uiBottom","offsetValue","menuSize","ActorStatusManager","actorDoc","isFavorite","isBlocked","makeFavorite","makeBlocked","li","ActorDragUtil","menuContainer","rect","dragImage","actorImgContainer","clonedImgContainer","nameDiv","clonedImg","actorName","clonedName","menuElement","ActorDropUtil","dropZone","targetTab","jsonData","textData","TokenMovementManager","actorTokens","movementStatus","shouldLock","messageKey","restricted","updateData","movementRestrictionValue","tokenUpdate","freshToken","newRestriction","restriction","restrictedCount","unrestrictedCount","status","currentCombatant","tokensToBlock","combatant","prior","current","isCurrentTurn","shouldRestrict","tokensToUnblock","currentRestriction","update","activeCombat","IconLayoutUtil","savedLayout","defaultLayout","mergedLayout","iconType","savedIcons","defaultIcons","savedIconIds","mergedIcons","maxOrder","defaultIcon","container","list","toggle","placeholder","draggingItem","draggedIconType","targetIconType","afterElement","closest","child","box","offset","iconItem","isEnabled","updatedIcons","updatedLayout","currentLayout","_activeMenu","IconContextMenu","contextMenu","menuHtml","__privateSet","closeHandler","viewportWidth","viewportHeight","addMacrosToFolder","iconConfig","actorToken","macroCommand","macroName","folderId","macro","methodName","description","folderName","folder","__privateGet","_RollMenuEventManager","tabs","tab","scrollContainer","scrollPosition","firstItem","menuLayout","maxIconsPerRow","maxWidth","maxHeight","itemsToScroll","itemWidth","scrollAmount","itemHeight","firstButton","secondButton","isAtStart","isAtEnd","scrollLeft","scrollWidth","clientWidth","scrollTop","scrollHeight","clientHeight","moduleIcons","actorIcons","iconElement","sheetIcon","targetIcon","tooltip","actorData","tooltipCopy","showTooltip","existingTooltip","actorRect","isLeftEdge","imgRect","imgCenterX","hideTooltip","searchInput","accordion","showOnHover","mouseEnterHandler","showOptionsListOnHover","mouseLeaveHandler","requestTypesContainer","parentItem","customEvent","macroBtn","requestHeader","requestItem","subItem","statusElement","groupId","targetCount","groupActors","openedGroups","groupData","member","totalRemoved","totalActors","statusEffects","isTargeted","maxHP","currentValue","newValue","actorGroups","tokenAssociationsByScene","currentSceneId","playerOwnedCount","totalSelectedCount","group","tokenUuid","playerOwnedRatio","actorType","defaultName","members","newActor","sceneId","sceneAssociations","tokenUuids","memberSummary","menuToUse","ContestedRollDialog","__vitePreload","TokenPlacementManager","TokenPlacementManager$1","TokenTeleportManager","TokenTeleportManager$1","TransformationManager","TransformationManager$1","RollMenuEventManager","RollMenuStatusManager","statusEffectId","statusEffect","successCount","totalCount","statusName","effectData","existingEffect","hasEffect","RollMenuStateManager","skip","selectAll","memberUniqueId","lockIcon","existing","buttonRect","tooltipRect","relativeTop","tooltipLeft","relativeLeft","tooltipTop","optionsToggleContainer","optionsElement","wrapperElement","checkbox","isSelected","hasSelection","hasPlayerCharacter","hitDieItem","selectAllCheckbox","selectedCount","currentActors","allMembers","groupActor","checkboxes","cb","savedFilters","tooltipContainer","filters","RollMenuActorProcessor","baseContext","groupEntries","actorFilters","filteredPCActors","filteredNPCActors","filteredGroupActors","groupToken","groupFilters","aActor","bActor","primaryParty","aIsPrimary","bIsPrimary","selectAllOn","requestTypes","showOnlyPCsWithToken","tokensInScene","actorForStats","hpData","hasAnyMemberTokens","hasActiveFilters","tokenAssociations","memberActorId","associatedTokenIds","foundValidToken","actorToCheck","memberData","memberTokens","memberActor","memberActors","memberDataList","selectedMembers","option","PROXY_BASE_URL","HEARTBEAT_INTERVAL","VALIDATION_CACHE_TIME","SESSION_TOKEN_KEY","_PatronSessionManager","instance","headers","connected","force","now","oldStatus","PatronSessionManager","DnDBConnection","onRollEvent","campaignId","cobaltCookie","sessionToken","errorData","eventUrl","raw","PremiumFeaturesDialog","SOCKET_HANDLERS","DnDBeyondIntegration","characterId","entityType","shouldPlayerExecute","rollOwnership","entityId","entityIdStr","actorByMonsterId","ddbId","actorByDDBFlag","dndbeyond","ddbCharacterId","foundryActorId","charIdStr","mappings","getProxyBaseUrl","DnDBCharacterFetcher","characterIds","promises","DDB_ABILITY_MAP","DnDBCharacterTransformer","ddbCharacter","matchResult","currency","movement","senses","traits","tools","allMods","savingThrowMap","saveProficiencies","mod","foundryKey","numericId","baseValue","bonusValue","overrideValue","finalValue","statsArray","statId","returnNull","stat","cls","baseHp","bonusHp","overrideHp","tempHp","removedHp","maxHp","currencies","itemData","ddbItem","isCantrip","classLevel","modifiers","source","skillMap","ddbSkill","foundrySkill","profMod","k","v","speedTypes","speedType","languages","weaponProf","armorProf","langName","spellSlotsUsed","pactMagic","classes","usedByLevel","slot","effectiveCasterLevel","casterClasses","spellRules","divisor","contribution","tableIndex","slotsAtLevel","spellLevel","max","used","remaining","pactSlot","pactMax","pactUsed","slotEntries","slotData","slotKey","toolTypes","toolName","toolNameMap","toolId","toolNames","choices","choiceDefinitions","optionIdToLabel","def","opt","processChoiceArray","choiceArray","choice","modifierTools","choiceTools","modTool","choiceToolName","DDB_SOURCE_BOOKS","DDB_TO_FOUNDRY_TYPE","EQUIPMENT_TYPE_VARIANTS","DnDBCompendiumMatcher","pack","elapsed","filterType","defType","directType","allMatches","book","sources","bookInfo","priorityOverride","ddbDefinitionId","foundryType","className","raceName","matches","ddbIdMatches","nameMatches","nameMatch","prefixedVariants","variant","variantMatches","variantMatch","wordMatches","wordMatch","priorityMode","packLabel","packageName","pattern","pkg","version","w","sourceBook","sourceRules","sourceAbbrev","labelLower","alreadyHasSource","rules","is2024","is2014","reqScoreA","reqScoreB","rulesPriorityA","rulesPriorityB","definitionId","expectedName","seenSources","normalizedExpected","packId","normalizedEntry","entryWithoutLegacy","requirementScore","dedupeKey","sourceInfo","entryType","entryClassId","entryRequirements","useWordMatch","normalizedSearch","searchWords","typeVariants","isNameMatch","stopWords","entryWords","sw","ew","matched","unmatched","itemsToMatch","availableSources","spellItems","itemName","itemType","selectedMatch","matchRate","tier","matchedSpells","unmatchedSpells","items","feature","requiredLevel","featureName","baseRaceName","lineageVariant","searchVariants","trait","traitName","bgDef","spellsByDefinitionId","onlyPrepared","spellSources","spell","defId","classSpellList","feat","existingClassFeatureIds","optionName","parentFeatureId","parentFeature","toolProficiencies","lineagePattern","variantParts","variantType","fullName","baseName","subRaceShortName","variants","parentFeatureName","totalItems","DnDBHomebrewManager","packName","normalizedName","unmatchedItems","createdItems","itemsToAddToActor","unmatchedItem","rawType","compendiumItem","actorItemData","definition","fullDescription","shortDescription","DnDBCharacterImporter","CharacterImportResultsDialog","DDBImporter","stubActor","refreshedActor","homebrewCount","spellSlotData","tierLabel","homebrewItems","classItems","subclassItems","raceBackgroundItems","classFeatureItems","regularItems","isChoiceOption","isClassFeature","spellsInRegular","itemsToAdd","classMatches","adv","_PremiumFeaturesDialog_static","onSave_fn","onToggleDdbSettings_fn","onAuthenticatePatreon_fn","onRefreshSession_fn","onLogout_fn","onTestConnection_fn","onTestGameLog_fn","onRefreshCharacters_fn","onMapCharacter_fn","onUnlinkCharacter_fn","onImportCharacter_fn","onSyncCharacter_fn","onImportAll_fn","onSyncAll_fn","_PremiumFeaturesDialog","tabId","partContext","ddbCampaignId","ddbUserId","ddbCobaltCookie","ddbNoAutoConsumeSpellSlot","ddbImportOwnership","hasSessionToken","ddbStatusInfo","patreonStatusInfo","patronStatus","canTestGameLog","hasDDBImporter","canShowCharacters","charactersWithMapping","char","mappingInfo","mappedCount","unmappedCount","characterCountText","patronTierName","characterName","mappedActorId","tierCents","showLoading","spinning","refreshBtn","fieldset","listHtml","mappedClass","avatarHtml","mappingStatusHtml","linkBtnHtml","actionBtnHtml","existingHeader","existingList","existingHint","formGroup","show","overlay","messageEl","campaignIdInput","userIdInput","cobaltCookieInput","debouncedRefresh","input","mappedItems","syncBtn","wait","indicator","statusInfo","toggleIcon","isCollapsed","messageHandler","dialogInstance","unmappedCharacters","imported","failed","ownershipLevel","mappedCharacters","synced","_instance","_refreshDebounceTimer","_REFRESH_DEBOUNCE_DELAY","_RollRequestsMenu","filterTooltip","preparedContext","frame","customPosition","dropZones","zone","optionsToggle","controlled","previousSelection","premiumBtn","gemIcon","patreonLabel","ddbLabel","verifiedText","ddbText","groupElement","containerRect","elementRect","changes","uid","ModuleSettingsMenu","menuItems","controlledTokens","groupActorId","hasAssociationsOnCurrentScene","allMembersSelected","selectedMembersCount","selectionState","searchTerm","requestName","subItems","hasVisibleSubItems","isVisible","categoryMatches","shouldShowCategory","nestedList","accordionToggle","statusEffectsContainer","statusItem","statusId","elementId","parentType","hook","property","immediate","actorsToPlace","previewData","snapped","children","tokenData","gridSize","texture","ghostToken","tokenWidth","tokenHeight","progressText","currentPreview","totalPlaced","location","tokensCreated","finalTokenData","created","tokensToTeleport","tokenDataToTeleport","scene","tokenObj","showNotification","tokenCount","sceneName","sourceGridSize","targetGridSize","boundingBox","groupCenterX","groupCenterY","sourceTokenWidth","sourceTokenHeight","sourceTokenCenterX","sourceTokenCenterY","relativeGridX","relativeGridY","newCenterX","newCenterY","targetTokenWidth","targetTokenHeight","newX","newY","destination","isSameScene","animationPath","fadeUpdates","arrivalPositions","tokenCenterX","tokenCenterY","relativeFromGroupCenterX","relativeFromGroupCenterY","snappedPosition","showUpdates","tokenCreateData","createdTokens","center","relativeX","relativeY","centerX","centerY","positions","pos","possiblePaths","dbPath","jb2aModule","filePath","circle1","circle2","circle3","animationFrame","scale1","scale2","scale3","halfGrid","snappedX","snappedY","tokenDataArray","minX","minY","maxX","maxY","destinationScene","centerLocation","checkInterval","targetScene","invalidIds","teleportedTokenIds","teleportedTokens","avgX","avgY","FormDataExtended","_TransformationDialog_static","onSubmit_fn","onTransform_fn","onCancel_fn","_TransformationDialog","favoritesData","favoriteUuids","selectBtn","actorImageContainer","actorImagePlaceholder","clearBtn","presetSelector","favoriteItems","toggleFavoriteBtns","favoritesSection","selectedActorImg","wasEmpty","imgContainer","toggleBtn","preview","favorites","favoriteSet","wasRemoved","preset","targetActor","renderSheet","settings","keep","TransformationDialog","targetActorUuid","transformedActors","idsToRevert","transformSettings","sanitizedTarget","customSettings","path","sourceActor","sourceData","targetData","sourceAbilityKeys","targetAbilityKeys","extraAbilities","abilityKey","TempActor","tempActor","isContestedRoll","workflowId","normalizedRequestType","invalidActorIds","mockMenu","cleanedOptions","tokenOnly","selectedIds","requestOptions","command","macroDocumentData","methodMap","normalizedMethod","enhancedRollResults","enhancedResultsWithLeader","enhancedResultsWithWeakest","newLockState","validFilters","filterButton","tempMenu","_registeredWrappers","_libWrapperChecked","_libWrapperAvailable","LibWrapperUtil","_element","_activeTab","_requireReload","_ModuleSettingsMenu_instances","setupRangeInputs_fn","handleRangeInputs_fn","_ModuleSettingsMenu_static","onReset_fn","getTabs_fn","_ModuleSettingsMenu","iconContainer","select","restrictedTabs","getSettingMenus","partKey","menuContext","configs","defaultIconsLayout","savedSettings","buildIconList","iconConfigs","defaultIconsMap","savedIconsMap","savedIcon","menuKey","fieldNames","fields","fieldValues","fieldDefaults","fieldName","confirmReload","activeTab","currSetting","rangeInput","valueInput","min","currentValueString","activeContent","defaults","inputField","nameParts","defaultValue","tabList","_SettingsUtil","isDebugOn","setting","settingObj","settingMenus","menuData","menuObj","isRollInterceptionEnabled","foundryUiConfig","interfaceTheme","settingName","selectedSetting","requestsIcon","isCompactMode","menuIconsLayout","enabledActorIcons","updated","validIds","existingIds","ActorDirectoryIconUtil","actorDirectory","flagChanges","existingIcon","RollHooksHandler","areSkipKeysPressed","stored","storedConfig","allSituationalBonuses","uniqueBonuses","bonus","trimmedBonus","_GroupTokenTracker","migrationCompleted","placement","wrapped","originalPlaceMembers","originalEncounterPlaceMembers","memberActorIds","expectedTokenCount","quantity","currentFlag","fromGroupPlacement","currentAssociations","existingUuids","associations","failCount","currentMemberIds","hasChanges","updatedAssociations","tokenIndex","cleanedAssociations","cleanedSceneAssociations","validTokenUuids","sceneTokens","shouldCleanup","reasons","legacyAssociations","newAssociations","migratedAssociations","totalMigrated","validUuids","needsSync","existingAssociations","validExisting","neededCount","currentCount","availableCount","mainContent","totalTokens","validTokens","textDiv","buttonGroup","selectButton","uuids","canvasToken","canvas","isLinkedMatch","isUnlinkedMatch","unassociatedTokens","hasGroupFlag","isAlreadyAssociated","oldGroup","tokensToAssociate","GroupTokenTracker","TokenAnimationManager","TokenClass","originalAnimate","customMovementSpeed","_TooltipUtil_static","interceptTooltipEvents_fn","wrapTooltipActivation_fn","wrapTooltipDeactivation_fn","_TooltipUtil","autoDismissSeconds","timer","TooltipClass","storedValue","customDelay","originalActivate","originalDeactivate","TooltipUtil","_UpdateNewsUtil","moduleVersion","baseUrl","controller","lastUpdateId","rawVersion","fetchError","json","UpdateNewsUtil","_MonksActiveTilesIntegration","entity","field","rollKeySelect","configKey","tile","entities","withinEntities","resolvedEntity","trigger","typeName","rollKeyName","advType","advLabel","skipDialog","document","tileObject","locationData","selectedTile","shouldSnap","tileDoc","tileBounds","randomX","randomY","finalLocation","locationText","sceneText","snapText","tokenDocs","td","transformedTokenDocIds","nonTransformedTokenDocIds","targetUuid","targetText","tokenX","tokenY","entityData","skillId","abilityId","timestamp","MonksActiveTilesIntegration","_HooksManager","contextOptions","chatLog","menuProxy","situationalInput","jQuerj","isMovementAllowed","isTeleporting","ownershipChanged","statsChanged","effectsChanged","abilitySelect","selectedAbility","configAbility","changeEvent","throttleKey","targettingSetting","maxDisposition","tokensToTarget","oldColorScheme","newColorScheme","menuInstance","Main","_ContestedRollDialog","flavorInput","hideNpcCheckbox","contestedConfig","actorConfig","firstRollType","speakerData","macroCode","firstActor","firstSelection","firstType","firstKey","rollCommands","selection","joinedCommands","actorEntriesCode","_CharacterImportResultsDialog_static","onConfirm_fn","onOpenDDBImporter_fn","_CharacterImportResultsDialog","classInfo","backgroundName","matchPercentage","groupedMatched","groupedUnmatched","groups","typeLabels","nameA","nameB","importData","createAllCheckbox","isChecked","toCreate","itemKey","selectedIndex","newMatch"],"ignoreList":[],"sources":["../../src/lib/libwrapper-shim.js","../../src/constants/IconMappings.mjs","../../src/constants/Settings.mjs","../../src/constants/General.mjs","../../src/constants/Hooks.mjs","../../src/components/utils/LogUtil.mjs","../../src/components/utils/SocketUtil.mjs","../../src/components/utils/DiceConfigUtil.mjs","../../src/components/utils/GeneralUtil.mjs","../../src/components/helpers/Helpers.mjs","../../src/components/integrations/dnd-beyond/DnDBRollParser.mjs","../../src/components/integrations/dnd-beyond/DnDBRollUtil.mjs","../../src/components/integrations/dnd-beyond/DnDBActivityUtil.mjs","../../src/components/helpers/ModuleHelpers.mjs","../../src/components/integrations/dnd-beyond/DnDBIntegration.mjs","../../src/components/integrations/dnd-beyond/DnDBRollExecutor.mjs","../../src/components/helpers/RollHelpers.mjs","../../src/components/managers/VanillaActivityManager.mjs","../../src/components/managers/MidiActivityManager.mjs","../../src/components/managers/BaseActivityManager.mjs","../../src/components/ui/dialogs/CustomRollDialog.mjs","../../src/components/managers/RollRequestManager.mjs","../../src/components/managers/ChatMessageManager.mjs","../../src/components/handlers/RollHandlers.mjs","../../src/components/helpers/RollValidationHelpers.mjs","../../src/components/ui/dialogs/gm-dialogs/GMRollConfigMixin.mjs","../../src/components/ui/dialogs/gm-dialogs/GMRollConfigDialog.mjs","../../src/components/ui/dialogs/gm-dialogs/GMHitDieConfigDialog.mjs","../../src/components/ui/dialogs/gm-dialogs/GMSkillToolConfigDialog.mjs","../../src/components/ui/dialogs/gm-dialogs/GMDamageConfigDialog.mjs","../../src/components/ui/dialogs/gm-dialogs/GMAttackConfigDialog.mjs","../../src/components/handlers/RollInterceptor.mjs","../../src/components/managers/roll-menu/OfflinePlayerManager.mjs","../../src/components/managers/roll-menu/RollMenuConfig.mjs","../../src/components/managers/roll-menu/RollMenuExecutor.mjs","../../src/components/managers/roll-menu/RollMenuOrchestrator.mjs","../../src/components/managers/SidebarController.mjs","../../src/components/utils/RollMenuActorUtil.mjs","../../src/components/managers/roll-menu/RollMenuDragManager.mjs","../../src/components/managers/ActorStatusManager.mjs","../../src/components/utils/ActorDragUtil.mjs","../../src/components/utils/ActorDropUtil.mjs","../../src/components/utils/TokenMovementManager.mjs","../../src/components/utils/IconLayoutUtil.mjs","../../src/components/ui/IconContextMenu.mjs","../../src/components/managers/roll-menu/RollMenuEventManager.mjs","../../src/components/managers/roll-menu/RollMenuStatusManager.mjs","../../src/components/managers/roll-menu/RollMenuStateManager.mjs","../../src/components/managers/roll-menu/RollMenuActorProcessor.mjs","../../src/components/managers/PatronSessionManager.mjs","../../src/components/integrations/dnd-beyond/DnDBConnection.mjs","../../src/components/integrations/DnDBeyondIntegration.mjs","../../src/components/integrations/dnd-beyond/DnDBCharacterFetcher.mjs","../../src/components/integrations/dnd-beyond/DnDBCharacterTransformer.mjs","../../src/constants/DnDBeyond.mjs","../../src/components/integrations/dnd-beyond/DnDBCompendiumMatcher.mjs","../../src/components/integrations/dnd-beyond/DnDBHomebrewManager.mjs","../../src/components/integrations/dnd-beyond/DnDBCharacterImporter.mjs","../../src/components/ui/dialogs/PremiumFeaturesDialog.mjs","../../src/components/ui/RollRequestsMenu.mjs","../../src/components/managers/TokenPlacementManager.mjs","../../src/components/managers/TokenTeleportManager.mjs","../../src/components/ui/dialogs/TransformationDialog.mjs","../../src/components/managers/TransformationManager.mjs","../../src/components/core/FlashAPI.mjs","../../src/components/utils/LibWrapperUtil.mjs","../../src/components/ui/dialogs/ModuleSettingsMenu.mjs","../../src/constants/SettingMenus.mjs","../../src/components/utils/SettingsUtil.mjs","../../src/components/utils/ActorDirectoryIconUtil.mjs","../../src/components/handlers/RollHooksHandler.mjs","../../src/components/managers/GroupTokenTracker.mjs","../../src/components/managers/TokenAnimationManager.mjs","../../src/components/utils/TooltipUtil.mjs","../../src/components/utils/UpdateNewsUtil.mjs","../../src/components/integrations/MonksActiveTilesIntegration.mjs","../../src/components/core/HooksManager.mjs","../../src/components/core/Main.mjs","../../src/module.mjs","../../src/components/ui/dialogs/ContestedRollDialog.mjs","../../src/components/ui/dialogs/CharacterImportResultsDialog.mjs"],"sourcesContent":["// SPDX-License-Identifier: LGPL-3.0-or-later\n// Copyright  2021 fvtt-lib-wrapper Rui Pinheiro\n\n'use strict';\n\n// A shim for the libWrapper library\nexport let libWrapper = undefined;\n\nexport const VERSIONS = [1,12,1];\nexport const TGT_SPLIT_RE = new RegExp(\"([^.[]+|\\\\[('([^'\\\\\\\\]|\\\\\\\\.)+?'|\\\"([^\\\"\\\\\\\\]|\\\\\\\\.)+?\\\")\\\\])\", 'g');\nexport const TGT_CLEANUP_RE = new RegExp(\"(^\\\\['|'\\\\]$|^\\\\[\\\"|\\\"\\\\]$)\", 'g');\n\n// ************** USER CUSTOMIZABLE:\n// Whether to warn GM users that libWrapper is not installed\n// NOTE: Disabled because Flash Rolls 5e has its own notification system\nconst WARN_FALLBACK = false;\n// ************** END USER CUSTOMIZABLE\n\n\n// ************** SHIM CODE:\n\n// Check if libWrapper is already loaded\nHooks.once('init', () => {\n\t// If libWrapper is loaded, use it\n\tif(globalThis.libWrapper) {\n\t\tlibWrapper = globalThis.libWrapper;\n\t\treturn;\n\t}\n\n\t// Otherwise, create shim\n\tlibWrapper = class {\n\t\tstatic get is_fallback() { return true };\n\n\t\tstatic get WRAPPER()  { return 'WRAPPER'  };\n\t\tstatic get MIXED()    { return 'MIXED'    };\n\t\tstatic get OVERRIDE() { return 'OVERRIDE' };\n\n\t\tstatic register(package_id, target, fn, type=\"MIXED\", {chain=undefined, bind=[]}={}) {\n\t\t\tconst is_setter = target.endsWith('#set');\n\t\t\ttarget = !is_setter ? target : target.slice(0, -4);\n\t\t\tconst split = target.match(TGT_SPLIT_RE).map((x)=>x.replace(/\\\\(.)/g, '$1').replace(TGT_CLEANUP_RE,''));\n\t\t\tconst root_nm = split.splice(0,1)[0];\n\t\t\tconst fn_name = split.pop();\n\t\t\tconst target_nm = split.join('.');\n\n\t\t\tlet obj, fn_nm;\n\t\t\tif(split.length == 0) {\n\t\t\t\tobj = globalThis;\n\t\t\t\tfn_nm = root_nm;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tconst _eval = eval;\n\t\t\t\tfn_nm = fn_name;\n\t\t\t\tobj = split.reduce((x,y)=>x[y], globalThis[root_nm] ?? _eval(root_nm));\n\t\t\t}\n\n\t\t\tlet iObj = obj;\n\t\t\tlet descriptor = null;\n\t\t\twhile(iObj) {\n\t\t\t\tdescriptor = Object.getOwnPropertyDescriptor(iObj, fn_nm);\n\t\t\t\tif(descriptor) break;\n\t\t\t\tiObj = Object.getPrototypeOf(iObj);\n\t\t\t}\n\t\t\tif(!descriptor || descriptor?.configurable === false) throw new Error(`libWrapper Shim: '${target}' does not exist, could not be found, or has a non-configurable descriptor.`);\n\n\t\t\tlet original = null;\n\t\t\tconst wrapper = (chain ?? (type.toUpperCase?.() != 'OVERRIDE' && type != 3)) ? function(...args) { return fn.call(this, original.bind(this), ...bind, ...args); } : function(...args) { return fn.call(this, ...bind, ...args); };\n\t\t\tif(!is_setter) {\n\t\t\t\tif(descriptor.value) {\n\t\t\t\t\toriginal = descriptor.value;\n\t\t\t\t\tdescriptor.value = wrapper;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\toriginal = descriptor.get;\n\t\t\t\t\tdescriptor.get = wrapper;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif(!descriptor.set) throw new Error(`libWrapper Shim: '${target}' does not have a setter`);\n\t\t\t\toriginal = descriptor.set;\n\t\t\t\tdescriptor.set = wrapper;\n\t\t\t}\n\n\t\t\tdescriptor.configurable = true;\n\t\t\tObject.defineProperty(obj, fn_nm, descriptor);\n\t\t}\n\t}\n\n\t// Make libWrapper global\n\tglobalThis.libWrapper = libWrapper;\n});\n","/**\n * Icon mappings and configuration for menu icons\n */\n\nexport const ICON_TYPES = {\n  MODULE_ACTIONS: \"moduleActions\",\n  ACTOR_ACTIONS: \"actorActions\"\n};\n\n/**\n * Module action icon configurations\n * Maps icon IDs to their properties and labels\n */\nexport const MODULE_ACTION_ICONS = {\n  \"lock-menu\": {\n    id: \"lock-menu\",\n    icon: \"fa-lock-keyhole\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.lockMenu\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.lockMenu\",\n    element: \"flash5e-actors-lock\",\n    type: \"button\"\n  },\n  \"toggle-requests\": {\n    id: \"toggle-requests\",\n    icon: \"fa-bolt\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.toggleRollRequests\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.toggleRollRequests\",\n    element: \"flash-rolls-toggle\",\n    type: \"checkbox\"\n  },\n  \"skip-dialogs\": {\n    id: \"skip-dialogs\",\n    icon: \"fa-square-question\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.skipRollDialog\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.skipRollDialog\",\n    element: \"flash5e-skip-dialogs\",\n    type: \"checkbox\"\n  },\n  \"group-rolls\": {\n    id: \"group-rolls\",\n    icon: \"fa-users-rectangle\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.groupRollsMsg\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.groupRollsMsg\",\n    element: \"flash5e-group-rolls-msg\",\n    type: \"checkbox\"\n  },\n  \"show-options\": {\n    id: \"show-options\",\n    icon: \"fa-bars-sort\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.showOptionsListOnHover\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.showOptionsListOnHover\",\n    element: \"flash5e-toggle-list\",\n    type: \"checkbox\"\n  },\n  \"open-settings\": {\n    id: \"open-settings\",\n    icon: \"fa-cog\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.openSettings\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.openSettings\",\n    element: \"flash5e-open-settings\",\n    type: \"button\"\n  },\n  \"premium-features\": {\n    id: \"premium-features\",\n    icon: \"fa-gem\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.premiumFeatures\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.premiumFeatures\",\n    element: \"flash5e-premium-features\",\n    type: \"button\"\n  }\n};\n\n/**\n * Actor action icon configurations\n * Maps icon IDs to their properties and labels\n */\nexport const ACTOR_ACTION_ICONS = {\n  \"select-all\": {\n    id: \"select-all\",\n    icon: \"fa-object-group\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.selectAll\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.selectAll\",\n    element: \"flash5e-actors-all\",\n    type: \"checkbox\",\n    cssClass: \"bulk-action\"\n  },\n  \"filter-actors\": {\n    id: \"filter-actors\",\n    icon: \"fa-filter-list\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.filterActors\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.filterActors\",\n    element: \"flash5e-filter-actors\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"toggle-targets\": {\n    id: \"toggle-targets\",\n    icon: \"fa-crosshairs\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.toggleTargets\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.toggleTargets\",\n    element: \"flash5e-targets\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"place-tokens\": {\n    id: \"place-tokens\",\n    icon: \"fa-location-dot\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.placeTokens\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.placeTokens\",\n    element: \"flash5e-place-tokens\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"teleport-tokens\": {\n    id: \"teleport-tokens\",\n    icon: \"fa-person-to-portal\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.teleportTokens\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.teleportTokens\",\n    element: \"flash5e-teleport-tokens\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"heal-all\": {\n    id: \"heal-all\",\n    icon: \"fa-heart-pulse\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.healAll\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.healAll\",\n    element: \"flash5e-heal-selected\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"kill-all\": {\n    id: \"kill-all\",\n    icon: \"fa-skull\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.killAll\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.killAll\",\n    element: \"flash5e-kill-selected\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"remove-status\": {\n    id: \"remove-status\",\n    icon: \"fa-sparkles\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.removeStatus\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.removeStatus\",\n    element: \"flash5e-remove-effects\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"open-sheets\": {\n    id: \"open-sheets\",\n    icon: \"fa-square-user\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.openSheets\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.openSheets\",\n    element: \"flash5e-sheets\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"group-selected\": {\n    id: \"group-selected\",\n    icon: \"fa-users-medical\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.groupSelected\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.groupSelected\",\n    element: \"flash5e-group-selected\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"movement\": {\n    id: \"movement\",\n    icon: \"fa-person-walking\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.toggleMovement\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.toggleMovement\",\n    element: \"flash5e-lock-movement\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"contested-roll\": {\n    id: \"contested-roll\",\n    icon: \"fa-swords\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.contestedRoll\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.contestedRoll\",\n    element: \"flash5e-contested-roll\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"transform\": {\n    id: \"transform\",\n    icon: \"fa-frog\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.transform\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.transform\",\n    element: \"flash5e-transform\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  }\n};\n\n/**\n * Get all icon configurations by type\n * @param {string} type - Icon type (moduleActions or actorActions)\n * @returns {Object} Icon configurations\n */\nexport function getIconConfigurations(type) {\n  switch (type) {\n    case ICON_TYPES.MODULE_ACTIONS:\n      return MODULE_ACTION_ICONS;\n    case ICON_TYPES.ACTOR_ACTIONS:\n      return ACTOR_ACTION_ICONS;\n    default:\n      return {};\n  }\n}\n\n/**\n * Get icon configuration by ID\n * @param {string} iconId - Icon ID\n * @param {string} type - Icon type\n * @returns {Object|null} Icon configuration or null if not found\n */\nexport function getIconConfiguration(iconId, type) {\n  const configurations = getIconConfigurations(type);\n  return configurations[iconId] || null;\n}\n\n/**\n * Get default icon layout configuration\n * @returns {Object} Default icon layout\n */\nexport function getDefaultIconLayout() {\n  return {\n    moduleActions: [\n      { id: \"lock-menu\", icon: \"fa-lock-keyhole\", enabled: true, order: 0 },\n      { id: \"toggle-requests\", icon: \"fa-bolt\", enabled: true, order: 1 },\n      { id: \"skip-dialogs\", icon: \"fa-square-question\", enabled: true, order: 2 },\n      { id: \"group-rolls\", icon: \"fa-users-rectangle\", enabled: true, order: 3 },\n      { id: \"show-options\", icon: \"fa-bars-sort\", enabled: true, order: 4 },\n      { id: \"open-settings\", icon: \"fa-cog\", enabled: true, order: 5 },\n      { id: \"premium-features\", icon: \"fa-gem\", enabled: true, order: 6 }\n    ],\n    actorActions: [\n      { id: \"filter-actors\", icon: \"fa-filter-list\", enabled: true, order: 0 },\n      { id: \"select-all\", icon: \"fa-object-group\", enabled: true, order: 1 },\n      { id: \"toggle-targets\", icon: \"fa-crosshairs\", enabled: true, order: 2 },\n      { id: \"remove-status\", icon: \"fa-sparkles\", enabled: true, order: 3 },\n      { id: \"teleport-tokens\", icon: \"fa-person-to-portal\", enabled: true, order: 4 },\n      { id: \"transform\", icon: \"fa-frog\", enabled: true, order: 5 },\n      { id: \"place-tokens\", icon: \"fa-location-dot\", enabled: true, order: 6 },\n      { id: \"contested-roll\", icon: \"fa-swords\", enabled: true, order: 7 },\n      { id: \"group-selected\", icon: \"fa-users-medical\", enabled: true, order: 8 },\n      { id: \"movement\", icon: \"fa-person-walking\", enabled: true, order: 9 },\n      { id: \"heal-all\", icon: \"fa-heart-pulse\", enabled: true, order: 10 },\n      { id: \"kill-all\", icon: \"fa-skull\", enabled: true, order: 11 },\n      { id: \"open-sheets\", icon: \"fa-square-user\", enabled: true, order: 12 }\n    ]\n  };\n}","import { getDefaultIconLayout } from \"./IconMappings.mjs\";\n\nexport const SETTING_INPUT = {\n  select: \"select\", \n  checkbox: \"checkbox\"\n}\nexport const SETTING_SCOPE = {\n  client: \"client\",\n  world: \"world\"\n}\nconst iconsMenuDefault = getDefaultIconLayout();\n\n/**\n * Get all module settings\n * @returns {Object} Module settings\n */\nexport const getSettings = () => {\n  return {\n    generalSettings: {\n      tag: \"flash5e-general-settings\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      title: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      propType: Object,\n      fields: [\n        'skipRollDialog',\n        'skipRollDialogOption',\n        'skipToRollResolver',\n        'showOnlyPCsWithToken',\n        'addMacrosToFolder',\n        'templateAutoTarget',\n        'removeTemplate',\n        'tooltipAutoDismiss',\n        'templateRemovalTimeout',\n        'tokenMovementSpeed',\n        'autoBlockMovementInCombat',\n        'disableNotifications'\n      ],\n      default: {\n        skipRollDialog: false,\n        skipRollDialogOption: 1,\n        skipToRollResolver: false,\n        showOnlyPCsWithToken: true,\n        addMacrosToFolder: true,\n        templateAutoTarget: 1,\n        removeTemplate: true,\n        tooltipAutoDismiss: 2,\n        tokenMovementSpeed: 6,\n        templateRemovalTimeout: 5,\n        autoBlockMovementInCombat: false,\n        disableNotifications: false\n      },\n      scope: SETTING_SCOPE.world,\n      config: false, \n      requiresReload: false \n    },\n\n    interfaceSettings: {\n      tag: \"flash5e-interface-settings\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      title: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      propType: Object,\n      fields: [\n        'showMenuOnLoad',\n        'showTokenVisionOnHover',\n        'compactMode',\n        'actorStatsToShow',\n        'menuLayout',\n        'menuIconsLayout',\n        'maxIconsPerRow',\n        'teleportAnimationPath',\n        'lockMenuPosition'\n      ],\n      default: {\n        showMenuOnLoad: true,\n        showTokenVisionOnHover: true,\n        compactMode: true,\n        actorStatsToShow: { hp: true, ac: true, dc: true, prc: true },\n        menuLayout: \"vertical\",\n        menuIconsLayout: iconsMenuDefault,\n        maxIconsPerRow: 5,\n        teleportAnimationPath: '',\n        lockMenuPosition: false\n      },\n      scope: SETTING_SCOPE.world,\n      config: false,\n      requiresReload: false\n    },\n\n    groupRollsSettings: {\n      tag: \"flash5e-group-rolls-settings\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      title: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      propType: Object,\n      fields: [\n        'groupRollsMsgEnabled',\n        'groupRollResultMode',\n        'groupCalculationForSaves',\n        'showGroupDCToPlayers',\n        'showGroupResultToPlayers',\n        'groupRollNPCHidden',\n        'concealNPCNames',\n        'interceptTidySheetsGroupRolls',\n        'autoSelectOnGroupRoll'\n      ],\n      default: {\n        groupRollsMsgEnabled: true,\n        groupRollResultMode: 1,\n        groupCalculationForSaves: false,\n        showGroupDCToPlayers: false,\n        showGroupResultToPlayers: true,\n        groupRollNPCHidden: true,\n        concealNPCNames: false,\n        interceptTidySheetsGroupRolls: true,\n        autoSelectOnGroupRoll: 0\n      },\n      scope: SETTING_SCOPE.world,\n      config: false,\n      requiresReload: false\n    },\n\n    rollRequestsSettings: {\n      tag: \"flash5e-roll-request-settings\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      title: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      propType: Object,\n      fields: [\n        'rollInterceptionEnabled',\n        'showRequestPrompt',\n        'useGMTargetTokens',\n        'consumptionConfigMode',\n        'placeTemplateForPlayer',\n        'showOfflineNotifications',\n        'initiateCombatOnRequest',\n        'publicPlayerRolls',\n        'useCondensedRollMessage',\n        'removeSaveMsgAfterRoll'\n      ],\n      default: {\n        rollInterceptionEnabled: true,\n        showRequestPrompt: true,\n        useGMTargetTokens: true,\n        consumptionConfigMode: 2,\n        placeTemplateForPlayer: false,\n        showOfflineNotifications: true,\n        initiateCombatOnRequest: true,\n        publicPlayerRolls: false,\n        useCondensedRollMessage: false,\n        removeSaveMsgAfterRoll: false\n      },\n      scope: SETTING_SCOPE.world,\n      config: false,\n      requiresReload: false\n    },\n\n    integrationSettings: {\n      tag: \"flash5e-integration-settings\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      title: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      propType: Object,\n      fields: [\n        'ddbRollOwnership',\n        'ddbNoAutoConsumeSpellSlot',\n        'ddbImportSourcePriority',\n        'ddbImportSpellMode'\n      ],\n      default: {\n        ddbRollOwnership: 0,\n        ddbNoAutoConsumeSpellSlot: false,\n        ddbImportSourcePriority: 0,\n        ddbImportSpellMode: 0\n      },\n      scope: SETTING_SCOPE.world,\n      config: false,\n      requiresReload: false\n    },\n\n    showGroupDCToPlayers: {\n      tag: \"show-group-dc-to-players\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showGroupDCToPlayers.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showGroupDCToPlayers.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showGroupResultToPlayers: {\n      tag: \"show-group-result-to-players\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showGroupResultToPlayers.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showGroupResultToPlayers.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    groupRollNPCHidden: {\n      tag: \"group-roll-npc-hidden\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollNPCHidden.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollNPCHidden.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    concealNPCNames: {\n      tag: \"conceal-npc-names\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.concealNPCNames.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.concealNPCNames.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    interceptTidySheetsGroupRolls: {\n      tag: \"intercept-tidy-sheets-group-rolls\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.interceptTidySheetsGroupRolls.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.interceptTidySheetsGroupRolls.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    autoSelectOnGroupRoll: {\n      tag: \"auto-select-on-group-roll\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.autoSelectOnGroupRoll.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.autoSelectOnGroupRoll.hint\"),\n      propType: Number,\n      inputType: SETTING_INPUT.select,\n      choices: {\n        0: game.i18n.localize(\"FLASH_ROLLS.settings.autoSelectOnGroupRoll.choices.0\"),\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.autoSelectOnGroupRoll.choices.1\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.autoSelectOnGroupRoll.choices.2\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.autoSelectOnGroupRoll.choices.3\")\n      },\n      default: 0,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    rollRequestsEnabled: {\n      tag: \"roll-requests-enabled\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.rollRequestsEnabled.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.rollRequestsEnabled.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: true\n    },\n    \n    groupRollsMsgEnabled: {\n      tag: \"group-roll-enabled\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollsMsgEnabled.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollsMsgEnabled.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    groupRollResultMode: {\n      tag: \"group-roll-result-mode\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.hint\"),\n      propType: Number,\n      inputType: SETTING_INPUT.select,\n      choices: {\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.1\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.2\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.3\"),\n        4: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.4\")\n      },\n      default: 1,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    groupCalculationForSaves: {\n      tag: \"group-calculation-for-saves\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.groupCalculationForSaves.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.groupCalculationForSaves.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    consumptionConfigMode: {\n      tag: \"consumption-config\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.hint\"),\n      propType: Number, \n      inputType: SETTING_INPUT.select,\n      choices: {\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.1\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.2\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.3\"),\n        4: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.4\")\n      },\n      default: 2,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    \n    placeTemplateForPlayer: {\n      tag: \"place-template-for-player\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.placeTemplateForPlayer.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.placeTemplateForPlayer.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    skipRollDialog: {\n      tag: \"skip-roll-dialog\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialog.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialog.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    skipRollDialogOption: {\n      tag: \"skip-roll-dialog-options\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialogOption.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialogOption.hint\"),\n      propType: Number,\n      inputType: SETTING_INPUT.select,\n      choices: {\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialogOption.choices.1\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialogOption.choices.2\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialogOption.choices.3\")\n      },\n      default: 1,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    skipToRollResolver: {\n      tag: \"skip-to-roll-resolver\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.skipToRollResolver.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.skipToRollResolver.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    useGMTargetTokens: {\n      tag: \"use-gm-target-tokens\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.useGMTargetTokens.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.useGMTargetTokens.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    rollInterceptionEnabled: {\n      tag: \"roll-interception-on\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.rollInterceptionEnabled.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.rollInterceptionEnabled.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    showRequestPrompt: {\n      tag: \"show-request-prompt\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showRequestPrompt.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showRequestPrompt.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    publicPlayerRolls: {\n      tag: \"public-player-roll-messages\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.publicPlayerRolls.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.publicPlayerRolls.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showOfflineNotifications: {\n      tag: \"show-offline-notifications\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showOfflineNotifications.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showOfflineNotifications.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showRequestNotifications: {\n      tag: \"show-request-notifications\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showRequestNotifications.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showRequestNotifications.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    initiateCombatOnRequest: {\n      tag: \"initiate-combat-on-request\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.initiateCombatOnRequest.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.initiateCombatOnRequest.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    useCondensedRollMessage: {\n      tag: \"use-condensed-roll-message\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.useCondensedRollMessage.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.useCondensedRollMessage.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    removeSaveMsgAfterRoll: {\n      tag: \"remove-save-msg-after-roll\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.removeSaveMsgAfterRoll.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.removeSaveMsgAfterRoll.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showOnlyPCsWithToken: {\n      tag: \"show-only-pcs-with-token\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showOnlyPCsWithToken.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showOnlyPCsWithToken.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    compactMode: {\n      tag: \"compact-mode\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.compactMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.compactMode.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    actorStatsToShow: {\n      tag: \"actor-stats-to-show\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.actorStatsToShow.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.actorStatsToShow.hint\"),\n      propType: Object,\n      default: { hp: true, ac: true, dc: true, prc: true },\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    menuLayout: {\n      tag: \"menu-layout\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.menuLayout.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.menuLayout.hint\"),\n      propType: String,\n      inputType: SETTING_INPUT.select,\n      choices: {\n        \"vertical\": game.i18n.localize(\"FLASH_ROLLS.settings.menuLayout.choices.vertical\"),\n        \"horizontal\": game.i18n.localize(\"FLASH_ROLLS.settings.menuLayout.choices.horizontal\")\n      },\n      default: \"vertical\",\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    lockMenuPosition: {\n      tag: \"lock-menu-position\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.lockMenuPosition.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.lockMenuPosition.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    maxIconsPerRow: {\n      tag: \"max-icons-per-row\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.maxIconsPerRow.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.maxIconsPerRow.hint\"),\n      propType: Number,\n      default: 5,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showOptionsListOnHover: {\n      tag: \"show-list-on-hover\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showOptionsListOnHover.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showOptionsListOnHover.hint\"),\n      propType: Boolean,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    templateAutoTarget: { \n      tag: \"template-auto-target\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.hint\"),\n      propType: Number,\n      choices: {\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.choices.all.label\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.choices.notFriendly.label\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.choices.none.label\"),\n      },\n      inputType: SETTING_INPUT.select,\n      default: 1,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    removeTemplate: {\n      tag: \"remove-template\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.removeTemplate.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.removeTemplate.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    templateRemovalTimeout: {\n      tag: \"template-removal-timeout\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.templateRemovalTimeout.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.templateRemovalTimeout.hint\"),\n      propType: Number,\n      default: 5,\n      scope: SETTING_SCOPE.world,\n      config: false,\n      range: {\n        min: 0,\n        max: 30,\n        step: 1\n      }\n    },\n\n    debugMode: {\n      tag: \"debug-mode-on\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.debugMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.debugMode.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.client,\n      config: true\n    },\n\n    showMenuOnLoad: {\n      tag: \"show-menu-on-load\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showMenuOnLoad.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showMenuOnLoad.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showTokenVisionOnHover: {\n      tag: \"show-token-vision-on-hover\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showTokenVisionOnHover.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showTokenVisionOnHover.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    addMacrosToFolder: {\n      tag: \"add-macros-to-folder\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.addMacrosToFolder.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.addMacrosToFolder.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    menuIconsLayout: {\n      tag: \"menu-icons-layout\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.menuIconsLayout.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.menuIconsLayout.hint\"),\n      propType: Object,\n      default: iconsMenuDefault,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    autoBlockMovementInCombat: {\n      tag: \"auto-block-movement-in-combat\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.autoBlockMovementInCombat.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.autoBlockMovementInCombat.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    tokenMovementSpeed: {\n      tag: \"token-movement-speed\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.tokenMovementSpeed.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.tokenMovementSpeed.hint\"),\n      propType: Number,\n      default: 6,\n      scope: SETTING_SCOPE.world,\n      config: false,\n      range: {\n        min: 1,\n        max: 20,\n        step: 1\n      }\n    },\n\n    tooltipAutoDismiss: {\n      tag: \"tooltip-auto-dismiss\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.tooltipAutoDismiss.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.tooltipAutoDismiss.hint\"),\n      propType: Number,\n      default: 2,\n      scope: SETTING_SCOPE.world,\n      config: false,\n      range: {\n        min: 0,\n        max: 10,\n        step: 1\n      }\n    },\n\n    teleportAnimationPath: {\n      tag: \"teleport-animation-path\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.teleportAnimationPath.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.teleportAnimationPath.hint\"),\n      propType: String,\n      inputType: \"filepicker\",\n      default: \"\",\n      scope: SETTING_SCOPE.world,\n      config: false,\n      filePicker: \"video\"\n    },\n\n    legacyTokenAssociationsMigrated: {\n      tag: \"legacy-token-associations-migrated\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.legacyTokenAssociationsMigrated.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.legacyTokenAssociationsMigrated.hint\"),\n      propType: Boolean,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    disableNotifications: {\n      tag: \"disable-notifications\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.disableNotifications.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.disableNotifications.hint\"),\n      propType: Boolean,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    lastUpdateId: {\n      tag: \"last-update-id\",\n      label: \"Last Update ID\",\n      hint: \"Stores the ID of the last update news shown\",\n      propType: String,\n      default: \"\",\n      scope: SETTING_SCOPE.client,\n      config: false\n    },\n\n    libWrapperNotificationShown: {\n      tag: \"libwrapper-notification-shown\",\n      label: \"LibWrapper Notification Shown\",\n      hint: \"Tracks whether the libWrapper recommendation notification has been shown\",\n      propType: Boolean,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    transformFavorites: {\n      tag: \"transform-favorites\",\n      label: \"Transformation Favorites\",\n      hint: \"Stores favorite transformation targets\",\n      propType: Array,\n      default: [],\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    ddbCampaignId: {\n      tag: \"ddb-campaign-id\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.ddbCampaignId.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.ddbCampaignId.hint\"),\n      propType: String,\n      default: \"\",\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    ddbUserId: {\n      tag: \"ddb-user-id\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.ddbUserId.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.ddbUserId.hint\"),\n      propType: String,\n      default: \"\",\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    ddbCobaltCookie: {\n      tag: \"ddb-cobalt-cookie\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.ddbCobaltCookie.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.ddbCobaltCookie.hint\"),\n      propType: String,\n      default: \"\",\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    proxyApiKey: {\n      tag: \"proxy-api-key\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.proxyApiKey.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.proxyApiKey.hint\"),\n      propType: String,\n      default: \"\",\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    ddbCharacterMappings: {\n      tag: \"ddb-character-mappings\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.ddbCharacterMappings.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.ddbCharacterMappings.hint\"),\n      propType: Object,\n      default: {},\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    ddbImportOwnership: {\n      tag: \"ddb-import-ownership\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportOwnership.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportOwnership.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    ddbRollOwnership: {\n      tag: \"ddb-roll-ownership\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.ddbRollOwnership.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.ddbRollOwnership.hint\"),\n      propType: Number,\n      inputType: SETTING_INPUT.select,\n      choices: {\n        0: game.i18n.localize(\"FLASH_ROLLS.settings.ddbRollOwnership.choices.0\"),\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.ddbRollOwnership.choices.1\")\n      },\n      default: 0,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    ddbNoAutoConsumeSpellSlot: {\n      tag: \"ddb-no-auto-consume-spell-slot\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.ddbNoAutoConsumeSpellSlot.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.ddbNoAutoConsumeSpellSlot.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    ddbImportSourcePriority: {\n      tag: \"ddb-import-source-priority\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportSourcePriority.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportSourcePriority.hint\"),\n      propType: Number,\n      inputType: SETTING_INPUT.select,\n      choices: {\n        0: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportSourcePriority.choices.0\"),\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportSourcePriority.choices.1\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportSourcePriority.choices.2\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportSourcePriority.choices.3\")\n      },\n      default: 0,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    ddbImportSpellMode: {\n      tag: \"ddb-import-spell-mode\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportSpellMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportSpellMode.hint\"),\n      propType: Number,\n      inputType: SETTING_INPUT.select,\n      choices: {\n        0: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportSpellMode.choices.0\"),\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.ddbImportSpellMode.choices.1\")\n      },\n      default: 0,\n      scope: SETTING_SCOPE.world,\n      config: false\n    }\n  };\n};\n","/**\n * Module ID constant\n * @constant\n * @type {string}\n */\nexport const MODULE_ID = \"flash-rolls-5e\";\n\n/**\n * Debug tag for console logging\n * @constant\n * @type {Array}\n */\nexport const DEBUG_TAG = [\n  `%cFlash Token Bar 5e`,\n  `color:rgb(47, 151, 161); font-weight: bold;`,\n  `|`,\n];\n\nexport const SOCKET_CALLS = {\n  receiveDiceConfig: \"receiveDiceConfig\",\n  getDiceConfig: \"getDiceConfig\",\n  handleRollRequest: \"handleRollRequest\",\n  removeTemplate: \"removeTemplate\",\n  broadcastRollComplete: \"broadcastRollComplete\",\n  deleteChatMessage: \"deleteChatMessage\"\n};\n\nexport const HOOK_NAMES = {\n  ATTACK: { name: \"attack\", requestType: \"attack\" },\n  DAMAGE: { name: \"damage\", requestType: \"damage\" },\n  SAVE: { name: \"save\", requestType: \"damage\" },\n  SAVING_THROW: { name: \"savingthrow\", requestType: \"check\" },\n  ABILITY_CHECK: { name: \"abilitycheck\", requestType: \"check\" },\n  CONCENTRATION: { name: \"concentration\", requestType: \"check\" },\n  DEATH_SAVE: { name: \"deathsave\", requestType: \"save\" }, \n  SKILL: { name: \"skill\", requestType: \"check\" },\n  TOOL: { name: \"tool\", requestType: \"check\" },\n  HIT_DIE: { name: \"hitdie\", requestType: \"formula\" },\n  INITIATIVE: { name: \"initiative\", requestType: \"check\" },\n  FORMULA: { name: \"formula\", requestType: \"formula\" },\n  RECHARGE: { name: \"recharge\", requestType: \"formula\" },\n  D20_TEST: { name: \"d20Test\", requestType: \"formula\" },\n  SHORT_REST: { name: \"shortRest\", requestType: \"formula\" },\n  LONG_REST: { name: \"longRest\", requestType: \"formula\" },\n};\n\nexport const ACTIVITY_TYPES = {\n  ATTACK: \"attack\",\n  CAST: \"cast\",\n  CHECK: \"check\",\n  DAMAGE: \"damage\",\n  ENCHANT: \"enchant\",\n  FORWARD: \"forward\",\n  HEAL: \"heal\",\n  ORDER: \"order\",\n  SAVE: \"save\",\n  SUMMON: \"summon\",\n  TRANSFORM: \"transform\",\n  UTILITY: \"utility\"\n};\n\nexport const CALL_TYPE = {\n  ACTIVITY: \"activity\",\n  CHECK: \"check\",\n}\n\nexport const BUTTON_ACTION_TYPES = {\n  ROLL_REQUEST: \"rollRequest\",\n  ROLL_ATTACK: \"rollAttack\",\n  ROLL_DAMAGE: \"rollDamage\"\n}\n\nexport const DICE_OPTIONS = {\n  'd4': 'd4',\n  'd6': 'd6',\n  'd8': 'd8',\n  'd10': 'd10',\n  'd12': 'd12',\n  'd20': 'd20',\n  'd100': 'd100'\n};\n\n/**\n * Roll types used throughout the module\n * @constant\n * @type {Object}\n */\nexport const ROLL_TYPES = {\n  ABILITY: \"ability\",\n  ABILITY_CHECK: \"abilitycheck\",\n  ATTACK: \"attack\",\n  CONCENTRATION: \"concentration\",\n  CUSTOM: \"custom\",\n  DEATH_SAVE: \"deathsave\",\n  FORMULA: \"formula\",\n  DAMAGE: \"damage\",\n  HEALING: \"healing\",\n  HIT_DIE: \"hitdie\",\n  INITIATIVE: \"initiative\",\n  INITIATIVE_DIALOG: \"initiativedialog\",\n  ITEM_SAVE: \"itemsave\",\n  SAVE: \"save\",\n  SAVING_THROW: \"savingthrow\",\n  SKILL: \"skill\",\n  TOOL: \"tool\"\n}\n\nexport const ROLL_REQUEST_OPTIONS = {\n  ABILITY_CHECK: { name: ROLL_TYPES.ABILITY_CHECK, label: \"Ability Check\", subList: \"abilities\", actorPath: 'system.abilities' },\n  SAVING_THROW: { name: ROLL_TYPES.SAVING_THROW, label: \"Saving Throw\", subList: \"abilities\", actorPath: 'system.abilities' },\n  SKILL: { name: ROLL_TYPES.SKILL, label: \"Skill Check\", subList: \"skills\", actorPath: 'system.skills' },\n  TOOL: { name: ROLL_TYPES.TOOL, label: \"Tool Check\", subList: \"tools\", actorPath: 'system.tools' },\n  CONCENTRATION: { name: ROLL_TYPES.CONCENTRATION, label: \"Concentration Check\", subList: null, actorPath: '' },\n  INITIATIVE: { name: ROLL_TYPES.INITIATIVE, label: \"Initiative Roll\", subList: null, actorPath: '' },\n  DEATH_SAVE: { name: ROLL_TYPES.DEATH_SAVE, label: \"Death Save\", subList: null, actorPath: '' },\n  // ITEM_SAVE: { name: ROLL_TYPES.ITEM_SAVE, label: \"Item Save\", subList: null, actorPath: '' },\n  HIT_DIE: { name: ROLL_TYPES.HIT_DIE, label: \"Hit Die\", subList: null, actorPath: '' },\n  CUSTOM: { name: ROLL_TYPES.CUSTOM, label: \"Custom Roll\", subList: null, actorPath: '' },\n}\n\n/**\n * Module configuration object\n * @constant\n * @type {Object}\n */\nexport const MODULE = {\n  ID: MODULE_ID,\n  ROLL_REQUEST_OPTIONS: ROLL_REQUEST_OPTIONS\n}\n","/**\n * Core Foundry hooks\n * @constant\n * @type {Object}\n */\nexport const HOOKS_CORE = {\n  INIT: \"init\",\n  READY: \"ready\",\n  RENDER_CHAT_MESSAGE: \"renderChatMessageHTML\",\n  RENDER_CHAT_LOG: \"renderChatLog\",\n  RENDER_CHAT_INPUT: \"renderChatInput\",\n  // RENDER_SIDEBAR_TAB: \"renderSidebarTab\",\n  CHANGE_SIDEBAR_TAB: \"changeSidebarTab\", \n  RENDER_SIDEBAR: \"renderSidebar\",\n  RENDER_APPLICATION_V2: \"renderApplicationV2\",\n  UPDATE_SCENE: \"updateScene\",\n  RENDER_SCENE_NAVIGATION: \"renderSceneNavigation\",\n  RENDER_ROLL_RESOLVER: \"renderRollResolver\",\n  USER_CONNECTED: \"userConnected\",\n  PRE_CREATE_CHAT_MESSAGE: \"preCreateChatMessage\",\n  CREATE_CHAT_MESSAGE: \"createChatMessage\",\n  RENDER_ROLL_CONFIGURATION_DIALOG: \"renderRollConfigurationDialog\",\n  COLLAPSE_SIDE_BAR: \"collapseSidebar\",\n  REFRESH_MEASURED_TEMPLATE: \"refreshMeasuredTemplate\",\n  CONTROL_TOKEN: \"controlToken\",\n  UPDATE_TOKEN: \"updateToken\",\n  PRE_UPDATE_TOKEN: \"preUpdateToken\",\n  DELETE_TOKEN: \"deleteToken\",\n  CREATE_TOKEN: \"createToken\",\n  UPDATE_ACTOR: \"updateActor\",\n  CREATE_ACTOR: \"createActor\",\n  DELETE_ACTOR: \"deleteActor\",\n  UPDATE_ITEM: \"updateItem\",\n  CREATE_ITEM: \"createItem\",\n  DELETE_ITEM: \"deleteItem\",\n  UPDATE_SETTING: \"updateSetting\",\n  CLIENT_SETTING_CHANGED: \"clientSettingChanged\",\n  GET_ACTOR_CONTEXT_OPTIONS: \"getActorContextOptions\",\n  GET_CHAT_MESSAGE_CONTEXT_OPTIONS: \"getChatMessageContextOptions\",\n  RENDER_ACTOR_DIRECTORY: \"renderActorDirectory\",\n  CREATE_COMBATANT: \"createCombatant\",\n  DELETE_COMBATANT: \"deleteCombatant\",\n  UPDATE_COMBAT: \"updateCombat\",\n  DELETE_COMBAT: \"deleteCombat\",\n  COMBAT_START: \"combatStart\",\n  COMBAT_TURN: \"combatTurn\",\n  COMBAT_TURN_CHANGE: \"combatTurnChange\",\n  COMBAT_ROUND: \"combatRound\",\n  CREATE_ACTIVE_EFFECT: \"createActiveEffect\",\n  DELETE_ACTIVE_EFFECT: \"deleteActiveEffect\",\n  UPDATE_ACTIVE_EFFECT: \"updateActiveEffect\",\n  RENDER_APPLICATION: \"renderApplication\",\n  PRE_CREATE_TOKEN: \"preCreateToken\",\n  CANVAS_READY: \"canvasReady\"\n};\n\n/**\n * Socketlib hooks\n */\nexport const HOOKS_SOCKET = {\n  READY: \"socketlib.ready\"\n}\n\n/**\n * Midi-QOL hooks\n */\nexport const HOOKS_MIDI_QOL = {\n  READY: \"midi-qol.ready\",\n  PRE_ITEM_ROLL: \"midi-qol.preItemRoll\",\n  PRE_DAMAGE_ROLL: \"midi-qol.preDamageRoll\"\n}\n\n/**\n * DnD5e hooks\n */\nexport const HOOKS_DND5E = {\n  // General Rolling Process\n  PRE_ROLL_V2: \"dnd5e.preRollV2\",\n\n  // Activity\n  PRE_USE_ACTIVITY: \"dnd5e.preUseActivity\",\n  POST_USE_ACTIVITY: \"dnd5e.postUseActivity\",\n  \n  // Ability Checks & Saving Throws\n  PRE_ROLL_ABILITY_CHECK: \"dnd5e.preRollAbilityCheckV2\",\n  PRE_ROLL_SAVING_THROW: \"dnd5e.preRollSavingThrowV2\",\n  ROLL_ABILITY_CHECK: \"dnd5e.rollAbilityCheckV2\",\n  ROLL_SAVING_THROW: \"dnd5e.rollSavingThrowV2\",\n  \n  // Concentration\n  PRE_BEGIN_CONCENTRATING: \"dnd5e.preBeginConcentrating\",\n  BEGIN_CONCENTRATING: \"dnd5e.beginConcentrating\",\n  PRE_END_CONCENTRATION: \"dnd5e.preEndConcentration\",\n  END_CONCENTRATION: \"dnd5e.endConcentration\",\n  PRE_ROLL_CONCENTRATION_V2: \"dnd5e.preRollConcentrationV2\",\n  ROLL_CONCENTRATION_V2: \"dnd5e.rollConcentrationV2\",\n  \n  // Damage\n  PRE_CALCULATE_DAMAGE: \"dnd5e.preCalculateDamage\",\n  CALCULATE_DAMAGE: \"dnd5e.calculateDamage\",\n  PRE_APPLY_DAMAGE: \"dnd5e.preApplyDamage\",\n  APPLY_DAMAGE: \"dnd5e.applyDamage\",\n  \n  // Death Saves\n  PRE_ROLL_DEATH_SAVE_V2: \"dnd5e.preRollDeathSaveV2\",\n  ROLL_DEATH_SAVE_V2: \"dnd5e.rollDeathSaveV2\",\n  POST_ROLL_DEATH_SAVE: \"dnd5e.postRollDeathSave\",\n  \n  // Skills & Tools\n  PRE_ROLL_SKILL_V2: \"dnd5e.preRollSkillV2\",\n  PRE_ROLL_TOOL_V2: \"dnd5e.preRollToolV2\",\n  ROLL_SKILL_V2: \"dnd5e.rollSkillV2\",\n  ROLL_TOOL_V2: \"dnd5e.rollToolV2\",\n  \n  // Hit Dice\n  PRE_ROLL_HIT_DIE_V2: \"dnd5e.preRollHitDieV2\",\n  ROLL_HIT_DIE_V2: \"dnd5e.rollHitDieV2\",\n  \n  // Hit Points\n  PRE_ROLL_CLASS_HIT_POINTS: \"dnd5e.preRollClassHitPoints\",\n  ROLL_CLASS_HIT_POINTS: \"dnd5e.rollClassHitPoints\",\n  PRE_ROLL_NPC_HIT_POINTS: \"dnd5e.preRollNPCHitPoints\",\n  ROLL_NPC_HIT_POINTS: \"dnd5e.rollNPChitPoints\",\n  \n  // Initiative\n  PRE_CONFIGURE_INITIATIVE: \"dnd5e.preConfigureInitiative\",\n  PRE_ROLL_INITIATIVE_DIALOG: \"dnd5e.preRollInitiativeDialog\",\n  // PRE_ROLL_INITIATIVE_DIALOG_V2: \"dnd5e.preRollInitiativeDialogV2\",\n  PRE_ROLL_INITIATIVE: \"dnd5e.preRollInitiative\",\n  ROLL_INITIATIVE: \"dnd5e.rollInitiative\",\n  \n  // Attacks\n  PRE_ROLL_ATTACK_V2: \"dnd5e.preRollAttackV2\",\n  ROLL_ATTACK_V2: \"dnd5e.rollAttackV2\",\n  POST_ROLL_ATTACK: \"dnd5e.postRollAttack\",\n  \n  // Damage Rolls\n  PRE_ROLL_DAMAGE_V2: \"dnd5e.preRollDamageV2\",\n  ROLL_DAMAGE_V2: \"dnd5e.rollDamageV2\",\n  \n  // Formula Rolls\n  PRE_ROLL_FORMULA_V2: \"dnd5e.preRollFormulaV2\",\n  ROLL_FORMULA_V2: \"dnd5e.rollFormulaV2\",\n  \n  // Recharge Rolls\n  PRE_ROLL_RECHARGE_V2: \"dnd5e.preRollRechargeV2\",\n  ROLL_RECHARGE_V2: \"dnd5e.rollRechargeV2\",\n  \n  // Car Display\n  PRE_DISPLAY_CARD_V2: \"dnd5e.preDisplayCardV2\",\n  DISPLAY_CARD: \"dnd5e.displayCard\",\n\n  // Config\n  BUILD_ROLL_CONFIG: \"dnd5e.buildRollConfig\",\n  POST_BUILD_ROLL_CONFIG: \"dnd5e.postBuildRollConfig\",\n  POST_ROLL_CONFIG: \"dnd5e.postRollConfiguration\",\n\n  // Pre-Roll Hooks (before dialog)\n  PRE_ROLL_ATTACK: \"dnd5e.preRollAttack\",\n  PRE_ROLL_DAMAGE: \"dnd5e.preRollDamage\",\n\n  // Post Roll Configuration Hooks (after config, before evaluation)\n  POST_ATTACK_ROLL_CONFIGURATION: \"dnd5e.postAttackRollConfiguration\",\n  POST_DAMAGE_ROLL_CONFIGURATION: \"dnd5e.postDamageRollConfiguration\",\n  POST_ABILITY_CHECK_ROLL_CONFIGURATION: \"dnd5e.postAbilityCheckRollConfiguration\",\n  POST_SKILL_CHECK_ROLL_CONFIGURATION: \"dnd5e.postSkillCheckRollConfiguration\",\n  POST_SAVING_THROW_ROLL_CONFIGURATION: \"dnd5e.postSavingThrowRollConfiguration\",\n\n  // Rendering\n  RENDER_ROLL_CONFIGURATION_DIALOG: \"renderRollConfigurationDialog\",\n  RENDER_SKILL_TOOL_ROLL_DIALOG: \"renderSkillToolRollConfigurationDialog\",\n  RENDER_FORMULA_ROLL_DIALOG: \"renderFormulaRollConfigurationDialog\",\n  RENDER_CHAT_MESSAGE: \"renderChatMessageHTML\",\n\n  // Actor Sheets\n  RENDER_GROUP_ACTOR_SHEET: \"renderGroupActorSheet\",\n  RENDER_ENCOUNTER_ACTOR_SHEET: \"renderEncounterActorSheet\",\n}\n\n/**\n * Tidy5e Sheets Hooks\n * @constant\n * @type {Object}\n */\nexport const HOOKS_TIDY5E = {\n  READY: \"tidy5e-sheet.ready\",\n  PRE_PROMPT_GROUP_SKILL_ROLL: \"tidy5e-sheet.prePromptGroupSkillRoll\",\n  RENDER_ACTOR_SHEET: \"tidy5e-sheet.renderActorSheet\",\n  RENDER_GROUP_SHEET_QUADRONE: \"renderTidy5eGroupSheetQuadrone\",\n  RENDER_GROUP_SHEET_CLASSIC: \"renderTidy5eGroupSheetClassic\",\n  RENDER_ENCOUNTER_SHEET_QUADRONE: \"renderTidy5eEncounterSheetQuadrone\",\n  RENDER_ENCOUNTER_SHEET_CLASSIC: \"renderTidy5eEncounterSheetClassic\"\n}\n\n/**\n * Flash Token Bar 5e Hooks\n * @constant\n * @type {Object}\n */\nexport const HOOKS_MODULE = {\n  READY: \"ready\"\n}","import { DEBUG_TAG, MODULE_ID } from \"../../constants/General.mjs\";\n\n/**\n * Handles logging operations in the module\n * Provides methods for debug, warning, and error logging with module context\n */\nexport class LogUtil {\n  /** @type {boolean} Whether debug logging is enabled */\n  static debugOn = false;\n\n  /**\n   * Logs information to the console, adding module name and reference\n   * @param {string} ref - Reference information to log after module name\n   * @param {Array|*} data - array of items to log on console, or a single item that will be wrapped in an array\n   * @param {boolean} [bypassSettings=false] - Whether to bypass debug settings check\n   */\n  static log(ref=\"\", data=[], bypassSettings=false) {\n    try {\n      const debugSetting = game.settings.get(MODULE_ID, \"debug-mode-on\") || LogUtil.debugOn;\n      const isDebugModeOn = bypassSettings || debugSetting;\n      if(!isDebugModeOn) { return; }\n      \n      // Ensure data is an array\n      const dataArray = Array.isArray(data) ? data : [data];\n      console.log(...DEBUG_TAG, ref, ...dataArray);\n    } catch(e) {\n      // If settings aren't available yet, check bypassSettings\n      if (bypassSettings || LogUtil.debugOn) {\n        // Ensure data is an array\n        const dataArray = Array.isArray(data) ? data : [data];\n        console.log(...DEBUG_TAG, ref, ...dataArray);\n      }\n    }\n  }\n\n  /**\n   * Outputs warning on console, adding module name and reference\n   * @param {string} ref - Reference information to log after module name\n   * @param {Array|*} data - array of items to log on console, or a single item that will be wrapped in an array\n   */\n  static warn(ref=\"\", data=[]) {\n    // Ensure data is an array\n    const dataArray = Array.isArray(data) ? data : [data];\n    console.warn(...DEBUG_TAG, ref, ...dataArray);\n  }\n\n  /**\n   * Logs an error to the console and/or UI notification\n   * @param {string} strRef - Reference string for the error\n   * @param {Array|*} data - array of items to log on console, or a single item that will be wrapped in an array\n   * @param {object} options - Error logging configuration\n   * @param {boolean} [options.ui=false] - Whether to show UI notification\n   * @param {boolean} [options.console=true] - Whether to log to console\n   * @param {boolean} [options.permanent=false] - Whether UI notification should be permanent\n   * @static\n   */\n  static error(strRef, data=[], options = { ui: false, console: true, permanent: false }) {\n    // Ensure data is an array\n    const dataArray = Array.isArray(data) ? data : [data];\n    \n    if(options.ui) {\n      ui.notifications?.error(strRef, { localize: true, permanent: options.permanent });\n    }\n    if(options.console) console.error(...DEBUG_TAG, strRef, ...dataArray);\n  }\n}","import { MODULE_ID } from \"../../constants/General.mjs\";\nimport { HOOKS_SOCKET } from \"../../constants/Hooks.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\n\n/**\n * Utility class for managing socket communication using socketlib.\n */\nexport class SocketUtil {\n  static socket;\n  static _activeExecutions = new Map();\n\n  /**\n   * Initializes the socket module and registers it with socketlib.\n   * This should be called once during FoundryVTT initialization.\n   * \n   * @param {Function} callbackFunc - Optional callback to execute after registration.\n   */\n  static initialize = (callbackFunc) => {\n    LogUtil.log('initialize', [callbackFunc]);\n\n    Hooks.once(HOOKS_SOCKET.READY, () => { \n      // Check if socketlib is available before registering the module\n      if (typeof socketlib === \"undefined\") {\n        LogUtil.error(\"SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled.\");\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.socketlibMissing\"), {permanent: true});\n        return;\n      }\n\n      try { \n        // Register the module with socketlib\n        SocketUtil.socket = socketlib.registerModule(MODULE_ID);\n\n        // Execute callback function if provided\n        if (callbackFunc) {\n          callbackFunc();\n        }\n\n      } catch (e) {\n        LogUtil.error(\"SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled.\", [e]);\n      }\n    });\n  }\n\n  /**\n   * Registers a callback function that can be called remotely via the socket.\n   * \n   * @param {string} name - The name of the remote function.\n   * @param {Function} func - The function to be executed remotely.\n   */\n  static registerCall = (name, func) => {\n    LogUtil.log('registerCall', [name, \"hasSocket:\", !!SocketUtil.socket]);\n    if (SocketUtil.socket) {\n      SocketUtil.socket.register(name, func);\n      LogUtil.log('registerCall - Registered successfully', [name]);\n    } else {\n      LogUtil.warn('registerCall - Socket not ready, registration failed!', [name]);\n    }\n  }\n\n  /**\n   * Sends a message via the socket (currently only logs it and calls a callback).\n   * \n   * @param {*} value - The message or data to send.\n   * @param {Function} callback - The callback function to execute after sending.\n   */\n  static sendMessage = (value, callback) => {\n    LogUtil.log('sendMessage', [value]);\n    if (callback) {\n        callback();\n    }\n  }\n\n  /**\n   * Executes a function as the GM.\n   * \n   * @param {Function} handler - The function to execute.\n   * @param {...*} parameters - The parameters to pass to the function.\n   * @returns {Promise} A promise resolving when the function executes.\n   */\n  static execForGMs = async (handler, ...parameters) => {\n    LogUtil.log('execForGMs', [handler, ...parameters]);\n    if (!SocketUtil.socket) {\n      return;\n    }\n    return await SocketUtil.socket.executeForAllGMs(handler, ...parameters);\n  }\n\n  /**\n   * Executes a function for all connected clients.\n   * \n   * @param {Function} handler - The function to execute.\n   * @param {...*} parameters - The parameters to pass to the function.\n   * @returns {Promise} A promise resolving when the function executes for all clients.\n   */\n  static execForAll = async (handler, ...parameters) => {\n    if (!SocketUtil.socket) {\n      return;\n    }\n    return await SocketUtil.socket.executeForEveryone(handler, ...parameters);\n  }\n\n\n  /**\n   * Executes a function as the specified user.\n   * @param {Function|string} handler - The function to execute or the name of a registered function.\n   * @param {String} userId - the id of the user that should execute this function\n   * @param {...*} parameters - The parameters to pass to the function.\n   * @returns {Promise} A promise resolving when the function executes.\n   */\n  static execForUser = async (handler, userId, ...parameters) => {\n    LogUtil.log('execForUser #0', [handler, userId, ...parameters]);\n    if (!SocketUtil.socket) {\n        return;\n    }\n\n    LogUtil.log('execForUser #1', [userId === game.user.id]);\n    if(userId === game.user.id){\n      return null; // Break the recursion\n    }\n\n    try {\n      const resp = await SocketUtil.socket.executeAsUser(handler, userId, ...parameters);\n      LogUtil.log('execForUser #2 - response', [resp]);\n      return resp;\n    } catch (error) {\n      LogUtil.error('execForUser #3 - error', [error]);\n      return null;\n    }\n  }\n\n  /**\n   * Serializes an object for transport, handling Roll objects properly\n   * @param {*} data - The data to serialize\n   * @returns {*} - Serialized data\n   */\n  static serializeForTransport(data, hasRolls=false) { \n    LogUtil.log('serializeForTransport', [data, hasRolls]);\n    // Handle null or undefined\n    if (data == null) return data;\n    \n    if (hasRolls && data.rolls && Array.isArray(data.rolls)) {\n      // data.rolls = data.rolls.map(r => SocketUtil.serializeForTransport(r));\n      \n      data.rolls = data.rolls.map(r => {\n        if(r instanceof Roll){\n          let serialized = r.toJSON();\n          return serialized;\n        }else{\n          return r;\n        }\n      });\n    }\n    \n    return data;\n  }\n\n  /**\n   * Deserializes data received from transport, reconstructing Roll objects\n   * @param {*} data - The serialized data\n   * @returns {*} - Deserialized data with reconstructed objects\n   */\n  static deserializeFromTransport(data, hasRolls=false) {\n    LogUtil.log('deserializeFromTransport', [data, hasRolls]);\n    let result = { ...data };\n    if (!data) return result;\n\n    if(hasRolls && data.rolls && data.rolls.length > 0){\n      const rolls = result.rolls.map(r => {\n        let roll = r;\n        if(typeof r === 'string'){\n          roll = Roll.fromJSON(r);\n        } else if (r instanceof Roll) {\n          roll = r;  // Already a Roll object\n        } else {\n          // Object that needs to be converted to Roll\n          roll = Roll.fromJSON(JSON.stringify(r));\n        }\n        return roll;\n      })\n      result.rolls = [...rolls];\n      return result;\n    }\n    \n    return result;\n  }\n\n}\n","import { LogUtil } from './LogUtil.mjs';\nimport { SocketUtil } from './SocketUtil.mjs';\n\n/**\n * Utility class for managing dice configurations across users\n */\nexport class DiceConfigUtil {\n  /**\n   * @type {Object} Current user's dice configuration\n   */\n  static diceConfig = {};\n  \n  /**\n   * @type {Object} All player dice configurations (GM only)\n   */\n  static playerDiceConfigs = {};\n  \n  /**\n   * Initialize the dice configuration for current user\n   */\n  static initialize() {\n    this.setDiceConfig();\n  }\n  \n  /**\n   * Set dice configuration from client settings\n   * @returns {Object} The dice configuration\n   */\n  static setDiceConfig() {\n    if (!game.user) return {};\n    \n    const clientSettings = game.settings.storage.get(\"client\");\n    this.diceConfig = clientSettings[`core.diceConfiguration`] || '';\n    \n    LogUtil.log(\"setDiceConfig\", [this.diceConfig]);\n\n    return this.diceConfig;\n  }\n  \n  /**\n   * Get the current user's dice configuration\n   * @returns {Object} The dice configuration\n   */\n  static getDiceConfig() {\n    if (!game.user) return {};\n    \n    // Ensure we have the latest configuration\n    this.setDiceConfig();\n    \n    // If GM, send config to GMs via socket\n    if (game.user.isGM) {\n      this._sendDiceConfigToGMs();\n    }\n    \n    return this.diceConfig;\n  }\n  \n  /**\n   * Send dice configuration to all GMs\n   * @private\n   */\n  static _sendDiceConfigToGMs() {\n    SocketUtil.execForGMs('receiveDiceConfig', game.user.id, this.diceConfig);\n  }\n  \n  /**\n   * Receive and store dice configuration from a player\n   * @param {string} userId - The user ID\n   * @param {string} diceConfig - The serialized dice configuration\n   */\n  static receiveDiceConfig(userId, diceConfig) {\n    if (game.user?.isGM || userId === game.user?.id) {\n      this.playerDiceConfigs[userId] = diceConfig ? JSON.parse(diceConfig) : {};\n    }\n  }\n  \n  /**\n   * Get dice configuration for a specific user\n   * @param {string} userId - The user ID\n   * @returns {Object} The user's dice configuration\n   */\n  static getUserDiceConfig(userId) {\n    if (userId === game.user?.id) {\n      return this.diceConfig;\n    }\n    \n    return this.playerDiceConfigs[userId] || {};\n  }\n  \n  /**\n   * Request dice configuration from a specific user\n   * @param {string} userId - The user ID to request from\n   */\n  static requestDiceConfigFromUser(userId) {\n    try {\n      SocketUtil.execForUser('getDiceConfig', userId);\n    } catch (error) {\n      LogUtil.log('Failed to request dice config from user:', [userId, error.message]);\n    }\n  }\n  \n  /**\n   * Request dice configuration from all active non-GM users\n   */\n  static requestDiceConfigFromAllPlayers() {\n    if (!game.user?.isGM) return;\n    \n    game.users.forEach(user => {\n      if (user.active && !user.isGM && user.id !== game.user.id) {\n        this.requestDiceConfigFromUser(user.id);\n      }\n    });\n  }\n  \n  /**\n   * Clear all stored player dice configurations\n   */\n  static clearPlayerConfigs() {\n    this.playerDiceConfigs = {};\n  }\n  \n  /**\n   * Check if a user has dice configuration stored\n   * @param {string} userId - The user ID\n   * @returns {boolean} True if configuration exists\n   */\n  static hasUserConfig(userId) {\n    if (userId === game.user?.id) {\n      return !!this.diceConfig;\n    }\n\n    return !!this.playerDiceConfigs[userId];\n  }\n\n  /**\n   * Check if the user is using non-digital dice (manual or interactive methods like bluetooth)\n   * @param {string} [userId] - Optional user ID to check. Defaults to current user.\n   * @returns {boolean} True if user has non-digital dice configured\n   */\n  static hasNonDigitalDice(userId) {\n    let config = userId ? this.getUserDiceConfig(userId) : this.diceConfig;\n\n    if (!config) {\n      this.setDiceConfig();\n      config = this.diceConfig;\n      LogUtil.log('hasNonDigitalDice - config was empty, refreshed:', [config]);\n    }\n\n    if (!config || (typeof config !== 'object' && typeof config !== 'string')) {\n      LogUtil.log('hasNonDigitalDice - no config or wrong type', [typeof config, config]);\n      return false;\n    }\n\n    let configObj;\n    try {\n      configObj = typeof config === 'string' ? JSON.parse(config) : config;\n    } catch (e) {\n      LogUtil.error('hasNonDigitalDice - failed to parse config', [config, e]);\n      return false;\n    }\n\n    const allMethods = CONFIG.Dice?.fulfillment?.methods;\n\n    LogUtil.log('hasNonDigitalDice - all available methods:', [allMethods]);\n    LogUtil.log('hasNonDigitalDice - user config:', [configObj]);\n\n    for (const method of Object.values(configObj)) {\n      if (!method) continue;\n\n      LogUtil.log('hasNonDigitalDice - checking method value:', [method]);\n\n      if (method === 'manual') {\n        LogUtil.log('hasNonDigitalDice - found manual method');\n        return true;\n      }\n\n      if (method !== 'random') {\n        const methodConfig = allMethods?.[method];\n        LogUtil.log('hasNonDigitalDice - found non-random method', [method, 'config:', methodConfig, 'interactive:', methodConfig?.interactive]);\n\n        if (methodConfig?.interactive) {\n          LogUtil.log('hasNonDigitalDice - method is interactive');\n          return true;\n        }\n\n        LogUtil.log('hasNonDigitalDice - treating non-random method as non-digital');\n        return true;\n      }\n    }\n\n    LogUtil.log('hasNonDigitalDice - no non-digital dice found');\n    return false;\n  }\n}","import { getSettings } from \"../../constants/Settings.mjs\";\nimport { LogUtil } from \"./LogUtil.mjs\";\nimport { SettingsUtil } from \"./SettingsUtil.mjs\";\nimport { SocketUtil } from \"./SocketUtil.mjs\";\n\n/**\n * Utility class providing general-purpose functionality for the module */\nexport class GeneralUtil {\n  /**\n   * Shows a notification message if notifications are enabled\n   * @param {string} type - The notification type: 'info', 'warn', or 'error'\n   * @param {string} message - The message to display\n   */\n  static notify(type, message) {\n    try {\n      const SETTINGS = getSettings();\n      if (SETTINGS?.disableNotifications?.tag) {\n        const disableNotifications = SettingsUtil.get(SETTINGS.disableNotifications.tag);\n        if (disableNotifications) {\n          return;\n        }\n      }\n    } catch (error) {\n      // If settings aren't available yet, just show the notification\n    }\n\n    if (type === 'info') {\n      ui.notifications.info(message);\n    } else if (type === 'warn') {\n      ui.notifications.warn(message);\n    } else if (type === 'error') {\n      ui.notifications.error(message);\n    }\n  }\n\n  /**\n   * Checks if module is currently installed and active\n   * @param {string} moduleName\n   * @returns {boolean}\n   */\n  static isModuleOn(moduleName){\n    const module = game.modules?.get(moduleName);\n    return module?.active ? true : false;\n  }\n\n  /**\n   * Check if Midi-QOL module is active and has an ongoing workflow\n   * @returns {boolean} True if midi-qol has an active workflow\n   */\n  static isMidiWorkflowActive() {\n    if (!this.isModuleOn('midi-qol')) return false;\n    LogUtil.log(\"isMidiWorkflowActive\",[globalThis.MidiQOL?.Workflow?.workflows]);\n    return globalThis.MidiQOL?.Workflow?.workflows?.size > 0;\n  }\n\n  /**\n   * Finds and returns the first element matching the selector within the parent element\n   * @param {HTMLElement} parent - The parent element to search within\n   * @param {string} selector - CSS selector string\n   * @returns {HTMLElement|null} The first matching element or null if not found\n   */\n  static html(parent, selector) {\n    return parent.querySelector(selector);\n  }\n\n  /**\n   * Gets the full width of an element including margins and borders\n   * @param {HTMLElement} element - The element to measure\n   * @returns {number} The full width in pixels\n   */\n  static getFullWidth(element) {\n    const style = window.getComputedStyle(element);\n    if (style.width === '0px') {\n      return 0;\n    }\n    return element.offsetWidth;\n  }\n\n  /**\n   * Prevents dialog flicker by applying opacity transition\n   * @param {HTMLElement} element - The dialog element to apply the transition to\n   * @param {number} delay - Delay in milliseconds before fading in (default: 100)\n   */\n  static preventDialogFlicker(element, delay = 0) {\n    if (!element) return;\n\n    element.style.opacity = '0';\n    element.style.transition = 'opacity 0.15s ease-in';\n\n    requestAnimationFrame(() => {\n      if (element) {\n        element.style.opacity = '1';\n      }\n    });\n  }\n\n  /**\n   * Adds CSS variables to a style element\n   * @param {string} varName \n   * @param {string} varValue \n   */\n  static addCSSVars(varName, varValue) {\n    let bodyStyle = document.querySelector('style#flash5e-vars');\n    \n    if (!bodyStyle) {\n      const body = document.querySelector('body.flash5e');\n      if(!body){return}\n      \n      const existingStyle = body.querySelector('style#flash5e-vars');\n      if (existingStyle) {\n        existingStyle.remove();\n      }\n      \n      bodyStyle = document.createElement('style');\n      bodyStyle.id = 'flash5e-vars';\n      bodyStyle.textContent = 'body.flash5e {\\n}\\n';\n      body.prepend(bodyStyle);\n    }\n    \n    let cssText = bodyStyle.textContent;\n    \n    let ruleStart = cssText.indexOf('body.flash5e {');\n    let ruleEnd = cssText.indexOf('}', ruleStart);\n    \n    if (ruleStart === -1) {\n      cssText = 'body.flash5e {\\n}\\n';\n      ruleStart = 0;\n      ruleEnd = cssText.indexOf('}');\n    }\n    \n    const rulePart = cssText.substring(ruleStart + 'body.flash5e {'.length, ruleEnd);\n    \n    const declarations = rulePart.split(';')\n      .map(decl => decl.trim())\n      .filter(decl => decl !== '');\n    \n    const varsMap = {};\n    declarations.forEach(decl => {\n      const parts = decl.split(':');\n      if (parts.length >= 2) {\n        const name = parts[0].trim();\n        const value = parts.slice(1).join(':').trim(); // Handle values that might contain colons\n        if (name) varsMap[name] = value;\n      }\n    });\n    \n    if (varName.includes('i18n') && \n        typeof varValue === 'string' && \n        !varValue.startsWith('\"') && \n        !varValue.startsWith(\"'\") && \n        !varValue.match(/^url\\(|^rgba?\\(|^hsla?\\(/)) {\n      varValue = `\"${varValue}\"`;\n    }\n    \n    varsMap[varName] = varValue;\n    \n    const newRuleContent = Object.entries(varsMap)\n      .map(([name, value]) => `  ${name}: ${value};`)\n      .join('\\n');\n    \n    const newCss = \n      cssText.substring(0, ruleStart) + \n      'body.flash5e {\\n' + \n      newRuleContent + \n      '\\n}' + \n      cssText.substring(ruleEnd + 1);\n    \n    bodyStyle.textContent = newCss;\n  }\n  \n  /**\n   * Gets the offset bottom of an element\n   * @param {HTMLElement} element \n   * @returns {number}\n   */\n  static getOffsetBottom(element) {\n    const offsetTop = element.offsetTop;\n    const elementHeight = element.offsetHeight;\n    return window.innerHeight - (offsetTop + elementHeight);\n  }\n\n  /**\n   * Retrieves a list of all available fonts\n   * @returns {Promise<string[]>}\n   */\n  static async getAllFonts() {\n    const foundryFonts = new Set(Object.keys(CONFIG.fontDefinitions));\n    const customFontsObj = game.settings.get(\"core\", \"fonts\") || {};\n    const customFonts = Object.entries(customFontsObj).map(([fontFamily]) => fontFamily);\n  \n    const cssImportedFonts = await this.processStyleSheets();\n  \n    const allFonts = Array.from(new Set([\n      ...foundryFonts,\n      ...customFonts,\n      ...cssImportedFonts\n    ]))\n    .filter(f => !/FontAwesome|Font Awesome|FoundryVTT/.test(f))\n    .map(f => f.replace(/['\"]/g, '').trim())\n    .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));\n\n    return allFonts || [];\n  }\n\n  // Helper function to format font names\n  /**\n   * Formats a font name by cleaning it and wrapping it in quotes if it contains spaces\n   * @param {string} fontName - The font name to format\n   * @returns {string} The formatted font name\n   */\n  static wrapFontName = (fontName) => {\n    const cleanName = fontName.replace(/['\"`]/g, '');\n    return cleanName.includes(' ') ? `\"${cleanName}\"` : cleanName;\n  }\n\n  /**\n   * Adds custom CSS to a style element\n   * @param {string} content - CSS content to add\n   * @param {string} [id='flash5e-custom-css'] - ID for the style element\n   * @param {boolean} [checkForDuplicates=true] - Whether to check for duplicate rules\n   */\n  static addCustomCSS(content, id = 'flash5e-custom-css', checkForDuplicates = true) {\n    if (!content) {\n      return;\n    }\n    \n    let customStyle = document.querySelector('#' + id);\n    \n    if (!customStyle) {\n      customStyle = document.createElement('style');\n      customStyle.id = id;\n      customStyle.textContent = '';\n      document.head.appendChild(customStyle);\n    }\n\n    const importRegex = /@import\\s+(?:url\\()?\\s*['\"]?[^'\")]+['\"]?\\s*\\)?\\s*;/g;\n    const imports = [];\n    let contentWithoutImports = content;\n    let match;\n    while ((match = importRegex.exec(content)) !== null) {\n      imports.push(match[0]);\n    }\n    \n    contentWithoutImports = content.replace(importRegex, '').trim();\n    \n    if (!checkForDuplicates) {\n      customStyle.textContent = imports.join('\\n') + (imports.length ? '\\n\\n' : '') + contentWithoutImports;\n      return;\n    }\n    \n    if (!customStyle.textContent.includes(contentWithoutImports)) {\n      const currentContent = customStyle.textContent;\n      const existingImports = [];\n      let currentMatch;\n      while ((currentMatch = importRegex.exec(currentContent)) !== null) {\n        existingImports.push(currentMatch[0]);\n      }\n      \n      const currentContentWithoutImports = currentContent.replace(importRegex, '').trim();\n      const newImports = imports.filter(imp => !existingImports.includes(imp));\n      const allImports = [...existingImports, ...newImports];\n      customStyle.textContent = allImports.join('\\n') + \n                               (allImports.length ? '\\n\\n' : '') + \n                               currentContentWithoutImports +\n                               (currentContentWithoutImports && contentWithoutImports ? '\\n\\n' : '') +\n                               contentWithoutImports;\n    }\n  }\n  \n  /**\n   * Performs a smooth scroll with custom duration\n   * @param {HTMLElement} element - The element to scroll\n   * @param {number} to - The target scroll position\n   * @param {string} [direction=\"horizontal\"] - The scroll direction (\"horizontal\" or \"vertical\")\n   * @param {number} [duration=300] - Duration of the animation in milliseconds\n   * @param {Function} [onComplete] - Optional callback to run when animation completes\n   * @returns {number} Animation ID that can be used to cancel the animation\n   */\n  static smoothScrollTo(element, to, direction = \"horizontal\", duration = 300, onComplete = null) {\n    // Cancel any existing animation if it has the same ID as the element\n    const animationId = element.dataset.scrollAnimationId;\n    if (animationId) {\n      cancelAnimationFrame(Number(animationId));\n    }\n    \n    // Determine if we're scrolling horizontally or vertically\n    const isHorizontal = direction === \"horizontal\";\n    const start = isHorizontal ? element.scrollLeft : element.scrollTop;\n    const change = to - start;\n    \n    // If there's no change or the element isn't scrollable, exit early\n    if (change === 0) {\n      if (onComplete) onComplete();\n      return null;\n    }\n    \n    const startTime = performance.now();\n    \n    const animateScroll = (currentTime) => {\n      const elapsedTime = currentTime - startTime;\n      \n      if (elapsedTime >= duration) {\n        if (isHorizontal) {\n          element.scrollLeft = to;\n        } else {\n          element.scrollTop = to;\n        }\n        \n        delete element.dataset.scrollAnimationId;\n        if (onComplete) onComplete();\n        return;\n      }\n      \n      const progress = elapsedTime / duration;\n      const easeProgress = progress < 0.5 \n        ? 2 * progress * progress \n        : 1 - Math.pow(-2 * progress + 2, 2) / 2;\n      \n      if (isHorizontal) {\n        element.scrollLeft = start + change * easeProgress;\n      } else {\n        element.scrollTop = start + change * easeProgress;\n      }\n      \n      const newAnimationId = requestAnimationFrame(animateScroll);\n      element.dataset.scrollAnimationId = newAnimationId;\n      return newAnimationId;\n    };\n    \n    const newAnimationId = requestAnimationFrame(animateScroll);\n    element.dataset.scrollAnimationId = newAnimationId;\n    return newAnimationId;\n  }\n\n  /**\n   * Opens a confirmation dialog to reload the page using DialogV2\n   * @param {string} [title=\"\"] - The title of the confirmation dialog\n   * @param {string} [content=\"\"] - The content message\n   * @param {Object} [options={}] - Additional dialog options\n   * @returns {Promise<boolean>} Resolves to true if confirmed, false otherwise\n   */\n  static confirmReload(\n    title = game.i18n.localize(\"FLASH_ROLLS.ui.reloadRequiredTitle\"), \n    content = game.i18n.localize(\"FLASH_ROLLS.ui.reloadRequiredLabel\"),\n    options = {}) {\n    \n    const dialogConfig = {\n      window: {\n        title\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      },\n      content,\n      yes: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.reloadButton\"),\n        callback: () => {\n          LogUtil.log(\"Reloading page after confirmation\");\n          window.location.reload();\n          return true;\n        }\n      },\n      no: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.cancelButton\"),\n        callback: () => false\n      },\n      defaultYes: false,\n      rejectClose: false\n    };\n    \n    mergeObject(dialogConfig, options);\n    return foundry.applications.api.DialogV2.confirm(dialogConfig);\n  }\n\n  /**\n   * Alias for Foundry's method to render Handlebars template\n   * @param {string} templatePath \n   * @param {Object} data \n   * @returns {Promise<string>} Rendered template HTML\n   */\n  static renderTemplate(templatePath, data){\n    return foundry.applications.handlebars.renderTemplate(templatePath, data);\n  }\n\n  /**\n   * Alias for Foundry's method to load Handlebars template\n   * @param {string} templatePath \n   * @returns {Promise<HandlebarsTemplate>} Loaded template object\n   */\n  static loadTemplate(templatePath){\n    return foundry.applications.handlebars.loadTemplate(templatePath);\n  }\n\n  /**\n   * Alias for Foundry's method to load Handlebars template\n   * @param {string[]} templatePaths \n   * @returns {Promise<HandlebarsTemplate>} Loaded template object\n   */\n  static loadTemplates(templatePaths){\n    if(!Array.isArray(templatePaths)) templatePaths = [templatePaths];\n    return foundry.applications.handlebars.loadTemplates(templatePaths);\n  }\n\n  /**\n   * Validates if a string is a valid CSS rule or selector\n   * @param {string} cssString - CSS rule or selector to validate\n   * @return {boolean} Whether the CSS is valid\n   */\n  static isValidCSSRule(cssString) {\n    if (!cssString || typeof cssString !== \"string\") return false;\n    const trimmedCSS = cssString.trim();\n    if (!trimmedCSS) return false;\n    try {\n      const style = document.createElement(\"style\");\n      const testCSS = `${trimmedCSS} { color: inherit; }`;\n      style.textContent = testCSS;\n      document.head.appendChild(style);\n      const isValid = Boolean(style.sheet && style.sheet.cssRules && style.sheet.cssRules.length > 0);\n      document.head.removeChild(style);\n      return isValid;\n    } catch (error) {\n      LogUtil.log(\"CSS validation error:\", [error, cssString]);\n      return false;\n    }\n  }\n\n  /**\n   * Processes CSS rules with nested selectors to create valid CSS for multiple target selectors\n   * @param {string} cssRules - CSS rules that may contain nested selectors\n   * @param {string} targetSelectors - Comma-separated list of selectors to apply the rules to\n   * @return {string} Valid CSS with properly combined selectors\n   */\n  static processCSSRules(cssRules, targetSelectors) {\n    if (!cssRules || !targetSelectors) return \"\";\n    const parsedCSS = this.#parseCSS(cssRules);\n    const mainStyle = targetSelectors + \" {\\n\" + parsedCSS.baseProperties.join(\"\\n\") + \"\\n}\";\n    const processedRules = [];\n    const rulesByContent = new Map();\n    \n    parsedCSS.nestedRules.forEach(rule => {\n      const { selector, content } = rule;\n      \n      if (selector.startsWith(\"&\")) {\n        const pseudoSelector = selector.substring(1);\n        const combinedSelectors = targetSelectors.split(\",\")\n          .map(s => s.trim())\n          .filter(Boolean)\n          .map(s => s + pseudoSelector)\n          .join(\", \");\n        \n        processedRules.push(`${combinedSelectors} {\\n${content}\\n}`);\n        return;\n      }\n      \n      if (!rulesByContent.has(content)) {\n        rulesByContent.set(content, []);\n      }\n      \n      const selectors = selector.split(\",\").map(s => s.trim());\n      const targetList = targetSelectors.split(\",\").map(s => s.trim()).filter(Boolean);\n      \n      selectors.forEach(nestedSelector => {\n        targetList.forEach(targetSelector => {\n          rulesByContent.get(content).push(`${targetSelector} ${nestedSelector}`);\n        });\n      });\n    });\n    \n    rulesByContent.forEach((selectors, content) => {\n      processedRules.push(`${selectors.join(\", \")} {\\n${content}\\n}`);\n    });\n    \n    return mainStyle + \"\\n\\n\" + processedRules.join(\"\\n\\n\");\n  }\n  \n  /**\n   * Parses CSS string into a structured format with base properties and nested rules\n   * @param {string} css - CSS string to parse\n   * @return {Object} Object with baseProperties array and nestedRules array\n   * @private\n   */\n  static #parseCSS(css) {\n    const baseProperties = [];\n    const nestedRules = [];\n    const lines = css.split(\"\\n\");\n    \n    let currentNested = null;\n    let braceCount = 0;\n    \n    for (let i = 0; i < lines.length; i++) {\n      const line = lines[i].trim();\n      if (!line) continue;\n      \n      const openBraces = (line.match(/{/g) || []).length;\n      const closeBraces = (line.match(/}/g) || []).length;\n      \n      if (line.includes(\"{\") && !currentNested) {\n        const selector = line.substring(0, line.indexOf(\"{\")).trim();\n        currentNested = { selector, content: \"\", startLine: i };\n        braceCount = 1;\n        \n        const contentAfterBrace = line.substring(line.indexOf(\"{\") + 1).trim();\n        if (contentAfterBrace && !contentAfterBrace.includes(\"}\")) {\n          currentNested.content += contentAfterBrace + \"\\n\";\n        }\n      } else if (currentNested) {\n        braceCount += openBraces - closeBraces;\n        \n        if (braceCount > 0) {\n          currentNested.content += line + \"\\n\";\n        } \n        else {\n          currentNested.content = currentNested.content.replace(/}\\s*$/, \"\").trim();\n          nestedRules.push(currentNested);\n          currentNested = null;\n        }\n      } else if (!line.includes(\"{\") && !line.includes(\"}\")) {\n        baseProperties.push(line);\n      }\n    }\n    \n    return { baseProperties, nestedRules };\n  }\n\n  /**\n   * Get the player owner of an actor\n   * @param {Actor} actor \n   * @returns {User|null}\n   */\n  static getActorOwner(actor) {\n    const ownership = actor.ownership || {};\n\n    for (const [userId, level] of Object.entries(ownership)) {\n      if (level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER) {\n        const user = game.users.get(userId);\n        if (user && !user.isGM) {\n          return user;\n        }\n      }\n    }\n\n    if(ownership?.default >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){\n      const user = game.users.filter(user => !user.isGM)[0];\n      if (user) {\n        return user;\n      }\n    }\n    \n    return null;\n  }\n\n  /**\n   * Opens a confirmation dialog to reload the page using DialogV2\n   * @param {string} [title=\"\"] - The title of the confirmation dialog\n   * @param {string} [content=\"\"] - The content message\n   * @param {Object} [options={}] - Additional dialog options\n   * @returns {Promise<boolean>} Resolves to true if confirmed, false otherwise\n   */\n  static confirmReload(\n    title = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.reloadRequiredTitle\"), \n    content = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.reloadRequiredLabel\"),\n    options = {}) {\n    \n    const dialogConfig = {\n      window: {\n        title\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      },\n      content,\n      yes: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.buttons.reloadButton\"),\n        callback: () => {\n          LogUtil.log(\"Reloading page after confirmation\");\n          window.location.reload();\n          return true;\n        }\n      },\n      no: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.buttons.cancelButton\"),\n        callback: () => false\n      },\n      defaultYes: false,\n      rejectClose: false\n    };\n    \n    mergeObject(dialogConfig, options);\n    return foundry.applications.api.DialogV2.confirm(dialogConfig);\n  }\n\n  /**\n   * Removes the MeasuredTemplate \n   * @param {Item5e} item \n   */\n  static async removeTemplateForItem (item) {\n    const SETTINGS = getSettings();\n    const removeTemplateSettingOn = SettingsUtil.get(SETTINGS.removeTemplate.tag);\n    LogUtil.log(\"removeTemplateForItem\", [item, removeTemplateSettingOn]);\n    if(!removeTemplateSettingOn){ return; }\n\n    // If not GM, send request to GM via existing socket\n    if (!game.user.isGM) {\n      LogUtil.log(\"removeTemplateForItem - requesting GM to remove template\", [item?.uuid]);\n      SocketUtil.execForGMs(\"removeTemplate\", item?.uuid);\n      return;\n    }\n    \n    try {\n      // Get templates that match this item UUID\n      const templates = canvas.templates.objects.children.filter(mt => {\n        return mt.document.flags.dnd5e.item === item?.uuid;\n      });\n\n      if(templates.length > 0){\n        // Double-check that templates still exist in the scene before deletion\n        const templateIds = templates.map(t => t.id);\n        const existingTemplates = canvas.scene.templates.filter(t => templateIds.includes(t.id));\n        \n        if (existingTemplates.length > 0) {\n          LogUtil.log(\"removeTemplateForItem - removing templates\", [item?.uuid, existingTemplates.length]);\n          await canvas.scene.deleteEmbeddedDocuments('MeasuredTemplate', existingTemplates.map(t => t.id));\n        } else {\n          LogUtil.log(\"removeTemplateForItem - templates already removed\", [item?.uuid]);\n        }\n      }\n    } catch (error) {\n      LogUtil.log(\"removeTemplateForItem - template not found or already deleted\", [item?.uuid, error.message]);\n    }\n    \n  }\n\n  /**\n   * Removes template by UUID - called via socket from player side\n   * @param {string} itemUuid - The UUID of the item whose template should be removed\n   */\n  static async removeTemplate(itemUuid) {\n    LogUtil.log(\"removeTemplate\", [itemUuid]);\n    try {\n      const item = await fromUuid(itemUuid);\n      if (item && game.user.isGM) {\n        return GeneralUtil.removeTemplateForItem(item);\n      }\n    } catch (error) {\n      LogUtil.error(\"removeTemplate - error\", [error]);\n    }\n  }\n\n  static areSkipKeysPressed(event){\n    // if (!event) return false;\n\n    const { areKeysPressed } = game.dnd5e.utils || {};\n    if (!areKeysPressed) {\n      return event.shiftKey || event.altKey || event.ctrlKey || event.metaKey || false;\n    }\n\n    return areKeysPressed(event, \"skipDialogNormal\") ||      // Shift\n           areKeysPressed(event, \"skipDialogAdvantage\") ||   // Alt\n           areKeysPressed(event, \"skipDialogDisadvantage\");  // Ctrl/Cmd\n  }\n}\n","/**\n * Helper functions for the Flash Token Bar 5e module\n */\nimport { MODULE, ROLL_TYPES } from '../../constants/General.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { FlashAPI } from '../core/FlashAPI.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\n\n/**\n * Get display name for roll type with optional details\n * @param {string} rollType - The type of roll\n * @param {string} rollKey - Optional key for the specific roll (ability, skill, etc.)\n * @returns {string} Formatted display string\n */\nexport function getRollTypeDisplay(rollType, rollKey) {\n  let display = game.i18n.localize(`FLASH_ROLLS.rollTypes.${rollType}`) || rollType;\n  \n  // Normalize rollType to lowercase for consistent comparisons\n  const normalizedRollType = rollType?.toLowerCase();\n  \n  if (rollKey) {\n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        display += ` (${CONFIG.DND5E.skills[rollKey]?.label || rollKey})`;\n        break;\n      case ROLL_TYPES.SAVE:\n        display += ` (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n        break;\n      case ROLL_TYPES.ABILITY:\n        display += ` (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n        break;\n      case ROLL_TYPES.TOOL:\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          display += ` (${toolItem?.name || rollKey})`;\n        } else {\n          display += ` (${rollKey})`;\n        }\n        break;\n      case ROLL_TYPES.CUSTOM:\n        display = `${display}: ${rollKey}`;\n        break;\n    }\n  }\n  \n  return display;\n}\n\n/**\n * Get the full name for a rollKey based on roll type\n * @param {string} rollType - The type of roll (normalized to lowercase)\n * @param {string} rollKey - The key for the specific roll\n * @returns {string} Full name or original rollKey if not found\n */\nexport function getFullRollName(rollType, rollKey) {\n  if (!rollKey) return '';\n  \n  const normalizedRollType = rollType?.toLowerCase();\n  \n  switch (normalizedRollType) {\n    case ROLL_TYPES.SKILL:\n      return CONFIG.DND5E.skills[rollKey]?.label || rollKey;\n    case ROLL_TYPES.SAVE:\n    case ROLL_TYPES.SAVING_THROW:\n      return CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n    case ROLL_TYPES.ABILITY:\n    case ROLL_TYPES.ABILITY_CHECK:\n      return CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n    case ROLL_TYPES.TOOL:\n      const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n      if (toolData?.id) {\n        const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n        return toolItem?.name || rollKey;\n      }\n      return rollKey;\n    default:\n      return rollKey;\n  }\n}\n\n/**\n * Show batched notifications to player\n * @param {Array} pendingNotifications - Array of notification objects\n * @param {Function} getRollTypeDisplayFn - Function to get roll type display (default: getRollTypeDisplay)\n */\nexport function showBatchedNotifications(pendingNotifications, getRollTypeDisplayFn = getRollTypeDisplay) {\n  if (pendingNotifications.length === 0) return;\n  if (!ui?.notifications) return;\n\n  // Group by roll type\n  const notificationsByType = {};\n  for (const notif of pendingNotifications) {\n    const key = `${notif.rollType}_${notif.rollKey || ''}`;\n    if (!notificationsByType[key]) {\n      notificationsByType[key] = {\n        rollType: notif.rollType,\n        rollKey: notif.rollKey,\n        actors: [],\n        gm: notif.gm\n      };\n    }\n    notificationsByType[key].actors.push(notif.actor);\n  }\n\n  const entries = Object.values(notificationsByType);\n  if (entries.length === 1 && entries[0].actors.length === 1) {\n    // Single roll request - use original format\n    const entry = entries[0];\n    FlashAPI.notify('info', game.i18n.format('FLASH_ROLLS.notifications.rollRequestReceived', {\n      gm: entry.gm,\n      rollType: getRollTypeDisplayFn(entry.rollType, entry.rollKey)\n    }));\n  } else {\n    // Multiple requests - create consolidated message\n    const messages = [];\n    for (const entry of entries) {\n      const rollTypeDisplay = getRollTypeDisplayFn(entry.rollType, entry.rollKey);\n      const actorNames = entry.actors.join(\", \");\n      messages.push(`${rollTypeDisplay} (${actorNames})`);\n    }\n\n    FlashAPI.notify('info', game.i18n.format('FLASH_ROLLS.notifications.rollRequestsReceivedMultiple', {\n      gm: entries[0].gm,\n      requests: messages.join(\"; \")\n    }));\n  }\n}\n\n/**\n * Check if an actor is owned by a player (not GM)\n * Prioritizes players who have this actor as their assigned character\n * @param {Actor} actor - The actor to check\n * @returns {User|null} The player owner, or null if not player-owned\n */\nexport function getPlayerOwner(actor) {\n  const assignedUser = game.users.find(user => !user.isGM && user.active && user.character?.id === actor.id);\n  if (assignedUser) return assignedUser;\n  const offlineAssignedUser = game.users.find(user => !user.isGM && user.character?.id === actor.id);\n  if (offlineAssignedUser) return offlineAssignedUser;\n  const ownership = actor.ownership || {};\n  const owners = Object.entries(ownership)\n    .filter(([userId, level]) => level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER)\n    .map(([userId]) => game.users.get(userId))\n    .filter(user => user && !user.isGM);\n  return owners.find(user => user.active) || owners[0] || null;\n}\n\n/**\n * Get actor stats for display (ability scores and modifiers)\n * @param {Actor} actor - The actor to get stats for\n * @returns {Array} Array of stat objects with name, value, and modifier\n */\nexport function getActorStats(actor) {\n  if (!actor?.system?.abilities) return [];\n  \n  return Object.entries(actor.system.abilities).map(([key, ability]) => ({\n    name: key.toUpperCase(),\n    value: ability.value || 10,\n    modifier: ability.mod >= 0 ? `+${ability.mod}` : `${ability.mod}`\n  }));\n}\n\n/**\n * Apply target tokens to user\n * @param {Array<string>} tokenIds - Array of token IDs to target\n * @param {User} user - User to apply targets for (default: game.user)\n */\nexport function applyTargetTokens(tokenIds, user = game.user) {\n  if (!tokenIds?.length) return;\n\n  tokenIds.forEach((id, index) => {\n    LogUtil.log('applyTargetTokens', [id, canvas.tokens.placeables.map(t => t.id)]);\n    const token = canvas.tokens.placeables.find(t => t.id === id); //canvas.tokens.get(id);\n    if (token) {\n      token.setTarget(true, { releaseOthers: index === 0 });\n    }else{\n      LogUtil.warn('applyTargetTokens - Token not found:', [id]);\n    }\n  });\n  \n  // const tokens = tokenIds\n  //   .map(id => canvas.tokens.get(id))\n  //   .filter(t => t);\n  // LogUtil.log('applyTargetTokens', [tokenIds, canvas.tokens.placeables.map(t => t.id)]);\n    \n  // tokens.forEach(t => t.setTarget(true, { user }));\n}\n\n/**\n * Clear all target tokens for user\n * @param {User} user - User to clear targets for (default: game.user)\n */\nexport function clearTargetTokens(user = game.user) {\n  user.targets.forEach(t => t.setTarget(false, { user }));\n}\n\n/**\n * Get target descriptors from current user's targets for damage application\n * @returns {Array<Object>} Array of target descriptors with name, img, uuid, ac\n */\nexport function getTargetDescriptors() {\n  const targets = new Map();\n  for (const token of game.user.targets) {\n    const { name } = token;\n    const { img, system, uuid, statuses } = token.actor ?? {};\n    if (uuid) {\n      const ac = statuses?.has?.(\"coverTotal\") ? null : system?.attributes?.ac?.value;\n      targets.set(uuid, { name, img, uuid, ac: ac ?? null });\n    }\n  }\n  return Array.from(targets.values());\n}\n\n/**\n * Format a notification message for multiple actors\n * @param {Array<string>} actorNames - Array of actor names\n * @param {string} action - The action being performed\n * @returns {string} Formatted message\n */\nexport function formatMultiActorNotification(actorNames, action) {\n  if (actorNames.length === 0) return \"\";\n  if (actorNames.length === 1) return `${actorNames[0]} ${action}`;\n  \n  const and = game.i18n.localize(\"FLASH_ROLLS.common.and\");\n  \n  if (actorNames.length === 2) return `${actorNames[0]} ${and} ${actorNames[1]} ${action}`;\n  \n  const lastActor = actorNames[actorNames.length - 1];\n  const otherActors = actorNames.slice(0, -1).join(\", \");\n  return `${otherActors}, ${and} ${lastActor} ${action}`;\n}\n\n/**\n * Check if an actor is owned by a player (not GM)\n * @param {Actor} actor - The actor to check\n * @returns {boolean} True if owned by a player\n */\nexport function isPlayerOwned(actor) {\n  // Skip non-character actors\n  if (actor.type !== 'character' && actor.type !== 'npc') return false;\n  \n  return Object.entries(actor.ownership)\n    .some(([userId, level]) => {\n      const user = game.users.get(userId);\n      return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n    });\n}\n\n/**\n * Check if actor has token in current scene\n * @param {Actor} actor - The actor to check\n * @returns {boolean} True if actor has token in current scene\n */\nexport function hasTokenInScene(actor) {\n  // Skip non-character actors\n  if (actor.type !== 'character' && actor.type !== 'npc') return false;\n  \n  const currentScene = game.scenes.current;\n  return currentScene && currentScene.tokens.some(token => token.actorId === actor.id);\n}\n\n/**\n * Update token selection on canvas based on actor selection\n * @param {string} actorId - The actor ID\n * @param {boolean} selected - Whether to select or deselect\n */\nexport function updateCanvasTokenSelection(actorId, selected, tokenId = null) {\n  const scene = game.scenes.current;\n  if (!scene) return;\n  \n  let tokens;\n  if (tokenId) {\n    const specificToken = canvas.tokens.placeables.find(t => t.id === tokenId);\n    tokens = specificToken ? [specificToken] : [];\n  } else {\n    tokens = canvas.tokens.placeables.filter(t => t.actor?.id === actorId);\n  }\n  \n  for (const token of tokens) {\n    if (selected) {\n      token.control({ releaseOthers: false });\n    } else {\n      token.release();\n    }\n  }\n}\n\n/**\n * Delay execution for a specified time\n * @param {number} ms - Milliseconds to delay\n * @returns {Promise} Promise that resolves after the delay\n */\nexport function delay(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Check if the sidebar is expanded\n * @returns {boolean} True if sidebar is expanded\n */\nexport function isSidebarExpanded() {\n  return ui?.sidebar?.expanded || false;\n}\n\n/**\n * Update body class based on sidebar state\n * @param {boolean} isExpanded - Whether sidebar is expanded\n */\nexport function updateSidebarClass(isExpanded) {\n  const body = document.querySelector(\"body\"); \n  if (isExpanded) {\n    body.classList.add(\"flash-sidebar-expanded\"); \n  } else {\n    body.classList.remove(\"flash-sidebar-expanded\"); \n  }\n  adjustMenuOffset();\n}\n\n/**\n * Build roll types array for a selected request type\n * @param {string} selectedRequestType - The type of roll request\n * @param {Set} selectedActors - Set of selected actor IDs\n * @returns {Array} Array of roll type objects with id, name, and rollable properties\n */\nexport function buildRollTypes(selectedRequestType, selectedActors) {\n  const rollTypes = [];\n  \n  if (!selectedRequestType) {\n    return rollTypes;\n  }\n  \n  const selectedOption = MODULE.ROLL_REQUEST_OPTIONS[selectedRequestType];\n  if (!selectedOption || !selectedOption.subList) {\n    return rollTypes;\n  }\n  \n  const configData = CONFIG.DND5E[selectedOption.subList];\n  \n  if (configData) {\n    for (const [key, data] of Object.entries(configData)) {\n      let label = data.label || data.name || key;\n      \n      if (selectedOption.subList === 'tools' && CONFIG.DND5E.enrichmentLookup?.tools?.[key]) {\n        const toolData = CONFIG.DND5E.enrichmentLookup.tools[key];\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          label = toolItem?.name || label;\n        }\n      }\n      \n      rollTypes.push({\n        id: key,\n        name: label,\n        rollable: true\n      });\n    }\n    \n    rollTypes.sort((a, b) => a.name.localeCompare(b.name));\n  }\n  \n  return rollTypes;\n}\n\n/**\n * Unified notification system with batching support\n */\nexport class NotificationManager {\n  static pendingNotifications = [];\n  static notificationTimer = null;\n  static NOTIFICATION_BATCH_DELAY = 500; // ms to wait for additional notifications\n  \n  /**\n   * Show a notification with optional batching for roll requests\n   * @param {string} type - Notification type (info, warn, error)\n   * @param {string} message - Message to display\n   * @param {Object} options - Options for the notification\n   * @param {boolean} options.batch - Whether to batch this notification\n   * @param {Object} options.batchData - Data for batched notifications\n   */\n  static notify(type, message, options = {}) {\n    if (!options.batch) {\n      if (ui?.notifications?.[type]) {\n        ui.notifications[type](message);\n      }\n      return;\n    }\n    \n    if (options.batchData) {\n      NotificationManager.pendingNotifications.push(options.batchData);\n      \n      if (NotificationManager.notificationTimer) {\n        clearTimeout(NotificationManager.notificationTimer);\n      }\n      \n      NotificationManager.notificationTimer = setTimeout(() => {\n        showBatchedNotifications(NotificationManager.pendingNotifications);\n        NotificationManager.pendingNotifications = [];\n        NotificationManager.notificationTimer = null;\n      }, NotificationManager.NOTIFICATION_BATCH_DELAY);\n    }\n  }\n  \n  /**\n   * Show roll request sent notifications (GM side)\n   * @param {Object} requestsByPlayer - Grouped requests by player\n   * @param {string} rollTypeName - Display name of the roll type\n   */\n  static notifyRollRequestsSent(requestsByPlayer, rollTypeName) {\n    const successfulRequests = Object.entries(requestsByPlayer);\n    \n    if (successfulRequests.length === 0) return;\n    \n    // Single player, single actor\n    if (successfulRequests.length === 1) {\n      const playerData = Object.values(requestsByPlayer)[0];\n      const actorNames = playerData.actors.map(a => a.name).join(\", \");\n      FlashAPI.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.rollRequestsSentSingle\", {\n        rollType: rollTypeName,\n        actors: actorNames,\n        player: playerData.player.name\n      }));\n    } else {\n      // Multiple players\n      const playerSummaries = successfulRequests.map(([playerId, data]) => {\n        const actorNames = data.actors.map(a => a.name).join(\", \");\n        return `${data.player.name} (${actorNames})`;\n      });\n      FlashAPI.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.rollRequestsSentMultiple\", {\n        rollType: rollTypeName,\n        count: successfulRequests.length,\n        players: playerSummaries.join(\"; \")\n      }));\n    }\n  }\n  \n  /**\n   * Clear any pending notifications\n   */\n  static clearPending() {\n    if (NotificationManager.notificationTimer) {\n      clearTimeout(NotificationManager.notificationTimer);\n      NotificationManager.notificationTimer = null;\n    }\n    NotificationManager.pendingNotifications = [];\n  }\n}\n\n/**\n * Filter actors based on death save requirements\n * @param {Actor[]} actors - Array of actors to filter\n * @returns {Actor[]} Array of actors that need death saves\n */\nexport function filterActorsForDeathSaves(actors) {\n  const actorsNeedingDeathSaves = [];\n  const actorsSkippingDeathSaves = [];\n  \n  for (const actor of actors) {\n    const hp = actor.system.attributes.hp?.value || 0;\n    const deathSaves = actor.system.attributes.death || {};\n    const successes = deathSaves.success || 0;\n    const failures = deathSaves.failure || 0;\n    \n    // Check if actor needs a death save\n    if (hp <= 0 && successes < 3 && failures < 3) {\n      actorsNeedingDeathSaves.push(actor);\n    } else {\n      actorsSkippingDeathSaves.push(actor.name);\n    }\n  }\n  \n  // Notify about actors that don't need death saves\n  if (actorsSkippingDeathSaves.length > 0) {\n    NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.actorsSkippingDeathSave\", {\n      actors: actorsSkippingDeathSaves.join(\", \")\n    }));\n  }\n  \n  return actorsNeedingDeathSaves;\n}\n\n/**\n * Categorize actors by ownership (PC vs NPC)\n * @param {Actor[]} actors - Array of actors to categorize\n * @returns {{pcActors: Array, npcActors: Actor[]}} Object with categorized actors\n */\nexport function categorizeActorsByOwnership(actors) {\n  const pcActors = [];\n  const npcActors = [];\n  \n  for (const actor of actors) {\n    const owner = getPlayerOwner(actor);\n    if (owner) {\n      pcActors.push({ actor, owner });\n    } else {\n      npcActors.push(actor);\n    }\n  }\n  \n  return { pcActors, npcActors };\n}\n\nexport function addHDUpdate(updates, newUpdate){\n  const existingIndex = updates.findIndex(update => update._id === newUpdate._id);\n  if(existingIndex > -1){\n    updates[existingIndex] = foundry.utils.mergeObject(\n      updates[existingIndex],\n      newUpdate\n    )\n  }else{\n    updates.push(newUpdate);\n  }\n}\n\n/**\n * Adjust the offset vars for the roll menu based on the state of the roll privacy controls\n */\nexport function adjustMenuOffset(isExpanded=true){\n  const rollPrivacyVertical = document.querySelector('#chat-notifications #roll-privacy');\n  const controlsWidth = rollPrivacyVertical ? GeneralUtil.getFullWidth(rollPrivacyVertical) : 36;\n  const isCrlngnUIOn = document.querySelector('body.crlngn-tabs') ? true : false;\n  \n  GeneralUtil.addCSSVars('--flash-rolls-menu-offset', (isCrlngnUIOn ? controlsWidth : controlsWidth + 16) + 'px');\n}\n\n/**\n * Find the actor data from actor ID, token ID, or token document ID\n * @param {string} uniqueId - The ID of the actor, token, or token document\n * @returns {Actor|null} The actor document, or null if not found\n */\nexport function getActorData(uniqueId){\n  // First check if this is a token ID\n  const tokenDoc = game.scenes.current?.tokens.get(uniqueId);\n  if (tokenDoc?.actor) return tokenDoc.actor;\n\n  const token = canvas.tokens?.get(uniqueId);\n  if (token?.actor) return token.actor;\n\n  const actor = game.actors.get(uniqueId);\n  return actor || null;\n}\n\nexport function showConsumptionConfig(){\n  const SETTINGS = getSettings();\n  const consumptionConfigMode = SettingsUtil.get(SETTINGS.consumptionConfigMode.tag);\n\n  switch (consumptionConfigMode) {\n    case 1:\n      return false;\n    case 2:\n      return game.user.isGM;\n    case 3:\n      return !game.user.isGM;\n    default:\n      return true;\n  }\n}\n  \n/**\n * Returns a consumption config object based on current situation\n * @param {Object} consume \n * @param {Boolean} isLocalRoll \n * @returns \n */\nexport function getConsumptionConfig(consume, isLocalRoll=true){\n  // const showConsumptionDialog = showConsumptionConfig();\n  let response = { ...consume };\n\n  if(game.user.isGM){\n    response.action = isLocalRoll ? consume.action : false;\n    response.resources = isLocalRoll ? consume.resources : [];\n    response.spellSlot = isLocalRoll ? consume.spellSlot : false;\n  }\n  return response;\n}\n\n/**\n * Returns a create config object based on current situation\n * Template placement logic:\n * - If the roll is local, always prompt for template placement\n * @param {*} createConfig \n * @param {*} isLocalRoll \n * @returns \n */\nexport function getCreateConfig(createConfig, isLocalRoll=true){\n  const SETTINGS = getSettings();\n  const placeTemplateForPlayer = SettingsUtil.get(SETTINGS.placeTemplateForPlayer.tag);\n  const withTemplate = createConfig.measuredTemplate === true;\n  const isMidiActive = game.modules.get(\"midi-qol\")?.active;\n  const isDnDBRoll = createConfig._isDnDBRoll === true;\n\n  let promptForTemplate;\n  if (isDnDBRoll) {\n    promptForTemplate = true;\n  } else if (game.user.isGM) {\n    promptForTemplate = isLocalRoll || placeTemplateForPlayer;\n  } else {\n    if (isMidiActive && placeTemplateForPlayer && withTemplate && !isLocalRoll) {\n      promptForTemplate = true;\n    } else {\n      promptForTemplate = !placeTemplateForPlayer;\n    }\n  }\n\n  LogUtil.log(\"getCreateConfig\", [createConfig, isLocalRoll, placeTemplateForPlayer, withTemplate, promptForTemplate, isMidiActive]);\n  return {\n    ...createConfig,\n    measuredTemplate: withTemplate ? promptForTemplate : false\n  }\n}","import { LogUtil } from \"../../utils/LogUtil.mjs\";\n\n/**\n * Parses and categorizes D&D Beyond roll events\n * Extracts roll information and maps to Foundry roll types\n */\nexport class DnDBRollParser {\n\n  /**\n   * Extract roll information from DnDB roll data\n   * @param {Object} rollData - The raw roll data from DnDB\n   * @returns {Object} Normalized roll information\n   */\n  static extractRollInfo(rollData) {\n    const rolls = rollData.data?.rolls || [];\n    const firstRoll = rolls[0] || {};\n\n    return {\n      action: rollData.data?.action || \"Unknown\",\n      rollType: firstRoll.rollType || \"check\",\n      rollKind: firstRoll.rollKind || \"\",\n      total: firstRoll.result?.total || 0,\n      formula: this._buildFormula(firstRoll),\n      diceResults: this._extractDiceResults(firstRoll),\n      characterId: rollData.entityId,\n      characterName: rollData.data?.context?.name || \"Unknown\",\n      characterAvatar: rollData.data?.context?.avatarUrl || \"\",\n      source: rollData.source || \"web\",\n      isAdvantage: firstRoll.rollKind === \"advantage\",\n      isDisadvantage: firstRoll.rollKind === \"disadvantage\",\n      isCritical: firstRoll.rollKind === \"critical hit\",\n      rawRolls: rolls,\n      rollMode: this._determineRollMode(rollData)\n    };\n  }\n\n  /**\n   * Determine Foundry rollMode from DnDB messageScope/messageTarget\n   * @param {Object} rollData - The raw roll data from DnDB\n   * @returns {string} Foundry roll mode constant\n   */\n  static _determineRollMode(rollData) {\n    const { messageScope, messageTarget, userId } = rollData;\n    if (messageScope === \"gameId\") {\n      return CONST.DICE_ROLL_MODES.PUBLIC;\n    }\n    if (messageScope === \"userId\") {\n      if (messageTarget === userId) {\n        return CONST.DICE_ROLL_MODES.PRIVATE;\n      }\n      return CONST.DICE_ROLL_MODES.BLIND;\n    }\n    return CONST.DICE_ROLL_MODES.PUBLIC;\n  }\n\n  /**\n   * Determine the Foundry roll category from DnDB roll data\n   * @param {string} action - The action name from DnDB\n   * @param {string} rollType - The rollType from DnDB\n   * @param {Actor|null} actor - The Foundry actor (for checking tools/skills)\n   * @returns {Object} Roll category info\n   */\n  static determineRollCategory(action, rollType, actor) {\n    const actionLower = action.toLowerCase();\n\n    if (actionLower === \"initiative\" || (rollType === \"roll\" && actionLower === \"initiative\")) {\n      return { category: \"initiative\" };\n    }\n\n    if (rollType === \"save\") {\n      const abilityAbbrev = this._getAbilityAbbrev(action);\n      if (abilityAbbrev) {\n        return { category: \"save\", ability: abilityAbbrev };\n      }\n      return { category: \"save\", ability: \"str\", original: action };\n    }\n\n    if (rollType === \"to hit\" || rollType === \"attack\") {\n      return { category: \"attack\", action };\n    }\n\n    if (rollType === \"damage\") {\n      return { category: \"damage\", action };\n    }\n\n    if (rollType === \"heal\" || rollType === \"healing\") {\n      return { category: \"healing\", action };\n    }\n\n    if (rollType === \"check\") {\n      const abilityAbbrev = this._getAbilityAbbrev(action);\n      if (abilityAbbrev) {\n        return { category: \"abilityCheck\", ability: abilityAbbrev };\n      }\n      const skillAbbrev = this._getSkillAbbrev(action);\n      if (skillAbbrev) {\n        return { category: \"skill\", skill: skillAbbrev, skillName: action };\n      }\n      if (actor) {\n        const toolItem = this._findToolForAction(actor, action);\n        if (toolItem) {\n          return { category: \"tool\", tool: toolItem, toolName: action };\n        }\n      }\n      return { category: \"customCheck\", action };\n    }\n\n    return { category: \"unknown\", action, rollType };\n  }\n\n  /**\n   * Get ability abbreviation from full name or abbreviation\n   * @param {string} value - Ability name or abbreviation\n   * @returns {string|null}\n   */\n  static _getAbilityAbbrev(value) {\n    const valueLower = value.toLowerCase();\n    const abilities = CONFIG.DND5E?.abilities || {};\n    for (const [abbrev, data] of Object.entries(abilities)) {\n      if (abbrev === valueLower || data.label?.toLowerCase() === valueLower) {\n        return abbrev;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Get skill abbreviation from full name\n   * @param {string} skillName - Skill name\n   * @returns {string|null}\n   */\n  static _getSkillAbbrev(skillName) {\n    const nameLower = skillName.toLowerCase();\n    const skills = CONFIG.DND5E?.skills || {};\n    for (const [abbrev, data] of Object.entries(skills)) {\n      if (abbrev === nameLower || data.label?.toLowerCase() === nameLower) {\n        return abbrev;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Find a tool on actor that matches the action name\n   * @param {Actor} actor - The Foundry actor\n   * @param {string} action - The action name\n   * @returns {Item|null}\n   */\n  static _findToolForAction(actor, action) {\n    if (!actor) return null;\n    const actionLower = action.toLowerCase();\n    return actor.items.find(item => {\n      if (item.type !== \"tool\") return false;\n      const nameLower = item.name.toLowerCase();\n      return nameLower.includes(actionLower) || actionLower.includes(nameLower);\n    }) || null;\n  }\n\n  /**\n   * Build a formula string from roll data\n   * @param {Object} roll - The roll object\n   * @returns {string}\n   */\n  static _buildFormula(roll) {\n    const notation = roll.diceNotation;\n    if (!notation) return \"\";\n\n    const parts = [];\n    for (const set of notation.set || []) {\n      parts.push(`${set.count}${set.dieType}`);\n    }\n\n    let formula = parts.join(\" + \");\n    if (notation.constant) {\n      const sign = notation.constant >= 0 ? \"+\" : \"\";\n      formula += ` ${sign}${notation.constant}`;\n    }\n\n    return formula;\n  }\n\n  /**\n   * Extract individual dice results from roll data\n   * @param {Object} roll - The roll object\n   * @returns {Array}\n   */\n  static _extractDiceResults(roll) {\n    const results = [];\n    const notation = roll.diceNotation;\n    if (!notation) return results;\n\n    for (const set of notation.set || []) {\n      for (const die of set.dice || []) {\n        results.push({\n          type: die.dieType,\n          value: die.dieValue\n        });\n      }\n    }\n\n    return results;\n  }\n\n  /**\n   * Get a localized label for a roll type\n   * @param {string} rollType - The roll type from DnDB\n   * @returns {string}\n   */\n  static getRollTypeLabel(rollType) {\n    const typeMap = {\n      \"to hit\": game.i18n.localize(\"DND5E.Attack\"),\n      \"attack\": game.i18n.localize(\"DND5E.Attack\"),\n      \"check\": \"Check\",\n      \"save\": game.i18n.localize(\"DND5E.SavingThrow\"),\n      \"damage\": game.i18n.localize(\"DND5E.Damage\"),\n      \"heal\": game.i18n.localize(\"DND5E.Healing\"),\n      \"healing\": game.i18n.localize(\"DND5E.Healing\")\n    };\n\n    return typeMap[rollType?.toLowerCase()] || rollType || \"Roll\";\n  }\n\n  /**\n   * Find an item on actor by name (for attacks/spells)\n   * @param {Actor} actor - The Foundry actor\n   * @param {string} actionName - The action/item name\n   * @returns {Item|null}\n   */\n  static findItemByAction(actor, actionName) {\n    if (!actor || !actionName) return null;\n    const nameLower = actionName.toLowerCase();\n    return actor.items.find(item => {\n      return item.name.toLowerCase() === nameLower;\n    }) || null;\n  }\n\n  /**\n   * Get activity from item based on roll type\n   * @param {Item} item - The item\n   * @param {string} rollType - DnDB roll type (to hit, damage, heal)\n   * @returns {Activity|null}\n   */\n  static getActivityFromItem(item, rollType) {\n    if (!item) return null;\n    const activities = item.system?.activities;\n    if (!activities) return null;\n\n    const activityTypeMap = {\n      \"to hit\": \"attack\",\n      \"attack\": \"attack\",\n      \"damage\": null,\n      \"heal\": \"heal\",\n      \"healing\": \"heal\"\n    };\n\n    const targetType = activityTypeMap[rollType];\n    if (targetType === null) {\n      if (item.hasAttack) {\n        return activities.find(act => act.type === \"attack\") || null;\n      } else if (item.hasSave) {\n        return activities.find(act => act.type === \"save\") || null;\n      } else {\n        return activities.find(act => act.type === \"damage\") || null;\n      }\n    }\n\n    if (targetType) {\n      return activities.find(act => act.type === targetType) || null;\n    }\n\n    return Array.from(activities.values())[0] || null;\n  }\n}\n","import { LogUtil } from \"../../utils/LogUtil.mjs\";\n\nconst Die = foundry.dice.terms.Die;\n\n/**\n * Utility functions for manipulating Foundry Roll objects\n * Used to replace dice values with DnDB results\n */\nexport class DnDBRollUtil {\n\n  /**\n   * Replace all terms in a roll with terms from the replacer roll\n   * @param {Roll} roll - The Foundry roll to modify\n   * @param {Roll} replacer - Roll containing the replacement terms\n   * @returns {Roll} The modified roll\n   */\n  static replaceTerms(roll, replacer) {\n    if (!roll || !replacer) return roll;\n    roll.terms = replacer.terms;\n    roll._total = roll._evaluateTotal();\n    roll.resetFormula();\n    return roll;\n  }\n\n  /**\n   * Replace only dice terms, keeping Foundry's modifiers\n   * Useful when you want DnDB dice values but Foundry calculated modifiers\n   * @param {Roll} roll - The Foundry roll to modify\n   * @param {Roll} replacer - Roll containing the replacement dice\n   * @returns {Roll} The modified roll\n   */\n  static replaceDie(roll, replacer) {\n    if (!replacer || !roll) return roll;\n    if (!replacer.terms) {\n      LogUtil.error(\"DnDBRollUtil.replaceDie - replacer.terms is undefined\", [replacer]);\n      return roll;\n    }\n\n    const replacerDice = replacer.terms.filter(t => t instanceof Die || t.class === \"Die\") || [];\n    const noDice = roll?.terms?.filter(t => !(t instanceof Die || t.class === \"Die\")) || [];\n    roll.terms = [...replacerDice, ...noDice];\n\n    roll._total = roll._evaluateTotal();\n    roll.resetFormula();\n    return roll;\n  }\n\n  /**\n   * Create a Foundry Roll object from DnDB roll data\n   * Creates proper Die terms with pre-evaluated results so formula displays correctly\n   * @param {Object} ddbRoll - The DnDB roll data\n   * @returns {Roll} A Foundry Roll object\n   */\n  static createRollFromDnDB(ddbRoll) {\n    const notation = ddbRoll.diceNotation;\n    if (!notation) return null;\n\n    const terms = [];\n    for (const set of notation.set || []) {\n      const faces = parseInt(set.dieType.replace(\"d\", \"\"), 10);\n      const results = set.dice.map((d, i) => ({\n        result: d.dieValue,\n        active: true,\n        indexThrow: i\n      }));\n\n      const die = new Die({ faces, number: set.count });\n      die._evaluated = true;\n      die.results = results;\n      terms.push(die);\n    }\n\n    if (notation.constant) {\n      const OperatorTerm = foundry.dice.terms.OperatorTerm;\n      const NumericTerm = foundry.dice.terms.NumericTerm;\n      const operator = notation.constant >= 0 ? \"+\" : \"-\";\n      const operatorTerm = new OperatorTerm({ operator });\n      operatorTerm._evaluated = true;\n      terms.push(operatorTerm);\n      const numericTerm = new NumericTerm({ number: Math.abs(notation.constant) });\n      numericTerm._evaluated = true;\n      terms.push(numericTerm);\n    }\n\n    const roll = Roll.fromTerms(terms);\n    roll._evaluated = true;\n    roll._total = ddbRoll.result?.total || 0;\n\n    return roll;\n  }\n\n  /**\n   * Build Die terms from DnDB dice data\n   * @param {Object} ddbRoll - The DnDB roll data\n   * @returns {Array<Die>} Array of Die terms\n   */\n  static buildDieTermsFromDnDB(ddbRoll) {\n    const notation = ddbRoll.diceNotation;\n    if (!notation) return [];\n\n    const terms = [];\n    for (const set of notation.set || []) {\n      const faces = parseInt(set.dieType.replace(\"d\", \"\"), 10);\n      const results = set.dice.map((d, i) => ({\n        result: d.dieValue,\n        active: true,\n        indexThrow: i\n      }));\n\n      const die = new Die({ faces, number: set.count });\n      die._evaluated = true;\n      die.results = results;\n      terms.push(die);\n    }\n\n    return terms;\n  }\n\n  /**\n   * Inject DnDB dice values into an existing Foundry roll\n   * Preserves Foundry's modifiers while replacing dice values\n   * @param {Roll} foundryRoll - The Foundry roll\n   * @param {Object} ddbRoll - The DnDB roll data\n   * @returns {Roll} The modified roll\n   */\n  static injectDnDBDiceValues(foundryRoll, ddbRoll) {\n    if (!foundryRoll || !ddbRoll) return foundryRoll;\n\n    const notation = ddbRoll.diceNotation;\n    if (!notation) return foundryRoll;\n\n    let ddbDiceIndex = 0;\n    const allDnDBDice = [];\n    for (const set of notation.set || []) {\n      for (const die of set.dice || []) {\n        allDnDBDice.push(die.dieValue);\n      }\n    }\n\n    for (const term of foundryRoll.terms) {\n      if (term instanceof Die || term.class === \"Die\") {\n        for (const result of term.results || []) {\n          if (ddbDiceIndex < allDnDBDice.length) {\n            result.result = allDnDBDice[ddbDiceIndex];\n            ddbDiceIndex++;\n          }\n        }\n      }\n    }\n\n    foundryRoll._total = foundryRoll._evaluateTotal();\n    foundryRoll.resetFormula();\n    return foundryRoll;\n  }\n}\n","import { MODULE_ID } from \"../../../constants/General.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\";\n\n/**\n * Utility functions for working with DnD5e Activities\n * Provides modified activity.use() that skips subsequent actions\n */\nexport class DnDBActivityUtil {\n\n  /**\n   * Activate an activity without triggering automatic subsequent rolls\n   * Based on ActivityMixin.use() but with subsequentActions control\n   * @param {Activity} activity - The activity to use\n   * @param {ActivityUseConfiguration} usage - Configuration for activation\n   * @param {ActivityDialogConfiguration} dialog - Configuration for dialog\n   * @param {ActivityMessageConfiguration} message - Configuration for message\n   * @returns {Promise<ActivityUsageResults|void>}\n   */\n  static async ddbUse(activity, usage = {}, dialog = {}, message = {}) {\n    if (!activity) {\n      ui.notifications.error(\"No activity found\", { localize: false });\n      return;\n    }\n    if (!activity.item.isEmbedded || activity.item.pack) return;\n    if (!activity.item.isOwner) {\n      ui.notifications.error(\"DND5E.DocumentUseWarn\", { localize: true });\n      return;\n    }\n    if (!activity.canUse) {\n      ui.notifications.error(\"DND5E.ACTIVITY.Warning.UsageNotAllowed\", { localize: true });\n      return;\n    }\n\n    let item = activity.item.clone({}, { keepId: true });\n\n    const usageConfig = activity._prepareUsageConfig(usage);\n\n    if (usage.create?._isDnDBRoll) {\n      usageConfig.create = usageConfig.create || {};\n      usageConfig.create._isDnDBRoll = true;\n    }\n    LogUtil.log(\"DnDBActivityUtil.ddbUse - usageConfig after _prepareUsageConfig\", [\"_isDnDBRoll:\", usageConfig.create?._isDnDBRoll, usageConfig.create]);\n\n    if (usageConfig.create?.measuredTemplate) {\n      ui.notifications?.info(game.i18n.localize(\"FLASH_ROLLS.notifications.clickMapToPlaceTemplate\"));\n    }\n\n    const dialogConfig = foundry.utils.mergeObject({\n      configure: false,\n      applicationClass: activity.metadata.usage.dialog\n    }, dialog);\n\n    const messageConfig = foundry.utils.mergeObject({\n      create: true,\n      data: {\n        flags: {\n          dnd5e: {\n            ...activity.messageFlags,\n            messageType: \"usage\",\n            use: {\n              effects: activity.applicableEffects?.map(e => e.id)\n            }\n          },\n          rsr5e: { processed: true, quickRoll: false }\n        }\n      },\n      hasConsumption: usageConfig.hasConsumption\n    }, message);\n\n    if (Hooks.call(\"dnd5e.preUseActivity\", activity, usageConfig, dialogConfig, messageConfig) === false) return;\n\n    if (dialogConfig.configure && activity._requiresConfigurationDialog(usageConfig)) {\n      try {\n        await dialogConfig.applicationClass.create(activity, usageConfig, dialogConfig.options);\n      } catch (err) {\n        return;\n      }\n    }\n\n    await activity._prepareUsageScaling(usageConfig, messageConfig, item);\n    activity = item.system.activities.get(activity.id);\n\n    const updates = await activity.consume(usageConfig, messageConfig);\n    if (updates === false) return;\n    const results = { effects: [], templates: [], updates };\n\n    if (usageConfig.concentration?.begin) {\n      const effect = await item.actor.beginConcentrating(activity, { \"flags.dnd5e.scaling\": usageConfig.scaling });\n\n      if (effect) {\n        results.effects ??= [];\n        results.effects.push(effect);\n        foundry.utils.setProperty(messageConfig.data, \"flags.dnd5e.use.concentrationId\", effect.id);\n      }\n      if (usageConfig.concentration?.end) {\n        const deleted = await item.actor.endConcentration(usageConfig.concentration.end);\n        results.effects.push(...deleted);\n      }\n    }\n\n    messageConfig.data.rolls = (messageConfig.data.rolls ?? []).concat(updates.rolls);\n\n    activity._finalizeMessageConfig(usageConfig, messageConfig, results);\n    results.message = await this._createUsageMessage(activity, messageConfig);\n\n    await activity._finalizeUsage(usageConfig, results);\n\n    LogUtil.log(\"DnDBActivityUtil.ddbUse - About to call postUseActivity hook\", [\"_isDnDBRoll:\", usageConfig.create?._isDnDBRoll]);\n    if (Hooks.call(\"dnd5e.postUseActivity\", activity, usageConfig, results) === false) return results;\n\n    if (usageConfig.subsequentActions !== false) {\n      activity._triggerSubsequentActions(usageConfig, results);\n    }\n\n    return results;\n  }\n\n  /**\n   * Create a chat message for activity usage\n   * @param {Activity} activity - The activity\n   * @param {Object} messageConfig - Message configuration\n   * @returns {Promise<ChatMessage5e|object>}\n   */\n  static async _createUsageMessage(activity, messageConfig) {\n    let context = await activity._usageChatContext(messageConfig);\n    const rollData = await this._buildRollData(messageConfig.data.rolls, activity);\n\n    context = {\n      ...context,\n      rolls: rollData\n    };\n\n    LogUtil.log(\"DnDBActivityUtil._createUsageMessage\", [activity.metadata.usage.chatCard, context]);\n\n    const config = foundry.utils.mergeObject({\n      rollMode: game.settings.get(\"core\", \"rollMode\"),\n      data: {\n        content: await foundry.applications.handlebars.renderTemplate(activity.metadata.usage.chatCard, context),\n        speaker: ChatMessage.getSpeaker({ actor: activity.item.actor }),\n        flags: {\n          core: { canPopout: true },\n          rsr5e: { processed: true }\n        }\n      }\n    }, messageConfig);\n\n    Hooks.callAll(\"dnd5e.preCreateUsageMessage\", activity, config);\n\n    ChatMessage.applyRollMode(config.data, config.rollMode);\n    const card = config.create === false ? config.data : await ChatMessage.create(config.data);\n\n    Hooks.callAll(\"dnd5e.postCreateUsageMessage\", activity, card);\n\n    return card;\n  }\n\n  /**\n   * Build roll data for template rendering\n   * @param {Array} rolls - Array of Roll objects\n   * @param {Activity} activity - The activity\n   * @returns {Promise<Array>}\n   */\n  static async _buildRollData(rolls, activity) {\n    if (!rolls || rolls.length === 0) return [];\n\n    const rollData = await Promise.all(rolls.map(async (r) => {\n      const tooltipHtml = await r.getTooltip();\n      const hasTarget = Number.isNumeric(r.options?.target);\n      const isSuccess = hasTarget && r.total >= r.options.target;\n      const isFailure = hasTarget && r.total < r.options.target;\n\n      return {\n        ...r,\n        formula: r.formula,\n        total: r.total,\n        tooltipHtml: tooltipHtml,\n        isSuccess: isSuccess,\n        isFailure: isFailure,\n        hasTarget: hasTarget\n      };\n    }));\n\n    return rollData;\n  }\n\n  /**\n   * Get activity from item by type\n   * @param {Item} item - The item\n   * @param {string} activityType - Type of activity (attack, damage, heal, save)\n   * @returns {Activity|null}\n   */\n  static getActivityByType(item, activityType) {\n    if (!item) return null;\n    const activities = item.system?.activities;\n    if (!activities) return null;\n\n    const activity = activities.find(act => act.type === activityType);\n    return activity || null;\n  }\n\n  /**\n   * Get the first activity from an item\n   * @param {Item} item - The item\n   * @returns {Activity|null}\n   */\n  static getFirstActivity(item) {\n    if (!item) return null;\n    const activities = item.system?.activities;\n    if (!activities) return null;\n    return Array.from(activities.values())[0] || null;\n  }\n}\n","import { MODULE_ID } from \"../../constants/General.mjs\";\nimport { HooksManager } from \"../core/HooksManager.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\n\n/**\n * Helper functions for module management\n */\nexport class ModuleHelpers {\n  static midiTimeout = null;\n\n  /**\n   * Get the MidiQOL API if available\n   * @returns {Object|null} - The MidiQOL API or null if not available\n   */\n  static getMidiQOL() {\n    if (GeneralUtil.isModuleOn('midi-qol') && typeof MidiQOL !== 'undefined') {\n      return MidiQOL;\n    }\n    return null;\n  }\n\n}","import { MODULE_ID } from \"../../../constants/General.mjs\";\nimport { HOOKS_DND5E, HOOKS_MIDI_QOL } from \"../../../constants/Hooks.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\";\nimport { GeneralUtil } from \"../../utils/GeneralUtil.mjs\";\nimport { ModuleHelpers } from \"../../helpers/ModuleHelpers.mjs\";\nimport { DnDBRollUtil } from \"./DnDBRollUtil.mjs\";\nimport { DnDBRollExecutor } from \"./DnDBRollExecutor.mjs\";\n\n/**\n * Handles DnDB roll integration with Midi-QOL workflows\n * Uses dnd5e roll configuration hooks to inject DDB dice values into Midi workflows\n */\nexport class DnDBIntegration {\n\n  static _pendingDnDBRoll = null;\n\n  /**\n   * Check if Midi-QOL is active\n   * @returns {boolean}\n   */\n  static isActive() {\n    return GeneralUtil.isModuleOn('midi-qol');\n  }\n\n  /**\n   * Store a pending DnDB roll for injection into the next Foundry roll\n   * @param {Object} rollInfo - Parsed roll info from DnDBRollParser\n   */\n  static setPendingRoll(rollInfo) {\n    this._pendingDnDBRoll = rollInfo;\n    LogUtil.log(\"DnDBIntegration.setPendingRoll\", [rollInfo]);\n  }\n\n  /**\n   * Clear any pending DnDB roll\n   */\n  static clearPendingRoll() {\n    this._pendingDnDBRoll = null;\n  }\n\n  /**\n   * Get and consume the pending DnDB roll\n   * @returns {Object|null} The pending roll info or null\n   */\n  static consumePendingRoll() {\n    const roll = this._pendingDnDBRoll;\n    this._pendingDnDBRoll = null;\n    return roll;\n  }\n\n  /**\n   * Check if there's a pending DnDB roll\n   * @returns {boolean}\n   */\n  static hasPendingRoll() {\n    return this._pendingDnDBRoll !== null;\n  }\n\n  static _waitingForDnDBDamage = false;\n\n  /**\n   * Register hooks for roll configuration injection\n   * Called during module initialization\n   */\n  static registerHooks() {\n    Hooks.on(HOOKS_DND5E.PRE_ROLL_ATTACK, this._onPreRollAttack.bind(this));\n    Hooks.on(HOOKS_DND5E.PRE_ROLL_DAMAGE, this._onPreRollDamage.bind(this));\n    Hooks.on(HOOKS_DND5E.PRE_ROLL_ABILITY_CHECK, this._onPreRollBasic.bind(this));\n    Hooks.on(HOOKS_DND5E.PRE_ROLL_SAVING_THROW, this._onPreRollBasic.bind(this));\n    Hooks.on(HOOKS_DND5E.PRE_ROLL_SKILL_V2, this._onPreRollBasic.bind(this));\n    Hooks.on(HOOKS_DND5E.PRE_ROLL_TOOL_V2, this._onPreRollBasic.bind(this));\n    Hooks.on(HOOKS_DND5E.POST_ATTACK_ROLL_CONFIGURATION, this._onPostAttackRollConfiguration.bind(this));\n    Hooks.on(HOOKS_DND5E.POST_DAMAGE_ROLL_CONFIGURATION, this._onPostDamageRollConfiguration.bind(this));\n    Hooks.on(HOOKS_DND5E.POST_ABILITY_CHECK_ROLL_CONFIGURATION, this._onPostBasicRollConfiguration.bind(this));\n    Hooks.on(HOOKS_DND5E.POST_SKILL_CHECK_ROLL_CONFIGURATION, this._onPostBasicRollConfiguration.bind(this));\n    Hooks.on(HOOKS_DND5E.POST_SAVING_THROW_ROLL_CONFIGURATION, this._onPostBasicRollConfiguration.bind(this));\n    Hooks.on(HOOKS_MIDI_QOL.PRE_DAMAGE_ROLL, this._onMidiPreDamageRoll.bind(this));\n    LogUtil.log(\"DnDBIntegration: Registered roll configuration hooks\");\n  }\n\n  /**\n   * Handle Midi preDamageRoll hook - block auto-damage when waiting for DDB damage\n   * Returns false to cancel the roll if we're waiting for DDB damage\n   */\n  static _onMidiPreDamageRoll(workflow, activity, config, dialog, message) {\n    if (this._waitingForDnDBDamage && !this.hasPendingRoll()) {\n      LogUtil.log(\"DnDBIntegration._onMidiPreDamageRoll - Blocking auto-damage, waiting for DDB damage roll\");\n      return false;\n    }\n    return true;\n  }\n\n  /**\n   * Handle pre-roll attack hook to force skip dialog for DDB rolls\n   * This runs before the roll dialog would show\n   */\n  static _onPreRollAttack(config, dialog, message) {\n    if (!this.hasPendingRoll()) return;\n    dialog.configure = false;\n    LogUtil.log(\"DnDBIntegration._onPreRollAttack - Forcing dialog.configure = false\");\n  }\n\n  /**\n   * Handle pre-roll damage hook to force skip dialog for DDB rolls\n   * This runs before the roll dialog would show\n   */\n  static _onPreRollDamage(config, dialog, message) {\n    if (!this.hasPendingRoll() && !DnDBRollExecutor.hasPendingDamageRoll()) return;\n    dialog.configure = false;\n    LogUtil.log(\"DnDBIntegration._onPreRollDamage - Forcing dialog.configure = false\");\n  }\n\n  /**\n   * Handle pre-roll basic roll hook (ability checks, saving throws, skills, tools)\n   * Forces skip dialog for DDB rolls\n   * This runs before the roll dialog would show\n   */\n  static _onPreRollBasic(config, dialog, message) {\n    if (!this.hasPendingRoll()) return;\n    dialog.configure = false;\n    LogUtil.log(\"DnDBIntegration._onPreRollBasic - Forcing dialog.configure = false\");\n  }\n\n  /**\n   * Handle post attack roll configuration hook\n   * Injects DnDB dice values into the attack roll before evaluation\n   * @param {Roll[]} rolls - The constructed but unevaluated rolls\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialog - Dialog configuration\n   * @param {Object} message - Message configuration\n   */\n  static _onPostAttackRollConfiguration(rolls, config, dialog, message) {\n    if (!this.hasPendingRoll()) return;\n\n    const pendingRoll = this._pendingDnDBRoll;\n    const ddbRoll = pendingRoll?.rawRolls?.[0];\n    if (!ddbRoll || !rolls?.length) return;\n\n    LogUtil.log(\"DnDBIntegration._onPostAttackRollConfiguration - Injecting DDB values\", [rolls, ddbRoll]);\n\n    for (const roll of rolls) {\n      this._injectDiceValuesPreEval(roll, ddbRoll);\n    }\n\n    this._addDnDBFlags(message, pendingRoll);\n    this.clearPendingRoll();\n  }\n\n  /**\n   * Handle post damage roll configuration hook\n   * Injects DnDB dice values into the damage roll before evaluation\n   * @param {Roll[]} rolls - The constructed but unevaluated rolls\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialog - Dialog configuration\n   * @param {Object} message - Message configuration\n   */\n  static _onPostDamageRollConfiguration(rolls, config, dialog, message) {\n    if (!this.hasPendingRoll()) return;\n\n    const pendingRoll = this._pendingDnDBRoll;\n    const ddbRoll = pendingRoll?.rawRolls?.[0];\n    if (!ddbRoll || !rolls?.length) return;\n\n    LogUtil.log(\"DnDBIntegration._onPostDamageRollConfiguration - Injecting DDB values\", [rolls, ddbRoll]);\n\n    for (const roll of rolls) {\n      this._injectDiceValuesPreEval(roll, ddbRoll);\n    }\n\n    this._addDnDBFlags(message, pendingRoll);\n    this.clearPendingRoll();\n  }\n\n  /**\n   * Handle post basic roll configuration hook (ability checks, skill checks, saving throws)\n   * Injects DnDB dice values into the roll before evaluation\n   * @param {Roll[]} rolls - The constructed but unevaluated rolls\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialog - Dialog configuration\n   * @param {Object} message - Message configuration\n   */\n  static _onPostBasicRollConfiguration(rolls, config, dialog, message) {\n    LogUtil.log(\"DnDBIntegration._onPostBasicRollConfiguration - Hook fired\", [\n      \"hasPending:\", this.hasPendingRoll(),\n      \"rollCount:\", rolls?.length\n    ]);\n\n    if (!this.hasPendingRoll()) return;\n\n    const pendingRoll = this._pendingDnDBRoll;\n    const ddbRoll = pendingRoll?.rawRolls?.[0];\n    if (!ddbRoll || !rolls?.length) {\n      LogUtil.warn(\"DnDBIntegration._onPostBasicRollConfiguration - Missing ddbRoll or rolls\", [\n        \"ddbRoll:\", !!ddbRoll,\n        \"rollsLength:\", rolls?.length\n      ]);\n      return;\n    }\n\n    LogUtil.log(\"DnDBIntegration._onPostBasicRollConfiguration - Injecting DDB values\", [\n      \"action:\", pendingRoll?.action,\n      \"rollType:\", pendingRoll?.rollType\n    ]);\n\n    for (const roll of rolls) {\n      this._injectDiceValuesPreEval(roll, ddbRoll);\n    }\n\n    this._addDnDBFlags(message, pendingRoll);\n    this.clearPendingRoll();\n  }\n\n  /**\n   * Inject DnDB dice values into a roll BEFORE evaluation\n   * Modifies the roll terms to include pre-determined values that will be used during evaluate()\n   * @param {Roll} roll - The unevaluated Foundry roll\n   * @param {Object} ddbRoll - The DnDB roll data\n   */\n  static _injectDiceValuesPreEval(roll, ddbRoll) {\n    const notation = ddbRoll.diceNotation;\n    if (!notation) {\n      LogUtil.warn(\"DnDBIntegration._injectDiceValuesPreEval - No diceNotation found\", [ddbRoll]);\n      return;\n    }\n\n    const allDnDBDice = [];\n    for (const set of notation.set || []) {\n      for (const die of set.dice || []) {\n        allDnDBDice.push(die.dieValue);\n      }\n    }\n\n    if (allDnDBDice.length === 0) {\n      LogUtil.warn(\"DnDBIntegration._injectDiceValuesPreEval - No dice values found\", [notation]);\n      return;\n    }\n\n    let ddbDiceIndex = 0;\n    const Die = foundry.dice.terms.Die;\n\n    for (const term of roll.terms) {\n      if (term instanceof Die) {\n        term.results = [];\n        for (let i = 0; i < term.number; i++) {\n          if (ddbDiceIndex < allDnDBDice.length) {\n            term.results.push({\n              result: allDnDBDice[ddbDiceIndex],\n              active: true\n            });\n            ddbDiceIndex++;\n          }\n        }\n        term._evaluated = true;\n      }\n    }\n\n    LogUtil.log(\"DnDBIntegration._injectDiceValuesPreEval - Injected values\", [\n      \"formula:\", roll.formula,\n      \"ddbValues:\", allDnDBDice,\n      \"rollTerms:\", roll.terms.map(t => t instanceof Die ? { faces: t.faces, results: t.results } : t)\n    ]);\n  }\n\n  /**\n   * Add DnDB identification flags to the message configuration\n   * @param {Object} message - Message configuration object\n   * @param {Object} rollInfo - The DnDB roll info\n   */\n  static _addDnDBFlags(message, rollInfo) {\n    if (!message?.data) {\n      message.data = {};\n    }\n    if (!message.data.flags) {\n      message.data.flags = {};\n    }\n\n    message.data.flags[MODULE_ID] = {\n      isDnDBRoll: true,\n      ddbCharacterId: rollInfo.characterId,\n      ddbSource: rollInfo.source,\n      rollType: rollInfo.rollType,\n      action: rollInfo.action\n    };\n    message.data.flags.rsr5e = { processed: true, quickRoll: false };\n  }\n\n  /**\n   * Execute an attack through Midi-QOL workflow with DnDB dice values\n   * Does NOT auto-roll damage - waits for separate DDB damage event\n   * @param {Actor} actor - The Foundry actor\n   * @param {Activity} activity - The attack activity\n   * @param {Object} rollInfo - Parsed DnDB roll info\n   * @param {Object} options - Additional options\n   * @returns {Promise<boolean>} Success status\n   */\n  static async executeAttackWithMidi(actor, activity, rollInfo, options = {}) {\n    const MidiQOL = ModuleHelpers.getMidiQOL();\n    if (!MidiQOL) {\n      LogUtil.warn(\"DnDBIntegration: MidiQOL not available\");\n      return false;\n    }\n\n    this.setPendingRoll(rollInfo);\n    this._waitingForDnDBDamage = true;\n\n    const usageConfig = {\n      consume: { resources: false, spellSlot: false },\n      midiOptions: {\n        fastForwardAttack: true,\n        fastForwardDamage: true,\n        autoRollAttack: true,\n        autoRollDamage: 'none',\n        workflowOptions: {\n          fastForwardAttack: true,\n          fastForwardDamage: true,\n          autoRollAttack: true,\n          autoRollDamage: 'none'\n        }\n      }\n    };\n\n    const dialogConfig = { configure: false };\n    const messageConfig = {\n      create: true,\n      data: {\n        flags: {\n          [MODULE_ID]: {\n            isDnDBRoll: true,\n            ddbCharacterId: rollInfo.characterId,\n            ddbSource: rollInfo.source\n          }\n        }\n      }\n    };\n\n    try {\n      const result = await MidiQOL.completeActivityUse(activity, usageConfig, dialogConfig, messageConfig);\n      const item = activity.item;\n      const workflow = this._findWorkflowWaitingForDamage(MidiQOL, item);\n      LogUtil.log(\"DnDBIntegration.executeAttackWithMidi - After completeActivityUse\", [\n        \"result:\", result,\n        \"workflowFound:\", !!workflow,\n        \"workflowState:\", workflow?.currentAction,\n        \"isGM:\", game.user.isGM,\n        \"_waitingForDnDBDamage:\", this._waitingForDnDBDamage\n      ]);\n      return true;\n    } catch (error) {\n      LogUtil.error(\"DnDBIntegration.executeAttackWithMidi failed\", [error]);\n      this.clearPendingRoll();\n      this._waitingForDnDBDamage = false;\n      return false;\n    }\n  }\n\n  /**\n   * Execute damage through Midi-QOL workflow with DnDB dice values\n   * Implements A/B/C routing logic:\n   * A - Activity has attack + existing workflow waiting for damage  use that Midi workflow\n   * B - Activity is damage-only (no attack, e.g., save spell or auto-hit)  use new Midi workflow\n   * C - Activity has attack + recent workflow (not waiting)  attach damage to that workflow\n   * D - Activity has attack but NO workflow at all  return false to fall back to vanilla flow\n   * @param {Actor} actor - The Foundry actor\n   * @param {Activity} activity - The damage activity\n   * @param {Object} rollInfo - Parsed DnDB roll info\n   * @param {Object} options - Additional options\n   * @returns {Promise<boolean>} Success status, false means caller should use vanilla flow\n   */\n  static async executeDamageWithMidi(actor, activity, rollInfo, options = {}) {\n    const MidiQOL = ModuleHelpers.getMidiQOL();\n    if (!MidiQOL) {\n      LogUtil.warn(\"DnDBIntegration: MidiQOL not available\");\n      return false;\n    }\n\n    LogUtil.log(\"DnDBIntegration.executeDamageWithMidi - Entry\", [\n      \"wasWaitingForDnDBDamage:\", this._waitingForDnDBDamage,\n      \"isGM:\", game.user.isGM,\n      \"activityUuid:\", activity.uuid\n    ]);\n\n    this._waitingForDnDBDamage = false;\n\n    const item = activity.item;\n    const itemRequiresAttack = item?.hasAttack ?? false;\n    const workflowByActivity = MidiQOL.Workflow.getWorkflowByActivityUuid?.(activity.uuid);\n    const workflowWaiting = this._findWorkflowWaitingForDamage(MidiQOL, activity);\n    const recentWorkflow = workflowWaiting || workflowByActivity || this._findRecentWorkflowForItem(MidiQOL, activity);\n\n    LogUtil.log(\"DnDBIntegration.executeDamageWithMidi - Routing decision\", [\n      \"itemRequiresAttack:\", itemRequiresAttack,\n      \"hasWorkflowWaiting:\", !!workflowWaiting,\n      \"hasWorkflowByActivity:\", !!workflowByActivity,\n      \"hasRecentWorkflow:\", !!recentWorkflow,\n      \"recentWorkflowState:\", recentWorkflow?.currentAction,\n      \"item:\", item?.name,\n      \"activity:\", activity.name\n    ]);\n\n    if (itemRequiresAttack) {\n      if (workflowWaiting) {\n        LogUtil.log(\"DnDBIntegration: Case A - Item requires attack + workflow waiting for damage, using Midi\");\n        return await this._executeDamageExistingWorkflow(activity, rollInfo, workflowWaiting);\n      } else if (recentWorkflow) {\n        LogUtil.log(\"DnDBIntegration: Case C - Item requires attack + recent workflow, attaching damage\");\n        return await this._executeDamageAttachToWorkflow(activity, rollInfo, recentWorkflow);\n      } else {\n        LogUtil.log(\"DnDBIntegration: Case D - Item requires attack but NO workflow, falling back to vanilla\");\n        return false;\n      }\n    } else {\n      LogUtil.log(\"DnDBIntegration: Case B - Damage-only item, creating new Midi workflow\");\n      return await this._executeDamageNewWorkflow(actor, activity, rollInfo, options);\n    }\n  }\n\n  /**\n   * Find a Midi workflow for the given activity that is waiting for a damage roll\n   * Searches by activity UUID first, then by item UUID as fallback\n   * @param {Object} MidiQOL - The MidiQOL module\n   * @param {Activity} activity - The activity to find a workflow for\n   * @returns {Object|null} The workflow if found and waiting for damage, null otherwise\n   */\n  static _findWorkflowWaitingForDamage(MidiQOL, activity) {\n    if (!activity || !MidiQOL?.Workflow?.workflows) {\n      LogUtil.log(\"DnDBIntegration._findWorkflowWaitingForDamage - No activity or workflows\", [\n        \"activity:\", activity?.name,\n        \"hasWorkflows:\", !!MidiQOL?.Workflow?.workflows\n      ]);\n      return null;\n    }\n\n    const workflows = MidiQOL.Workflow.workflows;\n    const itemUuid = activity.item?.uuid;\n    LogUtil.log(\"DnDBIntegration._findWorkflowWaitingForDamage - Searching workflows\", [\n      \"activityUuid:\", activity.uuid,\n      \"itemUuid:\", itemUuid,\n      \"workflowCount:\", workflows.size\n    ]);\n\n    for (const [key, workflowRef] of workflows.entries()) {\n      const workflow = workflowRef instanceof WeakRef ? workflowRef.deref() : workflowRef;\n      if (!workflow) continue;\n\n      const matchesActivity = workflow.activity?.uuid === activity.uuid;\n      const matchesItem = workflow.item?.uuid === itemUuid;\n\n      LogUtil.log(\"DnDBIntegration._findWorkflowWaitingForDamage - Checking workflow\", [\n        workflow.id,\n        \"workflowActivityUuid:\", workflow.activity?.uuid,\n        \"workflowItemUuid:\", workflow.item?.uuid,\n        \"matchesActivity:\", matchesActivity,\n        \"matchesItem:\", matchesItem,\n        \"currentAction:\", workflow.currentAction,\n        \"waitForDamageState:\", workflow.WorkflowState_WaitForDamageRoll\n      ]);\n\n      if ((matchesActivity || matchesItem) &&\n          workflow.currentAction === workflow.WorkflowState_WaitForDamageRoll) {\n        LogUtil.log(\"DnDBIntegration._findWorkflowWaitingForDamage - Found workflow\", [\n          workflow.id,\n          \"activity:\", workflow.activity?.name,\n          \"item:\", workflow.item?.name,\n          \"state:\", workflow.currentAction\n        ]);\n        return workflow;\n      }\n    }\n\n    LogUtil.log(\"DnDBIntegration._findWorkflowWaitingForDamage - No matching workflow found\");\n    return null;\n  }\n\n  /**\n   * Find any recent Midi workflow for the given activity that doesn't have damage yet\n   * Used when damage is rolled separately from attack (e.g., bonus made attack hit)\n   * Searches by activity UUID first, then by item UUID as fallback\n   * @param {Object} MidiQOL - The MidiQOL module\n   * @param {Activity} activity - The activity to find a workflow for\n   * @returns {Object|null} The most recent workflow for this activity without damage, or null\n   */\n  static _findRecentWorkflowForItem(MidiQOL, activity) {\n    if (!activity || !MidiQOL?.Workflow?.workflows) {\n      return null;\n    }\n\n    const workflows = MidiQOL.Workflow.workflows;\n    const itemUuid = activity.item?.uuid;\n    let mostRecentWorkflow = null;\n\n    for (const [key, workflowRef] of workflows.entries()) {\n      const workflow = workflowRef instanceof WeakRef ? workflowRef.deref() : workflowRef;\n      if (!workflow) continue;\n\n      const hasDamage = workflow.damageRolls?.length > 0 || workflow.damageTotal > 0;\n      const matchesActivity = workflow.activity?.uuid === activity.uuid;\n      const matchesItem = workflow.item?.uuid === itemUuid;\n\n      if ((matchesActivity || matchesItem) && !hasDamage) {\n        mostRecentWorkflow = workflow;\n      }\n    }\n\n    if (mostRecentWorkflow) {\n      LogUtil.log(\"DnDBIntegration._findRecentWorkflowForItem - Found workflow without damage\", [\n        mostRecentWorkflow.id,\n        \"activity:\", mostRecentWorkflow.activity?.name,\n        \"item:\", mostRecentWorkflow.item?.name,\n        \"state:\", mostRecentWorkflow.currentAction\n      ]);\n      return mostRecentWorkflow;\n    }\n\n    const chatWorkflow = this._findWorkflowFromRecentChat(MidiQOL, activity);\n    return chatWorkflow;\n  }\n\n  /**\n   * Find a workflow from recent chat messages for the activity's item\n   * Used when workflow completed/suspended (e.g., attack missed) but user still rolled damage\n   * @param {Object} MidiQOL - The MidiQOL module\n   * @param {Activity} activity - The activity to find a workflow for\n   * @returns {Object|null} A workflow reconstructed from chat, or null\n   */\n  static _findWorkflowFromRecentChat(MidiQOL, activity) {\n    if (!activity?.item) return null;\n\n    const itemUuid = activity.item.uuid;\n    const recentMessages = game.messages.contents.slice(-20).reverse();\n\n    for (const message of recentMessages) {\n      const flags = message.flags?.[\"midi-qol\"];\n      if (!flags) continue;\n\n      const msgItemUuid = flags.itemUuid;\n      if (msgItemUuid !== itemUuid) continue;\n\n      const hasDamageRolls = flags.damageRolls?.length > 0 || flags.damageTotal > 0;\n      if (hasDamageRolls) continue;\n\n      LogUtil.log(\"DnDBIntegration._findWorkflowFromRecentChat - Found candidate message\", [\n        message.id,\n        \"itemUuid:\", msgItemUuid\n      ]);\n\n      const workflow = MidiQOL.Workflow.getWorkflow(message.uuid);\n      if (workflow) {\n        LogUtil.log(\"DnDBIntegration._findWorkflowFromRecentChat - Reconstructed workflow from chat\", [\n          workflow.id,\n          \"item:\", workflow.item?.name,\n          \"suspended:\", workflow.suspended\n        ]);\n        return workflow;\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Execute damage within an existing Midi workflow (Case A)\n   * @param {Activity} activity - The damage activity\n   * @param {Object} rollInfo - Parsed DnDB roll info\n   * @param {Object} workflow - The existing Midi workflow\n   * @returns {Promise<boolean>} Success status\n   */\n  static async _executeDamageExistingWorkflow(activity, rollInfo, workflow) {\n    this.setPendingRoll(rollInfo);\n\n    const rollConfig = {\n      workflow: workflow,\n      midiOptions: {\n        fastForwardDamage: true,\n        isCritical: workflow.isCritical,\n        workflowOptions: {\n          fastForwardDamage: true,\n          autoRollDamage: 'always'\n        },\n        ...workflow.rollOptions\n      }\n    };\n\n    const dialogConfig = { configure: false };\n    const messageConfig = { create: false };\n\n    try {\n      await activity.rollDamage(rollConfig, dialogConfig, messageConfig);\n      return true;\n    } catch (error) {\n      LogUtil.error(\"DnDBIntegration._executeDamageExistingWorkflow failed\", [error]);\n      this.clearPendingRoll();\n      return false;\n    }\n  }\n\n  /**\n   * Attach damage to a workflow that's not waiting for damage (Case C)\n   * Used when damage is rolled after attack completed (e.g., attack missed but user rolled damage anyway)\n   * Rolls damage independently (NOT passing workflow) then attaches to the existing workflow\n   * @param {Activity} activity - The damage activity\n   * @param {Object} rollInfo - Parsed DnDB roll info\n   * @param {Object} workflow - The Midi workflow to attach damage to\n   * @returns {Promise<boolean>} Success status\n   */\n  static async _executeDamageAttachToWorkflow(activity, rollInfo, workflow) {\n    this.setPendingRoll(rollInfo);\n\n    const isWorkflowCompleted = workflow.currentAction === workflow.WorkflowState_Completed ||\n                                 workflow.currentAction === workflow.WorkflowState_RollFinished;\n\n    LogUtil.log(\"DnDBIntegration._executeDamageAttachToWorkflow - Entry\", [\n      \"workflowId:\", workflow.id,\n      \"isWorkflowCompleted:\", isWorkflowCompleted,\n      \"currentAction:\", workflow.currentAction?.name,\n      \"suspended:\", workflow.suspended\n    ]);\n\n    const rollConfig = isWorkflowCompleted ? {} : {\n      workflow: workflow,\n      midiOptions: {\n        fastForwardDamage: true,\n        isCritical: workflow.isCritical,\n        workflowOptions: {\n          fastForwardDamage: true\n        }\n      }\n    };\n\n    const dialogConfig = { configure: false };\n    const messageConfig = { create: false };\n\n    LogUtil.log(\"DnDBIntegration._executeDamageAttachToWorkflow - Calling rollDamage\", [\n      \"rollConfig:\", rollConfig,\n      \"dialogConfig:\", dialogConfig,\n      \"messageConfig:\", messageConfig\n    ]);\n\n    try {\n      const rolls = await activity.rollDamage(rollConfig, dialogConfig, messageConfig);\n      if (!rolls?.length) {\n        LogUtil.warn(\"DnDBIntegration._executeDamageAttachToWorkflow - No rolls returned\");\n        this.clearPendingRoll();\n        return false;\n      }\n\n      LogUtil.log(\"DnDBIntegration._executeDamageAttachToWorkflow - Got damage rolls\", [\n        \"rollCount:\", rolls.length,\n        \"workflowId:\", workflow.id,\n        \"workflowSuspended:\", workflow.suspended\n      ]);\n\n      if (typeof workflow.setDamageRolls === 'function') {\n        await workflow.setDamageRolls(rolls);\n        LogUtil.log(\"DnDBIntegration._executeDamageAttachToWorkflow - Used setDamageRolls API\", [\n          \"damageTotal:\", workflow.damageTotal,\n          \"hasDamageRollHTML:\", !!workflow.damageRollHTML\n        ]);\n      } else {\n        workflow.damageRolls = rolls;\n        workflow.damageRoll = rolls[0];\n        workflow.damageTotal = rolls.reduce((total, roll) => total + roll.total, 0);\n        LogUtil.log(\"DnDBIntegration._executeDamageAttachToWorkflow - Set damageRolls directly (fallback)\");\n      }\n\n      await workflow.displayDamageRolls?.();\n\n      return true;\n    } catch (error) {\n      LogUtil.error(\"DnDBIntegration._executeDamageAttachToWorkflow failed\", [error]);\n      this.clearPendingRoll();\n      return false;\n    }\n  }\n\n  /**\n   * Execute damage with a new Midi workflow (no existing attack workflow)\n   * Used for save spells and other damage-only activities\n   * For spells with templates, prompts the user to place the template first\n   * @param {Actor} actor - The Foundry actor\n   * @param {Activity} activity - The damage activity\n   * @param {Object} rollInfo - Parsed DnDB roll info\n   * @param {Object} options - Additional options\n   * @returns {Promise<boolean>} Success status\n   */\n  static async _executeDamageNewWorkflow(actor, activity, rollInfo, options = {}) {\n    const MidiQOL = ModuleHelpers.getMidiQOL();\n\n    this.setPendingRoll(rollInfo);\n\n    const hasTemplate = activity.target?.template?.type;\n    LogUtil.log(\"DnDBIntegration._executeDamageNewWorkflow\", [\n      \"activity:\", activity.name,\n      \"hasTemplate:\", hasTemplate,\n      \"templateType:\", activity.target?.template?.type\n    ]);\n\n    const consumeSpellSlot = !DnDBRollExecutor.shouldSkipSpellSlotConsumption();\n    const usageConfig = {\n      consume: { resources: true, spellSlot: consumeSpellSlot },\n      create: { measuredTemplate: !!hasTemplate, _isDnDBRoll: true },\n      midiOptions: {\n        fastForwardAttack: true,\n        fastForwardDamage: true,\n        autoRollDamage: 'always',\n        workflowOptions: {\n          fastForwardAttack: true,\n          fastForwardDamage: true,\n          autoRollDamage: 'always'\n        }\n      }\n    };\n\n    const dialogConfig = { configure: false };\n    const messageConfig = {\n      create: true,\n      data: {\n        flags: {\n          [MODULE_ID]: {\n            isDnDBRoll: true,\n            ddbCharacterId: rollInfo.characterId,\n            ddbSource: rollInfo.source\n          }\n        }\n      }\n    };\n\n    try {\n      await MidiQOL.completeActivityUse(activity, usageConfig, dialogConfig, messageConfig);\n      return true;\n    } catch (error) {\n      LogUtil.error(\"DnDBIntegration._executeDamageNewWorkflow failed\", [error]);\n      this.clearPendingRoll();\n      return false;\n    }\n  }\n\n  /**\n   * Execute healing through Midi-QOL workflow with DnDB dice values\n   * Similar to damage workflow but for heal activities\n   * @param {Actor} actor - The Foundry actor\n   * @param {Activity} activity - The heal activity\n   * @param {Object} rollInfo - Parsed DnDB roll info\n   * @returns {Promise<boolean>} Success status\n   */\n  static async executeHealingWithMidi(actor, activity, rollInfo) {\n    const MidiQOL = ModuleHelpers.getMidiQOL();\n    if (!MidiQOL) {\n      LogUtil.warn(\"DnDBIntegration: MidiQOL not available for healing\");\n      return false;\n    }\n\n    this.setPendingRoll(rollInfo);\n\n    LogUtil.log(\"DnDBIntegration.executeHealingWithMidi\", [\n      \"activity:\", activity.name,\n      \"item:\", activity.item?.name\n    ]);\n\n    const consumeSpellSlot = !DnDBRollExecutor.shouldSkipSpellSlotConsumption();\n    const usageConfig = {\n      consume: { resources: true, spellSlot: consumeSpellSlot },\n      midiOptions: {\n        fastForwardAttack: true,\n        fastForwardDamage: true,\n        autoRollDamage: 'always',\n        workflowOptions: {\n          fastForwardAttack: true,\n          fastForwardDamage: true,\n          autoRollDamage: 'always'\n        }\n      }\n    };\n\n    const dialogConfig = { configure: false };\n    const messageConfig = {\n      create: true,\n      data: {\n        flags: {\n          [MODULE_ID]: {\n            isDnDBRoll: true,\n            ddbCharacterId: rollInfo.characterId,\n            ddbSource: rollInfo.source\n          }\n        }\n      }\n    };\n\n    try {\n      await MidiQOL.completeActivityUse(activity, usageConfig, dialogConfig, messageConfig);\n      return true;\n    } catch (error) {\n      LogUtil.error(\"DnDBIntegration.executeHealingWithMidi failed\", [error]);\n      this.clearPendingRoll();\n      return false;\n    }\n  }\n}\n","import { MODULE_ID } from \"../../../constants/General.mjs\";\nimport { getSettings } from \"../../../constants/Settings.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../../utils/SettingsUtil.mjs\";\nimport { getPlayerOwner, getTargetDescriptors } from \"../../helpers/Helpers.mjs\";\nimport { DnDBRollParser } from \"./DnDBRollParser.mjs\";\nimport { DnDBRollUtil } from \"./DnDBRollUtil.mjs\";\nimport { DnDBActivityUtil } from \"./DnDBActivityUtil.mjs\";\nimport { DnDBIntegration } from \"./DnDBIntegration.mjs\";\n\n/**\n * Executes rolls in Foundry using DnDB dice values\n * Intercepts Foundry roll methods and injects DnDB results\n */\nexport class DnDBRollExecutor {\n\n  static _pendingVanillaDamageRoll = null;\n  static _isDnDBDamageInProgress = false;\n\n  static setPendingDamageRoll(rollInfo) {\n    this._pendingVanillaDamageRoll = rollInfo;\n    LogUtil.log(\"DnDBRollExecutor.setPendingDamageRoll\", [rollInfo?.action]);\n  }\n\n  static clearPendingDamageRoll() {\n    this._pendingVanillaDamageRoll = null;\n  }\n\n  static consumePendingDamageRoll() {\n    const roll = this._pendingVanillaDamageRoll;\n    this._pendingVanillaDamageRoll = null;\n    this._isDnDBDamageInProgress = true;\n    return roll;\n  }\n\n  static hasPendingDamageRoll() {\n    return this._pendingVanillaDamageRoll !== null;\n  }\n\n  static isDnDBDamageInProgress() {\n    return this._isDnDBDamageInProgress;\n  }\n\n  static clearDnDBDamageInProgress() {\n    this._isDnDBDamageInProgress = false;\n  }\n\n  /**\n   * Check if spell slot consumption should be skipped for DDB rolls\n   * @returns {boolean} True if spell slots should NOT be consumed\n   */\n  static shouldSkipSpellSlotConsumption() {\n    const SETTINGS = getSettings();\n    return SettingsUtil.get(SETTINGS.ddbNoAutoConsumeSpellSlot.tag) === true;\n  }\n\n  /**\n   * Build whisper recipients array based on rollMode and actor\n   * For PRIVATE rolls (self in DnDB), whisper to GMs + player owner\n   * For BLIND rolls (DM in DnDB), whisper to GMs only\n   * @param {string} rollMode - The Foundry roll mode\n   * @param {Actor} actor - The actor performing the roll\n   * @returns {string[]|null} Array of user IDs to whisper to, or null for public\n   */\n  static getWhisperRecipients(rollMode, actor) {\n    if (rollMode === CONST.DICE_ROLL_MODES.PUBLIC) {\n      return null;\n    }\n    const gmIds = ChatMessage.getWhisperRecipients(\"GM\").map(u => u.id);\n    if (rollMode === CONST.DICE_ROLL_MODES.PRIVATE) {\n      const owner = getPlayerOwner(actor);\n      if (owner && !gmIds.includes(owner.id)) {\n        return [...gmIds, owner.id];\n      }\n    }\n    return gmIds;\n  }\n\n  /**\n   * Execute a roll based on the category\n   * @param {Actor} actor - The Foundry actor\n   * @param {Object} rollInfo - Parsed roll info from DnDBRollParser\n   * @param {Object} category - Roll category from DnDBRollParser\n   * @returns {Promise<boolean>} Success status\n   */\n  static async execute(actor, rollInfo, category) {\n    if (!actor) {\n      LogUtil.warn(\"DnDBRollExecutor: No actor for roll execution\");\n      return false;\n    }\n\n    LogUtil.log(\"DnDBRollExecutor: Executing roll\", [category.category, rollInfo.action]);\n\n    try {\n      switch (category.category) {\n        case \"save\":\n          return await this._executeSave(actor, rollInfo, category);\n\n        case \"abilityCheck\":\n          return await this._executeAbilityCheck(actor, rollInfo, category);\n\n        case \"skill\":\n          return await this._executeSkillCheck(actor, rollInfo, category);\n\n        case \"tool\":\n          return await this._executeToolCheck(actor, rollInfo, category);\n\n        case \"initiative\":\n          return await this._executeInitiative(actor, rollInfo);\n\n        case \"attack\":\n          return await this._executeAttack(actor, rollInfo, category);\n\n        case \"damage\":\n          return await this._executeDamage(actor, rollInfo, category);\n\n        case \"healing\":\n          return await this._executeHealing(actor, rollInfo, category);\n\n        default:\n          LogUtil.log(\"DnDBRollExecutor: Unhandled category, creating simple message\", [category]);\n          return await this._createSimpleMessage(actor, rollInfo);\n      }\n    } catch (error) {\n      LogUtil.error(\"DnDBRollExecutor: Roll execution failed\", [error]);\n      return false;\n    }\n  }\n\n  /**\n   * Execute a saving throw\n   * Sets pending roll so hook can inject DnDB values before evaluation\n   */\n  static async _executeSave(actor, rollInfo, category) {\n    DnDBIntegration.setPendingRoll(rollInfo);\n\n    const owner = getPlayerOwner(actor) || game.user;\n    const whisper = this.getWhisperRecipients(rollInfo.rollMode, actor);\n    const rollConfig = { ability: category.ability, sendRequest: false };\n    const dialogConfig = { configure: false };\n    const messageConfig = {\n      create: true,\n      rollMode: rollInfo.rollMode,\n      data: {\n        speaker: ChatMessage.getSpeaker({ actor }),\n        author: owner.id,\n        whisper: whisper,\n        blind: rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND,\n        flags: {\n          ...this._buildFlags(rollInfo),\n          rsr5e: { processed: true, quickRoll: false }\n        }\n      }\n    };\n\n    const rolls = await actor.rollSavingThrow(\n      rollConfig,\n      dialogConfig,\n      messageConfig\n    );\n\n    if (!rolls || rolls.length < 1) {\n      DnDBIntegration.clearPendingRoll();\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * Execute an ability check\n   * Sets pending roll so hook can inject DnDB values before evaluation\n   */\n  static async _executeAbilityCheck(actor, rollInfo, category) {\n    DnDBIntegration.setPendingRoll(rollInfo);\n\n    const owner = getPlayerOwner(actor) || game.user;\n    const whisper = this.getWhisperRecipients(rollInfo.rollMode, actor);\n    const rollConfig = { ability: category.ability, sendRequest: false };\n    const dialogConfig = { configure: false };\n    const messageConfig = {\n      create: true,\n      rollMode: rollInfo.rollMode,\n      data: {\n        speaker: ChatMessage.getSpeaker({ actor }),\n        author: owner.id,\n        whisper: whisper,\n        blind: rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND,\n        flags: {\n          ...this._buildFlags(rollInfo),\n          rsr5e: { processed: true, quickRoll: false }\n        }\n      }\n    };\n\n    const rolls = await actor.rollAbilityCheck(\n      rollConfig,\n      dialogConfig,\n      messageConfig\n    );\n\n    if (!rolls || rolls.length < 1) {\n      DnDBIntegration.clearPendingRoll();\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * Execute a skill check\n   * Sets pending roll so hook can inject DnDB values before evaluation\n   */\n  static async _executeSkillCheck(actor, rollInfo, category) {\n    DnDBIntegration.setPendingRoll(rollInfo);\n\n    const owner = getPlayerOwner(actor) || game.user;\n    const whisper = this.getWhisperRecipients(rollInfo.rollMode, actor);\n    const rollConfig = { skill: category.skill, sendRequest: false };\n    const dialogConfig = { configure: false };\n    const messageConfig = {\n      create: true,\n      rollMode: rollInfo.rollMode,\n      data: {\n        speaker: ChatMessage.getSpeaker({ actor }),\n        author: owner.id,\n        whisper: whisper,\n        blind: rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND,\n        flags: {\n          ...this._buildFlags(rollInfo),\n          rsr5e: { processed: true, quickRoll: false }\n        }\n      }\n    };\n\n    const rolls = await actor.rollSkill(\n      rollConfig,\n      dialogConfig,\n      messageConfig\n    );\n\n    if (!rolls || rolls.length < 1) {\n      DnDBIntegration.clearPendingRoll();\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * Execute a tool check\n   * Sets pending roll so hook can inject DnDB values before evaluation\n   */\n  static async _executeToolCheck(actor, rollInfo, category) {\n    const tool = category.tool;\n\n    if (!tool) {\n      return await this._executeAbilityCheck(actor, rollInfo, { ability: \"dex\" });\n    }\n\n    DnDBIntegration.setPendingRoll(rollInfo);\n\n    const owner = getPlayerOwner(actor) || game.user;\n    const whisper = this.getWhisperRecipients(rollInfo.rollMode, actor);\n    const rollConfig = { sendRequest: false };\n    const dialogConfig = { configure: false };\n    const messageConfig = {\n      create: true,\n      rollMode: rollInfo.rollMode,\n      data: {\n        speaker: ChatMessage.getSpeaker({ actor }),\n        author: owner.id,\n        whisper: whisper,\n        blind: rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND,\n        flags: {\n          ...this._buildFlags(rollInfo),\n          rsr5e: { processed: true, quickRoll: false }\n        }\n      }\n    };\n\n    const toolConfig = {\n      ...rollConfig,\n      ability: tool.system.ability,\n      bonus: tool.system.bonus,\n      prof: tool.system.prof,\n      item: tool,\n      tool: tool.system.type.baseItem\n    };\n    const rolls = await actor.rollToolCheck(toolConfig, dialogConfig, messageConfig);\n\n    if (!rolls || rolls.length < 1) {\n      DnDBIntegration.clearPendingRoll();\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * Execute an initiative roll and add the actor to combat\n   */\n  static async _executeInitiative(actor, rollInfo) {\n    const ddbRoll = rollInfo.rawRolls[0];\n    const initiativeTotal = ddbRoll.result?.total || 0;\n\n    let combat = game.combat;\n    if (!combat) {\n      if (game.user.isGM && canvas.scene) {\n        const cls = getDocumentClass(\"Combat\");\n        combat = await cls.create({ scene: canvas.scene.id, active: true });\n      } else {\n        ui.notifications.warn(\"COMBAT.NoneActive\", { localize: true });\n        return false;\n      }\n    }\n\n    let tokenActor = actor;\n    let token = null;\n    if (!actor.isToken) {\n      token = canvas.tokens.placeables.find(t => t.actor?.id === actor.id);\n      if (token) {\n        tokenActor = token.actor;\n      }\n    } else {\n      token = actor.token?.object || canvas.tokens.get(actor.token?.id);\n    }\n\n    let combatants = combat.getCombatantsByActor(tokenActor);\n    if (combatants.length === 0 && token) {\n      await combat.createEmbeddedDocuments(\"Combatant\", [{\n        tokenId: token.id,\n        sceneId: token.scene?.id || canvas.scene?.id,\n        actorId: actor.id,\n        hidden: token.document?.hidden || false\n      }]);\n      combatants = combat.getCombatantsByActor(tokenActor);\n    }\n\n    if (combatants.length > 0) {\n      const combatant = combatants[0];\n      await combatant.update({ initiative: initiativeTotal });\n    }\n\n    const roll = actor.getInitiativeRoll();\n    if (!roll) return true;\n\n    await roll.evaluate();\n    DnDBRollUtil.injectDnDBDiceValues(roll, ddbRoll);\n\n    const owner = getPlayerOwner(actor) || game.user;\n    const whisper = this.getWhisperRecipients(rollInfo.rollMode, actor);\n    const messageData = {\n      speaker: ChatMessage.getSpeaker({ actor }),\n      author: owner.id,\n      flavor: this._buildFlavor(rollInfo, \"initiative\"),\n      whisper: whisper,\n      blind: rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND,\n      flags: {\n        ...this._buildFlags(rollInfo),\n        rsr5e: { processed: true, quickRoll: false }\n      }\n    };\n    await roll.toMessage(messageData, { rollMode: rollInfo.rollMode });\n\n    return true;\n  }\n\n  /**\n   * Execute an attack roll\n   * Uses Midi-QOL workflow when available for full integration\n   */\n  static async _executeAttack(actor, rollInfo, category) {\n    const item = DnDBRollParser.findItemByAction(actor, category.action);\n    if (!item) {\n      LogUtil.warn(\"DnDBRollExecutor: Item not found for attack\", [category.action]);\n      return await this._createSimpleMessage(actor, rollInfo);\n    }\n\n    const activity = DnDBRollParser.getActivityFromItem(item, \"attack\");\n    if (!activity) {\n      LogUtil.warn(\"DnDBRollExecutor: No attack activity found\", [item.name]);\n      return await this._createSimpleMessage(actor, rollInfo);\n    }\n\n    if (DnDBIntegration.isActive()) {\n      LogUtil.log(\"DnDBRollExecutor._executeAttack - Using Midi-QOL workflow\");\n      return await DnDBIntegration.executeAttackWithMidi(actor, activity, rollInfo);\n    }\n\n    return await this._executeAttackVanilla(actor, item, activity, rollInfo);\n  }\n\n  /**\n   * Execute an attack roll using vanilla DnD5e system\n   */\n  static async _executeAttackVanilla(actor, item, activity, rollInfo) {\n    DnDBIntegration.setPendingRoll(rollInfo);\n\n    const ddbRoll = rollInfo.rawRolls[0];\n    const dialogConfig = { configure: false };\n    const targets = getTargetDescriptors();\n    const rollConfig = {\n      subsequentActions: false,\n      consume: { resources: false, spellSlot: false },\n      target: targets.length === 1 ? targets[0].ac : undefined,\n      sendRequest: false,\n      flags: {\n        ...this._buildFlags(rollInfo),\n        dnd5e: { roll: { type: \"attack\" } }\n      }\n    };\n\n    const oldTemplate = activity.metadata.usage.chatCard;\n    activity.metadata.usage.chatCard = `modules/${MODULE_ID}/templates/ddb-attack-card.hbs`;\n\n    const rolls = await activity.rollAttack(rollConfig, dialogConfig, {\n      create: false,\n      data: {\n        speaker: ChatMessage.getSpeaker({ actor }),\n        targets: targets,\n        flags: {\n          ...this._buildFlags(rollInfo),\n          dnd5e: { targets: targets }\n        }\n      }\n    });\n\n    if (!rolls || rolls.length < 1) {\n      activity.metadata.usage.chatCard = oldTemplate;\n      return false;\n    }\n\n    DnDBRollUtil.injectDnDBDiceValues(rolls[0], ddbRoll);\n\n    LogUtil.log(\"DnDBRollExecutor._executeAttackVanilla - after inject\", [rolls[0]]);\n\n    const usageConfig = {\n      subsequentActions: false,\n      consume: { resources: false, spellSlot: false }\n    };\n\n    const usageResults = await DnDBActivityUtil.ddbUse(activity, usageConfig, dialogConfig, {\n      create: false,\n      data: {\n        rolls: [rolls[0]],\n        speaker: ChatMessage.getSpeaker({ actor }),\n        flavor: `${item.name}: ${game.i18n.localize(\"DND5E.Attack\")}`,\n        targets: targets,\n        flags: {\n          ...this._buildFlags(rollInfo),\n          dnd5e: { roll: { type: \"attack\" }, targets: targets },\n          rsr5e: { processed: true, quickRoll: false }\n        }\n      }\n    });\n\n    activity.metadata.usage.chatCard = oldTemplate;\n\n    if (!usageResults?.message) {\n      LogUtil.warn(\"DnDBRollExecutor: ddbUse returned no message\");\n      return false;\n    }\n\n    const owner = getPlayerOwner(actor) || game.user;\n    const whisper = this.getWhisperRecipients(rollInfo.rollMode, actor);\n    usageResults.message.flags = usageResults.message.flags ?? {};\n    usageResults.message.author = owner.id;\n    if (whisper) {\n      usageResults.message.whisper = whisper;\n    }\n    if (rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND) {\n      usageResults.message.blind = true;\n    }\n    const card = await ChatMessage.implementation.create(usageResults.message, { rollMode: rollInfo.rollMode });\n    LogUtil.log(\"DnDBRollExecutor._executeAttackVanilla - created card\", [card]);\n\n    return true;\n  }\n\n  /**\n   * Execute a damage roll\n   * Uses Midi-QOL workflow when available for full integration\n   */\n  static async _executeDamage(actor, rollInfo, category) {\n    LogUtil.log(\"DnDBRollExecutor._executeDamage - Entry\", [\n      \"action:\", category.action,\n      \"isGM:\", game.user.isGM\n    ]);\n\n    const item = DnDBRollParser.findItemByAction(actor, category.action);\n    if (!item) {\n      LogUtil.warn(\"DnDBRollExecutor: Item not found for damage\", [category.action]);\n      return await this._createSimpleMessage(actor, rollInfo);\n    }\n\n    const activity = DnDBRollParser.getActivityFromItem(item, \"damage\");\n    if (!activity) {\n      LogUtil.warn(\"DnDBRollExecutor: No damage activity found\", [item.name]);\n      return await this._createSimpleMessage(actor, rollInfo);\n    }\n\n    if (DnDBIntegration.isActive()) {\n      LogUtil.log(\"DnDBRollExecutor._executeDamage - Checking Midi-QOL workflow routing\", [\n        \"isGM:\", game.user.isGM\n      ]);\n      const midiResult = await DnDBIntegration.executeDamageWithMidi(actor, activity, rollInfo);\n      if (midiResult) return true;\n      LogUtil.log(\"DnDBRollExecutor._executeDamage - Midi returned false, using vanilla flow\", [\n        \"isGM:\", game.user.isGM\n      ]);\n    }\n\n    return await this._executeDamageVanilla(actor, item, activity, rollInfo);\n  }\n\n  /**\n   * Execute a damage roll using vanilla DnD5e system\n   * For SAVE activities, stores pending roll info and lets onPostUseActivityPlayer handle the damage roll\n   */\n  static async _executeDamageVanilla(actor, item, activity, rollInfo) {\n    const dialogConfig = { configure: false };\n    const owner = getPlayerOwner(actor) || game.user;\n    const hasTemplate = activity.target?.template?.type;\n\n    if (!activity.attack) {\n      LogUtil.log(\"DnDBRollExecutor: Damage-only activity (SAVE), setting pending roll and triggering usage\", [\n        \"item:\", item.name,\n        \"hasTemplate:\", hasTemplate\n      ]);\n\n      this.setPendingDamageRoll(rollInfo);\n      const consumeSpellSlot = !this.shouldSkipSpellSlotConsumption();\n      const whisper = this.getWhisperRecipients(rollInfo.rollMode, actor);\n\n      const usageConfig = {\n        subsequentActions: false,\n        consume: { resources: true, spellSlot: consumeSpellSlot },\n        create: { measuredTemplate: !!hasTemplate, _isDnDBRoll: true }\n      };\n\n      LogUtil.log(\"DnDBRollExecutor: About to call ddbUse (will wait for template if needed)\");\n      const usageResult = await DnDBActivityUtil.ddbUse(activity, usageConfig, dialogConfig, {\n        create: true,\n        rollMode: rollInfo.rollMode,\n        data: {\n          rolls: [],\n          speaker: ChatMessage.getSpeaker({ actor }),\n          author: owner.id,\n          whisper: whisper,\n          blind: rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND,\n          flags: {\n            ...this._buildFlags(rollInfo),\n            rsr5e: { processed: true, quickRoll: false }\n          }\n        }\n      });\n      LogUtil.log(\"DnDBRollExecutor: ddbUse completed\", [\n        \"templates:\", usageResult?.templates?.length\n      ]);\n\n      return true;\n    }\n\n    DnDBIntegration.setPendingRoll(rollInfo);\n\n    const ddbRoll = rollInfo.rawRolls[0];\n    const targets = getTargetDescriptors();\n    LogUtil.log(\"DnDBRollExecutor: Rolling damage via activity (attack activity)\", [\"targets:\", targets.length]);\n\n    const rollConfig = { sendRequest: false };\n    const rolls = await activity.rollDamage(rollConfig, dialogConfig, {\n      create: false,\n      data: {\n        speaker: ChatMessage.getSpeaker({ actor }),\n        targets: targets,\n        flags: {\n          ...this._buildFlags(rollInfo),\n          dnd5e: { targets: targets }\n        }\n      }\n    });\n\n    if (!rolls || rolls.length < 1) {\n      LogUtil.warn(\"DnDBRollExecutor: rollDamage returned no rolls\");\n      return false;\n    }\n\n    DnDBRollUtil.injectDnDBDiceValues(rolls[0], ddbRoll);\n\n    LogUtil.log(\"DnDBRollExecutor: Creating damage message with targets\");\n    const whisper = this.getWhisperRecipients(rollInfo.rollMode, actor);\n    const messageConfig = {\n      speaker: ChatMessage.getSpeaker({ actor }),\n      author: owner.id,\n      flavor: `${item.name} - ${activity.damageFlavor}`,\n      whisper: whisper,\n      blind: rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND,\n      flags: {\n        ...this._buildFlags(rollInfo),\n        dnd5e: {\n          ...activity.messageFlags,\n          messageType: \"roll\",\n          roll: { type: \"damage\" },\n          targets: targets\n        },\n        rsr5e: { processed: true, quickRoll: false }\n      }\n    };\n\n    await rolls[0].toMessage(messageConfig, { rollMode: rollInfo.rollMode });\n    LogUtil.log(\"DnDBRollExecutor: Damage message created\");\n\n    return true;\n  }\n\n  /**\n   * Execute a healing roll\n   * Uses Midi-QOL workflow when available for full integration\n   */\n  static async _executeHealing(actor, rollInfo, category) {\n    const item = DnDBRollParser.findItemByAction(actor, category.action);\n    if (!item) {\n      LogUtil.warn(\"DnDBRollExecutor: Item not found for healing\", [category.action]);\n      return await this._createSimpleMessage(actor, rollInfo);\n    }\n\n    const activity = DnDBRollParser.getActivityFromItem(item, \"heal\");\n    if (!activity) {\n      LogUtil.warn(\"DnDBRollExecutor: No heal activity found\", [item.name]);\n      return await this._createSimpleMessage(actor, rollInfo);\n    }\n\n    if (DnDBIntegration.isActive()) {\n      LogUtil.log(\"DnDBRollExecutor._executeHealing - Using Midi-QOL workflow\");\n      return await DnDBIntegration.executeHealingWithMidi(actor, activity, rollInfo);\n    }\n\n    return await this._executeHealingVanilla(actor, item, activity, rollInfo);\n  }\n\n  /**\n   * Execute a healing roll using vanilla DnD5e system\n   */\n  static async _executeHealingVanilla(actor, item, activity, rollInfo) {\n    DnDBIntegration.setPendingRoll(rollInfo);\n\n    const ddbRoll = rollInfo.rawRolls[0];\n    const dialogConfig = { configure: false };\n    const owner = getPlayerOwner(actor) || game.user;\n\n    LogUtil.log(\"DnDBRollExecutor: Healing activity (vanilla), triggering usage first\", [item.name]);\n    const consumeSpellSlot = !this.shouldSkipSpellSlotConsumption();\n    const whisper = this.getWhisperRecipients(rollInfo.rollMode, actor);\n    const usageConfig = {\n      subsequentActions: false,\n      consume: { resources: true, spellSlot: consumeSpellSlot }\n    };\n\n    await DnDBActivityUtil.ddbUse(activity, usageConfig, dialogConfig, {\n      create: true,\n      rollMode: rollInfo.rollMode,\n      data: {\n        rolls: [],\n        speaker: ChatMessage.getSpeaker({ actor }),\n        author: owner.id,\n        whisper: whisper,\n        blind: rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND,\n        flags: {\n          ...this._buildFlags(rollInfo),\n          rsr5e: { processed: true, quickRoll: false }\n        }\n      }\n    });\n\n    const targets = getTargetDescriptors();\n    const rollConfig = { sendRequest: false };\n    const rolls = await activity.rollDamage(rollConfig, dialogConfig, {\n      create: false,\n      data: {\n        speaker: ChatMessage.getSpeaker({ actor }),\n        targets: targets,\n        flags: {\n          ...this._buildFlags(rollInfo),\n          dnd5e: { targets: targets }\n        }\n      }\n    });\n\n    if (!rolls || rolls.length < 1) return false;\n\n    DnDBRollUtil.injectDnDBDiceValues(rolls[0], ddbRoll);\n\n    const messageConfig = {\n      speaker: ChatMessage.getSpeaker({ actor }),\n      author: owner.id,\n      flavor: `${item.name}: ${game.i18n.localize(\"DND5E.Healing\")}`,\n      whisper: whisper,\n      blind: rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND,\n      flags: {\n        ...this._buildFlags(rollInfo),\n        dnd5e: { roll: { type: \"damage\" }, targets: targets },\n        rsr5e: { processed: true, quickRoll: false }\n      }\n    };\n    await rolls[0].toMessage(messageConfig, { rollMode: rollInfo.rollMode });\n\n    return true;\n  }\n\n  /**\n   * Create a simple roll message for unmapped entities (monsters without actors)\n   * Uses the characterName from rollInfo as the speaker alias\n   * @param {Object} rollInfo - The parsed roll info\n   * @returns {Promise<boolean>} Success status\n   */\n  static async createSimpleRollMessage(rollInfo) {\n    return this._createSimpleMessage(null, rollInfo);\n  }\n\n  /**\n   * Create a simple chat message for unhandled roll types\n   * Uses standard Foundry roll template by creating a Roll object from DDB data\n   */\n  static async _createSimpleMessage(actor, rollInfo) {\n    const speaker = actor\n      ? ChatMessage.getSpeaker({ actor })\n      : { alias: rollInfo.characterName };\n\n    const ddbRoll = rollInfo.rawRolls?.[0];\n    if (ddbRoll) {\n      const roll = DnDBRollUtil.createRollFromDnDB(ddbRoll);\n      if (roll) {\n        const owner = actor ? (getPlayerOwner(actor) || game.user) : game.user;\n        const whisper = this.getWhisperRecipients(rollInfo.rollMode, actor);\n        const typeLabel = DnDBRollParser.getRollTypeLabel(rollInfo.rollType);\n        const flavor = typeLabel ? `${rollInfo.action}: ${typeLabel}` : rollInfo.action;\n\n        await roll.toMessage({\n          speaker,\n          author: owner.id,\n          flavor,\n          whisper: whisper,\n          blind: rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND,\n          flags: {\n            ...this._buildFlags(rollInfo),\n            rsr5e: { processed: true, quickRoll: false }\n          }\n        }, { rollMode: rollInfo.rollMode });\n\n        return true;\n      }\n    }\n\n    const diceHtml = rollInfo.diceResults\n      .map((d) => `<span class=\"die d${d.type.replace(\"d\", \"\")}\">${d.value}</span>`)\n      .join(\" \");\n\n    const typeLabel = DnDBRollParser.getRollTypeLabel(rollInfo.rollType);\n    const content = `\n      <div class=\"ddb-roll flash5e-ddb-roll\">\n        <div class=\"roll-header\">\n          <span class=\"roll-action\">${rollInfo.action}</span>\n          ${typeLabel ? `<span class=\"roll-type\">${typeLabel}</span>` : \"\"}\n        </div>\n        <div class=\"roll-content\">\n          <div class=\"dice-results\">${diceHtml}</div>\n          <div class=\"roll-formula\">${rollInfo.formula}</div>\n          <div class=\"roll-total\">${rollInfo.total}</div>\n        </div>\n      </div>\n    `;\n\n    const owner = actor ? (getPlayerOwner(actor) || game.user) : game.user;\n    const whisper = this.getWhisperRecipients(rollInfo.rollMode, actor);\n    await ChatMessage.create({\n      speaker,\n      author: owner.id,\n      content,\n      whisper: whisper,\n      blind: rollInfo.rollMode === CONST.DICE_ROLL_MODES.BLIND,\n      flags: {\n        ...this._buildFlags(rollInfo),\n        rsr5e: { processed: true, quickRoll: false }\n      }\n    }, { rollMode: rollInfo.rollMode });\n\n    return true;\n  }\n\n  /**\n   * Build flavor text for roll messages\n   */\n  static _buildFlavor(rollInfo, type) {\n    const advantageLabel = rollInfo.isAdvantage\n      ? ` (${game.i18n.localize(\"DND5E.Advantage\")})`\n      : rollInfo.isDisadvantage\n        ? ` (${game.i18n.localize(\"DND5E.Disadvantage\")})`\n        : \"\";\n\n    const action = rollInfo.action;\n    const actionLower = action.toLowerCase();\n\n    if (type === \"save\") {\n      const abilityConfig = Object.entries(CONFIG.DND5E.abilities).find(\n        ([abbr, data]) => abbr === actionLower || data.label?.toLowerCase() === actionLower\n      );\n      if (abilityConfig) {\n        return `${abilityConfig[1].label} ${game.i18n.localize(\"DND5E.ActionSave\")}${advantageLabel}`;\n      }\n    }\n\n    if (type === \"check\") {\n      const abilityConfig = Object.entries(CONFIG.DND5E.abilities).find(\n        ([abbr, data]) => abbr === actionLower || data.label?.toLowerCase() === actionLower\n      );\n      if (abilityConfig) {\n        return game.i18n.format(\"DND5E.AbilityPromptTitle\", { ability: abilityConfig[1].label }) + advantageLabel;\n      }\n    }\n\n    if (type === \"skill\") {\n      const skillConfig = Object.entries(CONFIG.DND5E.skills).find(\n        ([abbr, data]) => abbr === actionLower || data.label?.toLowerCase() === actionLower\n      );\n      if (skillConfig) {\n        const abilityAbbr = skillConfig[1].ability;\n        const abilityLabel = CONFIG.DND5E.abilities[abilityAbbr]?.label || abilityAbbr;\n        return game.i18n.format(\"DND5E.SkillPromptTitle\", {\n          skill: skillConfig[1].label,\n          ability: abilityLabel\n        }) + advantageLabel;\n      }\n    }\n\n    if (type === \"initiative\") {\n      return game.i18n.localize(\"DND5E.Initiative\") + advantageLabel;\n    }\n\n    return `${action}${advantageLabel}`;\n  }\n\n  /**\n   * Build message flags for DnDB rolls\n   */\n  static _buildFlags(rollInfo) {\n    return {\n      [MODULE_ID]: {\n        isDnDBRoll: true,\n        ddbCharacterId: rollInfo.characterId,\n        ddbSource: rollInfo.source,\n        rollType: rollInfo.rollType,\n        action: rollInfo.action\n      },\n      rsr5e: { processed: true, quickRoll: false }\n    };\n  }\n}\n","import { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { ROLL_TYPES, MODULE_ID } from \"../../constants/General.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { getPlayerOwner } from \"./Helpers.mjs\";\n\n/**\n * Helper functions for roll handling\n */\nexport const RollHelpers = {\n  /**\n   * Add situational bonus to a roll configuration\n   * @param {BasicRollProcessConfiguration} config - The process configuration with rolls array\n   * @param {string} situational - The situational bonus formula\n   * @param {boolean} [addToParts=true] - Whether to add @situational to parts array. Set to false when dialog will handle it.\n   * @returns {BasicRollProcessConfiguration} The modified config\n   */\n  addSituationalBonus(config, situational, addToParts = true) {\n    LogUtil.log(\"Config before adding bonus:\", [situational, config, addToParts]);\n    if (situational && config.rolls?.[0]) {\n      if (!config.rolls[0].parts) config.rolls[0].parts = [];\n      if (!config.rolls[0].data) config.rolls[0].data = {};\n\n      config.rolls[0].data.situational = situational;\n      if (addToParts && !config.rolls[0].parts.includes(\"@situational\")) {\n        config.rolls[0].parts.push(\"@situational\");\n      }\n      LogUtil.log(\"Config after adding bonus:\", [config]);\n    }\n    return config;\n  },\n\n  /**\n   * Async helper to unset activity config flag\n   * @param {Item5e} item - The item to update\n   * @returns {Promise<void>}\n   */\n  async unsetActivityFlag(item) {\n    if(!game.user.isGM || !item) return;\n    // Clean up any existing config first\n    const existingConfig = item.getFlag(MODULE_ID, 'tempActivityConfig');\n    if (existingConfig) {\n      LogUtil.log('updateActivityConfigFlag - cleaning up existing config', [existingConfig]);\n      await item.unsetFlag(MODULE_ID, 'tempActivityConfig');\n    }\n  },\n\n  /**\n   * Async helper to update activity config flag\n   * @param {Item5e} item - The item to update\n   * @param {Object} newConfig - The new configuration to store\n   * @returns {Promise<void>}\n   */\n  async updateActivityConfigFlag(item, newConfig) {\n    // Set the new config\n    LogUtil.log('updateActivityConfigFlag - storing new activity config', [newConfig]);\n    await item.setFlag(MODULE_ID, 'tempActivityConfig', newConfig);\n  },\n\n  /**\n   * Build base configuration for all roll types\n   * @param {Object} requestData - The roll request data\n   * @param {Object} requestData.config - Configuration from the request\n   * @param {boolean} [requestData.config.advantage] - Roll with advantage\n   * @param {boolean} [requestData.config.disadvantage] - Roll with disadvantage\n   * @param {string} [requestData.config.situational] - Situational bonus formula (root level)\n   * @param {Array} [requestData.config.rolls] - Rolls array with data.situational (from dialog result)\n   * @param {number} [requestData.config.target] - DC value\n   * @param {string} [requestData.config.requestedBy] - Name of requester\n   * @param {BasicRollConfiguration} rollConfig - Individual roll configuration with parts[], data{}, options{}\n   * @param {string[]} [rollConfig.parts=[]] - Roll formula parts\n   * @param {Object} [rollConfig.data={}] - Roll data for formula resolution\n   * @param {Object} [rollConfig.options={}] - Roll options\n   * @param {Object} [additionalConfig={}] - Additional configuration specific to the roll type\n   * @param {boolean} [dialogWillHandle=true] - If true, dialog will add @situational to parts; only set data.situational\n   * @returns {BasicRollProcessConfiguration} The process configuration for D&D5e actor roll methods\n   */\n  buildRollConfig(requestData, rollConfig, additionalConfig = {}, dialogWillHandle = true) {\n\n    const config = {\n      rolls: [{\n        parts: rollConfig?.parts ?? [],\n        data: rollConfig?.data ?? {},\n        options: {\n          ...(rollConfig?.options ?? {}),\n          ...(rollConfig?.options?._fromFlashRolls && { _fromFlashRolls: true })\n        }\n      }],\n      advantage: requestData?.config?.advantage || false,\n      disadvantage: requestData?.config?.disadvantage || false,\n      target: requestData?.config?.target,\n      subject: null,\n      chatMessage: true,\n      legacy: false,\n      sendRequest: requestData?.config?.sendRequest,\n      skipRollDialog: requestData?.config?.skipRollDialog,\n      ...additionalConfig\n    };\n\n    let situational = requestData?.config?.situational;\n    const alreadyInRolls = requestData?.config?.rolls?.[0]?.data?.situational;\n\n    if (game.user.isGM) {\n      if (!situational && alreadyInRolls) {\n        situational = alreadyInRolls;\n      }\n      if (situational) {\n        this.addSituationalBonus(config, situational, !dialogWillHandle);\n      }\n    } else {\n      if (alreadyInRolls) {\n        if (!config.rolls[0].data.situational) {\n          config.rolls[0].data.situational = alreadyInRolls;\n        }\n      } else if (situational) {\n        this.addSituationalBonus(config, situational, !dialogWillHandle);\n      }\n    }\n\n    return this.ensureRollFlags(config, requestData);\n  },\n\n  /**\n   * Ensure roll config has the required flags to prevent re-interception\n   * @param {BasicRollProcessConfiguration} config - The process configuration\n   * @param {Object} requestData - The roll request data\n   * @param {Object} requestData.config - Configuration object\n   * @param {string} [requestData.config.requestedBy] - Name of requester\n   * @returns {BasicRollProcessConfiguration} The updated config with required flags\n   */\n  ensureRollFlags(config, requestData) {\n    config.isRollRequest = game.user.isGM ? false : true;\n    config._showRequestedBy = true;\n    config._requestedBy = requestData.config.requestedBy || 'GM';\n\n    return config;\n  },\n\n  /**\n   * Validate and normalize actors array\n   * @param {Actor[]|string[]} actors - Array of Actor documents or actor IDs\n   * @returns {Actor[]|null} Array of valid actors or null if no valid actors\n   */\n  validateActors(actors) {\n    if (!actors || actors.length === 0) return null;\n    \n    // Convert actor IDs to Actor documents if needed\n    if (typeof actors[0] === 'string') {\n      actors = actors.map(actorId => game.actors.get(actorId)).filter(a => a);\n    }\n    \n    return actors.length > 0 ? actors : null;\n  },\n\n  /**\n   * Determine the appropriate roll class based on roll type\n   * @param {string} rollType - The type of roll\n   * @returns {typeof BasicRoll} The appropriate roll class\n   */\n  getRollClass(rollType) {\n    const normalizedType = rollType?.toLowerCase();\n    \n    if ([ROLL_TYPES.DAMAGE, ROLL_TYPES.HEALING].includes(normalizedType)) {\n      return CONFIG.Dice.DamageRoll || CONFIG.Dice.BasicRoll;\n    } else if ([ROLL_TYPES.FORMULA, ROLL_TYPES.CUSTOM, ROLL_TYPES.HIT_DIE].includes(normalizedType)) {\n      return CONFIG.Dice.BasicRoll;\n    }\n    \n    return CONFIG.Dice.D20Roll;\n  },\n\n  /**\n   * Check if DC field should be shown for a roll type\n   * @param {string} rollType - The type of roll\n   * @returns {boolean} Whether to show DC field\n   */\n  shouldShowDC(rollType) {\n    const normalizedType = rollType?.toLowerCase();\n    return [\n      ROLL_TYPES.SAVE,\n      ROLL_TYPES.SAVING_THROW,\n      ROLL_TYPES.ABILITY,\n      ROLL_TYPES.ABILITY_CHECK,\n      ROLL_TYPES.CONCENTRATION,\n      ROLL_TYPES.SKILL,\n      ROLL_TYPES.TOOL\n    ].includes(normalizedType);\n  },\n\n  /**\n   * Create base roll configuration for dialog\n   * @param {Actor} actor - The actor to roll for\n   * @param {string} rollType - The type of roll\n   * @param {string} rollKey - The specific roll key\n   * @returns {Object} Base roll configuration\n   */\n  createBaseRollConfig(actor, rollType, rollKey) {\n    const normalizedType = rollType?.toLowerCase();\n    \n    const rollConfig = {\n      data: actor.getRollData(),\n      subject: actor,\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n    \n    switch (normalizedType) {\n      case ROLL_TYPES.SKILL:\n        rollConfig.skill = rollKey;\n        break;\n      case ROLL_TYPES.TOOL:\n        rollConfig.tool = rollKey;\n        break;\n      case ROLL_TYPES.SAVE:\n      case ROLL_TYPES.SAVING_THROW:\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.ABILITY_CHECK:\n        rollConfig.ability = rollKey;\n        break;\n      case ROLL_TYPES.HIT_DIE:\n        rollConfig.rolls[0].options.flavor = \"Hit Die\";\n        break;\n    }\n    \n    return rollConfig;\n  },\n\n  /**\n   * Create standard message configuration\n   * @param {Actor} actor - The actor creating the message\n   * @param {string} [rollMode] - Optional roll mode to set\n   * @returns {Object} Message configuration\n   */\n  createMessageConfig(actor, rollMode = null) {\n    const config = {\n      create: false,\n      data: {\n        speaker: ChatMessage.getSpeaker({ actor })\n      }\n    };\n    \n    if (rollMode) {\n      config.rollMode = rollMode;\n    }\n    \n    return config;\n  },\n\n  /**\n   * Execute a roll dialog and return the result\n   * @param {Class} DialogClass - The dialog class to instantiate\n   * @param {Object} rollConfig - Roll configuration\n   * @param {Object} messageConfig - Message configuration\n   * @param {Object} dialogOptions - Dialog options\n   * @returns {Promise<Object|null>} Dialog result or null if cancelled\n   */\n  async triggerRollDialog(DialogClass, rollConfig, messageConfig, dialogOptions) {\n    const app = new DialogClass(rollConfig, messageConfig, dialogOptions);\n    \n    const result = await new Promise(resolve => {\n      app.addEventListener(\"close\", () => {\n        resolve({\n          rolls: app.rolls,\n          config: app.config,\n          message: app.message,\n          sendRequest: app.sendRequest,\n          critical: app.config.critical,\n          isCritical: app.config.isCritical\n        });\n      }, { once: true });\n      app.render({ force: true });\n    });\n    \n    return result;\n  },\n\n  /**\n   * Process dialog result into final roll configuration\n   * @param {Object} result - Result from dialog\n   * @param {Actor[]} actors - Array of actors\n   * @param {string} rollType - The type of roll\n   * @param {string} rollKey - The specific roll key\n   * @param {Object} options - Additional options\n   * @returns {Object|null} Final roll process configuration or null if cancelled\n   */\n  processDialogResult(result, actors, rollType, rollKey, options = {}) {\n    // If no rolls or user cancelled\n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    const normalizedType = rollType?.toLowerCase();\n    const firstRoll = result.rolls[0];\n    \n    // Extract advantage mode\n    let advantage = false;\n    let disadvantage = false;\n    \n    if (firstRoll?.options?.advantageMode !== undefined) {\n      advantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE;\n      disadvantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE;\n    }\n    \n    // Extract roll data\n    const situational = firstRoll?.data?.situational || \"\";\n    const target = firstRoll?.options?.target;\n    \n    // Build roll process configuration\n    const rollProcessConfig = {\n      rolls: [{\n        parts: firstRoll?.parts?.slice() || [],\n        data: situational ? { situational } : {},\n        options: target ? { target } : {}\n      }],\n      subject: actors[0],\n      advantage,\n      disadvantage,\n      target,\n      situationalBonus: situational || '',\n      sendRequest: result.sendRequest,\n      isRollRequest: result.sendRequest,\n      skipRollDialog: result.config?.skipRollDialog || options.skipRollDialog || false,\n      chatMessage: true\n    };\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = this.determineRollMode(isPublicRollsOn, result.message?.rollMode);\n    rollProcessConfig.rollMode = rollMode;\n    \n    if (result.config?.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedType)) {\n      rollProcessConfig.ability = result.config.ability;\n    }\n    \n    return rollProcessConfig;\n  },\n\n  /**\n   * Determine the final roll mode for GM dialogs\n   * @param {boolean} isPublicRollsOn - Whether public rolls setting is enabled\n   * @param {string} messageRollMode - Roll mode from message (user's selection in dialog)\n   * @returns {string} Final roll mode\n   */\n  determineRollMode(isPublicRollsOn, messageRollMode) {\n    // If user explicitly selected a roll mode in the dialog, use it\n    if (messageRollMode) {\n      return messageRollMode;\n    }\n    \n    // For GM dialogs, always default to the GM's core roll mode setting\n    // Individual actor roll modes will be determined later based on actor type\n    return game.settings.get(\"core\", \"rollMode\");\n  },\n\n  /**\n   * Check if actor is player owned\n   * @param {Actor} actor - The actor to check\n   * @returns {boolean} Whether the actor is player owned\n   */\n  isPlayerOwned(actor) {\n    return Object.entries(actor.ownership)\n      .some(([userId, level]) => {\n        const user = game.users.get(userId);\n        return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n      });\n  },\n\n  /**\n   * Check if actor is player owned\n   * @param {Actor} actor - The actor to check\n   * @returns {boolean} Whether the actor is player owned\n   */\n  isPlayerOwnerActive(actor) {\n    const playerOwner = getPlayerOwner(actor);\n    return playerOwner && playerOwner.active;\n  },\n\n  /* -------------------------------------------- */\n  /*  Group Roll Calculation Methods              */\n  /* -------------------------------------------- */\n\n  /**\n   * Calculate group roll result using Standard Rule - At least half the group must succeed\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total, success, failure }\n   * @param {number} dc - The DC to check against\n   * @returns {Object} Result object with { finalResult, successes, failures, summary }\n   */\n  calculateStandardRule(rollResults, dc) {\n    const successes = rollResults.filter(r => r.total >= dc).length;\n    const failures = rollResults.length - successes;\n    const halfThreshold = Math.ceil(rollResults.length / 2);\n    \n    return {\n      finalResult: successes >= halfThreshold,\n      successes,\n      failures,\n      summary: game.i18n.format(\"FLASH_ROLLS.groupRoll.standardRule.summary\", {\n        successes,\n        total: rollResults.length,\n        threshold: halfThreshold\n      }),\n      method: 'Standard Rule'\n    };\n  },\n\n  /**\n   * Calculate group roll result using Group Average - Simple average of all rolls, rounded down\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total }\n   * @param {number} dc - The DC to check against\n   * @returns {Object} Result object with { finalResult, average, success, summary }\n   */\n  calculateGroupAverage(rollResults, dc) {\n    const sum = rollResults.reduce((acc, r) => acc + r.total, 0);\n    const average = Math.floor(sum / rollResults.length);\n    \n    return {\n      finalResult: average,\n      average,\n      success: average >= dc,\n      summary: game.i18n.format(\"FLASH_ROLLS.groupRoll.groupAverage.summary\", {\n        average,\n        dc\n      }),\n      method: 'Group Average'\n    };\n  },\n\n  /**\n   * Calculate group roll result using Leader with Help - Result from actor with highest bonus, plus other successes minus other failures\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total, modifier }\n   * @param {number} dc - The DC to check against\n   * @param {Actor[]} actors - Array of actors to get modifiers from\n   * @param {string} rollType - Type of roll (skill, save, ability)\n   * @param {string} rollKey - The specific roll key (e.g., 'ath', 'dex')\n   * @returns {Object} Result object with { finalResult, leaderRoll, bonus, penalty, success, summary }\n   */\n  calculateLeaderWithHelp(rollResults, dc, actors, rollType, rollKey) {\n    let highestModifier = -999;\n    let leaderIndex = -1;\n    let leaderActorId = null;\n    let leaderModifier = 0;\n    \n    // Find the leader by checking each roll result's corresponding actor\n    for (let i = 0; i < rollResults.length; i++) {\n      const result = rollResults[i];\n      const actor = actors.find(a => a.id === result.actorId);\n      if (!actor) continue;\n      \n      const modifier = this._getActorModifier(actor, rollType, rollKey);\n      if (modifier > highestModifier) {\n        highestModifier = modifier;\n        leaderIndex = i;\n        leaderActorId = actor.id;\n        leaderModifier = modifier;\n      }\n    }\n    \n    if (leaderIndex === -1) {\n      return {\n        finalResult: 0,\n        error: 'No leader found',\n        method: 'Leader with Help'\n      };\n    }\n    \n    const leaderResult = rollResults[leaderIndex];\n    \n    // Count successes and failures from other members (excluding the leader by index, not actorId)\n    const otherResults = rollResults.filter((r, index) => index !== leaderIndex);\n    const successes = otherResults.filter(r => r.total >= dc).length;\n    const failures = otherResults.filter(r => r.total < dc).length;\n    const adjustedResult = leaderResult.total + successes - failures;\n    \n    // Choose appropriate summary based on successes and failures\n    let summaryKey;\n    let summaryData = {\n      leaderRoll: leaderResult.total,\n      adjustedResult,\n      dc\n    };\n    \n    if (successes > 0 && failures > 0) {\n      summaryKey = \"FLASH_ROLLS.groupRoll.leaderWithHelp.summary\";\n      summaryData.bonus = successes;\n      summaryData.penalty = failures;\n    } else if (successes > 0) {\n      summaryKey = \"FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlySuccess\";\n      summaryData.bonus = successes;\n      summaryData.successWord = successes === 1 \n        ? game.i18n.localize(\"FLASH_ROLLS.groupRoll.leaderWithHelp.successSingular\")\n        : game.i18n.localize(\"FLASH_ROLLS.groupRoll.leaderWithHelp.successPlural\");\n    } else if (failures > 0) {\n      summaryKey = \"FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlyFailure\";\n      summaryData.penalty = failures;\n      summaryData.failureWord = failures === 1\n        ? game.i18n.localize(\"FLASH_ROLLS.groupRoll.leaderWithHelp.failureSingular\")\n        : game.i18n.localize(\"FLASH_ROLLS.groupRoll.leaderWithHelp.failurePlural\");\n    } else {\n      summaryKey = \"FLASH_ROLLS.groupRoll.leaderWithHelp.summaryNoModifiers\";\n    }\n    \n    return {\n      finalResult: adjustedResult,\n      leaderRoll: leaderResult.total,\n      leaderName: actors.find(a => a.id === leaderActorId)?.name,\n      leaderActorId,\n      leaderModifier,\n      bonus: successes,\n      penalty: failures,\n      success: adjustedResult >= dc,\n      summary: game.i18n.format(summaryKey, summaryData),\n      method: 'Leader with Help'\n    };\n  },\n\n  /**\n   * Calculate group roll result using Weakest Link - Result from actor with lowest modifier, plus number of group successes\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total }\n   * @param {number} dc - The DC to check against\n   * @param {Actor[]} actors - Array of actors to get modifiers from\n   * @param {string} rollType - Type of roll (skill, save, ability)\n   * @param {string} rollKey - The specific roll key (e.g., 'ath', 'dex')\n   * @returns {Object} Result object with { finalResult, weakestRoll, bonus, success, summary }\n   */\n  calculateWeakestLink(rollResults, dc, actors, rollType, rollKey) {\n    let lowestModifier = 999;\n    let weakestActorId = null;\n    let weakestModifierValue = 0;\n    \n    for (const actor of actors) {\n      const modifier = this._getActorModifier(actor, rollType, rollKey);\n      if (modifier < lowestModifier) {\n        lowestModifier = modifier;\n        weakestActorId = actor.id;\n        weakestModifierValue = modifier;\n      }\n    }\n    \n    const weakestResult = rollResults.find(r => r.actorId === weakestActorId);\n    if (!weakestResult) {\n      return {\n        finalResult: 0,\n        error: 'Weakest link actor did not roll',\n        method: 'Weakest Link'\n      };\n    }\n    \n    // Count successes excluding the weakest actor\n    const successes = rollResults.filter(r => r.actorId !== weakestActorId && r.total >= dc).length;\n    const adjustedResult = weakestResult.total + successes;\n    \n    const successWord = successes === 1 ? \n      game.i18n.localize(\"FLASH_ROLLS.groupRoll.weakestLink.successSingular\") : \n      game.i18n.localize(\"FLASH_ROLLS.groupRoll.weakestLink.successPlural\");\n    \n    return {\n      finalResult: adjustedResult,\n      weakestRoll: weakestResult.total,\n      weakestName: actors.find(a => a.id === weakestActorId)?.name,\n      weakestActorId,\n      weakestModifier: weakestModifierValue,\n      bonus: successes,\n      success: adjustedResult >= dc,\n      summary: game.i18n.format(\"FLASH_ROLLS.groupRoll.weakestLink.summary\", {\n        weakestRoll: weakestResult.total,\n        bonus: successes,\n        successWord,\n        adjustedResult,\n        dc\n      }),\n      method: 'Weakest Link'\n    };\n  },\n\n  /**\n   * Get the modifier for a specific roll type and key from an actor\n   * @private\n   * @param {Actor} actor - The actor to get the modifier from\n   * @param {string} rollType - Type of roll (skill, save, ability)\n   * @param {string} rollKey - The specific roll key\n   * @returns {number} The modifier value\n   */\n  _getActorModifier(actor, rollType, rollKey) {\n    const normalizedType = rollType?.toLowerCase();\n    \n    switch (normalizedType) {\n      case ROLL_TYPES.SKILL:\n        return actor.system.skills[rollKey]?.total || \n               actor.system.skills[rollKey]?.mod || 0;\n      \n      case ROLL_TYPES.SAVE:\n      case ROLL_TYPES.SAVING_THROW:\n        // Support both old and new D&D 5e data structure\n        return actor.system.abilities[rollKey]?.save?.value || \n               actor.system.abilities[rollKey]?.save || 0;\n      \n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.ABILITY_CHECK:\n        return actor.system.abilities[rollKey]?.mod || 0;\n      \n      case ROLL_TYPES.TOOL:\n        if (actor.system.tools?.[rollKey]) {\n          return actor.system.tools[rollKey].total || \n                 actor.system.tools[rollKey].mod || 0;\n        }\n        const tool = actor.items.find(i => \n          i.type === 'tool' && \n          i.system.toolType === rollKey\n        );\n        return tool?.system.bonus || 0;\n      \n      default:\n        return 0;\n    }\n  },\n\n  /**\n   * Get the group roll result based on the selected calculation method\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total }\n   * @param {number} dc - The DC to check against\n   * @param {Actor[]} actors - Array of actors (needed for some methods)\n   * @param {string} rollType - Type of roll (needed for modifier calculation)\n   * @param {string} rollKey - The specific roll key (needed for modifier calculation)\n   * @returns {Object} Result object with { complete, success, result }\n   */\n  getGroupResult(rollResults, dc, actors, rollType, rollKey) {\n    const complete = rollResults.every(r => r.total !== null && r.total !== undefined);\n    \n    if (!complete) {\n      return {\n        complete: false,\n        success: false,\n        result: 0\n      };\n    }\n\n    const SETTINGS = getSettings();\n    const resultMode = SettingsUtil.get(SETTINGS.groupRollResultMode.tag) || 1;\n    \n    let calculationResult;\n    \n    switch (resultMode) {\n      case 1: // Standard Rule\n        calculationResult = this.calculateStandardRule(rollResults, dc);\n        return {\n          complete: true,\n          success: calculationResult.finalResult,\n          result: calculationResult.finalResult ? 1 : 0,\n          details: calculationResult\n        };\n        \n      case 2: // Group Average\n        calculationResult = this.calculateGroupAverage(rollResults, dc);\n        return {\n          complete: true,\n          success: calculationResult.success,\n          result: calculationResult.finalResult,\n          details: calculationResult\n        };\n        \n      case 3: // Leader with Help\n        calculationResult = this.calculateLeaderWithHelp(rollResults, dc, actors, rollType, rollKey);\n        return {\n          complete: true,\n          success: calculationResult.success,\n          result: calculationResult.finalResult,\n          details: calculationResult\n        };\n        \n      case 4: // Weakest Link\n        calculationResult = this.calculateWeakestLink(rollResults, dc, actors, rollType, rollKey);\n        return {\n          complete: true,\n          success: calculationResult.success,\n          result: calculationResult.finalResult,\n          details: calculationResult\n        };\n        \n      default:\n        calculationResult = this.calculateStandardRule(rollResults, dc);\n        return {\n          complete: true,\n          success: calculationResult.finalResult,\n          result: calculationResult.finalResult ? 1 : 0,\n          details: calculationResult\n        };\n    }\n  },\n  /**\n   * Consolidate data from multiple rolls into a single roll by merging their data\n   * Uses the first roll as the base and merges data from subsequent rolls\n   * For damage rolls, only consolidates if rolls have the same damage type\n   * @param {Object[]} rolls - Array of roll configurations to consolidate\n   * @returns {Object[]} Array with single consolidated roll or original array if damage types differ\n   */\n  consolidateRolls(rolls) {\n    // return rolls;\n    LogUtil.log('RollHelpers.consolidateRolls - BEFORE', [rolls]);\n    if (!rolls || rolls.length <= 1 || rolls._consolidated) return rolls;\n\n    const firstDamageType = rolls[0]?.options?.type || rolls[0]?.data?.damageType;\n    if (firstDamageType) {\n      for (let i = 1; i < rolls.length; i++) {\n        const rollDamageType = rolls[i]?.options?.type || rolls[i]?.data?.damageType;\n        if ((rollDamageType && rollDamageType !== firstDamageType) ) {\n          LogUtil.log('RollHelpers.consolidateRolls - Different damage types detected, skipping consolidation', [firstDamageType, rollDamageType]);\n          return rolls;\n        }\n      }\n    }\n\n    const consolidatedRoll = rolls[0];\n\n    for (let i = 1; i < rolls.length; i++) {\n      if (rolls[i]) {\n        const sourceRoll = rolls[i];\n\n        if (sourceRoll.parts && Array.isArray(sourceRoll.parts)) {\n          consolidatedRoll.parts = consolidatedRoll.parts || [];\n          for (const part of sourceRoll.parts) {\n            if (!consolidatedRoll.parts.includes(part)) {\n              consolidatedRoll.parts.push(part);\n            }\n          }\n        }\n\n        if (sourceRoll.data && typeof sourceRoll.data === 'object') {\n          consolidatedRoll.data = consolidatedRoll.data || {};\n          for (const [key, value] of Object.entries(sourceRoll.data)) {\n            if (!(key in consolidatedRoll.data)) {\n              consolidatedRoll.data[key] = value;\n            }\n          }\n        }\n\n        if (sourceRoll.options && typeof sourceRoll.options === 'object') {\n          consolidatedRoll.options = consolidatedRoll.options || {};\n          for (const [key, value] of Object.entries(sourceRoll.options)) {\n            if (!(key in consolidatedRoll.options)) {\n              consolidatedRoll.options[key] = value;\n            }\n          }\n        }\n      }\n    }\n\n    const result = [consolidatedRoll];\n    result._consolidated = true;\n\n\n    LogUtil.log('RollHelpers.consolidateRolls - AFTER', [result]);\n    return result;\n  },\n\n  /**\n   * Determine if challenge details (DC, success/failure) should be displayed for a player\n   * Based on D&D 5e's challengeVisibility setting\n   * @param {Object} rollProcessConfig - Roll process configuration from GM\n   * @returns {boolean} True if challenge details should be shown\n   */\n  shouldDisplayChallengeForPlayer(rollProcessConfig) {\n    // GM and message author always see challenges\n    if (game.user.isGM) return true;\n    \n    // Check if this message was sent by the current player\n    const requestedBy = rollProcessConfig._requestedBy;\n    if (requestedBy === game.user.name) return true;\n    \n    // Check D&D 5e challenge visibility setting\n    const challengeVisibility = game.settings.get(\"dnd5e\", \"challengeVisibility\");\n    switch (challengeVisibility) {\n      case \"all\": \n        return true;\n      case \"player\": \n        // Show if the message author is not the GM (i.e., another player)\n        return requestedBy !== game.users.find(u => u.isGM)?.name;\n      default: \n        // \"hide\" or any other value\n        return false;\n    }\n  },\n\n  /**\n   * Centralized method to determine if roll dialog should be skipped.\n   * Handles all skip dialog logic for both GM and player contexts.\n   * @param {Object} options - Configuration options\n   * @param {Event} [options.event] - The triggering event (for modifier key detection)\n   * @param {boolean} [options.isPC=false] - Whether the actor is a PC with active player owner\n   * @param {boolean} [options.isNPC=false] - Whether the actor is an NPC\n   * @param {boolean} [options.sendRequest] - Whether this is a roll request (from menu/orchestrator)\n   * @param {boolean} [options.hasNonDigitalDice=false] - Whether user has non-digital dice configured\n   * @param {boolean} [options.forceSkip] - Force skip (explicit override)\n   * @param {boolean} [options.forceShow] - Force show dialog (explicit override)\n   * @param {boolean} [options.configSendRequest] - Explicit config.sendRequest value from roll config\n   * @param {boolean} [options.configSkipRollDialog] - Explicit config.skipRollDialog value from roll config\n   * @param {boolean} [options.isRollRequest=false] - Whether any isRollRequest flag is set (config/dialog/message)\n   * @returns {boolean} Whether to skip the roll dialog\n   */\n  shouldSkipRollDialog({\n    event = null,\n    isPC = false,\n    isNPC = false,\n    sendRequest = null,\n    hasNonDigitalDice = false,\n    forceSkip = false,\n    forceShow = false,\n    configSendRequest = undefined,\n    configSkipRollDialog = undefined,\n    isRollRequest = false\n  } = {}) {\n    if (forceShow === true) {\n      return false;\n    }\n    if (forceSkip === true) {\n      return true;\n    }\n    if (configSkipRollDialog === true) {\n      return true;\n    }\n    if (configSendRequest === false) {\n      return true;\n    }\n    if (isRollRequest === true) {\n      return true;\n    }\n    if (this._areSkipKeysPressed(event)) {\n      return true;\n    }\n    if (hasNonDigitalDice) {\n      return true;\n    }\n    if (game.user.isGM) {\n      return this._shouldSkipDialogGM({isPC, isNPC, sendRequest});\n    }\n    return false;\n  },\n\n  /**\n   * GM-specific skip dialog logic based on settings.\n   * @private\n   * @param {Object} options\n   * @param {boolean} [options.isPC=false] - Whether the actor is a PC with active player owner\n   * @param {boolean} [options.isNPC=false] - Whether the actor is an NPC\n   * @param {boolean} [options.sendRequest] - Whether this is a roll request\n   * @returns {boolean} Whether GM should skip the dialog\n   */\n  _shouldSkipDialogGM({isPC = false, isNPC = false, sendRequest = null} = {}) {\n    const SETTINGS = getSettings();\n    const skipRollDialog = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n\n    if (!skipRollDialog) {\n      return false;\n    }\n\n    const skipRollDialogOption = SettingsUtil.get(SETTINGS.skipRollDialogOption.tag);\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n\n    switch (skipRollDialogOption) {\n      case 1: // all rolls\n      LogUtil.log(\"_shouldSkipDialogGM case 1\")\n        return true;\n      case 2: // Only request rolls (PC actors being sent as request)\n      LogUtil.log(\"_shouldSkipDialogGM case 2\")\n        return (isPC===true && sendRequest===true) || (isPC===true && sendRequest !== false && rollRequestsEnabled === true);\n      case 3: // Only non-request rolls (NPC/local rolls)\n      LogUtil.log(\"_shouldSkipDialogGM case 3\")\n        return isNPC===true;\n      default:\n      LogUtil.log(\"_shouldSkipDialogGM case default\")\n        return false;\n    }\n  },\n\n  /**\n   * Check if skip dialog modifier keys are pressed.\n   * @private\n   * @param {Event} event - The triggering event\n   * @returns {boolean} Whether skip keys are pressed\n   */\n  _areSkipKeysPressed(event) {\n    if (!event) return false;\n\n    const { areKeysPressed } = game.dnd5e?.utils || {};\n    if (!areKeysPressed) {\n      return event.shiftKey || event.altKey || event.ctrlKey || event.metaKey || false;\n    }\n\n    return areKeysPressed(event, \"skipDialogNormal\") ||\n           areKeysPressed(event, \"skipDialogAdvantage\") ||\n           areKeysPressed(event, \"skipDialogDisadvantage\");\n  }\n};\n\n","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { ROLL_TYPES, MODULE_ID, ACTIVITY_TYPES } from '../../constants/General.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { getConsumptionConfig, getCreateConfig } from '../helpers/Helpers.mjs';\nimport { BaseActivityManager } from './BaseActivityManager.mjs';\n\n/**\n * Handles vanilla D&D5e activity workflow (no Midi-QOL)\n * This manager is used when Midi-QOL is NOT active\n */\nexport class VanillaActivityManager {\n\n  /**\n   * Manually trigger missing rolls for roll requests in vanilla workflow\n   * @param {Activity5e} activity - The activity\n   * @param {Object} config - Configuration object\n   * @param {Object} results - Results from activity.use()\n   */\n  static async triggerMissingRolls(activity, config, results) {\n    LogUtil.log(\"VanillaActivityManager.triggerMissingRolls\", [activity, config, results]);\n\n    // Check if damage/healing roll should be triggered for save/heal/damage-only activities\n    const hasDamageParts = activity.damage?.parts?.length > 0;\n    // const hasHealingFormula = activity.healing?.formula;\n    const needsDamageRoll = (activity.type === ACTIVITY_TYPES.SAVE) // || activity.type === ACTIVITY_TYPES.DAMAGE || activity.type === ACTIVITY_TYPES.HEAL\n      && (hasDamageParts) //  || hasHealingFormula\n      && !results.damageRolls?.length;\n\n    if (needsDamageRoll) {\n      LogUtil.log(\"VanillaActivityManager.triggerMissingRolls - Manually triggering damage/healing roll\", [activity.type]);\n      await activity.rollDamage(config, {}, {});\n    }\n  }\n\n  /**\n   * Execute a roll using vanilla DnD5e activity system\n   * Note: When Midi-QOL is active, RollHandlers calls MidiActivityManager directly\n   * Template placement: GM always gets prompted when executing.\n   * Player gets prompted if 'placeTemplateForPlayer' setting is false\n   *\n   * @param {Actor5e} actor - The actor performing the roll\n   * @param {string} rollType - The type of roll\n   * @param {string} itemId - The item ID\n   * @param {string} activityId - The activity ID (optional)\n   * @param {Object} config - Roll configuration\n   * @param {ActivityUseConfiguration} config.usage - Activity usage configuration\n   * @param {BasicRollDialogConfiguration} config.dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} config.message - Message configuration\n   */\n  static async executeActivityRoll(actor, rollType, itemId, activityId, config) {\n    LogUtil.log('ActivityManager.executeActivityRoll', [actor, rollType, itemId, activityId, config]);\n    const SETTINGS = getSettings();\n    const promptForTemplate = game.user.isGM || SettingsUtil.get(SETTINGS.placeTemplateForPlayer.tag) === false;\n    const item = actor.items.get(itemId);\n    if (!item) {\n      LogUtil.error(`Item not found on actor`, [actor, itemId]);\n      return;\n    }\n\n    let activity = (activityId ? item.system.activities?.get(activityId) : BaseActivityManager.findActivityForRoll(item, rollType)) || null;\n\n    if (!activity) {\n      LogUtil.error(`Activity not found on item`, [item, activityId, rollType]);\n      return;\n    }\n\n    const normalizedRollType = rollType?.toLowerCase();\n    let damageConfig = null;\n\n    if (activity) {\n      switch (normalizedRollType) {\n        case ROLL_TYPES.ATTACK:\n          await this.executeAttackActivity(actor, activity, config);\n          break;\n        case ROLL_TYPES.DAMAGE:\n          LogUtil.log('executeActivityRoll - damage roll #0', [activity, config]);\n          damageConfig = {\n            critical: config.usage.critical || {},\n            situational: config.usage.rolls[0].data.situational || \"\",\n            rollMode: config.message?.rollMode,\n            create: config.message?.create !== false,\n            scaling: config.usage.scaling,\n            skipRollDialog: config.usage.skipRollDialog,\n            consume: config.usage.consume\n          };\n          config.usage = {\n            ...config.usage,\n            consume: getConsumptionConfig(config.usage.consume || {}, true),\n            create: getCreateConfig(config.usage.create || {}, true)\n          }\n          await activity.item.setFlag(MODULE_ID, 'tempDamageConfig', damageConfig);\n          LogUtil.log('executeActivityRoll - flag set', [damageConfig]);\n\n          const isDamageOnlyActivity = activity.type === ACTIVITY_TYPES.DAMAGE || activity.type === ACTIVITY_TYPES.SAVE || !activity?.attack;\n          const isSaveActivity = activity.type === ACTIVITY_TYPES.SAVE;\n          const isAttackActivity = activity.type === ACTIVITY_TYPES.ATTACK;\n\n          switch(activity.type){\n            case ACTIVITY_TYPES.DAMAGE:\n              await this.executeDamageActivity(actor, activity, config);\n              break;\n            case ACTIVITY_TYPES.SAVE:\n              await this.executeSaveActivity(actor, activity, config);\n              break;\n            case ACTIVITY_TYPES.HEAL:\n              await this.executeHealActivity(actor, activity, config);\n              break;\n            case ACTIVITY_TYPES.ATTACK:\n              await this.executeDamagefromAttack(actor, activity, config, damageConfig);\n              break;\n            default:\n              LogUtil.error('executeActivityRoll | untracked activity type', [activity.type]);\n              break;\n          }\n\n      }\n      return;\n    }\n\n    throw new Error(`No suitable method found for ${normalizedRollType} on item ${item.name}`);\n  }\n\n\n  /**\n   * Calls activity use for attack requests\n   * or for local GM activity use if player is offline\n   * Stores tempAttackConfig flag so full config data can be retrieved in preRoll hook\n   * Note: This is only called for vanilla DnD5e workflow (when Midi-QOL is not active)\n   */\n  static async executeAttackActivity(actor, activity, config){\n    LogUtil.log('executeAttackActivity', [config]);\n\n    const rollRequestConfig = {\n      attackMode: config.usage.attackMode,\n      ammunition: config.usage.ammunition,\n      mastery: config.usage.mastery,\n      situational: config.usage.rolls?.[0]?.data?.situational,\n      advantage: config.usage.advantage,\n      disadvantage: config.usage.disadvantage,\n      rollMode: config.message?.rollMode,\n      skipRollDialog: config.usage.skipRollDialog,\n      consume: config.usage.consume,\n      create: config.usage.create\n    };\n    config.message.create = true;\n    await activity.item.setFlag(MODULE_ID, 'tempAttackConfig', rollRequestConfig);\n\n    try {\n      await activity.use(config.usage, config.dialog, config.message);\n    } catch (error) {\n      LogUtil.error('executeAttackActivity - attack roll error', [error]);\n    } finally {\n      await activity.item.unsetFlag(MODULE_ID, 'tempAttackConfig');\n    }\n  }\n\n  /**\n   * Execute a save activity for vanilla DnD5e workflow\n   * Note: This is only called when Midi-QOL is not active\n   */\n  static async executeSaveActivity(actor, activity, config, damageConfig){\n    try {\n      LogUtil.log('executeSaveActivity - calling activity use', [activity, config]);\n      await activity.use(config.usage, config.dialog, config.message);\n    } catch (error) {\n      LogUtil.error('executeSaveActivity - save roll error', [error]);\n    } finally {\n      await activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n      await activity.item.unsetFlag(MODULE_ID, 'tempSaveConfig');\n    }\n  }\n\n  /**\n   * Execute a damage activity for vanilla DnD5e workflow\n   * Note: This is only called when Midi-QOL is not active\n   */\n  static async executeDamageActivity(actor, activity, config){\n    try {\n      LogUtil.log('executeDamageActivity - calling damage use', [activity, config]);\n      await activity.use(config.usage, config.dialog, config.message);\n    } catch (error) {\n      LogUtil.error('executeDamageActivity - roll error', [error]);\n    } finally {\n      await activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n    }\n  }\n\n  /**\n   * Execute a heal activity for vanilla DnD5e workflow\n   * Note: This is only called when Midi-QOL is not active\n   */\n  static async executeHealActivity(actor, activity, config){\n    try {\n      LogUtil.log('executeHealActivity - calling use', [activity, config]);\n      await activity.use(config.usage, config.dialog, config.message);\n    } catch (error) {\n      LogUtil.error('executeHealActivity - roll error', [error]);\n    } finally {\n      await activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n    }\n  }\n\n  /**\n   * Execute damage roll from an attack activity for vanilla DnD5e workflow\n   * Note: This is only called when Midi-QOL is not active\n   */\n  static async executeDamagefromAttack(actor, activity, config, damageConfig){\n    await activity.rollDamage(damageConfig, config.dialog, config.message);\n  }\n}","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { ROLL_TYPES, MODULE_ID, ACTIVITY_TYPES } from '../../constants/General.mjs';\nimport { ModuleHelpers } from '../helpers/ModuleHelpers.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { getConsumptionConfig, getCreateConfig, isPlayerOwned } from '../helpers/Helpers.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\n\n/**\n * Handles activity execution and roll hooks when Midi-QOL is active\n * Midi-QOL uses its own workflow system that differs from vanilla DnD5e:\n * - DAMAGE activities: use() internally triggers damage roll\n * - SAVE activities: use() handles save, damage rolled separately by Midi workflow\n * - Uses MidiQOL.completeActivityUse() as the canonical entry point\n *\n * Also handles Midi-specific hook logic to ensure proper dialog behavior\n */\nexport class MidiActivityManager {\n\n  // ========================================\n  // UTILITY METHODS\n  // ========================================\n\n  /**\n   * Check if Midi-QOL is active\n   */\n  static isActive() {\n    return GeneralUtil.isModuleOn('midi-qol');\n  }\n\n  /**\n   * Check if this is a local roll when Midi is active\n   * Returns true if Midi should handle this (skip vanilla processing)\n   */\n  static shouldHandleRoll(isLocalRoll) {\n    return this.isActive() && isLocalRoll;\n  }\n\n  /**\n   * Check if vanilla should handle save damage roll\n   * Returns true if vanilla should trigger damage (Midi won't handle it)\n   */\n  static shouldVanillaHandleSaveDamage(activity) {\n    if (!this.isActive()) return true;\n    return false;\n  }\n\n  /**\n   * Check if vanilla should trigger damage roll on player side\n   * For save activities with templates, Midi may not trigger damage in some cases\n   */\n  static shouldPlayerTriggerSaveDamage(activity, config) {\n    if (!this.isActive()) return true;\n\n    const hasTemplate = activity.target?.template.count > 0;\n    const templateNotPlaced = config.create.measuredTemplate !== true;\n    const isEmanation = activity.target?.template?.type === \"radius\";\n\n    return hasTemplate && templateNotPlaced && !isEmanation;\n  }\n\n  /**\n   * Check if Midi-QOL is configured to auto-roll attack rolls\n   * Based on midi-qol's getAutoRollAttack() logic\n   */\n  static #isAutoAttack(workflow) {\n    if (workflow?.systemCard) return false;\n    if (workflow?.workflowOptions?.autoRollAttack !== undefined) {\n      return workflow.workflowOptions.autoRollAttack;\n    }\n\n    const MidiQOL = ModuleHelpers.getMidiQOL();\n    const configSettings = MidiQOL?.currentConfigSettings;\n    if (!configSettings) return false;\n\n    return game.user?.isGM\n      ? configSettings.gmAutoAttack\n      : configSettings.autoRollAttack;\n  }\n\n  /**\n   * Check if Midi-QOL is configured to auto-roll damage rolls\n   * Based on midi-qol's getAutoRollDamage() logic\n   * Returns true if damage will be auto-rolled (not \"none\")\n   */\n  static #isAutoDamage(workflow) {\n    if (workflow?.workflowOptions?.autoRollDamage) {\n      return workflow.workflowOptions.autoRollDamage !== \"none\";\n    }\n\n    const MidiQOL = ModuleHelpers.getMidiQOL();\n    const configSettings = MidiQOL?.currentConfigSettings;\n    if (!configSettings) return false;\n\n    const autoRollDamage = game.user?.isGM\n      ? configSettings.gmAutoDamage\n      : configSettings.autoRollDamage;\n\n    return autoRollDamage !== \"none\";\n  }\n\n  // ========================================\n  // HOOK HANDLERS\n  // ========================================\n\n  /**\n   * Handle pre-roll attack hook for Midi-QOL compatibility\n   * Checks for fastForward option from Midi workflow\n   */\n  static onPreRollAttackV2(config, dialogOptions, messageOptions) {\n    LogUtil.log(\"MidiActivityManager.onPreRollAttackV2\", [config, dialogOptions, messageOptions]);\n  }\n\n  /**\n   * Handle pre-roll damage hook for Midi-QOL compatibility\n   * Ensures dialogs show for player-side damage-only activities by disabling fastForward\n   * This prevents duplicate damage rolls and ensures proper workflow\n   */\n  static onPreRollDamageV2(config, dialogOptions, messageOptions) {\n    LogUtil.log(\"MidiActivityManager.onPreRollDamageV2\", [config, dialogOptions, messageOptions]);\n  }\n\n  /**\n   * Handle post-use activity hook on player side for Midi workflows\n   * Used to manually trigger damage rolls when GM places templates\n   * @param {Activity5e} activity - The activity\n   * @param {Object} config - Activity usage configuration\n   * @param {Object} results - Activity use results\n   */\n  static async onPostUseActivityPlayer(activity, config, results) {\n    LogUtil.log(\"MidiActivityManager.onPostUseActivityPlayer #0\", [activity, config, results]);\n\n  }\n\n  /**\n   * Manually trigger attack or damage rolls if Midi didn't auto-roll them\n   * Called from BaseActivityManager.onPostUseActivityGM for roll requests\n   * @param {Activity5e} activity - The activity\n   * @param {Object} config - Activity usage configuration\n   * @param {Object} results - Activity use results\n   */\n  static async triggerMissingRolls(activity, config, results) {\n    LogUtil.log(\"MidiActivityManager.triggerMissingRolls\", [activity, config, results]);\n\n    const MidiQOL = ModuleHelpers.getMidiQOL();\n    if (!MidiQOL) return;\n\n    const workflow = MidiQOL.Workflow?.getWorkflowByActivityUuid?.(activity.uuid);\n    const hasWorkflowAttackRoll = workflow?.attackRoll || workflow?.attackRolls?.length > 0;\n    const hasWorkflowDamageRoll = workflow?.damageRoll || workflow?.damageRolls?.length > 0;\n\n    const isAutoAttack = this.#isAutoAttack(workflow);\n    if (activity.type === ACTIVITY_TYPES.ATTACK && !hasWorkflowAttackRoll && !isAutoAttack) {\n      LogUtil.log(\"MidiActivityManager.triggerMissingRolls - Manually triggering attack roll\");\n      await activity.rollAttack(config, {}, {});\n    }\n\n    const hasDamageParts = activity.damage?.parts?.length > 0;\n    const hasHealingFormula = activity.healing?.formula;\n    const isAutoDamage = this.#isAutoDamage(workflow);\n    const needsDamageRoll = (activity.type === ACTIVITY_TYPES.SAVE || activity.type === ACTIVITY_TYPES.HEAL || activity.type === ACTIVITY_TYPES.DAMAGE)\n      && (hasDamageParts || hasHealingFormula)\n      && !hasWorkflowDamageRoll\n      && !isAutoDamage;\n\n    if (needsDamageRoll) {\n      LogUtil.log(\"MidiActivityManager.triggerMissingRolls - Manually triggering damage/healing roll\", [activity.type]);\n      await activity.rollDamage(config, {}, {});\n    }\n  }\n\n  // ========================================\n  // ACTIVITY EXECUTION\n  // ========================================\n\n  /**\n   * Execute a roll using Midi-QOL's workflow system\n   * @param {Actor5e} actor - The actor performing the roll\n   * @param {string} rollType - The type of roll\n   * @param {string} itemId - The item ID\n   * @param {string} activityId - The activity ID (optional)\n   * @param {Object} config - Roll configuration\n   * @param {ActivityUseConfiguration} config.usage - Activity usage configuration\n   * @param {BasicRollDialogConfiguration} config.dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} config.message - Message configuration\n   */\n  static async executeActivityRoll(actor, rollType, itemId, activityId, config) {\n    LogUtil.log('MidiActivityManager.executeActivityRoll', [actor, rollType, itemId, activityId, config]);\n\n    const item = actor.items.get(itemId);\n    if (!item) {\n      LogUtil.error(`Item not found on actor`, [actor, itemId]);\n      return;\n    }\n\n    const activity = activityId ? item.system.activities?.get(activityId) : null;\n    if (!activity) {\n      LogUtil.error(`Activity not found on item`, [item, activityId]);\n      return;\n    }\n\n    const normalizedRollType = rollType?.toLowerCase();\n\n    switch (normalizedRollType) {\n      case ROLL_TYPES.ATTACK:\n        await this.executeAttackActivity(actor, activity, config);\n        break;\n      case ROLL_TYPES.DAMAGE:\n        await this.executeDamageActivity(actor, activity, config);\n        break;\n      case ROLL_TYPES.ITEM_SAVE:\n        await this.executeSaveActivity(actor, activity, config);\n        break;\n      default:\n        LogUtil.warn('MidiActivityManager: Unhandled roll type', [rollType]);\n        break;\n    }\n  }\n\n  /**\n   * Execute an attack activity using Midi-QOL workflow\n   * @param {Actor5e} actor - The actor\n   * @param {Activity5e} activity - The attack activity\n   * @param {Object} config - Roll configuration\n   */\n  static async executeAttackActivity(actor, activity, config) {\n    LogUtil.log('MidiActivityManager.executeAttackActivity', [activity, config]);\n\n    const rollRequestConfig = {\n      attackMode: config.usage.attackMode,\n      ammunition: config.usage.ammunition,\n      mastery: config.usage.mastery,\n      situational: config.usage.rolls?.[0]?.data?.situational,\n      advantage: config.usage.advantage,\n      disadvantage: config.usage.disadvantage,\n      rollMode: config.message?.rollMode,\n      skipRollDialog: config.usage.skipRollDialog,\n      consume: config.usage.consume,\n      create: config.usage.create\n    };\n\n    config.message.create = true;\n    await activity.item.setFlag(MODULE_ID, 'tempAttackConfig', rollRequestConfig);\n\n    try {\n      config.usage.consume = getConsumptionConfig(config.usage.consume || {}, true);\n      await this.completeActivityUse(activity, config.usage, config.dialog, config.message);\n    } catch (error) {\n      LogUtil.error('MidiActivityManager.executeAttackActivity - error', [error]);\n    } finally {\n      await activity.item.unsetFlag(MODULE_ID, 'tempAttackConfig');\n    }\n  }\n\n  /**\n   * Execute a damage activity using Midi-QOL workflow\n   * For DAMAGE activities, activity.use() internally triggers the damage roll through Midi's workflow\n   * DO NOT call activity.rollDamage() separately as it will create duplicate dialogs\n   * @param {Actor5e} actor - The actor\n   * @param {Activity5e} activity - The damage activity\n   * @param {Object} config - Roll configuration\n   */\n  static async executeDamageActivity(actor, activity, config) {\n    LogUtil.log('MidiActivityManager.executeDamageActivity', [activity, config]);\n\n    const isAttackActivityDamageRequest = activity.type === ACTIVITY_TYPES.ATTACK && config.usage.rollType === ROLL_TYPES.DAMAGE;\n\n    const baseDamageConfig = {\n      critical: config.usage.critical || {},\n      situational: config.usage.rolls?.[0]?.data?.situational || \"\",\n      rollMode: config.message?.rollMode,\n      create: config.message?.create !== false,\n      scaling: config.usage.scaling,\n      skipRollDialog: config.usage.skipRollDialog,\n      consume: config.usage.consume\n    };\n\n    if (isAttackActivityDamageRequest) {\n      const MidiQOL = ModuleHelpers.getMidiQOL();\n      const workflow = MidiQOL?.Workflow?.getWorkflowByActivityUuid?.(activity.uuid);\n\n      const damageConfig = {\n        ...baseDamageConfig,\n        workflow: workflow,\n        midiOptions: this.prepareDamageMidiOptions(config.usage.skipRollDialog)\n      };\n      const messageConfig = workflow ? { create: false } : config.message;\n      \n      try {\n        LogUtil.log(\"executeDamageActivity - case #1\")\n        await activity.rollDamage(damageConfig, config.dialog, messageConfig);\n      } catch (error) {\n        LogUtil.error('MidiActivityManager.executeDamageActivity - error', [error]);\n      }\n    } else {\n      config.usage._rollType = ROLL_TYPES.DAMAGE;\n\n      config.usage = {\n        ...config.usage,\n        consume: getConsumptionConfig(config.usage.consume || {}, true),\n        create: getCreateConfig(config.usage.create || {}, true)\n      };\n\n      await activity.item.setFlag(MODULE_ID, 'tempDamageConfig', baseDamageConfig);\n\n      try {\n        LogUtil.log(\"executeDamageActivity - case #2\")\n        await this.completeActivityUse(activity, config.usage, config.dialog, config.message);\n      } catch (error) {\n        LogUtil.error('MidiActivityManager.executeDamageActivity - error', [error]);\n      } finally {\n        await activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n      }\n    }\n  }\n\n  /**\n   * Execute a save activity using Midi-QOL workflow\n   * @param {Actor5e} actor - The actor\n   * @param {Activity5e} activity - The save activity\n   * @param {Object} config - Roll configuration\n   */\n  static async executeSaveActivity(actor, activity, config) {\n    LogUtil.log('MidiActivityManager.executeSaveActivity', [activity, config]);\n\n    try {\n      config.usage.consume = getConsumptionConfig(config.usage.consume || {}, true);\n      await this.completeActivityUse(activity, config.usage, config.dialog, config.message);\n    } catch (error) {\n      LogUtil.error('MidiActivityManager.executeSaveActivity - error', [error]);\n    } finally {\n      await activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n      await activity.item.unsetFlag(MODULE_ID, 'tempSaveConfig');\n    }\n  }\n\n  /**\n   * Use MidiQOL.completeActivityUse to execute an activity with proper workflow handling\n   * This is the canonical way to execute activities with Midi-QOL\n   * @param {Activity5e} activity - The activity to execute\n   * @param {ActivityUseConfiguration} usage - Usage configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   */\n  static async completeActivityUse(activity, usage = {}, dialog = {}, message = {}) {\n    LogUtil.log('MidiActivityManager.completeActivityUse #0', [activity, usage, dialog, message]);\n    \n    const usageConfig = this.prepareUsageConfig(activity, usage);\n    LogUtil.log('MidiActivityManager.completeActivityUse #1', [usageConfig]);\n\n    return await MidiQOL.completeActivityUse(activity, usageConfig, dialog, message);\n  }\n\n  /**\n   * Handle pre-use activity hook on player side for Midi-QOL integration\n   * Ensures workflow configuration is set up properly for template activities\n   * @param {Activity5e} activity - The activity\n   * @param {Object} config - Activity usage configuration\n   * @param {Object} dialog - Dialog configuration\n   * @param {Object} message - Message configuration\n   */\n  static onPreUseActivityPlayer(activity, config, dialog, message) {\n    const SETTINGS = getSettings();\n    const placeTemplateForPlayer = SettingsUtil.get(SETTINGS.placeTemplateForPlayer.tag);\n    const hasTemplate = activity.target?.template?.type;\n\n    if (placeTemplateForPlayer && hasTemplate && config.templateUuid) {\n      const workflow = config.workflow;\n      if (workflow) {\n        workflow.templateUuid = config.templateUuid;\n        LogUtil.log(\"MidiActivityManager.onPreUseActivityPlayer - Template configured on workflow\", [workflow.id, config.templateUuid]);\n      }\n    }\n  }\n\n  /**\n   * Prepare Midi options specifically for damage rolls\n   * @param {boolean} skipRollDialog - Whether to skip the roll dialog\n   * @returns {Object} - Midi options for damage rolls\n   */\n  static prepareDamageMidiOptions(skipRollDialog = false) {\n    const SETTINGS = getSettings();\n    const skipDialogsSetting = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n    const skipDialogs = skipRollDialog ?? skipDialogsSetting ?? false;\n    const isPlayerSide = !game.user.isGM;\n\n    return {\n      fastForwardDamage: isPlayerSide ? false : skipDialogs,\n      autoRollDamage: 'onHit',\n      workflowOptions: {\n        autoRollDamage: 'onHit'\n      }\n    };\n  }\n\n  /**\n   * Prepare usage configuration for Midi-QOL\n   * @param {Activity5e} activity - The activity\n   * @param {ActivityUseConfiguration} config - Base configuration\n   * @returns {ActivityUseConfiguration} - Prepared configuration\n   */\n  static prepareUsageConfig(activity, config = {}) {\n    const SETTINGS = getSettings();\n    const skipDialogsSetting = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n    const skipDialogs = config.skipRollDialog ?? skipDialogsSetting ?? false;\n\n    const isPlayerSide = !game.user.isGM;\n    const isDamageRollRequest = config._rollType === ROLL_TYPES.DAMAGE;\n\n    const shouldForceAutoRollDamage = isDamageRollRequest\n      || activity.type === ACTIVITY_TYPES.SAVE\n      || activity.type === ACTIVITY_TYPES.HEAL\n      || activity.type === ACTIVITY_TYPES.DAMAGE\n      || (activity.type === ACTIVITY_TYPES.ATTACK && !activity.attack);\n\n    const placeTemplateForPlayer = SettingsUtil.get(SETTINGS.placeTemplateForPlayer.tag);\n    const hasTemplate = activity.target?.template?.type;\n    const isTemplateActivity = placeTemplateForPlayer && hasTemplate;\n\n    const midiOptions = {\n      ...config.midiOptions,\n      fastForwardAttack: isPlayerSide ? false : skipDialogs,\n      fastForwardDamage: isPlayerSide && shouldForceAutoRollDamage ? false : skipDialogs,\n      autoRollAttack: true,\n      workflowOptions: {\n        autoRollAttack: true,\n        ...(shouldForceAutoRollDamage && { autoRollDamage: 'onHit' })\n      }\n    };\n\n    if (shouldForceAutoRollDamage) {\n      midiOptions.autoRollDamage = 'onHit';\n    }\n\n    const defaultConfig = {\n      consume: {\n        action: false,\n        resources: [],\n        spellSlot: false\n      },\n      midiOptions\n    };\n\n    return { ...config, ...defaultConfig };\n  }\n}\n","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { ROLL_TYPES, MODULE_ID, ACTIVITY_TYPES } from '../../constants/General.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { getConsumptionConfig, getCreateConfig, isPlayerOwned, showConsumptionConfig, getTargetDescriptors, getPlayerOwner } from '../helpers/Helpers.mjs';\nimport { DnDBRollExecutor } from '../integrations/dnd-beyond/DnDBRollExecutor.mjs';\nimport { DnDBRollUtil } from '../integrations/dnd-beyond/DnDBRollUtil.mjs';\nimport { DnDBIntegration } from '../integrations/dnd-beyond/DnDBIntegration.mjs';\nimport { RollHelpers } from '../helpers/RollHelpers.mjs';\nimport { HooksManager } from '../core/HooksManager.mjs';\nimport { VanillaActivityManager } from './VanillaActivityManager.mjs';\nimport { MidiActivityManager } from './MidiActivityManager.mjs';\n\n/**\n * @typedef {Object} ActivityUseConfiguration\n * @property {object|false} create\n * @property {boolean} create.measuredTemplate - Should this item create a template?\n * @property {object} concentration\n * @property {boolean} concentration.begin - Should this usage initiate concentration?\n * @property {string|null} concentration.end - ID of an active effect to end concentration on.\n * @property {object|false} consume\n * @property {boolean} consume.action - Should action economy be tracked? Currently only handles legendary actions.\n * @property {boolean|number[]} consume.resources - Set to `true` or `false` to enable or disable all resource\n *                                                   consumption or provide a list of consumption target indexes\n *                                                   to only enable those targets.\n * @property {boolean} consume.spellSlot - Should this spell consume a spell slot?\n * @property {Event} event - The browser event which triggered the item usage, if any.\n * @property {boolean|number} scaling - Number of steps above baseline to scale this usage, or `false` if\n *                                      scaling is not allowed.\n * @property {object} spell\n * @property {number} spell.slot - The spell slot to consume.\n * @property {boolean} [subsequentActions=true] - Trigger subsequent actions defined by this activity.\n * @property {object} [cause]\n * @property {string} [cause.activity] - Relative UUID to the activity that caused this one to be used.\n *                                       Activity must be on the same actor as this one.\n * @property {boolean|number[]} [cause.resources] - Control resource consumption on linked item.\n * @property {BasicRollConfiguration[]} [rolls] - Roll configurations for this activity\n */\n\n/**\n * Base Activity Manager - Single entry point for all activity operations\n * Routes to appropriate implementation (Vanilla or Midi) based on active modules\n * Contains common methods that work the same for both workflows\n */\nexport class BaseActivityManager {\n\n  static _isMidiActive = null;\n\n  /**\n   * Check if Midi-QOL is active (cached)\n   */\n  static get isMidiActive() {\n    if (this._isMidiActive === null) {\n      this._isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n    }\n    return this._isMidiActive;\n  }\n\n  /**\n   * Reset Midi cache (useful for module hot reload)\n   */\n  static resetMidiCache() {\n    this._isMidiActive = null;\n  }\n\n  // ========================================\n  // COMMON METHODS (work same for both)\n  // ========================================\n\n  /**\n   * Find the appropriate activity for a given roll type on an item\n   */\n  static findActivityForRoll(item, rollType) {\n    if (!item?.system?.activities) return null;\n\n    const activities = item.system.activities;\n    const normalizedRollType = rollType?.toLowerCase();\n\n    switch (normalizedRollType) {\n      case ROLL_TYPES.ATTACK:\n        const attackActivities = activities.getByType(\"attack\");\n        return attackActivities?.[0] || null;\n\n      case ROLL_TYPES.DAMAGE:\n        const damageAttackActivities = activities.getByType(\"attack\");\n        if (damageAttackActivities?.length > 0) return damageAttackActivities[0];\n\n        const damageActivities = activities.getByType(\"damage\");\n        if (damageActivities?.length > 0) return damageActivities[0];\n\n        const saveActivities = activities.getByType(\"save\");\n        if (saveActivities?.length > 0) return saveActivities[0];\n\n        const healActivities = activities.getByType(\"heal\");\n        if (healActivities?.length > 0) return healActivities[0];\n\n        return null;\n\n      case ROLL_TYPES.ITEM_SAVE:\n        const itemSaveActivities = activities.getByType(\"save\");\n        return itemSaveActivities?.[0] || null;\n\n      default:\n        return null;\n    }\n  }\n\n  /**\n   * Get all activities of a specific type from an item\n   */\n  static getActivitiesByType(item, activityType) {\n    if (!item?.system?.activities) return [];\n    return item.system.activities.getByType(activityType);\n  }\n\n  /**\n   * Check if an item has activities suitable for a given roll type\n   */\n  static hasActivityForRoll(item, rollType) {\n    LogUtil.log('hasActivityForRoll', [item, rollType]);\n    return !!this.findActivityForRoll(item, rollType);\n  }\n\n  /**\n   * Get display information for an activity\n   */\n  static getActivityDisplayInfo(activity) {\n    LogUtil.log('getActivityDisplayInfo', [activity]);\n    if (!activity) return null;\n\n    return {\n      name: activity.name || activity.constructor.metadata.label,\n      type: activity.type,\n      icon: activity.constructor.metadata.icon,\n      canAttack: activity.type === 'attack',\n      canDamage: ['attack', 'damage', 'save'].includes(activity.type),\n      canSave: activity.type === 'save'\n    };\n  }\n\n  /**\n   * Get damage formula string from an activity\n   */\n  static getDamageFormula(activity) {\n    LogUtil.log('getDamageFormula', [activity]);\n    if (!activity?.damage?.parts?.length) return null;\n\n    const formulas = activity.damage.parts.map(part => part.formula).filter(f => f);\n    return formulas.length > 0 ? formulas.join(' + ') : null;\n  }\n\n  // ========================================\n  // ROUTER METHODS (delegate to appropriate manager)\n  // ========================================\n\n  /**\n   * Execute a roll - routes to appropriate manager\n   */\n  static async executeActivityRoll(actor, rollType, itemId, activityId, config) {\n    LogUtil.log('BaseActivityManager.executeActivityRoll - routing', [this.isMidiActive ? 'Midi' : 'Vanilla']);\n\n    if (this.isMidiActive) {\n      return await MidiActivityManager.executeActivityRoll(actor, rollType, itemId, activityId, config);\n    } else {\n      return await VanillaActivityManager.executeActivityRoll(actor, rollType, itemId, activityId, config);\n    }\n  }\n\n  /**\n   * Handle pre-use activity hook on GM side\n   * Prevents usage message on GM side when sending activity requests for player-owned actors\n   */\n  static onPreUseActivityGM(activity, config, dialog, message) {\n    LogUtil.log(\"BaseActivityManager.onPreUseActivityGM #0\", [activity, config, dialog, message]);\n    const SETTINGS = getSettings();\n    const requestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const rollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n    if (!requestsEnabled || !rollInterceptionEnabled) return;\n\n    const actor = activity.actor;\n    const actorOwner = GeneralUtil.getActorOwner(actor);\n    const isPlayerActor = isPlayerOwned(actor) && actorOwner.active;\n    const isLocalRoll = !isPlayerActor || config.isRollRequest === false;\n\n    LogUtil.log(\"BaseActivityManager.onPreUseActivityGM - Roll determination\", {\n      isMidiActive: this.isMidiActive,\n      isPlayerActor,\n      isLocalRoll,\n      actorName: actor?.name,\n      ownerActive: actorOwner?.active,\n      isRollRequest: config.isRollRequest\n    });\n\n    if (isLocalRoll) {\n      LogUtil.log(\"BaseActivityManager.onPreUseActivityGM - Local roll, returning early to let normal D&D5e flow handle it\");\n      return;\n    }\n\n    activity.item.unsetFlag(MODULE_ID, 'tempAttackConfig');\n    activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n    activity.item.unsetFlag(MODULE_ID, 'tempSaveConfig');\n\n    if (!actor) return;\n    LogUtil.log(\"BaseActivityManager.onPreUseActivityGM #1\", [config, isLocalRoll]);\n\n    if (actorOwner && actorOwner.active && !actorOwner.isGM) {\n      config._originalConsume = structuredClone(config.consume || {});\n      config._originalCreate = structuredClone(config.create || {});\n    }\n\n    config.consume = getConsumptionConfig(config.consume || {}, isLocalRoll);\n    config.create = getCreateConfig(config.create || {}, isLocalRoll);\n\n    const isDnDBRoll = DnDBIntegration.hasPendingRoll();\n    if (actorOwner && !actorOwner.isGM && !isLocalRoll && !isDnDBRoll) {\n      if(this.isMidiActive){\n        LogUtil.log(\"BaseActivityManager.onPreUseActivityGM - Marking Midi message to suppress rendering for player-owned actor\", [actor.name]);\n        if (!message.data) message.data = {};\n        if (!message.data.flags) message.data.flags = {};\n        if (!message.data.flags[MODULE_ID]) message.data.flags[MODULE_ID] = {};\n        message.data.flags[MODULE_ID].preventRender = true;\n      } else {\n        const showConsumptionDialog = showConsumptionConfig();\n        dialog.configure = dialog.configure ? showConsumptionDialog : false;\n        message.create = false;\n      }\n    }\n\n  }\n\n  /**\n   * Handle post-use activity hook on GM side\n   * Triggers damage rolls for save activities and stores activity configuration for caching\n   */\n  static onPostUseActivityGM(activity, config, results) {\n    const SETTINGS = getSettings();\n    const requestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const rollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n    const actor = activity.actor;\n    const isDnDBRoll = config.create?._isDnDBRoll === true;\n\n    LogUtil.log(\"BaseActivityManager.onPostUseActivityGM #0\", [\n      \"activityType:\", activity.type,\n      \"isDnDBRoll:\", isDnDBRoll,\n      \"hasDamageParts:\", activity.damage?.parts?.length > 0,\n      \"requestsEnabled:\", requestsEnabled,\n      \"rollInterceptionEnabled:\", rollInterceptionEnabled,\n      \"actor:\", actor?.name\n    ]);\n\n    if (!requestsEnabled || !rollInterceptionEnabled || !actor) {\n      LogUtil.log(\"BaseActivityManager.onPostUseActivityGM - Early return (settings or no actor)\", [\n        \"requestsEnabled:\", requestsEnabled,\n        \"rollInterceptionEnabled:\", rollInterceptionEnabled,\n        \"hasActor:\", !!actor\n      ]);\n      if (isDnDBRoll && activity.type === ACTIVITY_TYPES.SAVE && activity.damage?.parts?.length > 0 && !this.isMidiActive) {\n        LogUtil.log(\"BaseActivityManager.onPostUseActivityGM - DnDB save damage bypassing settings check\");\n        this._handleDnDBSaveDamageRoll(activity, config);\n      }\n      return;\n    }\n\n    const actorOwner = GeneralUtil.getActorOwner(actor);\n    const isOwnerActive = actorOwner && actorOwner.active && actorOwner.id !== game.user.id;\n    const isLocalRoll = !isOwnerActive || config.isRollRequest===false;\n\n    LogUtil.log(\"BaseActivityManager.onPostUseActivityGM #1 \", [isLocalRoll, isOwnerActive, this.isMidiActive]);\n    if (this.isMidiActive && isLocalRoll) return;\n    const skipRollDialog = RollHelpers.shouldSkipRollDialog({\n      isPC: isOwnerActive,\n      isNPC: !isOwnerActive,\n      sendRequest: isOwnerActive\n    });\n    results.configure = config.skipRollDialog !== undefined ? !config.skipRollDialog : (isOwnerActive && !skipRollDialog);\n\n    LogUtil.log(\"BaseActivityManager.onPostUseActivityGM - skipRollDialog\", [skipRollDialog, config.skipRollDialog]);\n    if (config.skipRollDialog === false && (!actorOwner?.active || actorOwner.isGM)) {\n      LogUtil.log(\"BaseActivityManager.onPostUseActivityGM - Preventing usage message - no owning player for actor\", [activity.actor]);\n      return;\n    }\n\n    if (activity.item) {\n      const activityConfig = {\n        spell: config.spell || {},\n        scaling: config.scaling,\n        consume: config._originalConsume || config.consume || {},\n        create: config._originalCreate || config.create || {}\n      };\n\n      const cacheKey = activity.item.id;\n      const cacheEntry = {\n        config: activityConfig,\n        timestamp: Date.now()\n      };\n      HooksManager.activityConfigCache.set(cacheKey, cacheEntry);\n      LogUtil.log('BaseActivityManager.onPostUseActivityGM - storing activity config in cache', [cacheKey, activityConfig]);\n    }\n\n    // Manually trigger missing rolls for roll requests\n    if (!isLocalRoll) {\n      if (this.isMidiActive) {\n        MidiActivityManager.triggerMissingRolls(activity, config, results);\n      } else {\n        VanillaActivityManager.triggerMissingRolls(activity, config, results);\n      }\n    }\n\n    if (activity.type === ACTIVITY_TYPES.SAVE && activity.damage?.parts?.length > 0 && !this.isMidiActive && isLocalRoll) {\n      const isDnDBRoll = config.create?._isDnDBRoll === true;\n\n      if (isDnDBRoll) {\n        LogUtil.log(\"BaseActivityManager.onPostUseActivityGM - DnDB save damage roll detected\", [activity.item.name]);\n        this._handleDnDBSaveDamageRoll(activity, config);\n      } else {\n        LogUtil.log(\"BaseActivityManager.onPostUseActivityGM - triggering vanilla save damage roll for local roll\", [activity, config]);\n        const shouldShowDialog = config.skipRollDialog !== undefined ? !config.skipRollDialog : (isOwnerActive && !skipRollDialog);\n        activity.rollDamage(config, {\n          configure: shouldShowDialog\n        }, {});\n      }\n    }\n  }\n\n  /**\n   * Handle pre-use activity hook on player side\n   * Configures consumption and creation settings\n   */\n  static onPreUseActivityPlayer(activity, config, dialog, message) {\n    const SETTINGS = getSettings();\n    const requestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const rollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n    if (!requestsEnabled || !rollInterceptionEnabled) return;\n\n    LogUtil.log(\"BaseActivityManager.onPreUseActivityPlayer\", [activity, config, dialog, message]);\n\n    const actor = activity.actor;\n\n    activity.item.unsetFlag(MODULE_ID, 'tempAttackConfig');\n    activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n    activity.item.unsetFlag(MODULE_ID, 'tempSaveConfig');\n\n    if (!actor) return;\n\n    const showConsumptionDialog = showConsumptionConfig();\n    dialog.configure = dialog.configure ? showConsumptionDialog : false;\n\n    config.consume = getConsumptionConfig(config.consume || {}, true);\n    config.create = getCreateConfig(config.create || {}, true);\n\n    if (this.isMidiActive) {\n      MidiActivityManager.onPreUseActivityPlayer(activity, config, dialog, message);\n    }\n  }\n\n  /**\n   * Handle post-use activity hook on player side\n   * Configures Midi-QOL options and triggers save damage if needed\n   */\n  static onPostUseActivityPlayer(activity, config, results) {\n    const isDnDBRoll = config.create?._isDnDBRoll === true;\n    LogUtil.log(\"BaseActivityManager.onPostUseActivityPlayer\", [\n      \"activityType:\", activity.type,\n      \"isDnDBRoll:\", isDnDBRoll,\n      \"hasDamageParts:\", activity.damage?.parts?.length > 0,\n      \"damagePartsCount:\", activity.damage?.parts?.length,\n      \"isMidiActive:\", this.isMidiActive,\n      \"hasPendingDamageRoll:\", DnDBRollExecutor.hasPendingDamageRoll()\n    ]);\n\n    if (this.isMidiActive) {\n      MidiActivityManager.onPostUseActivityPlayer(activity, config, results);\n      return;\n    }\n\n    if (activity.type === ACTIVITY_TYPES.SAVE && activity.damage?.parts?.length > 0) {\n      if (isDnDBRoll) {\n        this._handleDnDBSaveDamageRoll(activity, config);\n      } else {\n        LogUtil.log(\"BaseActivityManager.onPostUseActivityPlayer - triggering vanilla save damage roll\", [activity, config]);\n        const shouldShowDialog = config.skipRollDialog !== undefined ? !config.skipRollDialog : true;\n        activity.rollDamage(config, {\n          configure: shouldShowDialog\n        }, {\n          create: true\n        });\n      }\n    }\n  }\n\n  /**\n   * Handle damage roll for DnDB save spells\n   * Calls rollDamage with create:false, injects DnDB dice values, and posts message with proper targets\n   * Note: This method is async but called from a sync hook - it handles its own promise chain\n   */\n  static _handleDnDBSaveDamageRoll(activity, config) {\n    LogUtil.log(\"BaseActivityManager._handleDnDBSaveDamageRoll - Entry\", [\n      \"activity:\", activity.item?.name,\n      \"hasPending:\", DnDBRollExecutor.hasPendingDamageRoll()\n    ]);\n\n    const pendingRollInfo = DnDBRollExecutor.consumePendingDamageRoll();\n    if (!pendingRollInfo) {\n      LogUtil.warn(\"BaseActivityManager._handleDnDBSaveDamageRoll - No pending DnDB roll found\");\n      return;\n    }\n\n    const ddbRoll = pendingRollInfo.rawRolls?.[0];\n    if (!ddbRoll) {\n      LogUtil.warn(\"BaseActivityManager._handleDnDBSaveDamageRoll - No raw roll data found\");\n      return;\n    }\n\n    LogUtil.log(\"BaseActivityManager._handleDnDBSaveDamageRoll - Processing DnDB damage\", [\n      \"item:\", activity.item.name,\n      \"ddbRollAction:\", pendingRollInfo.action\n    ]);\n\n    const rollConfig = { sendRequest: false };\n    const dialogConfig = { configure: false };\n    const messageConfig = { create: false };\n\n    activity.rollDamage(rollConfig, dialogConfig, messageConfig).then(rolls => {\n      if (!rolls?.length) {\n        LogUtil.warn(\"BaseActivityManager._handleDnDBSaveDamageRoll - rollDamage returned no rolls\");\n        return;\n      }\n\n      DnDBRollUtil.injectDnDBDiceValues(rolls[0], ddbRoll);\n\n      const targets = getTargetDescriptors();\n      const actor = activity.actor;\n      const owner = getPlayerOwner(actor) || game.user;\n      const rollMode = game.settings.get(\"core\", \"rollMode\");\n\n      LogUtil.log(\"BaseActivityManager._handleDnDBSaveDamageRoll - Creating message\", [\"targets:\", targets.length]);\n\n      const messageConfig = {\n        speaker: ChatMessage.getSpeaker({ actor }),\n        author: owner.id,\n        flavor: `${activity.item.name} - ${activity.damageFlavor}`,\n        flags: {\n          [MODULE_ID]: {\n            isDnDBRoll: true,\n            ddbCharacterId: pendingRollInfo.characterId,\n            ddbSource: pendingRollInfo.source,\n            rollType: pendingRollInfo.rollType,\n            action: pendingRollInfo.action\n          },\n          dnd5e: {\n            ...activity.messageFlags,\n            messageType: \"roll\",\n            roll: { type: \"damage\", damageOnSave: activity.damage?.onSave },\n            targets: targets\n          },\n          rsr5e: { processed: true, quickRoll: false }\n        }\n      };\n\n      rolls[0].toMessage(messageConfig, { rollMode }).then(() => {\n        LogUtil.log(\"BaseActivityManager._handleDnDBSaveDamageRoll - Damage message created\");\n        DnDBRollExecutor.clearDnDBDamageInProgress();\n      });\n    }).catch(err => {\n      LogUtil.error(\"BaseActivityManager._handleDnDBSaveDamageRoll - Error\", [err]);\n      DnDBRollExecutor.clearDnDBDamageInProgress();\n    });\n  }\n}\n","import { MODULE } from \"../../../constants/General.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\";\n\n/**\n * Custom Roll Dialog - ApplicationV2 component for custom roll formulas\n */\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\nexport class CustomRollDialog extends HandlebarsApplicationMixin(ApplicationV2) {\n  constructor(options = {}) {\n    super(options);\n    this.formula = options.formula || \"\";\n    this.readonly = options.readonly || false;\n    this.actor = options.actor;\n    this.callback = options.callback;\n    this.diceCounts = {};\n    this.rollMode = options.rollMode || game.settings.get(\"core\", \"rollMode\");\n  }\n\n  /**\n   * Default application configuration\n   */\n  static get DEFAULT_OPTIONS() {\n    return foundry.utils.mergeObject(super.DEFAULT_OPTIONS, {\n      classes: [\"flash5e-dialog\", \"flash5e-custom-roll-dialog\"],\n      tag: \"div\",\n      window: {\n        title: \"FLASH_ROLLS.ui.dialogs.customRollTitle\",\n        icon: \"fas fa-dice-d20\",\n        resizable: false,\n        positioned: true,\n        frame: true\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      }\n    });\n  }\n  \n  /**\n   * Override to provide unique ID per actor\n   */\n  get id() {\n    return `flash5e-custom-roll-dialog-${this.actor?.id || 'unknown'}`;\n  }\n  \n  /**\n   * Override to provide unique title per actor\n   */\n  get title() {\n    const baseTitle = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.customRollTitle\");\n    if (this.actor) {\n      return `${baseTitle} - ${this.actor.name}`;\n    }\n    return baseTitle;\n  }\n  \n  /**\n   * Override to handle action clicks\n   */\n  _onClickAction(event, target) {\n    const action = target.dataset.action;\n    switch (action) {\n      case \"rollDice\":\n        return this.rollDice(event, target);\n      case \"addDie\":\n        return this.addDie(event, target);\n      case \"cancel\":\n        return this.cancel(event, target);\n    }\n  }\n\n  /**\n   * Prepare application rendering context\n   */\n  async _prepareContext(options = {}) {\n    const context = await super._prepareContext(options);\n    const rollModes = Object.entries(CONFIG.Dice.rollModes).map(([value, label]) => ({\n      value,\n      labelKey: typeof label === 'string' ? label : (label?.label || label?.name || value),\n      selected: value === this.rollMode\n    }));\n    return {\n      ...context,\n      formula: this.formula,\n      readonly: this.readonly,\n      rollMode: this.rollMode,\n      rollModes\n    };\n  }\n\n  /**\n   * Define template parts\n   */\n  static PARTS = {\n    main: {\n      template: `modules/${MODULE.ID}/templates/custom-roll-dialog.hbs`\n    },\n    footer: {\n      template: `modules/${MODULE.ID}/templates/custom-roll-dialog-footer.hbs`\n    }\n  };\n\n  /**\n   * Add event listeners\n   */\n  _attachPartListeners(partId, htmlElement, options) {\n    super._attachPartListeners(partId, htmlElement, options);\n\n    const formulaInput = htmlElement.querySelector('#custom-roll-formula');\n    const validationMessage = htmlElement.querySelector('#formula-validation-message');\n    const rollModeSelect = htmlElement.querySelector('#custom-roll-mode');\n\n    if (formulaInput && !this.readonly) {\n      formulaInput.addEventListener('input', (event) => {\n        this.formula = event.target.value.trim();\n        this.updateValidationMessage(validationMessage);\n      });\n\n      if (this.formula) {\n        this.updateValidationMessage(validationMessage);\n      }\n    }\n\n    if (rollModeSelect) {\n      rollModeSelect.addEventListener('change', (event) => {\n        this.rollMode = event.target.value;\n      });\n    }\n  }\n  \n  /**\n   * Update the validation message based on formula validity\n   * @param {HTMLElement} messageElement - The validation message element\n   */\n  updateValidationMessage(messageElement) {\n    if (!messageElement) return;\n    \n    if (!this.formula) {\n      messageElement.textContent = '&nbsp;';\n      messageElement.classList.remove('error', 'success');\n      return;\n    }\n    \n    const isValid = this.validateFormula(this.formula);\n    \n    if (isValid) {\n      messageElement.textContent = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.formulaValid\");\n      messageElement.classList.remove('error');\n      messageElement.classList.add('success');\n    } else {\n      messageElement.textContent = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.formulaInvalid\");\n      messageElement.classList.remove('success');\n      messageElement.classList.add('error');\n    }\n  }\n\n  /**\n   * Handle dice button click\n   * @param {Event} event\n   * @param {HTMLElement} target\n   */\n  addDie(event, target) {\n    const die = target.dataset.die;\n    \n    const formulaInput = this.element.querySelector('#custom-roll-formula');\n    if (!formulaInput) return;\n    \n    const currentFormula = formulaInput.value.trim();\n    \n    if (currentFormula) {\n      const diceRegex = /(\\d*)d(\\d+)/g;\n      const diceMap = new Map();\n      \n      let remainingFormula = currentFormula;\n      let match;\n      \n      while ((match = diceRegex.exec(currentFormula)) !== null) {\n        const count = parseInt(match[1] || '1');\n        const dieType = match[2];\n        diceMap.set(dieType, (diceMap.get(dieType) || 0) + count);\n        remainingFormula = remainingFormula.replace(match[0], '').trim();\n      }\n      \n      const newDieType = die.substring(1); // Remove 'd' prefix\n      diceMap.set(newDieType, (diceMap.get(newDieType) || 0) + 1);\n      \n      const diceParts = [];\n      for (const [dieType, count] of diceMap) {\n        diceParts.push(`${count}d${dieType}`);\n      }\n      \n      remainingFormula = remainingFormula.replace(/^\\+\\s*|\\s*\\+\\s*$|\\s*\\+\\s*\\+/g, '').trim();\n      \n      if (remainingFormula && remainingFormula !== '+') {\n        this.formula = `${diceParts.join(' + ')} + ${remainingFormula}`;\n      } else {\n        this.formula = diceParts.join(' + ');\n      }\n    } else {\n      this.formula = `1${die}`;\n    }\n    formulaInput.value = this.formula;\n    \n    formulaInput.dispatchEvent(new Event('input'));\n  }\n\n  /**\n   * Validate the formula using Roll.validate\n   * @param {string} formula\n   * @returns {boolean}\n   */\n  validateFormula(formula) {\n    if (!formula || formula.trim() === \"\") return false;\n    \n    try {\n      return Roll.validate(formula);\n    } catch (error) {\n      try {\n        new Roll(formula, this.actor?.getRollData() || {});\n        return true;\n      } catch (e) {\n        return false;\n      }\n    }\n  }\n\n  /**\n   * Handle roll button click\n   */\n  async rollDice() {\n    LogUtil.log('rollDice');\n    if (!this.validateFormula(this.formula)) {\n      ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.notifications.invalidFormula\", {\n        formula: this.formula || \"empty\"\n      }));\n      return;\n    }\n\n    if (this.callback) {\n      await this.callback({ formula: this.formula, rollMode: this.rollMode });\n    }\n\n    this.close();\n  }\n\n  /**\n   * Handle cancel button click\n   */\n  cancel() {\n    this.close();\n  }\n\n  /**\n   * Show the dialog and return a promise for the result\n   * @param {Object} options\n   * @param {string} [options.formula] - Initial formula value\n   * @param {boolean} [options.readonly] - Whether the formula is readonly\n   * @param {string} [options.rollMode] - Initial roll mode\n   * @returns {Promise<{formula: string, rollMode: string}|null>} Result object or null if cancelled\n   */\n  static async prompt(options = {}) {\n    return new Promise((resolve) => {\n      const dialog = new this({\n        ...options,\n        callback: (result) => resolve(result)\n      });\n\n      dialog.addEventListener(\"close\", () => {\n        if (!dialog._resolved) {\n          resolve(null);\n        }\n      });\n\n      dialog.render(true);\n    });\n  }\n\n  /**\n   * Override close to track resolution\n   */\n  async close(options = {}) {\n    this._resolved = true;\n    return super.close(options);\n  }\n}","import { MODULE_ID, ROLL_TYPES } from \"../../constants/General.mjs\";\nimport { getRollTypeDisplay, applyTargetTokens, NotificationManager } from \"../helpers/Helpers.mjs\";\nimport { RollHandlers } from \"../handlers/RollHandlers.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../helpers/RollHelpers.mjs\";\nimport { DiceConfigUtil } from \"../utils/DiceConfigUtil.mjs\";\nimport { ModuleHelpers } from \"../helpers/ModuleHelpers.mjs\";\n\n/**\n * @typedef {Object} RollRequestData\n * @property {string} type - \"rollRequest\"\n * @property {string} requestId - Unique identifier for this request\n * @property {string} actorId - ID of the actor to roll for\n * @property {string} rollType - Type of roll (ability, save, skill, etc.) from ROLL_TYPES\n * @property {string} rollKey - Specific roll key (e.g., \"str\", \"acr\", \"perception\")\n * @property {string|null} activityId - Activity ID for item-based rolls\n * @property {BasicRollProcessConfiguration} rollProcessConfig - D&D5e roll process configuration\n * @property {boolean} skipRollDialog - Whether to skip the roll configuration dialog\n * @property {string[]} targetTokenIds - Array of targeted token IDs\n * @property {boolean} preserveTargets - Whether to apply GM's targets to the player\n */\n\n/**\n * Handles roll requests from GM to players\n */\nexport class RollRequestManager {\n  /**\n   * Queue for managing roll requests per user\n   * @type {Array<{actor: Actor, requestData: RollRequestData}>}\n   */\n  static rollQueue = [];\n\n  /**\n   * Flag indicating if a roll dialog is currently active\n   * @type {boolean}\n   */\n  static isProcessingRoll = false;\n\n  /**\n   * Resolver function for the current pending roll\n   * @type {Function|null}\n   */\n  static pendingRollResolver = null;\n\n  /**\n   * Actor ID for the current pending roll\n   * @type {string|null}\n   */\n  static pendingRollActorId = null;\n\n  /**\n   * Map of pending auto-roll timeouts by actor unique ID\n   * @type {Map<string, {timeoutId: number, requestData: RollRequestData}>}\n   */\n  static pendingAutoRollTimeouts = new Map();\n\n  /**\n   * Set of actor unique IDs that have been auto-rolled (timeout fired)\n   * Used to prevent duplicate rolls when original dialog is closed\n   * @type {Set<string>}\n   */\n  static autoRolledActors = new Set();\n\n  /**\n   * Handle roll request from GM on player side\n   * @param {RollRequestData} requestData - The roll request data\n   */\n  static async handleRequest(requestData) {\n    const isMidiRequest = GeneralUtil.isModuleOn('midi-qol');\n    LogUtil.log('handleRequest', [requestData]);\n    if (game.user.isGM) return;\n    \n    let actor;\n    if (requestData.isTokenActor) {\n      const tokenDoc = game.scenes.active?.tokens.get(requestData.actorId);\n      actor = tokenDoc?.actor;\n      if (!actor) {\n        LogUtil.warn('Token actor not found:', requestData.actorId);\n        return;\n      }\n    } else {\n      actor = game.actors.get(requestData.actorId);\n    }\n    \n    if (!actor || !actor.isOwner) {\n      return;\n    }\n    \n    if (requestData.preserveTargets && \n      requestData.targetTokenIds?.length > 0 \n      // && game.user.targets.size === 0\n    ) {\n      LogUtil.log('handleRequest - applyTargetTokens', [requestData]);\n      applyTargetTokens(requestData.targetTokenIds);\n    }\n\n    if(isMidiRequest && requestData.rollProcessConfig.midiOptions){\n      requestData.rollProcessConfig.midiOptions = {\n        ...requestData.rollProcessConfig.midiOptions,\n        fastForward: false,\n        fastForwardAttack: false,\n        // autoRollDamage: 'onHit',\n        dialogOptions: {\n          ...requestData.rollProcessConfig.midiOptions.dialogOptions,\n          fastForward: false,\n          fastForwardAttack: false,\n        },\n        workflowOptions: {\n          ...requestData.rollProcessConfig.midiOptions.workflowOptions,\n          fastForward: false,\n          fastForwardAttack: false,\n        }\n      };\n    }\n    \n    NotificationManager.notify('info', '', {\n      batch: true,\n      batchData: {\n        actor: actor.name,\n        rollType: requestData.rollType,\n        rollKey: requestData.rollKey,\n        gm: requestData.rollProcessConfig._requestedBy || 'GM'\n      }\n    });\n    \n    this.rollQueue.push({ actor, requestData });\n\n    if (!this.isProcessingRoll) {\n      this.isProcessingRoll = true;\n      this.processNextRoll();\n    }\n  }\n  \n  /**\n   * Process the next roll in the queue to be executed on the player side\n   */\n  static async processNextRoll() {\n    LogUtil.log('processNextRoll - called', [this.rollQueue.length, 'in queue', this.isProcessingRoll]);\n\n    if (this.rollQueue.length === 0) {\n      this.isProcessingRoll = false;\n      LogUtil.log('processNextRoll - queue empty, stopping');\n      return;\n    }\n\n    const { actor, requestData } = this.rollQueue.shift();\n\n    LogUtil.log('processNextRoll - Processing', [actor.name, requestData.rollType, this.rollQueue.length, 'remaining']);\n\n    const normalizedRollType = requestData.rollType?.toLowerCase();\n    const isNoWaitRoll = normalizedRollType === ROLL_TYPES.DAMAGE ||\n                         normalizedRollType === ROLL_TYPES.ATTACK ||\n                         normalizedRollType === ROLL_TYPES.ITEM;\n\n    if (isNoWaitRoll) {\n      this.executePlayerRollRequest(actor, requestData).catch(error => {\n        LogUtil.error('Error processing roll request:', [error]);\n      });\n      this.processNextRoll();\n      return;\n    }\n\n    try {\n      await this.executePlayerRollRequest(actor, requestData);\n    } catch (error) {\n      LogUtil.error('Error processing roll request:', [error]);\n    }\n\n    this.processNextRoll();\n  }\n\n  /**\n   * Called when a roll message is created to signal roll completion\n   * @param {string} [actorUniqueId] - Optional actor unique ID to cancel auto-roll timeout\n   */\n  static onRollCompleted(actorUniqueId) {\n    if (this.pendingRollResolver) {\n      this.pendingRollResolver();\n      this.pendingRollResolver = null;\n      this.pendingRollActorId = null;\n    }\n    if (actorUniqueId) {\n      this.cancelAutoRollTimeout(actorUniqueId);\n    }\n  }\n  \n  /**\n   * Execute a roll request received by a player\n   * @param {Actor} actor - The actor performing the roll\n   * @param {RollRequestData} requestData - The roll request data from GM\n   */\n  static async executePlayerRollRequest(actor, requestData) {\n    const SETTINGS = getSettings();\n    const publicPlayerRolls = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag);\n\n    try {\n      const normalizedRollType = requestData.rollType?.toLowerCase();\n      LogUtil.log('executePlayerRollRequest - normalized roll type', [normalizedRollType]);\n\n      const showRequestPrompt = SettingsUtil.get(SETTINGS.showRequestPrompt.tag);\n      const isActivityRoll = [ROLL_TYPES.ATTACK, ROLL_TYPES.DAMAGE, ROLL_TYPES.ITEM].includes(normalizedRollType);\n\n      if (!showRequestPrompt && !game.user.isGM) {\n        if (isActivityRoll) {\n          LogUtil.log('executePlayerRollRequest - Activity roll with showRequestPrompt disabled, showing item card only', [actor.name, normalizedRollType]);\n          await this.showItemCardOnly(actor, requestData);\n          return;\n        }\n\n        LogUtil.log('executePlayerRollRequest - Skipping prompt (showRequestPrompt disabled)', [actor.name]);\n        if (requestData.groupRollId) {\n          await actor.setFlag(MODULE_ID, 'tempGroupRollId', requestData.groupRollId);\n          if (actor.isToken && actor.actor) {\n            await actor.actor.setFlag(MODULE_ID, 'tempGroupRollId', requestData.groupRollId);\n          }\n          LogUtil.log('executePlayerRollRequest - Set tempGroupRollId for manual roll interception', [requestData.groupRollId, actor.name]);\n        }\n\n        const actorUniqueId = requestData.isTokenActor ? requestData.actorId : actor.id;\n        const timeoutSeconds = this.getMidiPlayerSaveTimeout();\n        const hasWorkflow = requestData.fromMidiWorkflow || requestData.rollProcessConfig?.midiOptions?.workflowId;\n        if (normalizedRollType === ROLL_TYPES.SAVE && timeoutSeconds > 0 && hasWorkflow) {\n          LogUtil.log('executePlayerRollRequest - Setting up auto-roll for showRequestPrompt disabled', [actor.name, timeoutSeconds]);\n          const rollConfig = requestData.rollProcessConfig.rolls?.[0] || { parts: [], data: {}, options: {} };\n          const rollModeFromGM = requestData.rollProcessConfig.rollMode;\n          const defaultRollMode = game.settings.get(\"core\", \"rollMode\");\n          const finalRollMode = rollModeFromGM || defaultRollMode;\n          const rollMetadata = {\n            [MODULE_ID]: {\n              isFlashRollRequest: true,\n              rollType: requestData.rollType,\n              rollKey: requestData.rollKey,\n              actorUniqueId: actorUniqueId,\n              fromMidiWorkflow: requestData.fromMidiWorkflow || false\n            }\n          };\n          const speaker = ChatMessage.getSpeaker({ actor });\n          const messageConfig = {\n            rollMode: finalRollMode,\n            create: requestData.rollProcessConfig.chatMessage !== false,\n            flags: rollMetadata,\n            data: { speaker },\n            messageData: { speaker, flags: rollMetadata }\n          };\n          const handlerRequestData = {\n            rollKey: requestData.rollKey,\n            activityId: requestData.activityId,\n            config: requestData.rollProcessConfig,\n            groupRollId: requestData.groupRollId\n          };\n          this.setupAutoRollTimeout(actor, requestData, actorUniqueId, handlerRequestData, rollConfig, messageConfig);\n        }\n        return;\n      }\n\n      const rollConfig = requestData.rollProcessConfig.rolls?.[0] || {\n        parts: [],\n        data: {},\n        options: {}\n      };\n\n      const skipToRollResolver = SettingsUtil.get(SETTINGS.skipToRollResolver.tag);\n      const hasNonDigitalDice = skipToRollResolver && DiceConfigUtil.hasNonDigitalDice();\n\n      const dialogConfig = {\n        configure: !hasNonDigitalDice\n      };\n\n      const rollModeFromGM = requestData.rollProcessConfig.rollMode;\n      const defaultRollMode = game.settings.get(\"core\", \"rollMode\");\n      const finalRollMode = rollModeFromGM || defaultRollMode;\n\n      const actorUniqueId = requestData.isTokenActor ? requestData.actorId : actor.id;\n      const rollMetadata = {\n        [MODULE_ID]: {\n          isFlashRollRequest: true,\n          rollType: requestData.rollType,\n          rollKey: requestData.rollKey,\n          actorUniqueId: actorUniqueId,\n          fromMidiWorkflow: requestData.fromMidiWorkflow || false\n        }\n      };\n\n      const speaker = ChatMessage.getSpeaker({ actor });\n      const messageConfig = {\n        rollMode: finalRollMode,\n        create: requestData.rollProcessConfig.chatMessage !== false,\n        flags: rollMetadata,\n        data: {\n          speaker\n        },\n        messageData: {\n          speaker,\n          flags: rollMetadata\n        }\n      };\n\n      const handlerRequestData = {\n        rollKey: requestData.rollKey,\n        activityId: requestData.activityId,\n        config: requestData.rollProcessConfig,\n        groupRollId: requestData.groupRollId\n      };\n\n      const handler = RollHandlers[normalizedRollType];\n\n      if (handler) {\n        LogUtil.log('executePlayerRollRequest - calling handler', [normalizedRollType, 'dialogConfig.configure:', dialogConfig.configure]);\n        this.setupAutoRollTimeout(actor, requestData, actorUniqueId, handlerRequestData, rollConfig, messageConfig);\n        await handler(actor, handlerRequestData, rollConfig, dialogConfig, messageConfig);\n        this.cancelAutoRollTimeout(actorUniqueId);\n        LogUtil.log('executePlayerRollRequest - handler completed', [normalizedRollType]);\n      } else {\n        LogUtil.warn(`No handler found for roll type: ${normalizedRollType}`);\n        NotificationManager.notify('warn', game.i18n.format('FLASH_ROLLS.notifications.rollError', {\n          actor: actor.name || 'Unknown Actor'\n        }));\n      }\n    } catch (error) {\n      LogUtil.error('Error executing roll request:', [error]);\n      NotificationManager.notify('error', game.i18n.format('FLASH_ROLLS.notifications.rollError', {\n        actor: actor.name || 'Unknown Actor'\n      }));\n    }\n  }\n\n  /**\n   * Get the midi-qol player save timeout setting in seconds\n   * Only returns a value if midi-qol is configured to use Flash Token Bar for saves\n   * @returns {number} - The timeout in seconds, or 0 if not applicable\n   */\n  static getMidiPlayerSaveTimeout() {\n    const MidiQOL = ModuleHelpers.getMidiQOL();\n    if (!MidiQOL?.currentConfigSettings) {\n      LogUtil.log('getMidiPlayerSaveTimeout - no MidiQOL config', [!!MidiQOL]);\n      return 0;\n    }\n\n    const playerRollSaves = MidiQOL.currentConfigSettings.playerRollSaves;\n    const timeout = MidiQOL.currentConfigSettings.playerSaveTimeout;\n    LogUtil.log('getMidiPlayerSaveTimeout - midi settings', [playerRollSaves, timeout]);\n\n    if (playerRollSaves !== 'ftb') return 0;\n\n    return timeout || 0;\n  }\n\n  /**\n   * Set up auto-roll timeout for midi-qol integration\n   * If playerSaveTimeout is > 0 and roll is a save, will auto-trigger after timeout\n   * @param {Actor} actor - The actor\n   * @param {RollRequestData} requestData - The roll request data\n   * @param {string} actorUniqueId - Unique identifier for the actor\n   * @param {Object} handlerRequestData - Handler request data\n   * @param {Object} rollConfig - Roll configuration\n   * @param {Object} messageConfig - Message configuration\n   */\n  static setupAutoRollTimeout(actor, requestData, actorUniqueId, handlerRequestData, rollConfig, messageConfig) {\n    const normalizedRollType = requestData.rollType?.toLowerCase();\n    LogUtil.log('setupAutoRollTimeout - checking', [normalizedRollType, ROLL_TYPES.SAVE, normalizedRollType === ROLL_TYPES.SAVE]);\n    if (normalizedRollType !== ROLL_TYPES.SAVE) return;\n\n    const hasWorkflow = requestData.fromMidiWorkflow || requestData.rollProcessConfig?.midiOptions?.workflowId;\n    LogUtil.log('setupAutoRollTimeout - workflow check', [hasWorkflow, requestData.fromMidiWorkflow, requestData.rollProcessConfig?.midiOptions?.workflowId]);\n    if (!hasWorkflow) return;\n\n    const timeoutSeconds = this.getMidiPlayerSaveTimeout();\n    LogUtil.log('setupAutoRollTimeout - timeout value', [timeoutSeconds]);\n    if (timeoutSeconds <= 0) return;\n\n    const handler = RollHandlers[normalizedRollType];\n    if (!handler) return;\n\n    LogUtil.log('setupAutoRollTimeout - Setting up auto-roll', [actor.name, timeoutSeconds, 'seconds']);\n\n    const timeoutId = setTimeout(async () => {\n      if (!this.pendingAutoRollTimeouts.has(actorUniqueId)) {\n        LogUtil.log('setupAutoRollTimeout - Timeout cancelled (roll already completed)', [actor.name]);\n        return;\n      }\n\n      LogUtil.log('setupAutoRollTimeout - Auto-rolling after timeout', [actor.name, timeoutSeconds]);\n      this.pendingAutoRollTimeouts.delete(actorUniqueId);\n      this.autoRolledActors.add(actorUniqueId);\n\n      NotificationManager.notify('info', game.i18n.format('FLASH_ROLLS.notifications.autoRollTimeout', {\n        actor: actor.name\n      }));\n\n      const autoRollDialogConfig = { configure: false };\n\n      try {\n        await handler(actor, handlerRequestData, rollConfig, autoRollDialogConfig, messageConfig);\n        LogUtil.log('setupAutoRollTimeout - Auto-roll completed', [actor.name]);\n      } catch (error) {\n        LogUtil.error('setupAutoRollTimeout - Auto-roll error', [error]);\n      } finally {\n        this.autoRolledActors.delete(actorUniqueId);\n      }\n    }, timeoutSeconds * 1000);\n\n    this.pendingAutoRollTimeouts.set(actorUniqueId, { timeoutId, requestData });\n  }\n\n  /**\n   * Cancel pending auto-roll timeout for an actor\n   * Called when a roll is completed manually before timeout expires\n   * @param {string} actorUniqueId - Unique identifier for the actor\n   */\n  static cancelAutoRollTimeout(actorUniqueId) {\n    const pending = this.pendingAutoRollTimeouts.get(actorUniqueId);\n    if (pending) {\n      LogUtil.log('cancelAutoRollTimeout - Cancelling timeout', [actorUniqueId]);\n      clearTimeout(pending.timeoutId);\n      this.pendingAutoRollTimeouts.delete(actorUniqueId);\n    }\n  }\n\n  /**\n   * Check if an actor was auto-rolled due to timeout\n   * @param {string} actorUniqueId - Unique identifier for the actor\n   * @returns {boolean} - True if the actor was auto-rolled\n   */\n  static wasAutoRolled(actorUniqueId) {\n    return this.autoRolledActors.has(actorUniqueId);\n  }\n\n  /**\n   * Show item card without executing any rolls\n   * Used when showRequestPrompt is disabled for activity rolls\n   * @param {Actor} actor - The actor\n   * @param {RollRequestData} requestData - The roll request data\n   */\n  static async showItemCardOnly(actor, requestData) {\n    const item = actor.items.get(requestData.rollKey);\n    if (!item) {\n      LogUtil.warn('showItemCardOnly - Item not found', [requestData.rollKey]);\n      return;\n    }\n\n    const activity = requestData.activityId\n      ? item.system.activities?.get(requestData.activityId)\n      : item.system.activities?.contents?.[0];\n\n    if (!activity) {\n      LogUtil.warn('showItemCardOnly - Activity not found', [item.name, requestData.activityId]);\n      return;\n    }\n\n    LogUtil.log('showItemCardOnly - Displaying item card', [item.name, activity.name]);\n\n    await activity.use({\n      consume: { resources: false, spellSlot: false, action: false },\n      create: { measuredTemplate: false }\n    }, {\n      configure: false\n    }, {\n      create: true\n    });\n  }\n}","import { HOOKS_CORE } from \"../../constants/Hooks.mjs\";\nimport { MODULE_ID, ROLL_TYPES, SOCKET_CALLS } from \"../../constants/General.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\nimport { FlashAPI } from \"../core/FlashAPI.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { RollHelpers } from \"../helpers/RollHelpers.mjs\";\nimport { RollHandlers } from \"../handlers/RollHandlers.mjs\";\nimport { HooksManager } from \"../core/HooksManager.mjs\";\nimport { RollRequestManager } from \"./RollRequestManager.mjs\";\nimport { SocketUtil } from \"../utils/SocketUtil.mjs\";\n\n/**\n * Utility class for managing group roll chat messages\n */\nexport class ChatMessageManager {\n  /**\n   * Map of requestId to chat message document\n   * @type {Map<string, ChatMessage>}\n   */\n  static groupRollMessages = new Map();\n  \n  /**\n   * Map of requestId to pending roll data\n   * @type {Map<string, Object>}\n   */\n  static pendingRolls = new Map();\n  \n  /**\n   * Set of message IDs that are scheduled for deletion\n   * @type {Set<string>}\n   */\n  static messagesScheduledForDeletion = new Set();\n  \n  /**\n   * Queue for serializing group message updates\n   * @type {Map<string, Promise>}\n   */\n  static updateQueue = new Map();\n  \n  /**\n   * Path to the group roll template\n   * @type {string}\n   */\n  static templatePath = 'modules/flash-rolls-5e/templates/chat-msg-group-roll.hbs';\n  \n  /**\n   * Initialize the ChatMessageManager\n   */\n  static async initialize() {\n    LogUtil.log('ChatMessageManager.initialize');\n    await this.preloadTemplate();\n  }\n\n  /**\n   * Handle chat message creation for debugging purposes\n   * @param {ChatMessage} message - The created message\n   * @param {Object} options - Creation options\n   * @param {string} userId - ID of the user who created the message\n   */\n  static onCreateChatMessage(message, options, userId, data) {\n    LogUtil.log('ChatMessageManager.onCreateChatMessage', [message, options, userId, data]);\n  }\n\n  /**\n   * Handle pre-create chat message to add group roll flags and requested-by flavor\n   * @param {ChatMessage} message - The message being created\n   * @param {Object} data - Message data\n   * @param {Object} options - Creation options\n   * @param {string} userId - ID of the creating user\n   */\n  static onPreCreateChatMessage(message, data, options, userId) {\n    LogUtil.log('ChatMessageManager.onPreCreateChatMessage', [message, data, options, userId]);\n\n    if (data._showRequestedBy && data.rolls?.length > 0) {\n      const requestedBy = data._requestedBy || 'GM';\n      const requestedText = game.i18n.format('FLASH_ROLLS.chat.requestedBy', { gm: requestedBy });\n\n      const currentFlavor = data.flavor || '';\n      data.flavor = currentFlavor ? `${currentFlavor} ${requestedText}` : requestedText;\n    }\n\n    if (data.flags?.[MODULE_ID]?.groupRollId) {\n      LogUtil.log('ChatMessageManager.onPreCreateChatMessage - Found groupRollId in data flags', [data]);\n    }\n\n    if (data.rolls?.length > 0 || data.flags?.core?.initiativeRoll) {\n      const speaker = data.speaker;\n      const actorId = speaker?.actor;\n\n      if (actorId) {\n        let actor = game.actors.get(actorId);\n\n        if (!actor && speaker?.token) {\n          const token = canvas.tokens.get(speaker.token);\n          if (token?.actor) {\n            actor = token.actor;\n            LogUtil.log('ChatMessageManager.onPreCreateChatMessage - Using token actor from speaker', [actor.name, actor.id]);\n          }\n        }\n\n        if (!actor) {\n          LogUtil.log('ChatMessageManager.onPreCreateChatMessage - No actor found', [actorId, speaker]);\n          return;\n        }\n\n        if (game.user.isGM) {\n          const baseActorId = actor.isToken ? actor.actor?.id : actor.id;\n          const checkIds = [actorId, baseActorId].filter(id => id);\n\n          for (const [groupRollId, pendingData] of ChatMessageManager.pendingRolls.entries()) {\n            const actorEntries = pendingData.actorEntries || (pendingData.actors ? pendingData.actors.map(id => ({ actorId: id })) : []);\n            if (checkIds.some(id => actorEntries.some(entry => entry.actorId === id))) {\n              data.flags = data.flags || {};\n              data.flags[MODULE_ID] = data.flags[MODULE_ID] || {};\n              data.flags[MODULE_ID].groupRollId = groupRollId;\n              data.flags.rsr5e = { processed: true, quickRoll: false};\n              LogUtil.log('ChatMessageManager.onPreCreateChatMessage - Added groupRollId flag (GM)', [groupRollId, actorId]);\n              break;\n            }\n          }\n        } else {\n          let storedGroupRollId = actor.getFlag(MODULE_ID, 'tempGroupRollId');\n          LogUtil.log('ChatMessageManager.onPreCreateChatMessage - Player side check', [actor.name, 'storedGroupRollId:', storedGroupRollId, 'isToken:', actor.isToken]);\n          if (!storedGroupRollId && actor.isToken) {\n            const baseActor = game.actors.get(actor.actor?.id);\n            if (baseActor) {\n              storedGroupRollId = baseActor.getFlag(MODULE_ID, 'tempGroupRollId');\n              LogUtil.log('ChatMessageManager.onPreCreateChatMessage - Checking base actor for tempGroupRollId', [baseActor.id, storedGroupRollId]);\n            }\n          }\n\n          let storedInitConfig = actor.getFlag(MODULE_ID, 'tempInitiativeConfig');\n\n          if (!storedInitConfig && actor.isToken) {\n            const baseActor = game.actors.get(actor.actor?.id);\n            if (baseActor) {\n              storedInitConfig = baseActor.getFlag(MODULE_ID, 'tempInitiativeConfig');\n            }\n          }\n\n          if (storedInitConfig?.groupRollId || storedGroupRollId) {\n            data.flags = data.flags || {};\n            data.flags[MODULE_ID] = data.flags[MODULE_ID] || {};\n            data.flags[MODULE_ID].groupRollId = storedGroupRollId || storedInitConfig?.groupRollId || '';\n            data.flags.rsr5e = { processed: true, quickRoll: false};\n\n            if (storedGroupRollId) {\n              actor.unsetFlag(MODULE_ID, 'tempGroupRollId');\n              if (actor.isToken) {\n                const baseActor = game.actors.get(actor.actor?.id);\n                if (baseActor) {\n                  baseActor.unsetFlag(MODULE_ID, 'tempGroupRollId');\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n\n    if (data.rolls?.length > 0 && data.rolls[0]) {\n      try {\n        const rollData = data.rolls[0];\n        if (rollData.options?._customFlavor) {\n          data.flavor = rollData.options._customFlavor;\n        }\n      } catch (error) {\n        LogUtil.error(\"ChatMessageManager.onPreCreateChatMessage - flavor error\", [error]);\n      }\n    }\n\n    if (!game.user.isGM && data.rolls?.length > 0 && RollRequestManager.pendingRollResolver) {\n      RollRequestManager.onRollCompleted();\n    }\n  }\n\n  /**\n   * Handle rendering of chat messages to process group rolls and add UI elements\n   * @param {ChatMessage} message - The message being rendered\n   * @param {HTMLElement} html - The rendered HTML\n   * @param {Object} context - Rendering context\n   */\n  static onRenderChatMessage(message, html, context) {\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n    const midiRequestId = isMidiActive ? message.getFlag('midi-qol', 'requestId') : null;\n    const dnd5eRollType = message.flags?.dnd5e?.roll?.type;\n    LogUtil.log(\"ChatMessageManager.onRenderChatMessage #0\", [message.id, 'speaker:', message.speaker?.alias, 'midiRequestId:', midiRequestId, 'dnd5eRollType:', dnd5eRollType]);\n\n    const htmlElement = html instanceof jQuery ? html[0] : (html[0] || html);\n\n    if (message.getFlag(MODULE_ID, 'preventRender')) {\n      LogUtil.log(\"ChatMessageManager.onRenderChatMessage - Hiding message for roll request\", [message.id]);\n      if (htmlElement) {\n        htmlElement.style.display = 'none';\n      }\n      return;\n    }\n\n    ChatMessageManager.interceptRollMessage(message, html, context);\n\n    if (message.getFlag(MODULE_ID, 'isGroupRoll')) {\n      const SETTINGS = getSettings();\n      const globalHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n      const messageHidden = message.getFlag(MODULE_ID, 'npcHiddenOverride');\n      const isGM = game.user.isGM;\n      const showAllResultsToPlayers = message.getFlag(MODULE_ID, 'showAllResultsToPlayers');\n\n      const shouldHideNPCs = (messageHidden !== undefined ? messageHidden : globalHidden) && !isGM;\n\n      const flagData = message.getFlag(MODULE_ID, 'rollData');\n      if (flagData && flagData.results) {\n        const actorResults = htmlElement.querySelectorAll('.actor-result');\n        actorResults.forEach((element, index) => {\n          const result = flagData.results[index];\n          if (result) {\n            const actor = game.actors.get(result.actorId);\n            const shouldHide = shouldHideNPCs && actor && !actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);\n\n            if (shouldHide) {\n              element.classList.add('npc-hidden');\n            } else {\n              element.classList.remove('npc-hidden');\n            }\n\n            const rollMode = result.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n            const hasPermission = actor?.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER);\n\n            let shouldHideRoll;\n            if (isGM || showAllResultsToPlayers) {\n              shouldHideRoll = false;\n            } else if (rollMode === CONST.DICE_ROLL_MODES.BLIND) {\n              shouldHideRoll = true;\n            } else if (rollMode === CONST.DICE_ROLL_MODES.PRIVATE || rollMode === CONST.DICE_ROLL_MODES.SELF) {\n              shouldHideRoll = !hasPermission;\n            } else {\n              shouldHideRoll = false;\n            }\n\n            LogUtil.log(\"onRenderChatMessage - Roll visibility\", [result.actorName, \"rollMode:\", rollMode, \"isGM:\", isGM, \"showAllResultsToPlayers:\", showAllResultsToPlayers, \"hasPermission:\", hasPermission, \"shouldHideRoll:\", shouldHideRoll]);\n\n            if (shouldHideRoll) {\n              element.classList.add('roll-hidden');\n            } else {\n              element.classList.remove('roll-hidden');\n            }\n\n            const concealNPCNames = SettingsUtil.get(SETTINGS.concealNPCNames.tag);\n            const shouldConcealName = !isGM && result.isNPC && concealNPCNames && !shouldHide;\n\n            LogUtil.log(\"onRenderChatMessage - Name concealment\", [\n              result.actorName,\n              \"isNPC:\", result.isNPC,\n              \"concealNPCNames:\", concealNPCNames,\n              \"shouldHide:\", shouldHide,\n              \"shouldConcealName:\", shouldConcealName\n            ]);\n\n            if (shouldConcealName) {\n              element.classList.add('npc-name-concealed');\n            } else {\n              element.classList.remove('npc-name-concealed');\n            }\n          }\n        });\n      }\n\n      ChatMessageManager._attachGroupRollListeners(htmlElement, message);\n      ChatMessageManager._attachDCAndSelectionListeners(htmlElement, message);\n    }\n\n    this._addSelectTargetsButton(message, htmlElement);\n\n    if(game.user.isGM){\n      let item = context.subject?.item;\n      if (!item && message.flags?.dnd5e?.item?.uuid) {\n        item = fromUuidSync(message.flags.dnd5e.item.uuid);\n      }\n\n      if (item) {\n        setTimeout(() => {\n          HooksManager.activityConfigCache.delete(item.id);\n          LogUtil.log(\"ChatMessageManager.onRenderChatMessage - cleared activity config cache\", [item.id]);\n        }, 1000);\n      }\n    }\n\n    if (!game.user.isGM) {\n      const hasFlashRollsFlag = message.flags?.[MODULE_ID]?.isFlashRollRequest ||\n                               message.flags?.[MODULE_ID]?.groupRollId ||\n                               message.getFlag('dnd5e', 'roll')?._requestedBy;\n\n      if (hasFlashRollsFlag) {\n        const challengeVisibility = game.settings.get(\"dnd5e\", \"challengeVisibility\");\n\n        let showDC = true;\n        switch(challengeVisibility) {\n          case \"none\":\n            showDC = false;\n            break;\n          case \"all\":\n            showDC = true;\n            break;\n          case \"player\":\n            showDC = message.author.id === game.user.id || !message.author.isGM;\n            break;\n          default:\n            showDC = true;\n            break;\n        }\n\n        if (showDC===false) {\n          const chatCard = html.querySelectorAll(\"[data-display-challenge]\");\n          chatCard.forEach((el) => delete el.dataset.displayChallenge);\n\n          const diceTotals = html.querySelectorAll(\".success, .failure, .critical, .fumble\");\n          diceTotals?.forEach((el) => {\n            el.classList.remove(\"success\", \"failure\", \"critical\", \"fumble\");\n          });\n\n          diceTotals?.forEach((el) => el.querySelector(\".icons\")?.remove());\n\n          html.querySelectorAll(\".save-dc, .dc, .target-dc\").forEach((el) => {\n            const text = el.textContent;\n            if (text && text.includes(\"DC\")) {\n              el.textContent = text.replace(/DC\\s*\\d+/gi, \"\");\n            }\n          });\n        }\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Handle rendering of chat log for template removal scheduling\n   * @param {Application} app - The chat log application\n   * @param {HTMLElement} html - The rendered HTML\n   */\n  static onRenderChatLog(app, html) {\n    LogUtil.log(\"ChatMessageManager.onRenderChatLog\", []);\n\n    const damageMessages = html.querySelectorAll('.chat-message');\n    damageMessages.forEach(messageElement => {\n      const messageId = messageElement.dataset.messageId;\n      const message = game.messages.get(messageId);\n\n      if (message?.flags?.dnd5e?.roll?.type === 'damage' && message.flags?.dnd5e?.item?.uuid) {\n        const itemUuid = message.flags.dnd5e.item.uuid;\n        const item = fromUuidSync(itemUuid);\n\n        if (item && !HooksManager.templateRemovalTimers.has(itemUuid)) {\n          \n          HooksManager.templateRemovalTimers.add(itemUuid);\n\n          const SETTINGS = getSettings();\n          const timeoutSeconds = SettingsUtil.get(SETTINGS.templateRemovalTimeout.tag);\n          const timeoutMs = timeoutSeconds * 1000;\n\n          setTimeout(() => {\n            GeneralUtil.removeTemplateForItem(item);\n            HooksManager.templateRemovalTimers.delete(itemUuid);\n          }, timeoutMs);\n        }\n      }\n    });\n  }\n\n  /**\n   * Add \"Select Targeted\" button to damage roll messages with saves\n   * @param {ChatMessage} message - The chat message\n   * @param {jQuery} html - The rendered HTML\n   */\n  static _addSelectTargetsButton(message, html) {\n    if(!game.user.isGM) return;\n\n    html = html[0] || html;\n    LogUtil.log(\"ChatMessageManager._addSelectTargetsButton #0\", [message, html]);\n    if (message.flags?.dnd5e?.roll?.type !== 'damage' || html.querySelector('.select-targeted')) return;\n\n    const button = document.createElement('button');\n    button.className = 'select-targeted';\n    button.type = 'button';\n    button.setAttribute(\"data-tooltip-direction\", \"LEFT\");\n    button.setAttribute(\"data-tooltip\", \"Select Targeted\");\n    button.innerHTML = '<i class=\"fas fa-crosshairs\"></i>';\n\n    button.addEventListener('click', (event) => {\n      event.preventDefault();\n      this._selectTargetedTokens(event);\n    });\n\n    html.querySelector('.message-content').appendChild(button);\n    message.update({\n      content: html\n    });\n  }\n\n  /**\n   * Select all currently targeted tokens as damage targets\n   * @param {Event} event - The click event\n   */\n  static _selectTargetedTokens(event) {\n    const message = event.currentTarget.closest('.chat-message');\n    const targets = message.querySelectorAll(\"[data-target-uuid]\");\n\n    if (targets.length === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noTargetedTokens\"));\n      return;\n    }\n\n    for ( let i=0; i < targets.length; i++ ) {\n      const target = targets[i];\n      const actorId = target.dataset.targetUuid.split('Actor.')[1];\n      const tokens = canvas.tokens.placeables.filter(t => {\n        return t.document.actor?.id === actorId || t.document.baseActor?.id === actorId;\n      });\n      tokens.forEach((token, j) => {\n        if(token && token.control){\n          token.control({ releaseOthers: i===0 });\n        }\n      });\n    }\n  }\n  \n\n  /**\n   * Token that was temporarily controlled for vision preview\n   * @type {Token|null}\n   */\n  static _previewToken = null;\n\n  /**\n   * Previously controlled tokens before vision preview\n   * @type {Token[]}\n   */\n  static _previouslyControlled = [];\n\n  /**\n   * Original controlled property descriptor for restoring\n   * @type {PropertyDescriptor|null}\n   */\n  static _originalControlledGetter = null;\n\n  /**\n   * Show token vision for a chat message actor result\n   * @param {HTMLElement} actorElement - The actor result element\n   */\n  static _showTokenVision(actorElement) {\n    if (!canvas?.tokens || !canvas.scene?.tokenVision || !game.user.isGM) return;\n\n    const tokenId = actorElement.dataset.tokenId;\n    const actorId = actorElement.dataset.actorId;\n\n    let token = tokenId ? canvas.tokens.get(tokenId) : null;\n    if (!token && actorId) {\n      token = canvas.tokens.placeables.find(t => t.actor?.id === actorId);\n    }\n\n    if (!token || !token.document.sight?.enabled) return;\n\n    this._previouslyControlled = [...canvas.tokens.controlled];\n    this._previewToken = token;\n\n    this._originalControlledGetter = Object.getOwnPropertyDescriptor(Object.getPrototypeOf(token), 'controlled');\n\n    Object.defineProperty(token, 'controlled', {\n      get: () => true,\n      configurable: true\n    });\n\n    token.initializeVisionSource();\n    canvas.perception.update({\n      initializeVision: true,\n      refreshVision: true\n    });\n  }\n\n  /**\n   * Hide token vision for a chat message actor result\n   * @param {HTMLElement} actorElement - The actor result element\n   */\n  static _hideTokenVision(actorElement) {\n    if (!this._previewToken || !game.user.isGM) return;\n\n    delete this._previewToken.controlled;\n\n    if (this._originalControlledGetter) {\n      Object.defineProperty(this._previewToken, 'controlled', this._originalControlledGetter);\n      this._originalControlledGetter = null;\n    }\n\n    this._previewToken.initializeVisionSource();\n\n    this._previouslyControlled.forEach(t => {\n      if (t.scene === canvas.scene) {\n        t.initializeVisionSource();\n      }\n    });\n\n    canvas.perception.update({\n      initializeVision: true,\n      refreshVision: true\n    });\n\n    this._previewToken = null;\n    this._previouslyControlled = [];\n  }\n\n  /**\n   * Static method to attach group roll listeners to HTML elements\n   * @param {HTMLElement} html - The HTML element containing group roll elements\n   * @param {ChatMessage} message - The chat message instance\n   */\n  static _attachGroupRollListeners(html, message) {\n    const actorResults = html.querySelectorAll('.actor-result');\n    LogUtil.log('_attachGroupRollListeners - found actor results', [actorResults.length]);\n\n    actorResults.forEach(element => {\n      element.addEventListener('click', (event) => {\n        if (event.target.closest('.dice-btn.rollable') || event.target.closest('.adv-btn')) {\n          return;\n        }\n\n        event.preventDefault();\n        event.stopPropagation();\n\n        const actorResult = element;\n\n        LogUtil.log('actor-result click', [element]);\n\n        if (actorResult.classList.contains('expanded')) {\n          actorResult.classList.remove('expanded');\n        } else {\n          actorResult.classList.add('expanded');\n        }\n      });\n\n      const actorImg = element.querySelector('.actor-image');\n      if (actorImg) {\n        actorImg.addEventListener('mouseenter', (event) => {\n          event.stopPropagation();\n          this._showTokenVision(element);\n        });\n\n        actorImg.addEventListener('mouseleave', (event) => {\n          event.stopPropagation();\n          this._hideTokenVision(element);\n        });\n      }\n    });\n    \n    html.querySelectorAll('.adv-btn').forEach(advBtn => {\n      advBtn.addEventListener('click', async (event) => {\n        event.preventDefault();\n        event.stopPropagation();\n        event.stopImmediatePropagation();\n        const advantageMode = parseInt(advBtn.dataset.advantageMode);\n        this._handleGroupRollClick(advBtn, message, true, advantageMode === 1, advantageMode === -1);\n      });\n    });\n\n    html.querySelectorAll('.dice-btn.rollable').forEach(diceBtn => {\n      diceBtn.addEventListener('click', async (event) => {\n        event.preventDefault();\n        event.stopPropagation();\n        event.stopImmediatePropagation();\n\n        const { areKeysPressed } = game.dnd5e.utils || {};\n        let hasAdvantage = false;\n        let hasDisadvantage = false;\n        let skipNormal = false;\n\n        if (areKeysPressed) {\n          skipNormal = areKeysPressed(event, \"skipDialogNormal\");\n          hasAdvantage = areKeysPressed(event, \"skipDialogAdvantage\");\n          hasDisadvantage = areKeysPressed(event, \"skipDialogDisadvantage\");\n        } else {\n          skipNormal = event.shiftKey;\n          hasAdvantage = event.altKey;\n          hasDisadvantage = event.ctrlKey || event.metaKey;\n        }\n\n        let shouldSkipDialog = skipNormal || hasAdvantage || hasDisadvantage;\n\n        if (game.user.isGM && !shouldSkipDialog) {\n          const actorId = diceBtn.dataset.actorId;\n          const tokenId = diceBtn.dataset.tokenId;\n          let actor;\n          if (tokenId) {\n            const tokenDoc = game.scenes.current?.tokens.get(tokenId);\n            actor = tokenDoc?.actor;\n          }\n          if (!actor) {\n            actor = game.actors.get(actorId);\n          }\n          const isNPC = actor?.type === 'npc';\n          const isPC = actor?.type === 'character';\n          shouldSkipDialog = RollHelpers.shouldSkipRollDialog({\n            event,\n            isPC,\n            isNPC,\n            sendRequest: isPC\n          });\n        }\n\n        this._handleGroupRollClick(diceBtn, message, shouldSkipDialog, hasAdvantage, hasDisadvantage);\n      });\n    });\n  }\n\n  /**\n   * Handle a group roll click from either the dice button or advantage/disadvantage buttons\n   * @param {HTMLElement} element - The clicked element with data attributes\n   * @param {ChatMessage} message - The chat message\n   * @param {boolean} shouldSkipDialog - Whether to skip the roll dialog\n   * @param {boolean} hasAdvantage - Whether to roll with advantage\n   * @param {boolean} hasDisadvantage - Whether to roll with disadvantage\n   */\n  static async _handleGroupRollClick(element, message, shouldSkipDialog, hasAdvantage, hasDisadvantage) {\n    const dataset = element.dataset;\n    const actorId = dataset.actorId;\n    const tokenId = dataset.tokenId;\n    let actor;\n    let uniqueId = actorId;\n    if (tokenId) {\n      const tokenDoc = game.scenes.current?.tokens.get(tokenId);\n      actor = tokenDoc?.actor;\n      uniqueId = tokenId;\n    }\n    if (!actor) {\n      actor = game.actors.get(actorId);\n      uniqueId = actorId;\n    }\n\n    if (!actor) {\n      FlashAPI.notify('warn', `Actor not found`);\n      return;\n    }\n\n    const canRoll = game.user.isGM || actor.isOwner;\n    if (!canRoll) {\n      FlashAPI.notify('warn', `You don't have permission to roll for ${actor.name}`);\n      return;\n    }\n\n    const rollType = dataset.type?.toLowerCase();\n    const rollKey = dataset.rollKey;\n    const groupRollId = dataset.groupRollId;\n    const dc = dataset.dc ? parseInt(dataset.dc) : null;\n    const gmAdvantage = dataset.gmAdvantage === 'true';\n    const gmDisadvantage = dataset.gmDisadvantage === 'true';\n    const situationalBonus = dataset.situationalBonus || '';\n\n    const finalAdvantage = hasAdvantage || gmAdvantage;\n    const finalDisadvantage = hasDisadvantage || gmDisadvantage;\n\n    LogUtil.log('Group roll click', [rollType, rollKey, actorId, groupRollId, { shouldSkipDialog, hasAdvantage, hasDisadvantage, gmAdvantage, gmDisadvantage, situationalBonus }]);\n\n    const requestData = {\n      rollKey: rollKey,\n      groupRollId: groupRollId,\n      config: {\n        advantage: finalAdvantage && !finalDisadvantage,\n        disadvantage: finalDisadvantage && !finalAdvantage,\n        target: dc,\n        rollMode: game.settings.get(\"core\", \"rollMode\"),\n        situational: situationalBonus || undefined\n      }\n    };\n\n    const dialogConfig = {\n      configure: !shouldSkipDialog,\n      isRollRequest: true\n    };\n\n    const messageConfig = {\n      rollMode: game.settings.get(\"core\", \"rollMode\"),\n      create: true,\n      isRollRequest: true\n    };\n\n    const rollConfig = {\n      parts: [],\n      data: {},\n      options: {}\n    };\n\n    try {\n      const handler = RollHandlers[rollType];\n      if (handler) {\n        await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n      } else {\n        let rollMethod;\n        switch(rollType) {\n          case ROLL_TYPES.SKILL:\n            rollMethod = 'rollSkill';\n            break;\n          case ROLL_TYPES.ABILITY:\n          case ROLL_TYPES.ABILITY_CHECK:\n            rollMethod = 'rollAbilityTest';\n            break;\n          case ROLL_TYPES.SAVE:\n          case ROLL_TYPES.SAVING_THROW:\n            rollMethod = 'rollAbilitySave';\n            break;\n          case ROLL_TYPES.TOOL:\n            rollMethod = 'rollToolCheck';\n            break;\n          default:\n            FlashAPI.notify('warn', `Unknown roll type: ${rollType}`);\n            return;\n        }\n\n        if (rollMethod && actor[rollMethod]) {\n          const rollOptions = {\n            ...requestData.config,\n            configure: !shouldSkipDialog,\n            messageOptions: { \"flags.flash-rolls-5e.groupRollId\": groupRollId }\n          };\n          if (situationalBonus) {\n            rollOptions.rolls = [{\n              data: { situational: situationalBonus },\n              ...(shouldSkipDialog ? { parts: [\"@situational\"] } : {})\n            }];\n          }\n          await actor[rollMethod](rollKey, rollOptions);\n        }\n      }\n    } catch (error) {\n      LogUtil.error('Error executing roll from chat', error);\n      ui.notifications.error(`Failed to execute roll: ${error.message}`);\n    }\n  }\n\n  /**\n   * Attach DC control and selection button listeners\n   * @param {HTMLElement} html - The HTML element\n   * @param {ChatMessage} message - The chat message\n   */\n  static _attachDCAndSelectionListeners(html, message) {\n    const dcControl = html.querySelector('.group-roll-dc-control');\n    const dcInput = html.querySelector('.dc-input');\n    \n    if (dcControl) {\n      const showToPlayers = dcControl.dataset.showToPlayers === 'true';\n      if (!game.user.isGM) {\n        dcControl.style.display = 'none';\n      }\n      if (!game.user.isGM && !showToPlayers) {\n        const groupFooterDetails = html.querySelector('.group-roll-footer .group-result-details');\n        if (groupFooterDetails) {\n          groupFooterDetails.style.display = 'none';\n        }\n      }\n    }\n\n    const groupFooter = html.querySelector('.group-roll-footer');\n    if (groupFooter) {\n      const showResultToPlayers = groupFooter.dataset.showToPlayers === 'true';\n      const showAllResultsToPlayers = message.getFlag(MODULE_ID, 'showAllResultsToPlayers');\n      if (!game.user.isGM && !showResultToPlayers && !showAllResultsToPlayers) {\n        groupFooter.style.display = 'none';\n      }\n    }\n    \n    if (dcInput) {\n      if (!game.user.isGM) {\n        dcInput.readOnly = true;\n        dcInput.style.cursor = 'not-allowed';\n      } else {\n        let debounceTimer = null;\n        \n        const handleDCChange = async () => {\n          const newDC = parseInt(dcInput.value);\n          \n          if (!dcInput.value) return;\n          \n          if (isNaN(newDC) || newDC < 1 || newDC > 99) {\n            dcInput.value = '';\n            return;\n          }\n          \n          const messageId = dcInput.dataset.messageId;\n          const targetMessage = game.messages.get(messageId);\n          \n          if (targetMessage) {\n            await ChatMessageManager.updateGroupRollDC(targetMessage, newDC);\n          }\n        };\n        \n        dcInput.addEventListener('input', (e) => {\n          if (debounceTimer) {\n            clearTimeout(debounceTimer);\n          }\n          \n          debounceTimer = setTimeout(() => {\n            handleDCChange();\n          }, 750);\n        });\n        \n        dcInput.addEventListener('keypress', (e) => {\n          if (e.key === 'Enter') {\n            if (debounceTimer) {\n              clearTimeout(debounceTimer);\n            }\n            handleDCChange();\n          }\n        });\n      }\n    }\n\n    const selectionButtons = html.querySelector('.group-roll-selection-buttons');\n    if (selectionButtons) {\n      if (game.user.isGM) {\n        selectionButtons.classList.remove('gm-only');\n      }\n\n      selectionButtons.querySelectorAll('.select-actors-btn').forEach(btn => {\n        btn.addEventListener('click', async (event) => {\n          event.preventDefault();\n          event.stopPropagation();\n          const selectType = btn.dataset.selectType;\n          const messageId = selectionButtons.dataset.messageId;\n          const targetMessage = game.messages.get(messageId);\n          if (targetMessage) {\n            await ChatMessageManager.selectActorsFromGroupRoll(targetMessage, selectType);\n          }\n        });\n      });\n    }\n  }\n\n  /**\n   * Select actors from a group roll message based on their roll result\n   * @param {ChatMessage} message - The group roll chat message\n   * @param {string} selectType - Type of selection: 'failed', 'passed', or 'all'\n   */\n  static async selectActorsFromGroupRoll(message, selectType) {\n    if (!game.user.isGM) return;\n\n    const flagData = message.getFlag(MODULE_ID, 'rollData');\n    if (!flagData?.results) return;\n\n    const tokensToSelect = [];\n\n    for (const result of flagData.results) {\n      if (!result.rolled) continue;\n\n      let shouldSelect = false;\n      switch (selectType) {\n        case 'failed':\n          shouldSelect = result.failure === true;\n          break;\n        case 'passed':\n          shouldSelect = result.success === true;\n          break;\n        case 'all':\n          shouldSelect = true;\n          break;\n      }\n\n      if (shouldSelect) {\n        let token = null;\n        if (result.tokenId) {\n          token = canvas.tokens.get(result.tokenId);\n        }\n        if (!token && result.uniqueId && result.uniqueId !== result.actorId) {\n          token = canvas.tokens.get(result.uniqueId);\n        }\n        if (!token && result.actorId) {\n          const matchingTokens = canvas.tokens.placeables.filter(t => t.actor?.id === result.actorId);\n          if (matchingTokens.length === 1) {\n            token = matchingTokens[0];\n          }\n        }\n        if (token) {\n          tokensToSelect.push(token);\n        }\n      }\n    }\n\n    canvas.tokens.releaseAll();\n    if (tokensToSelect.length > 0) {\n      tokensToSelect.forEach((token, index) => {\n        token.control({ releaseOthers: index === 0 });\n      });\n      LogUtil.log('selectActorsFromGroupRoll - Selected tokens', [selectType, tokensToSelect.length]);\n    } else {\n      LogUtil.log('selectActorsFromGroupRoll - No matching tokens, deselected all', [selectType]);\n    }\n  }\n\n  /**\n   * Preload the Handlebars template\n   */\n  static async preloadTemplate() {\n    LogUtil.log('ChatMessageManager.preloadTemplate');\n    try {\n      await GeneralUtil.loadTemplates([this.templatePath]);\n    } catch (error) {\n      LogUtil.error('Failed to preload template', error);\n    }\n  }\n  \n  /**\n   * Create a group roll message for multiple actors\n   * @param {Array<{actor: Actor, uniqueId: string, tokenId: string|null}>} actorEntries - Array of actor entries with unique identifiers\n   * @param {string} rollType - Type of roll\n   * @param {string} rollKey - Specific roll key\n   * @param {Object} config - Roll configuration\n   * @param {string} groupRollId - Unique group roll identifier\n   * @returns {Promise<ChatMessage>} The created chat message\n   */\n  static async createGroupRollMessage(actorEntries, rollType, rollKey, config, groupRollId) {\n    LogUtil.log('ChatMessageManager.createGroupRollMessage', [actorEntries.length, rollType, rollKey, groupRollId]);\n\n    const validEntries = actorEntries.filter(entry => entry && entry.actor);\n\n    let existingMessage = this.groupRollMessages.get(groupRollId);\n    if (!existingMessage) {\n      const messages = game.messages.contents;\n      existingMessage = messages.find(m =>\n        m.getFlag(MODULE_ID, 'groupRollId') === groupRollId &&\n        m.getFlag(MODULE_ID, 'isGroupRoll')\n      );\n      if (existingMessage) {\n        this.groupRollMessages.set(groupRollId, existingMessage);\n      }\n    }\n\n    if (existingMessage) {\n      LogUtil.log('createGroupRollMessage - Found existing message, merging actors', [groupRollId]);\n      const pendingData = this.pendingRolls.get(groupRollId);\n      const existingActorIds = new Set(pendingData?.actorEntries.map(e => e.actorId) || []);\n      const newEntries = validEntries.filter(entry => !existingActorIds.has(entry.actor.id));\n\n      if (newEntries.length === 0) {\n        LogUtil.log('createGroupRollMessage - All actors already in group, skipping');\n        return existingMessage;\n      }\n\n      const newEntriesData = newEntries.map(entry => ({ actorId: entry.actor.id, uniqueId: entry.uniqueId, tokenId: entry.tokenId }));\n      const mergedEntries = [...(pendingData?.actorEntries || []), ...newEntriesData];\n\n      if (pendingData) {\n        pendingData.actorEntries = mergedEntries;\n      }\n\n      const existingFlagData = existingMessage.getFlag(MODULE_ID, 'rollData');\n\n      const SETTINGS = getSettings();\n      const groupRollNPCHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n      const isGM = game.user?.isGM === true;\n\n      const newResults = newEntries.map(entry => {\n        const result = {\n          actorId: entry.actor.id,\n          actorUuid: entry.actor.uuid,\n          uniqueId: entry.uniqueId,\n          tokenId: entry.tokenId,\n          actorImg: entry.actor.img || entry.actor.prototypeToken?.texture?.src || 'icons/svg/mystery-man.svg',\n          actorName: entry.tokenId ?\n            (canvas.tokens?.get(entry.tokenId)?.name || entry.actor.name) :\n            entry.actor.name,\n          isNPC: entry.actor.type === 'npc' || !entry.actor.hasPlayerOwner,\n          rolled: false,\n          showDice: true,\n          total: null,\n          success: false,\n          failure: false,\n          rollTypeFlavor: existingFlagData?.flavor || ''\n        };\n\n        result.shouldHide = result.isNPC && groupRollNPCHidden && !isGM;\n        result.rollMode = CONST.DICE_ROLL_MODES.PUBLIC;\n        const hasPermission = entry.actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);\n\n        if (isGM) {\n          result.shouldHideRoll = false;\n        } else if (result.rollMode === CONST.DICE_ROLL_MODES.BLIND) {\n          result.shouldHideRoll = true;\n        } else if (result.rollMode === CONST.DICE_ROLL_MODES.PRIVATE || result.rollMode === CONST.DICE_ROLL_MODES.SELF) {\n          result.shouldHideRoll = !hasPermission;\n        } else {\n          result.shouldHideRoll = false;\n        }\n\n        return result;\n      });\n\n      const updatedData = {\n        ...existingFlagData,\n        results: [...existingFlagData.results, ...newResults]\n      };\n\n      const templatePath = updatedData.isContestedRoll\n        ? 'modules/flash-rolls-5e/templates/chat-msg-contested-roll.hbs'\n        : this.templatePath;\n\n      await existingMessage.update({\n        content: await GeneralUtil.renderTemplate(templatePath, updatedData),\n        flags: {\n          [MODULE_ID]: {\n            rollData: updatedData,\n            isGroupRoll: true,\n            groupRollId: groupRollId\n          }\n        }\n      });\n\n      return existingMessage;\n    }\n\n    const data = this.buildGroupRollData(actorEntries, rollType, rollKey, config, null);\n    if (!data) {\n      LogUtil.error('createGroupRollMessage - Failed to build group roll data');\n      return null;\n    }\n    data.groupRollId = groupRollId;\n    data.isContestedRoll = config.isContestedRoll || false;\n\n    this.pendingRolls.set(groupRollId, {\n      actorEntries: validEntries.map(entry => ({ actorId: entry.actor.id, uniqueId: entry.uniqueId, tokenId: entry.tokenId })),\n      rollType,\n      rollKey,\n      config,\n      results: new Map()\n    });\n\n    const hasAnyPC = validEntries.some(entry => entry.actor.hasPlayerOwner);\n    const rollMode = hasAnyPC ? CONST.DICE_ROLL_MODES.PUBLIC : game.settings.get(\"core\", \"rollMode\");\n\n    const message = await this.postGroupMessage(data, rollMode);\n    return message;\n  }\n  \n  /**\n   * Build the data object for the group roll template\n   * @param {Array<{actor: Actor, uniqueId: string, tokenId: string|null}>} actorEntries - Array of actor entries with unique identifiers\n   * @param {string} rollType - Type of roll\n   * @param {string} rollKey - Specific roll key\n   * @param {Object} config - Roll configuration\n   * @returns {Object} Template data\n   */\n  static buildGroupRollData(actorEntries, rollType, rollKey, config, messageRollMode = null) {\n\n    const validEntries = actorEntries.filter(entry => entry && entry.actor);\n    if (validEntries.length === 0) {\n      LogUtil.error('buildGroupRollData - No valid actor entries found', [actorEntries]);\n      return null;\n    }\n\n    let flavor = this._buildFlavorText(rollType, rollKey, config);\n    const dc = config?.dc || config?.target;\n    const results = validEntries.map(entry => {\n      const entryRollType = entry.rollType || rollType;\n      const entryRollKey = entry.rollKey || rollKey;\n      const entryFlavor = config?.isContestedRoll\n        ? this._buildFlavorText(entryRollType, entryRollKey, config)\n        : flavor;\n\n      return {\n        actorId: entry.actor.id,\n        actorUuid: entry.actor.uuid,\n        uniqueId: entry.uniqueId,\n        tokenId: entry.tokenId,\n        actorImg: entry.actor.img || entry.actor.prototypeToken?.texture?.src || 'icons/svg/mystery-man.svg',\n        actorName: entry.tokenId ?\n          (canvas.tokens?.get(entry.tokenId)?.name || entry.actor.name) :\n          entry.actor.name,\n        isNPC: entry.actor.type === 'npc' || !entry.actor.hasPlayerOwner,\n        rolled: false,\n        showDice: true,\n        total: null,\n        success: false,\n        failure: false,\n        rollTypeFlavor: entryFlavor\n      };\n    });\n    \n    const supportsDC = RollHelpers.shouldShowDC(rollType);\n    const SETTINGS = getSettings();\n    const showDCToPlayers = SettingsUtil.get(SETTINGS.showGroupDCToPlayers.tag);\n    const showResultToPlayers = SettingsUtil.get(SETTINGS.showGroupResultToPlayers.tag);\n    const groupRollNPCHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n    const groupCalculationForSaves = SettingsUtil.get(SETTINGS.groupCalculationForSaves.tag);\n    const isSaveRoll = rollType === ROLL_TYPES.SAVE || rollType === ROLL_TYPES.SAVING_THROW;\n    const showGroupCalculation = isSaveRoll ? groupCalculationForSaves : true;\n    const fromMidiWorkflow = config?.fromMidiWorkflow ?? false;\n    const isGM = game.user?.isGM === true;\n    LogUtil.log('buildGroupRollData - fromMidiWorkflow', [fromMidiWorkflow, 'config.fromMidiWorkflow:', config?.fromMidiWorkflow, 'rollType:', rollType]);\n\n    results.forEach(result => {\n      result.shouldHide = result.isNPC && groupRollNPCHidden && !isGM;\n      result.rollMode = messageRollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n      const hasPermission = validEntries.find(e => e.uniqueId === result.uniqueId)?.actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);\n\n      if (isGM) {\n        result.shouldHideRoll = false;\n      } else if (result.rollMode === CONST.DICE_ROLL_MODES.BLIND) {\n        result.shouldHideRoll = true;\n      } else if (result.rollMode === CONST.DICE_ROLL_MODES.PRIVATE || result.rollMode === CONST.DICE_ROLL_MODES.SELF) {\n        result.shouldHideRoll = !hasPermission;\n      } else {\n        result.shouldHideRoll = false;\n      }\n\n      LogUtil.log(\"buildGroupRollData - Roll visibility\", [result.actorName, \"rollMode:\", result.rollMode, \"isGM:\", isGM, \"hasPermission:\", hasPermission, \"shouldHideRoll:\", result.shouldHideRoll]);\n    });\n    \n    return {\n      flavor,\n      results,\n      showDC: dc !== undefined && dc !== null,\n      dc,\n      rollType,\n      rollKey,\n      supportsDC,\n      showDCToPlayers,\n      showResultToPlayers,\n      showGroupCalculation,\n      groupRollNPCHidden,\n      fromMidiWorkflow,\n      isGM,\n      isSingleActor: validEntries.length === 1,\n      actorEntries: validEntries.map(entry => ({ actorId: entry.actor.id, uniqueId: entry.uniqueId, tokenId: entry.tokenId })),\n      moduleId: MODULE_ID,\n      gmAdvantage: config?.advantage === true,\n      gmDisadvantage: config?.disadvantage === true,\n      gmSituationalBonus: config?.situationalBonus || config?.rolls?.[0]?.data?.situational || ''\n    };\n  }\n  \n  /**\n   * Calculate the result of a contested roll\n   * @param {Array} results - Array of roll results\n   * @returns {Object} Contested result with winner information\n   * @private\n   */\n  static _calculateContestedResult(results) {\n    const rolledResults = results.filter(r => r.rolled && r.total !== null);\n\n    if (rolledResults.length < 2) {\n      return { complete: false };\n    }\n\n    const [result1, result2] = rolledResults;\n    const winner = result1.total > result2.total ? result1 : result2;\n    const loser = result1.total > result2.total ? result2 : result1;\n\n    const getResultId = (result) => result.tokenId || result.uniqueId || result.actorId;\n\n    LogUtil.log('_calculateContestedResult - Results', [\n      'result1:', { tokenId: result1.tokenId, uniqueId: result1.uniqueId, actorId: result1.actorId, total: result1.total },\n      'result2:', { tokenId: result2.tokenId, uniqueId: result2.uniqueId, actorId: result2.actorId, total: result2.total },\n      'winnerId:', getResultId(winner),\n      'loserId:', getResultId(loser)\n    ]);\n\n    return {\n      complete: true,\n      winnerId: getResultId(winner),\n      winnerName: winner.actorName,\n      winnerTotal: winner.total,\n      loserId: getResultId(loser),\n      loserName: loser.actorName,\n      loserTotal: loser.total,\n      isTie: result1.total === result2.total\n    };\n  }\n\n  /**\n   * Build flavor text for the roll\n   * @private\n   */\n  static _buildFlavorText(rollType, rollKey, config) {\n    let flavor = '';\n    \n    switch(rollType?.toLowerCase()) {\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.ABILITY_CHECK:\n        const abilityLabel = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        flavor = game.i18n.format(\"DND5E.AbilityPromptTitle\", { ability: abilityLabel });\n        break;\n      case ROLL_TYPES.SAVE:\n      case ROLL_TYPES.SAVING_THROW:\n        const saveLabel = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        flavor = game.i18n.format(\"DND5E.SavePromptTitle\", { ability: saveLabel });\n        break;\n      case ROLL_TYPES.SKILL:\n        const skillLabel = CONFIG.DND5E.skills[rollKey]?.label || rollKey;\n        const skillAbility = config?.ability || CONFIG.DND5E.skills[rollKey]?.ability || 'int';\n        const skillAbilityLabel = CONFIG.DND5E.abilities[skillAbility]?.label || skillAbility;\n        LogUtil.log('buildFlavorText - skill', [config?.ability, skillLabel, skillAbility, skillAbilityLabel]);\n        flavor = game.i18n.format(\"DND5E.SkillPromptTitle\", { \n          skill: skillLabel,\n          ability: skillAbilityLabel\n        });\n        break;\n      case ROLL_TYPES.TOOL:\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        let toolLabel = rollKey;\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          toolLabel = toolItem?.name || rollKey;\n        }\n        const toolAbility = config?.ability || toolData?.ability || 'int';\n        const toolAbilityLabel = CONFIG.DND5E.abilities[toolAbility]?.label || toolAbility;\n        flavor = game.i18n.format(\"DND5E.ToolPromptTitle\", { \n          tool: toolLabel, \n          ability: toolAbilityLabel \n        });\n        break;\n      case ROLL_TYPES.CONCENTRATION:\n        flavor = game.i18n.localize(\"DND5E.Concentration\") || \"Concentration\";\n        break;\n      case ROLL_TYPES.DEATH_SAVE:\n        flavor = game.i18n.localize(\"DND5E.DeathSave\") || \"Death Saving Throw\";\n        break;\n      case ROLL_TYPES.HIT_DIE:\n      case 'hitdice':\n        flavor = game.i18n.localize(\"DND5E.HitDice\") || \"Hit Dice\";\n        break;\n      case ROLL_TYPES.HEALING:\n        flavor = config?.flavor || game.i18n.localize(\"DND5E.Healing\") || \"Healing\";\n        break;\n      case ROLL_TYPES.CUSTOM:\n        flavor = config?.flavor || rollKey || game.i18n.localize(\"DND5E.Roll\") || \"Custom Roll\";\n        break;\n      case ROLL_TYPES.FORMULA:\n        flavor = config?.flavor || rollKey || game.i18n.localize(\"DND5E.Roll\") || \"Custom Formula\";\n        break;\n      case ROLL_TYPES.ITEM_SAVE:\n        flavor = config?.flavor || game.i18n.localize(\"DND5E.SavingThrow\") || \"Saving Throw\";\n        break;\n      case ROLL_TYPES.INITIATIVE:\n        flavor = game.i18n.localize(\"DND5E.Initiative\");\n        break;\n      case ROLL_TYPES.ATTACK:\n        flavor = config?.flavor || game.i18n.localize(\"DND5E.Attack\") || \"Attack Roll\";\n        break;\n      case ROLL_TYPES.DAMAGE:\n        flavor = config?.flavor || game.i18n.localize(\"DND5E.Damage\") || \"Damage Roll\";\n        break;\n      default:\n        flavor = config?.flavor || \"Roll\";\n    }\n    \n    return flavor;\n  }\n  \n  /**\n   * Post a group message to chat\n   * @param {Object} data - Message data\n   * @param {string} [rollMode] - The roll mode for the message\n   * @returns {Promise<ChatMessage>} The created message\n   */\n  static async postGroupMessage(data, rollMode = null) {\n    LogUtil.log('postGroupMessage - groupRollId', [data.groupRollId, rollMode]);\n\n    try {\n      const templatePath = data.isContestedRoll\n        ? 'modules/flash-rolls-5e/templates/chat-msg-contested-roll.hbs'\n        : this.templatePath;\n\n      const content = await GeneralUtil.renderTemplate(templatePath, data);\n      let speakerAlias = game.i18n.localize(\"FLASH_ROLLS.chat.groupRoll\");\n      if (data.isContestedRoll) {\n        speakerAlias = game.i18n.localize(\"FLASH_ROLLS.chat.contestedRoll\");\n      } else if (data.isSingleActor) {\n        speakerAlias = game.i18n.localize(\"FLASH_ROLLS.chat.rollRequest\");\n      }\n      const messageData = {\n        content,\n        speaker: {\n          alias: speakerAlias\n        },\n        flags: {\n          [MODULE_ID]: {\n            isGroupRoll: true,\n            isContestedRoll: data.isContestedRoll || false,\n            groupRollId: data.groupRollId,\n            rollData: data\n          },\n          rsr5e: { processed: true, quickRoll: false}\n        }\n      };\n      if (rollMode) {\n        ChatMessage.applyRollMode(messageData, rollMode);\n      }\n\n      const msg = await ChatMessage.create(messageData);\n      this.groupRollMessages.set(data.groupRollId, msg);\n      return msg;\n    } catch (error) {\n      LogUtil.error('Failed to post group message', error);\n      return null;\n    }\n  }\n  \n  /**\n   * Update a group roll message with a completed roll result\n   * @param {string} groupRollId - The group roll identifier\n   * @param {string} uniqueId - The unique identifier (token ID or actor ID) who rolled\n   * @param {Roll} roll - The completed roll\n   */\n  static async updateGroupRollMessage(groupRollId, uniqueId, roll, rollMode = CONST.DICE_ROLL_MODES.PUBLIC) {\n    if (!game.user.isGM) {\n      return;\n    }\n    LogUtil.log('ChatMessageManager.updateGroupRollMessage #0', [groupRollId, uniqueId, roll, rollMode]);\n\n    return await this._performGroupRollUpdate(groupRollId, uniqueId, roll, rollMode);\n  }\n  \n  /**\n   * Internal method to perform the actual group roll update\n   * @param {string} groupRollId - The group roll identifier\n   * @param {string} uniqueId - The unique identifier (token ID or actor ID) who rolled\n   * @param {Roll} roll - The completed roll\n   * @param {string} rollMode - The roll mode for this specific roll\n   * @private\n   */\n  static async _performGroupRollUpdate(groupRollId, uniqueId, roll, rollMode = CONST.DICE_ROLL_MODES.PUBLIC) {\n    \n    let message = this.groupRollMessages.get(groupRollId);\n    let pendingData = this.pendingRolls.get(groupRollId);\n    \n    if (!message) {\n      const messages = game.messages.contents;\n      message = messages.find(m => \n        m.getFlag(MODULE_ID, 'groupRollId') === groupRollId &&\n        m.getFlag(MODULE_ID, 'isGroupRoll')\n      );\n      \n      if (message) {\n        this.groupRollMessages.set(groupRollId, message);\n        LogUtil.log('_performGroupRollUpdate - Found and registered group message', [groupRollId]);\n        \n        if (!pendingData) {\n          const flagData = message.getFlag(MODULE_ID, 'rollData');\n          pendingData = {\n            actorEntries: flagData.actorEntries || flagData.results.map(r => ({ actorId: r.actorId, uniqueId: r.uniqueId, tokenId: r.tokenId })),\n            results: new Map()\n          };\n          this.pendingRolls.set(groupRollId, pendingData);\n        }\n      }\n    }\n    \n    if (!message) {\n      LogUtil.log('No group message found for groupRollId', groupRollId);\n      return;\n    }\n    \n    // Store the result if pendingData exists\n    if (pendingData && pendingData.results) {\n      pendingData.results.set(uniqueId, {\n        total: roll.total,\n        roll: roll\n      });\n    }\n    \n    const flagData = message.getFlag(MODULE_ID, 'rollData');\n    LogUtil.log('_performGroupRollUpdate - Searching for uniqueId', [uniqueId, 'in results:', flagData.results.map(r => ({uniqueId: r.uniqueId, actorId: r.actorId, tokenId: r.tokenId}))]);\n    let resultIndex = flagData.results.findIndex(r => r.uniqueId === uniqueId);\n\n    if (resultIndex === -1) {\n      // 1: If uniqueId is a tokenId, try finding by tokenId property first (important for multiple tokens of same actor)\n      resultIndex = flagData.results.findIndex(r => r.tokenId === uniqueId);\n      if (resultIndex !== -1) {\n        LogUtil.log('_performGroupRollUpdate - Found by tokenId', [resultIndex]);\n      }\n\n      // 2: If uniqueId looks like a token ID, try to get the actor from the token\n      if (resultIndex === -1) {\n        const token = canvas.tokens?.get(uniqueId) || game.scenes.active?.tokens?.get(uniqueId);\n        if (token && token.actor) {\n          const tokenActorId = token.actor.id;\n          LogUtil.log('_performGroupRollUpdate - Trying token actor match', [uniqueId, 'token actor:', tokenActorId]);\n\n          // For unlinked tokens, match by tokenId\n          if (token.actorLink === false) {\n            resultIndex = flagData.results.findIndex(r => r.tokenId === uniqueId);\n          }\n\n          // For linked tokens or if no tokenId match, match by actorId\n          if (resultIndex === -1) {\n            resultIndex = flagData.results.findIndex(r => r.actorId === tokenActorId && !r.rolled);\n\n            // If all rolled, just match by actorId\n            if (resultIndex === -1) {\n              resultIndex = flagData.results.findIndex(r => r.actorId === tokenActorId);\n            }\n          }\n\n          if (resultIndex !== -1) {\n            LogUtil.log('_performGroupRollUpdate - Found by token lookup', [resultIndex]);\n          }\n        }\n      }\n\n      // 3: Try matching by actorId directly (only if no tokenId match found)\n      if (resultIndex === -1) {\n        resultIndex = flagData.results.findIndex(r => r.actorId === uniqueId);\n        if (resultIndex !== -1) {\n          LogUtil.log('_performGroupRollUpdate - Found by actorId', [resultIndex]);\n        }\n      }\n\n      // 4: Extract actorId from speaker and match\n      if (resultIndex === -1 && message.speaker?.actor) {\n        const speakerActorId = message.speaker.actor;\n        resultIndex = flagData.results.findIndex(r => r.actorId === speakerActorId);\n        if (resultIndex !== -1) {\n          LogUtil.log('_performGroupRollUpdate - Found by speaker actorId', [resultIndex]);\n        }\n      }\n\n      // 5: For contested rolls with multiple results, try to find the first unrolled result for this actor\n      if (resultIndex === -1 && flagData.isContestedRoll) {\n        resultIndex = flagData.results.findIndex(r => r.actorId === uniqueId && !r.rolled);\n        if (resultIndex !== -1) {\n          LogUtil.log('_performGroupRollUpdate - Found first unrolled result for actor in contested roll', [resultIndex]);\n        }\n      }\n    }\n    \n    if (resultIndex !== -1) {\n      flagData.results[resultIndex].rolled = true;\n      flagData.results[resultIndex].showDice = false;\n      flagData.results[resultIndex].total = roll.total;\n      flagData.results[resultIndex].roll = roll.toJSON();\n      flagData.results[resultIndex].rollMode = rollMode;\n      LogUtil.log('_performGroupRollUpdate - Set roll mode for result', [flagData.results[resultIndex].actorName, 'rollMode:', rollMode]);\n\n      try {\n        let rollBreakdown = await roll.render();\n        flagData.results[resultIndex].rollBreakdown = rollBreakdown;\n      } catch (error) {\n        LogUtil.error('Error rendering roll breakdown', [error]);\n        flagData.results[resultIndex].rollBreakdown = null;\n      }\n\n      if (flagData.showDC && flagData.dc) {\n        flagData.results[resultIndex].success = roll.total >= flagData.dc;\n        flagData.results[resultIndex].failure = roll.total < flagData.dc;\n      }\n\n      const hookData = {\n        actorUuid: flagData.results[resultIndex].actorUuid,\n        actorId: flagData.results[resultIndex].actorId,\n        tokenId: flagData.results[resultIndex].tokenId,\n        roll: roll.toJSON(),\n        total: roll.total,\n        rollType: flagData.rollType,\n        rollKey: flagData.rollKey,\n        groupRollId: groupRollId,\n        dc: flagData.dc || null,\n        success: flagData.dc ? roll.total >= flagData.dc : null\n      };\n      SocketUtil.execForAll(SOCKET_CALLS.broadcastRollComplete, hookData);\n    }else{\n      LogUtil.error('Group message id not found');\n      return;\n    }\n    \n    flagData.allRolled = flagData.results.every(r => r.rolled);\n    flagData.messageId = message.id;\n    flagData.supportsDC = RollHelpers.shouldShowDC(flagData.rollType);\n\n    const SETTINGS = getSettings();\n    flagData.showDCToPlayers = SettingsUtil.get(SETTINGS.showGroupDCToPlayers.tag);\n    flagData.showResultToPlayers = SettingsUtil.get(SETTINGS.showGroupResultToPlayers.tag);\n    flagData.groupRollNPCHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n    const groupCalculationForSaves = SettingsUtil.get(SETTINGS.groupCalculationForSaves.tag);\n    const isSaveRoll = flagData.rollType === ROLL_TYPES.SAVE || flagData.rollType === ROLL_TYPES.SAVING_THROW;\n    flagData.showGroupCalculation = isSaveRoll ? groupCalculationForSaves : true;\n    flagData.isGM = game.user?.isGM === true;\n\n    if (flagData.results) {\n      flagData.results.forEach(result => {\n        if (result.isNPC === undefined) {\n          const actor = game.actors.get(result.actorId);\n          result.isNPC = actor ? (actor.type === 'npc' || !actor.hasPlayerOwner) : false;\n        }\n        result.shouldHide = result.isNPC && flagData.groupRollNPCHidden && !flagData.isGM;\n\n        if (result.rollMode === undefined) {\n          result.rollMode = CONST.DICE_ROLL_MODES.PUBLIC;\n        }\n        const actor = game.actors.get(result.actorId);\n        const hasPermission = actor?.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED);\n\n        if (flagData.isGM) {\n          result.shouldHideRoll = false;\n        } else if (result.rollMode === CONST.DICE_ROLL_MODES.BLIND) {\n          result.shouldHideRoll = true;\n        } else if (result.rollMode === CONST.DICE_ROLL_MODES.PRIVATE || result.rollMode === CONST.DICE_ROLL_MODES.SELF) {\n          result.shouldHideRoll = !hasPermission;\n        } else {\n          result.shouldHideRoll = false;\n        }\n\n        LogUtil.log('_performGroupRollUpdate - Result visibility calculated', [\n          result.actorName,\n          'rollMode:', result.rollMode,\n          'isGM:', flagData.isGM,\n          'hasPermission:', hasPermission,\n          'shouldHideRoll:', result.shouldHideRoll\n        ]);\n      });\n    }\n\n    // Calculate contested result if it's a contested roll\n    if (flagData.isContestedRoll) {\n      const contestedResult = this._calculateContestedResult(flagData.results);\n      flagData.contestedResult = contestedResult;\n\n      if (contestedResult.complete && contestedResult.winnerId && !contestedResult.isTie) {\n        flagData.results.forEach(result => {\n          const resultId = result.tokenId || result.uniqueId || result.actorId;\n          result.isWinner = resultId === contestedResult.winnerId;\n          result.isLoser = resultId === contestedResult.loserId;\n          LogUtil.log('updateGroupRollMessage - Setting winner/loser', [\n            'resultId:', resultId,\n            'winnerId:', contestedResult.winnerId,\n            'loserId:', contestedResult.loserId,\n            'isWinner:', result.isWinner,\n            'isLoser:', result.isLoser\n          ]);\n        });\n      }\n\n      LogUtil.log('updateGroupRollMessage - Contested Result', [contestedResult]);\n    }\n    // Calculate group result if DC is set and roll type supports it\n    else if (flagData.supportsDC && flagData.showDC && flagData.dc) {\n      const actors = flagData.actorEntries?.map(entry => game.actors.get(entry.actorId)).filter(a => a) ||\n                     flagData.actors?.map(id => game.actors.get(id)).filter(a => a) || [];\n\n      const groupResult = RollHelpers.getGroupResult(\n        flagData.results,\n        flagData.dc,\n        actors,\n        flagData.rollType,\n        flagData.rollKey\n      );\n\n      flagData.groupResult = groupResult;\n      LogUtil.log('updateGroupRollMessage - COMPLETE?', [groupResult.complete]);\n\n      if (groupResult.complete && groupResult.details) {\n        flagData.groupSummary = groupResult.details.summary;\n      }\n    }\n\n    const templatePath = flagData.isContestedRoll\n      ? 'modules/flash-rolls-5e/templates/chat-msg-contested-roll.hbs'\n      : this.templatePath;\n\n    const newContent = await GeneralUtil.renderTemplate(templatePath, flagData);\n    await message.update({\n      content: newContent,\n      flags: {\n        [MODULE_ID]: {\n          rollData: flagData\n        },\n        rsr5e: { processed: true, quickRoll: false}\n      }\n    });\n    \n    if (pendingData?.results && pendingData?.actorEntries) {\n      if (pendingData.results.size === pendingData.actorEntries.length) {\n        this.pendingRolls.delete(groupRollId);\n        this._scheduleMessageRemoval(message);\n\n        if (flagData.supportsDC && flagData.dc && !flagData.isContestedRoll) {\n          this._handleAutoSelectOnComplete(message, flagData);\n        }\n\n        setTimeout(() => {\n          this.groupRollMessages.delete(groupRollId);\n          this.updateQueue.delete(groupRollId);\n        }, 60000);\n      }\n    }\n  }\n\n  /**\n   * Handle auto-selection of tokens when a group roll completes\n   * @param {ChatMessage} message - The group roll message\n   * @param {Object} flagData - The roll data from message flags\n   * @private\n   */\n  static _handleAutoSelectOnComplete(message, flagData) {\n    if (!game.user.isGM) return;\n\n    const SETTINGS = getSettings();\n    const autoSelectMode = SettingsUtil.get(SETTINGS.autoSelectOnGroupRoll.tag);\n\n    if (autoSelectMode === 0) return;\n\n    let selectType;\n    switch (autoSelectMode) {\n      case 1:\n        selectType = 'failed';\n        break;\n      case 2:\n        selectType = 'passed';\n        break;\n      case 3:\n        selectType = 'all';\n        break;\n      default:\n        return;\n    }\n\n    setTimeout(() => {\n      this.selectActorsFromGroupRoll(message, selectType);\n    }, 100);\n  }\n\n  /**\n   * Update group roll message with new DC value\n   * @param {ChatMessage} message - The chat message to update\n   * @param {number} newDC - The new DC value\n   */\n  static async updateGroupRollDC(message, newDC) {\n    const flagData = message.getFlag(MODULE_ID, 'rollData');\n    if (!flagData) return;\n    \n    flagData.supportsDC = RollHelpers.shouldShowDC(flagData.rollType);\n    if (!flagData.supportsDC) return;\n    \n    flagData.dc = newDC;\n    flagData.showDC = true;\n    flagData.results.forEach(result => {\n      if (result.rolled && result.total !== null) {\n        result.success = result.total >= newDC;\n        result.failure = result.total < newDC;\n      }\n    });\n    \n    const actors = flagData.actorEntries?.map(entry => game.actors.get(entry.actorId)).filter(a => a) || \n                   flagData.actors?.map(id => game.actors.get(id)).filter(a => a) || [];\n    \n    const groupResult = RollHelpers.getGroupResult(\n      flagData.results,\n      newDC,\n      actors,\n      flagData.rollType,\n      flagData.rollKey\n    );\n    \n    flagData.groupResult = groupResult;\n    \n    if (groupResult.complete && groupResult.details) {\n      flagData.groupSummary = groupResult.details.summary;\n    }\n    \n    flagData.allRolled = flagData.results.every(r => r.rolled);\n    flagData.messageId = message.id;\n\n    const SETTINGS = getSettings();\n    flagData.showDCToPlayers = SettingsUtil.get(SETTINGS.showGroupDCToPlayers.tag);\n    flagData.showResultToPlayers = SettingsUtil.get(SETTINGS.showGroupResultToPlayers.tag);\n    flagData.groupRollNPCHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n    const groupCalculationForSaves = SettingsUtil.get(SETTINGS.groupCalculationForSaves.tag);\n    const isSaveRoll = flagData.rollType === ROLL_TYPES.SAVE || flagData.rollType === ROLL_TYPES.SAVING_THROW;\n    flagData.showGroupCalculation = isSaveRoll ? groupCalculationForSaves : true;\n    flagData.isGM = game.user?.isGM === true;\n\n    if (flagData.results) {\n      flagData.results.forEach(result => {\n        if (result.isNPC === undefined) {\n          const actor = game.actors.get(result.actorId);\n          result.isNPC = actor ? !actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED) : false;\n        }\n        result.shouldHide = result.isNPC && flagData.groupRollNPCHidden && !flagData.isGM;\n      });\n    }\n\n    const newContent = await GeneralUtil.renderTemplate(this.templatePath, flagData);\n    await message.update({\n      content: newContent,\n      flags: {\n        [MODULE_ID]: {\n          rollData: flagData\n        },\n        rsr5e: { processed: true, quickRoll: false}\n      }\n    });\n  }\n\n  /**\n   * Intercept individual roll messages and update group message instead\n   * @param {ChatMessage} message - The chat message document\n   * @param {HTMLElement} html - The rendered HTML element\n   * @param {Object} context - Rendering context\n   * @returns {boolean} Return false to prevent rendering\n   */\n  static interceptRollMessage(message, html, context) {\n    const SETTINGS = getSettings();\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n\n    const actorUniqueIdFromFlag = message.getFlag(MODULE_ID, 'actorUniqueId');\n    const actorId = message.speaker?.actor;\n    const tokenId = message.speaker?.token;\n\n    LogUtil.log('interceptRollMessage - speaker info', ['actorUniqueId from flag:', actorUniqueIdFromFlag, message]);\n\n    let actor;\n    let uniqueId;\n    if (actorUniqueIdFromFlag) {\n      const tokenDoc = game.scenes.active?.tokens.get(actorUniqueIdFromFlag);\n      if (tokenDoc?.actor) {\n        actor = tokenDoc.actor;\n        uniqueId = actorUniqueIdFromFlag;\n      } else {\n        actor = game.actors.get(actorUniqueIdFromFlag);\n        uniqueId = actorUniqueIdFromFlag;\n      }\n    }\n    if (!actor) {\n      if (tokenId) {\n        const token = canvas.tokens?.get(tokenId) || game.scenes.active?.tokens?.get(tokenId);\n        actor = token?.actor;\n      }\n      if (!actor) {\n        actor = game.actors.get(actorId);\n      }\n      uniqueId = tokenId || actorId;\n    }\n\n    if (!actor) return;\n\n    LogUtil.log('interceptRollMessage - using uniqueId:', [uniqueId, 'for actor:', actor.name]);\n\n    const isFlashRollRequest = message.getFlag(MODULE_ID, 'isFlashRollRequest');\n    const rollType = message.getFlag(MODULE_ID, 'rollType');\n    const rollKey = message.getFlag(MODULE_ID, 'rollKey');\n    const roll = message.rolls?.[0];\n\n    if (!groupRollsMsgEnabled) {\n      if (isFlashRollRequest && roll) {\n        this._broadcastIndividualRollComplete(actor, roll, rollType, rollKey, tokenId);\n        this._scheduleIndividualMessageRemoval(message, rollType);\n      }\n      return;\n    }\n\n    const groupRollId = message.getFlag(MODULE_ID, 'groupRollId') ||\n                        actor.getFlag(MODULE_ID, 'tempGroupRollId') ||\n                        actor.getFlag(MODULE_ID, 'tempInitiativeConfig')?.groupRollId;\n\n    if (!groupRollId) {\n      LogUtil.log('interceptRollMessage #2 - no groupRollId in flag', [actor.name]);\n\n      if (game.user.isGM && roll && groupRollsMsgEnabled) {\n        const matchingGroupRollId = this._findMatchingPendingRoll(actor, uniqueId, message);\n        if (matchingGroupRollId) {\n          LogUtil.log('interceptRollMessage - Found matching pending roll for external roll', [actor.name, matchingGroupRollId]);\n          return this._processMatchedExternalRoll(message, html, actor, uniqueId, matchingGroupRollId, roll, tokenId);\n        }\n      }\n\n      if (isFlashRollRequest && roll) {\n        this._broadcastIndividualRollComplete(actor, roll, rollType, rollKey, tokenId);\n      }\n\n      if (GeneralUtil.isModuleOn('midi-qol')) {\n        const midiRequestId = message.getFlag('midi-qol', 'requestId');\n        if (midiRequestId && game.user.isGM) {\n          const dnd5eRollType = message.flags?.dnd5e?.roll?.type;\n          if (dnd5eRollType === 'save') {\n            LogUtil.log('interceptRollMessage - Midi-QOL save roll detected, scheduling removal', [actor.name, midiRequestId]);\n            this._scheduleMidiSaveRemoval(message);\n          }\n        }\n      }\n      return;\n    }\n\n    if (!game.user.isGM && !this.groupRollMessages.has(groupRollId)) {\n      const messages = game.messages.contents;\n      const groupMessage = messages.find(m => \n        m.getFlag(MODULE_ID, 'groupRollId') === groupRollId &&\n        m.getFlag(MODULE_ID, 'isGroupRoll')\n      );\n      \n      if (groupMessage) {\n        this.groupRollMessages.set(groupRollId, groupMessage);\n        LogUtil.log('interceptRollMessage - Registered group roll message', [actor.name,groupRollId]);\n      }\n    }\n    \n    if (!this.groupRollMessages.has(groupRollId)) {\n      const messages = game.messages.contents;\n      const groupMessage = messages.find(m => \n        m.getFlag(MODULE_ID, 'groupRollId') === groupRollId &&\n        m.getFlag(MODULE_ID, 'isGroupRoll')\n      );\n      \n      if (groupMessage) {\n        LogUtil.log('interceptRollMessage - Found group message in chat log, registering', [groupRollId]);\n        this.groupRollMessages.set(groupRollId, groupMessage);\n      } else {\n        LogUtil.log('interceptRollMessage - No group message found in chat log either', [groupRollId]);\n        return;\n      }\n    }\n\n    if (!roll) return;\n\n    let rollMode = CONST.DICE_ROLL_MODES.PUBLIC;\n    if (message.blind) {\n      rollMode = CONST.DICE_ROLL_MODES.BLIND;\n    } else if (message.whisper && message.whisper.length > 0) {\n      const gmUserIds = game.users.filter(u => u.isGM).map(u => u.id);\n      const isWhisperToGMOnly = message.whisper.every(id => gmUserIds.includes(id));\n      if (isWhisperToGMOnly) {\n        rollMode = CONST.DICE_ROLL_MODES.PRIVATE;\n      }\n    }\n\n    LogUtil.log('interceptRollMessage - Message details', [\n      'message.rollMode:', message.rollMode,\n      'message.blind:', message.blind,\n      'message.whisper:', message.whisper,\n      'determined rollMode:', rollMode\n    ]);\n\n    if (html && html instanceof HTMLElement && html.style) {\n      html.style.display = 'none';\n    }\n\n    if (game.user.isGM) {\n      LogUtil.log('interceptRollMessage - Updating group message', [groupRollId, uniqueId, actor.name, roll.total, 'rollMode:', rollMode]);\n      this.updateGroupRollMessage(groupRollId, uniqueId, roll, rollMode);\n      \n      this._scheduleMessageDeletion(message.id, 'interceptRollMessage');\n    } else {\n      // Player side - don't try to update the message (no permission)\n      LogUtil.log('interceptRollMessage - Player roll intercepted, GM will handle update', [groupRollId]);\n    }\n    \n    return;\n  }\n  \n  /**\n   * Check if a request should use group messaging\n   * @param {string} requestId - Request identifier\n   * @returns {boolean} True if this is a group roll\n   */\n  static isGroupRoll(requestId) {\n    return this.pendingRolls.has(requestId) || this.groupRollMessages.has(requestId);\n  }\n\n  /**\n   * Schedule a chat message for deletion when the rollComplete hook fires.\n   * Hides the message immediately and deletes it after the hook confirms the roll was processed.\n   * @param {string} msgId - The message ID to delete\n   * @param {string} [logPrefix='scheduleMessageDeletion'] - Prefix for log messages\n   */\n  static _scheduleMessageDeletion(msgId, logPrefix = 'scheduleMessageDeletion') {\n    if (!msgId || this.messagesScheduledForDeletion.has(msgId)) {\n      return;\n    }\n    this.messagesScheduledForDeletion.add(msgId);\n\n    const hideMessage = () => {\n      const msgElement = document.querySelector(`[data-message-id=\"${msgId}\"]`);\n      if (msgElement) {\n        msgElement.style.display = 'none !important';\n        LogUtil.log(`${logPrefix} - Hidden message element`, [msgId]);\n      } else {\n        LogUtil.log(`${logPrefix} - Message element not found in DOM`, [msgId]);\n      }\n    };\n\n    hideMessage();\n    requestAnimationFrame(hideMessage);\n    setTimeout(hideMessage, 100);\n\n    const hookId = Hooks.once('flash-rolls-5e.rollComplete', async () => {\n      LogUtil.log(`${logPrefix} - rollComplete hook fired, deleting message`, [msgId]);\n      try {\n        const msgToDelete = game.messages.get(msgId);\n        if (msgToDelete) {\n          await msgToDelete.delete();\n          LogUtil.log(`${logPrefix} - Deleted individual message`, [msgId]);\n        } else {\n          LogUtil.log(`${logPrefix} - Message already deleted or not found`, [msgId]);\n        }\n      } catch (error) {\n        LogUtil.error(`${logPrefix} - Error deleting message`, [msgId, error]);\n      } finally {\n        this.messagesScheduledForDeletion.delete(msgId);\n      }\n    });\n\n    setTimeout(() => {\n      if (this.messagesScheduledForDeletion.has(msgId)) {\n        Hooks.off('flash-rolls-5e.rollComplete', hookId);\n        this.messagesScheduledForDeletion.delete(msgId);\n        LogUtil.log(`${logPrefix} - Fallback timeout, hook didn't fire`, [msgId]);\n        const msg = game.messages.get(msgId);\n        if (msg) msg.delete().catch(() => {});\n      }\n    }, 5000);\n  }\n\n  /**\n   * Find a matching pending roll request for an actor based on roll type from message.\n   * This allows intercepting rolls made from character sheets or other sources.\n   * @param {Actor} actor - The actor who made the roll\n   * @param {string} uniqueId - Token or actor ID\n   * @param {ChatMessage} message - The chat message with the roll\n   * @returns {string|null} The matching groupRollId or null\n   */\n  static _findMatchingPendingRoll(actor, uniqueId, message) {\n    const dnd5eRoll = message.flags?.dnd5e?.roll;\n    const isInitiativeRoll = message.flags?.core?.initiativeRoll;\n    if (!dnd5eRoll?.type && !isInitiativeRoll) return null;\n\n    const dndRollType = isInitiativeRoll ? 'initiative' : dnd5eRoll.type;\n    const rollKey = dnd5eRoll?.skillId || dnd5eRoll?.toolId || dnd5eRoll?.ability;\n\n    LogUtil.log('_findMatchingPendingRoll - searching', [actor.name, 'dndRollType:', dndRollType, 'rollKey:', rollKey, 'isInitiativeRoll:', isInitiativeRoll, 'pendingRolls count:', this.pendingRolls.size]);\n\n    for (const [groupRollId, pendingData] of this.pendingRolls.entries()) {\n      const actorEntry = pendingData.actorEntries?.find(entry =>\n        entry.actorId === actor.id ||\n        entry.uniqueId === uniqueId ||\n        entry.tokenId === uniqueId\n      );\n\n      if (!actorEntry) continue;\n\n      const pendingType = pendingData.rollType?.toLowerCase();\n      let matchesType = false;\n\n      if (dndRollType === 'skill' && (pendingType === ROLL_TYPES.SKILL)) {\n        matchesType = true;\n      } else if (dndRollType === 'tool' && pendingType === ROLL_TYPES.TOOL) {\n        matchesType = true;\n      } else if (dndRollType === 'ability' && (pendingType === ROLL_TYPES.ABILITY || pendingType === ROLL_TYPES.ABILITY_CHECK)) {\n        matchesType = true;\n      } else if (dndRollType === 'save' && (pendingType === ROLL_TYPES.SAVE || pendingType === ROLL_TYPES.SAVING_THROW)) {\n        matchesType = true;\n      } else if (dndRollType === 'attack' && pendingType === ROLL_TYPES.ATTACK) {\n        matchesType = true;\n      } else if (dndRollType === 'damage' && (pendingType === ROLL_TYPES.DAMAGE || pendingType === ROLL_TYPES.HEALING)) {\n        matchesType = true;\n      } else if (dndRollType === 'death' && pendingType === ROLL_TYPES.DEATH_SAVE) {\n        matchesType = true;\n      } else if (dndRollType === 'initiative' && pendingType === ROLL_TYPES.INITIATIVE) {\n        matchesType = true;\n      }\n\n      if (!matchesType) {\n        LogUtil.log('_findMatchingPendingRoll - type mismatch', [groupRollId, 'pending:', pendingType, 'dnd5e:', dndRollType]);\n        continue;\n      }\n\n      if (rollKey && pendingData.rollKey && rollKey !== pendingData.rollKey) {\n        LogUtil.log('_findMatchingPendingRoll - key mismatch', [groupRollId, 'pending:', pendingData.rollKey, 'dnd5e:', rollKey]);\n        continue;\n      }\n\n      const existingResult = pendingData.results?.get(uniqueId) || pendingData.results?.get(actor.id);\n      if (existingResult) {\n        LogUtil.log('_findMatchingPendingRoll - already rolled', [groupRollId, actor.name]);\n        continue;\n      }\n\n      LogUtil.log('_findMatchingPendingRoll - found match!', [groupRollId, actor.name]);\n      return groupRollId;\n    }\n\n    return null;\n  }\n\n  /**\n   * Process an external roll (from character sheet, macro, etc.) that matches a pending roll request.\n   * @param {ChatMessage} message - The chat message with the roll\n   * @param {HTMLElement} html - The rendered HTML element\n   * @param {Actor} actor - The actor who made the roll\n   * @param {string} uniqueId - Token or actor ID\n   * @param {string} groupRollId - The matching group roll ID\n   * @param {Roll} roll - The roll object\n   * @param {string|null} tokenId - Token ID if applicable\n   */\n  static _processMatchedExternalRoll(message, html, actor, uniqueId, groupRollId, roll, tokenId) {\n    if (!this.groupRollMessages.has(groupRollId)) {\n      const messages = game.messages.contents;\n      const groupMessage = messages.find(m =>\n        m.getFlag(MODULE_ID, 'groupRollId') === groupRollId &&\n        m.getFlag(MODULE_ID, 'isGroupRoll')\n      );\n\n      if (groupMessage) {\n        this.groupRollMessages.set(groupRollId, groupMessage);\n        LogUtil.log('_processMatchedExternalRoll - Registered group message', [groupRollId]);\n      } else {\n        LogUtil.log('_processMatchedExternalRoll - No group message found', [groupRollId]);\n        return;\n      }\n    }\n\n    let rollMode = CONST.DICE_ROLL_MODES.PUBLIC;\n    if (message.blind) {\n      rollMode = CONST.DICE_ROLL_MODES.BLIND;\n    } else if (message.whisper && message.whisper.length > 0) {\n      const gmUserIds = game.users.filter(u => u.isGM).map(u => u.id);\n      const isWhisperToGMOnly = message.whisper.every(id => gmUserIds.includes(id));\n      if (isWhisperToGMOnly) {\n        rollMode = CONST.DICE_ROLL_MODES.PRIVATE;\n      }\n    }\n\n    const htmlElement = html instanceof jQuery ? html[0] : (html?.[0] || html);\n    if (htmlElement && htmlElement.style) {\n      htmlElement.style.display = 'none';\n    }\n\n    LogUtil.log('_processMatchedExternalRoll - Updating group message', [groupRollId, uniqueId, actor.name, roll.total, 'rollMode:', rollMode]);\n    this.updateGroupRollMessage(groupRollId, uniqueId, roll, rollMode);\n\n    this._scheduleMessageDeletion(message.id, '_processMatchedExternalRoll');\n  }\n\n  /**\n   * Add groupRollId and Flash Roll metadata to message flags\n   * @param {Object} messageConfig - The message configuration object\n   * @param {Object} requestData - The request data containing the groupRollId and rollKey\n   * @param {Actor} actor - The actor performing the roll (optional, for player flag storage)\n   * @param {string} rollType - The type of roll (save, skill, ability, etc.)\n   */\n  static async addGroupRollFlag(messageConfig, requestData, actor = null, rollType = null) {\n    const SETTINGS = getSettings();\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n\n    LogUtil.log('addGroupRollFlag called', [messageConfig, requestData.groupRollId, this.isGroupRoll(requestData.groupRollId), rollType]);\n\n    if (!game.user.isGM && requestData.groupRollId && actor) {\n      await actor.setFlag(MODULE_ID, 'tempGroupRollId', requestData.groupRollId);\n      if (actor.isToken && actor.actor) {\n        await actor.actor.setFlag(MODULE_ID, 'tempGroupRollId', requestData.groupRollId);\n        LogUtil.log('addGroupRollFlag - Also stored tempGroupRollId on base actor for player', [requestData.groupRollId, actor.actor.id]);\n      }\n\n      if (!this.groupRollMessages.has(requestData.groupRollId)) {\n        const messages = game.messages.contents;\n        const groupMessage = messages.find(m =>\n          m.getFlag(MODULE_ID, 'groupRollId') === requestData.groupRollId &&\n          m.getFlag(MODULE_ID, 'isGroupRoll')\n        );\n\n        if (groupMessage) {\n          this.groupRollMessages.set(requestData.groupRollId, groupMessage);\n          LogUtil.log('addGroupRollFlag - Registered group roll message on player side', [requestData.groupRollId]);\n        }\n      }\n    }\n\n    messageConfig.data = messageConfig.data || {};\n    messageConfig.data.flags = messageConfig.data.flags || {};\n    messageConfig.data.flags[MODULE_ID] = messageConfig.data.flags[MODULE_ID] || {};\n    messageConfig.data.flags[MODULE_ID].isFlashRollRequest = true;\n    if (rollType) {\n      messageConfig.data.flags[MODULE_ID].rollType = rollType;\n    }\n    if (requestData.rollKey) {\n      messageConfig.data.flags[MODULE_ID].rollKey = requestData.rollKey;\n    }\n\n    if (groupRollsMsgEnabled && requestData.groupRollId) {\n      const shouldAddFlag = game.user.isGM ? this.isGroupRoll(requestData.groupRollId) : true;\n\n      if (shouldAddFlag) {\n        messageConfig.data.flags[MODULE_ID].groupRollId = requestData.groupRollId;\n        messageConfig.data.flags.rsr5e = { ...messageConfig.data.flags.rsr5e, processed: true, quickRoll: false};\n\n        LogUtil.log('addGroupRollFlag - Added groupRollId flag to messageConfig', [messageConfig]);\n      }\n    }\n  }\n  \n  /**\n   * Broadcast roll complete hook for individual (non-group) rolls\n   * @param {Actor} actor - The actor who rolled\n   * @param {Roll} roll - The completed roll\n   * @param {string} rollType - Type of roll (save, skill, ability, etc.)\n   * @param {string} rollKey - Roll key (ability/skill key)\n   * @param {string|null} tokenId - Token ID if applicable\n   * @private\n   */\n  static _broadcastIndividualRollComplete(actor, roll, rollType, rollKey, tokenId) {\n    if (!actor || !roll) return;\n\n    const hookData = {\n      actorUuid: actor.uuid,\n      actorId: actor.id,\n      tokenId: tokenId || null,\n      roll: roll.toJSON(),\n      total: roll.total,\n      rollType: rollType || null,\n      rollKey: rollKey || null,\n      groupRollId: null,\n      dc: null,\n      success: null\n    };\n\n    LogUtil.log('_broadcastIndividualRollComplete - Broadcasting hook', [actor.name, rollType, rollKey, roll.total]);\n    SocketUtil.execForAll(SOCKET_CALLS.broadcastRollComplete, hookData);\n  }\n\n  /**\n   * Schedule message hide and delete for midi-qol integration\n   * Hides message after 1 second, deletes shortly after\n   * @param {ChatMessage} message - The chat message to hide/delete\n   * @private\n   */\n  static _scheduleMessageRemoval(message) {\n    if (!game.user.isGM) return;\n\n    const SETTINGS = getSettings();\n    const removeSaveMsgAfterRoll = SettingsUtil.get(SETTINGS.removeSaveMsgAfterRoll.tag);\n    if (!removeSaveMsgAfterRoll) {\n      LogUtil.log('_scheduleMessageRemoval - removeSaveMsgAfterRoll disabled, skipping');\n      return;\n    }\n\n    const flagData = message.getFlag(MODULE_ID, 'rollData');\n    const midiRequestId = GeneralUtil.isModuleOn('midi-qol') ? message.getFlag('midi-qol', 'requestId') : null;\n    const fromMidiWorkflow = flagData?.fromMidiWorkflow || !!midiRequestId;\n\n    LogUtil.log('_scheduleMessageRemoval - checking', [message.id, 'rollType:', flagData?.rollType, 'fromMidiWorkflow:', fromMidiWorkflow, 'flagData.fromMidiWorkflow:', flagData?.fromMidiWorkflow, 'midiRequestId:', midiRequestId, 'full flagData:', flagData]);\n\n    if (!fromMidiWorkflow) return;\n\n    const isSaveRoll = flagData?.rollType === ROLL_TYPES.SAVE || flagData?.rollType === ROLL_TYPES.SAVING_THROW;\n    if (!isSaveRoll) return;\n\n    LogUtil.log('_scheduleMessageRemoval - Scheduling hide/delete for save message', [message.id]);\n\n    this._scheduleDelayedMessageRemoval(message.id, '_scheduleMessageRemoval');\n  }\n\n  /**\n   * Schedule removal of individual Midi-QOL save roll messages.\n   * Called when interceptRollMessage detects a save roll with midi-qol.requestId flag.\n   * @param {ChatMessage} message - The chat message to hide/delete\n   * @private\n   */\n  static _scheduleMidiSaveRemoval(message) {\n    const SETTINGS = getSettings();\n    const removeSaveMsgAfterRoll = SettingsUtil.get(SETTINGS.removeSaveMsgAfterRoll.tag);\n    if (!removeSaveMsgAfterRoll) return;\n\n    LogUtil.log('_scheduleMidiSaveRemoval - Scheduling hide/delete for Midi-QOL save message', [message.id]);\n    this._scheduleDelayedMessageRemoval(message.id, '_scheduleMidiSaveRemoval');\n  }\n\n  /**\n   * Schedule individual message hide and delete for midi-qol integration\n   * Used when group rolls are disabled\n   * @param {ChatMessage} message - The chat message to hide/delete\n   * @param {string} rollType - The type of roll\n   * @private\n   */\n  static _scheduleIndividualMessageRemoval(message, rollType) {\n    if (!game.user.isGM) return;\n\n    const SETTINGS = getSettings();\n    const removeSaveMsgAfterRoll = SettingsUtil.get(SETTINGS.removeSaveMsgAfterRoll.tag);\n    if (!removeSaveMsgAfterRoll) return;\n\n    const midiRequestId = GeneralUtil.isModuleOn('midi-qol') ? message.getFlag('midi-qol', 'requestId') : null;\n    const fromMidiWorkflow = message.getFlag(MODULE_ID, 'fromMidiWorkflow') || !!midiRequestId;\n    if (!fromMidiWorkflow) return;\n\n    const isSaveRoll = rollType === ROLL_TYPES.SAVE || rollType === ROLL_TYPES.SAVING_THROW;\n    if (!isSaveRoll) return;\n\n    LogUtil.log('_scheduleIndividualMessageRemoval - Scheduling hide/delete for individual save message', [message.id, 'midiRequestId:', midiRequestId]);\n\n    this._scheduleDelayedMessageRemoval(message.id, '_scheduleIndividualMessageRemoval');\n  }\n\n  /**\n   * Schedule message hide after 1 second and delete after 2 seconds.\n   * Used for Midi-QOL workflow where rolls are already complete.\n   * @param {string} msgId - The message ID to hide/delete\n   * @param {string} [logPrefix='scheduleDelayedMessageRemoval'] - Prefix for log messages\n   * @private\n   */\n  static _scheduleDelayedMessageRemoval(msgId, logPrefix = 'scheduleDelayedMessageRemoval') {\n    if (!msgId || this.messagesScheduledForDeletion.has(msgId)) {\n      return;\n    }\n    this.messagesScheduledForDeletion.add(msgId);\n\n    setTimeout(() => {\n      const msgElement = document.querySelector(`[data-message-id=\"${msgId}\"]`);\n      if (msgElement) {\n        msgElement.style.display = 'none';\n        LogUtil.log(`${logPrefix} - Hidden message element after 1s`, [msgId]);\n      }\n    }, 1000);\n\n    setTimeout(async () => {\n      LogUtil.log(`${logPrefix} - Deleting message after 2s`, [msgId]);\n      try {\n        const msgToDelete = game.messages.get(msgId);\n        if (msgToDelete) {\n          await msgToDelete.delete();\n          LogUtil.log(`${logPrefix} - Deleted message`, [msgId]);\n        }\n      } catch (error) {\n        LogUtil.error(`${logPrefix} - Error deleting message`, [msgId, error]);\n      } finally {\n        this.messagesScheduledForDeletion.delete(msgId);\n      }\n    }, 2000);\n  }\n\n  /**\n   * Clean up old messages and data\n   */\n  static cleanup() {\n    const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);\n    \n    for (const [requestId, message] of this.groupRollMessages.entries()) {\n      if (message.timestamp < fiveMinutesAgo) {\n        this.groupRollMessages.delete(requestId);\n        this.pendingRolls.delete(requestId);\n      }\n    }\n  }\n}","import { ROLL_TYPES, MODULE_ID } from \"../../constants/General.mjs\";\nimport { BaseActivityManager } from \"../managers/BaseActivityManager.mjs\";\nimport { RollHelpers } from \"../helpers/RollHelpers.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { CustomRollDialog } from \"../ui/dialogs/CustomRollDialog.mjs\";\nimport { NotificationManager } from \"../helpers/Helpers.mjs\";\nimport { ChatMessageManager } from \"../managers/ChatMessageManager.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\nimport { FlashAPI } from \"../core/FlashAPI.mjs\";\n\n/**\n * Methods for handling different types of rolls\n * Called from GM side or player side to fulfill the roll request\n */\nexport const RollHandlers = {\n  ability: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const dialogWillHandle = dialogConfig.configure !== false;\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      ability: requestData.rollKey\n    }, dialogWillHandle);\n\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor, ROLL_TYPES.ABILITY);\n    await actor.rollAbilityCheck(config, dialogConfig, messageConfig);\n  },\n  \n  abilitycheck: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    return RollHandlers.ability(actor, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  save: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const dialogWillHandle = dialogConfig.configure !== false;\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      ability: requestData.config?.ability || requestData.rollKey\n    }, dialogWillHandle);\n\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor, ROLL_TYPES.SAVE);\n\n    await actor.rollSavingThrow(config, dialogConfig, messageConfig);\n  },\n  \n  savingthrow: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    return RollHandlers.save(actor, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  skill: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const dialogWillHandle = dialogConfig.configure !== false;\n    const defaultAbility = actor.system.skills?.[requestData.rollKey]?.ability ||\n                          CONFIG.DND5E.skills?.[requestData.rollKey]?.ability ||\n                          undefined;\n\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      skill: requestData.rollKey,\n      chooseAbility: dialogWillHandle,\n      ability: requestData.config.ability || defaultAbility\n    }, dialogWillHandle);\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor, ROLL_TYPES.SKILL);\n    await actor.rollSkill(config, dialogConfig, messageConfig);\n  },\n\n  tool: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const dialogWillHandle = dialogConfig.configure !== false;\n    const toolConfig = actor.system.tools?.[requestData.rollKey];\n    const defaultAbility = toolConfig?.ability ||\n                          CONFIG.DND5E.enrichmentLookup?.tools?.[requestData.rollKey]?.ability ||\n                          'int';\n\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      tool: requestData.rollKey,\n      chooseAbility: dialogWillHandle,\n      ability: requestData.config.ability || defaultAbility\n    }, dialogWillHandle);\n    LogUtil.log('RollHandlers.tool #2', [config, dialogConfig, messageConfig]);\n\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor, ROLL_TYPES.TOOL);\n    await actor.rollToolCheck(config, dialogConfig, messageConfig);\n  },\n\n  concentration: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const dialogWillHandle = dialogConfig.configure !== false;\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {}, dialogWillHandle);\n\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor, ROLL_TYPES.CONCENTRATION);\n    await actor.rollConcentration(config, dialogConfig, messageConfig);\n  },\n\n  attack: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleActivityRoll(actor, ROLL_TYPES.ATTACK, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  damage: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleActivityRoll(actor, ROLL_TYPES.DAMAGE, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  itemsave: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleActivityRoll(actor, ROLL_TYPES.ITEM_SAVE, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  initiative: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    if (!game.combat) {\n      FlashAPI.notify('warn',game.i18n.localize(\"COMBAT.NoneActive\"));\n      return;\n    }\n    const situational = requestData.config.situational || rollConfig.data?.situational || '';\n    const groupRollId = requestData.groupRollId;\n\n    let tokenActor = actor;\n    if (!actor.isToken) {\n      const token = canvas.tokens.placeables.find(t => t.actor?.id === actor.id);\n      if (token) {\n        tokenActor = token.actor;\n      } else {\n        FlashAPI.notify('info',game.i18n.localize(\"FLASH_ROLLS.notifications.noTokensForInitiative\"));\n        return;\n      }\n    }\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor, ROLL_TYPES.INITIATIVE);\n\n    try {\n      if (dialogConfig.configure) {\n        LogUtil.log('RollHandlers.initiative - Dialog', []);\n        \n        if (requestData.config) {\n          const initiativeConfig = RollHelpers.buildRollConfig(requestData, rollConfig, {\n            ability: actor.system.attributes?.init?.ability || 'dex'\n          }, true);\n\n          const tempConfig = {\n            advantage: requestData.config.advantage || false,\n            disadvantage: requestData.config.disadvantage || false,\n            rollMode: requestData.config.rollMode || game.settings.get(\"core\", \"rollMode\"),\n            rolls: initiativeConfig.rolls,\n            groupRollId: requestData.groupRollId\n          };\n          await actor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n          await tokenActor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n        }\n        await tokenActor.rollInitiativeDialog();\n        await tokenActor.unsetFlag(MODULE_ID, 'tempInitiativeConfig');\n        await actor.unsetFlag(MODULE_ID, 'tempInitiativeConfig');\n\n      } else {\n        const tempConfig = {\n          rollMode: requestData.config.rollMode || game.settings.get(\"core\", \"rollMode\"),\n          groupRollId: requestData.groupRollId\n        };\n\n        await actor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n        await tokenActor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n\n        const rollOptions = {\n          createCombatants: true,\n          rerollInitiative: true\n        };\n        await tokenActor.rollInitiative(rollOptions);\n        await tokenActor.unsetFlag(MODULE_ID, 'tempInitiativeConfig');\n        await actor.unsetFlag(MODULE_ID, 'tempInitiativeConfig');\n      }\n    } catch (error) {\n      LogUtil.error('RollHandlers.initiative - Error', [error]);\n      NotificationManager.notify('error', `Initiative roll failed: ${error.message}`);\n    }\n  },\n  \n  // Alias for INITIATIVE_DIALOG\n  initiativedialog: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    return RollHandlers.initiative(actor, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  deathsave: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const dialogWillHandle = dialogConfig.configure !== false;\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {}, dialogWillHandle);\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor, ROLL_TYPES.DEATH_SAVE);\n    await actor.rollDeathSave(config, dialogConfig, messageConfig);\n  },\n\n  hitdie: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    dialogConfig.configure = game.user.isGM ? dialogConfig.configure : true;\n    const dialogWillHandle = dialogConfig.configure !== false;\n\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      denomination: requestData.rollKey\n    }, dialogWillHandle);\n    LogUtil.log('RollHandlers.hitdie', [config, dialogConfig, messageConfig]);\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor, ROLL_TYPES.HIT_DIE);\n    await actor.rollHitDie(config, dialogConfig, messageConfig);\n  },\n\n  custom: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleCustomRoll(actor, requestData, dialogConfig, messageConfig);\n  },\n\n\n  /**\n   * Handle activity-based rolls (attack, damage, item save)\n   * @param {Actor5e} actor - The actor performing the roll\n   * @param {string} rollType - The type of roll from ROLL_TYPES\n   * @param {Object} requestData - The roll request data\n   * @param {string} requestData.rollKey - The item ID\n   * @param {string} requestData.activityId - The activity ID\n   * @param {Object} requestData.config - Configuration\n   * @param {string} [requestData.config.situational] - Situational bonus formula\n   * @param {BasicRollConfiguration} rollConfig - Individual roll configuration\n   * @param {BasicRollDialogConfiguration} dialogConfig - Dialog configuration\n   * @param {BasicRollMessageConfiguration} messageConfig - Message configuration\n   * @returns {Promise<void>}\n   */\n  async handleActivityRoll(actor, rollType, requestData, rollConfig, dialogConfig, messageConfig) {\n    LogUtil.log('RollHandlers.handleActivityRoll', [rollType, requestData, rollConfig]);\n    if (requestData.rollKey) {\n      const effectiveDialogConfigure = game.user.isGM && requestData.config.skipRollDialog !== undefined\n        ? !requestData.config.skipRollDialog\n        : dialogConfig.configure;\n      const dialogWillHandle = effectiveDialogConfigure !== false;\n      const processConfig = RollHelpers.buildRollConfig(requestData, rollConfig, {}, dialogWillHandle);\n\n      const rollOptions = processConfig.rolls?.[0]?.options || {};\n      const activityConfig = {\n        usage: {\n          ...requestData.config,\n          rollType: rollType,\n          rolls: processConfig.rolls,\n          ...(rollOptions.attackMode && { attackMode: rollOptions.attackMode }),\n          ...(rollOptions.ammunition && { ammunition: rollOptions.ammunition }),\n          ...(rollOptions.mastery !== undefined && { mastery: rollOptions.mastery }),\n          ...(requestData.config.spell && { spell: requestData.config.spell }),\n          ...(requestData.config.scaling !== undefined && { scaling: requestData.config.scaling }),\n          ...(requestData.config.consume && { consume: requestData.config.consume }),\n          ...(requestData.config.create && { create: requestData.config.create })\n        },\n        dialog: {\n          ...dialogConfig,\n          configure: effectiveDialogConfigure\n        },\n        message: messageConfig\n      };\n      \n      LogUtil.log('handleActivityRoll - final activity config', [activityConfig]);\n\n      await BaseActivityManager.executeActivityRoll(\n        actor,\n        rollType,\n        requestData.rollKey,\n        requestData.activityId,\n        activityConfig\n      );\n    }\n  },\n\n  /**\n   * Handle a custom roll, creating a custom dialog\n   * @param {Actor5e} actor - The actor performing the roll\n   * @param {Object} requestData - The roll request data\n   * @param {string} requestData.rollKey - The roll formula\n   * @param {Object} requestData.config - Configuration object\n   * @param {string} [requestData.config.rollMode] - Roll visibility mode\n   * @param {string} [requestData.config.requestedBy] - Name of the requester\n   * @param {BasicRollDialogConfiguration} dialogConfig - Dialog configuration\n   * @param {BasicRollMessageConfiguration} messageConfig - Message configuration\n   * @returns {Promise<void>}\n   */\n  async handleCustomRoll(actor, requestData, dialogConfig, messageConfig) {\n    const formula = requestData.rollKey;\n    LogUtil.log('handleCustomRoll', [actor.name, 'formula:', formula, 'requestData:', requestData, 'dialogConfig:', dialogConfig]);\n\n    if (dialogConfig?.configure === false) {\n      try {\n        const roll = new Roll(formula, actor.getRollData());\n        \n        roll.options = roll.options || {};\n        roll.options.isRollRequest = requestData.config?.isRollRequest !== false;\n        \n        await roll.evaluate();\n        await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n        \n        await roll.toMessage({\n          speaker: ChatMessage.getSpeaker({actor}),\n          flavor: game.i18n.localize(`FLASH_ROLLS.rollTypes.${ROLL_TYPES.CUSTOM}`),\n          rollMode: messageConfig?.rollMode || requestData.config?.rollMode || game.settings.get(\"core\", \"rollMode\"),\n          isRollRequest: requestData.config?.isRollRequest !== false,\n          create: messageConfig?.create !== false,\n          flags: messageConfig?.data?.flags\n        });\n      } catch (error) {\n        LogUtil.error('handleCustomRoll - Roll evaluation failed', [error, 'formula:', formula]);\n        FlashAPI.notify('error',game.i18n.format(\"FLASH_ROLLS.notifications.invalidFormula\", {formula: formula}));\n      }\n      return;\n    }\n    \n    const dialog = new CustomRollDialog({\n      formula: formula,\n      readonly: true,\n      actor: actor,\n      callback: async (result) => {\n        const confirmedFormula = typeof result === 'string' ? result : result.formula;\n        const confirmedRollMode = typeof result === 'string' ? requestData.config.rollMode : (result.rollMode || requestData.config.rollMode);\n        try {\n          const roll = new Roll(confirmedFormula, actor.getRollData());\n\n          roll.options = roll.options || {};\n          roll.options.isRollRequest = true;\n\n          await roll.evaluate();\n          await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n\n          await roll.toMessage({\n            speaker: ChatMessage.getSpeaker({actor}),\n            flavor: game.i18n.localize(`FLASH_ROLLS.rollTypes.${ROLL_TYPES.CUSTOM}`),\n            rollMode: confirmedRollMode,\n            isRollRequest: true,\n            _showRequestedBy: true,\n            _requestedBy: requestData.config.requestedBy || 'GM',\n            flags: messageConfig?.data?.flags\n          });\n        } catch (error) {\n          LogUtil.error('handleCustomRoll callback - Roll failed', [error, 'formula:', confirmedFormula]);\n          FlashAPI.notify('error',game.i18n.format(\"FLASH_ROLLS.notifications.invalidFormula\", {formula: confirmedFormula}));\n        }\n      }\n    });\n    \n    dialog.render(true);\n  },\n\n  /**\n   * Handle hit die recovery (used for refilling hit dice)\n   * @param {Actor5e} actor - The actor to recover hit dice for\n   * @returns {Promise<Object>} Result object with recovery details\n   */\n  async handleHitDieRecovery(actor) {\n    const result = foundry.utils.mergeObject({\n      type: \"long\",\n      deltas: {\n        hitDice: 0\n      },\n      newDay: false,\n      rolls: [],\n      updateData: {},\n      updateItems: []\n    }, {});\n    \n    if ( \"dhd\" in result ) result.deltas.hitDice = result.dhd;\n\n    actor._getRestHitDiceRecovery({ maxHitDice: actor.system.attributes.hd.max, type: \"long\" }, result);\n\n    result.dhd = result.deltas.hitDice;\n    result.longRest = true;\n\n    try {\n      if (result.updateData && Object.keys(result.updateData).length > 0) {\n        const updateResult = await actor.update(result.updateData, { isRest: false });\n      } else {\n        LogUtil.log('No actor updates to perform', []);\n      }\n      \n      if (result.updateItems && result.updateItems.length > 0) {\n        const itemUpdateResult = await actor.updateEmbeddedDocuments(\"Item\", result.updateItems, { isRest: false });\n      } else {\n        LogUtil.log('No item updates to perform', []);\n      }\n    } catch (error) {\n      LogUtil.error('Error during updates in handleHitDieRecovery:', [error]);\n      throw error;\n    }\n\n    LogUtil.log('handleHitDieRecovery #3', [result]);\n    // Return data summarizing the rest effects\n    return result;\n  }\n};","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { NotificationManager } from './Helpers.mjs';\n\n/**\n * Ensure combat exists for initiative rolls\n * @returns {Promise<boolean>} True if combat is ready, false if cancelled\n */\nexport async function ensureCombatForInitiative() {\n  if (!game.combat) {\n    const combat = await Combat.create({scene: game.scenes.active.id});\n    await combat.activate();\n    NotificationManager.notify('info', game.i18n.localize(\"FLASH_ROLLS.notifications.combatCreated\"));\n  }\n  return game.combat;\n}\n\n/**\n * Filter actors for initiative rolls, handling re-rolls\n * @param {string[]} actorIds - Array of actor IDs to filter\n * @param {Game} game - The game instance\n * @returns {Promise<string[]>} Filtered array of actor IDs\n */\nexport async function filterActorsForInitiative(actorIds, game) {\n  if (!game.combat) return actorIds;\n  \n  const actors = actorIds\n    .map(id => game.actors.get(id))\n    .filter(actor => actor);\n  \n  const actorsNamesWithInitiative = [];\n  const actorIdsWithInitiative = new Set();\n  \n  for (const actor of actors) {\n    const combatants = game.combat.getCombatantsByActor(actor.id);\n    const hasInitiative = combatants.some(c => c.initiative !== null);\n    if (hasInitiative) {\n      actorsNamesWithInitiative.push(actor.name);\n      actorIdsWithInitiative.add(actor.id);\n    }\n  };\n  LogUtil.log('filterActorsForInitiative', [actorsNamesWithInitiative]);\n  \n  // If any actors already have initiative, confirm re-roll\n  if (actorsNamesWithInitiative.length > 0) {\n    const reroll = await foundry.applications.api.DialogV2.confirm({\n      window: {\n        title: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.rerollInitiativeTitle\"),\n        classes: [\"flash5e-dialog\"]\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      },\n      content: \"<p>\" + game.i18n.format(\"FLASH_ROLLS.ui.dialogs.rerollInitiative\", {\n        actors: actorsNamesWithInitiative.join(\", \")\n      }) + \"</p>\",\n      rejectClose: false,\n      modal: true\n    });\n    \n    if (!reroll) { \n      const filteredIds = actorIds.filter(id => !actorIdsWithInitiative.has(id));\n      if (filteredIds.length === 0) {\n        NotificationManager.notify('info', game.i18n.localize(\"FLASH_ROLLS.notifications.allActorsHaveInitiative\"));\n      }\n      \n      return filteredIds;\n    } else {\n      if (game.user.isGM) {\n        for (const actorId of actorIdsWithInitiative) {\n          const combatants = game.combat.getCombatantsByActor(actorId);\n          LogUtil.log('filterActorsForInitiative - resetting initiative for combatants', [combatants]);\n          for (const c of combatants) {\n            await c.update({ initiative: null });\n          }\n        }\n      } else {\n        LogUtil.log('filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll');\n      }\n      \n      return actorIds;\n    }\n  }\n  \n  return actorIds;\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../../constants/General.mjs\";\nimport { HOOKS_CORE } from \"../../../../constants/Hooks.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { FlashAPI } from \"../../../core/FlashAPI.mjs\";\nimport { RollHelpers } from \"../../../helpers/RollHelpers.mjs\";\n\n// Check if required D&D5e classes exist\nHooks.once(HOOKS_CORE.READY, () => {\n  if (!dnd5e.applications.dice.DamageRollConfigurationDialog) {\n    LogUtil.warn(\"DamageRollConfigurationDialog not found in dnd5e.applications.dice\");\n  }\n});\n\n/**\n * Mixin that provides GM-specific functionality for roll configuration dialogs\n * @param {Class} Base - The base dialog class to extend\n * @returns {Class} The extended class with GM functionality\n */\nexport function GMRollConfigMixin(Base) {\n  return class extends Base {\n    constructor(config = {}, message = {}, options = {}) {\n      super(config, message, options);\n      \n      this.actors = options.actors || [];\n      this.sendRequest = options.sendRequest ?? options.isRollRequest ?? false;\n      this.showDC = options.showDC || false;\n      this.dcValue = options.dcValue ?? options.dc ?? null;\n      \n      this.rollKey = options.rollKey || config.skill || config.ability || null;\n      this.rollTypeString = options.rollTypeString || null;\n      \n      this.windowTitle = options.window?.title || \"\";\n      this.windowSubtitle = options.window?.subtitle || \"\";\n    }\n    \n    /**\n     * Build a roll configuration from form data.\n     * Handles ability selection and DC values. Situational bonus is handled by parent class.\n     * @param {BasicRollConfiguration} config - Individual roll configuration from the rolls array\n     * @param {FormDataExtended} formData - Data from the dialog form\n     * @param {number} index - Index of this roll in the rolls array\n     * @returns {BasicRollConfiguration} The modified individual roll configuration\n     * @protected\n     * @override\n     */\n    _buildConfig(config, formData, index) {\n      const abilityFromForm = formData?.get(\"ability\");\n      const dcFromForm = formData?.get(\"dc\");\n\n      if (abilityFromForm) {\n        config.ability = abilityFromForm;\n        this.config.ability = abilityFromForm;\n      }\n\n      const result = super._buildConfig(config, formData, index);\n\n      if (dcFromForm) {\n        const dcValue = parseInt(dcFromForm);\n        if (!isNaN(dcValue)) {\n          result.options = result.options || {};\n          result.options.target = dcValue;\n        }\n      } else if (this.dcValue !== undefined && this.dcValue !== null) {\n        result.options = result.options || {};\n        result.options.target = this.dcValue;\n      }\n\n      LogUtil.log(`${this.constructor.name}._buildConfig`, [this.config, formData, result]);\n      return result;\n    }\n    \n    /**\n     * Handle form changes to capture GM-specific fields.\n     * @param {Object} formConfig - The form configuration object\n     * @param {Event} event - The change event\n     * @protected\n     * @override\n     */\n    _onChangeForm(formConfig, event) {\n      LogUtil.log(`_onChangeForm`, [event.target?.value]);\n      super._onChangeForm(formConfig, event);\n\n      const sendRequestCheckbox = this.element.querySelector('input[name=\"flash5e-send-request\"]');\n      if (sendRequestCheckbox) {\n        this.sendRequest = sendRequestCheckbox.checked;\n      }\n      \n      const dcInput = this.element.querySelector('input[name=\"dc\"]');\n      if (dcInput && dcInput.value) {\n        this.dcValue = parseInt(dcInput.value) || null;\n      }\n      \n    }\n    \n    /**\n     * Finalize rolls based on the action button clicked.\n     * @param {string} action - The action button that was clicked\n     * @returns {D20Roll[]} Array of finalized rolls ready for execution\n     * @protected\n     * @override\n     */\n    _finalizeRolls(action) {\n      const finalizedRolls = super._finalizeRolls(action);\n      LogUtil.log(`_finalizeRolls #1`, [finalizedRolls, this.sendRequest]);\n\n      if (this.dcValue !== undefined && this.dcValue !== null) {\n        for (const roll of finalizedRolls) {\n          roll.options.target = this.dcValue;\n        }\n      }\n\n      this.config.sendRequest = this.sendRequest;\n      const hasPC = this.actors?.some(a => RollHelpers.isPlayerOwned(a));\n      const hasNPC = this.actors?.some(a => !RollHelpers.isPlayerOwned(a));\n      this.config.skipRollDialog = RollHelpers.shouldSkipRollDialog({\n        isPC: hasPC,\n        isNPC: hasNPC,\n        sendRequest: this.sendRequest\n      });\n\n      return finalizedRolls;\n    }\n    \n    /**\n     * Handle macro button click to create a macro with current dialog configuration\n     * @param {Event} event - The click event\n     * @protected\n     */\n    async _onCreateMacroClick(event) {\n      event.preventDefault();\n      event.stopPropagation();\n      \n      LogUtil.log('_onCreateMacroClick', [this]);\n      \n      if (!this.rollTypeString) {\n        ui.notifications.error(\"Cannot create macro: roll type not defined\");\n        return;\n      }\n      \n      const formData = new foundry.applications.ux.FormDataExtended(this.form);\n      const situational = formData.get('roll.0.situational') || formData.get('rolls.0.situational') || '';\n      const dc = formData.get('dc');\n      const sendRequest = formData.get('flash5e-send-request');\n      const rollMode = formData.get('rollMode') || game.settings.get(\"core\", \"rollMode\");\n      const ability = formData.get('ability'); \n      \n      const actorIds = this.actors?.map(actor => actor.id) || [];\n      const macroData = {\n        requestType: this.rollTypeString,\n        rollKey: this.rollKey,\n        actorIds: actorIds,\n        config: {\n          ...(situational && { situationalBonus: situational }),\n          ...(dc && { dc: parseInt(dc) }),\n          ...(rollMode !== game.settings.get(\"core\", \"rollMode\") && { rollMode }),\n          ...(ability && { ability }), // Include selected ability for skill/tool rolls\n          sendAsRequest: !!sendRequest,\n          skipRollDialog: true, // Always skip roll dialog for macros\n          advantage: false, // added for users to edit if needed\n          disadvantage: false // added for users to edit if needed\n        }\n      };\n      \n      try {\n        await FlashAPI.createMacro(macroData);\n        \n        // Close the dialog after successful macro creation\n        this.close();\n      } catch (error) {\n        LogUtil.error('Failed to create macro:', [error]);\n        ui.notifications.error(`Failed to create macro: ${error.message}`);\n      }\n    }\n    \n    /**\n     * Handle post-render actions for the dialog.\n     * Triggers initial formula rebuild if there's a situational bonus.\n     * @param {ApplicationRenderContext} context - The render context.\n     * @param {HandlebarsRenderOptions} options - Rendering options.\n     * @returns {Promise<void>}\n     * @protected\n     * @override\n     */\n    async _onRender(context, options) {\n      await super._onRender(context, options);\n\n      // Apply flicker prevention if we need to rebuild\n      if (this.config.rolls?.[0]?.data?.situational || this.config.situational) {\n        LogUtil.log(`${this.constructor.name}._onRender`, ['Triggering rebuild for initial situational bonus']);\n\n        // Prevent flicker by keeping opacity during rebuild\n        if (this.element) {\n          this.element.style.transition = 'none';\n          this.element.style.opacity = '1';\n        }\n\n        // Defer rebuild to next frame\n        requestAnimationFrame(() => {\n          this.rebuild();\n\n          // Restore transitions after rebuild\n          if (this.element) {\n            requestAnimationFrame(() => {\n              this.element.style.transition = '';\n            });\n          }\n        });\n      }\n    }\n  };\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID, ROLL_TYPES } from \"../../../../constants/General.mjs\";\nimport { getSettings } from \"../../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\n\n/**\n * GM Roll Configuration Dialog\n * Extends the standard D&D5e roll configuration dialogs to add DC field and send request toggle\n */\nexport class GMRollConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.D20RollConfigurationDialog) {\n  /**\n   * Create a new GM Roll Configuration Dialog.\n   * @param {BasicRollProcessConfiguration} [config={}] - Process configuration containing rolls array of BasicRollConfiguration objects.\n   * @param {BasicRollMessageConfiguration} [message={}] - Message configuration for chat output.\n   * @param {BasicRollConfigurationDialogOptions} [options={}] - Dialog rendering options.\n   * @param {Actor[]} [options.actors] - Array of actors this roll is being made for.\n   * @param {boolean} [options.sendRequest] - Whether to send this as a roll request to players.\n   * @param {boolean} [options.showDC] - Whether to show the DC input field.\n   * @param {string} [options.rollKey] - The specific roll key (e.g., \"str\" for strength save).\n   * @param {typeof BasicRoll} [options.rollType] - The roll class to use (D20Roll, DamageRoll, etc.).\n   * @param {string} [options.rollTypeString] - The roll type as a string for identification.\n   * @param {object} [options.window] - Window configuration options.\n   * @param {string} [options.window.title] - The window title.\n   * @param {string} [options.window.subtitle] - The window subtitle.\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    options.rollType = options.rollType || CONFIG.Dice.D20Roll;\n    super(config, message, options);\n    \n    LogUtil.log('constructor - initializing GM Dialog', [config, message, options]);\n  }\n  \n  /**\n   * Default rendering options for the GM roll configuration dialog.\n   * Extends the parent's default options to add custom CSS classes.\n   * @returns {object} The default options object.\n   * @override\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Get the window title for the dialog.\n   * Uses the window title from options if provided, otherwise falls back to parent implementation.\n   * The parent class constructs the title from options.window.title or uses a default localized string.\n   * @returns {string} The localized window title\n   * @override\n   */\n  get title() {\n    return this.windowTitle || super.title;\n  }\n  \n  /**\n   * Prepare the configuration data for rendering the dialog.\n   * This method is called internally by the parent class during rendering.\n   * Extends parent to add DC and send request options. The parent method prepares\n   * advantage/disadvantage toggles, roll mode selector, and situational bonus field.\n   * @param {BasicRoll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration containing rolls array\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration with rendering options\n   * @param {BasicRollMessageConfiguration} message - Message configuration for chat output\n   * @returns {Object} The prepared configuration data for rendering with added fields:\n   *   - showDC: Whether to display the DC input field\n   *   - dcValue: The current DC value if set\n   *   - sendRequest: Whether rolls should be sent to players\n   *   - actorCount: Number of actors this roll applies to\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('_prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    data.showDC = this.showDC;\n    data.dcValue = this.dcValue;\n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare the rendering context for a specific dialog part.\n   * Adds GM-specific data like DC value and send request option to the configuration part.\n   * The parent method builds the base context for each part (\"configuration\", \"formulas\", \"buttons\").\n   * @param {string} partId - The ID of the part being prepared (\"configuration\", \"formulas\", \"buttons\")\n   * @param {ApplicationRenderContext} context - The rendering context to modify\n   * @param {HandlebarsRenderOptions} options - Options which configure application rendering behavior\n   * @returns {Promise<ApplicationRenderContext>} The modified context with GM-specific data added to configuration part:\n   *   - showDC: Whether to display the DC input field\n   *   - dcValue: The current DC value if set\n   *   - sendRequest: Whether rolls should be sent to players\n   *   - actorCount: Number of actors this roll applies to\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    LogUtil.log('_preparePartContext', [partId, context, options]);\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.showDC = this.showDC;\n      context.dcValue = this.dcValue;\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render actions for the dialog.\n   * Injects custom GM fields (DC input, send request checkbox) into the dialog after rendering.\n   * Also attaches event listeners and triggers initial formula rebuild if needed.\n   * @param {ApplicationRenderContext} context - The render context.\n   * @param {HandlebarsRenderOptions} options - Rendering options.\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    LogUtil.log('_onRender', [context, options]);\n    super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n    \n    if (configSection && (this.showDC || this.actors.length > 0)) {\n      const templateData = {\n        showDC: this.showDC,\n        dcValue: this.dcValue,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest,\n        showMacroButton: true\n      };\n      \n      // toggle and dc template\n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n\n    this._attachButtonListeners();\n  }\n  \n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', []);\n    \n    const macroButton = this.element.querySelector('.flash5e-macro-button');\n    if (macroButton) {\n      macroButton.addEventListener('click', this._onCreateMacroClick.bind(this));\n    }\n\n    // const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    // buttons.forEach(button => {\n    //   button.addEventListener('click', (event) => {\n    //     const action = event.currentTarget.dataset.action;\n    //   });\n    // });\n  }\n  \n  \n  /**\n   * Static method to create and display the GM roll configuration dialog.\n   * Creates a BasicRollProcessConfiguration and shows dialog for user configuration.\n   * @param {Actor[]|string[]} actors - Array of Actor documents or actor IDs to roll for\n   * @param {string} rollType - The type of roll (e.g., \"save\", \"ability\", \"skill\", \"tool\")\n   * @param {string} rollKey - The specific roll key (e.g., \"str\" for strength, \"athletics\" for skill)\n   * @param {Object} options - Additional options for dialog configuration\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {number} [options.dcValue] - Initial DC value\n   * @param {boolean} [options.advantage] - Whether to roll with advantage\n   * @param {boolean} [options.disadvantage] - Whether to roll with disadvantage\n   * @param {string} [options.rollMode] - Roll visibility mode\n   * @param {string} [options.situational] - Situational bonus formula\n   * @returns {Promise<BasicRollProcessConfiguration|null>} Process configuration with rolls array, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}) {\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMRollConfigDialog.initConfiguration', [rollType, rollKey, options]);\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn, options.rollMode);\n    \n    const showDC = RollHelpers.shouldShowDC(normalizedRollType);\n    const rollClass = RollHelpers.getRollClass(normalizedRollType);\n    const rollConfig = RollHelpers.createBaseRollConfig(actor, rollType, rollKey);\n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n\n    if (options.situationalBonus) {\n      rollConfig.rolls[0].data.situational = options.situationalBonus;\n    }\n\n    if (options.advantage === true) {\n      rollConfig.rolls[0].options.advantage = true;\n    } else if (options.disadvantage === true) {\n      rollConfig.rolls[0].options.disadvantage = true;\n    }\n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        showDC,\n        rollKey,\n        rollType: rollClass,  // Set the roll type class here\n        rollTypeString: normalizedRollType,  // Store the roll type string\n        window: {\n          title: GMRollConfigDialog._getRollTitle(normalizedRollType, rollKey, actor),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        position: {\n          width: 420,\n          height: \"auto\"\n        },\n        ...options\n      }\n    };\n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    \n    const rollProcessConfig = RollHelpers.processDialogResult(result, actors, rollType, rollKey, options);\n    if (!rollProcessConfig) return null;\n    \n    if (result.config?.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      const defaultAbility = actor.system.skills?.[rollKey]?.ability || CONFIG.DND5E.skills?.[rollKey]?.ability;\n      if (result.config.ability !== defaultAbility) {\n        rollProcessConfig.ability = result.config.ability;\n      }\n    }\n    \n    let finalTitle = dialogConfig.options.window.title;\n    if (result.config.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      const selectedAbilityLabel = CONFIG.DND5E.abilities[result.config.ability]?.label || result.config.ability;\n      if (normalizedRollType === ROLL_TYPES.SKILL) {\n        const skillLabel = CONFIG.DND5E.skills[rollKey]?.label || rollKey;\n        finalTitle = game.i18n.format(\"DND5E.SkillPromptTitle\", { \n          skill: skillLabel,\n          ability: selectedAbilityLabel \n        });\n      } else if (normalizedRollType === ROLL_TYPES.TOOL) {\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        let toolLabel = rollKey;\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          toolLabel = toolItem?.name || rollKey;\n        }\n        finalTitle = game.i18n.format(\"DND5E.ToolPromptTitle\", { \n          tool: toolLabel,\n          ability: selectedAbilityLabel \n        });\n      }\n    }\n    \n    rollProcessConfig.rollTitle = finalTitle;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    return rollProcessConfig;\n  }\n  \n  /**\n   * Get a formatted title for the roll type\n   * @private\n   * @param {string} rollType - The type of roll\n   * @param {string} rollKey - The specific roll key\n   * @param {Actor} actor - The actor (used to get default ability for skills)\n   * @returns {string} The formatted title\n   */\n  static _getRollTitle(rollType, rollKey, actor) {\n    let title = \"\";\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    if ([ROLL_TYPES.SAVE, ROLL_TYPES.ABILITY, ROLL_TYPES.ABILITY_CHECK].includes(normalizedRollType) && !rollKey) {\n      LogUtil.warn('Missing rollKey for roll type', [normalizedRollType, rollKey]);\n    }\n    \n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        const skillLabel = CONFIG.DND5E.skills[rollKey]?.label || rollKey;\n        const skill = actor?.system.skills?.[rollKey];\n        const defaultAbility = skill?.ability || CONFIG.DND5E.skills[rollKey]?.ability || 'int';\n        const abilityLabel = CONFIG.DND5E.abilities[defaultAbility]?.label || defaultAbility;\n        title = game.i18n.format(\"DND5E.SkillPromptTitle\", { \n          skill: skillLabel,\n          ability: abilityLabel \n        });\n        break;\n      case ROLL_TYPES.SAVE:\n      case ROLL_TYPES.SAVING_THROW:\n        const saveAbility = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        title = game.i18n.format(\"DND5E.SavePromptTitle\", { ability: saveAbility });\n        break;\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.ABILITY_CHECK:\n        const checkAbility = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        title = game.i18n.format(\"DND5E.AbilityPromptTitle\", { ability: checkAbility });\n        break;\n      case ROLL_TYPES.CONCENTRATION:\n        title = game.i18n.localize(\"DND5E.Concentration\");\n        break;\n      case ROLL_TYPES.TOOL:\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        let toolLabel = rollKey;\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          toolLabel = toolItem?.name || rollKey;\n        }\n        const tool = actor?.system.tools?.[rollKey];\n        const toolDefaultAbility = tool?.ability || CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey]?.ability || 'int';\n        const toolAbilityLabel = CONFIG.DND5E.abilities[toolDefaultAbility]?.label || toolDefaultAbility;\n        title = game.i18n.format(\"DND5E.ToolPromptTitle\", { \n          tool: toolLabel,\n          ability: toolAbilityLabel\n        });\n        break;\n      case ROLL_TYPES.DEATH_SAVE:\n        title = game.i18n.localize(\"DND5E.DeathSave\");\n        break;\n      case ROLL_TYPES.INITIATIVE: \n      case ROLL_TYPES.INITIATIVE_DIALOG: // Handle alternate case\n        title = game.i18n.localize(\"DND5E.Initiative\");\n        break;\n      default:\n        title = game.i18n.localize(\"DND5E.Roll\");\n    }\n    LogUtil.log('_getRollTitle', [normalizedRollType, title]);\n    \n    return title;\n  }\n\n  static _getSubtitle(actors = []) {\n    if (actors.length === 1) {\n      return actors[0].name;\n    } else if (actors.length > 1) {\n      return game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.multipleActors\");\n    } else {\n      return \"\";\n    }\n  }\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../../constants/General.mjs\";\nimport { getSettings } from \"../../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\n\n/**\n * GM Hit Die Configuration Dialog\n * Extends base RollConfigurationDialog for hit die rolls\n * @extends {dnd5e.applications.dice.RollConfigurationDialog}\n */\nexport class GMHitDieConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.RollConfigurationDialog) {\n  /**\n   * Creates an instance of GMHitDieConfigDialog.\n   * Configures the dialog for hit die rolls with GM-specific options.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration\n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    options.rollType = CONFIG.Dice.BasicRoll || Roll;\n    options.showDC = false;\n    \n    super(config, message, options);\n    \n    LogUtil.log('constructor', [config, message, options]);\n  }\n  \n  /**\n   * Get default options for the hit die dialog.\n   * Extends parent options to add hit die specific CSS classes.\n   * @returns {Object} Default dialog options with \"hit-die-config\" class added\n   * @static\n   * @override\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\", \"hit-die-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * Overrides the formula display to show \"Hit Die (varies by actor)\" since\n   * different actors may have different hit die sizes.\n   * @param {BasicRoll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with custom formula display\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    LogUtil.log('GMHitDieConfigDialog._prepareConfigurationData', [data]);\n    \n    data.formula = \"Hit Die (varies by actor)\";\n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare context for rendering specific dialog parts.\n   * Adds send request toggle and actor count to the configuration part.\n   * @param {string} partId - The part ID being rendered\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<ApplicationRenderContext>} Modified context\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n      context.formula = \"Hit Die (varies by actor)\";\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render tasks for the dialog.\n   * Injects the send request toggle field for GM control.\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n    \n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n    \n    if (configSection && this.actors.length > 0) {\n      const templateData = {\n        showDC: false,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest,\n        showMacroButton: true\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n\n    this._attachButtonListeners();\n  }\n  \n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', []);\n    \n    const macroButton = this.element.querySelector('.flash5e-macro-button');\n    if (macroButton) {\n      macroButton.addEventListener('click', this._onCreateMacroClick.bind(this));\n    }\n\n    // const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    // buttons.forEach(button => {\n    //   button.addEventListener('click', (event) => {\n    //     const action = event.currentTarget.dataset.action;\n    //   });\n    // });\n  }\n  /**\n   * Process form submission data.\n   * Extracts and stores send request preference from the form.\n   * @param {SubmitEvent} event - The submission event\n   * @param {HTMLFormElement} form - The form element\n   * @param {FormDataExtended} formData - Processed form data\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _processSubmitData(event, form, formData) {\n    await super._processSubmitData(event, form, formData);\n    this.sendRequest = formData.get(\"flash5e-send-request\") !== \"false\";\n    \n    LogUtil.log('_processSubmitData', [formData, this.config]);\n  }\n  \n  /**\n   * Finalize rolls based on the action button clicked.\n   * Stores the send request flag in the configuration.\n   * For hit die rolls, merge situational bonuses into the main formula.\n   * @param {string} action - The action button clicked\n   * @returns {BasicRoll[]} Array of finalized rolls\n   * @protected\n   * @override\n   */\n  _finalizeRolls(action) {\n    const finalizedRolls = super._finalizeRolls(action);\n    this.config.sendRequest = this.sendRequest;\n\n    return finalizedRolls;\n  }\n  \n  /**\n   * Static method to create and display the hit die configuration dialog.\n   * Creates appropriate hit die formulas based on each actor's available hit dice.\n   * @param {Actor[]} actors - Array of actors to roll hit dice for\n   * @param {string} rollType - The roll type (should be \"hitdie\")\n   * @param {string} rollKey - Not used for hit die rolls\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @returns {Promise<Object|null>} Configuration with rolls array and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}) {\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMHitDieConfigDialog, initConfiguration', []);\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn, options.rollMode);\n    \n    const rollConfig = {\n      data: actor.getRollData(),\n      subject: actor,\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {\n          flavor: \"Hit Die Roll\"\n        }\n      }]\n    };\n\n    if (options.situationalBonus) {\n      rollConfig.rolls[0].data.situational = options.situationalBonus;\n    }\n\n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        rollKey,\n        rollType: CONFIG.Dice.BasicRoll || Roll,\n        window: {\n          title: game.i18n.localize(\"DND5E.HitDice\"),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        position: {\n          width: 420,\n          height: \"auto\"\n        },\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    LogUtil.log('GMHitDieConfigDialog - dialog result', [result.rolls]);\n    \n    const rollProcessConfig = RollHelpers.processDialogResult(result, actors, rollType, rollKey, options);\n    if (!rollProcessConfig) return null;\n    \n    if (result.config?.ability) {\n      rollProcessConfig.ability = result.config.ability;\n    }\n    \n    return rollProcessConfig;\n  }\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID, ROLL_TYPES } from \"../../../../constants/General.mjs\";\nimport { getSettings } from \"../../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\n\n/**\n * GM Skill/Tool Configuration Dialog\n * Extends SkillToolRollConfigurationDialog for ability selection\n * @extends {dnd5e.applications.dice.SkillToolRollConfigurationDialog}\n */\nexport class GMSkillToolConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.SkillToolRollConfigurationDialog) {\n  /**\n   * Creates an instance of GMSkillToolConfigDialog.\n   * Forces ability selection and adds GM-specific options.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration  \n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   *   @param {boolean} [options.showDC=false] - Whether to show DC field\n   *   @param {number} [options.dcValue] - Initial DC value\n   *   @param {string} [options.rollKey] - The skill/tool key being rolled\n   *   @param {string} [options.rollTypeString] - Display name for the roll type\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    const skillConfig = foundry.utils.mergeObject(config, {\n      chooseAbility: true\n    });\n    options.rollType = options.rollType || CONFIG.Dice.D20Roll;\n    super(skillConfig, message, options);\n    \n    LogUtil.log('constructor', [config, message, options]);\n  }\n  \n  /**\n   * @inheritDoc\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * Extends parent to add DC and send request options.\n   * The parent handles ability selection UI for skills and tools.\n   * @param {D20Roll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with GM-specific fields added\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('_prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    // GM-specific data\n    data.showDC = this.showDC;\n    data.dcValue = this.dcValue;\n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare context for rendering specific dialog parts.\n   * Adds GM-specific context data to the configuration part.\n   * @param {string} partId - The part ID being rendered\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<ApplicationRenderContext>} Modified context\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    LogUtil.log('_preparePartContext', [partId, context, options]);\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.showDC = this.showDC;\n      context.dcValue = this.dcValue;\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render tasks for the dialog.\n   * Injects GM-specific form fields (DC and send request toggle).\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    LogUtil.log('_onRender', [context, options]);\n    super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n\n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n\n    if (configSection && (this.showDC || this.actors.length > 0)) {\n      const templateData = {\n        showDC: this.showDC,\n        dcValue: this.dcValue,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest,\n        showMacroButton: true\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n\n    this._attachButtonListeners();\n  }\n  \n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', []);\n    \n    const macroButton = this.element.querySelector('.flash5e-macro-button');\n    if (macroButton) {\n      macroButton.addEventListener('click', this._onCreateMacroClick.bind(this));\n    }\n\n    // const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    // buttons.forEach(button => {\n    //   button.addEventListener('click', (event) => {\n    //     const action = event.currentTarget.dataset.action;\n    //   });\n    // });\n  }\n  \n  /**\n   * Static method to create and display the skill/tool configuration dialog.\n   * Handles ability selection for skills and tools with GM-specific options.\n   * @param {Actor[]} actors - Array of actors to roll for\n   * @param {string} rollType - The roll type (\"skill\" or \"tool\")\n   * @param {string} rollKey - The specific skill/tool key (e.g., \"athletics\", \"thieves\")\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {number} [options.dcValue] - Initial DC value\n   * @param {string} [options.ability] - Override ability selection\n   * @returns {Promise<Object|null>} Configuration with rolls array, ability selection, and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}) {\n    // Validate and normalize actors\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMSkillToolConfigDialog.initConfiguration', [rollType, rollKey, options]);\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn, options.rollMode);\n    \n    const showDC = RollHelpers.shouldShowDC(normalizedRollType);\n    const rollClass = CONFIG.Dice.D20Roll;\n    \n    let defaultAbility = null;\n    if (normalizedRollType === ROLL_TYPES.SKILL) {\n      const skill = actor.system.skills[rollKey];\n      defaultAbility = skill?.ability || CONFIG.DND5E.skills[rollKey]?.ability || 'int';\n    } else if (normalizedRollType === ROLL_TYPES.TOOL) {\n      const tool = actor.system.tools?.[rollKey];\n      defaultAbility = tool?.ability || CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey]?.ability || 'int';\n    }\n    \n    const rollConfig = {\n      data: actor.getRollData(),\n      subject: actor,\n      ability: defaultAbility,\n      chooseAbility: true,\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n\n    if (options.situationalBonus) {\n      rollConfig.rolls[0].data.situational = options.situationalBonus;\n    }\n\n    if (options.advantage === true) {\n      rollConfig.rolls[0].options.advantage = true;\n    } else if (options.disadvantage === true) {\n      rollConfig.rolls[0].options.disadvantage = true;\n    }\n\n    if (normalizedRollType === ROLL_TYPES.SKILL) {\n      rollConfig.skill = rollKey;\n    } else if (normalizedRollType === ROLL_TYPES.TOOL) {\n      rollConfig.tool = rollKey;\n    }\n    \n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        showDC,\n        rollKey,\n        rollType: rollClass,  // Set the roll type class here\n        rollTypeString: normalizedRollType,\n        window: {\n          title: GMRollConfigDialog._getRollTitle(normalizedRollType, rollKey, actor),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        position: {\n          width: 420,\n          height: \"auto\"\n        },\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    \n    const rollProcessConfig = RollHelpers.processDialogResult(result, actors, rollType, rollKey, options);\n    if (!rollProcessConfig) return null;\n    \n    if (result.config?.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      rollProcessConfig.ability = result.config.ability;\n    }\n    \n    rollProcessConfig.rollTitle = dialogConfig.options.window.title;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    return rollProcessConfig;\n  }\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../../constants/General.mjs\";\nimport { getSettings } from \"../../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\nimport { HooksManager } from \"../../../core/HooksManager.mjs\";\n/**\n * GM Damage Roll Configuration Dialog\n * Extends DamageRollConfigurationDialog to add send request toggle\n * @extends {dnd5e.applications.dice.DamageRollConfigurationDialog}\n */\nexport class GMDamageConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.DamageRollConfigurationDialog) {\n  /**\n   * Creates an instance of GMDamageConfigDialog.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration  \n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    // Ensure the dialog is configured to show\n    const dialogConfig = foundry.utils.mergeObject({\n      configure: true\n    }, config);\n    \n    super(dialogConfig, message, options);\n    \n    LogUtil.log('GMDamageConfigDialog.constructor', [dialogConfig, message, options]);\n  }\n  \n  /**\n   * @inheritDoc\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"damage-roll\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * @param {DamageRoll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with GM-specific fields added\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('GMDamageConfigDialog._prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  \n  /**\n   * Handle initial rendering of the dialog.\n   * @param {ApplicationRenderContext} context - The render context.\n   * @param {HandlebarsRenderOptions} options - Rendering options.\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    await super._onRender(context, options);\n    \n    // Prevent dialog flicker\n    GeneralUtil.preventDialogFlicker(this.element);\n\n    // Skip if already rendered\n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n\n    GeneralUtil.preventDialogFlicker(this.element);\n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n    \n    if (configSection && (this.showDC || this.actors.length > 0)) {\n      const templateData = {\n        showDC: false,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest,\n        showMacroButton: false\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n    \n    this._attachButtonListeners();\n  }\n  \n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', []);\n    \n    const macroButton = this.element.querySelector('.flash5e-macro-button');\n    if (macroButton) {\n      macroButton.addEventListener('click', this._onCreateMacroClick.bind(this));\n    }\n\n    // const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    // buttons.forEach(button => {\n    //   button.addEventListener('click', (event) => {\n    //     const action = event.currentTarget.dataset.action;\n    //   });\n    // });\n  }\n\n  /**\n   * Static method to create and display the attack configuration dialog.\n   * SIMPLIFIED VERSION: Matches ability check pattern without attack-specific configs\n   * @param {Actor[]} actors - Array of actors to roll for\n   * @param {string} rollType - The roll type (\"attack\")\n   * @param {string} rollKey - The item ID for the attack\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {Object} originalConfig - The original roll configuration from the intercepted roll\n   * @param {Object} originalDialog - The original dialog configuration from the intercepted roll\n   * @returns {Promise<Object|null>} Configuration with rolls array and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}, originalConfig = {}, originalDialog = {}) {\n    actors = RollHelpers.validateActors(actors);\n    LogUtil.log('GMDamageConfigDialog, initConfiguration', [actors, originalConfig, originalDialog]);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    \n    // Check for stored activity configuration in cache\n    const subjectItem = originalConfig.subject?.item;\n    const actorItem = actor.items.get(rollKey);\n    const itemId = actorItem?.id || subjectItem?.id;\n    \n    let storedActivityConfig = {};\n    if (itemId) {\n      // Use the new cache getter with automatic cleanup\n      storedActivityConfig = HooksManager.getActivityConfigFromCache(itemId) || {};\n    }\n\n    LogUtil.log('GMDamageConfigDialog - retrieved activity config from cache', [itemId, storedActivityConfig]);\n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn, options.rollMode || originalConfig.rollMode);\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    const rollConfig = {\n      subject: originalConfig.subject || actor,\n      data: actor.getRollData(),\n      critical: originalConfig.critical || {},\n      rolls: originalConfig.rolls || [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n\n    if (options.situationalBonus) {\n      rollConfig.rolls[0].data.situational = options.situationalBonus;\n    }\n\n    LogUtil.log('GMDamageConfigDialog, initConfiguration #1', [rollConfig]);\n\n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    LogUtil.log('GMDamageConfigDialog, initConfiguration #2', [messageConfig]);\n    \n    const { position, ...dialogOptions } = originalDialog?.options || {}; \n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        rollKey,\n        rollType: CONFIG.Dice.DamageRoll,\n        rollTypeString: normalizedRollType,\n        window: {\n          title: game.i18n.localize(\"DND5E.DamageRoll\"),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        ...dialogOptions,\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    \n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    const firstRoll = result.rolls[0];\n    \n    const situational = firstRoll?.data?.situational || \"\";\n    const target = firstRoll?.options?.target;\n    \n    const rollProcessConfig = {\n      rolls: [{\n        parts: [],\n        data: situational ? { situational } : {},\n        options: {\n          ...(target && { target }),\n          isCritical: firstRoll?.options?.isCritical || firstRoll?.isCritical || false\n        }\n      }],\n      subject: originalConfig.subject || actor,\n      target,\n      isCritical: firstRoll?.options?.isCritical || firstRoll?.isCritical || false,\n      sendRequest: result.sendRequest,\n      isRollRequest: result.sendRequest,\n      skipRollDialog: result.config?.skipRollDialog ?? (result.sendRequest ? false : true),\n      chatMessage: true,\n      // Preserve spell slot and scaling information from activity usage\n      spell: storedActivityConfig.spell || originalConfig.spell || {},\n      scaling: storedActivityConfig.scaling !== undefined ? storedActivityConfig.scaling : originalConfig.scaling,\n      consume: storedActivityConfig.consume || originalConfig.consume || {},\n      create: storedActivityConfig.create || originalConfig.create || {}\n    };\n    LogUtil.log('GMDamageConfigDialog, initConfiguration #6', [rollProcessConfig]); \n    // await item?.unsetFlag(MODULE_ID, 'tempActivityConfig');\n    \n    const finalRollMode = RollHelpers.determineRollMode(isPublicRollsOn, result.message?.rollMode);\n    rollProcessConfig.rollMode = finalRollMode;\n    \n    rollProcessConfig.rollTitle = dialogConfig.options.window.title;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    LogUtil.log('GMDamageConfigDialog, initConfiguration - result', [rollProcessConfig]);\n    \n    return rollProcessConfig;\n  }\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../../constants/General.mjs\";\nimport { getSettings } from \"../../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\nimport { HooksManager } from \"../../../core/HooksManager.mjs\";\n\n/**\n * GM Attack Roll Configuration Dialog\n * Extends AttackRollConfigurationDialog to add send request toggle\n * @extends {dnd5e.applications.dice.AttackRollConfigurationDialog}\n */\nexport class GMAttackConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.AttackRollConfigurationDialog) {\n  /**\n   * Creates an instance of GMAttackConfigDialog.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration  \n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    super(config, message, options);\n    \n    LogUtil.log('GMAttackConfigDialog.constructor', [config, message, options]);\n  }\n  \n  /**\n   * @inheritDoc\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * @param {D20Roll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with GM-specific fields added\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('GMAttackConfigDialog._prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare context for rendering specific dialog parts.\n   * @param {string} partId - The part ID being rendered\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<ApplicationRenderContext>} Modified context\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render tasks for the dialog.\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    await super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n    \n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n    \n    if (configSection && this.actors.length > 0) {\n      const templateData = {\n        showDC: false,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest,\n        showMacroButton: false\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n    \n    this._attachButtonListeners();\n  }\n  \n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', []);\n    \n    const macroButton = this.element.querySelector('.flash5e-macro-button');\n    if (macroButton) {\n      macroButton.addEventListener('click', this._onCreateMacroClick.bind(this));\n    }\n\n    // const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    // buttons.forEach(button => {\n    //   button.addEventListener('click', (event) => {\n    //     const action = event.currentTarget.dataset.action;\n    //   });\n    // });\n  }\n  \n  /**\n   * Override _finalizeRolls to prevent re-rendering when sendRequest is toggled off\n   * @param {string} action - The action button clicked\n   * @returns {BasicRoll[]} Array of finalized rolls\n   * @protected\n   * @override\n   */\n  _finalizeRolls(action) {\n    this.config.sendRequest = this.sendRequest;\n    \n    if (!this.sendRequest && this.config.isRollRequest) {\n      this.config.isRollRequest = false;\n    }\n    \n    return super._finalizeRolls(action);\n  }\n  \n  /**\n   * Static method to create and display the attack configuration dialog.\n   * SIMPLIFIED VERSION: Matches ability check pattern without attack-specific configs\n   * @param {Actor[]} actors - Array of actors to roll for\n   * @param {string} rollType - The roll type (\"attack\")\n   * @param {string} rollKey - The item ID for the attack\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {Object} originalConfig - The original roll configuration from the intercepted roll\n   * @param {Object} originalDialog - The original dialog configuration from the intercepted roll\n   * @returns {Promise<Object|null>} Configuration with rolls array and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}, originalConfig = {}, originalDialog = {}) {\n    // Validate and normalize actors\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMAttackConfigDialog, initConfiguration', []);\n    \n    // Check for stored activity configuration in cache\n    const subjectItem = originalConfig.subject?.item;\n    const actorItem = actor.items.get(rollKey);\n    const itemId = actorItem?.id || subjectItem?.id;\n    \n    let storedActivityConfig = {};\n    if (itemId) {\n      // Use the new cache getter with automatic cleanup\n      storedActivityConfig = HooksManager.getActivityConfigFromCache(itemId) || {};\n    }\n\n    LogUtil.log('GMAttackConfigDialog - retrieved activity config from cache', [itemId, storedActivityConfig]);\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    const rollConfig = {\n      subject: originalConfig.subject || actor,\n      data: actor.getRollData(),\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n\n    if (options.situationalBonus) {\n      rollConfig.rolls[0].data.situational = options.situationalBonus;\n    }\n\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn, options.rollMode);\n\n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    \n    const { position, ...dialogOptions } = originalDialog?.options || {};\n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        rollKey,\n        rollType: CONFIG.Dice.D20Roll,\n        rollTypeString: normalizedRollType,\n        window: {\n          title: game.i18n.localize(\"DND5E.Attack\"),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        ...dialogOptions,\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    LogUtil.log('GMAttackConfigDialog, initConfiguration', [result?.sendRequest]);\n    \n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    const firstRoll = result.rolls[0];\n    let advantage = false;\n    let disadvantage = false;\n    \n    if (firstRoll?.options?.advantageMode !== undefined) {\n      advantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE;\n      disadvantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE;\n    }\n    \n    const situational = firstRoll?.data?.situational || \"\";\n    const target = firstRoll?.options?.target;\n    \n    const rollProcessConfig = {\n      rolls: [{\n        parts: [],\n        data: situational ? { situational } : {},\n        options: {\n          ...(target && { target }),\n          // Include attack-specific options from the roll\n          ...(firstRoll?.options?.ammunition && { ammunition: firstRoll.options.ammunition }),\n          ...(firstRoll?.options?.attackMode && { attackMode: firstRoll.options.attackMode }),\n          ...(firstRoll?.options?.mastery !== undefined && { mastery: firstRoll.options.mastery })\n        }\n      }],\n      subject: originalConfig.subject || actor,\n      advantage,\n      disadvantage,\n      target,\n      sendRequest: result.sendRequest,\n      isRollRequest: result.sendRequest,\n      skipRollDialog: result.config?.skipRollDialog ?? (result.sendRequest ? false : true),\n      chatMessage: !GeneralUtil.isModuleOn('midi-qol') || true,\n      // Preserve spell slot and scaling information from activity usage\n      spell: storedActivityConfig?.spell || originalConfig?.spell || {},\n      scaling: storedActivityConfig?.scaling !== undefined ? storedActivityConfig?.scaling : originalConfig?.scaling,\n      consume: storedActivityConfig?.consume || originalConfig?.consume || {},\n      create: storedActivityConfig?.create || originalConfig?.create || {}\n    };\n    // await item?.unsetFlag(MODULE_ID, 'tempActivityConfig');\n    \n    const finalRollMode = RollHelpers.determineRollMode(isPublicRollsOn, result.message?.rollMode);\n    rollProcessConfig.rollMode = finalRollMode;\n    \n    rollProcessConfig.rollTitle = dialogConfig.options.window.title;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    LogUtil.log('GMAttackConfigDialog, initConfiguration - SIMPLIFIED result', [rollProcessConfig]);\n    \n    return rollProcessConfig;\n  }\n}","import { HOOKS_DND5E } from '../../constants/Hooks.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport { SocketUtil } from '../utils/SocketUtil.mjs';\nimport { MODULE_ID, DEBUG_TAG, ROLL_TYPES, ACTIVITY_TYPES } from '../../constants/General.mjs';\nimport { GMRollConfigDialog, GMSkillToolConfigDialog, GMHitDieConfigDialog, GMDamageConfigDialog, GMAttackConfigDialog } from '../ui/dialogs/gm-dialogs/index.mjs';\nimport { RollHandlers } from './RollHandlers.mjs';\nimport { ensureCombatForInitiative, filterActorsForInitiative } from '../helpers/RollValidationHelpers.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { FlashAPI } from '../core/FlashAPI.mjs';\nimport { ModuleHelpers } from '../helpers/ModuleHelpers.mjs';\nimport { OfflinePlayerManager } from '../managers/roll-menu/OfflinePlayerManager.mjs';\nimport { RollHelpers } from '../helpers/RollHelpers.mjs';\nimport { HooksManager } from '../core/HooksManager.mjs';\nimport { DiceConfigUtil } from '../utils/DiceConfigUtil.mjs';\nimport { ChatMessageManager } from '../managers/ChatMessageManager.mjs';\nimport { DnDBIntegration } from '../integrations/dnd-beyond/DnDBIntegration.mjs';\n\n/**\n * Handles intercepting D&D5e rolls on the GM side and redirecting them to players\n */\nexport class RollInterceptor {  \n  /**\n   * @type {Set<string>} - Set of registered hook IDs for cleanup\n   */\n  static registeredHooks = new Set();\n  \n  /**\n   * Initialize the roll interceptor\n   */\n  static initialize() {\n    LogUtil.log('RollInterceptor.initialize');\n    if (!game.user.isGM) return;\n    \n    this.registerHooks();\n  }\n  \n  /**\n   * Register all necessary hooks for roll interception\n   */\n  static registerHooks() {\n    LogUtil.log('RollInterceptor.registerHooks');\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_ABILITY_CHECK, this._onPreRollIntercept.bind(this, ROLL_TYPES.ABILITY));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_SAVING_THROW, this._onPreRollIntercept.bind(this, ROLL_TYPES.SAVE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_SKILL_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.SKILL));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_TOOL_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.TOOL));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_ATTACK_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.ATTACK));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_DAMAGE_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.DAMAGE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_DEATH_SAVE_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.DEATH_SAVE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_HIT_DIE_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.HIT_DIE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_INITIATIVE, this._onPreRollInterceptInitiative.bind(this, ROLL_TYPES.INITIATIVE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_INITIATIVE_DIALOG, this._onPreRollInterceptInitiative.bind(this, ROLL_TYPES.INITIATIVE));\n  }\n  \n  /**\n   * Helper to register a hook and track it for cleanup\n   * @param {string} hookName \n   * @param {Function} handler \n   */\n  static _registerHook(hookName, handler) {\n    LogUtil.log('RollInterceptor._registerHook');\n    const hookId = Hooks.on(hookName, handler);\n    this.registeredHooks.add({ hookName, hookId });\n  }\n  \n  /**\n   * Unregister all hooks (for cleanup)\n   */\n  static unregisterHooks() {\n    LogUtil.log('RollInterceptor.unregisterHooks');\n    for (const { hookName, hookId } of this.registeredHooks) {\n      Hooks.off(hookName, hookId);\n    }\n    this.registeredHooks.clear();\n  }\n\n   /**\n   * Handle pre-roll initiative to intercept rolls\n   * @param {string} rollType - Type of roll being intercepted\n   * @param {Actor5e} actor - Actor for initiative\n   * @param {D20Roll} roll - Roll configuration object\n   * @returns {boolean|void} - Return false to prevent the roll\n   */\n  static _onPreRollInterceptInitiative(rollType, actor, roll) {\n    // LogUtil.log('_onPreRollInterceptInitiative', [rollType, actor, roll]);\n    return;\n  }\n\n  /**\n   * Handle pre-roll hooks to intercept rolls\n   * @param {string} rollType - Type of roll being intercepted\n   * @param {Object} config - Roll configuration object (or Actor for initiative)\n   * @param {Object} dialog - Dialog options\n   * @param {Object} message - Message options\n   * @returns {boolean|void} - Return false to prevent the roll\n   */\n  static _onPreRollIntercept(rollType, config, dialog, message) {\n    LogUtil.log('_onPreRollIntercept #0', [rollType, config, dialog, message]);\n    const SETTINGS = getSettings();\n    const requestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const rollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n    const isMidiOn = GeneralUtil.isModuleOn('midi-qol');\n\n    let actor;\n    if (rollType === ROLL_TYPES.INITIATIVE && config instanceof Actor) {\n      actor = config;\n    } else if (rollType === ROLL_TYPES.HIT_DIE) {\n      actor = dialog?.subject?.actor || dialog?.subject || dialog?.actor;\n    } else if (rollType === ROLL_TYPES.ATTACK || rollType === ROLL_TYPES.DAMAGE) {\n      actor = config.subject?.actor;\n    } else {\n      actor = config.subject?.actor || config.subject || config.actor;\n    }\n\n    // === External module bypass checks (keep these separate) ===\n    const ddbGameLogFlag = message?.data?.flags?.['ddb-game-log'];\n    if (ddbGameLogFlag?.cls) {\n      LogUtil.log('_onPreRollIntercept - skipping roll with ddb-game-log.cls flag (DDB roll)', [ddbGameLogFlag]);\n      return;\n    }\n\n    const flash5eFlags = message?.data?.flags?.[MODULE_ID];\n    if (flash5eFlags?.isDnDBRoll) {\n      return;\n    }\n\n    const monksTokenBarFlags = message?.data?.flags?.['monks-tokenbar'];\n    const eventTarget = config.event?.target;\n    const isMonksTokenBarButton = eventTarget?.closest?.('[data-action=\"requestRollPlusRoll\"]') ||\n                                   eventTarget?.closest?.('.monks-tokenbar') ||\n                                   eventTarget?.closest?.('.request-card');\n    if (monksTokenBarFlags || config?.options?.['monks-tokenbar'] || dialog?.options?.['monks-tokenbar'] || isMonksTokenBarButton) {\n      LogUtil.log('_onPreRollIntercept - skipping roll from Monk\\'s Token Bar', [monksTokenBarFlags, isMonksTokenBarButton]);\n      return;\n    }\n\n    if (DnDBIntegration.hasPendingRoll()) {\n      LogUtil.log('_onPreRollIntercept - skipping interception: pending DnDB roll');\n      dialog.configure = false;\n      return;\n    }\n\n    // === Calculate context for skip dialog decision ===\n    const owner = GeneralUtil.getActorOwner(actor);\n    const isOwnerActive = owner && owner?.active && !owner?.isGM;\n    const skipToRollResolver = SettingsUtil.get(SETTINGS.skipToRollResolver.tag);\n    const hasNonDigitalDice = skipToRollResolver && DiceConfigUtil.hasNonDigitalDice();\n    const isRollRequestFlag = config?.isRollRequest || dialog?.isRollRequest || message?.isRollRequest;\n\n    const shouldSkipDialog = RollHelpers.shouldSkipRollDialog({\n      event: config.event,\n      isPC: isOwnerActive,\n      isNPC: !isOwnerActive,\n      hasNonDigitalDice,\n      configSendRequest: config.sendRequest,\n      configSkipRollDialog: config.skipRollDialog,\n      isRollRequest: isRollRequestFlag\n    });\n\n    // === Handle non-interception mode (requests disabled or not intercepting) ===\n    if (!requestsEnabled || !rollInterceptionEnabled) {\n      dialog.configure = !shouldSkipDialog;\n      LogUtil.log('_onPreRollIntercept - interception disabled, dialog.configure:', [!shouldSkipDialog]);\n      return;\n    }\n\n    // === Only intercept on GM side ===\n    if (!game.user.isGM) return;\n\n    // === Skip interception if shouldSkipDialog is true ===\n    if (shouldSkipDialog) {\n      dialog.configure = false;\n      LogUtil.log('_onPreRollIntercept - skipping interception (shouldSkipDialog)', [shouldSkipDialog]);\n      return;\n    }\n\n    // === Context checks that remain in interceptor ===\n    if (isMidiOn && (owner?.isGM || !owner?.active)) return;\n\n    if (!actor || actor.documentName !== 'Actor') {\n      return;\n    }\n\n    // Attack/Damage specific: check for module flags on item\n    if (rollType === ROLL_TYPES.ATTACK || rollType === ROLL_TYPES.DAMAGE) {\n      const moduleFlags = config.subject?.item?.getFlag(MODULE_ID, 'tempAttackConfig') || config.subject?.item?.getFlag(MODULE_ID, 'tempDamageConfig');\n      if (moduleFlags) {\n        LogUtil.log('_onPreRollIntercept - found module flags, skipping interception', [moduleFlags]);\n        return;\n      }\n      if ((config.subject?.activity || config.subject?.item) && !owner?.active) {\n        LogUtil.log('_onPreRollIntercept - activity-based attack/damage roll with offline owner, skip interception', [config.subject, owner]);\n        return;\n      }\n    }\n\n    // Override rollType if this is actually an initiative roll\n    const hookNames = config?.hookNames || dialog?.hookNames || message?.hookNames || [];\n    const isInitiativeRoll = hookNames.includes('initiativeDialog') || hookNames.includes('initiative');\n    if (isInitiativeRoll && rollType === ROLL_TYPES.ABILITY) {\n      LogUtil.log('RollInterceptor._onPreRollIntercept - Overriding ability to initiative', [hookNames]);\n      rollType = ROLL_TYPES.INITIATIVE;\n    }\n\n    // Set attack rolls to public\n    if (rollType === ROLL_TYPES.ATTACK) {\n      message = { ...message, rollMode: CONST.DICE_ROLL_MODES.PUBLIC };\n    }\n\n    // Add processing flags to message\n    if (message?.data) {\n      message.data = {\n        ...message.data,\n        flags: {\n          ...message.data?.flags,\n          rsr5e: { ...message.data?.flags?.rsr5e, processed: true, quickRoll: false }\n        }\n      };\n    }\n\n    // === Show GM config dialog ===\n    LogUtil.log('_onPreRollIntercept - showing GM config dialog', [rollType, config, dialog, message]);\n    this._showGMConfigDialog(actor, owner, rollType, config, dialog, message);\n    return false;\n  }\n  /**\n   * Handle initiative-specific pre-roll checks\n   * @param {Actor} actor\n   * @returns {Promise<boolean>} true if should continue with roll\n   */\n  static async _handleInitiativePreChecks(actor) {\n    if (!game.combat) {\n      const combatReady = await ensureCombatForInitiative();\n      if (!combatReady) return false;\n    }\n    \n    const filteredActorIds = await filterActorsForInitiative([actor.id], game);\n    return filteredActorIds.length > 0;\n  }\n\n  /**\n   * Get the appropriate dialog class for a roll type\n   * @param {string} rollType\n   * @returns {Class} The dialog class to use\n   */\n  static _getDialogClass(rollType) {\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    if ([ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      return GMSkillToolConfigDialog;\n    } else if (normalizedRollType === ROLL_TYPES.HIT_DIE) {\n      return GMHitDieConfigDialog;\n    } else if (normalizedRollType === ROLL_TYPES.ATTACK) {\n      return GMAttackConfigDialog;\n    } else if (normalizedRollType === ROLL_TYPES.DAMAGE) {\n      return GMDamageConfigDialog;\n    } else {\n      return GMRollConfigDialog;\n    }\n  }\n\n  /**\n   * Extract roll key and build roll config based on roll type\n   * @param {string} rollType\n   * @param {Object} config\n   * @param {Object} dialog\n   * @param {Actor} actor\n   * @returns {Object} {rollKey, rollConfig}\n   */\n  static _extractRollConfiguration(rollType, config, dialog, actor) {\n    const normalizedRollType = rollType?.toLowerCase();\n    let rollKey = null;\n    const rollConfig = {\n      rolls: [{\n        parts: [],\n        data: {},\n        options: {}\n      }]\n    };\n\n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        rollConfig.skill = config.skill;\n        rollConfig.ability = config.ability || config.subject?.ability;\n        rollKey = rollConfig.skill;\n        break;\n        \n      case ROLL_TYPES.TOOL:\n        rollConfig.tool = config.tool;\n        rollConfig.ability = config.ability || config.subject?.ability;\n        rollKey = rollConfig.tool;\n        break;\n        \n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.SAVE:\n        rollConfig.ability = config.ability || config.subject?.ability;\n        rollKey = rollConfig.ability;\n        if (rollConfig.ability === 'con' && config.targetValue !== undefined) {\n          rollType = ROLL_TYPES.CONCENTRATION;\n        }\n        break;\n        \n      case ROLL_TYPES.CONCENTRATION:\n        rollConfig.ability = 'con';\n        rollKey = 'con';\n        break;\n        \n      case ROLL_TYPES.INITIATIVE:\n      case ROLL_TYPES.INITIATIVE_DIALOG:\n        rollKey = actor.system.attributes?.init?.ability || 'dex';\n        break;\n        \n      case ROLL_TYPES.HIT_DIE:\n        rollConfig.denomination = typeof config === 'string' ? \n          config : (config.denomination || config.subject?.denomination);\n        rollKey = rollConfig.denomination;\n        break;\n        \n      case ROLL_TYPES.ATTACK:\n        if (dialog?.options) {\n          rollConfig.ammunition = dialog.options.ammunition;\n          rollConfig.attackMode = dialog.options.attackMode;\n          rollConfig.mastery = dialog.options.mastery;\n        }\n        rollKey = config.subject?.item?.id;\n        break;\n        \n      case ROLL_TYPES.DAMAGE:\n        rollConfig.item = config.subject?.item;\n        rollConfig.subject = config.subject;\n        rollConfig.critical = config.critical || {};\n        rollKey = config.subject?.item?.id;\n        break;\n    }\n\n    return { rollKey, rollConfig };\n  }\n\n  /**\n   * Show dialog and get configuration from user\n   * @param {Class} DialogClass\n   * @param {Actor} actor\n   * @param {string} rollType\n   * @param {string} rollKey\n   * @param {boolean} skipRollDialog\n   * @param {boolean} rollRequestsEnabled\n   * @param {Object} config\n   * @param {Object} dialog\n   * @returns {Promise<Object>} Dialog result or default config\n   */\n  static async _getDialogResult(DialogClass, actor, rollType, rollKey, skipRollDialog, rollRequestsEnabled, config, dialog) {\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    LogUtil.log('_getDialogResult', [actor, rollType, rollKey, config, dialog]);\n    if (skipRollDialog) {\n      return {\n        sendRequest: true,\n        advantage: false,\n        disadvantage: false,\n        skipRollDialog: false,\n        situational: \"\",\n        rollMode: game.settings.get(\"core\", \"rollMode\")\n      };\n    }\n\n    if (!DialogClass.initConfiguration) {\n      LogUtil.error('DialogClass.initConfiguration not found', [DialogClass, DialogClass.name]);\n      throw new Error(`DialogClass ${DialogClass.name} does not have initConfiguration method`);\n    }\n    \n    const dialogOptions = {\n      skipRollDialog: false,\n      sendRequest: rollRequestsEnabled && config.isRollRequest !== false\n    };\n\n    LogUtil.log('_getDialogResult - normalizedRollType', [normalizedRollType, ROLL_TYPES.DAMAGE, ROLL_TYPES.ATTACK]);\n    if (normalizedRollType === ROLL_TYPES.ATTACK || normalizedRollType === ROLL_TYPES.DAMAGE) {\n      LogUtil.log('DialogClass.initConfiguration A', [actor, normalizedRollType, rollKey, dialogOptions, config, dialog]);\n      return await DialogClass.initConfiguration([actor], normalizedRollType, rollKey, dialogOptions, config, dialog);\n    } else {\n      LogUtil.log('DialogClass.initConfiguration B', [actor, normalizedRollType, rollKey, dialogOptions, config, dialog]);\n      return await DialogClass.initConfiguration([actor], normalizedRollType, rollKey, dialogOptions, config, dialog);\n    }\n  }\n\n  /**\n   * Show GM configuration dialog before sending roll request\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} rollType \n   * @param {Object} config \n   * @param {Object} dialog \n   * @param {Object} message \n   */\n  static async _showGMConfigDialog(actor, owner, rollType, config, dialog, message) {\n    LogUtil.log('_showGMConfigDialog - config', [rollType, dialog, config, message]);\n    const SETTINGS = getSettings();\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n\n    try {\n      const normalizedRollType = rollType?.toLowerCase();\n\n      if (normalizedRollType === ROLL_TYPES.INITIATIVE) {\n        const shouldContinue = await this._handleInitiativePreChecks(actor);\n        if (!shouldContinue) return;\n      }\n\n      const DialogClass = this._getDialogClass(rollType);\n      const { rollKey, rollConfig } = this._extractRollConfiguration(rollType, config, dialog, actor);\n      const isOwnerActive = owner && owner?.active && !owner?.isGM;\n\n      let result;\n      const shouldSkipDialog = RollHelpers.shouldSkipRollDialog({\n        event: config.event,\n        isPC: isOwnerActive,\n        isNPC: !isOwnerActive,\n        sendRequest: isOwnerActive ? rollRequestsEnabled : false\n      });\n      LogUtil.log('_showGMConfigDialog - rollConfig', [rollConfig, rollKey, shouldSkipDialog, isOwnerActive, owner]);\n      // Check if dialog should be skipped - pass rollRequestsEnabled as the sendRequest context\n      if (shouldSkipDialog) {\n        result = {\n          sendRequest: isOwnerActive ? rollRequestsEnabled : false,\n          advantage: false,\n          disadvantage: false,\n          skipRollDialog: true,\n          situational: \"\",\n          rollMode: game.settings.get(\"core\", \"rollMode\")\n        };\n      } else {\n        result = await this._getDialogResult(\n          DialogClass,\n          actor,\n          rollType,\n          rollKey,\n          shouldSkipDialog,\n          rollRequestsEnabled,\n          config,\n          dialog\n        );\n        LogUtil.log('_showGMConfigDialog - _getDialogResult', [result]);\n      }\n      \n      if (!result) {\n        LogUtil.log('_showGMConfigDialog - Dialog cancelled');\n        return;\n      }\n      \n      // If sendRequest is false, execute local roll\n      if (!result.sendRequest || !rollRequestsEnabled) {\n        LogUtil.log('_showGMConfigDialog - triggering _executeInterceptedRoll', [rollType, config, result]);\n        await this._executeInterceptedRoll(actor, rollType, config, result);\n        return;\n      }\n      \n      // Send the roll request to the player with the configured settings\n      // const { event, ...configWithoutEvent } = config;\n      delete config.event;\n      // Preserve the original subject (activity) before spreading result\n      const originalSubject = config.subject;\n      const finalConfig = {\n        ...config,\n        ...result,\n        subject: originalSubject, // Restore the original subject (activity)\n        rolls: result.rolls,\n        requestedBy: game.user.name,\n        // For attack activity rolls, prevent the usage message from being created\n        ...(rollType === ROLL_TYPES.ATTACK && { chatMessage: false })\n      };\n      \n      LogUtil.log('_showGMConfigDialog - triggering _sendRollRequest', [rollType, finalConfig]);\n      this._sendRollRequest(actor, owner, rollType, finalConfig);\n      \n    } catch (error) {\n      LogUtil.error('RollInterceptor._showGMConfigDialog - Error', [error]);\n      // Fallback: send request without configuration\n      // this._sendRollRequest(actor, owner, rollType, config);\n    }\n  }\n  \n  /**\n   * Called when an intercepted roll should be executed \n   * locally on the GM side instead of sent to player\n   * @param {Actor} actor \n   * @param {string} rollType \n   * @param {Object} originalConfig\n   * @param {Object} dialogResult\n   */\n  static async _executeInterceptedRoll(actor, rollType, originalConfig, dialogResult) {\n    LogUtil.log('RollInterceptor._executeInterceptedRoll', [actor, rollType, originalConfig, dialogResult]);\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    // Ensure we have a proper roll configuration structure\n    const rollConfig = dialogResult.rolls?.[0] || {\n      parts: [],\n      data: {},\n      options: {}\n    };\n    const situational = rollConfig.data?.situational || dialogResult.situational || \"\";\n    \n    // Determine the correct rollKey based on the roll type\n    let rollKey;\n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        rollKey = originalConfig.skill;\n        break;\n      case ROLL_TYPES.TOOL:\n        rollKey = originalConfig.tool;\n        break;\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.SAVE:\n        rollKey = originalConfig.ability || originalConfig.subject?.ability;\n        break;\n      case ROLL_TYPES.HIT_DIE:\n        rollKey = originalConfig.denomination;\n        break;\n      default:\n        rollKey = originalConfig.ability || originalConfig.skill || originalConfig.tool || originalConfig.denomination;\n    }\n    \n    const requestData = {\n      rollKey: rollKey,\n      config: {\n        advantage: dialogResult.advantage || originalConfig.advantage,\n        disadvantage: dialogResult.disadvantage || originalConfig.disadvantage,\n        target: dialogResult.target || dialogResult.dc || originalConfig.target,\n        rollMode: dialogResult.rollMode || originalConfig.rollMode,\n        situational: situational,\n        isRollRequest: false,\n        skipRollDialog: dialogResult.skipRollDialog,\n        ability: originalConfig.ability\n      }\n    };\n    \n    if (normalizedRollType === ROLL_TYPES.SKILL && !requestData.config.ability) {\n      requestData.config.ability = actor.system.skills?.[requestData.rollKey]?.ability || \n                                   CONFIG.DND5E.skills?.[requestData.rollKey]?.ability;\n    } else if (normalizedRollType === ROLL_TYPES.TOOL && !requestData.config.ability) {\n      const toolConfig = actor.system.tools?.[requestData.rollKey];\n      requestData.config.ability = toolConfig?.ability || \n                                   CONFIG.DND5E.enrichmentLookup?.tools?.[requestData.rollKey]?.ability ||\n                                   'int';\n    } else if ((normalizedRollType === ROLL_TYPES.ABILITY || normalizedRollType === ROLL_TYPES.SAVE) && !requestData.config.ability) {\n      requestData.config.ability = requestData.rollKey;\n    }\n    \n    LogUtil.log('RollInterceptor._executeInterceptedRoll - requestData', [requestData, originalConfig, dialogResult]);\n    \n    const dialogConfig = {\n      configure: false, // Skip dialog\n      isRollRequest: false\n    };\n    \n    const messageConfig = {\n      rollMode: requestData.config.rollMode,\n      create: true,\n      isRollRequest: false\n    };\n    \n    try {\n      const handlerMap = ROLL_TYPES;\n      const handler = RollHandlers[normalizedRollType];\n      \n      if (handler) {\n        // Special handling for attack and damage rolls\n        if (normalizedRollType === ROLL_TYPES.ATTACK || normalizedRollType === ROLL_TYPES.DAMAGE || normalizedRollType === ROLL_TYPES.SAVE) {\n          requestData.rollKey = originalConfig.subject?.item?.id;\n          requestData.activityId = originalConfig.subject?.id;\n          requestData.config.skipRollDialog = true;\n        }\n        \n        await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n      } else {\n        LogUtil.warn(`No handler found for roll type: ${normalizedRollType}`);\n      }\n    } catch (error) {\n      LogUtil.error(\"RollInterceptor._executeInterceptedRoll\", [error]);\n    }\n  }\n  \n  /**\n   * Send a roll request to the player\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} rollType \n   * @param {BasicRollProcessConfiguration} config - The roll process configuration\n   */\n  static async _sendRollRequest(actor, owner, rollType, config) {\n    LogUtil.log('_sendRollRequest', [actor, owner, rollType, config]);\n    const SETTINGS = getSettings();\n    let normalizedRollType = rollType?.toLowerCase();\n    const isOwnerActive = owner && owner.active && owner.id !== game.user.id;\n    \n    if (normalizedRollType === ROLL_TYPES.INITIATIVE) {\n      normalizedRollType = ROLL_TYPES.INITIATIVE_DIALOG;\n    }\n    \n    // Extract the roll key based on roll type\n    let rollKey = null;\n    let activityId = null;\n    switch (normalizedRollType) {\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.SAVE:\n        rollKey = config.ability;\n        break;\n      case ROLL_TYPES.SKILL:\n        rollKey = config.skill;\n        break;\n      case ROLL_TYPES.TOOL:\n        rollKey = config.tool;\n        break;\n      case ROLL_TYPES.ATTACK:\n      case ROLL_TYPES.DAMAGE:\n        LogUtil.log('_sendRollRequest - Attack/Damage roll config', [rollType, config]);\n        // for activities, config.subject is the activity itself\n        rollKey = config.subject.item?.id;\n        activityId = config.subject.id;\n        LogUtil.log('_sendRollRequest - resolved rollKey and activityId', [rollKey, activityId]);\n        break;\n      case ROLL_TYPES.HIT_DIE:\n        rollKey = typeof config === 'string' ? config : config.denomination;\n        break;\n      case ROLL_TYPES.INITIATIVE_DIALOG:\n      case ROLL_TYPES.INITIATIVE:\n        rollKey = null;\n        break;\n      case ROLL_TYPES.DEATH_SAVE:\n        rollKey = null;\n        break;\n      default:\n        LogUtil.warn(`Unknown roll type: ${rollType}`);\n        return;\n    }\n    \n    // Build the request data with proper rollProcessConfig\n    // Filter out circular references that midi-qol adds\n    const cleanConfig = { ...config };\n\n    if(cleanConfig.midiOptions && cleanConfig.activity && cleanConfig.activity.type === ACTIVITY_TYPES.DAMAGE){\n      LogUtil.log('_sendRollRequest - Damage activity', [cleanConfig]);\n      cleanConfig.midiOptions = {\n        ...cleanConfig.midiOptions,\n        workflowOptions: {\n          ...cleanConfig.midiOptions.workflowOptions,\n          fastForward: false,\n          fastForwardAttack: false,\n          fastForwardDamage: false,\n        }\n      };\n    }\n\n    if (rollKey && (normalizedRollType === ROLL_TYPES.ATTACK || normalizedRollType === ROLL_TYPES.DAMAGE)) {\n      const activity = config.subject;\n      const MidiQOL = game.modules.get('midi-qol')?.api;\n\n      if (MidiQOL && activity) {\n        const workflow = MidiQOL.Workflow?.getWorkflowByActivityUuid?.(activity.uuid);\n        if (workflow?.templateUuid) {\n          cleanConfig.templateUuid = workflow.templateUuid;\n          LogUtil.log('_sendRollRequest - Added templateUuid from GM workflow', [workflow.templateUuid]);\n        }\n      }\n    }\n\n    delete cleanConfig.subject;\n    delete cleanConfig.workflow;\n    delete cleanConfig.item;\n    delete cleanConfig.activity;\n\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    const useCondensedRollMessage = SettingsUtil.get(SETTINGS.useCondensedRollMessage.tag);\n    const isActivityRoll = [ROLL_TYPES.ATTACK, ROLL_TYPES.DAMAGE, ROLL_TYPES.ITEM].includes(normalizedRollType);\n    let groupRollId = null;\n\n    if (groupRollsMsgEnabled && useCondensedRollMessage && !isActivityRoll) {\n      groupRollId = foundry.utils.randomID();\n      const tokenId = actor.token?.id || canvas.tokens?.placeables.find(t => t.actor?.id === actor.id)?.id;\n      const actorEntry = {\n        actor,\n        uniqueId: tokenId || actor.id,\n        tokenId: tokenId || null\n      };\n      await ChatMessageManager.createGroupRollMessage(\n        [actorEntry],\n        normalizedRollType,\n        rollKey,\n        { ...cleanConfig, dc: cleanConfig.target },\n        groupRollId\n      );\n      LogUtil.log('_sendRollRequest - Created condensed group message', [groupRollId, actor.name]);\n    }\n\n    const requestData = {\n      type: \"rollRequest\",\n      requestId: foundry.utils.randomID(),\n      actorId: actor.id,\n      rollType: normalizedRollType,\n      rollKey,\n      activityId,\n      groupRollId,\n      rollProcessConfig: {\n        ...cleanConfig,\n        _requestedBy: game.user.name\n      },\n      skipRollDialog: false,\n      targetTokenIds: Array.from(game.user.targets).map(t => t.id),\n      preserveTargets: SettingsUtil.get(SETTINGS.useGMTargetTokens.tag),\n      fromMidiWorkflow: GeneralUtil.isMidiWorkflowActive()\n    };\n\n    LogUtil.log('_sendRollRequest - requestData', [owner, requestData, 'groupRollId:', groupRollId]);\n    \n    // Check if there's a valid active owner to send the request to\n    if (!isOwnerActive) {\n      LogUtil.log('_sendRollRequest - No valid active owner, executing locally', [owner?.name, owner?.active]);\n      // Execute roll locally since there's no player to send to\n      const defaultDialogResult = {\n        ...cleanConfig,\n        rollMode: config.rollMode || game.settings.get(\"core\", \"rollMode\"),\n        skipRollDialog: RollHelpers.shouldSkipRollDialog({isPC: false, isNPC: true, sendRequest: false})\n      };\n      await this._executeInterceptedRoll(actor, rollType, config, defaultDialogResult);\n      return;\n    }\n    \n    // Use unified offline player handling\n    const wasOffline = await OfflinePlayerManager.handleOfflinePlayer(owner, actor, rollType, config, {\n      ...config,\n      sendRequest: false \n    });\n    \n    if (wasOffline) {\n      return; // Player was offline and roll was handled\n    }\n    \n    // Owner is active, send the request\n    SocketUtil.execForUser('handleRollRequest', owner.id, requestData);\n    FlashAPI.notify('info',game.i18n.format('FLASH_ROLLS.notifications.rollRequestSent', { \n      player: owner?.name || 'Unknown',\n      actor: actor.name || 'Unknown' \n    }));\n    \n  }\n}","import { LogUtil } from '../../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { RollInterceptor } from '../../handlers/RollInterceptor.mjs';\nimport { RollHandlers } from '../../handlers/RollHandlers.mjs';\nimport { GeneralUtil } from '../../utils/GeneralUtil.mjs';\nimport { FlashAPI } from '../../core/FlashAPI.mjs';\n\n/**\n * Handles offline player detection and roll execution\n */\nexport class OfflinePlayerManager {\n  \n  /**\n   * Check if a player owner is offline and handle the roll accordingly\n   * @param {User} owner - The player owner\n   * @param {Actor} actor - The actor to roll for\n   * @param {string} rollType - The type of roll\n   * @param {Object} originalConfig - Original roll configuration\n   * @param {Object} dialogResult - Dialog result configuration\n   * @returns {boolean} - Returns true if player is offline and roll was handled, false if player is online\n   */\n  static async handleOfflinePlayer(owner, actor, rollType, originalConfig, dialogResult = null) {\n    LogUtil.log('OfflinePlayerManager.handleOfflinePlayer', [owner?.name, actor?.name, rollType]);\n\n    if (!owner || !originalConfig) {\n      FlashAPI.notify('warn', 'Flash Token Bar: No owner found for actor ' + actor.name);\n      return true;\n    }\n    \n    if (!owner.active) {\n      const SETTINGS = getSettings();\n      if (SettingsUtil.get(SETTINGS.showOfflineNotifications.tag)) {\n        FlashAPI.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.playerOffline\", {\n          player: owner.name\n        }));\n      }\n      \n      const RollInterceptorClass = RollInterceptor;\n      await RollInterceptorClass._executeInterceptedRoll(actor, rollType, originalConfig, dialogResult || {\n        ...originalConfig,\n        sendRequest: false \n      });\n\n      \n      return true; // Player was offline and roll was handled\n    }\n    \n    return false; // Player is online, continue\n  }\n  \n  /**\n   * Categorize actors by their owner's online status\n   * @param {Array} pcActors - Array of {actor, owner} objects\n   * @returns {Object} - Object with onlinePlayerActors and offlinePlayerActors arrays\n   */\n  static categorizeActorsByOnlineStatus(pcActors) {\n    const onlinePlayerActors = [];\n    const offlinePlayerActors = [];\n    \n    const actorMap = new Map();\n    for (const { actor, owner } of pcActors) {\n      if (!actorMap.has(actor.id)) {\n        actorMap.set(actor.id, { actor, owners: [] });\n      }\n      actorMap.get(actor.id).owners.push(owner);\n    }\n    \n    for (const { actor, owners } of actorMap.values()) {\n      const onlineNonGMOwner = owners.find(owner => owner.active && !owner.isGM);\n      \n      if (onlineNonGMOwner) {\n        onlinePlayerActors.push({ actor, owner: onlineNonGMOwner });\n      } else {\n        offlinePlayerActors.push(actor);\n      }\n    }\n    \n    return { onlinePlayerActors, offlinePlayerActors };\n  }\n  \n  /**\n   * Process offline actors using the unified offline handling\n   * @param {Actor[]} offlineActors - Array of actors whose owners are offline\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {Object} config - Roll configuration\n   */\n  static async processOfflineActors(offlineActors, rollMethodName, rollKey, config) {\n\n    for (const actor of offlineActors) {\n      const ownership = actor.ownership || {};\n      let owner = null;\n      \n      for (const [userId, level] of Object.entries(ownership)) {\n        if (level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER && userId !== \"default\") {\n          const potentialOwner = game.users.get(userId);\n          if (potentialOwner && !potentialOwner.isGM) {\n            owner = potentialOwner;\n            break;\n          }\n        }\n      }\n      \n      if (!owner) {\n        LogUtil.warn('OfflinePlayerManager.processOfflineActors - No owner found for actor', [actor.name]);\n        continue;\n      }\n      \n      const requestData = {\n        rollKey: rollKey,\n        groupRollId: config.groupRollId,\n        config: {\n          ...config,\n          ...(rollMethodName === 'ability' || rollMethodName === 'abilitycheck' || \n              rollMethodName === 'save' || rollMethodName === 'savingthrow' ? { ability: rollKey } : {}),\n          sendRequest: false,\n          isGroupRoll: !!config.groupRollId\n        }\n      };\n      \n      const rollConfig = {\n        parts: [],\n        data: config.situational ? { situational: config.situational } : {},\n        options: config.dc ? { target: config.dc } : {}\n      };\n      \n      const dialogConfig = {\n        configure: false,\n        isRollRequest: true\n      };\n      \n      const messageConfig = {\n        rollMode: config.rollMode || game.settings.get(\"core\", \"rollMode\"),\n        create: true,\n        isRollRequest: true,\n        groupRollId: config.groupRollId\n      };\n      \n      const handler = RollHandlers[rollMethodName.toLowerCase()];\n      if (handler) {\n        await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n      }\n      await new Promise(resolve => setTimeout(resolve, 200));\n    }\n  }\n}","import { ROLL_TYPES } from '../../../constants/General.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { LogUtil } from '../../utils/LogUtil.mjs';\nimport { GMRollConfigDialog, GMSkillToolConfigDialog, GMHitDieConfigDialog } from '../../ui/dialogs/gm-dialogs/index.mjs';\nimport { CustomRollDialog } from '../../ui/dialogs/CustomRollDialog.mjs';\nimport { RollHelpers } from '../../helpers/RollHelpers.mjs';\nimport { OfflinePlayerManager } from './OfflinePlayerManager.mjs';\n\n/**\n * Utility class for roll configuration operations in the Roll Requests Menu\n */\nexport class RollMenuConfig {\n  /**\n   * Get roll configuration from dialog or create default\n   * @param {Actor[]} actors - Actors being rolled for\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {boolean} skipRollDialog - Whether to skip dialogs\n   * @param {Array} pcActors - PC actors with owners\n   * @returns {Promise<BasicRollProcessConfiguration|null>} Process configuration or null if cancelled\n   */\n  static async getRollConfiguration(actors, rollMethodName, rollKey, skipRollDialog, pcActors, configOverrides = {}) {\n    const SETTINGS = getSettings();\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const sendAsRequest = configOverrides.hasOwnProperty('sendAsRequest') ? configOverrides.sendAsRequest : undefined;\n    const npcActors = actors.filter(actor => !pcActors.some(pc => pc.actor.id === actor.id));\n\n    const { onlinePlayerActors, offlinePlayerActors } = OfflinePlayerManager.categorizeActorsByOnlineStatus(pcActors);\n    const hasOnlinePlayers = onlinePlayerActors.length > 0;\n    const allActorsAreLocalRolls = !hasOnlinePlayers;\n\n    let confirmedSkipDialog;\n    if (configOverrides.hasOwnProperty('skipRollDialog')) {\n      confirmedSkipDialog = configOverrides.skipRollDialog;\n    } else {\n      confirmedSkipDialog = RollHelpers.shouldSkipRollDialog({\n        isPC: hasOnlinePlayers,\n        isNPC: npcActors.length > 0 || allActorsAreLocalRolls,\n        sendRequest: allActorsAreLocalRolls ? false : sendAsRequest\n      });\n    }\n\n    LogUtil.log('getRollConfiguration', [configOverrides]);\n    if (!confirmedSkipDialog && rollMethodName !== ROLL_TYPES.CUSTOM) {\n      let DialogClass;\n      if ([ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(rollMethodName)) {\n        DialogClass = GMSkillToolConfigDialog;\n      } else if (rollMethodName === ROLL_TYPES.HIT_DIE) {\n        DialogClass = GMHitDieConfigDialog;\n      } else {\n        DialogClass = GMRollConfigDialog;\n      }\n\n      const config = await DialogClass.initConfiguration(actors, rollMethodName, rollKey, {\n        confirmedSkipDialog,\n        sendRequest: rollRequestsEnabled && (sendAsRequest===true || (sendAsRequest===undefined && hasOnlinePlayers)),\n        ...configOverrides,\n        advantage: configOverrides.advantage === true,\n        disadvantage: configOverrides.disadvantage === true,\n        situationalBonus: configOverrides.situationalBonus\n      });\n      LogUtil.log('getRollConfiguration B', [config]);\n      \n\n      if (config && configOverrides.groupRollId) {\n        config.groupRollId = configOverrides.groupRollId;\n        config.isContestedRoll = configOverrides.isContestedRoll || false;\n      }\n\n      if (config && configOverrides.fromMidiWorkflow) {\n        config.fromMidiWorkflow = true;\n      }\n\n      return config;\n    } else {\n      const config = {\n        rolls: [{\n          parts: [],\n          data: configOverrides.situationalBonus ? { situational: configOverrides.situationalBonus } : {},\n          options: configOverrides.dc ? { target: configOverrides.dc } : {}\n        }],\n        advantage: configOverrides.advantage === true,\n        disadvantage: configOverrides.disadvantage === true,\n        situationalBonus: configOverrides.situationalBonus,\n        rollMode: configOverrides.rollMode || game.settings.get(\"core\", \"rollMode\"),\n        chatMessage: true,\n        isRollRequest: false,\n        skipRollDialog: confirmedSkipDialog,\n        sendRequest: rollRequestsEnabled && (configOverrides.hasOwnProperty('sendAsRequest') ? configOverrides.sendAsRequest : hasOnlinePlayers)\n      };\n\n      if (configOverrides.dc) {\n        config.target = configOverrides.dc;\n      }\n\n      if (rollMethodName === ROLL_TYPES.DEATH_SAVE) {\n        config.target = 10;\n      }\n\n      if (configOverrides.groupRollId) {\n        config.groupRollId = configOverrides.groupRollId;\n        config.isContestedRoll = configOverrides.isContestedRoll || false;\n      }\n\n      if (configOverrides.fromMidiWorkflow) {\n        config.fromMidiWorkflow = true;\n      }\n\n      return config;\n    }\n  }\n\n  /**\n   * Handle custom roll dialog\n   * @param {Object} [options={}] - Options for the dialog\n   * @param {string} [options.rollMode] - Initial roll mode\n   * @returns {Promise<{formula: string, rollMode: string}|null>} Result with formula and rollMode, or null if cancelled\n   */\n  static async handleCustomRoll(options = {}) {\n    const result = await this.showCustomRollDialog(options);\n    return result;\n  }\n\n  /**\n   * Show custom roll dialog\n   * @param {Object} [options={}] - Options for the dialog\n   * @param {string} [options.rollMode] - Initial roll mode\n   * @returns {Promise<{formula: string, rollMode: string}|null>} Result with formula and rollMode, or null if cancelled\n   */\n  static async showCustomRollDialog(options = {}) {\n    LogUtil.log('showCustomRollDialog');\n    return CustomRollDialog.prompt({\n      formula: \"\",\n      readonly: false,\n      rollMode: options.rollMode\n    });\n  }\n}","import { ROLL_TYPES } from '../../../constants/General.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { LogUtil } from '../../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { delay, NotificationManager } from '../../helpers/Helpers.mjs';\nimport { RollHandlers } from '../../handlers/RollHandlers.mjs';\nimport { RollHelpers } from '../../helpers/RollHelpers.mjs';\n\n/**\n * Utility class for executing GM rolls and local roll handling\n */\nexport class RollMenuExecutor {\n\n  /**\n   * Handle rolling for NPC actors locally\n   * @param {Actor[]} actors \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  static async handleGMRolls(actors, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('RollMenuExecutor.handleGMRolls', [actors, requestType, rollKey, rollProcessConfig]);\n    \n    for (const actor of actors) {\n      await this.initiateRoll(actor, requestType, rollKey, rollProcessConfig);\n      await delay(100);\n    }\n  }\n\n  /**\n   * Handle GM rolls with token information preserved\n   * @param {Array} actorEntries - Array of actor entries with unique IDs\n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig \n   */\n  static async handleGMRollsWithTokens(actorEntries, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('RollMenuExecutor.handleGMRollsWithTokens', [actorEntries, requestType, rollKey, rollProcessConfig]);\n    \n    for (const entry of actorEntries) {\n      if (entry.tokenId) {\n        const token = canvas.tokens?.get(entry.tokenId) || game.scenes.active?.tokens.get(entry.tokenId);\n        if (token) {\n          await this.initiateRollForToken(entry.actor, token, requestType, rollKey, rollProcessConfig);\n        } else {\n          await this.initiateRoll(entry.actor, requestType, rollKey, rollProcessConfig);\n        }\n      } else {\n        await this.initiateRoll(entry.actor, requestType, rollKey, rollProcessConfig);\n      }\n      await delay(100);\n    }\n  }\n\n  /**\n   * Execute local roll for a GM actor with token context\n   * @param {Actor} actor \n   * @param {Token} token \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  static async initiateRollForToken(actor, token, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('RollMenuExecutor.initiateRollForToken', [actor.name, token.name, requestType, rollKey, rollProcessConfig]);\n    \n    const wasControlled = token.controlled;\n    if (!wasControlled) {\n      token.control({ releaseOthers: false });\n    }\n    \n    try {\n      await this.initiateRoll(actor, requestType, rollKey, rollProcessConfig);\n    } finally {\n      if (!wasControlled) {\n        token.release();\n      }\n    }\n  }\n\n  /**\n   * Execute local roll for a GM actor\n   * @param {Actor} actor \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  static async initiateRoll(actor, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('RollMenuExecutor.initiateRoll', [actor, requestType, rollKey, rollProcessConfig]);\n    \n    try {\n      const normalizedType = requestType.toLowerCase();\n      let actualRollKey = rollKey;\n      \n      if (normalizedType === ROLL_TYPES.HIT_DIE) {\n        const hdData = actor.system.attributes.hd;\n        if(hdData.value > 0){\n          actualRollKey = hdData.largestAvailable;\n        }\n        if (!actualRollKey) {\n          LogUtil.warn('RollMenuExecutor.initiateRoll - No hit dice available after orchestration refill', [actor.name]);\n          NotificationManager.notify('warn', game.i18n.format(\"FLASH_ROLLS.notifications.noHitDice\", { \n            actor: actor.name \n          }) || `No hit dice available for ${actor.name}`);\n          return;\n        }\n      }\n      \n      const requestData = {\n        rollKey: actualRollKey,\n        groupRollId: rollProcessConfig.groupRollId,\n        config: {\n          ...rollProcessConfig,\n          rollMode: rollProcessConfig.rollMode || game.settings.get(\"core\", \"rollMode\"),\n          advantage: rollProcessConfig.advantage || false,\n          disadvantage: rollProcessConfig.disadvantage || false,\n          target: rollProcessConfig.target\n        }\n      };\n      \n      const dialogConfig = {\n        configure: !rollProcessConfig.fastForward && !rollProcessConfig.skipRollDialog,\n        isRollRequest: true\n      };\n      \n      let finalRollMode = rollProcessConfig.rollMode || game.settings.get(\"core\", \"rollMode\");\n      \n      const SETTINGS = getSettings();\n      const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n      const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag) === true;\n      \n      if ((!groupRollsMsgEnabled || !rollProcessConfig.groupRollId) && !rollProcessConfig.rollMode) {\n        if (isPublicRollsOn && actor && RollHelpers.isPlayerOwned(actor)) {\n          finalRollMode = CONST.DICE_ROLL_MODES.PUBLIC;\n        }\n      }\n      \n      const messageConfig = {\n        rollMode: finalRollMode,\n        create: rollProcessConfig.chatMessage !== false,\n        isRollRequest: true \n      };\n      \n      const rollConfig = rollProcessConfig.rolls?.[0] || {};\n      \n      LogUtil.log('RollMenuExecutor.initiateRoll - rollConfig before handler', [\n        'parts:', rollConfig.parts,\n        'data:', rollConfig.data,\n        'rollProcessConfig:', rollProcessConfig\n      ]);\n      \n      const handler = RollHandlers[normalizedType];\n      if (handler) {\n        await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n      } else {\n        NotificationManager.notify('warn', `Unknown roll type: ${requestType}`);\n      }\n    } catch (error) {\n      LogUtil.error('RollMenuExecutor.initiateRoll error', [error]);\n      NotificationManager.notify('error', game.i18n.format(\"FLASH_ROLLS.notifications.rollError\", { \n        actor: actor.name \n      }));\n    }\n  }\n}","import { MODULE, ROLL_TYPES } from '../../../constants/General.mjs';\nimport { LogUtil } from '../../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { SocketUtil } from '../../utils/SocketUtil.mjs';\nimport { delay, NotificationManager, filterActorsForDeathSaves, categorizeActorsByOwnership, getActorData } from '../../helpers/Helpers.mjs';\nimport { RollHandlers } from '../../handlers/RollHandlers.mjs';\nimport { ensureCombatForInitiative, filterActorsForInitiative } from '../../helpers/RollValidationHelpers.mjs';\nimport { ChatMessageManager } from '../ChatMessageManager.mjs';\nimport { RollMenuConfig } from './RollMenuConfig.mjs';\nimport { OfflinePlayerManager } from './OfflinePlayerManager.mjs';\nimport { RollMenuExecutor } from './RollMenuExecutor.mjs';\nimport { GeneralUtil } from '../../utils/GeneralUtil.mjs';\nimport { FlashAPI } from '../../core/FlashAPI.mjs';\n\n/**\n * Utility class for orchestrating roll requests and execution\n */\nexport class RollMenuOrchestrator {\n  \n  /**\n   * Orchestrate rolls for selected actors, handling both player requests and GM rolls\n   * @param {Object} config - Roll configuration\n   * @param {Array} pcActors - PC actors with owners\n   * @param {Actor[]} npcActors - NPC actors\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {Array} actorsData - Array of actor entries with unique IDs\n   */\n  static async orchestrateRollsForActors(config, pcActors, npcActors, rollMethodName, rollKey, actorsData) {\n    const SETTINGS = getSettings();\n    const successfulRequests = [];\n    const offlinePlayerActors = [];\n    const onlinePlayerActors = [];\n    let groupRollId = config.groupRollId || foundry.utils.randomID();\n\n    LogUtil.log('RollMenuOrchestrator.orchestrateRollsForActors', [\n      'groupRollId:', groupRollId,\n      'config.groupRollId:', config.groupRollId,\n      'config.isContestedRoll:', config.isContestedRoll,\n      'config.sendRequest:', config.sendRequest,\n      'pcActors:', pcActors.map(p => `${p.actor.name}(${p.owner?.name})`),\n      'npcActors:', npcActors.map(n => n.name)\n    ]);\n    \n    const allActorEntries = [];\n    const allActors = [];\n\n    if (config.sendRequest) {\n      // Use unified offline player categorization\n      const { onlinePlayerActors: online, offlinePlayerActors: offline } = \n        OfflinePlayerManager.categorizeActorsByOnlineStatus(pcActors);\n      \n      onlinePlayerActors.push(...online);\n      offlinePlayerActors.push(...offline);\n      \n      // Show offline notifications\n      if (offline.length > 0) {\n        const SETTINGS = getSettings();\n        if (SettingsUtil.get(SETTINGS.showOfflineNotifications.tag)) {\n          offline.forEach(actor => {\n            const owner = pcActors.find(pc => pc.actor.id === actor.id)?.owner;\n            if (owner) {\n              NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.playerOffline\", { \n                player: owner.name \n              }));\n            }\n          });\n        }\n      }\n      \n      allActors.push(...onlinePlayerActors.map(({actor}) => actor));\n    } else {\n      npcActors.push(...pcActors.map(({ actor }) => actor));\n    }\n    \n    allActors.push(...offlinePlayerActors, ...npcActors);\n    const allActorIds = allActors.map(actor => actor.id);\n    \n    allActorEntries.push(...actorsData.filter(item => \n      item && item.actor && allActorIds.includes(item.actor.id)\n    ));\n\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    const useCondensedRollMessage = SettingsUtil.get(SETTINGS.useCondensedRollMessage.tag);\n    const isMultiActorRoll = allActors.length > 1;\n\n    // Skip if groupRollId already exists (e.g., from contested rolls where the group message was already created)\n    const groupMessageAlreadyExists = groupRollId && ChatMessageManager.groupRollMessages.has(groupRollId);\n    const shouldCreateGroupMessage = groupRollsMsgEnabled && !groupMessageAlreadyExists && (isMultiActorRoll || useCondensedRollMessage || config.groupRollId);\n    if (shouldCreateGroupMessage) {\n      await ChatMessageManager.createGroupRollMessage(\n        allActorEntries,\n        rollMethodName,\n        rollKey,\n        config,\n        groupRollId\n      );\n      await delay(100);\n    }\n    \n    // Handle offline player actors AFTER creating group message\n    if (offlinePlayerActors.length > 0) {\n      config.skipRollDialog = true;\n      config.groupRollId = groupRollId; // Set group ID so rolls are included in group message\n      \n      await OfflinePlayerManager.processOfflineActors(offlinePlayerActors, rollMethodName, rollKey, config);\n    }\n\n    // Special handling for hit die rolls - check ALL actors upfront and refill if needed\n    if (rollMethodName === ROLL_TYPES.HIT_DIE) {\n      const allActorsForHitDie = [];\n      onlinePlayerActors.forEach(({actor}) => allActorsForHitDie.push(actor));\n      offlinePlayerActors.forEach(actor => allActorsForHitDie.push(actor));\n      npcActors.forEach(actor => allActorsForHitDie.push(actor));\n      \n      const refillCheckComplete = await this.handleHitDieRefill(allActorsForHitDie);\n      \n      if (!refillCheckComplete) {\n        return;\n      }\n    }\n\n    // Player Rolls: Actors owned by active players\n    for (const { actor, owner } of onlinePlayerActors) {\n      const useGroupId = groupRollsMsgEnabled && (isMultiActorRoll || useCondensedRollMessage || config.isContestedRoll) ? groupRollId : null;\n\n      LogUtil.log('orchestrateRollsForActors - Sending to player', {\n        actor: actor.name,\n        owner: owner.name,\n        useGroupId,\n        groupRollId\n      });\n\n      let currentRollKey = rollKey;\n      if (rollMethodName === ROLL_TYPES.HIT_DIE) {\n        currentRollKey = actor.system.attributes.hd.largestAvailable;\n        if (!currentRollKey) {\n          continue;\n        }\n      }\n\n      await this.sendRollRequestToPlayer(actor, owner, rollMethodName, currentRollKey, config, true, useGroupId);\n      successfulRequests.push({ actor, owner });\n      await delay(100);\n    }\n    if (successfulRequests.length > 0) {\n      this.showConsolidatedNotification(successfulRequests, rollMethodName, rollKey);\n    }\n    \n    // Handle NPC actors using traditional GM rolls\n    if (npcActors.length > 0) {\n      config.skipRollDialog = true;\n      config.groupRollId = (groupRollsMsgEnabled && (isMultiActorRoll || useCondensedRollMessage || config.isContestedRoll)) ? groupRollId : null;\n\n      const npcActorIds = npcActors.map(actor => actor.id);\n      const npcActorEntries = actorsData.filter(entry =>\n        entry && entry.actor && npcActorIds.includes(entry.actor.id)\n      );\n\n      await RollMenuExecutor.handleGMRollsWithTokens(npcActorEntries, rollMethodName, rollKey, config);\n    }\n  }\n\n  /**\n   * Handle hit die refill dialog for actors with no available hit dice\n   * @param {Actor|Actor[]} actors - Single actor or array of actors to potentially refill hit dice for\n   * @returns {Promise<boolean>} True if refill succeeded or not needed, false if cancelled\n   */\n  static async handleHitDieRefill(actorsToRefill) {\n    const actors = Array.isArray(actorsToRefill) ? actorsToRefill : [actorsToRefill];\n    \n    const actorsNeedingRefill = actors.filter(actor => {\n      const hdData = actor.system.attributes.hd;\n      const needsRefill = hdData.value === 0;\n      return needsRefill;\n    });\n    \n    if (actorsNeedingRefill.length === 0) {\n      return true; // No refill needed\n    }\n    \n    const actorNames = actorsNeedingRefill.map(actor => actor.name).join(\", \");\n    \n    // Show dialog to GM\n    const dialogResult = await foundry.applications.api.DialogV2.confirm({\n      window: {\n        title: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillTitle\") || \"No Hit Dice Available\",\n        classes: [\"flash5e-hit-die-dialog\"]\n      },\n      position: {\n        width: 420\n      },\n      content: `<p>${game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refillMessage\", { \n        actors: actorNames \n      }) || \"\"}</p>`,\n      modal: true,\n      rejectClose: false,\n      yes: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend\") || \"Refill & Send\",\n        icon: \"\"\n      },\n      no: {\n        label: game.i18n.localize(\"Cancel\") || \"Cancel\",\n        icon: \"\"\n      }\n    });\n    \n    if (dialogResult) {\n      for (const actor of actorsNeedingRefill) {\n        try {\n          const hitDieResult = await RollHandlers.handleHitDieRecovery(actor);\n          \n          // If this is a token actor, also update the base actor to keep them in sync\n          if (actor.isToken && actor._actor) {\n            try {\n              await RollHandlers.handleHitDieRecovery(actor._actor);\n            } catch (baseActorError) {\n              LogUtil.error('Error updating base actor:', [baseActorError]);\n            }\n          }\n        } catch (error) {\n          LogUtil.error('Error calling handleHitDieRecovery:', [error]);\n        }\n      }\n      \n      NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refilled\", { \n        actor: actorNames \n      }) || `Hit dice refilled for ${actorNames}`);\n      \n      return true;\n    }\n    \n    return false;\n  }\n\n  /**\n   * Method called from menu items to trigger the roll for selected actors\n   * @param {string} requestType - The type of roll request (e.g., 'skill', 'ability')\n   * @param {string} rollKey - The specific roll key (e.g., 'acr' for Acrobatics)\n   * @param {RollRequestsMenu} menu - Menu instance for accessing properties and methods\n   * @param {Object} [config={}] - Optional configuration overrides\n   * @param {boolean} [config.skipRollDialog] - Override skip roll dialog setting\n   * @param {number} [config.dc] - Difficulty Class for the roll\n   * @param {string} [config.situationalBonus] - Situational bonus\n   * @param {boolean} [config.advantage] - Roll with advantage\n   * @param {boolean} [config.disadvantage] - Roll with disadvantage\n   * @param {boolean} [config.sendAsRequest] - Send to players instead of rolling locally\n   * @param {string} [config.groupRollId] - Group roll identifier for combining multiple rolls\n   * @param {boolean} [config.isContestedRoll] - Whether this is part of a contested roll\n   */\n  static async triggerRoll(requestType, rollKey, menu, config = {}) {\n    const SETTINGS = getSettings();\n    const selectedUniqueIds = Array.from(menu.selectedActors);\n    const skipRollDialog = config.skipRollDialog !== undefined ? config.skipRollDialog : SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n    \n    let actorsData = selectedUniqueIds\n      .map(uniqueId => {\n        const actor = getActorData(uniqueId);\n        if (!actor) return null;\n        \n        let tokenId = null;\n        if (game.actors.get(uniqueId)) {\n          tokenId = null;\n        } else {\n          tokenId = uniqueId;\n        }\n        \n        return { actor, uniqueId, tokenId };\n      })\n      .filter(item => item);\n    \n    let actors = actorsData.map(item => item.actor);\n    \n    const rollOption = MODULE.ROLL_REQUEST_OPTIONS[requestType];\n    const rollMethodName = (rollOption?.name || requestType)?.toLowerCase();\n\n    const originalRollKey = rollKey;\n    rollKey = await this.handleSpecialRollTypes(rollMethodName, rollKey, selectedUniqueIds, actorsData, actors, menu, config);\n    if (rollKey === null && originalRollKey !== null) {\n      return;\n    }\n    \n    if (!actors.length) {\n      NotificationManager.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n      return;\n    }\n    \n    const { pcActors, npcActors } = categorizeActorsByOwnership(actors);\n    const rollConfig = await RollMenuConfig.getRollConfiguration(actors, rollMethodName, rollKey, skipRollDialog, pcActors, config);\n    LogUtil.log('RollMenuOrchestrator.triggerRoll', [rollConfig]);\n    \n    if (!rollConfig) return;\n    \n    await this.orchestrateRollsForActors(rollConfig, pcActors, npcActors, rollMethodName, rollKey, actorsData);\n    \n    if (!menu?.isLocked && typeof menu?.close === 'function') {\n      setTimeout(() => menu.close(), 500);\n    }\n  }\n\n  /**\n   * Handle special roll types that require additional processing\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {Array} selectedUniqueIds - Selected actor unique IDs\n   * @param {Array} actorsData - Actor data array (modified by reference)\n   * @param {Array} actors - Actors array (modified by reference)\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @param {Object} config - Config object (modified by reference for custom rolls)\n   * @returns {Promise<string|null>} Modified rollKey or null if cancelled\n   */\n  static async handleSpecialRollTypes(rollMethodName, rollKey, selectedUniqueIds, actorsData, actors, menu, config = {}) {\n    const SETTINGS = getSettings();\n\n    switch(rollMethodName) {\n      case ROLL_TYPES.CUSTOM:\n        if (!rollKey) {\n          const customResult = await RollMenuConfig.handleCustomRoll({ rollMode: config.rollMode });\n          if (!customResult) return null;\n          rollKey = customResult.formula;\n          if (customResult.rollMode) {\n            config.rollMode = customResult.rollMode;\n          }\n        }\n        break;\n        \n      case ROLL_TYPES.INITIATIVE:\n      case ROLL_TYPES.INITIATIVE_DIALOG:\n        const result = await this.handleInitiativeRoll(selectedUniqueIds, actorsData, actors);\n        if (!result.success) return null;\n        // actorsData and actors are modified by reference\n        \n        const initiateCombat = SettingsUtil.get(SETTINGS.initiateCombatOnRequest.tag);\n        if (initiateCombat) {\n          game.combat.startCombat();\n        }\n        break;\n        \n      case ROLL_TYPES.DEATH_SAVE:\n        const filteredActors = await filterActorsForDeathSaves(actors);\n        actors.length = 0;\n        actors.push(...filteredActors);\n        actorsData = actorsData.filter(item => filteredActors.includes(item.actor));\n        break;\n        \n      case ROLL_TYPES.HIT_DIE:\n        const characterActors = actors.filter(actor => actor.type === 'character');\n        if (characterActors.length === 0) {\n          NotificationManager.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noCharactersForHitDie\") || \n            \"Hit dice can only be rolled for player characters, not NPCs.\");\n          return null;\n        }\n        actors.length = 0;\n        actors.push(...characterActors);\n        actorsData = actorsData.filter(item => item.actor.type === 'character');\n        break;\n    }\n    \n    return rollKey;\n  }\n\n  /**\n   * Handle initiative roll processing\n   * @param {Array} selectedUniqueIds - Selected actor unique IDs\n   * @param {Array} actorsData - Actor data array (modified by reference)\n   * @param {Array} actors - Actors array (modified by reference)\n   * @returns {Promise<{success: boolean}>} Success status\n   */\n  static async handleInitiativeRoll(selectedUniqueIds, actorsData, actors) {\n    const combatReady = await ensureCombatForInitiative();\n    if (!combatReady) return { success: false };\n    \n    const actorsWithoutTokens = [];\n    const actorsWithTokens = [];\n    \n    for (const uniqueId of selectedUniqueIds) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n      \n      let tokenId = null;\n      \n      if (!game.actors.get(uniqueId)) {\n        tokenId = uniqueId;\n        actorsWithTokens.push(actor.name);\n      } else {\n        tokenId = actor.getActiveTokens()?.[0]?.id || null;\n        if (!tokenId) {\n          actorsWithoutTokens.push(actor.name);\n          continue;\n        }\n        actorsWithTokens.push(actor.name);\n        \n        const existingCombatant = game.combat.combatants.find(c => c.tokenId === tokenId);\n        if (!existingCombatant) {\n          await game.combat.createEmbeddedDocuments(\"Combatant\", [{\n            actorId: actor.id,\n            tokenId: tokenId\n          }]);\n        }\n      }\n    }\n    \n    if (actorsWithTokens.length === 0) {\n      // ui.notifications.warn(game.i18n.localize(\"FLASH_ROLLS.notifications.noTokensForInitiative\"));\n      return { success: false };\n    }\n    \n    if (actorsWithoutTokens.length > 0) {\n      FlashAPI.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.actorsSkippedInitiative\", {\n        actors: actorsWithoutTokens.join(\", \")\n      }) || `Initiative skipped for actors without tokens: ${actorsWithoutTokens.join(\", \")}`);\n    }\n    \n    const entriesWithTokens = actorsData.filter(entry => {\n      if (entry.tokenId) return true;\n      const hasToken = entry.actor.getActiveTokens()?.[0];\n      return !!hasToken;\n    });\n    \n    actorsData.length = 0;\n    actorsData.push(...entriesWithTokens);\n    \n    actors = entriesWithTokens.map(entry => entry.actor);\n    const uniqueActorIds = [...new Set(actors.map(actor => actor.id))];\n    const filteredActorIds = await filterActorsForInitiative(uniqueActorIds, game);\n\n    if (!filteredActorIds.length) return { success: false };\n\n    const filteredActorsData = actorsData.filter(item => \n      item && item.actor && filteredActorIds.includes(item.actor.id)\n    );\n    \n    actors.length = 0;\n    actors.push(...filteredActorIds.map(id => game.actors.get(id)).filter(actor => actor));\n    \n    actorsData.length = 0;\n    actorsData.push(...filteredActorsData);\n    \n    return { success: true };\n  }\n\n  /**\n   * Send a roll request to a player\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} config - Roll configuration from dialog\n   * @param {boolean} suppressNotification - If true, don't show individual notification\n   * @param {string} groupRollId - Optional group roll ID for multi-actor rolls\n   */\n  static async sendRollRequestToPlayer(actor, owner, requestType, rollKey, config, suppressNotification = false, groupRollId = null) {\n    const SETTINGS = getSettings();\n    \n    let rollType = requestType?.toLowerCase();\n    \n    // Mapping for compound types\n    if (rollType === ROLL_TYPES.ABILITY_CHECK) {\n      rollType = ROLL_TYPES.ABILITY;\n    } else if (rollType === ROLL_TYPES.SAVING_THROW) {\n      rollType = ROLL_TYPES.SAVE;\n    } else if (rollType === ROLL_TYPES.INITIATIVE_DIALOG) {\n      rollType = ROLL_TYPES.INITIATIVE;\n    }\n    \n    // For hit die rolls, get the largest available denomination\n    if (rollType === ROLL_TYPES.HIT_DIE) {\n      rollKey = actor.system.attributes.hd.largestAvailable;\n      if (!rollKey) {\n        LogUtil.warn(`No hit dice available for ${actor.name}.`);\n        return;\n      }\n    }\n    \n    // Build the request data with proper rollProcessConfig\n    const cleanConfig = { ...config };\n    delete cleanConfig.subject;\n    delete cleanConfig.workflow;\n    delete cleanConfig.item;\n    delete cleanConfig.activity;\n    \n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag) === true;\n\n    if (!cleanConfig.rollMode) {\n      const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n      if (isPublicRollsOn) {\n        cleanConfig.rollMode = CONST.DICE_ROLL_MODES.PUBLIC;\n      }\n    }\n    \n    const requestData = {\n      type: \"rollRequest\",\n      groupRollId: groupRollId,\n      actorId: actor.isToken ? actor.token.id : actor.id,\n      isTokenActor: actor.isToken,\n      baseActorId: actor.isToken ? actor._actor?.id : actor.id,\n      rollType,\n      rollKey,\n      activityId: null,\n      rollProcessConfig: {\n        ...cleanConfig,\n        _requestedBy: game.user.name\n      },\n      skipRollDialog: config.skipRollDialog || false,\n      targetTokenIds: Array.from(game.user.targets).map(t => t.id),\n      preserveTargets: SettingsUtil.get(SETTINGS.useGMTargetTokens.tag),\n      fromMidiWorkflow: config.fromMidiWorkflow ?? false\n    };\n\n    LogUtil.log('RollMenuOrchestrator.sendRollRequestToPlayer - sending request', {\n      actor: actor.name,\n      owner: owner.name,\n      groupRollId: requestData.groupRollId\n    });\n    SocketUtil.execForUser('handleRollRequest', owner.id, requestData);\n    \n    if (!suppressNotification) {\n      NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.rollRequestSent\", { \n        player: owner.name,\n        actor: actor.name \n      }));\n    }\n  }\n\n  /**\n   * Send a consolidated notification for multiple roll requests\n   * @param {Array} successfulRequests - Array of {actor, owner} objects\n   * @param {string} rollMethodName - The type of roll being requested\n   * @param {string} rollKey - The specific roll key (if applicable)\n   */\n  static showConsolidatedNotification(successfulRequests, rollMethodName, rollKey) {\n    const requestsByPlayer = {};\n    for (const { actor, owner } of successfulRequests) {\n      if (!requestsByPlayer[owner.id]) {\n        requestsByPlayer[owner.id] = {\n          player: owner,\n          actors: []\n        };\n      }\n      requestsByPlayer[owner.id].actors.push(actor);\n    }\n    \n    // Get roll type name for display\n    let rollTypeName = game.i18n.localize(`FLASH_ROLLS.rollTypes.${rollMethodName}`) || rollMethodName;\n    \n    if (rollKey) {\n      const normalizedRollTypeKey = rollMethodName.toLowerCase();\n      if (normalizedRollTypeKey === ROLL_TYPES.SKILL) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.skills[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.SAVING_THROW) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.ABILITY_CHECK) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.TOOL) {\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          rollTypeName = `${rollTypeName} (${toolItem?.name || rollKey})`;\n        } else {\n          rollTypeName = `${rollTypeName} (${rollKey})`;\n        }\n      } else if (normalizedRollTypeKey === ROLL_TYPES.CUSTOM) {\n        rollTypeName = `${rollTypeName}: ${rollKey}`;\n      }\n    }\n    \n    // Use NotificationManager for consolidated roll request notifications\n    NotificationManager.notifyRollRequestsSent(requestsByPlayer, rollTypeName);\n  }\n}","import { getSettings } from \"../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport RollRequestsMenu from \"../ui/RollRequestsMenu.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\n\n/**\n * Utility class for managing sidebar controls\n */\nexport class SidebarController {\n  /**\n   * Add the roll request bolt icon to sidebar\n   * @param {SidebarTab} app - The sidebar tab application\n   * @param {jQuery} html - The rendered HTML\n   */\n  static addSidebarControls(app, html) {\n    LogUtil.log(\"addSidebarControls\",[app, html]);\n    if (!game.user.isGM || !app || app.id !== \"sidebar\") return;\n    \n    const chatControls = document.querySelector(\"#roll-privacy\");\n\n    if (!chatControls || chatControls.querySelector('.flash-rolls-icon')) {\n      return;\n    }\n    \n    const SETTINGS = getSettings();\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    \n    const rollRequestIcon = document.createElement('button');\n    rollRequestIcon.id = \"flash-rolls-icon\"; \n    rollRequestIcon.setAttribute(\"data-tooltip-direction\", \"RIGHT\");\n    rollRequestIcon.className = `ui-control icon chat-control-icon flash-rolls-icon${rollRequestsEnabled ? ' active' : ''}`;\n    rollRequestIcon.title = game.i18n.localize('FLASH_ROLLS.ui.menus.rollRequestsTitle');\n    rollRequestIcon.innerHTML = `<i class=\"fas fa-bolt${rollRequestsEnabled ? '' : '-slash'}\"></i>`;\n    \n    const firstChatControlIcon = chatControls.firstChild;\n    if (firstChatControlIcon) {\n      firstChatControlIcon.parentNode.insertBefore(rollRequestIcon, firstChatControlIcon);\n    } else {\n      chatControls.insertBefore(rollRequestIcon, chatControls.firstChild);\n    }\n\n    LogUtil.log(\"addSidebarControls\",[firstChatControlIcon, rollRequestIcon]);\n    \n    rollRequestIcon.addEventListener(\"click\", (event) => {\n      event.stopPropagation();\n      event.preventDefault();\n      RollRequestsMenu.toggle();\n    });\n  }\n  \n  /**\n   * Update the roll requests icon based on enabled state\n   * @param {boolean} enabled - Whether roll requests are enabled\n   */\n  static updateRollRequestsIcon(enabled) {\n    const icon = document.querySelector('#flash-rolls-icon i');\n    if (icon) {\n      icon.className = `fas fa-bolt${enabled ? '' : '-slash'}`;\n    }\n  }\n}","import { isPlayerOwned, hasTokenInScene } from '../helpers/Helpers.mjs';\nimport { LogUtil } from './LogUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SettingsUtil } from './SettingsUtil.mjs';\n\n/**\n * Utility class for actor-related operations in the Roll Requests Menu\n */\nexport class RollMenuActorUtil {\n  /**\n   * Get formatted stats for an actor\n   * @param {Actor} actor - The actor to get stats for\n   * @returns {Array<{abbrev: string, value: number}>} Array of stat objects\n   */\n  static getActorStats(actor) {\n    const SETTINGS = getSettings();\n    const statsToShow = SettingsUtil.get(SETTINGS.actorStatsToShow.tag) || { hp: true, ac: true, dc: true, prc: true };\n    const system = actor.system;\n    const stats = [];\n\n    if (statsToShow.hp && system.attributes?.hp) {\n      stats.push({\n        abbrev: 'HP',\n        value: system.attributes.hp.value\n      });\n    }\n\n    if (statsToShow.ac && system.attributes?.ac) {\n      stats.push({\n        abbrev: 'AC',\n        value: system.attributes.ac.value\n      });\n    }\n\n    if (statsToShow.dc) {\n      const spellDC = system.attributes?.spell?.dc;\n      if (spellDC) {\n        stats.push({\n          abbrev: 'DC',\n          value: spellDC\n        });\n      }\n    }\n\n    if (statsToShow.prc && system.skills?.prc?.passive) {\n      stats.push({\n        abbrev: 'PRC',\n        value: system.skills.prc.passive\n      });\n    }\n\n    return stats;\n  }\n\n  /**\n   * Get HP percentage and color for an actor\n   * @param {Actor} actor - The actor to get HP data for\n   * @returns {{hpPercent: number, hpColor: string}} HP percentage and color\n   */\n  static getActorHPData(actor) {\n    const hp = actor.system.attributes?.hp;\n    if (!hp || !hp.max) {\n      return { hpPercent: 100, hpColor: 'var(--fr5e-color-hp-high)' };\n    }\n    \n    const hpPercent = Math.round((hp.value / hp.max) * 100);\n    const hpColor = hpPercent > 50 ? 'var(--fr5e-color-hp-high)' : 'var(--fr5e-color-hp-low)';\n    \n    return { hpPercent, hpColor };\n  }\n\n  /**\n   * Get valid actor IDs based on current tab\n   * @param {Array<string>} selectedActorIds - Array of selected actor IDs\n   * @param {string} currentTab - Current tab ('pc' or 'npc')\n   * @returns {Array<string>} Filtered array of valid actor IDs\n   */\n  static getValidActorIds(selectedActorIds, currentTab) {\n    return selectedActorIds.filter(actorId => {\n      const actor = game.actors.get(actorId);\n      if (!actor) return false;\n      const isPC = isPlayerOwned(actor);\n      const isNPC = !isPC && hasTokenInScene(actor);\n      \n      return (currentTab === 'pc' && isPC) || (currentTab === 'npc' && isNPC);\n    });\n  }\n}","import { MODULE } from '../../../constants/General.mjs';\nimport { LogUtil } from '../../utils/LogUtil.mjs';\nimport { adjustMenuOffset } from '../../helpers/Helpers.mjs';\nimport { GeneralUtil } from '../../utils/GeneralUtil.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\n\n/**\n * Handles drag and positioning of the Roll Requests Menu\n */\nexport class RollMenuDragManager {\n  static SNAP_DISTANCE = 50; // pixels\n  static DRAG_HANDLE_SELECTOR = '.drag-handle';\n  static LIGHTNING_BOLT_SELECTOR = '#flash-rolls-icon';\n  \n  /**\n   * Initialize drag functionality for the menu\n   * @param {RollRequestsMenu} menu - The menu instance\n   * @deprecated Use direct event listener attachment in _onRender instead\n   */\n  static initializeDrag(menu) {\n    const dragHandle = menu.element.querySelector(this.DRAG_HANDLE_SELECTOR);\n    \n    if (!dragHandle) {\n      LogUtil.error('RollMenuDragManager.initializeDrag - No drag handle found!');\n      return;\n    }\n    \n    dragHandle.addEventListener('mousedown', (e) => {\n      this.handleDragStart(e, menu);\n    });\n  }\n  \n  /**\n   * Handle drag start\n   * @param {MouseEvent} event\n   * @param {RollRequestsMenu} menu\n   */\n  static async handleDragStart(event, menu) {\n    const SETTINGS = getSettings();\n    const lockMenuPosition = SettingsUtil.get(SETTINGS.lockMenuPosition.tag);\n\n    if (lockMenuPosition && menu.isLocked) {\n      event.preventDefault();\n      event.stopPropagation();\n      return;\n    }\n\n    event.preventDefault();\n    event.stopPropagation();\n\n    menu.isDragging = true;\n    if(!menu.element){return}\n    menu.element.classList.add('dragging');\n    \n    const startX = event.clientX;\n    const startY = event.clientY;\n    \n    // Check if we're dragging from bottom dock before making any changes\n    const isDockedBottom = menu.element.classList.contains('docked-bottom');\n    const isDraggedFromBottomDock = menu.element.parentElement?.id === 'ui-bottom';\n    \n    // Remove docked classes when starting drag\n    menu.element.classList.remove('docked-right', 'docked-bottom', 'faded-ui');\n    \n    // Force layout recalculation by accessing offsetHeight\n    menu.element.offsetHeight;\n    \n    const menuRect = menu.element.getBoundingClientRect();\n    let initialLeft = menuRect.left;\n    let initialTop = startY;//menuRect.top;\n    \n    // If dragging from bottom dock, adjust position to keep cursor over drag handle\n    if (isDraggedFromBottomDock) {\n      const dragHandle = menu.element.querySelector(this.DRAG_HANDLE_SELECTOR);\n      if (dragHandle) {\n        const handleRect = dragHandle.getBoundingClientRect();\n        const handleCenterOffset = (handleRect.left - menuRect.left) + (handleRect.width / 2);\n        initialLeft = startX - handleCenterOffset;\n      } else {\n        initialLeft = startX - (menuRect.width / 2);\n      }\n      initialTop = startY; //menuRect.top;\n    }\n    \n    const parent = menu.element.parentElement;\n    document.body.appendChild(menu.element);\n    menu.element.style.position = 'fixed';\n    menu.element.style.inset = '';  // Clear inset first\n    menu.element.style.transform = ''; // Clear any transform from docked-bottom\n    menu.element.style.top = `${initialTop}px`;\n    menu.element.style.left = `${initialLeft}px`;\n    menu.element.style.right = 'auto';\n    menu.element.style.bottom = 'auto';\n    menu.element.style.zIndex = 'var(--z-index-app)'; // Ensure it's on top while dragging\n    \n    menu.element.offsetHeight;\n    \n    const dragData = {\n      startX,\n      startY,\n      initialLeft,\n      initialTop,\n      currentLeft: initialLeft,\n      currentTop: initialTop\n    };\n    \n    const handleMove = (e) => this.handleDragMove(e, menu, dragData);\n    const handleUp = (e) => this.handleDragEnd(e, menu, dragData, handleMove, handleUp);\n    \n    document.addEventListener('mousemove', handleMove);\n    document.addEventListener('mouseup', handleUp);\n  }\n  \n  /**\n   * Handle drag move\n   * @param {MouseEvent} event \n   * @param {RollRequestsMenu} menu \n   * @param {Object} dragData \n   */\n  static handleDragMove(event, menu, dragData) {\n    if (!menu.isDragging || !menu.element) return;\n    const deltaX = event.clientX - dragData.startX;\n    const deltaY = event.clientY - dragData.startY;\n    \n    dragData.currentLeft = dragData.initialLeft + deltaX;\n    dragData.currentTop = dragData.initialTop + deltaY;\n    \n    menu.element.style.inset = '';\n    menu.element.style.right = 'auto';\n    menu.element.style.bottom = 'auto';\n    \n    menu.element.style.position = 'fixed';\n    menu.element.style.top = `${dragData.currentTop}px`;\n    menu.element.style.left = `${dragData.currentLeft}px`;\n    \n    const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize) * 15;\n    if (dragData.currentLeft < remInPixels) {\n      menu.element.classList.add('left-edge');\n    } else {\n      menu.element.classList.remove('left-edge');\n    }\n    \n    const isHorizontalLayout = menu.element.hasAttribute('data-layout') && \n                              menu.element.getAttribute('data-layout') === 'horizontal';\n    if (isHorizontalLayout) {\n      if (dragData.currentTop < 400) {\n        menu.element.classList.add('top-edge');\n      } else {\n        menu.element.classList.remove('top-edge');\n      }\n    } else {\n      menu.element.classList.remove('top-edge');\n    }\n    \n    const computed = window.getComputedStyle(menu.element);\n\n    const snapInfo = this.calculateSnapDistance(menu);\n    \n    const currentSnapType = menu.element.classList.contains('near-snap-both') ? 'both-edges' :\n                           menu.element.classList.contains('near-snap-right') ? 'right-edge' :\n                           menu.element.classList.contains('near-snap-bottom') ? 'bottom-edge' : 'none';\n    \n    if (currentSnapType !== snapInfo.type) {\n      menu.element.classList.remove('near-snap', 'near-snap-right', 'near-snap-bottom', 'near-snap-both');\n      \n      if (snapInfo.type === 'both-edges') {\n        menu.element.classList.add('near-snap', 'near-snap-both');\n      } else if (snapInfo.type === 'right-edge') {\n        menu.element.classList.add('near-snap', 'near-snap-right');\n      } else if (snapInfo.type === 'bottom-edge') {\n        menu.element.classList.add('near-snap', 'near-snap-bottom');\n      }\n    }\n  }\n  \n  /**\n   * Handle drag end\n   * @param {MouseEvent} event \n   * @param {RollRequestsMenu} menu \n   * @param {Object} dragData \n   * @param {Function} moveHandler \n   * @param {Function} upHandler \n   */\n  static async handleDragEnd(event, menu, dragData, moveHandler, upHandler) {\n    LogUtil.log('RollMenuDragManager.handleDragEnd');\n\n    document.removeEventListener('mousemove', moveHandler);\n    document.removeEventListener('mouseup', upHandler);\n\n    if (!menu?.element) {\n      LogUtil.error('RollMenuDragManager.handleDragEnd - Menu element is null');\n      return;\n    }\n\n    menu.isDragging = false;\n    menu.element.classList.remove('dragging');\n    menu.element.classList.remove('near-snap', 'near-snap-right', 'near-snap-bottom', 'near-snap-both');\n\n    menu.element.style.zIndex = '';\n\n    const snapInfo = this.calculateSnapDistance(menu);\n    \n    if (snapInfo.type === 'both-edges') {\n      const chatNotifications = document.querySelector('#chat-notifications');\n      if (chatNotifications && menu.element) {\n        chatNotifications.insertBefore(menu.element, chatNotifications.firstChild);\n      }\n      await this.snapToDefault(menu);\n    } else if (snapInfo.type === 'bottom-edge') {\n      await this.snapToBottomEdge(menu);\n    } else if (snapInfo.type === 'right-edge') {\n      const chatNotifications = document.querySelector('#chat-notifications');\n      if (chatNotifications && menu.element) {\n        chatNotifications.insertBefore(menu.element, chatNotifications.firstChild);\n      }\n      await this.snapToRightEdge(menu, dragData.currentTop);\n    } else {\n      menu.isCustomPosition = true;\n      menu.customPosition = {\n        x: dragData.currentLeft,\n        y: dragData.currentTop,\n        isCustom: true,\n        dockedRight: false,\n        dockedBottom: false\n      };\n      const isCrlngnUIOn = document.querySelector('body.crlngn-tabs') ? true : false;\n      GeneralUtil.addCSSVars('--flash-rolls-menu-offset', isCrlngnUIOn ? '0px' : '16px');\n      \n      await this.saveCustomPosition(menu.customPosition);\n      menu.element.classList.add('custom-position');\n      \n      const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize) * 15;\n      if (dragData.currentLeft < remInPixels) {\n        menu.element.classList.add('left-edge');\n      }\n      \n      // Handle top-edge for horizontal layout\n      const isHorizontalLayout = menu.element.hasAttribute('data-layout') && \n                                menu.element.getAttribute('data-layout') === 'horizontal';\n      if (isHorizontalLayout && dragData.currentTop < 400) {\n        menu.element.classList.add('top-edge');\n      }\n    }\n  }\n  \n  /**\n   * Check if menu should snap and determine snap type\n   * @param {RollRequestsMenu} menu \n   * @returns {{type: string, distance: number}} Snap information\n   */\n  static calculateSnapDistance(menu) {\n    if (!menu?.element) {\n      LogUtil.error('RollMenuDragManager.calculateSnapDistance - Menu element is null');\n      return { type: 'none', distance: Infinity };\n    }\n\n    const lightningBolt = document.querySelector(this.LIGHTNING_BOLT_SELECTOR);\n    const hotbar = document.querySelector('#hotbar');\n\n    if (!lightningBolt && !hotbar) return { type: 'none', distance: Infinity };\n\n    const menuRect = menu.element.getBoundingClientRect();\n    \n    if (hotbar) {\n      const hotbarRect = hotbar.getBoundingClientRect();\n      const bottomDistance = Math.abs(hotbarRect.top - menuRect.bottom);\n      const menuLeft = menuRect.left;\n      const menuRight = menuRect.right;\n      const hotbarLeft = hotbarRect.left;\n      const hotbarRight = hotbarRect.right;\n      \n      const horizontalOverlap = (menuLeft < hotbarRight && menuRight > hotbarLeft);\n      \n      if (horizontalOverlap && bottomDistance <= this.SNAP_DISTANCE) {\n        return { type: 'bottom-edge', distance: 0 };\n      }\n    }\n    \n    if (lightningBolt) {\n      const boltRect = lightningBolt.getBoundingClientRect();\n      const horizontalDistance = Math.abs(boltRect.left - menuRect.right);\n      const verticalDistance = window.innerHeight - menuRect.bottom;\n      \n      if (horizontalDistance <= this.SNAP_DISTANCE) {\n        if (verticalDistance <= this.SNAP_DISTANCE) {\n          return { type: 'both-edges', distance: 0 };\n        }\n        return { type: 'right-edge', distance: 0 };\n      }\n    }\n    \n    return { type: 'none', distance: Infinity };\n  }\n  \n  /**\n   * Snap menu to right edge with custom vertical position\n   * @param {RollRequestsMenu} menu \n   * @param {number} currentTop - The vertical position to maintain\n   */\n  static async snapToRightEdge(menu, currentTop) {\n    LogUtil.log('RollMenuDragManager.snapToRightEdge', [currentTop]);\n\n    if (!menu?.element) {\n      LogUtil.error('RollMenuDragManager.snapToRightEdge - Menu element is null');\n      return;\n    }\n\n    menu.isCustomPosition = true;\n    menu.customPosition = {\n      y: currentTop,\n      isCustom: true,\n      dockedRight: true\n    };\n\n    menu.element.classList.remove('custom-position', 'left-edge', 'top-edge', 'docked-bottom', 'faded-ui', 'offset');\n    menu.element.classList.add('docked-right', 'snapping');\n    \n    const isHorizontalLayout = menu.element.hasAttribute('data-layout') && \n                              menu.element.getAttribute('data-layout') === 'horizontal';\n    if (isHorizontalLayout && currentTop < 400) {\n      menu.element.classList.add('top-edge');\n    } else {\n      menu.element.classList.remove('top-edge');\n    }\n    \n    menu.element.style.position = 'fixed';\n    menu.element.style.inset = '';\n    menu.element.style.left = '';\n    menu.element.style.right = '';\n    menu.element.style.bottom = '';\n    menu.element.style.top = `${currentTop}px`;\n    menu.element.style.zIndex = '';\n    \n    adjustMenuOffset();\n    \n    await this.saveCustomPosition(menu.customPosition);\n    \n    setTimeout(() => {\n      menu.element.classList.remove('snapping');\n    }, 300);\n  }\n  \n  /**\n   * Snap menu to bottom edge (docked to hotbar)\n   * @param {RollRequestsMenu} menu \n   */\n  static async snapToBottomEdge(menu) {\n    LogUtil.log('RollMenuDragManager.snapToBottomEdge');\n\n    if (!menu?.element) {\n      LogUtil.error('RollMenuDragManager.snapToBottomEdge - Menu element is null');\n      return;\n    }\n\n    menu.isCustomPosition = true;\n    menu.customPosition = {\n      isCustom: true,\n      dockedBottom: true\n    };\n\n    menu.element.classList.remove('custom-position', 'left-edge', 'top-edge', 'docked-right', 'offset');\n    menu.element.classList.add('docked-bottom', 'snapping');\n\n    const uiBottom = document.querySelector('#ui-bottom');\n    if (uiBottom && menu.element && !uiBottom.contains(menu.element)) {\n      uiBottom.prepend(menu.element);\n    }\n    \n    const hotbar = document.querySelector('#ui-bottom #hotbar');\n    if (hotbar && hotbar.classList.contains('faded-ui')) {\n      menu.element.classList.add('faded-ui');\n    }\n    this.syncOffsetClass(menu); \n    adjustMenuOffset();\n    \n    await this.saveCustomPosition(menu.customPosition);\n    \n    setTimeout(() => {\n      menu.element.classList.remove('snapping');\n    }, 300);\n  }\n  \n  /**\n   * Synchronize offset class from hotbar to menu when docked to bottom\n   * @param {RollRequestsMenu} menu \n   */\n  static syncOffsetClass(menu) {\n    const hotbar = document.querySelector('#hotbar');\n    if (hotbar && hotbar.classList.contains('offset')) {\n      menu.element.classList.add('offset');\n      const offsetValue = hotbar.style.getPropertyValue('--offset');\n      if (offsetValue) {\n        menu.element.style.setProperty('--offset', offsetValue);\n      }\n    } else {\n      menu.element.classList.remove('offset');\n      menu.element.style.removeProperty('--offset');\n    }\n  }\n\n  /**\n   * Synchronize faded-ui class from hotbar to menu when docked to bottom\n   * @param {RollRequestsMenu|Object} menu - Menu instance or proxy object with element property\n   */\n  static syncFadedUIClass(menu) {\n    if (!menu.element.classList.contains('docked-bottom')) {\n      menu.element.classList.remove('faded-ui');\n      return;\n    }\n\n    const hotbar = document.querySelector('#ui-bottom #hotbar');\n    if (hotbar && hotbar.classList.contains('faded-ui')) {\n      menu.element.classList.add('faded-ui');\n    } else {\n      menu.element.classList.remove('faded-ui');\n    }\n  }\n\n  /**\n   * Snap menu back to default position\n   * @param {RollRequestsMenu} menu \n   */\n  static async snapToDefault(menu) {\n    LogUtil.log('RollMenuDragManager.snapToDefault');\n\n    if (!menu?.element) {\n      LogUtil.error('RollMenuDragManager.snapToDefault - Menu element is null');\n      return;\n    }\n\n    menu.isCustomPosition = false;\n    menu.customPosition = null;\n\n    const SETTINGS = getSettings();\n    const originalLayout = SettingsUtil.get(SETTINGS.menuLayout.tag);\n\n    menu.element.classList.remove('custom-position', 'left-edge', 'top-edge', 'docked-bottom', 'docked-right', 'faded-ui', 'offset');\n    menu.element.classList.add('snapping');\n\n    menu.element.style.position = '';\n    menu.element.style.inset = '';\n    menu.element.style.left = '';\n    menu.element.style.top = '';\n    menu.element.style.right = '';\n    menu.element.style.bottom = '';\n    menu.element.style.zIndex = '';\n    menu.element.style.removeProperty('--offset');  \n    \n    adjustMenuOffset();\n    \n    await this.saveCustomPosition(null);\n    \n    setTimeout(() => {\n      menu.element.classList.remove('snapping');\n    }, 300);\n  }\n  \n  /**\n   * Apply custom position to menu\n   * @param {RollRequestsMenu} menu \n   * @param {Object} position \n   */\n  static applyCustomPosition(menu, position) {\n    if (!position || !position.isCustom || !menu?.element) return;\n\n    const menuSize = menu.element.getBoundingClientRect();\n\n    LogUtil.log('RollMenuDragManager.applyCustomPosition', [position]);\n    if(position.x < 0){\n      position.x = 0;\n    }else if (position.x > window.innerWidth - menuSize.width){\n      position.x = window.innerWidth - menuSize.width;\n    }\n\n    if(position.y < 0){\n      position.y = 0;\n    }else if (position.y > window.innerHeight - menuSize.height){\n      position.y = window.innerHeight - menuSize.height;\n    }\n    \n    menu.isCustomPosition = true;\n    menu.customPosition = position;\n    \n    if (position.dockedRight) {\n      const chatNotifications = document.querySelector('#chat-notifications');\n      if (chatNotifications) {\n        chatNotifications.insertBefore(menu.element, chatNotifications.firstChild);\n      }\n      \n      menu.element.style.position = 'fixed';\n      menu.element.style.inset = '';\n      menu.element.style.top = `${position.y}px`;\n      menu.element.style.left = '';\n      menu.element.style.right = '';\n      menu.element.style.bottom = '';\n      \n      menu.element.classList.add('docked-right');\n      menu.element.classList.remove('custom-position', 'left-edge', 'faded-ui', 'offset');\n      \n      const isHorizontalLayout = menu.element.hasAttribute('data-layout') && \n                                menu.element.getAttribute('data-layout') === 'horizontal';\n      if (isHorizontalLayout && position.y < 400) {\n        menu.element.classList.add('top-edge');\n      } else {\n        menu.element.classList.remove('top-edge');\n      }\n      \n      adjustMenuOffset();\n    } else if (position.dockedBottom) {\n      const uiBottom = document.querySelector('#ui-bottom');\n      if (uiBottom && !uiBottom.contains(menu.element)) {\n        uiBottom.prepend(menu.element);\n      }\n      \n      menu.element.classList.add('docked-bottom');\n      menu.element.classList.remove('custom-position', 'left-edge', 'top-edge', 'docked-right', 'faded-ui', 'offset');\n      \n      const hotbar = document.querySelector('#ui-bottom #hotbar');\n      if (hotbar && hotbar.classList.contains('faded-ui')) {\n        menu.element.classList.add('faded-ui');\n      }\n      \n      this.syncOffsetClass(menu);\n      \n      adjustMenuOffset();\n    } else {\n      document.body.appendChild(menu.element);\n      \n      menu.element.style.position = 'fixed';\n      menu.element.style.inset = '';\n      menu.element.style.top = `${position.y}px`;\n      menu.element.style.left = `${position.x}px`;\n      menu.element.style.right = 'auto';\n      menu.element.style.bottom = 'auto';\n      \n      const isCrlngnUIOn = document.querySelector('body.crlngn-tabs') ? true : false;\n      GeneralUtil.addCSSVars('--flash-rolls-menu-offset', isCrlngnUIOn ? '0px' : '16px');\n      \n      menu.element.classList.add('custom-position');\n      menu.element.classList.remove('docked-right', 'faded-ui', 'offset');\n      \n      const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize) * 15;\n      if (position.x < remInPixels) {\n        menu.element.classList.add('left-edge');\n      }\n      \n      const isHorizontalLayout = menu.element.hasAttribute('data-layout') && \n                                menu.element.getAttribute('data-layout') === 'horizontal';\n      if (isHorizontalLayout && position.y < 400) {\n        menu.element.classList.add('top-edge');\n      }\n    }\n  }\n  \n  /**\n   * Save custom position to user flag\n   * @param {Object|null} position \n   */\n  static async saveCustomPosition(position) {\n    if (!position) {\n      await game.user.setFlag(MODULE.ID, 'menuCustomPosition', null);\n      return;\n    }\n\n    const menu = document.querySelector('.flash-rolls-menu');\n    if (menu) {\n      const menuSize = menu.getBoundingClientRect();\n\n      if(position.x < 0){\n        position.x = 0;\n      }else if (position.x > window.innerWidth - menuSize.width){\n        position.x = window.innerWidth - menuSize.width;\n      }\n      \n      if(position.y < 0){\n        position.y = 0;\n      }else if (position.y > window.innerHeight - menuSize.height){\n        position.y = window.innerHeight - menuSize.height;\n      }\n    }\n    \n    await game.user.setFlag(MODULE.ID, 'menuCustomPosition', position);\n  }\n  \n  /**\n   * Load custom position from user flag\n   * @returns {Object|null} Position object or null\n   */\n  static loadCustomPosition() {\n    return game.user.getFlag(MODULE.ID, 'menuCustomPosition') || null;\n  }\n  \n  /**\n   * Reset menu to default position\n   * @param {RollRequestsMenu} menu \n   */\n  static async resetPosition(menu) {\n    await this.snapToDefault(menu);\n  }\n}","import { MODULE_ID } from '../../constants/General.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport RollRequestsMenu from '../ui/RollRequestsMenu.mjs';\n\n/**\n * Utility class for managing actor status (favorites, blocked) using actor flags\n */\nexport class ActorStatusManager {\n  /**\n   * Actor status flag keys\n   */\n  static FLAGS = {\n    FAVORITE: 'isFavorite',\n    BLOCKED: 'isBlocked'\n  };\n\n  /**\n   * Check if an actor is favorited\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {boolean} Whether the actor is favorited\n   */\n  static isFavorite(actor) {\n    try {\n      const actorDoc = typeof actor === 'string' ? game.actors.get(actor) : actor;\n      if (!actorDoc || !actorDoc.getFlag) return false;\n      return actorDoc.getFlag(MODULE_ID, this.FLAGS.FAVORITE) === true;\n    } catch (error) {\n      LogUtil.error('Error checking favorite status', [error, actor]);\n      return false;\n    }\n  }\n\n  /**\n   * Check if an actor is blocked\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {boolean} Whether the actor is blocked\n   */\n  static isBlocked(actor) {\n    const actorDoc = typeof actor === 'string' ? game.actors.get(actor) : actor;\n    if (!actorDoc) return false;\n    return actorDoc.getFlag(MODULE_ID, this.FLAGS.BLOCKED) === true;\n  }\n\n  /**\n   * Set favorite status for an actor\n   * @param {Actor|string} actor - The actor or actor ID\n   * @param {boolean} isFavorite - Whether to favorite the actor\n   * @returns {Promise<void>}\n   */\n  static async setFavorite(actor, isFavorite) {\n    const actorDoc = typeof actor === 'string' ? game.actors.get(actor) : actor;\n    if (!actorDoc) {\n      LogUtil.error('Actor not found', [actor]);\n      return;\n    }\n\n    LogUtil.log('ActorStatusManager.setFavorite', [actorDoc.name, isFavorite]);\n\n    if (isFavorite) {\n      // If favoriting, remove blocked status\n      await actorDoc.setFlag(MODULE_ID, this.FLAGS.FAVORITE, true);\n      await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.BLOCKED);\n      \n      // ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.actorAddedToFavorites\", {\n      //   actor: actorDoc.name\n      // }) || `${actorDoc.name} added to Flash Token Bar favorites`);\n    } else {\n      await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.FAVORITE);\n      \n      // ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.actorRemovedFromFavorites\", {\n      //   actor: actorDoc.name\n      // }) || `${actorDoc.name} removed from Flash Token Bar favorites`);\n    }\n\n    this._refreshMenu();\n  }\n\n  /**\n   * Set blocked status for an actor\n   * @param {Actor|string} actor - The actor or actor ID\n   * @param {boolean} isBlocked - Whether to block the actor\n   * @returns {Promise<void>}\n   */\n  static async setBlocked(actor, isBlocked) {\n    const actorDoc = typeof actor === 'string' ? game.actors.get(actor) : actor;\n    if (!actorDoc) {\n      LogUtil.error('Actor not found', [actor]);\n      return;\n    }\n\n    if (isBlocked) {\n      await actorDoc.setFlag(MODULE_ID, this.FLAGS.BLOCKED, true);\n      await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.FAVORITE);\n    } else {\n      await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.BLOCKED);\n    }\n\n    this._refreshMenu();\n  }\n\n  /**\n   * Toggle favorite status for an actor\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {Promise<void>}\n   */\n  static async toggleFavorite(actor, makeFavorite) {\n    const isFavorite = makeFavorite ? true : !this.isFavorite(actor);\n    await this.setFavorite(actor, isFavorite);\n  }\n\n  /**\n   * Toggle blocked status for an actor\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {Promise<void>}\n   */\n  static async toggleBlocked(actor, makeBlocked) {\n    const isBlocked = makeBlocked ? true : !this.isBlocked(actor);\n    await this.setBlocked(actor, isBlocked);\n  }\n\n  /**\n   * Block an actor (for drag-to-remove functionality)\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {Promise<void>}\n   */\n  static async blockActor(actor) {\n    await this.setBlocked(actor, true);\n  }\n\n  /**\n   * Get all favorite actors\n   * @returns {Actor[]} Array of favorite actors\n   */\n  static getFavoriteActors() {\n    return game.actors.filter(actor => this.isFavorite(actor));\n  }\n\n  /**\n   * Get all blocked actors\n   * @returns {Actor[]} Array of blocked actors\n   */\n  static getBlockedActors() {\n    return game.actors.filter(actor => this.isBlocked(actor));\n  }\n\n  /**\n   * Filter actors by removing blocked ones\n   * @param {Actor[]} actors - Array of actors to filter\n   * @returns {Actor[]} Filtered array without blocked actors\n   */\n  static filterBlocked(actors) {\n    return actors.filter(actor => !this.isBlocked(actor));\n  }\n\n  /**\n   * Get actor status object\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {Object} Status object with favorite and blocked properties\n   */\n  static getActorStatus(actor) {\n    return {\n      isFavorite: this.isFavorite(actor),\n      isBlocked: this.isBlocked(actor)\n    };\n  }\n\n  /**\n   * Clear all status flags for an actor\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {Promise<void>}\n   */\n  static async clearActorStatus(actor) {\n    const actorDoc = typeof actor === 'string' ? game.actors.get(actor) : actor;\n    if (!actorDoc) return;\n\n    await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.FAVORITE);\n    await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.BLOCKED);\n    \n    this._refreshMenu();\n  }\n\n  /**\n   * Refresh the Roll Requests Menu if it's open\n   * @private\n   */\n  static _refreshMenu() {\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Get context menu options for actor management\n   * @param {HTMLElement} html - The HTML element\n   * @param {Array} options - Existing context menu options\n   * @returns {Array} Updated context menu options\n   */\n  static getContextMenuOptions(html, options) {\n    if (!game.user.isGM) return options;\n\n    options.push({\n      name: \"FLASH_ROLLS.contextMenu.toggleFavorite\",\n      icon: '<i class=\"fas fa-bolt\"></i>',\n      callback: li => {\n        const actorId = li.data('documentId') || li.dataset.entryId;\n        if (actorId) {\n          this.toggleFavorite(actorId);\n        }\n      },\n      condition: li => game.user.isGM\n    });\n\n    options.push({\n      name: \"FLASH_ROLLS.contextMenu.toggleBlocked\",\n      icon: '<i class=\"fas fa-ban\"></i>',\n      callback: li => {\n        const actorId = li.data('documentId') || li.dataset.entryId;\n        if (actorId) {\n          this.toggleBlocked(actorId);\n        }\n      },\n      condition: li => game.user.isGM\n    });\n\n    return options;\n  }\n}","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { ActorStatusManager } from '../managers/ActorStatusManager.mjs';\n\n/**\n * Handles drag-to-remove functionality for actors in the Roll Requests Menu\n */\nexport class ActorDragUtil {\n  /**\n   * Initialize drag functionality for actor list items\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static initializeActorDrag(menu) {\n    const actorElements = menu.element.querySelectorAll('.actor-list .actor.drag-wrapper[draggable=\"true\"]');\n    \n    actorElements.forEach(actorElement => {\n      actorElement.addEventListener('dragstart', (e) => this.handleDragStart(e, menu));\n      actorElement.addEventListener('dragend', (e) => this.handleDragEnd(e, menu));\n    });\n    \n    const menuContainer = menu.element;\n    menuContainer.addEventListener('dragover', (e) => this.handleDragOver(e));\n    menuContainer.addEventListener('drop', (e) => this.handleDrop(e, menu));\n    \n    document.addEventListener('dragover', (e) => this.handleGlobalDragOver(e, menu));\n    document.addEventListener('drop', (e) => this.handleGlobalDrop(e, menu));\n  }\n  \n  /**\n   * Handle drag start event\n   * @param {DragEvent} event \n   * @param {RollRequestsMenu} menu \n   */\n  static handleDragStart(event, menu) {\n    const actorElement = event.currentTarget;\n    const actorId = actorElement.dataset.actorId;\n    const actor = game.actors.get(actorId);\n    \n    if (!actor) {\n      event.preventDefault();\n      return;\n    }\n    \n    LogUtil.log('ActorDragUtil.handleDragStart', [actor.name, actorId]);\n    \n    event.dataTransfer.setData('text/plain', actorId);\n    event.dataTransfer.setData('application/json', JSON.stringify({\n      actorId: actorId,\n      actorName: actor.name,\n      uniqueId: actorElement.dataset.id,\n      tokenId: actorElement.dataset.tokenId || null\n    }));\n    \n    event.dataTransfer.effectAllowed = 'move';\n    actorElement.classList.add('dragging');\n    \n    const rect = actorElement.getBoundingClientRect();\n\n    const dragImage = document.createElement('div');\n    dragImage.style.width = rect.width + 'px';\n    dragImage.style.height = rect.height + 'px';\n    dragImage.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';\n    dragImage.style.border = '2px dashed rgba(255, 255, 255, 0.3)';\n    dragImage.style.borderRadius = '4px';\n    dragImage.style.opacity = '0.6';\n    dragImage.style.position = 'absolute';\n    dragImage.style.top = '-1000px';\n    dragImage.style.left = '-1000px';\n    dragImage.style.pointerEvents = 'none';\n    document.body.appendChild(dragImage);\n\n    event.dataTransfer.setDragImage(dragImage, rect.width / 2, rect.height / 2);\n    \n    setTimeout(() => {\n      if (dragImage.parentNode) {\n        dragImage.parentNode.removeChild(dragImage);\n      }\n    }, 0);\n    \n    menu._currentDragData = {\n      actorId: actorId,\n      actorElement: actorElement,\n      startTime: Date.now()\n    };\n  }\n  \n  /**\n   * Create a custom drag image for group actors showing member portraits\n   * @param {HTMLElement} actorElement - The group actor element\n   * @param {Actor} actor - The group actor\n   * @returns {HTMLElement} The custom drag image element\n   */\n  static createGroupDragImage(actorElement, actor) {\n    const dragImage = document.createElement('div');\n    dragImage.className = 'actor actor-group drag-wrapper';\n    dragImage.style.background = getComputedStyle(actorElement).background;\n    dragImage.style.border = getComputedStyle(actorElement).border;\n    dragImage.style.borderRadius = getComputedStyle(actorElement).borderRadius;\n    dragImage.style.padding = getComputedStyle(actorElement).padding;\n\n    // Get the actor images container (non-expanded view)\n    const actorImgContainer = actorElement.querySelector('.actor-img');\n    if (actorImgContainer) {\n      const clonedImgContainer = actorImgContainer.cloneNode(true);\n      dragImage.appendChild(clonedImgContainer);\n    }\n\n    // Add group name\n    const nameDiv = document.createElement('div');\n    nameDiv.className = 'actor-name';\n    nameDiv.textContent = actor.name;\n    nameDiv.style.color = getComputedStyle(actorElement.querySelector('.actor-name') || actorElement).color;\n    nameDiv.style.fontSize = getComputedStyle(actorElement.querySelector('.actor-name') || actorElement).fontSize;\n    nameDiv.style.fontWeight = 'bold';\n    nameDiv.style.textAlign = 'center';\n    nameDiv.style.marginTop = '4px';\n    dragImage.appendChild(nameDiv);\n\n    return dragImage;\n  }\n\n  /**\n   * Create a standard drag image for regular actors with improved formatting\n   * @param {HTMLElement} actorElement - The actor element\n   * @returns {HTMLElement} The drag image element\n   */\n  static createStandardDragImage(actorElement) {\n    const dragImage = document.createElement('div');\n    dragImage.className = actorElement.className;\n    dragImage.style.background = getComputedStyle(actorElement).background;\n    dragImage.style.border = getComputedStyle(actorElement).border;\n    dragImage.style.borderRadius = getComputedStyle(actorElement).borderRadius;\n    dragImage.style.padding = getComputedStyle(actorElement).padding;\n    dragImage.style.display = 'flex';\n    dragImage.style.alignItems = 'center';\n    dragImage.style.gap = '8px';\n\n    // Clone the actor image\n    const actorImg = actorElement.querySelector('.actor-img');\n    if (actorImg) {\n      const clonedImg = actorImg.cloneNode(true);\n      dragImage.appendChild(clonedImg);\n    }\n\n    // Clone the actor name\n    const actorName = actorElement.querySelector('.actor-name');\n    if (actorName) {\n      const clonedName = actorName.cloneNode(true);\n      dragImage.appendChild(clonedName);\n    }\n\n    return dragImage;\n  }\n\n  /**\n   * Handle drag over event within the menu\n   * @param {DragEvent} event\n   */\n  static handleDragOver(event) {\n    event.preventDefault();\n    event.dataTransfer.dropEffect = 'none';\n  }\n  \n  /**\n   * Handle drop event within the menu\n   * @param {DragEvent} event \n   * @param {RollRequestsMenu} menu \n   */\n  static handleDrop(event, menu) {\n    event.preventDefault();\n    LogUtil.log('ActorDragUtil.handleDrop - dropped within menu, canceling remove');\n    \n    this.cleanupDrag(menu);\n  }\n  \n  /**\n   * Handle global drag over (outside the menu)\n   * @param {DragEvent} event\n   * @param {RollRequestsMenu} menu\n   */\n  static handleGlobalDragOver(event, menu) {\n    if (!menu._currentDragData) return;\n\n    // Check if we're over the menu element or any of its children\n    const menuElement = menu.element;\n    const target = document.elementFromPoint(event.clientX, event.clientY);\n    const isOverMenu = menuElement && (menuElement.contains(target) || menuElement === target);\n\n    if (!isOverMenu) {\n      event.preventDefault();\n      event.dataTransfer.dropEffect = 'move';\n\n      if (menu._currentDragData.actorElement) {\n        menu._currentDragData.actorElement.classList.add('drag-remove-zone');\n      }\n    } else {\n      event.dataTransfer.dropEffect = 'none';\n\n      if (menu._currentDragData.actorElement) {\n        menu._currentDragData.actorElement.classList.remove('drag-remove-zone');\n      }\n    }\n  }\n  \n  /**\n   * Handle global drop (outside the menu)\n   * @param {DragEvent} event\n   * @param {RollRequestsMenu} menu\n   */\n  static handleGlobalDrop(event, menu) {\n    if (!menu._currentDragData) return;\n\n    // Check if we're over the menu element or any of its children\n    const menuElement = menu.element;\n    const target = document.elementFromPoint(event.clientX, event.clientY);\n    const isOverMenu = menuElement && (menuElement.contains(target) || menuElement === target);\n\n    if (!isOverMenu) {\n      event.preventDefault();\n\n      const dragData = JSON.parse(event.dataTransfer.getData('application/json'));\n      LogUtil.log('ActorDragUtil.handleGlobalDrop - blocking actor', [dragData.actorName]);\n\n      this.blockActor(dragData.actorId, menu);\n    }\n\n    this.cleanupDrag(menu);\n  }\n  \n  /**\n   * Handle drag end event\n   * @param {DragEvent} event \n   * @param {RollRequestsMenu} menu \n   */\n  static handleDragEnd(event, menu) {\n    LogUtil.log('ActorDragUtil.handleDragEnd');\n    \n    setTimeout(() => {\n      this.cleanupDrag(menu);\n    }, 100);\n  }\n  \n  /**\n   * Block an actor by setting the blocked flag\n   * @param {string} actorId - The actor ID to block\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async blockActor(actorId, menu) {\n    try {\n      await ActorStatusManager.blockActor(actorId);\n      \n      const actorElement = menu.element.querySelector(`[data-actor-id=\"${actorId}\"]`);\n      if (actorElement) {\n        const uniqueId = actorElement.dataset.id;\n        menu.selectedActors.delete(uniqueId);\n      }\n      \n      // Let the ActorStatusManager._refreshMenu() handle the re-render automatically\n      \n    } catch (error) {\n      LogUtil.error('Error blocking actor', [error]);\n      ui.notifications.error(`Failed to block actor: ${error.message}`);\n    }\n  }\n  \n  /**\n   * Clean up drag-related state and visual feedback\n   * @param {RollRequestsMenu} menu \n   */\n  static cleanupDrag(menu) {\n    if (menu._currentDragData?.actorElement) {\n      menu._currentDragData.actorElement.classList.remove('dragging', 'drag-remove-zone');\n    }\n    \n    menu._currentDragData = null;\n  }\n  \n  /**\n   * Remove drag event listeners (for cleanup)\n   * @param {RollRequestsMenu} menu \n   */\n  static removeDragListeners(menu) {\n    document.removeEventListener('dragover', this.handleGlobalDragOver);\n    document.removeEventListener('drop', this.handleGlobalDrop);\n  }\n}","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { isPlayerOwned } from '../helpers/Helpers.mjs';\nimport { ActorStatusManager } from '../managers/ActorStatusManager.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { FlashAPI } from '../core/FlashAPI.mjs';\n\n/**\n * Handles drag and drop of actors from the directory into the Flash Token Bar menu\n */\nexport class ActorDropUtil {\n  /**\n   * Check if the current user can drop actors into the menu\n   * @param {string} selector - The drop target selector\n   * @returns {boolean} Whether the drop is allowed\n   */\n  static canDrop(selector) {\n    LogUtil.log('ActorDropUtil.canDrop', [selector]);\n    return game.user.isGM;\n  }\n\n  /**\n   * Handle the drag over event for visual feedback\n   * @param {DragEvent} event - The drag over event\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static handleDragOver(event, menu) {\n    LogUtil.log('ActorDropUtil.handleDragOver', [event, event.currentTarget, event.target]);\n    \n    event.preventDefault();\n    event.stopPropagation();\n    \n    if (event.dataTransfer) {\n      event.dataTransfer.dropEffect = 'copy';\n      LogUtil.log('ActorDropUtil.handleDragOver - dataTransfer types:', [event.dataTransfer.types]);\n    }\n    \n    const dropZone = event.currentTarget.closest('.actor-list, .actors');\n    if (dropZone) {\n      dropZone.classList.add('drag-over');\n      LogUtil.log('ActorDropUtil.handleDragOver - added drag-over class');\n    }\n    \n    return false;\n  }\n\n  /**\n   * Handle the drag leave event to remove visual feedback\n   * @param {DragEvent} event - The drag leave event\n   */\n  static handleDragLeave(event) {\n    LogUtil.log('ActorDropUtil.handleDragLeave', [event, event.currentTarget, event.target]);\n\n    // If called from global dragend, just remove all drag-over classes\n    if (!event.currentTarget || typeof event.currentTarget.getBoundingClientRect !== 'function') {\n      const allDragOverElements = document.querySelectorAll('.drag-over');\n      allDragOverElements.forEach(element => {\n        element.classList.remove('drag-over');\n      });\n      LogUtil.log('ActorDropUtil.handleDragLeave - removed drag-over class from all elements (global cleanup)');\n      return;\n    }\n\n    const rect = event.currentTarget.getBoundingClientRect();\n    const isActuallyLeaving = (\n      event.clientX < rect.left ||\n      event.clientX > rect.right ||\n      event.clientY < rect.top ||\n      event.clientY > rect.bottom\n    );\n\n    if (isActuallyLeaving) {\n      const dropZone = event.currentTarget.closest('.actor-list, .actors');\n      if (dropZone) {\n        dropZone.classList.remove('drag-over');\n        LogUtil.log('ActorDropUtil.handleDragLeave - removed drag-over class');\n      }\n    }\n  }\n\n  /**\n   * Handle the drop event when an actor is dropped into the menu\n   * @param {DragEvent} event - The drop event\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async handleDrop(event, menu) {\n    event.preventDefault();\n    event.stopPropagation(); // Prevent bubbling to parent elements\n    \n    for (let i = 0; i < event.dataTransfer.types.length; i++) {\n      const type = event.dataTransfer.types[i];\n      const data = event.dataTransfer.getData(type);\n      LogUtil.log(`ActorDropUtil.handleDrop - ${type}:`, [data]);\n    }\n\n    const allDragOverElements = menu.element.querySelectorAll('.drag-over');\n    allDragOverElements.forEach(element => {\n      element.classList.remove('drag-over');\n    });\n    LogUtil.log('ActorDropUtil.handleDrop - removed drag-over class from all elements');\n\n    try {\n      const dragData = this.parseDragData(event);\n      if (!dragData || dragData.type !== 'Actor') {\n        LogUtil.log('ActorDropUtil.handleDrop - Invalid drag data', [dragData]);\n        return;\n      }\n\n      const actor = await this.getActorFromDragData(dragData);\n      if (!actor) {\n        FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.notifications.actorNotFound\") || \"Actor not found\");\n        return;\n      }\n      \n      const isPC = isPlayerOwned(actor);\n      const targetTab = isPC ? 'pc' : 'npc';\n\n      if (menu.currentTab !== targetTab) {\n        menu.currentTab = targetTab;\n      }\n      await this.addActorToMenu(actor, menu);\n\n      // ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.actorAdded\", { \n      //   actor: actor.name \n      // }) || `Added ${actor.name} to Flash Token Bar menu`);\n\n    } catch (error) {\n      LogUtil.error('ActorDropUtil.handleDrop - Error processing drop', [error]);\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.dropError\") || \"Error adding actor to menu\");\n    }\n  }\n\n  /**\n   * Parse drag data from the drag event\n   * @param {DragEvent} event - The drag event\n   * @returns {Object|null} The parsed drag data or null if invalid\n   */\n  static parseDragData(event) {\n    try {\n      const jsonData = event.dataTransfer.getData('application/json');\n      if (jsonData) {\n        const parsed = JSON.parse(jsonData);\n        return parsed;\n      }\n\n      const textData = event.dataTransfer.getData('text/plain');\n      \n      if (textData) {\n        if (textData.startsWith('Actor.')) {\n          const dragData = {\n            type: 'Actor',\n            uuid: textData\n          };\n          return dragData;\n        }\n        \n        try {\n          const parsed = JSON.parse(textData);\n          return parsed;\n        } catch (e) {\n          LogUtil.log('ActorDropUtil.parseDragData - Text is not JSON');\n        }\n      }\n\n      return null;\n    } catch (error) {\n      LogUtil.error('ActorDropUtil.parseDragData - Error parsing drag data', [error]);\n      return null;\n    }\n  }\n\n  /**\n   * Get the actor document from drag data\n   * @param {Object} dragData - The drag data object\n   * @returns {Promise<Actor|null>} The actor document or null if not found\n   */\n  static async getActorFromDragData(dragData) {\n    try {\n      if (dragData.uuid) {\n        return await fromUuid(dragData.uuid);\n      } else if (dragData.id) {\n        return game.actors.get(dragData.id);\n      }\n      return null;\n    } catch (error) {\n      LogUtil.error('ActorDropUtil.getActorFromDragData - Error getting actor', [error]);\n      return null;\n    }\n  }\n\n  /**\n   * Add an actor to the menu as a favorite\n   * @param {Actor} actor - The actor to add\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async addActorToMenu(actor, menu) {\n    const isBlocked = ActorStatusManager.isBlocked(actor);\n    const isFavorite = ActorStatusManager.isFavorite(actor);\n    \n    if (isFavorite && !isBlocked) {\n      FlashAPI.notify('info',game.i18n.format(\"FLASH_ROLLS.notifications.actorAlreadyAdded\", { \n        actor: actor.name \n      }) || `${actor.name} is already in the menu`);\n      return;\n    }\n\n    await ActorStatusManager.setFavorite(actor, true);\n  }\n}","import { LogUtil } from './LogUtil.mjs';\nimport { getActorData } from '../helpers/Helpers.mjs';\nimport { MODULE_ID } from '../../constants/General.mjs';\nimport { SettingsUtil } from './SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport RollRequestsMenu from '../ui/RollRequestsMenu.mjs';\nimport { GeneralUtil } from './GeneralUtil.mjs';\nimport { FlashAPI } from '../core/FlashAPI.mjs';\n\n/**\n * Manages token movement restrictions for Flash Token Bar 5e\n * Provides player-only movement blocking while preserving GM override capabilities\n */\nexport class TokenMovementManager {\n\n  /**\n   * Toggle movement restriction for selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async toggleMovementForSelected(menu) {\n    if (menu.selectedActors.size === 0) {\n      FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.notifications.noValidActorsSelected\"));\n      return;\n    }\n\n    const tokens = [];\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) {\n        LogUtil.log(`TokenMovementManager: No actor found for uniqueId: ${uniqueId}`);\n        continue;\n      }\n\n      const actorTokens = this.getTokensForActor(actor.id, uniqueId);\n      LogUtil.log(`TokenMovementManager: Found ${actorTokens.length} tokens for actor ${actor.name} (${actor.id})`);\n      tokens.push(...actorTokens);\n    }\n\n    if (tokens.length === 0) {\n      FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.notifications.noTokensForMovementLock\"));\n      return;\n    }\n\n    // Get movement status for all tokens\n    const movementStatus = this.getMovementStatus(tokens);\n\n    // Majority rule: if more than half are restricted, unlock all; otherwise lock all\n    const shouldLock = movementStatus.restricted < movementStatus.unrestricted;\n\n    LogUtil.log(`TokenMovementManager: Before toggle - ${movementStatus.restricted} restricted, ${movementStatus.unrestricted} unrestricted, shouldLock: ${shouldLock}`);\n\n    await this.setMovementRestriction(tokens, shouldLock);\n\n    RollRequestsMenu.refreshIfOpen();\n\n    const messageKey = shouldLock ? \"movementLocked\" : \"movementUnlocked\";\n    FlashAPI.notify('info',game.i18n.format(`FLASH_ROLLS.notifications.${messageKey}`, {\n      count: tokens.length\n    }));\n\n    LogUtil.log(`TokenMovementManager: ${shouldLock ? 'Locked' : 'Unlocked'} movement for ${tokens.length} tokens`);\n  }\n\n\n  /**\n   * Set movement restriction for selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   * @param {boolean} restricted - Whether to restrict movement\n   * @private\n   */\n  static async _setMovementForSelected(menu, restricted) {\n    if (menu.selectedActors.size === 0) {\n      FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.notifications.noValidActorsSelected\"));\n      return;\n    }\n\n    const tokens = [];\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n\n      const actorTokens = this.getTokensForActor(actor.id, uniqueId);\n      tokens.push(...actorTokens);\n    }\n\n    if (tokens.length === 0) {\n      FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.notifications.noTokensForMovementLock\"));\n      return;\n    }\n\n    await this.setMovementRestriction(tokens, restricted);\n\n    const messageKey = restricted ? \"movementLocked\" : \"movementUnlocked\";\n    FlashAPI.notify('info',game.i18n.format(`FLASH_ROLLS.notifications.${messageKey}`, {\n      count: tokens.length\n    }));\n\n    LogUtil.log(`TokenMovementManager: ${restricted ? 'Locked' : 'Unlocked'} movement for ${tokens.length} tokens`);\n  }\n\n  /**\n   * Get tokens for a specific actor\n   * @param {string} actorId - The actor ID\n   * @param {string} uniqueId - The unique ID (could be token ID or actor ID)\n   * @returns {TokenDocument[]} Array of token documents\n   */\n  static getTokensForActor(actorId, uniqueId) {\n    const tokens = [];\n    const currentScene = game.scenes.current;\n\n    if (!currentScene) return tokens;\n\n    if (uniqueId !== actorId) {\n      const tokenDoc = currentScene.tokens.get(uniqueId);\n      if (tokenDoc && tokenDoc.actorId === actorId) {\n        tokens.push(tokenDoc);\n      }\n    } else {\n      const actorTokens = currentScene.tokens.filter(token => token.actorId === actorId);\n      tokens.push(...actorTokens);\n    }\n\n    return tokens;\n  }\n\n  /**\n   * Set movement restriction on tokens\n   * @param {TokenDocument[]} tokens - Array of token documents\n   * @param {boolean} restricted - Whether to restrict movement\n   */\n  static async setMovementRestriction(tokens, restricted) {\n    const updates = tokens.map(token => {\n      let updateData;\n\n      if (restricted) {\n        // Setting restriction\n        const movementRestrictionValue = {\n          type: \"manual\",\n          enabled: true,\n          source: \"gm\",\n          metadata: {\n            restrictedAt: Date.now(),\n            restrictedBy: game.user.id\n          }\n        };\n\n        updateData = {\n          _id: token.id,\n          flags: {\n            [MODULE_ID]: {\n              movementRestriction: movementRestrictionValue\n            }\n          }\n        };\n      } else {\n        updateData = {\n          _id: token.id,\n          [`flags.${MODULE_ID}.-=movementRestriction`]: null\n        };\n      }\n\n      return updateData;\n    });\n\n    if (updates.length > 0) {\n      try {\n        LogUtil.log(`TokenMovementManager: Updating ${updates.length} tokens with updates:`, updates);\n        await game.scenes.current.updateEmbeddedDocuments(\"Token\", updates);\n        LogUtil.log(`TokenMovementManager: Successfully updated ${updates.length} tokens with movement restriction: ${restricted}`);\n\n        // Verify the update worked - need to get fresh token documents\n        for (const tokenUpdate of updates) {\n          const freshToken = game.scenes.current.tokens.get(tokenUpdate._id);\n          if (freshToken) {\n            const newRestriction = freshToken.getFlag(MODULE_ID, 'movementRestriction');\n            LogUtil.log(`TokenMovementManager: After update, token ${freshToken.name} restriction is:`, newRestriction);\n          }\n        }\n      } catch (error) {\n        LogUtil.error(\"TokenMovementManager: Failed to update token movement restrictions\", [error]);\n        ui.notifications.error(\"Failed to update token movement restrictions\");\n      }\n    }\n  }\n\n  /**\n   * Check if a token has movement restrictions\n   * @param {TokenDocument} token - The token document\n   * @returns {boolean} True if movement is restricted\n   */\n  static isMovementRestricted(token) {\n    const restriction = token.getFlag(MODULE_ID, 'movementRestriction');\n    return restriction?.enabled === true;\n  }\n\n  /**\n   * Check if movement is allowed for a token and user\n   * @param {TokenDocument} token - The token document\n   * @param {User} user - The user attempting to move the token\n   * @param {Object} updateData - The update data containing position changes\n   * @returns {boolean} True if movement is allowed\n   */\n  static isMovementAllowed(token, user, updateData) {\n    if (user.isGM) {\n      return true;\n    }\n\n    const hasPositionChange = updateData.x !== undefined || updateData.y !== undefined;\n    if (!hasPositionChange) {\n      return true;\n    }\n\n    const restriction = token.getFlag(MODULE_ID, 'movementRestriction');\n    if (!restriction?.enabled) {\n      return true;\n    }\n\n    LogUtil.log(`TokenMovementManager: Movement blocked for token ${token.name} by user ${user.name}`);\n    return false;\n  }\n\n  /**\n   * Get movement restriction status for multiple tokens\n   * @param {TokenDocument[]} tokens - Array of token documents\n   * @returns {Object} Object with counts of restricted/unrestricted tokens\n   */\n  static getMovementStatus(tokens) {\n    let restrictedCount = 0;\n    let unrestrictedCount = 0;\n\n    tokens.forEach(token => {\n      if (this.isMovementRestricted(token)) {\n        restrictedCount++;\n      } else {\n        unrestrictedCount++;\n      }\n    });\n\n    return {\n      restricted: restrictedCount,\n      unrestricted: unrestrictedCount,\n      total: tokens.length,\n      hasRestricted: restrictedCount > 0,\n      hasUnrestricted: unrestrictedCount > 0,\n      allRestricted: restrictedCount === tokens.length,\n      allUnrestricted: unrestrictedCount === tokens.length\n    };\n  }\n\n  /**\n   * Get the appropriate icon class based on movement status\n   * @param {Object} status - Movement status object from getMovementStatus\n   * @returns {string} FontAwesome icon class\n   */\n  static getStatusIcon(status) {\n    if (status.allRestricted) {\n      return 'fa-user-lock';\n    } else if (status.allUnrestricted) {\n      return 'fa-person-walking';\n    } else {\n      return 'fa-user-slash';\n    }\n  }\n\n  /**\n   * Clear all movement restrictions from tokens\n   * @param {TokenDocument[]} tokens - Array of token documents\n   */\n  static async clearAllRestrictions(tokens) {\n    await this.setMovementRestriction(tokens, false);\n  }\n\n  /**\n   * Handle combat start - block movement for all combatants not on their turn\n   * @param {Combat} combat - The combat instance\n   * @param {object} updateData - Update data\n   */\n  static async onCombatStart(combat, updateData) {\n    if (!game.user.isGM) return;\n\n    const SETTINGS = getSettings();\n    const autoBlock = SettingsUtil.get(SETTINGS.autoBlockMovementInCombat?.tag);\n\n    if (!autoBlock) return;\n\n    LogUtil.log('TokenMovementManager: Combat started, applying movement restrictions');\n\n    // Get current combatant\n    const currentCombatant = combat.combatant;\n\n    // Block all combatants except the current one\n    const tokensToBlock = [];\n\n    for (const combatant of combat.combatants) {\n      if (combatant.id === currentCombatant?.id) continue;\n\n      const token = combatant.token;\n      if (token) {\n        tokensToBlock.push(token);\n      }\n    }\n\n    if (tokensToBlock.length > 0) {\n      await this.setCombatMovementRestriction(tokensToBlock, true);\n      LogUtil.log(`TokenMovementManager: Blocked movement for ${tokensToBlock.length} combatants`);\n    }\n  }\n\n  /**\n   * Handle turn change - unblock current combatant, block previous\n   * @param {Combat} combat - The combat instance\n   * @param {object} prior - The prior turn state\n   * @param {object} current - The current turn state\n   */\n  static async onCombatTurnChange(combat, prior, current) {\n    if (!game.user.isGM) return;\n\n    const SETTINGS = getSettings();\n    const autoBlock = SettingsUtil.get(SETTINGS.autoBlockMovementInCombat?.tag);\n\n    if (!autoBlock) return;\n\n    LogUtil.log('TokenMovementManager: Combat turn changed',[combat, prior, current]);\n\n    const currentCombatant = combat.combatant;\n    LogUtil.log(`TokenMovementManager: Current combatant`, [currentCombatant]);\n\n    // Update all combatants: block everyone except the current one\n    for (const combatant of combat.combatants) {\n      const token = combatant.token;\n      if (!token) continue;\n\n      const isCurrentTurn = combatant.tokenId === currentCombatant?.tokenId;\n      const shouldRestrict = !isCurrentTurn;\n\n      LogUtil.log(`TokenMovementManager: ${combatant.name} - isCurrentTurn: ${isCurrentTurn}, shouldRestrict: ${shouldRestrict}`, [combatant]);\n\n      await this.setCombatMovementRestriction([token], shouldRestrict);\n    }\n\n    LogUtil.log(`TokenMovementManager: Updated movement restrictions for all combatants`);\n  }\n\n  /**\n   * Handle combat end - remove all combat-based movement restrictions\n   * @param {Combat} combat - The combat instance\n   */\n  static async onCombatEnd(combat) {\n    if (!game.user.isGM) return;\n\n    LogUtil.log('TokenMovementManager: Combat ended, removing movement restrictions');\n\n    const tokensToUnblock = [];\n\n    // Unblock all combatants\n    for (const combatant of combat.combatants) {\n      const token = combatant.token;\n      if (token) {\n        // Check if this token has combat-based restriction\n        const restriction = token.getFlag(MODULE_ID, 'movementRestriction');\n        if (restriction?.type === 'combat') {\n          tokensToUnblock.push(token);\n        }\n      }\n    }\n\n    if (tokensToUnblock.length > 0) {\n      await this.setCombatMovementRestriction(tokensToUnblock, false);\n      LogUtil.log(`TokenMovementManager: Unblocked movement for ${tokensToUnblock.length} combatants`);\n    }\n  }\n\n  /**\n   * Set combat-based movement restriction on tokens\n   * @param {TokenDocument[]} tokens - Array of token documents\n   * @param {boolean} restricted - Whether to restrict movement\n   */\n  static async setCombatMovementRestriction(tokens, restricted) {\n    const updates = tokens.map(token => {\n      let updateData;\n\n      if (restricted) {\n        // Setting combat restriction\n        const movementRestrictionValue = {\n          type: \"combat\",\n          enabled: true,\n          source: \"system\",\n          metadata: {\n            restrictedAt: Date.now(),\n            combatId: game.combat?.id\n          }\n        };\n        updateData = {\n          _id: token.id,\n          flags: {\n            [MODULE_ID]: {\n              movementRestriction: movementRestrictionValue\n            }\n          }\n        };\n      } else {\n        // Check if this is a combat restriction before removing\n        const currentRestriction = token.getFlag(MODULE_ID, 'movementRestriction');\n\n        // Only remove if it's a combat-based restriction\n        if (currentRestriction?.type === 'combat') {\n          updateData = {\n            _id: token.id,\n            [`flags.${MODULE_ID}.-=movementRestriction`]: null\n          };\n        } else {\n          return null;\n        }\n      }\n\n      return updateData;\n    }).filter(update => update !== null);\n\n    if (updates.length > 0) {\n      try {\n        await game.scenes.current.updateEmbeddedDocuments(\"Token\", updates);\n        LogUtil.log(`TokenMovementManager: Updated ${updates.length} tokens with combat movement restriction: ${restricted}`);\n      } catch (error) {\n        LogUtil.error(\"TokenMovementManager: Failed to update combat movement restrictions\", [error]);\n      }\n    }\n  }\n\n  /**\n   * Handle combatant creation - block movement if auto-block is enabled and combat is active\n   * @param {Combatant} combatant - The combatant document\n   * @param {object} options - Creation options\n   * @param {string} userId - The user ID who created the combatant\n   */\n  static async onCreateCombatant(combatant, options, userId) {\n    if (!game.user.isGM) return;\n\n    const SETTINGS = getSettings();\n    const autoBlock = SettingsUtil.get(SETTINGS.autoBlockMovementInCombat?.tag);\n\n    if (!autoBlock) return;\n\n    const combat = combatant.combat;\n    if (!combat?.started) return;\n\n    const token = combatant.token;\n    if (!token) return;\n\n    const currentCombatant = combat.combatant;\n    if (combatant.id === currentCombatant?.id) {\n      LogUtil.log(`TokenMovementManager: New combatant ${combatant.name} is current turn, allowing movement`);\n      return;\n    }\n\n    LogUtil.log(`TokenMovementManager: Blocking movement for newly added combatant ${combatant.name}`);\n    await this.setCombatMovementRestriction([token], true);\n  }\n\n  /**\n   * Initialize movement restrictions for active combat on page load\n   * Called when the module initializes to handle existing active combat\n   */\n  static async initializeCombatMovementRestrictions() {\n    if (!game.user.isGM) return;\n\n    const SETTINGS = getSettings();\n    const autoBlock = SettingsUtil.get(SETTINGS.autoBlockMovementInCombat?.tag);\n\n    if (!autoBlock) return;\n\n    const activeCombat = game.combat;\n    if (!activeCombat?.started) return;\n\n    LogUtil.log('TokenMovementManager: Initializing movement restrictions for active combat');\n\n    const currentCombatant = activeCombat.combatant;\n    LogUtil.log(`TokenMovementManager: Current combatant on init`, [currentCombatant]);\n\n    // Apply restrictions to all combatants except the current one\n    for (const combatant of activeCombat.combatants) {\n      const token = combatant.token;\n      if (!token) continue;\n\n      const isCurrentTurn = combatant.id === currentCombatant?.id;\n      const shouldRestrict = !isCurrentTurn;\n\n      LogUtil.log(`TokenMovementManager: Init - ${combatant.name} - isCurrentTurn: ${isCurrentTurn}, shouldRestrict: ${shouldRestrict}`);\n\n      await this.setCombatMovementRestriction([token], shouldRestrict);\n    }\n\n    LogUtil.log(`TokenMovementManager: Initialized movement restrictions for active combat`);\n  }\n}","import { MODULE_ACTION_ICONS, ACTOR_ACTION_ICONS, ICON_TYPES, getIconConfiguration, getDefaultIconLayout } from '../../constants/IconMappings.mjs';\nimport { SettingsUtil } from './SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\n\n/**\n * Utility class for managing icon layout and drag-and-drop functionality\n */\nexport class IconLayoutUtil {\n\n  /**\n   * Merge saved icon layout with default layout\n   * Preserves user's order and enabled state for existing icons\n   * Adds new icons from default layout that aren't in saved layout\n   * @param {Object} savedLayout - The saved layout from settings\n   * @param {Object} defaultLayout - The default layout\n   * @returns {Object} Merged layout\n   */\n  static mergeWithDefaultLayout(savedLayout, defaultLayout) {\n    if (!savedLayout) return defaultLayout;\n\n    const mergedLayout = {};\n\n    for (const iconType of ['moduleActions', 'actorActions']) {\n      const savedIcons = savedLayout[iconType] || [];\n      const defaultIcons = defaultLayout[iconType] || [];\n\n      const savedIconIds = new Set(savedIcons.map(icon => icon.id));\n      const mergedIcons = [...savedIcons];\n\n      let maxOrder = savedIcons.length > 0\n        ? Math.max(...savedIcons.map(icon => icon.order))\n        : -1;\n\n      for (const defaultIcon of defaultIcons) {\n        if (!savedIconIds.has(defaultIcon.id)) {\n          maxOrder++;\n          mergedIcons.push({\n            ...defaultIcon,\n            enabled: true,\n            order: maxOrder\n          });\n        }\n      }\n\n      mergedIcons.sort((a, b) => a.order - b.order);\n\n      mergedLayout[iconType] = mergedIcons.map((icon, index) => ({\n        ...icon,\n        order: index\n      }));\n    }\n\n    return mergedLayout;\n  }\n\n  /**\n   * Get icon layout with migration from saved settings\n   * @returns {Object} Icon layout\n   */\n  static getIconLayout() {\n    const SETTINGS = getSettings();\n    const savedLayout = SettingsUtil.get(SETTINGS.menuIconsLayout.tag);\n    const defaultLayout = getDefaultIconLayout();\n\n    return this.mergeWithDefaultLayout(savedLayout, defaultLayout);\n  }\n\n  /**\n   * Initialize drag and drop functionality for icon lists\n   * @param {HTMLElement} container - The settings container element\n   */\n  static initializeDragAndDrop(container) {\n    const iconLists = container.querySelectorAll('.sortable-icon-list');\n\n    iconLists.forEach(list => {\n      this.setupListEventListeners(list);\n    });\n\n    // Setup toggle functionality\n    const toggles = container.querySelectorAll('.icon-toggle');\n    toggles.forEach(toggle => {\n      toggle.addEventListener('change', this.handleIconToggle.bind(this));\n    });\n  }\n\n  /**\n   * Setup event listeners for a sortable list\n   * @param {HTMLElement} list - The list element\n   */\n  static setupListEventListeners(list) {\n    list.addEventListener('dragover', this.handleDragOver.bind(this));\n    list.addEventListener('drop', this.handleDrop.bind(this));\n    list.addEventListener('dragenter', this.handleDragEnter.bind(this));\n    list.addEventListener('dragleave', this.handleDragLeave.bind(this));\n\n    // Setup draggable items\n    const items = list.querySelectorAll('.icon-item');\n    items.forEach(item => {\n      item.addEventListener('dragstart', this.handleDragStart.bind(this));\n      item.addEventListener('dragend', this.handleDragEnd.bind(this));\n    });\n  }\n\n  /**\n   * Handle drag start event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDragStart(event) {\n    const item = event.target.closest('.icon-item');\n    if (!item) return;\n\n    item.classList.add('dragging');\n    event.dataTransfer.effectAllowed = 'move';\n    event.dataTransfer.setData('text/html', item.outerHTML);\n    event.dataTransfer.setData('text/plain', JSON.stringify({\n      iconId: item.dataset.iconId,\n      iconType: item.closest('.sortable-icon-list').dataset.iconType,\n      order: parseInt(item.dataset.order)\n    }));\n  }\n\n  /**\n   * Handle drag end event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDragEnd(event) {\n    const item = event.target.closest('.icon-item');\n    if (!item) return;\n\n    item.classList.remove('dragging');\n\n    // Clean up any drag state\n    document.querySelectorAll('.sortable-icon-list').forEach(list => {\n      list.classList.remove('drag-over');\n    });\n\n    // Remove any placeholders\n    document.querySelectorAll('.drag-placeholder').forEach(placeholder => {\n      placeholder.remove();\n    });\n  }\n\n  /**\n   * Handle drag over event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDragOver(event) {\n    event.preventDefault();\n    event.dataTransfer.dropEffect = 'move';\n\n    const list = event.currentTarget;\n    const draggingItem = document.querySelector('.icon-item.dragging');\n    if (!draggingItem) return;\n\n    // Only allow dropping within the same icon type\n    const draggedIconType = draggingItem.closest('.sortable-icon-list').dataset.iconType;\n    const targetIconType = list.dataset.iconType;\n\n    if (draggedIconType !== targetIconType) {\n      event.dataTransfer.dropEffect = 'none';\n      return;\n    }\n\n    const afterElement = this.getDragAfterElement(list, event.clientY);\n    if (afterElement == null) {\n      list.appendChild(draggingItem);\n    } else {\n      list.insertBefore(draggingItem, afterElement);\n    }\n  }\n\n  /**\n   * Handle drag enter event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDragEnter(event) {\n    event.preventDefault();\n    const list = event.currentTarget;\n    list.classList.add('drag-over');\n  }\n\n  /**\n   * Handle drag leave event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDragLeave(event) {\n    const list = event.currentTarget;\n    const rect = list.getBoundingClientRect();\n\n    if (event.clientX < rect.left || event.clientX > rect.right ||\n        event.clientY < rect.top || event.clientY > rect.bottom) {\n      list.classList.remove('drag-over');\n    }\n  }\n\n  /**\n   * Handle drop event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDrop(event) {\n    event.preventDefault();\n    const list = event.currentTarget;\n    list.classList.remove('drag-over');\n\n    // Update the order and save settings\n    this.updateIconOrder(list);\n  }\n\n  /**\n   * Get the element that the dragged item should be inserted before\n   * @param {HTMLElement} container - The container element\n   * @param {number} y - The y coordinate\n   * @returns {HTMLElement|null} The element to insert before\n   */\n  static getDragAfterElement(container, y) {\n    const draggableElements = [...container.querySelectorAll('.icon-item:not(.dragging)')];\n\n    return draggableElements.reduce((closest, child) => {\n      const box = child.getBoundingClientRect();\n      const offset = y - box.top - box.height / 2;\n\n      if (offset < 0 && offset > closest.offset) {\n        return { offset: offset, element: child };\n      } else {\n        return closest;\n      }\n    }, { offset: Number.NEGATIVE_INFINITY }).element;\n  }\n\n  /**\n   * Handle icon toggle event\n   * @param {Event} event - The change event\n   */\n  static handleIconToggle(event) {\n    const toggle = event.target;\n    const iconItem = toggle.closest('.icon-item');\n    const isEnabled = toggle.checked;\n\n    // Update visual state\n    iconItem.dataset.enabled = isEnabled;\n    if (isEnabled) {\n      iconItem.classList.remove('disabled');\n    } else {\n      iconItem.classList.add('disabled');\n    }\n\n    // Update settings\n    const list = iconItem.closest('.sortable-icon-list');\n    this.updateIconOrder(list);\n  }\n\n  /**\n   * Update icon order in the list and save to settings\n   * @param {HTMLElement} list - The sortable list\n   */\n  static async updateIconOrder(list) {\n    const iconType = list.dataset.iconType;\n    const items = [...list.querySelectorAll('.icon-item')];\n\n    const updatedIcons = items.map((item, index) => ({\n      id: item.dataset.iconId,\n      icon: this.getIconClass(item.dataset.iconId, iconType),\n      enabled: item.dataset.enabled === 'true',\n      order: index\n    }));\n\n    // Get current settings\n    const SETTINGS = getSettings();\n    const currentLayout = this.getIconLayout();\n\n    // Update the specific icon type\n    const updatedLayout = {\n      ...currentLayout,\n      [iconType]: updatedIcons\n    };\n\n    // Save to settings\n    await SettingsUtil.set(SETTINGS.menuIconsLayout.tag, updatedLayout);\n\n    // Trigger menu refresh if needed\n    if (game.flashRolls?.menu) {\n      game.flashRolls.menu.render(false);\n    }\n  }\n\n  /**\n   * Get icon class for a given icon ID and type\n   * @param {string} iconId - The icon ID\n   * @param {string} iconType - The icon type\n   * @returns {string} The icon class\n   */\n  static getIconClass(iconId, iconType) {\n    const config = getIconConfiguration(iconId, iconType);\n    return config ? config.icon : '';\n  }\n\n  /**\n   * Get enabled icons in order for rendering\n   * @param {string} iconType - The icon type (moduleActions or actorActions)\n   * @returns {Array} Array of enabled icons in order\n   */\n  static getEnabledIcons(iconType) {\n    const layout = this.getIconLayout();\n    const icons = layout[iconType] || [];\n\n    return icons\n      .filter(icon => icon.enabled)\n      .sort((a, b) => a.order - b.order);\n  }\n\n  /**\n   * Get all icons (enabled and disabled) in order for settings display\n   * @param {string} iconType - The icon type\n   * @returns {Array} Array of all icons in order\n   */\n  static getAllIcons(iconType) {\n    const layout = this.getIconLayout();\n    const icons = layout[iconType] || [];\n\n    return icons.sort((a, b) => a.order - b.order);\n  }\n\n  /**\n   * Get icon configurations for template rendering\n   * @returns {Object} Icon configurations object\n   */\n  static getIconConfigurations() {\n    return {\n      moduleActions: MODULE_ACTION_ICONS,\n      actorActions: ACTOR_ACTION_ICONS\n    };\n  }\n\n  /**\n   * Reset icons to default layout\n   * @param {string} iconType - Optional icon type to reset, or all if not specified\n   */\n  static async resetToDefault(iconType = null) {\n    const SETTINGS = getSettings();\n    const defaultLayout = getDefaultIconLayout();\n\n    if (iconType) {\n      const currentLayout = SettingsUtil.get(SETTINGS.menuIconsLayout.tag) || {};\n      const updatedLayout = {\n        ...currentLayout,\n        [iconType]: defaultLayout[iconType]\n      };\n      await SettingsUtil.set(SETTINGS.menuIconsLayout.tag, updatedLayout);\n    } else {\n      await SettingsUtil.set(SETTINGS.menuIconsLayout.tag, defaultLayout);\n    }\n  }\n\n  /**\n   * Remove an icon from the layout by disabling it\n   * @param {string} iconId - The icon ID to remove\n   * @param {string} iconType - The icon type (moduleActions or actorActions)\n   */\n  static async removeIcon(iconId, iconType) {\n    const SETTINGS = getSettings();\n    const currentLayout = this.getIconLayout();\n\n    if (!currentLayout[iconType]) {\n      LogUtil.error('IconLayoutUtil.removeIcon - Invalid icon type:', [iconType]);\n      return;\n    }\n\n    const iconIndex = currentLayout[iconType].findIndex(icon => icon.id === iconId);\n    if (iconIndex === -1) {\n      LogUtil.error('IconLayoutUtil.removeIcon - Icon not found:', [iconId, iconType]);\n      return;\n    }\n\n    const updatedLayout = {\n      ...currentLayout,\n      [iconType]: currentLayout[iconType].map(icon =>\n        icon.id === iconId ? { ...icon, enabled: false } : icon\n      )\n    };\n\n    await SettingsUtil.set(SETTINGS.menuIconsLayout.tag, updatedLayout);\n\n    const RollRequestsMenu = game.modules.get('flash-rolls-5e')?.api?.RollRequestsMenu;\n    if (RollRequestsMenu) {\n      RollRequestsMenu.refreshIfOpen();\n    }\n  }\n}","import { IconLayoutUtil } from '../utils/IconLayoutUtil.mjs';\nimport { FlashAPI } from '../core/FlashAPI.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport { getIconConfiguration } from '../../constants/IconMappings.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\n\n/**\n * Handles context menu functionality for menu icons\n * Provides options to remove icons from layout or create macros for icon actions\n */\nexport class IconContextMenu {\n  static #activeMenu = null;\n\n  /**\n   * Show context menu for an icon\n   * @param {MouseEvent} event - The context menu event\n   * @param {string} iconId - The icon identifier\n   * @param {string} iconType - The icon type (moduleActions or actorActions)\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static show(event, iconId, iconType, menu) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    this.close();\n\n    const iconConfig = getIconConfiguration(iconId, iconType);\n    if (!iconConfig) {\n      LogUtil.error('IconContextMenu: Icon configuration not found', [iconId, iconType]);\n      return;\n    }\n\n    const contextMenu = document.createElement('div');\n    contextMenu.className = 'icon-context-menu';\n    contextMenu.style.position = 'fixed';\n    contextMenu.style.left = `${event.clientX}px`;\n    contextMenu.style.top = `${event.clientY}px`;\n    contextMenu.style.zIndex = '10000';\n\n    const menuHtml = `\n      <ul>\n        <li class=\"context-menu-item\" data-action=\"remove\">\n          <i class=\"fas fa-times\"></i>\n          <span>${game.i18n.localize(\"FLASH_ROLLS.ui.contextMenu.removeIcon\")}</span>\n        </li>\n        <li class=\"context-menu-item\" data-action=\"create-macro\">\n          <i class=\"fas fa-code\"></i>\n          <span>${game.i18n.localize(\"FLASH_ROLLS.ui.contextMenu.createMacro\")}</span>\n        </li>\n      </ul>\n    `;\n\n    contextMenu.innerHTML = menuHtml;\n\n    const removeItem = contextMenu.querySelector('[data-action=\"remove\"]');\n    removeItem.addEventListener('click', async () => {\n      await this._handleRemoveIcon(iconId, iconType);\n      this.close();\n    });\n\n    const createMacroItem = contextMenu.querySelector('[data-action=\"create-macro\"]');\n    createMacroItem.addEventListener('click', async () => {\n      await this._handleCreateMacro(iconId, iconType, menu);\n      this.close();\n    });\n\n    document.body.appendChild(contextMenu);\n    this.#activeMenu = contextMenu;\n\n    const closeHandler = (e) => {\n      if (!contextMenu.contains(e.target)) {\n        this.close();\n        document.removeEventListener('click', closeHandler);\n      }\n    };\n    setTimeout(() => {\n      document.addEventListener('click', closeHandler);\n    }, 10);\n\n    this._adjustPosition(contextMenu);\n  }\n\n  /**\n   * Adjust context menu position to stay within viewport\n   * @param {HTMLElement} contextMenu - The context menu element\n   * @private\n   */\n  static _adjustPosition(contextMenu) {\n    const rect = contextMenu.getBoundingClientRect();\n    const viewportWidth = window.innerWidth;\n    const viewportHeight = window.innerHeight;\n\n    if (rect.right > viewportWidth) {\n      contextMenu.style.left = `${viewportWidth - rect.width - 10}px`;\n    }\n\n    if (rect.bottom > viewportHeight) {\n      contextMenu.style.top = `${viewportHeight - rect.height - 10}px`;\n    }\n  }\n\n  /**\n   * Handle removing an icon from the layout\n   * @param {string} iconId - The icon identifier\n   * @param {string} iconType - The icon type\n   * @private\n   */\n  static async _handleRemoveIcon(iconId, iconType) {\n    try {\n      await IconLayoutUtil.removeIcon(iconId, iconType);\n      FlashAPI.notify('info',game.i18n.format(\"FLASH_ROLLS.notifications.iconRemoved\", {\n        iconName: game.i18n.localize(getIconConfiguration(iconId, iconType)?.labelKey || iconId)\n      }));\n    } catch (error) {\n      LogUtil.error('Failed to remove icon', [error]);\n      FlashAPI.notify('error',game.i18n.localize(\"FLASH_ROLLS.notifications.iconRemoveFailed\"));\n    }\n  }\n\n  /**\n   * Handle creating a macro for an icon's action\n   * @param {string} iconId - The icon identifier\n   * @param {string} iconType - The icon type\n   * @param {RollRequestsMenu} menu - The menu instance\n   * @private\n   */\n  static async _handleCreateMacro(iconId, iconType, menu) {\n    try {\n      const SETTINGS = getSettings();\n      const addMacrosToFolder = SettingsUtil.get(SETTINGS.addMacrosToFolder.tag);\n\n      const iconConfig = getIconConfiguration(iconId, iconType);\n      let selectedActorIds = Array.from(menu?.selectedActors || []);\n\n      if (iconId === 'place-tokens') {\n        selectedActorIds = selectedActorIds.map(uniqueId => {\n          const actor = game.actors.get(uniqueId);\n          if (actor) {\n            return actor.id;\n          }\n          const token = canvas.tokens.placeables.find(t => t.id === uniqueId);\n          if (token?.actor) {\n            return token.actor.id;\n          }\n          return uniqueId;\n        });\n      }\n\n      if (iconId === 'teleport-tokens') {\n        selectedActorIds = selectedActorIds.map(uniqueId => {\n          const token = canvas.tokens.placeables.find(t => t.id === uniqueId);\n          if (token) {\n            return token.id;\n          }\n          const actor = game.actors.get(uniqueId);\n          if (actor) {\n            const actorToken = canvas.tokens.placeables.find(t => t.actor?.id === actor.id);\n            if (actorToken) {\n              return actorToken.id;\n            }\n          }\n          return null;\n        }).filter(id => id !== null);\n\n        if (selectedActorIds.length === 0) {\n          selectedActorIds = null;\n        }\n      }\n\n      let macroCommand = '';\n      let macroName = game.i18n.localize(iconConfig.labelKey);\n\n      switch (iconId) {\n        case 'lock-menu':\n          macroCommand = this._generateToggleMacro('toggleLockMenu', 'Toggle Menu Lock');\n          break;\n        case 'toggle-requests':\n          macroCommand = this._generateToggleMacro('toggleRollRequests', 'Toggle Roll Requests');\n          break;\n        case 'skip-dialogs':\n          macroCommand = this._generateToggleMacro('toggleSkipDialogs', 'Toggle Skip Dialogs');\n          break;\n        case 'group-rolls':\n          macroCommand = this._generateToggleMacro('toggleGroupRolls', 'Toggle Group Rolls');\n          break;\n        case 'show-options':\n          macroCommand = this._generateToggleMacro('toggleShowOptions', 'Toggle Show Options on Hover');\n          break;\n        case 'open-settings':\n          macroCommand = this._generateActionMacro('openSettings', 'Open Flash Rolls Settings');\n          break;\n        case 'premium-features':\n          macroCommand = this._generateActionMacro('openPremiumFeatures', 'Open Premium Features');\n          break;\n        case 'select-all':\n          macroCommand = this._generateSelectAllMacro();\n          break;\n        case 'filter-actors':\n          macroCommand = this._generateFilterActorsMacro();\n          break;\n        case 'toggle-targets':\n          macroCommand = this._generateToggleTargetsMacro(selectedActorIds);\n          break;\n        case 'heal-all':\n          macroCommand = this._generateActorActionMacro('healAll', 'Heal All', selectedActorIds);\n          break;\n        case 'kill-all':\n          macroCommand = this._generateActorActionMacro('killAll', 'Kill All', selectedActorIds);\n          break;\n        case 'remove-status':\n          macroCommand = this._generateActorActionMacro('removeStatusEffects', 'Remove Status Effects', selectedActorIds);\n          break;\n        case 'open-sheets':\n          macroCommand = this._generateActorActionMacro('openSheets', 'Open Sheets', selectedActorIds);\n          break;\n        case 'group-selected':\n          macroCommand = this._generateActorActionMacro('groupSelected', 'Create Group', selectedActorIds);\n          break;\n        case 'movement':\n          macroCommand = this._generateActorActionMacro('toggleMovement', 'Toggle Movement', selectedActorIds);\n          break;\n        case 'contested-roll':\n          macroCommand = this._generateActorActionMacro('openContestedRoll', 'Contested Roll', selectedActorIds);\n          break;\n        case 'place-tokens':\n          macroCommand = this._generatePlaceTokensMacro(selectedActorIds);\n          break;\n        case 'teleport-tokens':\n          macroCommand = this._generateTeleportTokensMacro(selectedActorIds);\n          break;\n        case 'transform':\n          macroCommand = this._generateTransformActorsMacro(selectedActorIds);\n          break;\n        default:\n          FlashAPI.notify('warn',`No macro generation configured for icon: ${iconId}`);\n          return;\n      }\n\n      let folderId = null;\n      if (addMacrosToFolder) {\n        folderId = await this._ensureFlashRollsFolder();\n      }\n\n      const macro = await Macro.create({\n        name: `FTB: ${macroName}`,\n        type: \"script\",\n        command: macroCommand,\n        img: \"modules/flash-rolls-5e/assets/bolt-circle.svg\",\n        ...(folderId && { folder: folderId }),\n        flags: {\n          \"flash-rolls-5e\": {\n            iconId,\n            iconType\n          }\n        }\n      });\n\n      FlashAPI.notify('info',game.i18n.format(\"FLASH_ROLLS.notifications.macroCreated\", {\n        macroName: macro.name\n      }));\n\n      macro.sheet.render(true);\n    } catch (error) {\n      LogUtil.error('Failed to create macro', [error]);\n      FlashAPI.notify('error',game.i18n.localize(\"FLASH_ROLLS.notifications.macroCreationFailed\"));\n    }\n  }\n\n  /**\n   * Generate macro command for simple toggle actions\n   * @param {string} methodName - The FlashAPI method name\n   * @param {string} description - Macro description\n   * @returns {string} Macro command\n   * @private\n   */\n  static _generateToggleMacro(methodName, description) {\n    return `// Flash Token Bar: ${description}\ntry {\n  FlashAPI.${methodName}();\n} catch (error) {\n  ui.notifications.error(\"Failed to execute ${description}: \" + error.message);\n}`;\n  }\n\n  /**\n   * Generate macro command for simple action methods\n   * @param {string} methodName - The FlashAPI method name\n   * @param {string} description - Macro description\n   * @returns {string} Macro command\n   * @private\n   */\n  static _generateActionMacro(methodName, description) {\n    return `// Flash Token Bar: ${description}\ntry {\n  FlashAPI.${methodName}();\n} catch (error) {\n  ui.notifications.error(\"Failed to execute ${description}: \" + error.message);\n}`;\n  }\n\n  /**\n   * Generate macro command for actor-based actions\n   * @param {string} methodName - The FlashAPI method name\n   * @param {string} description - Macro description\n   * @param {string[]} actorIds - Selected actor IDs (if any)\n   * @returns {string} Macro command\n   * @private\n   */\n  static _generateActorActionMacro(methodName, description, actorIds) {\n    if (actorIds && actorIds.length > 0) {\n      return `// Flash Token Bar: ${description}\n// Uses specific actors: ${actorIds.join(', ')}\ntry {\n  FlashAPI.${methodName}(${JSON.stringify(actorIds)});\n} catch (error) {\n  ui.notifications.error(\"Failed to execute ${description}: \" + error.message);\n}`;\n    } else {\n      return `// Flash Token Bar: ${description}\n// Uses currently selected actors\ntry {\n  const actorIds = FlashAPI.getSelectedActors();\n  if (actorIds.length === 0) {\n    FlashAPI.notify('warn',\"No actors selected\");\n  } else {\n    FlashAPI.${methodName}(actorIds);\n  }\n} catch (error) {\n  ui.notifications.error(\"Failed to execute ${description}: \" + error.message);\n}`;\n    }\n  }\n\n  /**\n   * Generate macro command for select all actors action\n   * @returns {string} Macro command\n   * @private\n   */\n  static _generateSelectAllMacro() {\n    return `// Flash Token Bar: Toggle Select All Actors\n// Toggles between selecting all and deselecting all actors\n// Optional parameter - specify which tab to select from:\n//   'pc'    - Player Characters tab\n//   'npc'   - NPCs tab\n//   'group' - Groups/Encounters tab\n// Examples:\n//   FlashAPI.selectAllActors();        // Toggle selection in current tab\n//   FlashAPI.selectAllActors('pc');    // Switch to PC tab and toggle\n//   FlashAPI.selectAllActors('npc');   // Switch to NPC tab and toggle\n\ntry {\n  FlashAPI.selectAllActors();\n} catch (error) {\n  ui.notifications.error(\"Failed to execute Toggle Select All: \" + error.message);\n}`;\n  }\n\n  /**\n   * Generate macro command for filter actors action\n   * @returns {string} Macro command\n   * @private\n   */\n  static _generateFilterActorsMacro() {\n    return `// Flash Token Bar: Filter Actors\n// Available filter options (all are optional, defaults to false):\n//   inCombat: true/false    - Show only actors in combat\n//   visible: true/false     - Show only visible tokens\n//   removeDead: true/false  - Hide dead actors (HP = 0)\n//\n// Examples:\n//   FlashAPI.filterActors({ inCombat: true });\n//   FlashAPI.filterActors({ visible: true, removeDead: true });\n//   FlashAPI.filterActors();  // Opens filter dialog\n//\n// Toggle filters:\n//   const current = FlashAPI.getActorFilters();\n//   FlashAPI.filterActors({ ...current, inCombat: !current.inCombat });\n\ntry {\n  // Customize the filters below or leave empty to open dialog\n  FlashAPI.filterActors();\n} catch (error) {\n  ui.notifications.error(\"Failed to execute Filter Actors: \" + error.message);\n}`;\n  }\n\n  /**\n   * Generate macro command for toggle targets action\n   * @param {string[]} actorIds - Selected actor IDs (if any)\n   * @returns {string} Macro command\n   * @private\n   */\n  static _generateToggleTargetsMacro(actorIds) {\n    if (actorIds && actorIds.length > 0) {\n      return `// Flash Token Bar: Toggle Targets\n// Uses specific actors: ${actorIds.join(', ')}\ntry {\n  FlashAPI.toggleTargets(${JSON.stringify(actorIds)});\n} catch (error) {\n  ui.notifications.error(\"Failed to execute Toggle Targets: \" + error.message);\n}`;\n    } else {\n      return `// Flash Token Bar: Toggle Targets\n// Uses currently selected actors, or clears all targets if none selected\ntry {\n  const actorIds = FlashAPI.getSelectedActors();\n  if (actorIds.length === 0 && game.user.targets.size === 0) {\n    FlashAPI.notify('warn',\"No actors selected and no targets to clear\");\n  } else {\n    FlashAPI.toggleTargets(actorIds);\n  }\n} catch (error) {\n  ui.notifications.error(\"Failed to execute Toggle Targets: \" + error.message);\n}`;\n    }\n  }\n\n  /**\n   * Generate macro command for place tokens action\n   * @param {string[]} actorIds - Selected actor IDs (if any)\n   * @returns {string} Macro command\n   * @private\n   */\n  static _generatePlaceTokensMacro(actorIds) {\n    if (actorIds && actorIds.length > 0) {\n      return `// Flash Token Bar: Place Tokens\n// Uses specific actors: ${actorIds.join(', ')}\n// Optional second parameter: location object {x: number, y: number}\n// Examples:\n//   FlashAPI.placeTokens(${JSON.stringify(actorIds)});                    // Interactive placement\n//   FlashAPI.placeTokens(${JSON.stringify(actorIds)}, {x: 1000, y: 1000}); // Auto-place at coordinates\n\ntry {\n  FlashAPI.placeTokens(${JSON.stringify(actorIds)});\n} catch (error) {\n  ui.notifications.error(\"Failed to execute Place Tokens: \" + error.message);\n}`;\n    } else {\n      return `// Flash Token Bar: Place Tokens\n// Uses currently selected actors\n// Optional second parameter: location object {x: number, y: number}\n// Examples:\n//   FlashAPI.placeTokens(actorIds);                    // Interactive placement\n//   FlashAPI.placeTokens(actorIds, {x: 1000, y: 1000}); // Auto-place at coordinates\n\ntry {\n  const actorIds = FlashAPI.getSelectedActors();\n  if (actorIds.length === 0) {\n    FlashAPI.notify('warn',\"No actors selected\");\n  } else {\n    FlashAPI.placeTokens(actorIds);\n  }\n} catch (error) {\n  ui.notifications.error(\"Failed to execute Place Tokens: \" + error.message);\n}`;\n    }\n  }\n\n  /**\n   * Generate macro command for teleport tokens action\n   * @param {string[]} actorIds - Selected actor IDs (if any)\n   * @returns {string} Macro command\n   * @private\n   */\n  static _generateTeleportTokensMacro(actorIds) {\n    if (actorIds && actorIds.length > 0) {\n      return `// Flash Token Bar: Teleport Tokens\n// Uses specific token IDs: ${actorIds.join(', ')}\n// Optional parameters:\n//   destinationScene: Scene ID, name, or scene object\n//   centerLocation: Object {x: number, y: number}\n// Examples:\n//   FlashAPI.teleportTokens(${JSON.stringify(actorIds)});                                    // Interactive teleport\n//   FlashAPI.teleportTokens(${JSON.stringify(actorIds)}, 'sceneId', {x: 1000, y: 1000});     // Auto-teleport by scene ID\n//   FlashAPI.teleportTokens(${JSON.stringify(actorIds)}, 'Scene Name', {x: 1000, y: 1000});  // Auto-teleport by scene name\n\ntry {\n  FlashAPI.teleportTokens(${JSON.stringify(actorIds)});\n} catch (error) {\n  ui.notifications.error(\"Failed to execute Teleport Tokens: \" + error.message);\n}`;\n    } else {\n      return `// Flash Token Bar: Teleport Tokens\n// Uses currently selected actors (converted to token IDs)\n// Optional parameters:\n//   destinationScene: Scene ID, name, or scene object\n//   centerLocation: Object {x: number, y: number}\n// Examples:\n//   FlashAPI.teleportTokens(tokenIds);                                    // Interactive teleport\n//   FlashAPI.teleportTokens(tokenIds, 'sceneId', {x: 1000, y: 1000});     // Auto-teleport by scene ID\n//   FlashAPI.teleportTokens(tokenIds, 'Scene Name', {x: 1000, y: 1000});  // Auto-teleport by scene name\n\ntry {\n  const tokenIds = FlashAPI.getSelectedActors(true);\n  if (tokenIds.length === 0) {\n    FlashAPI.notify('warn',\"No tokens found for selected actors\");\n  } else {\n    FlashAPI.teleportTokens(tokenIds);\n  }\n} catch (error) {\n  ui.notifications.error(\"Failed to execute Teleport Tokens: \" + error.message);\n}`;\n    }\n  }\n\n  /**\n   * Generate macro command for transform actors\n   * @param {string[]} actorIds - Selected actor IDs\n   * @returns {string} Macro command\n   * @private\n   */\n  static _generateTransformActorsMacro(actorIds) {\n    if (actorIds && actorIds.length > 0) {\n      return `// Flash Token Bar: Transform Actors\n// targetActorUuid: UUID of actor to transform into (shows dialog if omitted)\n// options: Object with preset ('wildshape', 'polymorph', 'appearance'), settings, and renderSheet\n// Example - transformation into specific actor as wildshape:\n// FlashAPI.transformActors(actorIds, 'Compendium.dnd5e.monsters.Actor.xyz', { preset: 'wildshape' });\n\n// Option 1: Use specific actors\nconst actorIds = ${JSON.stringify(actorIds)};\n// Option 2: Use currently selected actors in Flash Token Bar menu\n// const actorIds = FlashAPI.getSelectedActors();\n\ntry {\n  FlashAPI.transformActors(actorIds);\n} catch (error) {\n  ui.notifications.error(\"Failed to execute Transform Actors: \" + error.message);\n}`;\n    } else {\n      return `// Flash Token Bar: Transform Actors\n// targetActorUuid: UUID of actor to transform into (shows dialog if omitted)\n// options: Object with preset ('wildshape', 'polymorph', 'appearance'), settings, and renderSheet\n// Example - transformation into specific actor as wildshape:\n// FlashAPI.transformActors(actorIds, 'Compendium.dnd5e.monsters.Actor.xyz', { preset: 'wildshape' });\n\ntry {\n  // Option 1: Use currently selected actors in Flash Token Bar menu\n  const actorIds = FlashAPI.getSelectedActors();\n  // Option 2: Use specific actors\n  // const actorIds = [\"8sKqJT1gcAUvko53\",\"6xvOSmZnNUcP5Gyh\"];\n\n  if (actorIds.length === 0) {\n    FlashAPI.notify('warn',\"No actors selected\");\n  } else {\n    FlashAPI.transformActors(actorIds);\n  }\n} catch (error) {\n  ui.notifications.error(\"Failed to execute Transform Actors: \" + error.message);\n}`;\n    }\n  }\n\n  /**\n   * Ensure Flash Token Bar macro folder exists\n   * @returns {string|null} Folder ID or null\n   * @private\n   */\n  static async _ensureFlashRollsFolder() {\n    const folderName = 'Flash Token Bar';\n    let folder = game.folders.find(f => f.type === 'Macro' && f.name === folderName);\n\n    if (!folder) {\n      try {\n        folder = await Folder.create({\n          name: folderName,\n          type: 'Macro',\n          color: '#302437',\n          sort: 0\n        });\n        LogUtil.log('Created Flash Token Bar macro folder', [folder]);\n      } catch (error) {\n        LogUtil.error('Failed to create Flash Token Bar macro folder:', [error]);\n        FlashAPI.notify('warn','Failed to create Flash Token Bar macro folder. Macro will be created without folder organization.');\n        return null;\n      }\n    }\n\n    return folder?.id || null;\n  }\n\n  /**\n   * Close and cleanup the active context menu\n   */\n  static close() {\n    if (this.#activeMenu) {\n      this.#activeMenu.remove();\n      this.#activeMenu = null;\n    }\n  }\n}\n","import { LogUtil } from '../../utils/LogUtil.mjs';\nimport { RollMenuDragManager } from './RollMenuDragManager.mjs';\nimport { delay, getActorData, updateCanvasTokenSelection } from '../../helpers/Helpers.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { MODULE_ID } from '../../../constants/General.mjs';\nimport { TokenMovementManager } from '../../utils/TokenMovementManager.mjs';\nimport { IconContextMenu } from '../../ui/IconContextMenu.mjs';\nimport { GeneralUtil } from '../../utils/GeneralUtil.mjs';\nimport { FlashAPI } from '../../core/FlashAPI.mjs';\n\n/**\n * Handles Roll Requests Menu event listeners\n */\nexport class RollMenuEventManager {\n\n  /**\n   * Set to track tokens that were temporarily selected on hover\n   * @type {Set<Token>}\n   */\n  static _hoveredTokens = new Set();\n\n  /**\n   * Token that was temporarily controlled for vision preview\n   * @type {Token|null}\n   */\n  static _previewControlToken = null;\n\n  /**\n   * Previously controlled tokens before vision preview\n   * @type {Token[]}\n   */\n  static _previouslyControlledTokens = [];\n\n  /**\n   * Original controlled property descriptor for restoring\n   * @type {PropertyDescriptor|null}\n   */\n  static _originalControlledGetter = null;\n\n  /**\n   * Reference to the active menu instance\n   * @type {RollRequestsMenu|null}\n   */\n  static activeMenu = null;\n  \n  /**\n   * Attach all event listeners to the menu\n   * @param {RollRequestsMenu} menu - The menu instance\n   * @param {HTMLElement} html - The menu HTML element\n   */\n  static attachListeners(menu, html) {\n    LogUtil.log('RollMenuEventManager.attachListeners');\n\n    this.activeMenu = menu;\n\n    // Check if there are no actors and clean up tooltips\n    const actors = html.querySelectorAll('.actor');\n    if (actors.length === 0) {\n      this.cleanupActorTooltips();\n      html.classList.add('no-actors');\n    } else {\n      html.classList.remove('no-actors');\n    }\n\n    this.attachToggleHandlers(menu, html);\n    this.attachDragHandlers(menu, html);\n    this.attachTabHandlers(menu, html);\n    this.attachActorHandlers(menu, html);\n    this.attachActionIconHandlers(menu, html);\n    this.attachIconContextMenuHandlers(menu, html);\n    this.attachCompactTooltipHandlers(menu, html);\n    this.attachSearchHandlers(menu, html);\n    this.attachAccordionHandlers(menu, html);\n    this.attachSubmenuHandlers(menu, html);\n    this.attachStatusEffectHandlers(menu, html);\n    this.attachGroupHandlers(menu, html);\n    this.attachOutsideClickHandler(menu);\n  }\n  \n  /**\n   * Attach toggle switch handlers\n   */\n  static attachToggleHandlers(menu, html) {\n    html.querySelector('#flash-rolls-toggle')?.addEventListener('change', menu._onToggleRollRequests.bind(menu));\n    html.querySelector('#flash5e-skip-dialogs')?.addEventListener('change', menu._onToggleSkipDialogs.bind(menu));\n    html.querySelector('#flash5e-group-rolls-msg')?.addEventListener('change', menu._onToggleGroupRollsMsg.bind(menu));\n    html.querySelector('#flash5e-actors-all')?.addEventListener('change', menu._onToggleSelectAll.bind(menu));\n    html.querySelector('#flash5e-filter-actors')?.addEventListener('click', menu._onToggleActorFilter.bind(menu));\n    html.querySelector('#flash5e-actors-lock')?.addEventListener('click', menu._onToggleLock.bind(menu));\n    html.querySelector('.options-toggle-btn')?.addEventListener('click', menu._onToggleOptions.bind(menu));\n    html.querySelector('#flash5e-open-settings')?.addEventListener('click', menu._onOpenSettings.bind(menu));\n    html.querySelector('#flash5e-premium-features')?.addEventListener('click', menu._onOpenPremiumFeatures.bind(menu));\n    html.querySelector('#flash5e-premium-features')?.addEventListener('contextmenu', menu._onPremiumFeaturesContextMenu.bind(menu));\n  }\n  \n  /**\n   * Attach drag handle handlers\n   */\n  static attachDragHandlers(menu, html) {\n    const dragHandle = html.querySelector(RollMenuDragManager.DRAG_HANDLE_SELECTOR);\n    if (dragHandle && !dragHandle.hasAttribute('data-drag-initialized')) {\n      dragHandle.setAttribute('data-drag-initialized', 'true');\n      dragHandle.addEventListener('mousedown', (e) => {\n        RollMenuDragManager.handleDragStart(e, menu);\n      });\n    }\n  }\n  \n  /**\n   * Attach tab click handlers\n   */\n  static attachTabHandlers(menu, html) {\n    const tabs = html.querySelectorAll('.actor-tab');\n    LogUtil.log('RollMenuEventManager.attachTabHandlers - found tabs:', [tabs.length]);\n    tabs.forEach(tab => {\n      LogUtil.log('RollMenuEventManager.attachTabHandlers - attaching to tab:', [tab.dataset.tab]);\n      tab.addEventListener('click', menu._onTabClick.bind(menu));\n      tab.addEventListener('dblclick', menu._onTabDoubleClick.bind(menu));\n    });\n  }\n  \n  /**\n   * Attach action icon handlers for bulk operations\n   */\n  static attachActionIconHandlers(menu, html) {\n    html.querySelector('#flash5e-targets')?.addEventListener('click', () => {\n      this.toggleTargetsForSelected(menu);\n    });\n\n    html.querySelector('#flash5e-heal-selected')?.addEventListener('click', () => {\n      this.healSelectedActors(menu);\n    });\n\n    html.querySelector('#flash5e-kill-selected')?.addEventListener('click', () => {\n      this.killSelectedActors(menu);\n    });\n\n    html.querySelector('#flash5e-sheets')?.addEventListener('click', () => {\n      this.openSheetsForSelected(menu);\n    });\n\n    html.querySelector('#flash5e-toggle-list')?.addEventListener('change', () => {\n      this.toggleOptionsListOnHover(menu);\n    });\n\n    html.querySelector('#flash5e-remove-effects')?.addEventListener('click', () => {\n      this.removeAllStatusEffectsFromSelected(menu);\n    });\n\n    html.querySelector('#flash5e-group-selected')?.addEventListener('click', () => {\n      this.createGroupFromSelected(menu);\n    });\n\n    html.querySelector('#flash5e-lock-movement')?.addEventListener('click', () => {\n      this.toggleMovementForSelected(menu);\n    });\n\n    html.querySelector('#flash5e-contested-roll')?.addEventListener('click', () => {\n      this.openContestedRollDialog(menu);\n    });\n\n    html.querySelector('#flash5e-place-tokens')?.addEventListener('click', () => {\n      this.placeTokensForSelected(menu);\n    });\n\n    html.querySelector('#flash5e-teleport-tokens')?.addEventListener('click', () => {\n      this.teleportTokensForSelected(menu);\n    });\n\n    html.querySelector('#flash5e-transform')?.addEventListener('click', () => {\n      this.transformSelectedActors(menu);\n    });\n\n    const navButtons = html.querySelectorAll('.actor-actions-nav');\n    navButtons.forEach(button => {\n      button.addEventListener('click', (event) => {\n        this.scrollActorActions(event.currentTarget, html);\n      });\n    });\n\n    const scrollContainer = html.querySelector('.actor-actions-scrollable');\n    if (scrollContainer) {\n      this.updateActorActionsContainerHeight(html);\n      this.updateActorActionsNavState(html);\n      this.restoreActorActionsScrollPosition(scrollContainer);\n      scrollContainer.addEventListener('scroll', () => {\n        this.updateActorActionsNavState(html);\n        this.saveActorActionsScrollPosition(scrollContainer);\n      });\n    }\n  }\n\n  /**\n   * Save the current scroll position of the actor actions list to a flag\n   * @param {HTMLElement} scrollContainer - The scrollable container element\n   */\n  static saveActorActionsScrollPosition(scrollContainer) {\n    if (!scrollContainer) return;\n\n    const SETTINGS = getSettings();\n    const menuLayout = SettingsUtil.get(SETTINGS.menuLayout.tag) || 'vertical';\n\n    const scrollPosition = {\n      left: scrollContainer.scrollLeft,\n      top: scrollContainer.scrollTop\n    };\n\n    game.user.setFlag(MODULE_ID, 'actorActionsScrollPosition', scrollPosition);\n  }\n\n  /**\n   * Restore the scroll position of the actor actions list from a flag\n   * @param {HTMLElement} scrollContainer - The scrollable container element\n   */\n  static restoreActorActionsScrollPosition(scrollContainer) {\n    if (!scrollContainer) return;\n\n    const scrollPosition = game.user.getFlag(MODULE_ID, 'actorActionsScrollPosition');\n    if (!scrollPosition) return;\n\n    scrollContainer.scrollLeft = scrollPosition.left || 0;\n    scrollContainer.scrollTop = scrollPosition.top || 0;\n  }\n\n  /**\n   * Update the actor actions container max-height/max-width based on actual item dimensions\n   * @param {HTMLElement} html - The menu HTML element\n   */\n  static updateActorActionsContainerHeight(html) {\n    const scrollContainer = html.querySelector('.actor-actions-scrollable');\n    if (!scrollContainer) return;\n\n    const container = scrollContainer.closest('.actor-actions-container');\n    if (!container || container.classList.contains('no-scroll')) return;\n\n    const firstItem = scrollContainer.querySelector('li.bulk-action');\n    if (!firstItem) return;\n\n    const SETTINGS = getSettings();\n    const menuLayout = SettingsUtil.get(SETTINGS.menuLayout.tag) || 'vertical';\n    const maxIconsPerRow = SettingsUtil.get(SETTINGS.maxIconsPerRow.tag) || 5;\n\n    if (menuLayout === 'horizontal') {\n      const itemWidth = firstItem.offsetWidth;\n      const maxWidth = itemWidth * maxIconsPerRow;\n      scrollContainer.style.maxWidth = `${maxWidth}px`;\n      scrollContainer.style.maxHeight = '';\n    } else {\n      const itemHeight = firstItem.offsetHeight;\n      const maxHeight = itemHeight * maxIconsPerRow;\n      scrollContainer.style.maxHeight = `${maxHeight}px`;\n      scrollContainer.style.maxWidth = '';\n    }\n  }\n\n  /**\n   * Scroll actor actions container in the appropriate direction\n   * @param {HTMLElement} button - The navigation button that was clicked\n   * @param {HTMLElement} html - The menu HTML element\n   */\n  static scrollActorActions(button, html) {\n    const direction = button.dataset.direction;\n    const scrollContainer = html.querySelector('.actor-actions-scrollable');\n    if (!scrollContainer) return;\n\n    const firstItem = scrollContainer.querySelector('li.bulk-action');\n    if (!firstItem) return;\n\n    const SETTINGS = getSettings();\n    const menuLayout = SettingsUtil.get(SETTINGS.menuLayout.tag) || 'vertical';\n    const maxIconsPerRow = SettingsUtil.get(SETTINGS.maxIconsPerRow.tag) || 5;\n    const itemsToScroll = Math.max(1, maxIconsPerRow - 1);\n\n    if (menuLayout === 'horizontal') {\n      const itemWidth = firstItem.offsetWidth;\n      const scrollAmount = direction === 'left' ? -(itemWidth * itemsToScroll) : (itemWidth * itemsToScroll);\n      scrollContainer.scrollBy({\n        left: scrollAmount,\n        behavior: 'smooth'\n      });\n    } else {\n      const itemHeight = firstItem.offsetHeight;\n      const scrollAmount = direction === 'up' ? -(itemHeight * itemsToScroll) : (itemHeight * itemsToScroll);\n      scrollContainer.scrollBy({\n        top: scrollAmount,\n        behavior: 'smooth'\n      });\n    }\n\n    setTimeout(() => {\n      this.updateActorActionsNavState(html);\n    }, 300);\n  }\n\n  /**\n   * Update the enabled/disabled state of actor actions navigation arrows\n   * @param {HTMLElement} html - The menu HTML element\n   */\n  static updateActorActionsNavState(html) {\n    const scrollContainer = html.querySelector('.actor-actions-scrollable');\n    if (!scrollContainer) return;\n\n    const SETTINGS = getSettings();\n    const menuLayout = SettingsUtil.get(SETTINGS.menuLayout.tag) || 'vertical';\n\n    let firstButton, secondButton, isAtStart, isAtEnd;\n\n    if (menuLayout === 'horizontal') {\n      firstButton = html.querySelector('.actor-actions-nav-left');\n      secondButton = html.querySelector('.actor-actions-nav-right');\n\n      if (!firstButton || !secondButton) return;\n\n      const scrollLeft = scrollContainer.scrollLeft;\n      const scrollWidth = scrollContainer.scrollWidth;\n      const clientWidth = scrollContainer.clientWidth;\n\n      isAtStart = scrollLeft <= 1;\n      isAtEnd = scrollLeft + clientWidth >= scrollWidth - 1;\n    } else {\n      firstButton = html.querySelector('.actor-actions-nav-up');\n      secondButton = html.querySelector('.actor-actions-nav-down');\n\n      if (!firstButton || !secondButton) return;\n\n      const scrollTop = scrollContainer.scrollTop;\n      const scrollHeight = scrollContainer.scrollHeight;\n      const clientHeight = scrollContainer.clientHeight;\n\n      isAtStart = scrollTop <= 1;\n      isAtEnd = scrollTop + clientHeight >= scrollHeight - 1;\n    }\n\n    if (isAtStart) {\n      firstButton.classList.add('disabled');\n      firstButton.setAttribute('disabled', 'true');\n    } else {\n      firstButton.classList.remove('disabled');\n      firstButton.removeAttribute('disabled');\n    }\n\n    if (isAtEnd) {\n      secondButton.classList.add('disabled');\n      secondButton.setAttribute('disabled', 'true');\n    } else {\n      secondButton.classList.remove('disabled');\n      secondButton.removeAttribute('disabled');\n    }\n  }\n\n  /**\n   * Attach context menu handlers to all icon elements\n   */\n  static attachIconContextMenuHandlers(menu, html) {\n    const moduleIcons = html.querySelectorAll('[data-icon-id][data-icon-type=\"moduleActions\"]');\n    const actorIcons = html.querySelectorAll('[data-icon-id][data-icon-type=\"actorActions\"]');\n\n    const allIcons = [...moduleIcons, ...actorIcons];\n\n    allIcons.forEach(iconElement => {\n      const iconId = iconElement.dataset.iconId;\n      const iconType = iconElement.dataset.iconType;\n\n      if (!iconId || !iconType) return;\n\n      iconElement.addEventListener('contextmenu', (event) => {\n        event.preventDefault();\n        event.stopPropagation();\n\n        IconContextMenu.show(event, iconId, iconType, menu);\n      });\n    });\n  }\n\n  /**\n   * Attach actor selection handlers\n   */\n  static attachActorHandlers(menu, html) {\n    html.querySelectorAll('.actor.drag-wrapper').forEach(wrapper => {\n      wrapper.addEventListener('click', (event) => {\n        if (wrapper.hasAttribute('data-non-selectable')) {\n          return;\n        }\n        menu._onActorClick.call(menu, event);\n      });\n\n      const sheetIcon = wrapper.querySelector('.icon-sheet');\n      if (sheetIcon) {\n        sheetIcon.addEventListener('click', (event) => {\n          event.preventDefault();\n          event.stopPropagation();\n\n          const actorId = wrapper.dataset.actorId;\n          const tokenId = wrapper.dataset.tokenId;\n\n          this.openActorSheetById(actorId, tokenId);\n        });\n      }\n\n      const targetIcon = wrapper.querySelector('.icon-target');\n      if (targetIcon) {\n        targetIcon.addEventListener('click', (event) => {\n          event.preventDefault();\n          event.stopPropagation();\n          \n          const actorId = wrapper.dataset.actorId;\n          const tokenId = wrapper.dataset.tokenId;\n          \n          this.toggleActorTargetById(actorId, tokenId);\n        });\n      }\n\n      const actorImg = wrapper.querySelector('.actor-img');\n      if (actorImg) {\n        actorImg.addEventListener('contextmenu', (event) => {\n          event.preventDefault();\n          event.stopPropagation();\n          \n          const tokenId = wrapper.dataset.tokenId;\n          const actorId = wrapper.dataset.actorId;\n          \n          let token = tokenId ? canvas.tokens.get(tokenId) : null;\n          if (!token && actorId) {\n            token = canvas.tokens.placeables.find(t => t.actor?.id === actorId);\n          }\n          \n          if (token) {\n            canvas.animatePan({ x: token.x, y: token.y, duration: 250 });\n          }\n        });\n\n        // Add hover handlers for temporary token selection preview\n        actorImg.addEventListener('mouseenter', (event) => {\n          this.showTokenSelectionPreview(wrapper, menu);\n        });\n\n        actorImg.addEventListener('mouseleave', (event) => {\n          this.hideTokenSelectionPreview(wrapper, menu);\n        });\n      }\n    });\n  }\n  \n  /**\n   * Clean up any existing actor data tooltips\n   */\n  static cleanupActorTooltips() {\n    const existingTooltips = document.querySelectorAll('.actor-data-tooltip');\n    existingTooltips.forEach(tooltip => tooltip.remove());\n  }\n\n  /**\n   * Attach tooltip handlers for compact mode\n   */\n  static attachCompactTooltipHandlers(menu, html) {\n    this.cleanupActorTooltips();\n    \n    if (!html.classList.contains('compact')) return;\n    \n    const actors = html.querySelectorAll('#flash-rolls-menu.compact .actor');\n    \n    actors.forEach(actor => {\n      const actorData = actor.querySelector('.actor-data');\n      if (!actorData) return;\n      \n      let tooltipCopy = null;\n      \n      const showTooltip = async (event) => {\n        \n        const existingTooltip = document.querySelector('.actor-data-tooltip');\n        if (existingTooltip) {\n          existingTooltip.remove();\n        }\n        \n        tooltipCopy = actorData.cloneNode(true);\n        \n        const actorRect = actor.getBoundingClientRect();\n        const menuRect = html.getBoundingClientRect();\n        const isLeftEdge = html.classList.contains('left-edge');\n        const isHorizontalLayout = html.hasAttribute('data-layout') && html.getAttribute('data-layout') === 'horizontal';\n        \n        if (isHorizontalLayout) {\n          const actorImg = actor.querySelector('.actor-img');\n          const imgRect = actorImg ? actorImg.getBoundingClientRect() : actorRect;\n          \n          const imgCenterX = imgRect.left + (imgRect.width / 2) - menuRect.left - 16;\n          \n          tooltipCopy.style.left = `${imgCenterX}px`;\n          tooltipCopy.style.transform = 'translateX(-50%)';\n          tooltipCopy.style.bottom = `${menuRect.bottom - actorRect.top + 8}px`;\n          tooltipCopy.style.top = 'auto';\n          tooltipCopy.style.right = 'auto';\n        } else {\n          if (isLeftEdge) {\n            tooltipCopy.style.left = `${actorRect.right - menuRect.left - 8}px`;\n          } else {\n            tooltipCopy.style.right = `${menuRect.right - actorRect.left - 8}px`;\n          }\n          tooltipCopy.style.top = `${actorRect.top - menuRect.top}px`;\n        }\n        tooltipCopy.className = 'actor-data-tooltip';\n        \n        document.querySelector('#flash-rolls-menu').appendChild(tooltipCopy);\n        \n        setTimeout(()=>{\n          tooltipCopy?.classList.add('visible');\n        }, menu.selectedActors.size > 0 ? 300 : 0);\n      };\n      \n      const hideTooltip = () => {\n        if (tooltipCopy) {\n          tooltipCopy.remove();\n          tooltipCopy = null;\n        }\n      };\n      \n      actor.addEventListener('mouseenter', showTooltip);\n      actor.addEventListener('mouseleave', hideTooltip);\n      \n      const scrollContainer = actor.closest('ul');\n      if (scrollContainer) {\n        scrollContainer.addEventListener('scroll', hideTooltip);\n      }\n    });\n  }\n  \n  /**\n   * Attach search input handlers\n   */\n  static attachSearchHandlers(menu, html) {\n    const searchInput = html.querySelector('.search-input');\n    if (searchInput) {\n      searchInput.addEventListener('input', menu._onSearchInput.bind(menu));\n      \n      searchInput.addEventListener('click', (event) => {\n        event.target.select();\n      });\n      \n      searchInput.addEventListener('focus', (event) => {\n        event.target.select();\n        menu.isSearchFocused = true;\n        game.user.setFlag(MODULE_ID, 'searchFocused', true);\n      });\n      \n      searchInput.addEventListener('blur', () => {\n        menu.isSearchFocused = false;\n        game.user.setFlag(MODULE_ID, 'searchFocused', false);\n        const accordion = html.querySelector('.request-types-accordion');\n        if (accordion && !html.matches(':hover')) {\n          accordion.classList.remove('hover-visible');\n        }\n      });\n    }\n  }\n  \n  /**\n   * Attach accordion and request type handlers\n   */\n  static attachAccordionHandlers(menu, html) {    \n    const SETTINGS = getSettings();\n    const showOnHover = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag);\n    \n    const accordion = html.querySelector('.request-types-accordion');\n    if (accordion) {\n      const mouseEnterHandler = () => {\n        const showOptionsListOnHover = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag);\n        if (menu.selectedActors.size > 0 && showOptionsListOnHover) {\n          accordion?.classList.add('hover-visible');\n        }\n      };\n      \n      const mouseLeaveHandler = () => {\n        if (!menu.isSearchFocused) {\n          accordion?.classList.remove('hover-visible');\n        }\n      };\n      \n      menu._accordionMouseEnter = mouseEnterHandler;\n      menu._accordionMouseLeave = mouseLeaveHandler;\n      \n      if (showOnHover) {\n        html.addEventListener('mouseenter', mouseEnterHandler);\n        html.addEventListener('mouseleave', mouseLeaveHandler);\n        menu._accordionListenersAttached = true;\n      } else {\n        menu._accordionListenersAttached = false;\n      }\n    }\n    \n    const requestTypesContainer = html.querySelector('.request-types');\n    LogUtil.log('RollMenuEventManager.attachAccordionHandlers', [requestTypesContainer]);\n    if (requestTypesContainer) {\n      requestTypesContainer.addEventListener('click', (event) => {\n        if (event.target.classList.contains('btn-macro')) {\n          event.preventDefault();\n          event.stopPropagation();\n          event.stopImmediatePropagation();\n\n          const parentItem = event.target.closest('.sub-item') || event.target.closest('.request-type-item');\n          if (parentItem) {\n            const customEvent = {\n              ...event,\n              currentTarget: parentItem\n            };\n            menu._onMacroButtonClick(customEvent);\n          }\n          return;\n        }\n        \n        const macroBtn = event.target.closest('.btn-macro');\n        if (macroBtn) {\n          event.preventDefault();\n          event.stopPropagation();\n          event.stopImmediatePropagation();\n          \n          const parentItem = macroBtn.closest('.sub-item') || macroBtn.closest('.request-type-item');\n          if (parentItem) {\n            const customEvent = {\n              ...event,\n              currentTarget: parentItem\n            };\n            menu._onMacroButtonClick(customEvent);\n          }\n          return;\n        }\n        \n        const requestHeader = event.target.closest('.request-type-header');\n        \n        if (requestHeader) {\n          const requestItem = requestHeader.closest('.request-type-item');\n          \n          if (requestHeader.classList.contains('accordion-header')) {\n            menu._onAccordionToggle(event);\n            return;\n          }\n          \n          if (requestHeader.classList.contains('toggle') && requestItem && requestItem.classList.contains('rollable')) {\n            const customEvent = {\n              ...event,\n              currentTarget: requestItem\n            };\n            menu._onRequestTypeClick(customEvent);\n            return;\n          }\n        }\n        \n        const subItem = event.target.closest('.sub-item');\n        if (subItem && subItem.dataset.id) {\n          const customEvent = {\n            ...event,\n            currentTarget: subItem\n          };\n          menu._onRollTypeClick(customEvent);\n        }\n      });\n    }\n  }\n\n  /**\n   * Attach submenu tab handlers\n   */\n  static attachSubmenuHandlers(menu, html) {\n    try {\n      const submenuTabs = html.querySelectorAll('.submenu-tabs li[data-tab]');\n      submenuTabs.forEach(tab => {\n        tab.addEventListener('click', menu._onSubmenuTabClick.bind(menu));\n      });\n    } catch (error) {\n      LogUtil.error('RollMenuEventManager.attachSubmenuHandlers error:', [error]);\n    }\n  }\n\n  /**\n   * Attach status effect handlers\n   */\n  static attachStatusEffectHandlers(menu, html) {\n    try {\n      const statusEffects = html.querySelectorAll('.status-effects .status-effect');\n      statusEffects.forEach(statusElement => {\n        if (!statusElement.dataset.listenerAttached) {\n          statusElement.dataset.listenerAttached = 'true';\n          statusElement.addEventListener('click', menu._onStatusEffectClick.bind(menu));\n        }\n      });\n    } catch (error) {\n      LogUtil.error('RollMenuEventManager.attachStatusEffectHandlers error:', [error]);\n    }\n  }\n  \n  /**\n   * Attach group expansion/collapse handlers\n   */\n  static attachGroupHandlers(menu, html) {\n    const groupExpandButtons = html.querySelectorAll('.group-expand-btn');\n    groupExpandButtons.forEach(button => {\n      button.addEventListener('click', async (event) => {\n        event.preventDefault();\n        event.stopPropagation();\n        \n        const groupId = button.dataset.groupId;\n        const isExpanded = menu.groupExpansionStates[groupId] ?? false;\n        \n        menu.groupExpansionStates[groupId] = !isExpanded;\n        await game.user.setFlag(MODULE_ID, 'groupExpansionStates', menu.groupExpansionStates);\n        menu.render();\n      });\n    });\n  }\n\n  /**\n   * Attach outside click handler with delay to prevent immediate closure\n   */\n  static attachOutsideClickHandler(menu) {\n    setTimeout(() => {\n      document.addEventListener('click', menu._onClickOutside, true);\n    }, 100);\n  }\n\n  /**\n   * Toggle targeting for all selected actors, or clear all targets if none selected\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static toggleTargetsForSelected(menu) {\n    if (menu.selectedActors.size > 0) {\n      menu.selectedActors.forEach(uniqueId => {\n        const actor = getActorData(uniqueId);\n        if (!actor) return;\n\n        const actorId = actor.id;\n        const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n\n        this.toggleActorTargetById(actorId, tokenId);\n      });\n    } else {\n      if (game.user.targets.size > 0) {\n        const targetCount = game.user.targets.size;\n        game.user.targets.forEach(token => {\n          token.setTarget(false, { releaseOthers: false });\n        });\n        FlashAPI.notify('info', `Cleared ${targetCount} target(s)`);\n      }\n    }\n  }\n\n  /**\n   * Open character sheets for all selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static openSheetsForSelected(menu) {\n    if (menu.currentTab === 'group') {\n      this.openGroupSheetsForSelected(menu);\n    } else {\n      menu.selectedActors.forEach(uniqueId => {\n        const actor = getActorData(uniqueId);\n        if (!actor) return;\n        \n        const actorId = actor.id;\n        const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n        \n        this.openActorSheetById(actorId, tokenId);\n      });\n    }\n  }\n\n  /**\n   * Open group sheets for groups that contain selected members\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static openGroupSheetsForSelected(menu) {\n    const context = menu._lastPreparedContext || {};\n    const groupActors = context.actors || [];\n    const openedGroups = new Set();\n    \n    groupActors.forEach(groupData => {\n      if (groupData.isGroup && groupData.members) {\n        const hasSelectedMembers = groupData.members.some(member => \n          menu.selectedActors.has(member.uniqueId)\n        );\n        \n        if (hasSelectedMembers && !openedGroups.has(groupData.id)) {\n          this.openActorSheetById(groupData.id, groupData.tokenId);\n          openedGroups.add(groupData.id);\n        }\n      }\n    });\n  }\n\n  /**\n   * Heal all selected actors to full HP\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static healSelectedActors(menu) {\n    menu.selectedActors.forEach(uniqueId => {\n      const actor = getActorData(uniqueId);\n      if (!actor) return;\n      \n      const actorId = actor.id;\n      const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n      \n      this.healActorById(actorId, tokenId);\n    });\n  }\n\n  /**\n   * Set HP to 0 for all selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static killSelectedActors(menu) {\n    menu.selectedActors.forEach(uniqueId => {\n      const actor = getActorData(uniqueId);\n      if (!actor) return;\n      \n      const actorId = actor.id;\n      const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n      \n      this.killActorById(actorId, tokenId);\n    });\n  }\n\n  /**\n   * Remove all status effects from selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async removeAllStatusEffectsFromSelected(menu) {\n    if (menu.selectedActors.size === 0) {\n      FlashAPI.notify('warn', \"No actors selected\");\n      return;\n    }\n\n    let totalRemoved = 0;\n    let totalActors = 0;\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n      \n      totalActors++;\n      const statusEffects = actor.appliedEffects.filter(effect =>\n        effect.statuses?.size > 0 || effect.flags?.core?.statusId\n      );\n      \n      if (statusEffects.length > 0) {\n        for (const effect of statusEffects) {\n          try {\n            await effect.delete();\n            totalRemoved++;\n          } catch (error) {\n            LogUtil.error(`Failed to remove status effect from ${actor.name}`, [error]);\n          }\n        }\n      }\n    }\n    \n    if (totalRemoved > 0) {\n      FlashAPI.notify('info', `Removed ${totalRemoved} status effects from ${totalActors} actor(s)`);\n    } else {\n      FlashAPI.notify('info', `No status effects to remove from selected actors`);\n    }\n  }\n\n  /**\n   * Toggle target state for a single actor\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   */\n  static toggleActorTarget(wrapper) {\n    const tokenId = wrapper.dataset.tokenId;\n    const actorId = wrapper.dataset.actorId;\n    \n    let token = tokenId ? canvas.tokens.get(tokenId) : null;\n    if (!token && actorId) {\n      token = canvas.tokens.placeables.find(t => t.actor?.id === actorId);\n    }\n    \n    if (token) {\n      const isTargeted = game.user.targets.has(token);\n      token.setTarget(!isTargeted, { releaseOthers: false });\n    }\n  }\n\n  /**\n   * Open character sheet for a single actor\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   */\n  static openActorSheet(wrapper) {\n    const actorId = wrapper.dataset.actorId;\n    const tokenId = wrapper.dataset.tokenId;\n    \n    if (actorId) {\n      let actor;\n      if (tokenId) {\n        const token = canvas.tokens.get(tokenId);\n        actor = token?.actor || game.actors.get(actorId);\n      } else {\n        actor = game.actors.get(actorId);\n      }\n      actor?.sheet.render(true);\n    }\n  }\n\n  /**\n   * Heal actor to full HP\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   */\n  static healActor(wrapper) {\n    const actorId = wrapper.dataset.actorId;\n    const tokenId = wrapper.dataset.tokenId;\n    \n    let actor;\n    if (tokenId) {\n      const token = canvas.tokens.get(tokenId);\n      actor = token?.actor || game.actors.get(actorId);\n    } else {\n      actor = game.actors.get(actorId);\n    }\n    \n    if (actor && actor.system?.attributes?.hp) {\n      const maxHP = actor.system.attributes.hp.max;\n      actor.update({ 'system.attributes.hp.value': maxHP });\n    }\n  }\n\n  /**\n   * Set actor HP to 0\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   */\n  static killActor(wrapper) {\n    const actorId = wrapper.dataset.actorId;\n    const tokenId = wrapper.dataset.tokenId;\n    \n    let actor;\n    if (tokenId) {\n      const token = canvas.tokens.get(tokenId);\n      actor = token?.actor || game.actors.get(actorId);\n    } else {\n      actor = game.actors.get(actorId);\n    }\n    \n    if (actor && actor.system?.attributes?.hp) {\n      actor.update({ 'system.attributes.hp.value': 0 });\n    }\n  }\n\n  /**\n   * Toggle target state for a single actor by ID\n   * @param {string} actorId - The actor ID\n   * @param {string} tokenId - The token ID (optional)\n   */\n  static toggleActorTargetById(actorId, tokenId) {\n    let token = tokenId ? canvas.tokens.get(tokenId) : null;\n    if (!token && actorId) {\n      token = canvas.tokens.placeables.find(t => t.actor?.id === actorId);\n    }\n    \n    if (token) {\n      const isTargeted = game.user.targets.has(token);\n      token.setTarget(!isTargeted, { releaseOthers: false });\n    }\n  }\n\n  /**\n   * Open character sheet for a single actor by ID\n   * @param {string} actorId - The actor ID\n   * @param {string} tokenId - The token ID (optional)\n   */\n  static openActorSheetById(actorId, tokenId) {\n    if (actorId) {\n      let actor;\n      if (tokenId) {\n        const token = canvas.tokens.get(tokenId);\n        actor = token?.actor || game.actors.get(actorId);\n      } else {\n        actor = game.actors.get(actorId);\n      }\n      actor?.sheet.render(true);\n    }\n  }\n\n  /**\n   * Heal actor to full HP by ID\n   * @param {string} actorId - The actor ID\n   * @param {string} tokenId - The token ID (optional)\n   */\n  static healActorById(actorId, tokenId) {\n    let actor;\n    if (tokenId) {\n      const token = canvas.tokens.get(tokenId);\n      actor = token?.actor || game.actors.get(actorId);\n    } else {\n      actor = game.actors.get(actorId);\n    }\n    \n    if (actor && actor.system?.attributes?.hp) {\n      const maxHP = actor.system.attributes.hp.max;\n      actor.update({ 'system.attributes.hp.value': maxHP });\n    }\n  }\n\n  /**\n   * Set actor HP to 0 by ID\n   * @param {string} actorId - The actor ID\n   * @param {string} tokenId - The token ID (optional)\n   */\n  static killActorById(actorId, tokenId) {\n    let actor;\n    if (tokenId) {\n      const token = canvas.tokens.get(tokenId);\n      actor = token?.actor || game.actors.get(actorId);\n    } else {\n      actor = game.actors.get(actorId);\n    }\n    \n    if (actor && actor.system?.attributes?.hp) {\n      actor.update({ 'system.attributes.hp.value': 0 });\n    }\n  }\n\n  /**\n   * Show temporary token selection preview on hover\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static showTokenSelectionPreview(wrapper, menu) {\n    const tokenId = wrapper.dataset.tokenId;\n    const actorId = wrapper.dataset.actorId;\n\n    let token = tokenId ? canvas.tokens.get(tokenId) : null;\n    if (!token && actorId) {\n      token = canvas.tokens.placeables.find(t => t.actor?.id === actorId);\n    }\n\n    if (token && !token.hover) {\n      token.hover = true;\n      token.renderFlags.set({refreshState: true});\n      this._hoveredTokens.add(token);\n\n      const SETTINGS = getSettings();\n      const showTokenVisionOnHover = SettingsUtil.get(SETTINGS.showTokenVisionOnHover.tag);\n\n      if (showTokenVisionOnHover && canvas.scene?.tokenVision && token.document.sight?.enabled && game.user.isGM) {\n        this._previouslyControlledTokens = [...canvas.tokens.controlled];\n        this._previewControlToken = token;\n\n        this._originalControlledGetter = Object.getOwnPropertyDescriptor(Object.getPrototypeOf(token), 'controlled');\n\n        Object.defineProperty(token, 'controlled', {\n          get: () => true,\n          configurable: true\n        });\n\n        token.initializeVisionSource();\n        canvas.perception.update({\n          initializeVision: true,\n          refreshVision: true\n        });\n      }\n    }\n  }\n\n  /**\n   * Toggle the show options list on hover setting\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async toggleOptionsListOnHover(menu) {    \n    const SETTINGS = getSettings();\n    const currentValue = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag);\n    const accordion = menu.element.querySelector('.request-types-accordion');\n    const accordionVisible = accordion?.classList.contains('hover-visible');\n    \n    const newValue = !currentValue;\n    await SettingsUtil.set(SETTINGS.showOptionsListOnHover.tag, newValue);\n\n    RollMenuEventManager.updateAccordionHoverBehaviorNoRender(menu, newValue);\n\n    if(newValue===false || menu.selectedActors.size === 0){\n      accordion?.classList.remove('hover-visible');\n    }else if(newValue===true && menu.selectedActors.size > 0){\n      accordion?.classList.add('hover-visible');\n    }\n  }\n\n  /**\n   * Update accordion hover behavior based on setting\n   * @param {RollRequestsMenu} menu - The menu instance\n   * @param {boolean} showOnHover - Whether to show accordion on hover\n   */\n  static updateAccordionHoverBehavior(menu, showOnHover) {\n    menu.render();\n  }\n\n  /**\n   * Update accordion hover behavior without re-rendering\n   * @param {RollRequestsMenu} menu - The menu instance\n   * @param {boolean} showOnHover - Whether to show accordion on hover\n   */\n  static updateAccordionHoverBehaviorNoRender(menu, showOnHover) {\n    const html = menu.element;\n    const accordion = html.querySelector('.request-types-accordion');\n    if (!accordion || !menu._accordionMouseEnter) return;\n\n    html.removeEventListener('mouseenter', menu._accordionMouseEnter);\n    html.removeEventListener('mouseleave', menu._accordionMouseLeave);\n    accordion.classList.remove('hover-visible');\n\n    if(showOnHover) {\n      html.addEventListener('mouseenter', menu._accordionMouseEnter);\n      html.addEventListener('mouseleave', menu._accordionMouseLeave);\n    }\n  }\n\n  /**\n   * Hide temporary token selection preview on mouse leave\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static hideTokenSelectionPreview(wrapper, menu) {\n    const tokenId = wrapper.dataset.tokenId;\n    const actorId = wrapper.dataset.actorId;\n\n    let token = tokenId ? canvas.tokens.get(tokenId) : null;\n    if (!token && actorId) {\n      token = canvas.tokens.placeables.find(t => t.actor?.id === actorId);\n    }\n\n    if (token && this._hoveredTokens.has(token)) {\n      token.hover = false;\n      token.renderFlags.set({refreshState: true});\n      this._hoveredTokens.delete(token);\n\n      if (this._previewControlToken === token && game.user.isGM) {\n        delete token.controlled;\n\n        if (this._originalControlledGetter) {\n          Object.defineProperty(token, 'controlled', this._originalControlledGetter);\n          this._originalControlledGetter = null;\n        }\n\n        token.initializeVisionSource();\n\n        this._previouslyControlledTokens.forEach(t => {\n          if (t.scene === canvas.scene) {\n            t.initializeVisionSource();\n          }\n        });\n\n        canvas.perception.update({\n          initializeVision: true,\n          refreshVision: true\n        });\n\n        this._previewControlToken = null;\n        this._previouslyControlledTokens = [];\n      }\n    }\n  }\n\n  /**\n   * Create a new group or encounter actor from selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async createGroupFromSelected(menu) {\n    if (menu.selectedActors.size === 0) {\n      FlashAPI.notify('warn', \"No actors selected\");\n      return;\n    }\n\n    const actorGroups = new Map(); \n    const tokenAssociationsByScene = {}; \n    const currentSceneId = game.scenes.current?.id;\n    let playerOwnedCount = 0;\n    let totalSelectedCount = 0;\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n\n      totalSelectedCount++;\n      const baseActorId = actor.id;\n\n      if (actorGroups.has(baseActorId)) {\n        const group = actorGroups.get(baseActorId);\n        group.count++;\n        if (actor.tokenId) {\n          group.tokenIds.push(actor.tokenId);\n        }\n      } else {\n        actorGroups.set(baseActorId, {\n          actor: actor,\n          count: 1,\n          tokenIds: actor.tokenId ? [actor.tokenId] : []\n        });\n\n        const baseActor = game.actors.get(baseActorId);\n        if (baseActor?.hasPlayerOwner) {\n          playerOwnedCount++;\n        }\n      }\n\n      if (uniqueId !== actor.id && currentSceneId) {\n        const tokenUuid = `Scene.${currentSceneId}.Token.${uniqueId}`;\n\n        if (!tokenAssociationsByScene[currentSceneId]) {\n          tokenAssociationsByScene[currentSceneId] = {};\n        }\n\n        if (!tokenAssociationsByScene[currentSceneId][baseActorId]) {\n          tokenAssociationsByScene[currentSceneId][baseActorId] = [];\n        }\n\n        tokenAssociationsByScene[currentSceneId][baseActorId].push(tokenUuid);\n      }\n    }\n\n    if (actorGroups.size === 0) {\n      FlashAPI.notify('warn', \"No valid actors found\");\n      return;\n    }\n\n    const playerOwnedRatio = playerOwnedCount / actorGroups.size;\n    const actorType = playerOwnedRatio >= 0.5 ? \"group\" : \"encounter\";\n    const defaultName = actorType === \"group\" ? \"New Group\" : \"New Encounter\";\n\n    const members = [];\n    if (actorType === \"group\") {\n      for (const [baseActorId, { actor, count }] of actorGroups) {\n        const baseActor = game.actors.get(baseActorId);\n        if (baseActor) {\n          members.push({\n            actor: baseActorId\n          });\n        }\n      }\n    } else {\n      for (const [baseActorId, { actor, count }] of actorGroups) {\n        members.push({\n          uuid: `Actor.${baseActorId}`,\n          quantity: {\n            value: count,\n            formula: \"\"\n          }\n        });\n      }\n    }\n\n    try {\n      const newActor = await Actor.create({\n        name: defaultName,\n        type: actorType,\n        img: \"icons/svg/mystery-man.svg\", // Default icon\n        system: {\n          members: members\n        },\n        flags: {\n          \"flash-rolls-5e\": {\n            tokenAssociationsByScene: tokenAssociationsByScene\n          }\n        },\n        ownership: {\n          default: CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER,\n          [game.user.id]: CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER\n        }\n      });\n\n      if (newActor) {\n        for (const [sceneId, sceneAssociations] of Object.entries(tokenAssociationsByScene)) {\n          for (const tokenUuids of Object.values(sceneAssociations)) {\n            for (const tokenUuid of tokenUuids) {\n              try {\n                const tokenDoc = await fromUuid(tokenUuid);\n                if (tokenDoc) {\n                  await tokenDoc.setFlag(MODULE_ID, 'groupId', newActor.id);\n                }\n              } catch (error) {\n                LogUtil.log(`createGroupFromSelected - Failed to set groupId on token ${tokenUuid}`, error);\n              }\n            }\n          }\n        }\n\n        newActor.sheet.render(true);\n\n        const memberSummary = Array.from(actorGroups.values()).map(({ actor, count }) =>\n          count > 1 ? `${actor.name} (x${count})` : actor.name\n        ).join(\", \");\n        FlashAPI.notify('info', `Created ${actorType} \"${newActor.name}\" (${totalSelectedCount} tokens, ${actorGroups.size} unique: ${memberSummary})`);\n\n        LogUtil.log(`createGroupFromSelected - Created ${actorType}:`, {\n          newActor,\n          totalSelectedCount,\n          uniqueActorCount: actorGroups.size,\n          playerOwnedCount,\n          playerOwnedRatio,\n          tokenAssociationsByScene,\n          members: Array.from(actorGroups.entries()).map(([id, { actor, count, tokenUuids }]) => ({\n            id,\n            name: actor.name,\n            quantity: count,\n            tokenUuids\n          }))\n        });\n      }\n    } catch (error) {\n      LogUtil.error(\"Failed to create group/encounter actor:\", error);\n      FlashAPI.notify('warn', `Failed to create ${actorType}: ${error.message}`);\n    }\n  }\n\n  /**\n   * Toggle movement restriction for selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async toggleMovementForSelected(menu) {\n    await TokenMovementManager.toggleMovementForSelected(menu);\n  }\n\n  /**\n   * Open contested roll dialog with selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async openContestedRollDialog(menu) {\n    const menuToUse = menu || this.activeMenu;\n\n    if (!menuToUse || menuToUse.selectedActors.size === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n      return;\n    }\n\n    const actors = [];\n    for (const uniqueId of menuToUse.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (actor) {\n        const tokenDoc = game.scenes.current?.tokens.get(uniqueId);\n        const token = canvas.tokens?.get(uniqueId);\n        const tokenId = (tokenDoc || token) ? uniqueId : null;\n\n        actors.push({\n          actor: actor,\n          uniqueId: uniqueId,\n          tokenId: tokenId\n        });\n      }\n    }\n\n    if (actors.length === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n      return;\n    }\n\n    if (actors.length < 2) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.twoActorsRequired\"));\n      return;\n    }\n\n    const selectedActors = actors.slice(0, 2);\n\n    const { ContestedRollDialog } = await import('../../../components/ui/dialogs/ContestedRollDialog.mjs');\n    await ContestedRollDialog.show(selectedActors);\n  }\n\n  /**\n   * Place tokens for selected actors on canvas\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async placeTokensForSelected(menu) {\n    const { TokenPlacementManager } = await import('../TokenPlacementManager.mjs');\n    await TokenPlacementManager.placeTokensForSelectedActors(menu);\n  }\n\n  /**\n   * Teleport selected tokens to a new location\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async teleportTokensForSelected(menu) {\n    const { TokenTeleportManager } = await import('../TokenTeleportManager.mjs');\n    await TokenTeleportManager.teleportSelectedTokens(menu);\n  }\n\n  /**\n   * Transform selected actors into another actor\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async transformSelectedActors(menu) {\n    const { TransformationManager } = await import('../TransformationManager.mjs');\n    await TransformationManager.transformSelectedActors(menu);\n  }\n}","import { LogUtil } from '../../utils/LogUtil.mjs';\nimport { getActorData } from '../../helpers/Helpers.mjs';\nimport { GeneralUtil } from '../../utils/GeneralUtil.mjs';\nimport { FlashAPI } from '../../core/FlashAPI.mjs';\n\n/**\n * Handles status effects in the Roll Requests Menu\n */\nexport class RollMenuStatusManager {\n\n  /**\n   * Apply a status effect to selected actors\n   * @param {string} statusEffectId - The ID of the status effect to apply\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async applyStatusToSelected(statusEffectId, menu) {\n    const statusEffect = CONFIG.statusEffects.find(effect => effect.id === statusEffectId);\n    if (!statusEffect) {\n      FlashAPI.notify('warn', `Status effect \"${statusEffectId}\" not found`);\n      return;\n    }\n\n    if (menu.selectedActors.size === 0) {\n      FlashAPI.notify('warn', \"No actors selected\");\n      return;\n    }\n\n    let successCount = 0;\n    let totalCount = 0;\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n      \n      totalCount++;\n      const success = await this.applyStatusToActor(statusEffect, actor);\n      if (success) successCount++;\n    }\n\n    if (successCount > 0) {\n      const statusName = statusEffect.name || statusEffect.label || statusEffect.id;\n      FlashAPI.notify('info', `Applied \"${statusName}\" to ${successCount}/${totalCount} actors`);\n    }\n  }\n\n  /**\n   * Apply a status effect to a single actor\n   * @param {Object} statusEffect - The status effect configuration\n   * @param {Actor} actor - The actor to apply the effect to\n   * @returns {Promise<boolean>} Success state\n   */\n  static async applyStatusToActor(statusEffect, actor) {\n    try {\n      // Check if actor already has this status effect\n      const existingEffect = actor.appliedEffects.find(effect => \n        effect.statuses?.has(statusEffect.id) || \n        effect.flags?.core?.statusId === statusEffect.id\n      );\n\n      if (existingEffect) {\n        LogUtil.log(`RollMenuStatusManager: Actor ${actor.name} already has status effect ${statusEffect.id}`);\n        return false;\n      }\n\n      // Use the actor's toggleStatusEffect method if available (Foundry v10+)\n      if (actor.toggleStatusEffect) {\n        const hasEffect = actor.appliedEffects.some(e => e.statuses?.has(statusEffect.id));\n        if (!hasEffect) {\n          await actor.toggleStatusEffect(statusEffect.id, { active: true });\n          LogUtil.log(`RollMenuStatusManager: Applied ${statusEffect.id} to ${actor.name}`);\n          return true;\n        }\n        return false;\n      }\n      \n      const effectData = {\n        name: statusEffect.name || statusEffect.label || statusEffect.id,\n        icon: statusEffect.icon || statusEffect.img,\n        statuses: [statusEffect.id],\n        flags: {\n          core: {\n            statusId: statusEffect.id\n          }\n        }\n      };\n\n      if (statusEffect.changes) {\n        effectData.changes = statusEffect.changes;\n      }\n\n      await actor.createEmbeddedDocuments('ActiveEffect', [effectData]);\n      LogUtil.log(`RollMenuStatusManager: Applied ${statusEffect.id} to ${actor.name}`);\n      return true;\n\n    } catch (error) {\n      LogUtil.error(`RollMenuStatusManager: Failed to apply status effect to ${actor.name}`, [error]);\n      return false;\n    }\n  }\n\n  /**\n   * Remove a status effect from selected actors\n   * @param {string} statusEffectId - The ID of the status effect to remove\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async removeStatusFromSelected(statusEffectId, menu) {\n    const statusEffect = CONFIG.statusEffects.find(effect => effect.id === statusEffectId);\n    if (!statusEffect) {\n      FlashAPI.notify('warn', `Status effect \"${statusEffectId}\" not found`);\n      return;\n    }\n\n    if (menu.selectedActors.size === 0) {\n      FlashAPI.notify('warn', \"No actors selected\");\n      return;\n    }\n\n    let successCount = 0;\n    let totalCount = 0;\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n      \n      totalCount++;\n      const success = await this.removeStatusFromActor(statusEffect, actor);\n      if (success) successCount++;\n    }\n\n    if (successCount > 0) {\n      const statusName = statusEffect.name || statusEffect.label || statusEffect.id;\n      FlashAPI.notify('info', `Removed \"${statusName}\" from ${successCount}/${totalCount} actors`);\n    }\n  }\n\n  /**\n   * Remove a status effect from a single actor\n   * @param {Object} statusEffect - The status effect configuration\n   * @param {Actor} actor - The actor to remove the effect from\n   * @returns {Promise<boolean>} Success state\n   */\n  static async removeStatusFromActor(statusEffect, actor) {\n    try {\n      if (actor.toggleStatusEffect) {\n        const hasEffect = actor.appliedEffects.some(e => e.statuses?.has(statusEffect.id));\n        if (hasEffect) {\n          await actor.toggleStatusEffect(statusEffect.id, { active: false });\n          LogUtil.log(`RollMenuStatusManager: Removed ${statusEffect.id} from ${actor.name}`);\n          return true;\n        }\n        return false;\n      }\n      \n      const existingEffect = actor.appliedEffects.find(effect => \n        effect.statuses?.has(statusEffect.id) || \n        effect.flags?.core?.statusId === statusEffect.id\n      );\n\n      if (!existingEffect) {\n        LogUtil.log(`RollMenuStatusManager: Actor ${actor.name} does not have status effect ${statusEffect.id}`);\n        return false;\n      }\n\n      await existingEffect.delete();\n      LogUtil.log(`RollMenuStatusManager: Removed ${statusEffect.id} from ${actor.name}`);\n      return true;\n\n    } catch (error) {\n      LogUtil.error(`RollMenuStatusManager: Failed to remove status effect from ${actor.name}`, [error]);\n      return false;\n    }\n  }\n\n  /**\n   * Toggle a status effect on selected actors\n   * @param {string} statusEffectId - The ID of the status effect to toggle\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async toggleStatusOnSelected(statusEffectId, menu) {\n    const statusEffect = CONFIG.statusEffects.find(effect => effect.id === statusEffectId);\n    if (!statusEffect) {\n      FlashAPI.notify('warn', `Status effect \"${statusEffectId}\" not found`);\n      return;\n    }\n\n    if (menu.selectedActors.size === 0) {\n      FlashAPI.notify('warn', \"No actors selected\");\n      return;\n    }\n\n    let hasEffect = false;\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n      \n      const existingEffect = actor.appliedEffects.find(effect => \n        effect.statuses?.has(statusEffect.id) || \n        effect.flags?.core?.statusId === statusEffect.id\n      );\n\n      if (existingEffect) {\n        hasEffect = true;\n        break;\n      }\n    }\n\n    if (hasEffect) {\n      await this.removeStatusFromSelected(statusEffectId, menu);\n    } else {\n      await this.applyStatusToSelected(statusEffectId, menu);\n    }\n  }\n\n  /**\n   * Get status effects data for template context\n   * @returns {Array} Array of status effects with additional UI data\n   */\n  static getStatusEffectsForTemplate() {\n    try {\n      if (!CONFIG.statusEffects || !Array.isArray(CONFIG.statusEffects)) {\n        LogUtil.warn('RollMenuStatusManager: CONFIG.statusEffects not available or not an array');\n        return [];\n      }\n      \n      return CONFIG.statusEffects\n        .map(effect => ({\n          ...effect,\n          displayName: effect.name || effect.label || effect.id,\n          iconPath: effect.icon || effect.img || 'icons/svg/aura.svg'\n        }))\n        .sort((a, b) => {\n          // Sort alphabetically by display name\n          return a.displayName.localeCompare(b.displayName, undefined, { sensitivity: 'base' });\n        });\n    } catch (error) {\n      LogUtil.error('RollMenuStatusManager: Error getting status effects for template', [error]);\n      return [];\n    }\n  }\n}","import { LogUtil } from '../../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { MODULE } from '../../../constants/General.mjs';\nimport { SidebarController } from '../SidebarController.mjs';\nimport { updateCanvasTokenSelection, getActorData } from '../../helpers/Helpers.mjs';\n\n/**\n * Handles UI state management in the Roll Requests Menu\n */\nexport class RollMenuStateManager {\n  \n  /**\n   * Handle roll requests toggle\n   * @param {Event} event - Toggle event\n   */\n  static async handleToggleRollRequests(event) {\n    const SETTINGS = getSettings();\n    const enabled = event.target.checked;\n    await SettingsUtil.set(SETTINGS.rollRequestsEnabled.tag, enabled);\n    \n    SidebarController.updateRollRequestsIcon(enabled);\n  }\n\n  /**\n   * Handle skip dialogs toggle\n   * @param {Event} event - Toggle event\n   */\n  static async handleToggleSkipDialogs(event) {\n    const SETTINGS = getSettings();\n    const skip = event.target.checked;\n    await SettingsUtil.set(SETTINGS.skipRollDialog.tag, skip);\n  }\n\n  /**\n   * Handle group rolls message toggle\n   * @param {Event} event - Toggle event\n   */\n  static async handleToggleGroupRollsMsg(event) {\n    const SETTINGS = getSettings();\n    const isEnabled = event.target.checked;\n    await SettingsUtil.set(SETTINGS.groupRollsMsgEnabled.tag, isEnabled);\n  }\n\n  /**\n   * Handle select all toggle\n   * @param {Event} event - Toggle event\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static handleToggleSelectAll(event, menu) {\n    const SETTINGS = getSettings();\n    const selectAll = event.target.checked;\n    menu._ignoreTokenControl = true;\n    \n    const context = menu._lastPreparedContext || {};\n    const currentActors = menu.currentTab === 'group' ? (context.groups || []) : (context.actors || []);\n    \n    currentActors.forEach(actorData => {\n      if (actorData.isGroup && actorData.members) {\n        actorData.members.forEach(member => {\n          const memberUniqueId = member.uniqueId;\n          if (selectAll) {\n            menu.selectedActors.add(memberUniqueId);\n            if (member.tokenId) {\n              updateCanvasTokenSelection(member.id, true, member.tokenId);\n            } else {\n              updateCanvasTokenSelection(member.id, true);\n            }\n          } else {\n            menu.selectedActors.delete(memberUniqueId);\n            if (member.tokenId) {\n              updateCanvasTokenSelection(member.id, false, member.tokenId);\n            } else {\n              updateCanvasTokenSelection(member.id, false);\n            }\n          }\n        });\n      } else {\n        const uniqueId = actorData.uniqueId;\n        if (selectAll) {\n          menu.selectedActors.add(uniqueId);\n          if (actorData.tokenId) {\n            updateCanvasTokenSelection(actorData.id, true, actorData.tokenId);\n          } else {\n            updateCanvasTokenSelection(actorData.id, true);\n          }\n        } else {\n          menu.selectedActors.delete(uniqueId);\n          if (actorData.tokenId) {\n            updateCanvasTokenSelection(actorData.id, false, actorData.tokenId);\n          } else {\n            updateCanvasTokenSelection(actorData.id, false);\n          }\n        }\n      }\n    });\n    \n    setTimeout(() => {\n      menu._ignoreTokenControl = false;\n    }, 200);\n    \n    menu._updateGroupSelectionUI();\n    this.updateSelectAllState(menu);\n    \n    menu.render();\n    this.updateRequestTypesVisibility(menu);\n    const showOptionsListOnHover = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag);\n    \n    const accordion = menu.element.querySelector('.request-types-accordion');\n    if (accordion) {\n      if (menu.selectedActors.size > 0 && showOptionsListOnHover) {\n        accordion.classList.add('hover-visible');\n      } else {\n        accordion.classList.remove('hover-visible');\n      }\n    }\n  }\n\n  /**\n   * Handle lock toggle\n   * @param {Event} event - Toggle event\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static async handleToggleLock(event, menu) {\n    event.preventDefault();\n    menu.isLocked = !menu.isLocked;\n\n    await game.user.setFlag(MODULE.ID, 'menuLocked', menu.isLocked);\n\n    const lockIcon = event.currentTarget || menu.element?.querySelector('#flash5e-actors-lock');\n    if (lockIcon) {\n      lockIcon.classList.remove('fa-lock-keyhole', 'fa-lock-keyhole-open');\n      lockIcon.classList.add(menu.isLocked ? 'fa-lock-keyhole' : 'fa-lock-keyhole-open');\n    }\n\n    const SETTINGS = getSettings();\n    const lockMenuPosition = SettingsUtil.get(SETTINGS.lockMenuPosition.tag);\n\n    if (lockMenuPosition && menu.element) {\n      if (menu.isLocked) {\n        menu.element.classList.add('position-locked');\n      } else {\n        menu.element.classList.remove('position-locked');\n      }\n    }\n  }\n\n  /**\n   * Handle actor filter toggle\n   * @param {Event} event - Toggle event\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static async handleToggleActorFilter(event, menu) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const button = event.currentTarget;\n    const existing = menu.element.querySelector('.actor-filter-tooltip');\n\n    if (existing) {\n      existing.remove();\n      return;\n    }\n\n    const tooltip = await RollMenuStateManager.createActorFilterTooltip(menu);\n\n    menu.element.appendChild(tooltip);\n\n    const buttonRect = button.getBoundingClientRect();\n    const menuRect = menu.element.getBoundingClientRect();\n    const menuLayout = menu.element.dataset.layout;\n\n    const tooltipRect = tooltip.getBoundingClientRect();\n\n    const relativeTop = buttonRect.top - menuRect.top;\n    const buttonCenterX = buttonRect.left - menuRect.left + (buttonRect.width / 2);\n    const tooltipLeft = buttonCenterX - (tooltipRect.width / 2);\n\n    if (menuLayout === 'horizontal') {\n      tooltip.style.top = `${relativeTop - tooltipRect.height - 8}px`;\n      tooltip.style.left = `${tooltipLeft}px`;\n    } else {\n      const isLeftEdge = menu.element.classList.contains('left-edge');\n      const relativeLeft = buttonRect.left - menuRect.left;\n      const buttonBottom = relativeTop + buttonRect.height;\n      const tooltipTop = buttonBottom - tooltipRect.height;\n\n      if (isLeftEdge) {\n        tooltip.style.top = `${tooltipTop}px`;\n        tooltip.style.left = `${relativeLeft + buttonRect.width + 20}px`;\n      } else {\n        tooltip.style.top = `${tooltipTop}px`;\n        tooltip.style.left = `${relativeLeft - tooltipRect.width - 20}px`;\n      }\n    }\n  }\n\n  /**\n   * Handle options toggle\n   * @param {Event} event - Toggle event\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static async handleToggleOptions(event, menu) {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    menu.optionsExpanded = !menu.optionsExpanded;\n    await game.user.setFlag(MODULE.ID, 'menuOptionsExpanded', menu.optionsExpanded);\n    \n    const optionsToggleContainer = menu.element.querySelector('.options-toggle');\n    if (optionsToggleContainer) {\n      optionsToggleContainer.classList.toggle('expanded', menu.optionsExpanded);\n    }\n    \n    const optionsElement = menu.element.querySelector('li.options');\n    if (optionsElement) {\n      optionsElement.classList.toggle('expanded', menu.optionsExpanded);\n    }\n  }\n\n  /**\n   * Toggle actor selection state\n   * @param {string} uniqueId - Unique ID of the actor/token\n   * @param {string} actorId - Actor ID\n   * @param {string} tokenId - Token ID (if applicable)\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static toggleActorSelection(uniqueId, actorId, tokenId, menu) {\n    const SETTINGS = getSettings();\n    menu._ignoreTokenControl = true;\n    \n    if (menu.selectedActors.has(uniqueId)) {\n      menu.selectedActors.delete(uniqueId);\n      if (tokenId) {\n        updateCanvasTokenSelection(actorId, false, tokenId);\n      } else {\n        updateCanvasTokenSelection(actorId, false);\n      }\n    } else {\n      menu.selectedActors.add(uniqueId);\n      if (tokenId) {\n        updateCanvasTokenSelection(actorId, true, tokenId);\n      } else {\n        updateCanvasTokenSelection(actorId, true);\n      }\n    }\n    \n    setTimeout(() => {\n      menu._ignoreTokenControl = false;\n    }, 100);\n    \n    this.updateActorSelectionUI(uniqueId, menu);\n    this.updateSelectAllState(menu);\n    this.updateRequestTypesVisibilityNoRender(menu);\n    const showOptionsListOnHover = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag);\n    \n    const accordion = menu.element.querySelector('.request-types-accordion');\n    if (accordion) {\n      if (menu.selectedActors.size > 0 && showOptionsListOnHover) {\n        accordion.classList.add('hover-visible');\n      } else {\n        accordion.classList.remove('hover-visible');\n      }\n    }\n  }\n\n  /**\n   * Update the visual state of an actor element without re-rendering\n   * @param {string} actorId - Actor ID to update\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static updateActorSelectionUI(actorId, menu) {\n    const wrapperElement = menu.element.querySelector(`.actor.drag-wrapper[data-id=\"${actorId}\"]`);\n    if (!wrapperElement) return;\n    \n    const actorElement = wrapperElement.closest('.actor');\n    if (!actorElement) return;\n    \n    const checkbox = actorElement.querySelector('.actor-select');\n    const isSelected = menu.selectedActors.has(actorId);\n    \n    if (checkbox) {\n      checkbox.checked = isSelected;\n    }\n    \n    wrapperElement.classList.toggle('selected', isSelected);\n    wrapperElement.dataset.selected = isSelected.toString();\n  }\n\n  /**\n   * Update request types visibility based on actor selection\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static updateRequestTypesVisibility(menu) {\n    menu.render();\n  }\n\n  /**\n   * Update request types visibility without re-rendering\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static updateRequestTypesVisibilityNoRender(menu) {\n    const hasSelection = menu.selectedActors.size > 0;\n    const requestTypesContainer = menu.element.querySelector('.request-types');\n    \n    if (requestTypesContainer) {\n      const requestItems = requestTypesContainer.querySelectorAll('.request-type-item');\n      requestItems.forEach(item => {\n        item.classList.toggle('disabled', !hasSelection);\n      });\n      \n      const hasPlayerCharacter = Array.from(menu.selectedActors).some(uniqueId => {\n        const actor = getActorData(uniqueId);\n        return actor?.type === 'character';\n      });\n      \n      const hitDieItem = requestTypesContainer.querySelector('[data-id=\"HIT_DIE\"]');\n      if (hitDieItem) {\n        hitDieItem.style.display = hasPlayerCharacter ? '' : 'none';\n      }\n    }\n  }\n\n  /**\n   * Update select all checkbox state\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static updateSelectAllState(menu) {\n    const selectAllCheckbox = menu.element.querySelector('#flash5e-actors-all');\n    let selectedCount = 0;\n    let totalCount = 0;\n    \n    if (menu.currentTab === 'group') {\n      const context = menu._lastPreparedContext || {};\n      const currentActors = context.groups || [];\n      const allMembers = [];\n      currentActors.forEach(groupActor => {\n        if (groupActor.isGroup && groupActor.members) {\n          allMembers.push(...groupActor.members);\n        }\n      });\n      totalCount = allMembers.length;\n      selectedCount = allMembers.filter(member => \n        menu.selectedActors.has(member.uniqueId)\n      ).length;\n    } else {\n      const currentActors = menu.currentTab === 'pc' ? 'pc' : 'npc';\n      const checkboxes = menu.element.querySelectorAll(`.${currentActors}-actors .actor-item input[type=\"checkbox\"]`);\n      totalCount = checkboxes.length;\n      selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;\n    }\n\n    if(!selectAllCheckbox) return;\n    selectAllCheckbox.checked = selectedCount > 0 && selectedCount === totalCount;\n    selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCount;\n  }\n\n  /**\n   * Create actor filter tooltip with filter options\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {HTMLElement} Tooltip element\n   */\n  static async createActorFilterTooltip(menu) {\n    const savedFilters = game.user.getFlag(MODULE.ID, 'actorFilters') || {\n      inCombat: false,\n      visible: false,\n      removeDead: false\n    };\n\n    menu.actorFilters = savedFilters;\n\n    const templatePath = 'modules/flash-rolls-5e/templates/actor-filter-tooltip.hbs';\n    const html = await renderTemplate(templatePath, {\n      filters: savedFilters\n    });\n\n    const tooltipContainer = document.createElement('div');\n    tooltipContainer.innerHTML = html;\n    const tooltip = tooltipContainer.firstElementChild;\n\n    tooltip.querySelectorAll('input[type=\"checkbox\"]').forEach(checkbox => {\n      checkbox.addEventListener('change', (event) => {\n        RollMenuStateManager.applyActorFilters(menu);\n      });\n    });\n\n    return tooltip;\n  }\n\n  /**\n   * Apply actor filters based on current filter settings\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static async applyActorFilters(menu) {\n    const tooltip = menu.element.querySelector('.actor-filter-tooltip');\n    if (!tooltip) return;\n\n    const filters = {\n      inCombat: tooltip.querySelector('[data-filter=\"inCombat\"]').checked,\n      visible: tooltip.querySelector('[data-filter=\"visible\"]').checked,\n      removeDead: tooltip.querySelector('[data-filter=\"removeDead\"]').checked\n    };\n    menu.actorFilters = filters;\n    await game.user.setFlag(MODULE.ID, 'actorFilters', filters);\n    menu.render();\n  }\n\n  /**\n   * Check if an actor meets the specified filter criteria\n   * @param {Actor} actor - The actor to check\n   * @param {Object} filters - Filter criteria\n   * @param {boolean} filters.inCombat - Show only actors in combat\n   * @param {boolean} filters.visible - Show only visible actors\n   * @param {boolean} filters.removeDead - Remove dead actors from the list\n   * @param {TokenDocument} [token] - Optional token document for token-specific checks\n   * @returns {boolean} True if actor meets all active filter criteria\n   */\n  static doesActorPassFilters(actor, filters, token = null) {\n    if (!filters.inCombat && !filters.visible && !filters.removeDead) {\n      return true;\n    }\n\n    if (filters.inCombat) {\n      const inCombat = token ? token.inCombat : actor.inCombat;\n      if (!inCombat) return false;\n    }\n\n    if (filters.visible) {\n      if (token) {\n        if (token.hidden) return false;\n      }\n    }\n\n    if (filters.removeDead) {\n      const hasDead = actor.appliedEffects.some(effect =>\n        effect.statuses?.has('dead') ||\n        effect.flags?.core?.statusId === 'dead'\n      );\n      if (hasDead) return false;\n    }\n\n    return true;\n  }\n}","import { MODULE, MODULE_ID } from '../../../constants/General.mjs';\nimport { LogUtil } from '../../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { buildRollTypes } from '../../helpers/Helpers.mjs';\nimport { RollMenuActorUtil } from '../../utils/RollMenuActorUtil.mjs';\nimport { ActorStatusManager } from '../ActorStatusManager.mjs';\nimport { RollMenuStatusManager } from './RollMenuStatusManager.mjs';\nimport { RollMenuStateManager } from './RollMenuStateManager.mjs';\nimport { TokenMovementManager } from '../../utils/TokenMovementManager.mjs';\n\n/**\n * Utility class for processing actors for the Roll Requests Menu\n */\nexport class RollMenuActorProcessor {\n\n  /**\n   * Process all actors and build context data for template rendering\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @param {Object} baseContext - Base context from ApplicationV2\n   * @returns {Object} Complete context object for template\n   */\n  static async prepareActorContext(menu, baseContext) {\n    const SETTINGS = getSettings();\n    const actors = game.actors.contents;\n    const pcActors = [];\n    const npcActors = [];\n    const groupActors = [];\n    const currentScene = game.scenes.current;\n    \n    for (const actor of actors) {\n      // Process group and encounter actors separately\n      if (actor.type === 'group' || actor.type === 'encounter') {\n        const groupEntries = await this.processGroupActor(actor, currentScene, menu);\n        groupActors.push(...groupEntries);\n        continue;\n      }\n      \n      if (actor.type !== 'character' && actor.type !== 'npc') continue;\n      \n      const isPlayerOwned = this.isPlayerOwnedActor(actor);\n      const actorEntries = await this.processActor(actor, currentScene, menu, isPlayerOwned);\n      \n      if (isPlayerOwned) {\n        pcActors.push(...actorEntries);\n      } else {\n        npcActors.push(...actorEntries);\n      }\n    }\n\n    // Apply actor filters if any are active\n    const actorFilters = menu.actorFilters || {};\n    if (actorFilters.inCombat || actorFilters.visible || actorFilters.removeDead) {\n      const filteredPCActors = pcActors.filter(actorData => {\n        const token = actorData.tokenId ? currentScene?.tokens.get(actorData.tokenId) : null;\n        const actor = token?.actor || game.actors.get(actorData.id);\n        if (!actor) return false;\n\n        return RollMenuStateManager.doesActorPassFilters(actor, actorFilters, token);\n      });\n      pcActors.length = 0;\n      pcActors.push(...filteredPCActors);\n\n      const filteredNPCActors = npcActors.filter(actorData => {\n        const token = actorData.tokenId ? currentScene?.tokens.get(actorData.tokenId) : null;\n        const actor = token?.actor || game.actors.get(actorData.id);\n        if (!actor) return false;\n\n        return RollMenuStateManager.doesActorPassFilters(actor, actorFilters, token);\n      });\n      npcActors.length = 0;\n      npcActors.push(...filteredNPCActors);\n\n      const filteredGroupActors = groupActors.filter(groupData => {\n        if (groupData.isGroup) {\n          const groupActor = game.actors.get(groupData.id);\n          const groupToken = groupData.tokenId ? currentScene?.tokens.get(groupData.tokenId) : null;\n\n          const groupFilters = {\n            inCombat: actorFilters.inCombat,\n            visible: actorFilters.visible,\n            removeDead: false\n          };\n\n          const groupPasses = groupActor && RollMenuStateManager.doesActorPassFilters(groupActor, groupFilters, groupToken);\n\n          return groupPasses || (groupData.members && groupData.members.length > 0);\n        } else {\n          const actor = game.actors.get(groupData.id);\n          if (!actor) return false;\n\n          const token = groupData.tokenId ? currentScene?.tokens.get(groupData.tokenId) : null;\n          return RollMenuStateManager.doesActorPassFilters(actor, actorFilters, token);\n        }\n      });\n      groupActors.length = 0;\n      groupActors.push(...filteredGroupActors);\n    }\n\n    groupActors.sort((a, b) => {\n      const aActor = game.actors.get(a.id);\n      const bActor = game.actors.get(b.id);\n      if (!aActor || !bActor) return 0;\n\n      const primaryParty = game.settings.get(\"dnd5e\", \"primaryParty\")?.actor;\n      const aIsPrimary = primaryParty?.id === aActor.id;\n      const bIsPrimary = primaryParty?.id === bActor.id;\n\n      if (aIsPrimary && !bIsPrimary) return -1;\n      if (!aIsPrimary && bIsPrimary) return 1;\n\n      if (aActor.type === 'group' && bActor.type === 'encounter') return -1;\n      if (aActor.type === 'encounter' && bActor.type === 'group') return 1;\n      return 0;\n    });\n\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const skipRollDialog = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    const showOnlyPCsWithToken = SettingsUtil.get(SETTINGS.showOnlyPCsWithToken.tag);\n    const showOptionsListOnHover = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag) ?? SETTINGS.showOptionsListOnHover.default;\n    LogUtil.log('Template context showOptionsListOnHover:', [showOptionsListOnHover, typeof showOptionsListOnHover, 'tag:', SETTINGS.showOptionsListOnHover.tag]);\n    \n    const currentActors = menu.currentTab === 'pc' ? pcActors : \n                          menu.currentTab === 'npc' ? npcActors : \n                          groupActors;\n    let selectAllOn = false;\n    if (currentActors.length > 0) {\n      if (menu.currentTab === 'group') {\n        const allMembers = [];\n        currentActors.forEach(groupActor => {\n          if (groupActor.isGroup && groupActor.members) {\n            allMembers.push(...groupActor.members);\n          }\n        });\n        selectAllOn = allMembers.length > 0 && \n          allMembers.every(member => menu.selectedActors.has(member.uniqueId));\n      } else {\n        selectAllOn = currentActors.every(actor => menu.selectedActors.has(actor.uniqueId));\n      }\n    }\n    \n    const requestTypes = this.buildRequestTypes(menu);\n    const rollTypes = buildRollTypes(menu.selectedRequestType, menu.selectedActors);\n    const statusEffects = RollMenuStatusManager.getStatusEffectsForTemplate();\n    \n    return {\n      ...baseContext,\n      actors: menu.currentTab === 'group' ? [] : currentActors,\n      groups: menu.currentTab === 'group' ? currentActors : [],\n      currentTab: menu.currentTab,\n      isPCTab: menu.currentTab === 'pc',\n      isNPCTab: menu.currentTab === 'npc',\n      isGroupTab: menu.currentTab === 'group',\n      selectedTab: menu.currentTab,\n      selectedSubmenu: menu.selectedSubmenu,\n      rollRequestsEnabled,\n      skipRollDialog,\n      groupRollsMsgEnabled,\n      showOptionsListOnHover,\n      selectAllOn,\n      hasSelectedActors: menu.selectedActors.size > 0,\n      requestTypes,\n      rollTypes,\n      statusEffects,\n      showNames: true,\n      actorsLocked: menu.isLocked,\n      optionsExpanded: menu.optionsExpanded,\n      isGM: game.user.isGM,\n      isCompact: SettingsUtil.get(SETTINGS.compactMode.tag)\n    };\n  }\n\n  /**\n   * Check if an actor is player-owned (either via explicit ownership or assigned character)\n   * @param {Actor} actor - The actor to check\n   * @returns {boolean} True if player-owned\n   */\n  static isPlayerOwnedActor(actor) {\n    const hasExplicitOwnership = Object.entries(actor.ownership)\n      .some(([userId, level]) => {\n        const user = game.users.get(userId);\n        return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n      });\n    if (hasExplicitOwnership) return true;\n    const isAssignedCharacter = game.users.some(user =>\n      !user.isGM && user.character?.id === actor.id\n    );\n    return isAssignedCharacter;\n  }\n\n  /**\n   * Process a single actor and return array of actor entries (including tokens)\n   * @param {Actor} actor - The actor to process\n   * @param {Scene} currentScene - Current active scene\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @param {boolean} isPlayerOwned - Whether the actor is player-owned\n   * @returns {Array} Array of actor data entries\n   */\n  static async processActor(actor, currentScene, menu, isPlayerOwned) {\n    if (ActorStatusManager.isBlocked(actor)) {\n      return [];\n    }\n\n    const SETTINGS = getSettings();\n    const showOnlyPCsWithToken = SettingsUtil.get(SETTINGS.showOnlyPCsWithToken?.tag);\n    const isFavorite = ActorStatusManager.isFavorite(actor);\n    const tokensInScene = currentScene?.tokens.filter(token => token.actorId === actor.id) || [];\n    \n    const actorEntries = [];\n\n    if (isPlayerOwned) {\n      if (isFavorite) {\n        actorEntries.push(...this.processFavoriteActor(actor, tokensInScene, menu));\n      } else if (showOnlyPCsWithToken) {\n        actorEntries.push(...this.processTokenOnlyActor(actor, tokensInScene, menu));\n      } else {\n        actorEntries.push(...this.processRegularActor(actor, tokensInScene, menu));\n      }\n    } else {\n      if (isFavorite) {\n        actorEntries.push(...this.processFavoriteActor(actor, tokensInScene, menu));\n      } else {\n        actorEntries.push(...this.processTokenOnlyActor(actor, tokensInScene, menu));\n      }\n    }\n\n    return actorEntries;\n  }\n\n  /**\n   * Process a favorite actor (always show, with or without tokens)\n   * @param {Actor} actor - The actor\n   * @param {TokenDocument[]} tokensInScene - Tokens for this actor in current scene\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {Array} Array of actor data entries\n   */\n  static processFavoriteActor(actor, tokensInScene, menu) {\n    const actorEntries = [];\n    \n    if (tokensInScene.length > 0) {\n      tokensInScene.forEach(tokenDoc => {\n        const actorData = this.createActorData(actor, tokenDoc, menu);\n        actorData.isFavorite = true;\n        actorEntries.push(actorData);\n      });\n    } else {\n      const actorData = this.createActorData(actor, null, menu);\n      actorData.isFavorite = true;\n      actorEntries.push(actorData);\n    }\n    \n    return actorEntries;\n  }\n\n  /**\n   * Process an actor that only shows if it has tokens\n   * @param {Actor} actor - The actor\n   * @param {TokenDocument[]} tokensInScene - Tokens for this actor in current scene\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {Array} Array of actor data entries\n   */\n  static processTokenOnlyActor(actor, tokensInScene, menu) {\n    const actorEntries = [];\n    \n    if (tokensInScene.length > 0) {\n      tokensInScene.forEach(tokenDoc => {\n        const actorData = this.createActorData(actor, tokenDoc, menu);\n        actorEntries.push(actorData);\n      });\n    }\n    \n    return actorEntries;\n  }\n\n  /**\n   * Process a regular actor (show both with and without tokens)\n   * @param {Actor} actor - The actor\n   * @param {TokenDocument[]} tokensInScene - Tokens for this actor in current scene\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {Array} Array of actor data entries\n   */\n  static processRegularActor(actor, tokensInScene, menu) {\n    const actorEntries = [];\n    \n    if (tokensInScene.length > 0) {\n      tokensInScene.forEach(tokenDoc => {\n        const actorData = this.createActorData(actor, tokenDoc, menu);\n        actorEntries.push(actorData);\n      });\n    } else {\n      const actorData = this.createActorData(actor, null, menu);\n      actorEntries.push(actorData);\n    }\n    \n    return actorEntries;\n  }\n\n  /**\n   * Create actor data object for template rendering\n   * @param {Actor} actor - The actor\n   * @param {TokenDocument|null} token - The token document, if any\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {Object} Actor data object\n   */\n  static createActorData(actor, token, menu) {\n    // TokenDocument.actor gives us the synthetic token actor with its own HP/effects\n    const actorForStats = token?.actor || actor;\n    const hpData = RollMenuActorUtil.getActorHPData(actorForStats);\n\n    return {\n      id: actor.id,\n      uuid: actor.uuid,\n      name: token ? token.name : actor.name,\n      img: actor.img,\n      selected: menu.selectedActors.has(token?.id || actor.id),\n      crlngnStats: RollMenuActorUtil.getActorStats(actorForStats),\n      hpPercent: hpData.hpPercent,\n      hpColor: hpData.hpColor,\n      tokenId: token?.id || null,\n      isToken: !!token,\n      uniqueId: token?.id || actor.id,\n      movementRestricted: token ? TokenMovementManager.isMovementRestricted(token) : false\n    };\n  }\n\n  /**\n   * Process a group or encounter actor for display in the Flash Token Bar menu.\n   *\n   * This method converts a D&D 5e group/encounter actor into Flash Token Bar menu data.\n   * The result is an array of group data objects that can be displayed in the Flash Token Bar menu,\n   * with each group containing its member actors properly associated with specific tokens.\n   *\n   * @param {Actor} actor - The group/encounter actor to process\n   * @param {Scene} currentScene - Current active scene\n   * @param {RollRequestsMenu} menu - Menu instance for state and settings\n   * @returns {Array} Array of group actor data objects with members for menu display\n   */\n  static async processGroupActor(actor, currentScene, menu) {\n    if (ActorStatusManager.isBlocked(actor)) {\n      return [];\n    }\n\n\n    const SETTINGS = getSettings();\n    const showOnlyPCsWithToken = SettingsUtil.get(SETTINGS.showOnlyPCsWithToken?.tag);\n\n    const tokensInScene = currentScene?.tokens.filter(token => token.actorId === actor.id) || [];\n    const groupEntries = [];\n\n    const members = [];\n    let hasAnyMemberTokens = false;\n    const actorFilters = menu.actorFilters || {};\n    const hasActiveFilters = actorFilters.inCombat || actorFilters.visible || actorFilters.removeDead;\n\n    if (actor.type === 'group') {\n      // Group type: members have direct actor references\n      // Check if we have stored token associations (new scene-based format)\n      const tokenAssociationsByScene = actor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n      const tokenAssociations = tokenAssociationsByScene[currentScene?.id] || {};\n\n      for (const member of actor.system.members || []) {\n        if (member.actor && !ActorStatusManager.isBlocked(member.actor)) {\n          const memberActorId = member.actor.id;\n          const associatedTokenIds = tokenAssociations[memberActorId] || [];\n\n\n          if (associatedTokenIds.length > 0) {\n            let foundValidToken = false;\n            for (const tokenUuid of associatedTokenIds) {\n              try {\n                const tokenDoc = fromUuidSync(tokenUuid);\n                if (tokenDoc && tokenDoc.actorId === member.actor.id && tokenDoc.parent === currentScene) {\n                  if (hasActiveFilters) {\n                    const actorToCheck = tokenDoc.actor || member.actor;\n                    if (!RollMenuStateManager.doesActorPassFilters(actorToCheck, actorFilters, tokenDoc)) {\n                      continue;\n                    }\n                  }\n                  hasAnyMemberTokens = true;\n                  foundValidToken = true;\n                  const memberData = this.createActorData(member.actor, tokenDoc, menu);\n                  members.push(memberData);\n                }\n              } catch (error) {\n              }\n            }\n\n            // If we have associations but all tokens are invalid/deleted, fall back to showing the actor\n            if (!foundValidToken && !showOnlyPCsWithToken) {\n              if (hasActiveFilters) {\n                if (!RollMenuStateManager.doesActorPassFilters(member.actor, actorFilters, null)) {\n                  continue;\n                }\n              }\n              const memberData = this.createActorData(member.actor, null, menu);\n              members.push(memberData);\n            }\n          } else {\n            const memberTokens = currentScene?.tokens.filter(token => token.actorId === member.actor.id) || [];\n\n            if (memberTokens.length > 0) {\n              hasAnyMemberTokens = true;\n              memberTokens.forEach(tokenDoc => {\n                if (hasActiveFilters) {\n                  const actorToCheck = tokenDoc.actor || member.actor;\n                  if (!RollMenuStateManager.doesActorPassFilters(actorToCheck, actorFilters, tokenDoc)) {\n                    return;\n                  }\n                }\n                const memberData = this.createActorData(member.actor, tokenDoc, menu);\n                members.push(memberData);\n              });\n            } else if (!showOnlyPCsWithToken) {\n              if (hasActiveFilters) {\n                if (!RollMenuStateManager.doesActorPassFilters(member.actor, actorFilters, null)) {\n                  continue;\n                }\n              }\n              const memberData = this.createActorData(member.actor, null, menu);\n              members.push(memberData);\n            }\n          }\n        }\n      }\n    } else if (actor.type === 'encounter') {\n      // Encounter type: members have UUIDs and quantities\n      // Check if we have stored token associations (new scene-based format)\n      const tokenAssociationsByScene = actor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n      const tokenAssociations = tokenAssociationsByScene[currentScene?.id] || {};\n\n      for (const member of actor.system.members || []) {\n        try {\n          const memberActor = await fromUuid(member.uuid);\n          if (memberActor && !ActorStatusManager.isBlocked(memberActor)) {\n            const memberActorId = memberActor.id;\n            const associatedTokenIds = tokenAssociations[memberActorId] || [];\n\n            if (associatedTokenIds.length > 0) {\n              for (const tokenUuid of associatedTokenIds) {\n                try {\n                  const tokenDoc = fromUuidSync(tokenUuid);\n                  if (tokenDoc && tokenDoc.actorId === memberActor.id && tokenDoc.parent === currentScene) {\n                    if (hasActiveFilters) {\n                      const actorToCheck = tokenDoc.actor || memberActor;\n                      if (!RollMenuStateManager.doesActorPassFilters(actorToCheck, actorFilters, tokenDoc)) {\n                        continue;\n                      }\n                    }\n                    hasAnyMemberTokens = true;\n                    const memberData = this.createActorData(memberActor, tokenDoc, menu);\n                    memberData.quantity = 1;\n                    members.push(memberData);\n                  }\n                } catch (error) {\n                }\n              }\n            } else {\n              const memberTokens = currentScene?.tokens.filter(token => token.actorId === memberActor.id) || [];\n\n              if (memberTokens.length > 0) {\n                hasAnyMemberTokens = true;\n                memberTokens.forEach(tokenDoc => {\n                  if (hasActiveFilters) {\n                    const actorToCheck = tokenDoc.actor || memberActor;\n                    if (!RollMenuStateManager.doesActorPassFilters(actorToCheck, actorFilters, tokenDoc)) {\n                      return;\n                    }\n                  }\n                  const memberData = this.createActorData(memberActor, tokenDoc, menu);\n                  memberData.quantity = 1;\n                  members.push(memberData);\n                });\n              } else if (!showOnlyPCsWithToken) {\n                if (hasActiveFilters) {\n                  if (!RollMenuStateManager.doesActorPassFilters(memberActor, actorFilters, null)) {\n                    continue;\n                  }\n                }\n                const memberData = this.createActorData(memberActor, null, menu);\n                memberData.quantity = member.quantity || 1;\n                members.push(memberData);\n              }\n            }\n          }\n        } catch (error) {\n          LogUtil.log(`Failed to resolve member UUID: ${member.uuid}`, [error]);\n        }\n      }\n    }\n\n    // If showOnlyPCsWithToken is enabled, filter out groups without tokens\n    if (showOnlyPCsWithToken) {\n      const groupHasTokens = tokensInScene.length > 0;\n      if (!groupHasTokens && !hasAnyMemberTokens) {\n        // Group has no tokens and no members have tokens, filter it out\n        return [];\n      }\n    }\n\n    // If no members with tokens but showOnlyPCsWithToken is disabled, still show the group with actor members\n    // (this handles the case where the group exists but has no tokens in this scene)\n    if (members.length === 0 && !showOnlyPCsWithToken) {\n      let memberActors = [];\n      if (actor.type === 'group') {\n        memberActors = (actor.system.members || []).map(m => m.actor).filter(a => a);\n      } else if (actor.type === 'encounter') {\n        const resolved = await Promise.all(\n          (actor.system.members || []).map(async m => {\n            try {\n              return await fromUuid(m.uuid);\n            } catch (error) {\n              return null;\n            }\n          })\n        );\n        memberActors = resolved.filter(a => a);\n      }\n\n      const memberDataList = memberActors.map(memberActor => {\n        if (!ActorStatusManager.isBlocked(memberActor)) {\n          if (hasActiveFilters) {\n            if (!RollMenuStateManager.doesActorPassFilters(memberActor, actorFilters, null)) {\n              return null;\n            }\n          }\n          return this.createActorData(memberActor, null, menu);\n        }\n        return null;\n      }).filter(m => m !== null);\n\n      const groupData = this.createActorData(actor, null, menu);\n      groupData.members = memberDataList;\n      groupData.isGroup = true;\n      groupData.isExpanded = menu.groupExpansionStates?.[actor.id] ?? false;\n      groupData.memberImages = memberDataList.slice(0, 4).map(m => m.img);\n      groupData.selected = false;\n      groupEntries.push(groupData);\n      return groupEntries;\n    }\n\n    // Don't show groups with no members if showOnlyPCsWithToken is enabled\n    if (members.length === 0) {\n      return [];\n    }\n\n    if (tokensInScene.length > 0) {\n      tokensInScene.forEach(tokenDoc => {\n        const groupData = this.createActorData(actor, tokenDoc, menu);\n        groupData.members = members;\n        groupData.isGroup = true;\n        groupData.isExpanded = menu.groupExpansionStates?.[actor.id] ?? false;\n        groupData.memberImages = members.slice(0, 4).map(m => m.img);\n        \n        const selectedMembers = members.filter(member => menu.selectedActors.has(member.uniqueId));\n        if (selectedMembers.length === 0) {\n          groupData.selected = 'false';\n        } else if (selectedMembers.length === members.length) {\n          groupData.selected = 'true';\n        } else {\n          groupData.selected = 'partial';\n        }\n        \n        groupEntries.push(groupData);\n      });\n    } else {\n      const groupData = this.createActorData(actor, null, menu);\n      groupData.members = members;\n      groupData.isGroup = true;\n      groupData.isExpanded = menu.groupExpansionStates?.[actor.id] ?? false;\n      groupData.memberImages = members.slice(0, 4).map(m => m.img);\n      \n      const selectedMembers = members.filter(member => menu.selectedActors.has(member.uniqueId));\n      if (selectedMembers.length === 0) {\n        groupData.selected = 'false';\n      } else if (selectedMembers.length === members.length) {\n        groupData.selected = 'true';\n      } else {\n        groupData.selected = 'partial';\n      }\n      \n      groupEntries.push(groupData);\n    }\n    \n    return groupEntries;\n  }\n\n  /**\n   * Build request types for the accordion\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {Array} Array of request type objects\n   */\n  static buildRequestTypes(menu) {\n    const requestTypes = [];\n    \n    for (const [key, option] of Object.entries(MODULE.ROLL_REQUEST_OPTIONS)) {\n      const requestType = {\n        id: key,\n        name: game.i18n.localize(`FLASH_ROLLS.rollTypes.${option.name}`) || option.label,\n        rollable: option.subList == null,\n        hasSubList: !!option.subList,\n        selected: menu.selectedRequestType === key, \n        expanded: menu.accordionStates[key] ?? false,\n        subItems: []\n      };\n      \n      if (option.subList) {\n        requestType.subItems = buildRollTypes(key, menu.selectedActors);\n      }\n      \n      requestTypes.push(requestType);\n    }\n    \n    return requestTypes;\n  }\n}","import { MODULE_ID } from \"../../constants/General.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\n\nconst PROXY_BASE_URL = \"https://proxy.carolingian.io\";\nconst HEARTBEAT_INTERVAL = 30000;\nconst VALIDATION_CACHE_TIME = 60000;\nconst SESSION_TOKEN_KEY = `${MODULE_ID}.sessionToken`;\n\nexport class PatronSessionManager {\n  static _instance = null;\n  static _patronStatus = {\n    isPatron: false,\n    tier: 0,\n    name: null,\n    ddbConnected: false,\n    lastValidated: 0\n  };\n  static _heartbeatInterval = null;\n  static _validating = false;\n  static _validationPromise = null;\n  static _sessionToken = null;\n\n  static getInstance() {\n    if (!PatronSessionManager._instance) {\n      PatronSessionManager._instance = new PatronSessionManager();\n    }\n    return PatronSessionManager._instance;\n  }\n\n  static async initialize() {\n    if (!game.user.isGM) {\n      LogUtil.log(\"PatronSessionManager: Skipping initialization for non-GM user\");\n      return;\n    }\n    LogUtil.log(\"Initializing PatronSessionManager\");\n    PatronSessionManager._loadSessionToken();\n    const instance = PatronSessionManager.getInstance();\n    await instance.validateSession();\n    instance.startHeartbeat();\n  }\n\n  static _loadSessionToken() {\n    try {\n      PatronSessionManager._sessionToken = localStorage.getItem(SESSION_TOKEN_KEY);\n      if (PatronSessionManager._sessionToken) {\n        LogUtil.log(\"Session token loaded from storage\");\n      }\n    } catch (e) {\n      LogUtil.warn(\"Failed to load session token:\", [e]);\n    }\n  }\n\n  static setSessionToken(token) {\n    PatronSessionManager._sessionToken = token;\n    try {\n      if (token) {\n        localStorage.setItem(SESSION_TOKEN_KEY, token);\n      } else {\n        localStorage.removeItem(SESSION_TOKEN_KEY);\n      }\n    } catch (e) {\n      LogUtil.warn(\"Failed to save session token:\", [e]);\n    }\n  }\n\n  static getSessionToken() {\n    return PatronSessionManager._sessionToken;\n  }\n\n  static _getAuthHeaders() {\n    const headers = {\n      'Accept': 'application/json'\n    };\n    if (PatronSessionManager._sessionToken) {\n      headers['Authorization'] = `Bearer ${PatronSessionManager._sessionToken}`;\n    }\n    return headers;\n  }\n\n  static shutdown() {\n    LogUtil.log(\"Shutting down PatronSessionManager\");\n    const instance = PatronSessionManager.getInstance();\n    instance.stopHeartbeat();\n  }\n\n  static getStatus() {\n    return { ...PatronSessionManager._patronStatus };\n  }\n\n  static isPatron() {\n    return PatronSessionManager._patronStatus.isPatron;\n  }\n\n  static isDDBConnected() {\n    return PatronSessionManager._patronStatus.ddbConnected;\n  }\n\n  static setDDBConnected(connected) {\n    if (PatronSessionManager._patronStatus.ddbConnected !== connected) {\n      PatronSessionManager._patronStatus.ddbConnected = connected;\n      Hooks.callAll(`${MODULE_ID}.patronStatusChanged`, PatronSessionManager.getStatus());\n    }\n  }\n\n  async validateSession(force = false) {\n    const now = Date.now();\n    if (!force && now - PatronSessionManager._patronStatus.lastValidated < VALIDATION_CACHE_TIME) {\n      return PatronSessionManager.getStatus();\n    }\n\n    if (PatronSessionManager._validating && PatronSessionManager._validationPromise) {\n      return PatronSessionManager._validationPromise;\n    }\n\n    PatronSessionManager._validating = true;\n\n    PatronSessionManager._validationPromise = (async () => {\n      try {\n        const response = await fetch(`${PROXY_BASE_URL}/api/validate`, {\n          method: 'GET',\n          credentials: 'include',\n          headers: PatronSessionManager._getAuthHeaders()\n        });\n\n        if (!response.ok) {\n          throw new Error(`Validation failed: ${response.status}`);\n        }\n\n        const data = await response.json();\n\n        const oldStatus = { ...PatronSessionManager._patronStatus };\n        PatronSessionManager._patronStatus = {\n          isPatron: data.isPatron || false,\n          tier: data.tier || 0,\n          name: data.name || null,\n          ddbConnected: data.ddbConnected || false,\n          lastValidated: now\n        };\n\n        const statusChanged =\n          oldStatus.isPatron !== PatronSessionManager._patronStatus.isPatron ||\n          oldStatus.ddbConnected !== PatronSessionManager._patronStatus.ddbConnected;\n\n        if (statusChanged) {\n          LogUtil.log(\"Patron status changed:\", [PatronSessionManager._patronStatus]);\n          Hooks.callAll(`${MODULE_ID}.patronStatusChanged`, PatronSessionManager.getStatus());\n        }\n\n        return PatronSessionManager.getStatus();\n      } catch (error) {\n        LogUtil.error(\"Session validation error:\", [error]);\n\n        const oldStatus = { ...PatronSessionManager._patronStatus };\n        PatronSessionManager._patronStatus = {\n          isPatron: false,\n          tier: 0,\n          name: null,\n          ddbConnected: false,\n          lastValidated: now\n        };\n\n        if (oldStatus.isPatron) {\n          Hooks.callAll(`${MODULE_ID}.patronStatusChanged`, PatronSessionManager.getStatus());\n        }\n\n        return PatronSessionManager.getStatus();\n      } finally {\n        PatronSessionManager._validating = false;\n        PatronSessionManager._validationPromise = null;\n      }\n    })();\n\n    return PatronSessionManager._validationPromise;\n  }\n\n  async sendHeartbeat() {\n    try {\n      const headers = PatronSessionManager._getAuthHeaders();\n      headers['Content-Type'] = 'application/json';\n      const response = await fetch(`${PROXY_BASE_URL}/api/heartbeat`, {\n        method: 'POST',\n        credentials: 'include',\n        headers,\n        body: JSON.stringify({\n          ddbConnected: PatronSessionManager._patronStatus.ddbConnected\n        })\n      });\n\n      if (!response.ok) {\n        LogUtil.warn(\"Heartbeat failed:\", [response.status]);\n        return;\n      }\n\n      const data = await response.json();\n\n      if (!data.valid) {\n        LogUtil.warn(\"Session invalidated:\", [data.reason]);\n        await this.validateSession(true);\n        return;\n      }\n\n      const oldStatus = { ...PatronSessionManager._patronStatus };\n      PatronSessionManager._patronStatus = {\n        isPatron: data.isPatron || false,\n        tier: data.tier || 0,\n        name: data.name || null,\n        ddbConnected: data.ddbConnected || false,\n        lastValidated: Date.now()\n      };\n\n      const statusChanged =\n        oldStatus.isPatron !== PatronSessionManager._patronStatus.isPatron ||\n        oldStatus.ddbConnected !== PatronSessionManager._patronStatus.ddbConnected;\n\n      if (statusChanged) {\n        Hooks.callAll(`${MODULE_ID}.patronStatusChanged`, PatronSessionManager.getStatus());\n      }\n    } catch (error) {\n      LogUtil.error(\"Heartbeat error:\", [error]);\n    }\n  }\n\n  startHeartbeat() {\n    if (PatronSessionManager._heartbeatInterval) {\n      return;\n    }\n\n    LogUtil.log(\"Starting heartbeat\", [HEARTBEAT_INTERVAL + \"ms interval\"]);\n    PatronSessionManager._heartbeatInterval = setInterval(() => {\n      this.sendHeartbeat();\n    }, HEARTBEAT_INTERVAL);\n  }\n\n  stopHeartbeat() {\n    if (PatronSessionManager._heartbeatInterval) {\n      clearInterval(PatronSessionManager._heartbeatInterval);\n      PatronSessionManager._heartbeatInterval = null;\n      LogUtil.log(\"Heartbeat stopped\");\n    }\n  }\n\n  static async logout() {\n    try {\n      const response = await fetch(`${PROXY_BASE_URL}/auth/logout`, {\n        method: 'POST',\n        credentials: 'include',\n        headers: PatronSessionManager._getAuthHeaders()\n      });\n\n      PatronSessionManager.setSessionToken(null);\n      PatronSessionManager._patronStatus = {\n        isPatron: false,\n        tier: 0,\n        name: null,\n        ddbConnected: false,\n        lastValidated: Date.now()\n      };\n      Hooks.callAll(`${MODULE_ID}.patronStatusChanged`, PatronSessionManager.getStatus());\n      ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.loggedOut\"));\n    } catch (error) {\n      LogUtil.error(\"Logout error:\", [error]);\n      PatronSessionManager.setSessionToken(null);\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.logoutFailed\"));\n    }\n  }\n}\n","import { getSettings } from \"../../../constants/Settings.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../../utils/SettingsUtil.mjs\";\nimport { PremiumFeaturesDialog } from \"../../ui/dialogs/PremiumFeaturesDialog.mjs\";\nimport { PatronSessionManager } from \"../../managers/PatronSessionManager.mjs\";\n\nconst PROXY_BASE_URL = \"https://proxy.carolingian.io\";\n\n/**\n * Manages connection to the D&D Beyond proxy server via SSE\n * Handles connection lifecycle, reconnection logic, and event streaming\n */\nexport class DnDBConnection {\n  static _eventSource = null;\n  static _sessionId = null;\n  static _isConnecting = false;\n  static _reconnectAttempts = 0;\n  static _maxReconnectAttempts = 5;\n  static _reconnectDelay = 5000;\n  static _reconnectTimer = null;\n  static _onRollEvent = null;\n\n  /**\n   * Initialize the connection with a callback for roll events\n   * @param {Function} onRollEvent - Callback function for roll events\n   */\n  static setRollEventHandler(onRollEvent) {\n    this._onRollEvent = onRollEvent;\n  }\n\n  /**\n   * Get the current DnDB configuration from settings\n   * @returns {Object} Configuration object with isValid flag\n   */\n  static getConfig() {\n    const SETTINGS = getSettings();\n    const campaignId = SettingsUtil.get(SETTINGS.ddbCampaignId.tag)?.trim() || \"\";\n    const userId = SettingsUtil.get(SETTINGS.ddbUserId.tag)?.trim() || \"\";\n    const cobaltCookie = SettingsUtil.get(SETTINGS.ddbCobaltCookie.tag)?.trim() || \"\";\n    const sessionToken = PatronSessionManager.getSessionToken();\n\n    return {\n      campaignId,\n      userId,\n      cobaltCookie,\n      sessionToken,\n      isValid: !!(sessionToken && campaignId && userId && cobaltCookie)\n    };\n  }\n\n  /**\n   * Connect to the proxy server and establish SSE connection\n   */\n  static async connect() {\n    if (this._isConnecting || this._eventSource) {\n      LogUtil.log(\"DnDBConnection: Already connected or connecting\");\n      return;\n    }\n\n    const config = this.getConfig();\n    if (!config.isValid) {\n      LogUtil.warn(\"DnDBConnection: Cannot connect - invalid configuration\");\n      return;\n    }\n\n    this._isConnecting = true;\n    this._notifyStatusChange();\n\n    try {\n      const sessionToken = PatronSessionManager.getSessionToken();\n      const headers = {\n        \"Content-Type\": \"application/json\"\n      };\n      if (sessionToken) {\n        headers[\"Authorization\"] = `Bearer ${sessionToken}`;\n      }\n      const response = await fetch(`${PROXY_BASE_URL}/ddb/connect`, {\n        method: \"POST\",\n        credentials: \"include\",\n        headers,\n        body: JSON.stringify({\n          gameId: config.campaignId,\n          userId: config.userId,\n          cobaltCookie: config.cobaltCookie\n        })\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.error || `HTTP ${response.status}`);\n      }\n\n      const data = await response.json();\n      this._sessionId = data.sessionId;\n\n      LogUtil.log(\"DnDBConnection: Connection established\", [this._sessionId]);\n\n      this._establishEventStream();\n      this._reconnectAttempts = 0;\n      this._notifyStatusChange();\n    } catch (error) {\n      LogUtil.log(\"DnDBConnection: Connection attempt failed\", [error.message]);\n      this._scheduleReconnect();\n    } finally {\n      this._isConnecting = false;\n      this._notifyStatusChange();\n    }\n  }\n\n  /**\n   * Establish the SSE event stream\n   */\n  static _establishEventStream() {\n    if (!this._sessionId) {\n      LogUtil.warn(\"DnDBConnection: No session ID for event stream\");\n      return;\n    }\n\n    const sessionToken = PatronSessionManager.getSessionToken();\n    const eventUrl = `${PROXY_BASE_URL}/ddb/events/${this._sessionId}?token=${encodeURIComponent(sessionToken || '')}`;\n\n    this._eventSource = new EventSource(eventUrl, {\n      withCredentials: false\n    });\n\n    this._eventSource.onopen = () => {\n      LogUtil.log(\"DnDBConnection: Event stream opened\");\n      PatronSessionManager.setDDBConnected(true);\n    };\n\n    this._eventSource.onmessage = (event) => {\n      this._handleEvent(event);\n    };\n\n    this._eventSource.onerror = (error) => {\n      LogUtil.error(\"DnDBConnection: Event stream error\", [error]);\n      this._handleDisconnect();\n    };\n  }\n\n  /**\n   * Handle events from the SSE stream\n   * @param {MessageEvent} event - The SSE event\n   */\n  static _handleEvent(event) {\n    const raw = event.data;\n    if (raw === \"pong\" || raw === \"ping\") {\n      return;\n    }\n\n    try {\n      const data = JSON.parse(raw);\n      if (data.eventType === \"dice/roll/fulfilled\") {\n        LogUtil.log(\"DnDBConnection: Roll received\", [\n          `messageScope=${data.messageScope}`,\n          `messageTarget=${data.messageTarget}`,\n          `userId=${data.userId}`,\n          data\n        ]);\n        if (this._onRollEvent) {\n          this._onRollEvent(data);\n        }\n      }\n    } catch (error) {\n      LogUtil.error(\"DnDBConnection: Error parsing event\", [error, raw]);\n    }\n  }\n\n  /**\n   * Handle disconnection\n   */\n  static _handleDisconnect() {\n    this.disconnect();\n    this._scheduleReconnect();\n  }\n\n  /**\n   * Schedule a reconnection attempt\n   */\n  static async _scheduleReconnect() {\n    if (this._reconnectTimer) {\n      clearTimeout(this._reconnectTimer);\n    }\n\n    if (this._reconnectAttempts >= this._maxReconnectAttempts) {\n      LogUtil.warn(\"DnDBConnection: Max reconnect attempts reached\");\n      ui.notifications.error(\n        game.i18n.localize(\"FLASH_ROLLS.notifications.ddbConnectionFailed\")\n      );\n      PatronSessionManager.setDDBConnected(false);\n      return;\n    }\n\n    const patronStatus = PatronSessionManager.getStatus();\n    if (!patronStatus.isPatron) {\n      LogUtil.warn(\"DnDBConnection: Not a patron - stopping reconnection attempts\");\n      PatronSessionManager.setDDBConnected(false);\n      return;\n    }\n\n    const sessionToken = PatronSessionManager.getSessionToken();\n    if (!sessionToken) {\n      LogUtil.warn(\"DnDBConnection: No session token - stopping reconnection attempts\");\n      PatronSessionManager.setDDBConnected(false);\n      return;\n    }\n\n    this._reconnectAttempts++;\n    const delay = this._reconnectDelay * this._reconnectAttempts;\n\n    LogUtil.log(\"DnDBConnection: Scheduling reconnect\", [\n      this._reconnectAttempts,\n      delay\n    ]);\n\n    this._reconnectTimer = setTimeout(() => {\n      this.connect();\n    }, delay);\n  }\n\n  /**\n   * Disconnect from the proxy server\n   */\n  static disconnect() {\n    if (this._eventSource) {\n      this._eventSource.close();\n      this._eventSource = null;\n    }\n\n    if (this._reconnectTimer) {\n      clearTimeout(this._reconnectTimer);\n      this._reconnectTimer = null;\n    }\n\n    this._sessionId = null;\n    this._isConnecting = false;\n\n    LogUtil.log(\"DnDBConnection: Disconnected\");\n    this._notifyStatusChange();\n  }\n\n  /**\n   * Check if currently connected\n   * @returns {boolean}\n   */\n  static isConnected() {\n    return this._eventSource?.readyState === EventSource.OPEN;\n  }\n\n  /**\n   * Get the current connection status\n   * @returns {string} 'connected', 'connecting', or 'disconnected'\n   */\n  static getStatus() {\n    if (this._isConnecting) return \"connecting\";\n    if (this.isConnected()) return \"connected\";\n    return \"disconnected\";\n  }\n\n  /**\n   * Manually trigger a reconnection\n   */\n  static async reconnect() {\n    this.disconnect();\n    this._reconnectAttempts = 0;\n    await this.connect();\n  }\n\n  /**\n   * Notify status change to UI\n   */\n  static _notifyStatusChange() {\n    const dialog = PremiumFeaturesDialog.getInstance();\n    if (dialog) {\n      dialog.updateConnectionStatus(this.getStatus());\n    }\n  }\n}\n","import { MODULE_ID } from \"../../constants/General.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { SocketUtil } from \"../utils/SocketUtil.mjs\";\nimport { getPlayerOwner } from \"../helpers/Helpers.mjs\";\nimport { DnDBConnection } from \"./dnd-beyond/DnDBConnection.mjs\";\nimport { DnDBRollParser } from \"./dnd-beyond/DnDBRollParser.mjs\";\nimport { DnDBRollExecutor } from \"./dnd-beyond/DnDBRollExecutor.mjs\";\nimport { DnDBIntegration } from \"./dnd-beyond/DnDBIntegration.mjs\";\nimport { PatronSessionManager } from \"../managers/PatronSessionManager.mjs\";\n\nconst SOCKET_HANDLERS = {\n  EXECUTE_DDB_ROLL: \"executeDnDBRoll\"\n};\n\n/**\n * Integration with D&D Beyond Game Log via proxy server\n * Orchestrates connection, roll parsing, and execution\n * Premium feature - requires Patreon authentication\n */\nexport class DnDBeyondIntegration {\n\n  /**\n   * Initialize the DnDB Game Log integration\n   * Only runs for GM users with valid configuration\n   */\n  static async initialize() {\n    DnDBIntegration.registerHooks();\n    this._registerSocketHandlers();\n\n    if (!game.user.isGM) {\n      return;\n    }\n\n    const patronStatus = await PatronSessionManager.getInstance().validateSession();\n    if (!patronStatus.isPatron) {\n      LogUtil.log(\"DnDBeyondIntegration: Not a patron - skipping auto-connect\");\n      return;\n    }\n\n    const config = DnDBConnection.getConfig();\n    if (!config.isValid) {\n      LogUtil.log(\"DnDBeyondIntegration: Missing DnDB credentials - skipping auto-connect\");\n      return;\n    }\n\n    LogUtil.log(\"DnDBeyondIntegration: Initializing with config\", [config]);\n\n    DnDBConnection.setRollEventHandler((data) => this._onRollEvent(data));\n    await DnDBConnection.connect();\n  }\n\n  /**\n   * Register socket handlers for player-side roll execution\n   */\n  static _registerSocketHandlers() {\n    LogUtil.log(\"DnDBeyondIntegration._registerSocketHandlers - Attempting registration\", [\n      \"hasSocket:\", !!SocketUtil.socket,\n      \"isGM:\", game.user?.isGM\n    ]);\n    SocketUtil.registerCall(SOCKET_HANDLERS.EXECUTE_DDB_ROLL, this._handleSocketRollExecution.bind(this));\n    LogUtil.log(\"DnDBeyondIntegration: Registered socket handlers\");\n  }\n\n  /**\n   * Handle roll execution request received via socket (runs on player's client)\n   * @param {Object} data - The roll execution data\n   * @param {string} data.actorId - The actor ID\n   * @param {Object} data.rollInfo - The parsed roll info\n   * @param {Object} data.category - The roll category\n   * @returns {Promise<boolean>} Success status\n   */\n  static async _handleSocketRollExecution(data) {\n    const { actorId, rollInfo, category } = data;\n    LogUtil.log(\"DnDBeyondIntegration._handleSocketRollExecution - Received roll request\", [\n      \"actorId:\", actorId,\n      \"action:\", rollInfo.action,\n      \"rollType:\", rollInfo.rollType,\n      \"category:\", category.category,\n      \"isGM:\", game.user.isGM\n    ]);\n\n    const actor = game.actors.get(actorId);\n    if (!actor) {\n      LogUtil.warn(\"DnDBeyondIntegration._handleSocketRollExecution - Actor not found\", [actorId]);\n      return false;\n    }\n\n    return await DnDBRollExecutor.execute(actor, rollInfo, category);\n  }\n\n  /**\n   * Handle roll events from the connection\n   * @param {Object} rollData - The roll data from DnDB\n   */\n  static async _onRollEvent(rollData) {\n    LogUtil.log(\"=== DnDB ROLL EVENT ===\");\n    LogUtil.log(\"Action:\", [rollData.data?.action]);\n    LogUtil.log(\"Roll Type:\", [rollData.data?.rolls?.[0]?.rollType]);\n    LogUtil.log(\"Roll Kind:\", [rollData.data?.rolls?.[0]?.rollKind]);\n    LogUtil.log(\"Visibility:\", [`messageScope=${rollData.messageScope}`, `messageTarget=${rollData.messageTarget}`, `userId=${rollData.userId}`]);\n    LogUtil.log(\"======================\");\n\n    await this._processRollEvent(rollData);\n  }\n\n  /**\n   * Process a roll event\n   * @param {Object} rollData - The roll data from DnDB\n   */\n  static async _processRollEvent(rollData) {\n    const characterId = rollData.entityId;\n    const entityType = rollData.entityType;\n    const actor = this._getActorForCharacter(characterId, entityType);\n\n    const rollInfo = DnDBRollParser.extractRollInfo(rollData);\n    const category = DnDBRollParser.determineRollCategory(\n      rollInfo.action,\n      rollInfo.rollType,\n      actor\n    );\n\n    LogUtil.log(\"DnDBeyondIntegration: Processing roll\", [\n      rollInfo.action,\n      rollInfo.rollType,\n      category.category,\n      actor?.name\n    ]);\n\n    if (actor) {\n      const playerOwner = getPlayerOwner(actor);\n      const shouldPlayerExecute = this._shouldPlayerExecute(playerOwner);\n      LogUtil.log(\"DnDBeyondIntegration: shouldPlayerExecute\", [shouldPlayerExecute]);\n\n      if (shouldPlayerExecute) {\n        LogUtil.log(\"DnDBeyondIntegration: Sending roll to player\", [\n          \"category:\", category.category\n        ]);\n        const success = await this._sendRollToPlayer(actor, rollInfo, category, playerOwner);\n        if (success) return;\n        LogUtil.log(\"DnDBeyondIntegration: Player execution failed, falling back to GM\");\n      }\n\n      const success = await DnDBRollExecutor.execute(actor, rollInfo, category);\n      if (success) return;\n    }\n\n    await this._createFallbackMessage(rollInfo);\n  }\n\n  /**\n   * Check if a player should execute the roll based on settings and online status\n   * @param {User|null} playerOwner - The player owner of the actor\n   * @returns {boolean} Whether the player should execute the roll\n   */\n  static _shouldPlayerExecute(playerOwner) {\n    const SETTINGS = getSettings();\n    const rollOwnership = SettingsUtil.get(SETTINGS.ddbRollOwnership.tag) ?? 0;\n\n    LogUtil.log(\"DnDBeyondIntegration._shouldPlayerExecute\", [\n      \"playerOwner:\", playerOwner?.name,\n      \"playerActive:\", playerOwner?.active,\n      \"rollOwnership setting:\", rollOwnership,\n      \"result:\", rollOwnership === 1 && !!playerOwner && playerOwner.active\n    ]);\n\n    if (!playerOwner) return false;\n    if (!playerOwner.active) return false;\n    return rollOwnership === 1;\n  }\n\n  /**\n   * Send roll execution request to player via socket\n   * @param {Actor} actor - The actor performing the roll\n   * @param {Object} rollInfo - The parsed roll info\n   * @param {Object} category - The roll category\n   * @param {User} playerOwner - The player to send the roll to\n   * @returns {Promise<boolean>} Success status\n   */\n  static async _sendRollToPlayer(actor, rollInfo, category, playerOwner) {\n    try {\n      const data = {\n        actorId: actor.id,\n        rollInfo: rollInfo,\n        category: category\n      };\n\n      const result = await SocketUtil.execForUser(\n        SOCKET_HANDLERS.EXECUTE_DDB_ROLL,\n        playerOwner.id,\n        data\n      );\n\n      LogUtil.log(\"DnDBeyondIntegration._sendRollToPlayer - Result\", [result]);\n      return result === true;\n    } catch (error) {\n      LogUtil.error(\"DnDBeyondIntegration._sendRollToPlayer - Failed\", [error]);\n      return false;\n    }\n  }\n\n  /**\n   * Create a fallback roll message when no actor is mapped\n   * Creates a proper Roll object using DnDB dice values\n   * @param {Object} rollInfo - The parsed roll information\n   */\n  static async _createFallbackMessage(rollInfo) {\n    await DnDBRollExecutor.createSimpleRollMessage(rollInfo);\n  }\n\n  /**\n   * Get the Foundry actor associated with a DnDB entity ID\n   * @param {string|number} entityId - The DnDB entity ID (character or monster)\n   * @param {string} entityType - The entity type (\"character\" or \"monster\")\n   * @returns {Actor|null}\n   */\n  static _getActorForCharacter(entityId, entityType = \"character\") {\n    const entityIdStr = String(entityId);\n    const SETTINGS = getSettings();\n    const mappings = SettingsUtil.get(SETTINGS.ddbCharacterMappings.tag) || {};\n    const actorId = mappings[entityIdStr];\n\n    if (actorId) {\n      const actor = game.actors.get(actorId);\n      if (actor) {\n        return actor;\n      }\n      LogUtil.warn(\"DnDBeyondIntegration: Mapped actor not found\", [actorId]);\n    }\n\n    if (entityType === \"monster\") {\n      const actorByMonsterId = game.actors.find(a => {\n        const ddbId = a.flags?.ddbimporter?.id;\n        return ddbId && String(ddbId) === entityIdStr;\n      });\n\n      if (actorByMonsterId) {\n        LogUtil.log(\"DnDBeyondIntegration: Found monster actor via ddbimporter.id\", [actorByMonsterId.name]);\n        return actorByMonsterId;\n      }\n    }\n\n    const actorByDDBFlag = game.actors.find(a => {\n      const dndbeyond = a.flags?.ddbimporter?.dndbeyond;\n      if (!dndbeyond) return false;\n      if (dndbeyond.characterId && String(dndbeyond.characterId) === entityIdStr) {\n        return true;\n      }\n      if (dndbeyond.url && dndbeyond.url.includes(`/characters/${entityIdStr}`)) {\n        return true;\n      }\n      return false;\n    });\n\n    if (actorByDDBFlag) {\n      LogUtil.log(\"DnDBeyondIntegration: Found actor via ddbimporter flag\", [actorByDDBFlag.name]);\n      return actorByDDBFlag;\n    }\n\n    LogUtil.log(\"DnDBeyondIntegration: No actor found for entity\", [entityIdStr, entityType]);\n    return null;\n  }\n\n  /**\n   * Connect to the proxy server\n   */\n  static async connect() {\n    DnDBConnection.setRollEventHandler((data) => this._onRollEvent(data));\n    await DnDBConnection.connect();\n  }\n\n  /**\n   * Disconnect from the proxy server\n   */\n  static disconnect() {\n    DnDBConnection.disconnect();\n  }\n\n  /**\n   * Manually trigger a reconnection\n   */\n  static async reconnect() {\n    DnDBConnection.setRollEventHandler((data) => this._onRollEvent(data));\n    await DnDBConnection.reconnect();\n  }\n\n  /**\n   * Check if currently connected\n   * @returns {boolean}\n   */\n  static isConnected() {\n    return DnDBConnection.isConnected();\n  }\n\n  /**\n   * Get the current connection status\n   * @returns {string} 'connected', 'connecting', or 'disconnected'\n   */\n  static getStatus() {\n    return DnDBConnection.getStatus();\n  }\n\n  /**\n   * Map a DnDB character ID to a Foundry actor ID\n   * @param {string|number} ddbCharacterId - The DnDB character ID\n   * @param {string} foundryActorId - The Foundry actor ID\n   */\n  static async mapCharacter(ddbCharacterId, foundryActorId) {\n    const charIdStr = String(ddbCharacterId);\n    const SETTINGS = getSettings();\n    const mappings = SettingsUtil.get(SETTINGS.ddbCharacterMappings.tag) || {};\n\n    mappings[charIdStr] = foundryActorId;\n\n    await SettingsUtil.set(SETTINGS.ddbCharacterMappings.tag, mappings);\n    LogUtil.log(\"DnDBeyondIntegration: Character mapped\", [charIdStr, foundryActorId]);\n  }\n\n  /**\n   * Remove a character mapping\n   * @param {string|number} ddbCharacterId - The DnDB character ID to unmap\n   */\n  static async unmapCharacter(ddbCharacterId) {\n    const charIdStr = String(ddbCharacterId);\n    const SETTINGS = getSettings();\n    const mappings = SettingsUtil.get(SETTINGS.ddbCharacterMappings.tag) || {};\n\n    delete mappings[charIdStr];\n\n    await SettingsUtil.set(SETTINGS.ddbCharacterMappings.tag, mappings);\n    LogUtil.log(\"DnDBeyondIntegration: Character unmapped\", [charIdStr]);\n  }\n\n  /**\n   * Get all current character mappings\n   * @returns {Object} Object mapping DnDB character IDs to Foundry actor IDs\n   */\n  static getMappings() {\n    const SETTINGS = getSettings();\n    return SettingsUtil.get(SETTINGS.ddbCharacterMappings.tag) || {};\n  }\n}\n","import { getSettings } from \"../../../constants/Settings.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../../utils/SettingsUtil.mjs\";\nimport { PatronSessionManager } from \"../../managers/PatronSessionManager.mjs\";\n\nfunction getProxyBaseUrl() {\n  return window.FLASH5E_DEV_PROXY || \"https://proxy.carolingian.io\";\n}\n\n/**\n * Fetches character data from D&D Beyond via the proxy server\n */\nexport class DnDBCharacterFetcher {\n\n  /**\n   * Fetch complete character data from D&D Beyond\n   * @param {string|number} characterId - The DDB character ID\n   * @returns {Promise<Object|null>} Full character data or null on error\n   */\n  static async fetchCharacter(characterId) {\n    if (!characterId) {\n      LogUtil.warn(\"DnDBCharacterFetcher: No character ID provided\");\n      return null;\n    }\n\n    const config = this._getConfig();\n    if (!config.isValid) {\n      LogUtil.warn(\"DnDBCharacterFetcher: Invalid configuration\");\n      return null;\n    }\n\n    try {\n      const headers = {\n        \"Content-Type\": \"application/json\"\n      };\n      if (config.sessionToken) {\n        headers[\"Authorization\"] = `Bearer ${config.sessionToken}`;\n      }\n      if (config.cobaltCookie) {\n        headers[\"X-Cobalt-Cookie\"] = config.cobaltCookie;\n      }\n\n      const response = await fetch(`${getProxyBaseUrl()}/ddb/character/${characterId}`, {\n        method: \"GET\",\n        credentials: \"include\",\n        headers\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.error || `HTTP ${response.status}`);\n      }\n\n      const data = await response.json();\n      LogUtil.log(\"DnDBCharacterFetcher: Character data fetched\", [characterId, data.name]);\n      LogUtil.log(\"DnDBCharacterFetcher: Full character data\", [JSON.stringify(data, null, 2), data]);\n      return data;\n    } catch (error) {\n      LogUtil.error(\"DnDBCharacterFetcher: Failed to fetch character\", [characterId, error.message]);\n      return null;\n    }\n  }\n\n  /**\n   * Fetch multiple characters in parallel\n   * @param {Array<string|number>} characterIds - Array of DDB character IDs\n   * @returns {Promise<Map<string, Object>>} Map of characterId to character data\n   */\n  static async fetchCharacters(characterIds) {\n    const results = new Map();\n    const promises = characterIds.map(async (id) => {\n      const data = await this.fetchCharacter(id);\n      if (data) {\n        results.set(String(id), data);\n      }\n    });\n\n    await Promise.all(promises);\n    return results;\n  }\n\n  /**\n   * Get configuration for API calls\n   * @returns {Object} Configuration with isValid flag\n   * @private\n   */\n  static _getConfig() {\n    const SETTINGS = getSettings();\n    const cobaltCookie = SettingsUtil.get(SETTINGS.ddbCobaltCookie.tag)?.trim() || \"\";\n    const sessionToken = PatronSessionManager.getSessionToken();\n\n    return {\n      cobaltCookie,\n      sessionToken,\n      isValid: !!(sessionToken && cobaltCookie)\n    };\n  }\n}\n","import { LogUtil } from \"../../utils/LogUtil.mjs\";\n\n/**\n * DDB ability ID to Foundry ability key mapping\n */\nconst DDB_ABILITY_MAP = {\n  1: \"str\",\n  2: \"dex\",\n  3: \"con\",\n  4: \"int\",\n  5: \"wis\",\n  6: \"cha\"\n};\n\n/**\n * Transforms D&D Beyond character data into Foundry VTT Actor5e format\n */\nexport class DnDBCharacterTransformer {\n\n  /**\n   * Transform DDB character data to Foundry actor creation data\n   * @param {Object} ddbCharacter - Full DDB character data\n   * @param {Object} matchResult - Compendium matching results\n   * @returns {Object} Actor creation data compatible with Actor.create()\n   */\n  static transformToActor(ddbCharacter, matchResult) {\n    const abilities = this._transformAbilities(ddbCharacter);\n    const totalLevel = this._calculateTotalLevel(ddbCharacter);\n    const hp = this._transformHP(ddbCharacter);\n    const currency = this._transformCurrency(ddbCharacter);\n    const skills = this._transformSkills(ddbCharacter);\n    const movement = this._transformMovement(ddbCharacter);\n    const senses = this._transformSenses(ddbCharacter);\n    const traits = this._transformTraits(ddbCharacter);\n    const tools = this.transformTools(ddbCharacter);\n\n    return {\n      name: ddbCharacter.name,\n      type: \"character\",\n      img: this._getAvatarUrl(ddbCharacter),\n      system: {\n        abilities,\n        skills,\n        tools,\n        attributes: {\n          hp,\n          death: {\n            success: ddbCharacter.deathSaves?.successCount || 0,\n            failure: ddbCharacter.deathSaves?.failCount || 0\n          },\n          inspiration: ddbCharacter.inspiration || false,\n          movement,\n          senses\n        },\n        traits,\n        details: {\n          xp: { value: ddbCharacter.currentXp || 0 },\n          appearance: ddbCharacter.traits?.appearance || \"\",\n          trait: ddbCharacter.traits?.personalityTraits || \"\",\n          ideal: ddbCharacter.traits?.ideals || \"\",\n          bond: ddbCharacter.traits?.bonds || \"\",\n          flaw: ddbCharacter.traits?.flaws || \"\"\n        },\n        currency\n      },\n      flags: {\n        \"flash-rolls-5e\": {\n          ddbCharacterId: ddbCharacter.id,\n          importTier: matchResult.tier,\n          importDate: Date.now(),\n          unmatchedItems: matchResult.unmatched.map(u => u.name)\n        },\n        ddbimporter: {\n          dndbeyond: {\n            characterId: ddbCharacter.id,\n            url: `https://www.dndbeyond.com/characters/${ddbCharacter.id}`\n          }\n        }\n      }\n    };\n  }\n\n  /**\n   * Transform DDB ability scores to Foundry format\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Object} Foundry abilities object\n   * @private\n   */\n  static _transformAbilities(ddbCharacter) {\n    const abilities = {};\n    const allMods = this._getAllModifiers(ddbCharacter);\n\n    const savingThrowMap = {\n      \"strength-saving-throws\": \"str\",\n      \"dexterity-saving-throws\": \"dex\",\n      \"constitution-saving-throws\": \"con\",\n      \"intelligence-saving-throws\": \"int\",\n      \"wisdom-saving-throws\": \"wis\",\n      \"charisma-saving-throws\": \"cha\"\n    };\n\n    const saveProficiencies = new Set();\n    for (const mod of allMods) {\n      if (mod.type === \"proficiency\" && savingThrowMap[mod.subType]) {\n        saveProficiencies.add(savingThrowMap[mod.subType]);\n      }\n    }\n\n    LogUtil.log(\"DnDBCharacterTransformer: Processing abilities\", [\n      `stats: ${JSON.stringify(ddbCharacter.stats?.slice(0, 2))}...`,\n      `bonusStats: ${JSON.stringify(ddbCharacter.bonusStats?.slice(0, 2))}...`,\n      `saveProficiencies: ${Array.from(saveProficiencies).join(\", \")}`\n    ]);\n\n    for (const [ddbId, foundryKey] of Object.entries(DDB_ABILITY_MAP)) {\n      const numericId = Number(ddbId);\n      const baseValue = this._getStatValue(ddbCharacter.stats, numericId);\n      const bonusValue = this._getStatValue(ddbCharacter.bonusStats, numericId);\n      const overrideValue = this._getStatValue(ddbCharacter.overrideStats, numericId, true);\n\n      const finalValue = overrideValue !== null ? overrideValue : (baseValue + bonusValue);\n      abilities[foundryKey] = {\n        value: finalValue,\n        proficient: saveProficiencies.has(foundryKey) ? 1 : 0\n      };\n\n      if (finalValue === 0) {\n        LogUtil.warn(\"DnDBCharacterTransformer: Ability is 0\", [\n          foundryKey, `base=${baseValue}`, `bonus=${bonusValue}`, `override=${overrideValue}`\n        ]);\n      }\n    }\n\n    return abilities;\n  }\n\n  /**\n   * Get stat value from DDB stats array\n   * @param {Array} statsArray - Array of stat objects\n   * @param {number} statId - Stat ID to find\n   * @param {boolean} returnNull - If true, return null when not found instead of 0\n   * @returns {number|null} Stat value, 0, or null\n   * @private\n   */\n  static _getStatValue(statsArray, statId, returnNull = false) {\n    if (!Array.isArray(statsArray)) return returnNull ? null : 0;\n    const stat = statsArray.find(s => s.id === statId);\n    if (!stat || stat.value === null || stat.value === undefined) {\n      return returnNull ? null : 0;\n    }\n    return stat.value;\n  }\n\n  /**\n   * Calculate total character level from classes\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {number} Total level\n   * @private\n   */\n  static _calculateTotalLevel(ddbCharacter) {\n    if (!Array.isArray(ddbCharacter.classes)) return 1;\n    return ddbCharacter.classes.reduce((sum, cls) => sum + (cls.level || 0), 0) || 1;\n  }\n\n  /**\n   * Transform HP values from DDB format\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Object} Foundry HP object\n   * @private\n   */\n  static _transformHP(ddbCharacter) {\n    const baseHp = ddbCharacter.baseHitPoints || 0;\n    const bonusHp = ddbCharacter.bonusHitPoints || 0;\n    const overrideHp = ddbCharacter.overrideHitPoints;\n    const tempHp = ddbCharacter.temporaryHitPoints || 0;\n    const removedHp = ddbCharacter.removedHitPoints || 0;\n\n    const maxHp = overrideHp ?? (baseHp + bonusHp);\n    const currentHp = Math.max(0, maxHp - removedHp);\n\n    return {\n      value: currentHp,\n      max: maxHp,\n      temp: tempHp\n    };\n  }\n\n  /**\n   * Transform currency from DDB format\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Object} Foundry currency object\n   * @private\n   */\n  static _transformCurrency(ddbCharacter) {\n    const currencies = ddbCharacter.currencies || {};\n    return {\n      cp: currencies.cp || 0,\n      sp: currencies.sp || 0,\n      ep: currencies.ep || 0,\n      gp: currencies.gp || 0,\n      pp: currencies.pp || 0\n    };\n  }\n\n  /**\n   * Get avatar URL, falling back to default\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {string} Avatar URL\n   * @private\n   */\n  static _getAvatarUrl(ddbCharacter) {\n    if (ddbCharacter.avatarUrl) {\n      return ddbCharacter.avatarUrl;\n    }\n    if (ddbCharacter.decorations?.avatarUrl) {\n      return ddbCharacter.decorations.avatarUrl;\n    }\n    return \"icons/svg/mystery-man.svg\";\n  }\n\n  /**\n   * Apply DDB item state to a Foundry item data object\n   * @param {Object} itemData - Foundry item data (will be modified)\n   * @param {Object} ddbItem - DDB item data\n   */\n  static applyItemState(itemData, ddbItem) {\n    if (itemData.system.equipped !== undefined && ddbItem.equipped !== undefined) {\n      itemData.system.equipped = ddbItem.equipped;\n    }\n\n    if (itemData.system.attunement !== undefined && ddbItem.isAttuned) {\n      itemData.system.attuned = true;\n    }\n\n    if (itemData.system.quantity !== undefined) {\n      itemData.system.quantity = ddbItem.quantity || 1;\n    }\n\n    if (itemData.type === \"spell\") {\n      const isCantrip = ddbItem.definition?.level === 0;\n      if (ddbItem.alwaysPrepared) {\n        itemData.system.prepared = 2;\n      } else if (ddbItem.prepared || isCantrip) {\n        itemData.system.prepared = 1;\n      } else {\n        itemData.system.prepared = 0;\n      }\n    }\n\n    if (itemData.type === \"class\") {\n      const classLevel = ddbItem._classLevel || 1;\n      if (!itemData.system) itemData.system = {};\n      itemData.system.levels = classLevel;\n\n      if (!itemData.system.hd) {\n        itemData.system.hd = {};\n      }\n      itemData.system.hd.spent = 0;\n    }\n  }\n\n  /**\n   * Get class information from DDB character\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Array<Object>} Array of class info objects\n   */\n  static getClassInfo(ddbCharacter) {\n    if (!Array.isArray(ddbCharacter.classes)) return [];\n\n    return ddbCharacter.classes.map(cls => ({\n      name: cls.definition?.name || \"Unknown\",\n      level: cls.level || 1,\n      subclass: cls.subclassDefinition?.name || null,\n      isStartingClass: cls.isStartingClass || false\n    }));\n  }\n\n  /**\n   * Get race/species name from DDB character\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {string|null} Race name or null\n   */\n  static getRaceName(ddbCharacter) {\n    if (ddbCharacter.race?.fullName) {\n      return ddbCharacter.race.fullName;\n    }\n    if (ddbCharacter.race?.baseName) {\n      return ddbCharacter.race.baseName;\n    }\n    return null;\n  }\n\n  /**\n   * Get background name from DDB character\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {string|null} Background name or null\n   */\n  static getBackgroundName(ddbCharacter) {\n    return ddbCharacter.background?.definition?.name || null;\n  }\n\n  /**\n   * Get all modifiers from all sources\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Array} Combined array of all modifiers\n   * @private\n   */\n  static _getAllModifiers(ddbCharacter) {\n    const modifiers = ddbCharacter.modifiers || {};\n    const allMods = [];\n    for (const source of [\"race\", \"class\", \"background\", \"feat\", \"item\"]) {\n      if (Array.isArray(modifiers[source])) {\n        allMods.push(...modifiers[source]);\n      }\n    }\n    return allMods;\n  }\n\n  /**\n   * Transform skill proficiencies from DDB modifiers\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Object} Foundry skills object\n   * @private\n   */\n  static _transformSkills(ddbCharacter) {\n    const skills = {};\n    const allMods = this._getAllModifiers(ddbCharacter);\n\n    const skillMap = {\n      acrobatics: \"acr\",\n      \"animal-handling\": \"ani\",\n      arcana: \"arc\",\n      athletics: \"ath\",\n      deception: \"dec\",\n      history: \"his\",\n      insight: \"ins\",\n      intimidation: \"itm\",\n      investigation: \"inv\",\n      medicine: \"med\",\n      nature: \"nat\",\n      perception: \"prc\",\n      performance: \"prf\",\n      persuasion: \"per\",\n      religion: \"rel\",\n      \"sleight-of-hand\": \"slt\",\n      stealth: \"ste\",\n      survival: \"sur\"\n    };\n\n    for (const [ddbSkill, foundrySkill] of Object.entries(skillMap)) {\n      const profMod = allMods.find(m =>\n        m.type === \"proficiency\" &&\n        m.subType === ddbSkill &&\n        (m.isGranted === true || m.isGranted === false)\n      );\n\n      const expertiseMod = allMods.find(m =>\n        m.type === \"expertise\" &&\n        m.subType === ddbSkill\n      );\n\n      if (expertiseMod) {\n        skills[foundrySkill] = { value: 2 };\n      } else if (profMod) {\n        skills[foundrySkill] = { value: 1 };\n      }\n    }\n\n    const savingThrowMap = {\n      \"strength-saving-throws\": \"str\",\n      \"dexterity-saving-throws\": \"dex\",\n      \"constitution-saving-throws\": \"con\",\n      \"intelligence-saving-throws\": \"int\",\n      \"wisdom-saving-throws\": \"wis\",\n      \"charisma-saving-throws\": \"cha\"\n    };\n\n    LogUtil.log(\"DnDBCharacterTransformer: Skills transformed\", [\n      Object.keys(skills).length,\n      Object.entries(skills).map(([k, v]) => `${k}:${v.value}`).join(\", \")\n    ]);\n\n    return skills;\n  }\n\n  /**\n   * Transform movement speeds from DDB modifiers\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Object} Foundry movement object\n   * @private\n   */\n  static _transformMovement(ddbCharacter) {\n    const allMods = this._getAllModifiers(ddbCharacter);\n    const movement = {\n      walk: 30,\n      burrow: 0,\n      climb: 0,\n      fly: 0,\n      swim: 0,\n      units: \"ft\",\n      hover: false\n    };\n\n    const speedTypes = {\n      \"innate-speed-walking\": \"walk\",\n      \"innate-speed-swimming\": \"swim\",\n      \"innate-speed-flying\": \"fly\",\n      \"innate-speed-climbing\": \"climb\",\n      \"innate-speed-burrowing\": \"burrow\",\n      \"speed-walking\": \"walk\",\n      \"speed-swimming\": \"swim\",\n      \"speed-flying\": \"fly\",\n      \"speed-climbing\": \"climb\"\n    };\n\n    for (const mod of allMods) {\n      if (mod.type === \"set\" && speedTypes[mod.subType]) {\n        const speedType = speedTypes[mod.subType];\n        const value = mod.value || mod.fixedValue || 0;\n        if (value > movement[speedType]) {\n          movement[speedType] = value;\n        }\n      }\n    }\n\n    LogUtil.log(\"DnDBCharacterTransformer: Movement\", [\n      `walk: ${movement.walk}`,\n      `fly: ${movement.fly}`,\n      `swim: ${movement.swim}`\n    ]);\n\n    return movement;\n  }\n\n  /**\n   * Transform senses from DDB modifiers\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Object} Foundry senses object\n   * @private\n   */\n  static _transformSenses(ddbCharacter) {\n    const allMods = this._getAllModifiers(ddbCharacter);\n    const senses = {\n      darkvision: 0,\n      blindsight: 0,\n      tremorsense: 0,\n      truesight: 0,\n      units: \"ft\",\n      special: \"\"\n    };\n\n    for (const mod of allMods) {\n      if (mod.type === \"set-base\" || mod.type === \"sense\") {\n        const value = mod.value || mod.fixedValue || 0;\n        if (mod.subType === \"darkvision\" && value > senses.darkvision) {\n          senses.darkvision = value;\n        } else if (mod.subType === \"blindsight\" && value > senses.blindsight) {\n          senses.blindsight = value;\n        } else if (mod.subType === \"tremorsense\" && value > senses.tremorsense) {\n          senses.tremorsense = value;\n        } else if (mod.subType === \"truesight\" && value > senses.truesight) {\n          senses.truesight = value;\n        }\n      }\n    }\n\n    LogUtil.log(\"DnDBCharacterTransformer: Senses\", [\n      `darkvision: ${senses.darkvision}`\n    ]);\n\n    return senses;\n  }\n\n  /**\n   * Transform traits (languages, proficiencies) from DDB modifiers\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Object} Foundry traits object\n   * @private\n   */\n  static _transformTraits(ddbCharacter) {\n    const allMods = this._getAllModifiers(ddbCharacter);\n    const languages = new Set();\n    const weaponProf = new Set();\n    const armorProf = new Set();\n    const toolProf = [];\n\n    for (const mod of allMods) {\n      if (mod.type === \"language\") {\n        const langName = mod.subType?.replace(/-/g, \" \");\n        if (langName) languages.add(langName);\n      } else if (mod.type === \"proficiency\") {\n        if (mod.subType?.includes(\"armor\") || mod.subType === \"shields\") {\n          armorProf.add(mod.subType.replace(/-/g, \" \"));\n        } else if (mod.subType?.includes(\"weapons\")) {\n          weaponProf.add(mod.subType.replace(/-/g, \" \"));\n        }\n      }\n    }\n\n    LogUtil.log(\"DnDBCharacterTransformer: Traits\", [\n      `languages: ${Array.from(languages).join(\", \")}`,\n      `armor: ${Array.from(armorProf).join(\", \")}`,\n      `weapons: ${Array.from(weaponProf).join(\", \")}`\n    ]);\n\n    return {\n      languages: {\n        value: Array.from(languages)\n      },\n      weaponProf: {\n        value: Array.from(weaponProf)\n      },\n      armorProf: {\n        value: Array.from(armorProf)\n      }\n    };\n  }\n\n  /**\n   * Standard multiclass spell slot progression table (PHB)\n   * Index = effective caster level - 1, values = [1st, 2nd, 3rd, 4th, 5th, 6th, 7th, 8th, 9th]\n   * @private\n   */\n  static MULTICLASS_SPELL_SLOTS = [\n    [2, 0, 0, 0, 0, 0, 0, 0, 0],  // Level 1\n    [3, 0, 0, 0, 0, 0, 0, 0, 0],  // Level 2\n    [4, 2, 0, 0, 0, 0, 0, 0, 0],  // Level 3\n    [4, 3, 0, 0, 0, 0, 0, 0, 0],  // Level 4\n    [4, 3, 2, 0, 0, 0, 0, 0, 0],  // Level 5\n    [4, 3, 3, 0, 0, 0, 0, 0, 0],  // Level 6\n    [4, 3, 3, 1, 0, 0, 0, 0, 0],  // Level 7\n    [4, 3, 3, 2, 0, 0, 0, 0, 0],  // Level 8\n    [4, 3, 3, 3, 1, 0, 0, 0, 0],  // Level 9\n    [4, 3, 3, 3, 2, 0, 0, 0, 0],  // Level 10\n    [4, 3, 3, 3, 2, 1, 0, 0, 0],  // Level 11\n    [4, 3, 3, 3, 2, 1, 0, 0, 0],  // Level 12\n    [4, 3, 3, 3, 2, 1, 1, 0, 0],  // Level 13\n    [4, 3, 3, 3, 2, 1, 1, 0, 0],  // Level 14\n    [4, 3, 3, 3, 2, 1, 1, 1, 0],  // Level 15\n    [4, 3, 3, 3, 2, 1, 1, 1, 0],  // Level 16\n    [4, 3, 3, 3, 2, 1, 1, 1, 1],  // Level 17\n    [4, 3, 3, 3, 3, 1, 1, 1, 1],  // Level 18\n    [4, 3, 3, 3, 3, 2, 1, 1, 1],  // Level 19\n    [4, 3, 3, 3, 3, 2, 2, 1, 1],  // Level 20\n  ];\n\n  /**\n   * Calculate spell slots from DDB character using multiclass rules\n   * Calculates effective caster level from all classes, then looks up standard table\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Object} Object with max, value, and used per spell level\n   */\n  static getSpellSlots(ddbCharacter) {\n    const result = { spellSlots: {}, pactSlots: null };\n    const spellSlotsUsed = ddbCharacter.spellSlots || [];\n    const pactMagic = ddbCharacter.pactMagic || [];\n    const classes = ddbCharacter.classes || [];\n\n    const usedByLevel = {};\n    for (const slot of spellSlotsUsed) {\n      if (slot.level >= 1 && slot.level <= 9) {\n        usedByLevel[slot.level] = slot.used || 0;\n      }\n    }\n\n    let effectiveCasterLevel = 0;\n    const casterClasses = [];\n\n    for (const cls of classes) {\n      const classLevel = cls.level || 1;\n      const spellRules = cls.definition?.spellRules;\n      const divisor = spellRules?.multiClassSpellSlotDivisor;\n\n      if (divisor && divisor > 0 && spellRules?.levelSpellSlots) {\n        const contribution = Math.floor(classLevel / divisor);\n        effectiveCasterLevel += contribution;\n        casterClasses.push({\n          name: cls.definition?.name,\n          level: classLevel,\n          divisor,\n          contribution\n        });\n      }\n    }\n\n    if (casterClasses.length > 0) {\n      LogUtil.log(\"DnDBCharacterTransformer: Caster level calculation\", [\n        casterClasses.map(c => `${c.name} ${c.level}/${c.divisor}=${c.contribution}`).join(\", \"),\n        `Effective level: ${effectiveCasterLevel}`\n      ]);\n    }\n\n    if (effectiveCasterLevel > 0) {\n      const tableIndex = Math.min(effectiveCasterLevel, 20) - 1;\n      const slotsAtLevel = this.MULTICLASS_SPELL_SLOTS[tableIndex];\n\n      for (let i = 0; i < slotsAtLevel.length; i++) {\n        const spellLevel = i + 1;\n        const max = slotsAtLevel[i];\n        if (max > 0) {\n          const used = usedByLevel[spellLevel] || 0;\n          const remaining = Math.max(0, max - used);\n          result.spellSlots[spellLevel] = { max, value: remaining, used };\n        }\n      }\n    }\n\n    const pactSlot = pactMagic.find(p => p.level > 0);\n    if (pactSlot) {\n      const pactMax = pactSlot.available || 0;\n      const pactUsed = pactSlot.used || 0;\n      result.pactSlots = {\n        max: pactMax,\n        value: Math.max(0, pactMax - pactUsed),\n        used: pactUsed,\n        level: pactSlot.level\n      };\n    }\n\n    const slotEntries = Object.entries(result.spellSlots)\n      .map(([level, data]) => `spell${level}: ${data.value}/${data.max}`);\n    if (result.pactSlots) {\n      slotEntries.push(`pact: ${result.pactSlots.value}/${result.pactSlots.max}`);\n    }\n\n    if (slotEntries.length > 0) {\n      LogUtil.log(\"DnDBCharacterTransformer: Spell slots calculated\", slotEntries);\n    }\n\n    return result;\n  }\n\n  /**\n   * Apply spell slot values directly to actor's spells data\n   * Sets both max (as override) and value based on DDB data\n   * @param {Actor} actor - The actor to update\n   * @param {Object} slotData - Data from getSpellSlots\n   * @returns {Promise<Object>} Update data that was applied\n   */\n  static async applySpellSlots(actor, slotData) {\n    const updateData = {};\n\n    for (const [level, data] of Object.entries(slotData.spellSlots)) {\n      const slotKey = `spell${level}`;\n      updateData[`system.spells.${slotKey}.value`] = data.value;\n      updateData[`system.spells.${slotKey}.override`] = data.max;\n    }\n\n    if (slotData.pactSlots) {\n      updateData[`system.spells.pact.value`] = slotData.pactSlots.value;\n      updateData[`system.spells.pact.override`] = slotData.pactSlots.max;\n      updateData[`system.spells.pact.level`] = slotData.pactSlots.level;\n    }\n\n    if (Object.keys(updateData).length > 0) {\n      await actor.update(updateData);\n      LogUtil.log(\"DnDBCharacterTransformer: Applied spell slots\", [\n        Object.entries(updateData).map(([k, v]) => `${k}: ${v}`).join(\", \")\n      ]);\n    }\n\n    return updateData;\n  }\n\n  /**\n   * Extract tool proficiencies from DDB character data\n   * Returns array of tool names that the character is proficient with\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Array<Object>} Array of tool proficiency objects with name and type\n   */\n  static getToolProficiencies(ddbCharacter) {\n    const allMods = this._getAllModifiers(ddbCharacter);\n    const tools = [];\n\n    const toolTypes = new Set([\n      \"alchemists-supplies\", \"brewers-supplies\", \"calligraphers-supplies\",\n      \"carpenters-tools\", \"cartographers-tools\", \"cobblers-tools\",\n      \"cooks-utensils\", \"glassblowers-tools\", \"jewelers-tools\",\n      \"leatherworkers-tools\", \"masons-tools\", \"painters-supplies\",\n      \"potters-tools\", \"smiths-tools\", \"tinkers-tools\", \"weavers-tools\",\n      \"woodcarvers-tools\", \"disguise-kit\", \"forgery-kit\", \"herbalism-kit\",\n      \"navigators-tools\", \"poisoners-kit\", \"thieves-tools\",\n      \"bagpipes\", \"drum\", \"dulcimer\", \"flute\", \"horn\", \"lute\", \"lyre\",\n      \"pan-flute\", \"shawm\", \"viol\",\n      \"dice-set\", \"dragonchess-set\", \"playing-card-set\", \"three-dragon-ante-set\"\n    ]);\n\n    for (const mod of allMods) {\n      if (mod.type === \"proficiency\" && toolTypes.has(mod.subType)) {\n        const toolName = mod.friendlySubtypeName || mod.subType.replace(/-/g, \" \");\n        tools.push({\n          name: toolName,\n          subType: mod.subType,\n          type: \"tool\"\n        });\n      }\n    }\n\n    if (tools.length > 0) {\n      LogUtil.log(\"DnDBCharacterTransformer: Tool proficiencies\", [\n        tools.map(t => t.name).join(\", \")\n      ]);\n    }\n\n    return tools;\n  }\n\n  /**\n   * Build a mapping from tool display names to Foundry tool keys\n   * Uses CONFIG.DND5E.tools and compendium lookups dynamically\n   * @returns {Object} Map of lowercase tool name -> Foundry tool key\n   * @private\n   */\n  static _buildToolNameToKeyMap() {\n    const toolNameMap = {};\n    const tools = CONFIG.DND5E?.tools || {};\n\n    for (const [key, toolConfig] of Object.entries(tools)) {\n      const toolId = toolConfig.id;\n      if (toolId) {\n        const toolItem = dnd5e.documents.Trait.getBaseItem(toolId, { indexOnly: true });\n        if (toolItem?.name) {\n          toolNameMap[toolItem.name.toLowerCase()] = key;\n        }\n      }\n    }\n\n    LogUtil.log(\"DnDBCharacterTransformer: Built tool name map\", [\n      Object.keys(toolNameMap).length + \" tools mapped\"\n    ]);\n\n    return toolNameMap;\n  }\n\n  /**\n   * Extract tool proficiency choices from DDB character data\n   * Looks at choices.background and choices.class for tool selections\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Array<string>} Array of selected tool names\n   * @private\n   */\n  static _extractToolChoices(ddbCharacter) {\n    const toolNames = [];\n    const choices = ddbCharacter.choices || {};\n    const choiceDefinitions = choices.choiceDefinitions || [];\n\n    const optionIdToLabel = {};\n    for (const def of choiceDefinitions) {\n      if (def.options) {\n        for (const opt of def.options) {\n          optionIdToLabel[opt.id] = opt.label;\n        }\n      }\n    }\n\n    const processChoiceArray = (choiceArray) => {\n      if (!Array.isArray(choiceArray)) return;\n      for (const choice of choiceArray) {\n        const label = choice.label?.toLowerCase() || \"\";\n        if (label.includes(\"tool\") || label.includes(\"gaming\") || label.includes(\"instrument\")) {\n          if (choice.optionValue && optionIdToLabel[choice.optionValue]) {\n            toolNames.push(optionIdToLabel[choice.optionValue]);\n          }\n        }\n      }\n    };\n\n    processChoiceArray(choices.background);\n    processChoiceArray(choices.class);\n    processChoiceArray(choices.race);\n    processChoiceArray(choices.feat);\n\n    if (toolNames.length > 0) {\n      LogUtil.log(\"DnDBCharacterTransformer: Found tool choices\", toolNames);\n    }\n\n    return toolNames;\n  }\n\n  /**\n   * Transform tool proficiencies to Foundry format for actor.system.tools\n   * Combines modifiers-based tools and choice-based tools\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {Object} Foundry tools object keyed by tool ID\n   */\n  static transformTools(ddbCharacter) {\n    const tools = {};\n    const toolNameMap = this._buildToolNameToKeyMap();\n    const modifierTools = this.getToolProficiencies(ddbCharacter);\n    const choiceTools = this._extractToolChoices(ddbCharacter);\n\n    for (const modTool of modifierTools) {\n      const toolName = modTool.name.toLowerCase();\n      const foundryKey = toolNameMap[toolName];\n      if (foundryKey && !tools[foundryKey]) {\n        tools[foundryKey] = { value: 1 };\n      }\n    }\n\n    for (const choiceToolName of choiceTools) {\n      const toolName = choiceToolName.toLowerCase();\n      const foundryKey = toolNameMap[toolName];\n      if (foundryKey && !tools[foundryKey]) {\n        tools[foundryKey] = { value: 1 };\n      }\n    }\n\n    if (Object.keys(tools).length > 0) {\n      LogUtil.log(\"DnDBCharacterTransformer: Tools transformed\", [\n        Object.keys(tools).join(\", \")\n      ]);\n    }\n\n    return tools;\n  }\n}\n","export const DDB_SOURCE_BOOKS = [\n  {\n    id: 100,\n    order: 8,\n    label: \"Unearthed Arcana\",\n    subLabel: \"\",\n    slug: \"ua\",\n    relativePath: \"sources/dnd/ua\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/29461/179/638010276214549263.jpeg\",\n    type: 1,\n    releaseDate: \"2022-08-18T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n    prioritize: false\n  },\n  {\n    id: 148,\n    order: 9,\n    label: \"D&D Beyond Basic Rules\",\n    subLabel: \"\",\n    slug: \"br-2024\",\n    relativePath: \"sources/dnd/br-2024\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/43764/971/638599907624251366.jpeg\",\n    type: 1,\n    releaseDate: \"2024-09-03T13:12:00Z\",\n    isReleased: true,\n    isFree: true,\n    isThirdParty: false\n  },\n  {\n    id: 145,\n    order: 10,\n    label: \"Players Handbook\",\n    subLabel: \"\",\n    slug: \"phb-2024\",\n    relativePath: \"sources/dnd/phb-2024\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/41956/71/638520961161219818.jpeg\",\n    type: 1,\n    releaseDate: \"2024-09-17T13:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n    prioritize: true\n  },\n  {\n    id: 146,\n    order: 11,\n    label: \"Dungeon Masters Guide\",\n    subLabel: \"\",\n    slug: \"dmg-2024\",\n    relativePath: \"sources/dnd/dmg-2024\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/41956/44/638520960647339792.jpeg\",\n    type: 1,\n    releaseDate: \"2024-10-29T14:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n    prioritize: true\n  },\n  {\n    id: 147,\n    order: 12,\n    label: \"Monster Manual\",\n    subLabel: \"\",\n    slug: \"mm-2024\",\n    relativePath: \"sources/dnd/mm-2024\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/41956/56/638520960908919838.jpeg\",\n    type: 1,\n    releaseDate: \"2025-02-04T13:45:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n    prioritize: true\n  },\n  {\n    id: 166,\n    order: 13,\n    label: \"Sage Advice & Errata\",\n    subLabel: \"\",\n    slug: \"sae\",\n    relativePath: \"sources/dnd/sae\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/48408/464/638794027038919813.jpeg\",\n    type: 1,\n    releaseDate: \"2025-04-30T16:45:00Z\",\n    isReleased: true,\n    isFree: true,\n    isThirdParty: false,\n    prioritize: false\n  },\n  {\n    id: 110,\n    order: 21,\n    label: \"Bigby Presents: Glory of the Giants\",\n    subLabel: \"\",\n    slug: \"gotg\",\n    relativePath: \"sources/dnd/gotg\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/33889/812/638179362854797417.jpeg\",\n    type: 1,\n    releaseDate: \"2023-08-01T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 191,\n    order: 22,\n    label: \"Eberron: Forge of the Artificer\",\n    subLabel: \"\",\n    slug: \"efota\",\n    relativePath: \"sources/dnd/efota\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/52984/276/638995468447060854.jpeg\",\n    type: 1,\n    releaseDate: \"2025-11-25T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false\n  },\n  {\n    id: 49,\n    order: 37,\n    label: \"Eberron: Rising from the Last War\",\n    subLabel: \"\",\n    slug: \"erftlw\",\n    relativePath: \"sources/dnd/erftlw\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/7745/229/637093481879972578.jpeg\",\n    type: 1,\n    releaseDate: \"2019-11-19T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 81,\n    order: 43,\n    label: \"Fizban's Treasury of Dragons\",\n    subLabel: \"\",\n    slug: \"ftod\",\n    relativePath: \"sources/dnd/ftod\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/19075/984/637620380257973999.jpeg\",\n    type: 1,\n    releaseDate: \"2021-10-26T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 205,\n    order: 44,\n    label: \"Forgotten Realms: Heroes of Faern\",\n    subLabel: \"New!\",\n    slug: \"frhof\",\n    relativePath: \"sources/dnd/frhof\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/52402/286/638971147782879883.jpeg\",\n    type: 1,\n    releaseDate: \"2025-10-28T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false\n  },\n  {\n    id: 85,\n    order: 57,\n    label: \"Mordenkainen Presents: Monsters of the Multiverse\",\n    subLabel: \"\",\n    slug: \"motm\",\n    relativePath: \"sources/dnd/motm\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/22937/355/637776964750870725.jpeg\",\n    type: 1,\n    releaseDate: \"2022-05-16T10:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 114,\n    order: 62,\n    label: \"Planescape: Adventures in the Multiverse\",\n    subLabel: \"\",\n    slug: \"paitm\",\n    relativePath: \"sources/dnd/paitm\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/33644/786/638170881549586932.jpeg\",\n    type: 1,\n    releaseDate: \"2023-10-03T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 90,\n    order: 63,\n    label: \"Spelljammer: Adventures in Space\",\n    subLabel: \"\",\n    slug: \"sais\",\n    relativePath: \"sources/dnd/sais\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/25228/877/637859890825757803.jpeg\",\n    type: 1,\n    releaseDate: \"2022-08-16T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 67,\n    order: 67,\n    label: \"Tashas Cauldron of Everything\",\n    subLabel: \"\",\n    slug: \"tcoe\",\n    relativePath: \"sources/dnd/tcoe\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/13526/337/637394093261962736.jpeg\",\n    type: 1,\n    releaseDate: \"2020-11-17T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 109,\n    order: 68,\n    label: \"The Book of Many Things\",\n    subLabel: \"\",\n    slug: \"tbomt\",\n    relativePath: \"sources/dnd/tbomt\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/34541/96/638205353418103417.jpeg\",\n    type: 1,\n    releaseDate: \"2023-10-31T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 27,\n    order: 78,\n    label: \"Xanathar's Guide to Everything\",\n    subLabel: \"\",\n    slug: \"xgte\",\n    relativePath: \"sources/dnd/xgte\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/10346/306/637244369065271336.jpeg\",\n    type: 1,\n    releaseDate: \"2017-11-15T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 217,\n    order: 1,\n    label: \"Astarion's Book of Hungers\",\n    subLabel: \"\",\n    slug: \"aboh\",\n    relativePath: \"sources/dnd/aboh\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/52637/494/638981487854541579.jpeg\",\n    type: 2,\n    releaseDate: \"2025-11-11T07:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 48,\n    order: 4,\n    label: \"Baldurs Gate: Descent into Avernus\",\n    subLabel: \"\",\n    slug: \"bgdia\",\n    relativePath: \"sources/dnd/bgdia\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/7745/257/637093484650833588.jpeg\",\n    type: 2,\n    releaseDate: \"2019-09-17T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 83,\n    order: 7,\n    label: \"Critical Role: Call of the Netherdeep\",\n    subLabel: \"\",\n    slug: \"cotn\",\n    relativePath: \"sources/dnd/cotn\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/20906/944/637695655262762818.jpeg\",\n    type: 2,\n    releaseDate: \"2022-03-15T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 6,\n    order: 8,\n    label: \"Curse of Strahd\",\n    subLabel: \"\",\n    slug: \"cos\",\n    relativePath: \"sources/dnd/cos\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/10346/347/637244372481971363.jpeg\",\n    type: 2,\n    releaseDate: \"2016-03-15T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 163,\n    order: 9,\n    label: \"Dragon Delves\",\n    subLabel: \"\",\n    slug: \"drde\",\n    relativePath: \"sources/dnd/drde\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/49845/429/638857756428432417.jpeg\",\n    type: 2,\n    releaseDate: \"2025-06-24T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 95,\n    order: 12,\n    label: \"Dragonlance: Shadow of the Dragon Queen\",\n    subLabel: \"\",\n    slug: \"sotdq\",\n    relativePath: \"sources/dnd/sotdq\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/27777/667/637951679603767773.jpeg\",\n    type: 2,\n    releaseDate: \"2022-11-22T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 222,\n    order: 18,\n    label: \"Fated Flight of the Recluse\",\n    subLabel: \"\",\n    slug: \"ffotr\",\n    relativePath: \"sources/dnd/ffotr\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/53004/853/638996385600844893.jpeg\",\n    type: 2,\n    releaseDate: \"2025-11-25T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 206,\n    order: 19,\n    label: \"Forgotten Realms: Adventures in Faern\",\n    subLabel: \"New!\",\n    slug: \"fraif\",\n    relativePath: \"sources/dnd/fraif\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/52402/308/638971148265450077.jpeg\",\n    type: 2,\n    releaseDate: \"2025-10-28T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 43,\n    order: 20,\n    label: \"Ghosts of Saltmarsh\",\n    subLabel: \"\",\n    slug: \"gos\",\n    relativePath: \"sources/dnd/gos\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/10347/264/637244456880438089.jpeg\",\n    type: 2,\n    releaseDate: \"2019-05-21T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 199,\n    order: 22,\n    label: \"Heroes of the Borderlands\",\n    subLabel: \"\",\n    slug: \"hotb\",\n    relativePath: \"sources/dnd/hotb\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/51322/303/638924470224291152.jpeg\",\n    type: 2,\n    releaseDate: \"2025-09-16T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 66,\n    order: 26,\n    label: \"Icewind Dale: Rime of the Frostmaiden\",\n    subLabel: \"\",\n    slug: \"idrotf\",\n    relativePath: \"sources/dnd/idrotf\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/11095/612/637278970090981939.jpeg\",\n    type: 2,\n    releaseDate: \"2020-09-15T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 87,\n    order: 28,\n    label: \"Journeys through the Radiant Citadel\",\n    subLabel: \"\",\n    slug: \"jttrc\",\n    relativePath: \"sources/dnd/jttrc\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/24454/512/637830510511365404.jpeg\",\n    type: 2,\n    releaseDate: \"2022-07-19T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 103,\n    order: 29,\n    label: \"Keys from the Golden Vault\",\n    subLabel: \"\",\n    slug: \"kftgv\",\n    relativePath: \"sources/dnd/kftgv\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/31000/596/638070671794669885.jpeg\",\n    type: 2,\n    releaseDate: \"2023-02-07T14:45:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 223,\n    order: 37,\n    label: \"One-Shot Wonders: Holiday Adventure Pack\",\n    subLabel: \"Roll & Play Press\",\n    slug: \"oswhap\",\n    relativePath: \"sources/dnd/oswhap\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/53150/57/639002890479436109.jpeg\",\n    type: 2,\n    releaseDate: \"2025-12-03T13:45:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: true,\n  },\n  {\n    id: 113,\n    order: 39,\n    label: \"Phandelver and Below: The Shattered Obelisk\",\n    subLabel: \"\",\n    slug: \"pbtso\",\n    relativePath: \"sources/dnd/pbtso\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/33178/258/638154350835162270.jpeg\",\n    type: 2,\n    releaseDate: \"2023-09-05T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 12,\n    order: 47,\n    label: \"Storm King's Thunder\",\n    subLabel: \"\",\n    slug: \"skt\",\n    relativePath: \"sources/dnd/skt\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/10347/307/637244460981849379.jpeg\",\n    type: 2,\n    releaseDate: \"2016-09-06T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 203,\n    order: 48,\n    label: \"Stranger Things: Welcome to the Hellfire Club\",\n    subLabel: \"\",\n    slug: \"wthc\",\n    relativePath: \"sources/dnd/wthc\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/52003/638/638954445979470424.jpeg\",\n    type: 2,\n    releaseDate: \"2025-10-07T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 14,\n    order: 50,\n    label: \"Tales from the Yawning Portal\",\n    subLabel: \"\",\n    slug: \"tftyp\",\n    relativePath: \"sources/dnd/tftyp\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/10347/315/637244461501105683.jpeg\",\n    type: 2,\n    releaseDate: \"2017-03-24T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 79,\n    order: 60,\n    label: \"The Wild Beyond the Witchlight\",\n    subLabel: \"\",\n    slug: \"twbtw\",\n    relativePath: \"sources/dnd/twbtw\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/18120/587/637583471235980161.jpeg\",\n    type: 2,\n    releaseDate: \"2021-09-21T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 25,\n    order: 61,\n    label: \"Tomb of Annihilation\",\n    subLabel: \"\",\n    slug: \"toa\",\n    relativePath: \"sources/dnd/toa\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/10347/322/637244461998912169.jpeg\",\n    type: 2,\n    releaseDate: \"2017-09-08T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 132,\n    order: 65,\n    label: \"Vecna: Eve of Ruin\",\n    subLabel: \"\",\n    slug: \"veor\",\n    relativePath: \"sources/dnd/veor\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/39768/809/638427681491023112.jpeg\",\n    type: 2,\n    releaseDate: \"2024-05-07T13:40:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n  {\n    id: 35,\n    order: 69,\n    label: \"Waterdeep: Dragon Heist\",\n    subLabel: \"\",\n    slug: \"wdh\",\n    relativePath: \"sources/dnd/wdh\",\n    imageUrl:\n      \"https://www.dndbeyond.com/avatars/10347/339/637244462815499464.jpeg\",\n    type: 2,\n    releaseDate: \"2018-09-07T00:00:00Z\",\n    isReleased: true,\n    isFree: false,\n    isThirdParty: false,\n  },\n];\n","import { LogUtil } from \"../../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../../utils/SettingsUtil.mjs\";\nimport { getSettings } from \"../../../constants/Settings.mjs\";\nimport { DnDBCharacterTransformer } from \"./DnDBCharacterTransformer.mjs\";\nimport { DDB_SOURCE_BOOKS } from \"../../../constants/DnDBeyond.mjs\";\n\n/**\n * DDB filter type to Foundry item type mapping\n */\nconst DDB_TO_FOUNDRY_TYPE = {\n  Weapon: \"weapon\",\n  Armor: \"equipment\",\n  Shield: \"equipment\",\n  \"Wondrous item\": \"equipment\",\n  \"Wondrous Item\": \"equipment\",\n  Ring: \"equipment\",\n  Rod: \"equipment\",\n  Staff: \"equipment\",\n  Wand: \"equipment\",\n  \"Adventuring Gear\": \"equipment\",\n  \"Other Gear\": \"equipment\",\n  Gear: \"equipment\",\n  Tool: \"tool\",\n  Potion: \"consumable\",\n  Scroll: \"consumable\",\n  Ammunition: \"consumable\",\n  spell: \"spell\",\n  Feat: \"feat\",\n  \"Class Feature\": \"feat\",\n  \"class-feature\": \"feat\",\n  \"Racial Trait\": \"feat\",\n  Background: \"background\",\n  Race: \"race\",\n  Class: \"class\",\n  Subclass: \"subclass\"\n};\n\n/**\n * Equipment-related Foundry types that should match flexibly\n * When searching for equipment, also check consumable/tool and vice versa\n */\nconst EQUIPMENT_TYPE_VARIANTS = [\"equipment\", \"consumable\", \"tool\", \"loot\"];\n\n/**\n * Handles compendium searching and matching for DDB character import\n * Uses dual-matching strategy: DDB Importer flags first, then name matching\n */\nexport class DnDBCompendiumMatcher {\n  static _indices = null;\n  static _indexBuildPromise = null;\n\n  /**\n   * Build and cache indices for all visible Item compendiums\n   * Includes DDB Importer flags for priority matching\n   * @returns {Promise<void>}\n   */\n  static async buildIndex() {\n    if (this._indexBuildPromise) {\n      return this._indexBuildPromise;\n    }\n\n    this._indexBuildPromise = this._buildIndexInternal();\n    return this._indexBuildPromise;\n  }\n\n  /**\n   * Internal index building implementation\n   * @returns {Promise<void>}\n   * @private\n   */\n  static async _buildIndexInternal() {\n    LogUtil.log(\"DnDBCompendiumMatcher: Building compendium indices\");\n    const startTime = performance.now();\n\n    this._indices = new Map();\n\n    for (const pack of game.packs) {\n      if (pack.documentName !== \"Item\" || !pack.visible) continue;\n\n      try {\n        const index = await pack.getIndex({\n          fields: [\"name\", \"type\", \"flags.ddbimporter.definitionId\", \"system.source.book\", \"system.source.rules\", \"system.type.value\", \"system.identifier\", \"system.classIdentifier\", \"system.requirements\"]\n        });\n\n        this._indices.set(pack.collection, {\n          pack,\n          index,\n          entries: Array.from(index.values())\n        });\n      } catch (error) {\n        LogUtil.warn(\"DnDBCompendiumMatcher: Failed to index pack\", [pack.collection, error.message]);\n      }\n    }\n\n    const elapsed = performance.now() - startTime;\n    LogUtil.log(\"DnDBCompendiumMatcher: Index built\", [\n      `${this._indices.size} packs`,\n      `${elapsed.toFixed(0)}ms`\n    ]);\n  }\n\n  /**\n   * Clear cached indices\n   */\n  static clearCache() {\n    this._indices = null;\n    this._indexBuildPromise = null;\n  }\n\n  /**\n   * Normalize item name for fuzzy matching\n   * @param {string} name - Item name to normalize\n   * @returns {string} Normalized name\n   * @private\n   */\n  static _normalizeName(name) {\n    if (!name) return \"\";\n    return name\n      .toLowerCase()\n      .replace(/[,()'\"]/g, \" \")\n      .replace(/\\s+/g, \" \")\n      .trim();\n  }\n\n  /**\n   * Map DDB item type to Foundry item type\n   * @param {Object} ddbItem - DDB item object\n   * @returns {string|null} Foundry item type or null\n   * @private\n   */\n  static _mapDDBType(ddbItem) {\n    const filterType = ddbItem.definition?.filterType || ddbItem.filterType;\n    const defType = ddbItem.definition?.type;\n    const directType = ddbItem.type;\n\n    if (filterType && DDB_TO_FOUNDRY_TYPE[filterType]) {\n      return DDB_TO_FOUNDRY_TYPE[filterType];\n    }\n    if (directType && typeof directType === \"string\" && DDB_TO_FOUNDRY_TYPE[directType]) {\n      return DDB_TO_FOUNDRY_TYPE[directType];\n    }\n    if (defType && typeof defType === \"string\" && DDB_TO_FOUNDRY_TYPE[defType]) {\n      return DDB_TO_FOUNDRY_TYPE[defType];\n    }\n    return null;\n  }\n\n  /**\n   * Find a matching compendium item for a DDB item\n   * Priority: DDB Importer definitionId > normalized name match\n   * @param {Object} ddbItem - DDB item object with definition and/or direct properties\n   * @returns {Promise<MatchResult|null>} Match result or null if not found\n   */\n  static async findMatch(ddbItem) {\n    const allMatches = await this.findAllMatches(ddbItem);\n    return allMatches.length > 0 ? allMatches[0] : null;\n  }\n\n  /**\n   * Build Set of DDB source IDs that indicate 2024 rules content\n   * Derived from DDB_SOURCE_BOOKS by checking slug for \"2024\" pattern\n   * @returns {Set<number>}\n   * @private\n   */\n  static get DDB_2024_SOURCE_IDS() {\n    if (!this._ddb2024SourceIds) {\n      this._ddb2024SourceIds = new Set(\n        DDB_SOURCE_BOOKS\n          .filter(book => book.slug?.includes(\"2024\"))\n          .map(book => book.id)\n      );\n    }\n    return this._ddb2024SourceIds;\n  }\n\n  /**\n   * Detect rules version from DDB character data\n   * Checks class sources to determine if character uses 2024 or 2014 rules\n   * @param {Object} ddbCharacter - DDB character data\n   * @returns {number} Priority mode: 1 for 2024 rules, 2 for 2014 rules\n   * @private\n   */\n  static _detectRulesVersion(ddbCharacter) {\n    if (!Array.isArray(ddbCharacter.classes)) return 1;\n\n    for (const cls of ddbCharacter.classes) {\n      const sources = cls.definition?.sources || [];\n      for (const source of sources) {\n        if (this.DDB_2024_SOURCE_IDS.has(source.sourceId)) {\n          const bookInfo = DDB_SOURCE_BOOKS.find(b => b.id === source.sourceId);\n          LogUtil.log(\"DnDBCompendiumMatcher: Detected 2024 rules\", [\n            cls.definition?.name,\n            bookInfo?.label || `sourceId: ${source.sourceId}`\n          ]);\n          return 1;\n        }\n      }\n    }\n\n    LogUtil.log(\"DnDBCompendiumMatcher: Detected 2014 rules (no 2024 source found)\");\n    return 2;\n  }\n\n  /**\n   * Find ALL matching compendium items for a DDB item across all sources\n   * @param {Object} ddbItem - DDB item object with definition and/or direct properties\n   * @param {number|null} priorityOverride - Optional priority mode to use instead of setting\n   * @returns {Promise<Array<MatchResult>>} All matching results sorted by priority\n   */\n  static async findAllMatches(ddbItem, priorityOverride = null) {\n    if (!this._indices) {\n      await this.buildIndex();\n    }\n\n    const ddbDefinitionId = ddbItem.definition?.id || ddbItem.id;\n    const name = ddbItem.definition?.name || ddbItem.name;\n    const foundryType = this._mapDDBType(ddbItem);\n    const className = ddbItem._className?.toLowerCase();\n    const raceName = ddbItem._raceName?.toLowerCase();\n\n    if (!name) {\n      return [];\n    }\n\n    const matches = [];\n\n    const ddbIdMatches = this._findAllByDDBId(ddbDefinitionId, name, className, raceName);\n    matches.push(...ddbIdMatches);\n\n    const nameMatches = this._findAllByName(name, foundryType, false, className, raceName);\n    for (const nameMatch of nameMatches) {\n      const isDuplicate = matches.some(m => m.uuid === nameMatch.uuid);\n      if (!isDuplicate) {\n        matches.push(nameMatch);\n      }\n    }\n\n    if (ddbItem._isChoiceOption && ddbItem._parentFeatureName && matches.length === 0) {\n      const prefixedVariants = this._getChoiceNameVariants(name, ddbItem._parentFeatureName);\n      for (const variant of prefixedVariants) {\n        const variantMatches = this._findAllByName(variant, foundryType);\n        for (const variantMatch of variantMatches) {\n          const isDuplicate = matches.some(m => m.uuid === variantMatch.uuid);\n          if (!isDuplicate) {\n            matches.push(variantMatch);\n          }\n        }\n      }\n    }\n\n    if (ddbItem.type === \"Race\") {\n      const wordMatches = this._findAllByName(name, foundryType, true);\n      for (const wordMatch of wordMatches) {\n        const isDuplicate = matches.some(m => m.uuid === wordMatch.uuid);\n        if (!isDuplicate) {\n          matches.push(wordMatch);\n        }\n      }\n\n      if (ddbItem._searchVariants) {\n        for (const variant of ddbItem._searchVariants) {\n          if (variant === name) continue;\n          const variantMatches = this._findAllByName(variant, foundryType);\n          for (const variantMatch of variantMatches) {\n            const isDuplicate = matches.some(m => m.uuid === variantMatch.uuid);\n            if (!isDuplicate) {\n              matches.push(variantMatch);\n            }\n          }\n        }\n      }\n    }\n\n    let priorityMode = priorityOverride;\n    if (priorityMode === null) {\n      const SETTINGS = getSettings();\n      priorityMode = SettingsUtil.get(SETTINGS.ddbImportSourcePriority.tag) ?? 0;\n    }\n    matches.sort((a, b) => this._compareMatches(a, b, priorityMode));\n\n    if (matches.length > 0) {\n      LogUtil.log(\"DnDBCompendiumMatcher: Found matches\", [name, `${matches.length} sources`]);\n    }\n\n    return matches;\n  }\n\n  /**\n   * Known source priorities (lower = higher priority)\n   * Official 2024 content > DDB Importer > Official 2014 content > SRD > Other\n   * @private\n   */\n  static SOURCE_PRIORITIES = {\n    \"dnd-2024-players-handbook\": 10,\n    \"dnd-players-handbook-2024\": 10,\n    \"dnd-2024-dungeon-masters-guide\": 11,\n    \"ddb-importer\": 20,\n    \"dnd5e-complete-pack\": 25,\n    \"dnd-players-handbook\": 30,\n    \"dnd-dungeon-masters-guide\": 31,\n    \"dnd5e\": 50\n  };\n\n  /**\n   * Pack label patterns to exclude from character imports (monster-specific content)\n   * @private\n   */\n  static EXCLUDED_PACK_PATTERNS = [\n    /monster/i,\n    /creatures/i,\n    /bestiary/i,\n    /npc/i\n  ];\n\n  /**\n   * Check if a pack should be excluded from character import matching\n   * @param {string} packLabel - Compendium pack label\n   * @param {string} packageName - Source package name\n   * @returns {boolean} True if pack should be excluded\n   * @private\n   */\n  static _isExcludedPack(packLabel, packageName) {\n    if (packageName.includes(\"monster-manual\")) return true;\n    return this.EXCLUDED_PACK_PATTERNS.some(pattern => pattern.test(packLabel));\n  }\n\n  /**\n   * Get source info including version\n   * @param {string} packageName - Source package name\n   * @returns {Object} Source info\n   * @private\n   */\n  static _getSourceInfo(packageName) {\n    const pkg = game.modules.get(packageName) || game.system;\n    const version = pkg?.version || \"0.0.0\";\n\n    return {\n      packageName,\n      version,\n      title: pkg?.title || packageName\n    };\n  }\n\n  /**\n   * Short abbreviations for known source packages\n   * @private\n   */\n  static SOURCE_ABBREVIATIONS = {\n    \"dnd5e\": \"SRD\",\n    \"ddb-importer\": \"DDB\",\n    \"dnd-2024-players-handbook\": \"PHB\",\n    \"dnd-players-handbook-2024\": \"PHB\",\n    \"dnd-2024-dungeon-masters-guide\": \"DMG\",\n    \"dnd-players-handbook\": \"PHB\",\n    \"dnd-dungeon-masters-guide\": \"DMG\",\n    \"dnd-monster-manual\": \"MM\",\n    \"dnd5e-complete-pack\": \"Complete\"\n  };\n\n  /**\n   * Get abbreviated source name for display\n   * Creates acronym from module title (first letter of each word)\n   * @param {string} packageName - Source package name\n   * @returns {string} Short display name\n   * @private\n   */\n  static _getSourceAbbreviation(packageName) {\n    if (this.SOURCE_ABBREVIATIONS[packageName]) {\n      return this.SOURCE_ABBREVIATIONS[packageName];\n    }\n    const pkg = game.modules.get(packageName);\n    if (pkg?.title) {\n      const words = pkg.title.split(/\\s+/).filter(w => w.length > 0);\n      const acronym = words.map(w => w[0].toUpperCase()).join(\"\");\n      return acronym || \"World\";\n    }\n    return \"World\";\n  }\n\n  /**\n   * Create display label for a compendium match\n   * Shows compendium label with item's source book\n   * @param {string} packLabel - Compendium pack label\n   * @param {string} packageName - Source package name\n   * @param {string} [sourceBook] - Item's source book (e.g., \"PHB 2024\", \"SRD 5.1\")\n   * @param {string} [sourceRules] - Item's rules version (e.g., \"2024\", \"2014\")\n   * @returns {string} Display label for dropdown\n   * @private\n   */\n  static _createDisplayLabel(packLabel, packageName, sourceBook, sourceRules) {\n    if (sourceBook) {\n      return `${packLabel} (${sourceBook})`;\n    }\n    const sourceAbbrev = this._getSourceAbbreviation(packageName);\n    const labelLower = packLabel.toLowerCase();\n    const alreadyHasSource = labelLower.includes(\"(srd)\") || labelLower.includes(\"(phb)\") || labelLower.includes(\"(dmg)\");\n    if (sourceRules === \"2024\") {\n      if (alreadyHasSource) {\n        return packLabel.replace(/\\(SRD\\)/i, \"(SRD 2024)\").replace(/\\(PHB\\)/i, \"(PHB 2024)\").replace(/\\(DMG\\)/i, \"(DMG 2024)\");\n      }\n      return `${packLabel} (${sourceAbbrev} 2024)`;\n    }\n    if (alreadyHasSource) {\n      return packLabel;\n    }\n    return `${packLabel} (${sourceAbbrev})`;\n  }\n\n  /**\n   * Get source priority (lower = higher priority)\n   * @param {string} source - Source package name\n   * @returns {number} Priority value\n   * @private\n   */\n  static _getSourcePriority(source) {\n    return this.SOURCE_PRIORITIES[source] ?? 99;\n  }\n\n  /**\n   * Foundry package names that contain 2024 rules content\n   * @private\n   */\n  static PACKAGES_2024 = new Set([\n    \"dnd-2024-players-handbook\",\n    \"dnd-players-handbook-2024\",\n    \"dnd-2024-dungeon-masters-guide\",\n    \"dnd-2024-monster-manual\"\n  ]);\n\n  /**\n   * Foundry package names that contain 2014 rules content\n   * Note: dnd-players-handbook, dnd-dungeon-masters-guide, dnd-monster-manual are NOT included\n   * because Foundry reused these IDs for the 2024 premium modules. We rely on system.source.rules instead.\n   * @private\n   */\n  static PACKAGES_2014 = new Set([\n    \"dnd5e\"\n  ]);\n\n  /**\n   * Get rules version priority (lower = higher priority)\n   * @param {string} rules - Rules version string (e.g., \"2024\", \"2014\")\n   * @param {string} sourceBook - Source book name (e.g., \"PHB 2024\", \"SRD 5.1\")\n   * @param {string} packageName - Source package name (e.g., \"dnd5e\", \"dnd-2024-players-handbook\")\n   * @param {number} priorityMode - 1=prefer 2024, 2=prefer 2014, 3=closest match\n   * @returns {number} Priority value\n   * @private\n   */\n  static _getRulesPriority(rules, sourceBook, packageName, priorityMode = 1) {\n    const is2024 = rules === \"2024\" || this.PACKAGES_2024.has(packageName) || packageName?.includes(\"2024\");\n    const is2014 = rules === \"2014\" || this.PACKAGES_2014.has(packageName);\n\n    if (priorityMode === 1) {\n      if (is2024) return 10;\n      if (is2014) return 30;\n      return 50;\n    }\n    if (priorityMode === 2) {\n      if (is2014) return 10;\n      if (is2024) return 30;\n      return 50;\n    }\n    return 50;\n  }\n\n  /**\n   * Compare two matches for sorting based on priority setting\n   * @param {MatchResult} a - First match\n   * @param {MatchResult} b - Second match\n   * @param {number} priorityMode - 1=prefer 2024, 2=prefer 2014, 3=closest match (DDB ID first)\n   * @returns {number} Sort comparison result\n   * @private\n   */\n  static _compareMatches(a, b, priorityMode) {\n    const reqScoreA = a.requirementScore ?? 100;\n    const reqScoreB = b.requirementScore ?? 100;\n    if (reqScoreA !== reqScoreB) {\n      return reqScoreB - reqScoreA;\n    }\n\n    if (priorityMode === 3) {\n      if (a.matchType === \"ddbId\" && b.matchType !== \"ddbId\") return -1;\n      if (a.matchType !== \"ddbId\" && b.matchType === \"ddbId\") return 1;\n      const rulesPriorityA = this._getRulesPriority(a.sourceRules, a.sourceBook, a.source, 1);\n      const rulesPriorityB = this._getRulesPriority(b.sourceRules, b.sourceBook, b.source, 1);\n      if (rulesPriorityA !== rulesPriorityB) {\n        return rulesPriorityA - rulesPriorityB;\n      }\n      return this._getSourcePriority(a.source) - this._getSourcePriority(b.source);\n    }\n\n    const rulesPriorityA = this._getRulesPriority(a.sourceRules, a.sourceBook, a.source, priorityMode);\n    const rulesPriorityB = this._getRulesPriority(b.sourceRules, b.sourceBook, b.source, priorityMode);\n    if (rulesPriorityA !== rulesPriorityB) {\n      return rulesPriorityA - rulesPriorityB;\n    }\n    if (a.matchType === \"ddbId\" && b.matchType !== \"ddbId\") return -1;\n    if (a.matchType !== \"ddbId\" && b.matchType === \"ddbId\") return 1;\n    return this._getSourcePriority(a.source) - this._getSourcePriority(b.source);\n  }\n\n  /**\n   * Find ALL items by DDB Importer definition ID across all packs\n   * @param {number|string} definitionId - DDB definition ID\n   * @param {string} expectedName - Expected item name for validation\n   * @param {string|null} className - Optional class name to filter class features\n   * @param {string|null} raceName - Optional race name to filter racial traits\n   * @returns {Array<MatchResult>}\n   * @private\n   */\n  static _findAllByDDBId(definitionId, expectedName, className = null, raceName = null) {\n    if (!definitionId) return [];\n\n    const numericId = Number(definitionId);\n    if (isNaN(numericId)) return [];\n\n    const matches = [];\n    const seenSources = new Set();\n    const normalizedExpected = this._normalizeName(expectedName);\n\n    for (const [packId, { pack, entries }] of this._indices) {\n      const source = pack.metadata.packageName;\n      if (this._isExcludedPack(pack.metadata.label, source)) continue;\n\n      for (const entry of entries) {\n        const entryDDBId = entry.flags?.ddbimporter?.definitionId;\n        if (entryDDBId === numericId) {\n          const normalizedEntry = this._normalizeName(entry.name);\n          const entryWithoutLegacy = normalizedEntry.replace(/\\s*\\(?\\s*legacy\\s*\\)?\\s*/g, \"\").trim();\n\n          if (normalizedEntry === normalizedExpected || entryWithoutLegacy === normalizedExpected) {\n            const requirementScore = this._getRequirementScore(entry, className, raceName);\n            if (requirementScore === 0) {\n              continue;\n            }\n\n            const sourceBook = entry.system?.source?.book || \"\";\n            const sourceRules = entry.system?.source?.rules || \"\";\n            const dedupeKey = `${source}::${sourceBook}::${sourceRules}`;\n            if (seenSources.has(dedupeKey)) continue;\n\n            const sourceInfo = this._getSourceInfo(source);\n            matches.push({\n              uuid: entry.uuid,\n              name: entry.name,\n              type: entry.type,\n              packId,\n              source,\n              sourceLabel: pack.metadata.label,\n              sourceVersion: sourceInfo.version,\n              sourceTitle: sourceInfo.title,\n              sourceBook,\n              sourceRules,\n              displayLabel: this._createDisplayLabel(pack.metadata.label, source, sourceBook, sourceRules),\n              matchType: \"ddbId\",\n              requirementScore\n            });\n            seenSources.add(dedupeKey);\n          } else {\n            LogUtil.warn(\"DnDBCompendiumMatcher: DDB ID collision\", [\n              `ID ${numericId}:`,\n              `\"${expectedName}\" vs compendium \"${entry.name}\"`\n            ]);\n          }\n        }\n      }\n    }\n    return matches;\n  }\n\n  /**\n   * Calculate a match score for class/race requirements (higher = better match)\n   * @param {Object} entry - Compendium index entry\n   * @param {string|null} className - Required class name (lowercase)\n   * @param {string|null} raceName - Required race name (lowercase)\n   * @returns {number} Match score: 100 = exact match, 50 = no identifier, 0 = wrong class/race\n   * @private\n   */\n  static _getRequirementScore(entry, className, raceName) {\n    if (entry.type !== \"feat\") return 100;\n\n    const entryType = entry.system?.type?.value;\n    const entryClassId = (entry.system?.identifier || entry.system?.classIdentifier || \"\").toLowerCase();\n    const entryRequirements = (entry.system?.requirements || \"\").toLowerCase();\n\n    if (className && entryType === \"class\") {\n      if (entryRequirements && entryRequirements.includes(className)) return 100;\n      if (entryClassId && entryClassId === className) return 100;\n      if (entryRequirements) {\n        const otherClasses = [\"barbarian\", \"bard\", \"cleric\", \"druid\", \"fighter\", \"monk\", \"paladin\", \"ranger\", \"rogue\", \"sorcerer\", \"warlock\", \"wizard\"];\n        const hasOtherClass = otherClasses.some(c => c !== className && entryRequirements.includes(c));\n        if (hasOtherClass) return 0;\n      }\n      if (!entryClassId && !entryRequirements) return 50;\n      return 50;\n    }\n\n    if (raceName && entryType === \"race\") {\n      if (entryRequirements && entryRequirements.includes(raceName)) return 100;\n      if (entryClassId && entryClassId.includes(raceName)) return 100;\n      if (!entryClassId && !entryRequirements) return 50;\n      return 0;\n    }\n\n    return 100;\n  }\n\n  /**\n   * Find ALL items by normalized name match across all packs\n   * Only matches exact names - no partial/fuzzy matching to avoid wrong matches\n   * @param {string} name - Item name to search for\n   * @param {string|null} type - Optional Foundry item type to filter by\n   * @param {boolean} useWordMatch - Use word-based matching for races\n   * @param {string|null} className - Optional class name to filter class features\n   * @param {string|null} raceName - Optional race name to filter racial traits\n   * @returns {Array<MatchResult>}\n   * @private\n   */\n  static _findAllByName(name, type, useWordMatch = false, className = null, raceName = null) {\n    const normalizedSearch = this._normalizeName(name);\n    if (!normalizedSearch) return [];\n\n    const searchWords = normalizedSearch.split(/\\s+/).filter(w => w.length > 0);\n    const matches = [];\n    const seenSources = new Set();\n    const typeVariants = this._getTypeVariants(type);\n\n    for (const [packId, { pack, entries }] of this._indices) {\n      const source = pack.metadata.packageName;\n      if (this._isExcludedPack(pack.metadata.label, source)) continue;\n\n      for (const entry of entries) {\n        if (type && !typeVariants.includes(entry.type)) continue;\n\n        const normalizedEntry = this._normalizeName(entry.name);\n        const entryWithoutLegacy = normalizedEntry.replace(/\\s*\\(?\\s*legacy\\s*\\)?\\s*/g, \"\").trim();\n\n        let isNameMatch = normalizedEntry === normalizedSearch || entryWithoutLegacy === normalizedSearch;\n\n        if (!isNameMatch && useWordMatch && searchWords.length > 1) {\n          const stopWords = new Set([\"of\", \"the\", \"a\", \"an\"]);\n          const entryWords = entryWithoutLegacy.split(/[\\s,\\-]+/).filter(w => w.length > 0 && !stopWords.has(w));\n          const filteredSearchWords = searchWords.filter(w => !stopWords.has(w));\n          isNameMatch = filteredSearchWords.every(sw => entryWords.some(ew => ew === sw));\n        }\n\n        if (!isNameMatch) continue;\n\n        const requirementScore = this._getRequirementScore(entry, className, raceName);\n        if (requirementScore === 0) {\n          continue;\n        }\n\n        const sourceBook = entry.system?.source?.book || \"\";\n        const sourceRules = entry.system?.source?.rules || \"\";\n        const dedupeKey = `${source}::${sourceBook}::${sourceRules}`;\n        if (seenSources.has(dedupeKey)) continue;\n\n        const sourceInfo = this._getSourceInfo(source);\n        matches.push({\n          uuid: entry.uuid,\n          name: entry.name,\n          type: entry.type,\n          packId,\n          source,\n          sourceLabel: pack.metadata.label,\n          sourceVersion: sourceInfo.version,\n          sourceTitle: sourceInfo.title,\n          sourceBook,\n          sourceRules,\n          displayLabel: this._createDisplayLabel(pack.metadata.label, source, sourceBook, sourceRules),\n          matchType: \"exactName\",\n          requirementScore\n        });\n        seenSources.add(dedupeKey);\n      }\n    }\n\n    return matches;\n  }\n\n  /**\n   * Get type variants to search for (handles race/species and equipment/consumable/tool flexibility)\n   * @param {string|null} type - Foundry item type\n   * @returns {Array<string>} Array of types to match\n   * @private\n   */\n  static _getTypeVariants(type) {\n    if (!type) return [];\n    if (type === \"race\") return [\"race\", \"species\"];\n    if (type === \"species\") return [\"race\", \"species\"];\n    if (EQUIPMENT_TYPE_VARIANTS.includes(type)) return EQUIPMENT_TYPE_VARIANTS;\n    return [type];\n  }\n\n  /**\n   * Match all items from a DDB character\n   * @param {Object} ddbCharacter - Full DDB character data\n   * @returns {Promise<CharacterMatchResult>}\n   */\n  static async matchCharacterItems(ddbCharacter) {\n    if (!this._indices) {\n      await this.buildIndex();\n    }\n\n    const SETTINGS = getSettings();\n    let priorityMode = SettingsUtil.get(SETTINGS.ddbImportSourcePriority.tag) ?? 0;\n\n    if (priorityMode === 0) {\n      priorityMode = this._detectRulesVersion(ddbCharacter);\n    }\n\n    const matched = [];\n    const unmatched = [];\n    const itemsToMatch = this._extractItemsToMatch(ddbCharacter);\n    const availableSources = new Set();\n\n    const spellItems = itemsToMatch.filter(i => i.type === \"spell\" || i.type?.toLowerCase() === \"spell\");\n    LogUtil.log(\"DnDBCompendiumMatcher: Items to match\", [\n      itemsToMatch.length,\n      `(${spellItems.length} spells)`,\n      `priority: ${priorityMode === 1 ? \"2024\" : priorityMode === 2 ? \"2014\" : \"closest\"}`\n    ]);\n    if (spellItems.length > 0) {\n      LogUtil.log(\"DnDBCompendiumMatcher: Spells to match\", [\n        spellItems.map(s => s.definition?.name || s.name).join(\", \")\n      ]);\n    }\n\n    for (const ddbItem of itemsToMatch) {\n      const allMatches = await this.findAllMatches(ddbItem, priorityMode);\n      const itemName = ddbItem.definition?.name || ddbItem.name;\n      const itemType = this._mapDDBType(ddbItem) || \"unknown\";\n\n      if (allMatches.length > 0) {\n        const selectedMatch = allMatches[0];\n\n        for (const m of allMatches) {\n          availableSources.add(m.source);\n        }\n\n        matched.push({\n          ddbItem,\n          foundryUuid: selectedMatch.uuid,\n          foundryName: selectedMatch.name,\n          foundryType: itemType || selectedMatch.type,\n          matchType: selectedMatch.matchType,\n          source: selectedMatch.source,\n          sourceLabel: selectedMatch.sourceLabel,\n          sourceTitle: selectedMatch.sourceTitle,\n          sourceVersion: selectedMatch.sourceVersion,\n          allMatches,\n          selectedIndex: 0\n        });\n      } else {\n        unmatched.push({\n          ddbItem,\n          name: itemName,\n          type: itemType,\n          reason: \"not_found\"\n        });\n      }\n    }\n\n    const total = matched.length + unmatched.length;\n    const matchRate = total > 0 ? matched.length / total : 0;\n    const tier = matchRate >= 0.5 ? \"B\" : \"C\";\n\n    const matchedSpells = matched.filter(m => m.foundryType === \"spell\");\n    const unmatchedSpells = unmatched.filter(u => u.type === \"spell\");\n    LogUtil.log(\"DnDBCompendiumMatcher: Character match complete\", [\n      `${matched.length}/${total} matched`,\n      `${(matchRate * 100).toFixed(0)}%`,\n      `Tier ${tier}`,\n      `${matchedSpells.length} spells matched, ${unmatchedSpells.length} unmatched`\n    ]);\n    if (unmatchedSpells.length > 0) {\n      LogUtil.log(\"DnDBCompendiumMatcher: Unmatched spells\", [\n        unmatchedSpells.map(s => s.name).join(\", \")\n      ]);\n    }\n\n    return {\n      matched,\n      unmatched,\n      matchRate,\n      tier,\n      total,\n      availableSources: Array.from(availableSources)\n    };\n  }\n\n  /**\n   * Extract all items from DDB character that need matching\n   * @param {Object} ddbCharacter - Full DDB character data\n   * @returns {Array<Object>} Array of DDB item objects\n   * @private\n   */\n  static _extractItemsToMatch(ddbCharacter) {\n    const items = [];\n\n    if (Array.isArray(ddbCharacter.classes)) {\n      for (const cls of ddbCharacter.classes) {\n        items.push({\n          definition: cls.definition,\n          id: cls.definition?.id,\n          name: cls.definition?.name,\n          type: \"Class\",\n          _classLevel: cls.level,\n          _isStartingClass: cls.isStartingClass,\n          _subclass: cls.subclassDefinition\n        });\n\n        if (cls.subclassDefinition) {\n          items.push({\n            definition: cls.subclassDefinition,\n            id: cls.subclassDefinition.id,\n            name: cls.subclassDefinition.name,\n            type: \"Subclass\",\n            _parentClass: cls.definition?.name\n          });\n        }\n\n        if (Array.isArray(cls.classFeatures)) {\n          for (const feature of cls.classFeatures) {\n            if (!feature.definition) continue;\n            const requiredLevel = feature.definition.requiredLevel || 1;\n            if (requiredLevel > cls.level) continue;\n\n            const featureName = feature.definition.name;\n            if (this._isSystemMechanicFeature(featureName)) {\n              continue;\n            }\n\n            items.push({\n              definition: feature.definition,\n              id: feature.definition.id,\n              name: featureName,\n              type: feature.definition.entityType || \"class-feature\",\n              _className: cls.definition?.name,\n              _classLevel: cls.level,\n              _requiredLevel: requiredLevel,\n              _isSubclassFeature: feature.definition.isSubClassFeature || false\n            });\n          }\n        }\n      }\n    }\n\n    if (ddbCharacter.race) {\n      const baseRaceName = ddbCharacter.race.baseName || ddbCharacter.race.fullName;\n      const lineageVariant = this._extractLineageVariant(ddbCharacter, baseRaceName);\n      const raceName = lineageVariant || ddbCharacter.race.fullName || baseRaceName;\n      const searchVariants = this._getRaceSearchVariants(raceName, baseRaceName, ddbCharacter.race.subRaceShortName, lineageVariant);\n\n      LogUtil.log(\"DnDBCompendiumMatcher: Extracting race/species\", [\n        `base: ${baseRaceName}`,\n        `lineage: ${lineageVariant || \"none\"}`,\n        `name: ${raceName}`,\n        `variants: ${searchVariants.join(\", \")}`\n      ]);\n\n      items.push({\n        definition: ddbCharacter.race,\n        id: ddbCharacter.race.entityRaceId || ddbCharacter.race.id,\n        name: raceName,\n        type: \"Race\",\n        _isSubrace: !!ddbCharacter.race.subRaceShortName,\n        _baseRaceName: baseRaceName,\n        _lineageVariant: lineageVariant,\n        _searchVariants: searchVariants\n      });\n\n      if (Array.isArray(ddbCharacter.race.racialTraits)) {\n        for (const trait of ddbCharacter.race.racialTraits) {\n          if (!trait.definition) continue;\n          const traitName = trait.definition.name;\n          if (this._isSystemMechanicFeature(traitName)) continue;\n\n          items.push({\n            definition: trait.definition,\n            id: trait.definition.id,\n            name: traitName,\n            type: \"Racial Trait\",\n            _raceName: baseRaceName\n          });\n        }\n      }\n    }\n\n    if (ddbCharacter.background?.definition) {\n      const bgDef = ddbCharacter.background.definition;\n      items.push({\n        definition: bgDef,\n        id: bgDef.id,\n        name: bgDef.name,\n        type: \"Background\"\n      });\n    }\n\n    if (ddbCharacter.inventory) {\n      for (const item of ddbCharacter.inventory) {\n        items.push(item);\n      }\n    }\n\n    const spellsByDefinitionId = new Map();\n    const SETTINGS = getSettings();\n    const spellImportMode = SettingsUtil.get(SETTINGS.ddbImportSpellMode.tag) ?? 0;\n    const onlyPrepared = spellImportMode === 1;\n\n    if (ddbCharacter.spells) {\n      const spellSources = [\"class\", \"race\", \"feat\", \"item\", \"background\"];\n\n      for (const source of spellSources) {\n        if (Array.isArray(ddbCharacter.spells[source])) {\n          for (const spell of ddbCharacter.spells[source]) {\n            const defId = spell.definition?.id;\n            if (!defId) continue;\n\n            const isCantrip = spell.definition?.level === 0;\n            if (onlyPrepared && !spell.prepared && !spell.alwaysPrepared && !isCantrip) continue;\n\n            const existing = spellsByDefinitionId.get(defId);\n            if (existing) {\n              if (spell.alwaysPrepared && !existing.alwaysPrepared) {\n                spellsByDefinitionId.set(defId, { ...spell, _spellSource: source, type: \"spell\" });\n              }\n            } else {\n              spellsByDefinitionId.set(defId, { ...spell, _spellSource: source, type: \"spell\" });\n            }\n          }\n        }\n      }\n    }\n\n    if (Array.isArray(ddbCharacter.classSpells)) {\n      for (const classSpellList of ddbCharacter.classSpells) {\n        if (!Array.isArray(classSpellList.spells)) continue;\n\n        for (const spell of classSpellList.spells) {\n          const defId = spell.definition?.id;\n          if (!defId) continue;\n\n          const isCantrip = spell.definition?.level === 0;\n          if (onlyPrepared && !spell.prepared && !spell.alwaysPrepared && !isCantrip) continue;\n\n          const existing = spellsByDefinitionId.get(defId);\n          if (existing) {\n            if (spell.alwaysPrepared && !existing.alwaysPrepared) {\n              spellsByDefinitionId.set(defId, { ...spell, _spellSource: \"classSpells\", type: \"spell\" });\n            }\n          } else {\n            spellsByDefinitionId.set(defId, { ...spell, _spellSource: \"classSpells\", type: \"spell\" });\n          }\n        }\n      }\n    }\n\n    for (const spell of spellsByDefinitionId.values()) {\n      items.push(spell);\n    }\n\n    if (ddbCharacter.feats) {\n      for (const feat of ddbCharacter.feats) {\n        items.push({\n          ...feat,\n          type: \"Feat\"\n        });\n      }\n    }\n\n    if (ddbCharacter.options?.class) {\n      const existingClassFeatureIds = new Set(\n        items.filter(i => i.type === \"class-feature\" || i._className).map(i => i.id)\n      );\n\n      for (const option of ddbCharacter.options.class) {\n        if (!option.definition) continue;\n        if (existingClassFeatureIds.has(option.definition.id)) continue;\n\n        const optionName = option.definition.name;\n        if (this._isSystemMechanicFeature(optionName)) {\n          continue;\n        }\n\n        const parentFeatureId = option.componentId;\n        const parentFeature = items.find(i =>\n          (i.type === \"class-feature\" || i._className) && i.id === parentFeatureId\n        );\n\n        items.push({\n          definition: option.definition,\n          id: option.definition.id,\n          name: optionName,\n          type: \"class-feature\",\n          _isChoiceOption: true,\n          _parentFeatureId: parentFeatureId,\n          _parentFeatureName: parentFeature?.name || null,\n          _className: parentFeature?._className || null\n        });\n\n        LogUtil.log(\"DnDBCompendiumMatcher: Extracted choice option\", [\n          optionName,\n          `parent: ${parentFeature?.name || parentFeatureId}`\n        ]);\n      }\n    }\n\n    const toolProficiencies = DnDBCharacterTransformer.getToolProficiencies(ddbCharacter);\n    for (const tool of toolProficiencies) {\n      items.push({\n        name: tool.name,\n        type: \"Tool\",\n        _toolSubType: tool.subType,\n        _isToolProficiency: true\n      });\n    }\n\n    return items;\n  }\n\n  /**\n   * Extract lineage variant from options.race for 2024 species\n   * For example: \"Wood Elf Lineage\" option -> \"Elf, Wood\"\n   * @param {Object} ddbCharacter - Full DDB character data\n   * @param {string} baseRaceName - Base race/species name (e.g., \"Elf\")\n   * @returns {string|null} Lineage variant name for compendium matching, or null\n   * @private\n   */\n  static _extractLineageVariant(ddbCharacter, baseRaceName) {\n    if (!ddbCharacter.options?.race) return null;\n\n    const lineagePattern = /^(\\w+(?:\\s+\\w+)?)\\s+Lineage$/i;\n\n    for (const option of ddbCharacter.options.race) {\n      const optionName = option.definition?.name;\n      if (!optionName) continue;\n\n      const match = optionName.match(lineagePattern);\n      if (match) {\n        const variant = match[1];\n        if (variant.toLowerCase().includes(baseRaceName.toLowerCase()) ||\n            baseRaceName.toLowerCase().includes(variant.split(/\\s+/)[0].toLowerCase())) {\n          const variantParts = variant.split(/\\s+/);\n          if (variantParts.length >= 2) {\n            const variantType = variantParts[0];\n            const result = `${baseRaceName}, ${variantType}`;\n            LogUtil.log(\"DnDBCompendiumMatcher: Extracted lineage variant\", [\n              optionName,\n              `-> ${result}`\n            ]);\n            return result;\n          }\n        }\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Get search variants for race/species names to handle 2014 vs 2024 naming\n   * @param {string} fullName - Full race name (e.g., \"Elf, Wood\" or \"High Elf\")\n   * @param {string} baseName - Base race name (e.g., \"Elf\")\n   * @param {string|null} subRaceShortName - Subrace short name for 2014 (e.g., \"High\")\n   * @param {string|null} lineageVariant - Lineage variant for 2024 (e.g., \"Elf, Wood\")\n   * @returns {Array<string>} Array of name variants to search\n   * @private\n   */\n  static _getRaceSearchVariants(fullName, baseName, subRaceShortName, lineageVariant) {\n    const variants = new Set([fullName]);\n    if (lineageVariant) {\n      variants.add(lineageVariant);\n      const parts = lineageVariant.split(/,\\s*/);\n      if (parts.length === 2) {\n        variants.add(`${parts[1]} ${parts[0]}`);\n      }\n    }\n    if (baseName && subRaceShortName) {\n      variants.add(`${baseName}, ${subRaceShortName}`);\n      variants.add(`${subRaceShortName} ${baseName}`);\n    }\n    if (baseName) {\n      variants.add(baseName);\n    }\n    return Array.from(variants);\n  }\n\n  /**\n   * Get name variants for choice options (e.g., Fighting Style: Defense)\n   * DDB stores just \"Defense\" but compendiums may have \"Fighting Style: Defense\"\n   * @param {string} optionName - The choice option name (e.g., \"Defense\")\n   * @param {string} parentFeatureName - The parent feature name (e.g., \"Fighting Style\")\n   * @returns {Array<string>} Array of name variants to search\n   * @private\n   */\n  static _getChoiceNameVariants(optionName, parentFeatureName) {\n    const variants = [];\n    variants.push(`${parentFeatureName}: ${optionName}`);\n    variants.push(`${optionName} (${parentFeatureName})`);\n    variants.push(`${parentFeatureName} - ${optionName}`);\n    return variants;\n  }\n\n  /**\n   * System mechanic feature names that should NOT be matched as separate items\n   * These are handled by the actor's base stats, not as item features\n   * @private\n   */\n  static SYSTEM_MECHANIC_FEATURES = new Set([\n    \"Proficiencies\",\n    \"Hit Points\",\n    \"Equipment\",\n    \"Languages\",\n    \"Ability Score Increases\",\n    \"Ability Score Increase\",\n    \"Creature Type\",\n    \"Size\",\n    \"Speed\",\n    \"Darkvision\",\n    \"Superior Darkvision\",\n    \"Fighting Style feat\",\n    \"Epic Boon feat\"\n  ]);\n\n  static SYSTEM_MECHANIC_PATTERNS = [\n    /^Core .+ Traits$/\n  ];\n\n  /**\n   * Check if a feature name is a system mechanic that shouldn't be matched\n   * @param {string} featureName - Name of the feature\n   * @returns {boolean} True if this is a system mechanic feature\n   * @private\n   */\n  static _isSystemMechanicFeature(featureName) {\n    if (!featureName) return false;\n    if (this.SYSTEM_MECHANIC_FEATURES.has(featureName)) return true;\n    return this.SYSTEM_MECHANIC_PATTERNS.some(pattern => pattern.test(featureName));\n  }\n\n  /**\n   * Get statistics about the current index\n   * @returns {Object} Index statistics\n   */\n  static getIndexStats() {\n    if (!this._indices) {\n      return { built: false, packCount: 0, totalItems: 0 };\n    }\n\n    let totalItems = 0;\n    for (const { entries } of this._indices.values()) {\n      totalItems += entries.length;\n    }\n\n    return {\n      built: true,\n      packCount: this._indices.size,\n      totalItems\n    };\n  }\n}\n\n/**\n * @typedef {Object} MatchResult\n * @property {string} uuid - Foundry UUID of matched item\n * @property {string} name - Name of matched item\n * @property {string} type - Foundry item type\n * @property {string} packId - Compendium pack ID\n * @property {string} matchType - How the match was made: \"ddbId\", \"exactName\", or \"partialName\"\n */\n\n/**\n * @typedef {Object} CharacterMatchResult\n * @property {Array} matched - Successfully matched items\n * @property {Array} unmatched - Items that couldn't be matched\n * @property {number} matchRate - Ratio of matched to total (0-1)\n * @property {string} tier - \"B\" if matchRate >= 0.5, \"C\" otherwise\n * @property {number} total - Total number of items processed\n */\n","import { MODULE } from \"../../../constants/General.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\";\n\n/**\n * Manages FTB Homebrew compendiums for storing placeholder items from D&D Beyond imports\n * Creates world compendiums organized by item type for unmatched DDB content\n */\nexport class DnDBHomebrewManager {\n\n  static FOLDER_NAME = \"Flash Token Bar\";\n  static FOLDER_COLOR = \"#5c2d91\";\n\n  static COMPENDIUM_CONFIG = {\n    race: { label: \"FTB Species\", type: \"Item\" },\n    species: { label: \"FTB Species\", type: \"Item\" },\n    background: { label: \"FTB Backgrounds\", type: \"Item\" },\n    class: { label: \"FTB Classes\", type: \"Item\" },\n    subclass: { label: \"FTB Subclasses\", type: \"Item\" },\n    feat: { label: \"FTB Features\", type: \"Item\" },\n    spell: { label: \"FTB Spells\", type: \"Item\" },\n    weapon: { label: \"FTB Equipment\", type: \"Item\" },\n    equipment: { label: \"FTB Equipment\", type: \"Item\" },\n    consumable: { label: \"FTB Equipment\", type: \"Item\" },\n    tool: { label: \"FTB Equipment\", type: \"Item\" },\n    unknown: { label: \"FTB Features\", type: \"Item\" }\n  };\n\n  /**\n   * Get or create the FTB compendium folder\n   * @returns {Promise<Folder|null>} The folder or null if creation failed\n   */\n  static async getOrCreateFolder() {\n    let folder = game.folders.find(f =>\n      f.type === \"Compendium\" &&\n      f.name === this.FOLDER_NAME\n    );\n\n    if (folder) {\n      return folder;\n    }\n\n    try {\n      folder = await Folder.create({\n        name: this.FOLDER_NAME,\n        type: \"Compendium\",\n        color: this.FOLDER_COLOR\n      });\n      LogUtil.log(\"DnDBHomebrewManager: Created compendium folder\", [folder.id]);\n      return folder;\n    } catch (error) {\n      LogUtil.error(\"DnDBHomebrewManager: Failed to create folder\", [error.message]);\n      return null;\n    }\n  }\n\n  /**\n   * Get or create a compendium for a specific item type\n   * @param {string} itemType - The item type (race, background, class, etc.)\n   * @returns {Promise<CompendiumCollection|null>} The compendium or null if failed\n   */\n  static async getOrCreateCompendium(itemType) {\n    const config = this.COMPENDIUM_CONFIG[itemType.toLowerCase()];\n    if (!config) {\n      LogUtil.warn(\"DnDBHomebrewManager: Unknown item type\", [itemType]);\n      return null;\n    }\n\n    const packName = this._getPackName(config.label);\n    let pack = game.packs.get(`world.${packName}`);\n\n    if (pack) {\n      return pack;\n    }\n\n    pack = game.packs.find(p =>\n      p.metadata.packageType === \"world\" &&\n      p.metadata.label === config.label\n    );\n\n    if (pack) {\n      return pack;\n    }\n\n    try {\n      const folder = await this.getOrCreateFolder();\n\n      const CompendiumClass = foundry.documents?.collections?.CompendiumCollection ?? CompendiumCollection;\n\n      pack = await CompendiumClass.createCompendium({\n        type: config.type,\n        label: config.label,\n        name: packName,\n        packageType: \"world\",\n        flags: {\n          [MODULE.ID]: {\n            isHomebrewCompendium: true,\n            createdDate: Date.now()\n          }\n        }\n      });\n\n      if (pack && folder) {\n        await pack.setFolder(folder.id);\n      }\n\n      LogUtil.log(\"DnDBHomebrewManager: Created compendium\", [config.label, pack?.metadata?.id]);\n      return pack;\n    } catch (error) {\n      LogUtil.error(\"DnDBHomebrewManager: Failed to create compendium\", [config.label, error.message]);\n      return null;\n    }\n  }\n\n  /**\n   * Convert a label to a valid pack name\n   * @param {string} label - The compendium label\n   * @returns {string} Valid pack name\n   * @private\n   */\n  static _getPackName(label) {\n    return label.toLowerCase().replace(/\\s+/g, \"-\").replace(/[^a-z0-9-]/g, \"\");\n  }\n\n  /**\n   * Check if an item already exists in the appropriate compendium\n   * @param {string} name - Item name to search for\n   * @param {string} itemType - Item type\n   * @returns {Promise<Object|null>} Existing item or null\n   */\n  static async findExistingItem(name, itemType) {\n    const pack = await this.getOrCreateCompendium(itemType);\n    if (!pack) return null;\n\n    const normalizedName = name.toLowerCase().trim();\n    const index = await pack.getIndex();\n\n    const existing = index.find(i => i.name.toLowerCase().trim() === normalizedName);\n    if (existing) {\n      return {\n        uuid: `${pack.metadata.id}.${existing._id}`,\n        name: existing.name,\n        pack: pack.metadata.id\n      };\n    }\n\n    return null;\n  }\n\n  /**\n   * Create a placeholder item in the appropriate compendium\n   * @param {Object} itemData - Foundry item data to create\n   * @param {string} itemType - Item type for compendium selection\n   * @returns {Promise<Item|null>} Created item or null if failed\n   */\n  static async createItemInCompendium(itemData, itemType) {\n    const pack = await this.getOrCreateCompendium(itemType);\n    if (!pack) return null;\n\n    const existing = await this.findExistingItem(itemData.name, itemType);\n    if (existing) {\n      LogUtil.log(\"DnDBHomebrewManager: Item already exists in compendium\", [itemData.name, existing.uuid]);\n      const item = await fromUuid(existing.uuid);\n      return item;\n    }\n\n    try {\n      const Item5e = CONFIG.Item.documentClass;\n      const item = await Item5e.create(itemData, { pack: pack.metadata.id });\n      LogUtil.log(\"DnDBHomebrewManager: Created item in compendium\", [item.name, pack.metadata.id]);\n      return item;\n    } catch (error) {\n      LogUtil.error(\"DnDBHomebrewManager: Failed to create item in compendium\", [itemData.name, error.message]);\n      return null;\n    }\n  }\n\n  /**\n   * Create multiple placeholder items and add them to an actor\n   * @param {Actor} actor - The actor to add items to\n   * @param {Array} unmatchedItems - Array of unmatched item data from DDB\n   * @returns {Promise<Array>} Array of created items\n   */\n  static async createHomebrewItemsForActor(actor, unmatchedItems) {\n    const createdItems = [];\n    const itemsToAddToActor = [];\n\n    LogUtil.log(\"DnDBHomebrewManager: Creating homebrew items\", [\n      unmatchedItems.length,\n      unmatchedItems.map(i => `${i.name} (${i.type})`).join(\", \")\n    ]);\n\n    for (const unmatchedItem of unmatchedItems) {\n      const itemData = this._createPlaceholderItemData(unmatchedItem);\n      if (!itemData) {\n        LogUtil.warn(\"DnDBHomebrewManager: Failed to create placeholder data for\", [unmatchedItem.name]);\n        continue;\n      }\n\n      const rawType = unmatchedItem.type || \"feat\";\n      LogUtil.log(\"DnDBHomebrewManager: Creating item\", [itemData.name, itemData.type, rawType]);\n      const compendiumItem = await this.createItemInCompendium(itemData, rawType);\n\n      if (compendiumItem) {\n        createdItems.push(compendiumItem);\n\n        const actorItemData = compendiumItem.toObject();\n        delete actorItemData._id;\n\n        this._applyItemState(actorItemData, unmatchedItem);\n\n        itemsToAddToActor.push(actorItemData);\n      }\n    }\n\n    if (itemsToAddToActor.length > 0) {\n      await actor.createEmbeddedDocuments(\"Item\", itemsToAddToActor);\n      LogUtil.log(\"DnDBHomebrewManager: Added homebrew items to actor\", [itemsToAddToActor.length, actor.name]);\n    }\n\n    return createdItems;\n  }\n\n  /**\n   * Create placeholder item data for an unmatched item\n   * @param {Object} unmatchedItem - The unmatched item data\n   * @returns {Object|null} Foundry item data\n   * @private\n   */\n  static _createPlaceholderItemData(unmatchedItem) {\n    const name = unmatchedItem.name || unmatchedItem.ddbItem?.definition?.name || \"Unknown Item\";\n    const rawType = unmatchedItem.type || \"feat\";\n    const type = this._mapTypeForCreation(rawType);\n\n    const definition = unmatchedItem.ddbItem?.definition;\n    const fullDescription = definition?.description || \"\";\n    const shortDescription = definition?.snippet || \"\";\n    const description = (fullDescription.length >= shortDescription.length ? fullDescription : shortDescription) ||\n                        `<p><em>Placeholder item imported from D&D Beyond. This item was not found in any compendium.</em></p>`;\n\n    const itemData = {\n      name,\n      type,\n      img: this._getDefaultIcon(type),\n      system: {\n        description: {\n          value: description\n        },\n        source: {\n          custom: \"FTB - D&D Beyond\"\n        }\n      },\n      flags: {\n        [MODULE.ID]: {\n          ddbPlaceholder: true,\n          ddbItemType: rawType,\n          ddbDefinitionId: unmatchedItem.ddbItem?.definition?.id || unmatchedItem.id\n        }\n      }\n    };\n\n    if (type === \"class\" && unmatchedItem._classLevel) {\n      itemData.system.levels = unmatchedItem._classLevel;\n    }\n\n    return itemData;\n  }\n\n  /**\n   * Apply DDB item state to Foundry item data\n   * @param {Object} itemData - Foundry item data to modify\n   * @param {Object} unmatchedItem - Original unmatched item\n   * @private\n   */\n  static _applyItemState(itemData, unmatchedItem) {\n    if (itemData.type === \"class\" && unmatchedItem._classLevel) {\n      if (!itemData.system) itemData.system = {};\n      itemData.system.levels = unmatchedItem._classLevel;\n    }\n  }\n\n  /**\n   * Map DDB type to valid Foundry item type for creation\n   * @param {string} type - DDB item type\n   * @returns {string} Valid Foundry item type\n   * @private\n   */\n  static _mapTypeForCreation(type) {\n    if (!type) return \"feat\";\n    const normalizedType = type.toLowerCase();\n    const typeMap = {\n      race: \"race\",\n      species: \"race\",\n      background: \"background\",\n      class: \"class\",\n      subclass: \"subclass\",\n      feat: \"feat\",\n      spell: \"spell\",\n      weapon: \"weapon\",\n      equipment: \"equipment\",\n      consumable: \"consumable\",\n      tool: \"tool\",\n      unknown: \"feat\"\n    };\n    return typeMap[normalizedType] || \"feat\";\n  }\n\n  /**\n   * Get default icon for item type\n   * @param {string} type - Foundry item type\n   * @returns {string} Icon path\n   * @private\n   */\n  static _getDefaultIcon(type) {\n    const icons = {\n      race: \"icons/environment/people/group.webp\",\n      background: \"icons/skills/trades/academics-book-study-purple.webp\",\n      class: \"icons/sundries/books/book-red-exclamation.webp\",\n      subclass: \"icons/sundries/books/book-stack.webp\",\n      feat: \"icons/sundries/scrolls/scroll-runed-brown-purple.webp\",\n      spell: \"icons/magic/symbols/runes-star-pentagon-orange-purple.webp\",\n      weapon: \"icons/weapons/swords/sword-guard-bronze.webp\",\n      equipment: \"icons/equipment/chest/breastplate-banded-steel-gold.webp\",\n      consumable: \"icons/consumables/potions/potion-bottle-corked-red.webp\",\n      tool: \"icons/tools/hand/hammer-and-nails.webp\"\n    };\n    return icons[type] || \"icons/svg/item-bag.svg\";\n  }\n}\n","import { LogUtil } from \"../../utils/LogUtil.mjs\";\nimport { DnDBCharacterFetcher } from \"./DnDBCharacterFetcher.mjs\";\nimport { DnDBCompendiumMatcher } from \"./DnDBCompendiumMatcher.mjs\";\nimport { DnDBCharacterTransformer } from \"./DnDBCharacterTransformer.mjs\";\nimport { DnDBHomebrewManager } from \"./DnDBHomebrewManager.mjs\";\nimport { DnDBeyondIntegration } from \"../DnDBeyondIntegration.mjs\";\nimport { MODULE } from \"../../../constants/General.mjs\";\n\n/**\n * Main orchestrator for importing characters from D&D Beyond\n * Implements tiered import strategy:\n * - Tier A: DDB Importer active - delegate to their API\n * - Tier B: No DDB Importer, 50% matches - create actor with matched items\n * - Tier C: No DDB Importer, <50% matches - create basic actor shell\n */\nexport class DnDBCharacterImporter {\n\n  /**\n   * Import a character from D&D Beyond\n   * @param {string|number} characterId - DDB character ID\n   * @param {Object} options - Import options\n   * @param {boolean} options.skipDialog - Skip confirmation dialog\n   * @returns {Promise<Actor|null>} Created actor or null if cancelled/failed\n   */\n  static async importCharacter(characterId, options = {}) {\n    LogUtil.log(\"DnDBCharacterImporter: Starting import\", [characterId]);\n\n    if (this._hasDDBImporter()) {\n      return await this._importViaDDBImporter(characterId);\n    }\n\n    const ddbCharacter = await DnDBCharacterFetcher.fetchCharacter(characterId);\n    if (!ddbCharacter) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumSettings.fetchFailed\"));\n      return null;\n    }\n\n    const matchResult = await DnDBCompendiumMatcher.matchCharacterItems(ddbCharacter);\n\n    if (!options.skipDialog) {\n      const { CharacterImportResultsDialog } = await import(\n        \"../../ui/dialogs/CharacterImportResultsDialog.mjs\"\n      );\n\n      const dialogResult = await CharacterImportResultsDialog.show({\n        characterName: ddbCharacter.name,\n        tier: matchResult.tier,\n        matchRate: matchResult.matchRate,\n        matched: matchResult.matched,\n        unmatched: matchResult.unmatched,\n        classInfo: DnDBCharacterTransformer.getClassInfo(ddbCharacter),\n        raceName: DnDBCharacterTransformer.getRaceName(ddbCharacter),\n        backgroundName: DnDBCharacterTransformer.getBackgroundName(ddbCharacter)\n      });\n\n      if (!dialogResult) {\n        LogUtil.log(\"DnDBCharacterImporter: Import cancelled by user\");\n        return null;\n      }\n\n      matchResult.matched = dialogResult.matched;\n      matchResult.homebrewToCreate = dialogResult.homebrewToCreate || [];\n    }\n\n    return await this._createActorFromMatch(ddbCharacter, matchResult);\n  }\n\n  /**\n   * Check if DDB Importer module is active\n   * @returns {boolean}\n   * @private\n   */\n  static _hasDDBImporter() {\n    return game.modules.get(\"ddb-importer\")?.active === true;\n  }\n\n  /**\n   * Import via DDB Importer module API\n   * DDB Importer requires an existing actor with characterId in flags\n   * We create a stub actor first, then let DDB Importer populate it\n   * @param {string|number} characterId - DDB character ID\n   * @returns {Promise<Actor|null>}\n   * @private\n   */\n  static async _importViaDDBImporter(characterId) {\n    LogUtil.log(\"DnDBCharacterImporter: Using DDB Importer (Tier A)\");\n\n    try {\n      const DDBImporter = game.modules.get(\"ddb-importer\")?.api;\n      if (!DDBImporter?.importCharacter) {\n        LogUtil.error(\"DnDBCharacterImporter: DDB Importer API not available\");\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumSettings.ddbImporterApiError\"));\n        return null;\n      }\n\n      const stubActor = await Actor.create({\n        name: `DDB Import ${characterId}`,\n        type: \"character\",\n        flags: {\n          ddbimporter: {\n            dndbeyond: {\n              characterId: String(characterId)\n            }\n          }\n        }\n      });\n\n      if (!stubActor) {\n        LogUtil.error(\"DnDBCharacterImporter: Failed to create stub actor\");\n        return null;\n      }\n\n      LogUtil.log(\"DnDBCharacterImporter: Created stub actor for DDB Importer\", [stubActor.id]);\n\n      await DDBImporter.importCharacter({ actor: stubActor });\n\n      const refreshedActor = game.actors.get(stubActor.id);\n      if (refreshedActor) {\n        await DnDBeyondIntegration.mapCharacter(characterId, refreshedActor.id);\n        ui.notifications.info(\n          game.i18n.format(\"FLASH_ROLLS.settings.premiumSettings.successDDBImporter\", { name: refreshedActor.name })\n        );\n        return refreshedActor;\n      }\n\n      ui.notifications.warn(game.i18n.localize(\"FLASH_ROLLS.settings.premiumSettings.ddbImporterFailed\"));\n      return null;\n    } catch (error) {\n      LogUtil.error(\"DnDBCharacterImporter: DDB Importer error\", [error.message]);\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumSettings.ddbImporterError\"));\n      return null;\n    }\n  }\n\n  /**\n   * Create actor from match results (Tier B/C)\n   * @param {Object} ddbCharacter - DDB character data\n   * @param {Object} matchResult - Compendium match results\n   * @returns {Promise<Actor|null>}\n   * @private\n   */\n  static async _createActorFromMatch(ddbCharacter, matchResult) {\n    const homebrewCount = matchResult.homebrewToCreate?.length || 0;\n    LogUtil.log(\"DnDBCharacterImporter: Creating actor\", [\n      `Tier ${matchResult.tier}`,\n      `${matchResult.matched.length} items to add`,\n      `${homebrewCount} homebrew to create`\n    ]);\n\n    try {\n      const actorData = DnDBCharacterTransformer.transformToActor(ddbCharacter, matchResult);\n      const actor = await Actor.create(actorData);\n\n      if (!actor) {\n        throw new Error(\"Actor.create returned null\");\n      }\n\n      await this._addMatchedItems(actor, matchResult.matched);\n\n      if (matchResult.homebrewToCreate?.length > 0) {\n        await this._createHomebrewItems(actor, matchResult.homebrewToCreate);\n      }\n\n      const refreshedActor = game.actors.get(actor.id);\n      const spellSlotData = DnDBCharacterTransformer.getSpellSlots(ddbCharacter);\n      if (Object.keys(spellSlotData.spellSlots).length > 0 || spellSlotData.pactSlots) {\n        await DnDBCharacterTransformer.applySpellSlots(refreshedActor, spellSlotData);\n      }\n\n      await DnDBeyondIntegration.mapCharacter(ddbCharacter.id, actor.id);\n\n      const tierLabel = matchResult.tier === \"B\" ? \"partial\" : \"basic\";\n      const totalCount = matchResult.matched.length + homebrewCount;\n      ui.notifications.info(\n        game.i18n.format(\"FLASH_ROLLS.settings.premiumSettings.success\", {\n          name: actor.name,\n          tier: tierLabel,\n          count: totalCount\n        })\n      );\n\n      LogUtil.log(\"DnDBCharacterImporter: Import complete\", [actor.id, actor.name]);\n      return actor;\n    } catch (error) {\n      LogUtil.error(\"DnDBCharacterImporter: Failed to create actor\", [error.message]);\n      ui.notifications.error(\n        game.i18n.format(\"FLASH_ROLLS.settings.premiumSettings.createFailed\", { error: error.message })\n      );\n      return null;\n    }\n  }\n\n  /**\n   * Create placeholder homebrew items for unmatched items\n   * Items are stored in FTB compendiums and then added to the actor\n   * @param {Actor} actor - The actor to add items to\n   * @param {Array} homebrewItems - Array of unmatched items to create as homebrew\n   * @private\n   */\n  static async _createHomebrewItems(actor, homebrewItems) {\n    const createdItems = await DnDBHomebrewManager.createHomebrewItemsForActor(actor, homebrewItems);\n    LogUtil.log(\"DnDBCharacterImporter: Created homebrew items via compendiums\", [createdItems.length]);\n  }\n\n  /**\n   * Add matched items from compendiums to actor\n   * Items are added in order: class first (to establish level), then race/background, then features, then regular items\n   * Skips advancement flow - adds class features directly from DDB data\n   * @param {Actor} actor - The actor to add items to\n   * @param {Array} matched - Array of matched items\n   * @private\n   */\n  static async _addMatchedItems(actor, matched) {\n    const classItems = [];\n    const subclassItems = [];\n    const raceBackgroundItems = [];\n    const classFeatureItems = [];\n    const regularItems = [];\n\n    for (const match of matched) {\n      const itemType = match.foundryType || match.ddbItem.type?.toLowerCase();\n      const entityType = match.ddbItem.type?.toLowerCase() || match.ddbItem.definition?.entityType;\n      const isChoiceOption = match.ddbItem._isChoiceOption === true;\n      const isClassFeature = entityType === \"class-feature\" || match.ddbItem._className;\n\n      if (itemType === \"class\") {\n        classItems.push(match);\n      } else if (itemType === \"subclass\") {\n        subclassItems.push(match);\n      } else if ([\"race\", \"species\", \"background\"].includes(itemType)) {\n        raceBackgroundItems.push(match);\n      } else if (isClassFeature || isChoiceOption) {\n        classFeatureItems.push(match);\n      } else {\n        regularItems.push(match);\n      }\n    }\n\n    const spellsInRegular = regularItems.filter(m => m.foundryType === \"spell\" || m.ddbItem?.type === \"spell\");\n    LogUtil.log(\"DnDBCharacterImporter: Categorized items\", [\n      `${classItems.length} classes`,\n      `${subclassItems.length} subclasses`,\n      `${raceBackgroundItems.length} race/bg`,\n      `${classFeatureItems.length} class features`,\n      `${regularItems.length} regular (${spellsInRegular.length} spells)`\n    ]);\n    if (spellsInRegular.length > 0) {\n      LogUtil.log(\"DnDBCharacterImporter: Spells to add\", [\n        spellsInRegular.map(s => s.foundryName).join(\", \")\n      ]);\n    }\n\n    if (classItems.length > 0) {\n      await this._addClassItemsDirectly(actor, classItems);\n    }\n\n    if (subclassItems.length > 0) {\n      await this._addItemsToActor(actor, subclassItems);\n    }\n\n    if (raceBackgroundItems.length > 0) {\n      await this._addItemsToActor(actor, raceBackgroundItems);\n    }\n\n    if (classFeatureItems.length > 0) {\n      await this._addItemsToActor(actor, classFeatureItems);\n    }\n\n    if (regularItems.length > 0) {\n      await this._addItemsToActor(actor, regularItems);\n    }\n  }\n\n  /**\n   * Add a batch of matched items to actor (non-class items only)\n   * @param {Actor} actor - The actor to add items to\n   * @param {Array} matched - Array of matched items\n   * @private\n   */\n  static async _addItemsToActor(actor, matched) {\n    const itemsToAdd = [];\n\n    for (const match of matched) {\n      try {\n        const compendiumItem = await fromUuid(match.foundryUuid);\n        if (!compendiumItem) {\n          LogUtil.warn(\"DnDBCharacterImporter: Could not load item\", [match.foundryUuid]);\n          continue;\n        }\n\n        const itemData = compendiumItem.toObject();\n        delete itemData._id;\n        DnDBCharacterTransformer.applyItemState(itemData, match.ddbItem);\n        itemsToAdd.push(itemData);\n      } catch (error) {\n        LogUtil.warn(\"DnDBCharacterImporter: Failed to process item\", [\n          match.foundryName,\n          error.message\n        ]);\n      }\n    }\n\n    if (itemsToAdd.length > 0) {\n      await actor.createEmbeddedDocuments(\"Item\", itemsToAdd);\n      LogUtil.log(\"DnDBCharacterImporter: Added items to actor\", [itemsToAdd.length]);\n    }\n  }\n\n  /**\n   * Add class items directly to actor without triggering advancement\n   * Sets the class level from DDB data - features are added separately\n   * @param {Actor} actor - The actor to add items to\n   * @param {Array} classMatches - Array of class matched items\n   * @private\n   */\n  static async _addClassItemsDirectly(actor, classMatches) {\n    const itemsToAdd = [];\n\n    for (const match of classMatches) {\n      try {\n        const compendiumItem = await fromUuid(match.foundryUuid);\n        if (!compendiumItem) {\n          LogUtil.warn(\"DnDBCharacterImporter: Could not load class item\", [match.foundryUuid]);\n          continue;\n        }\n\n        const itemData = compendiumItem.toObject();\n        delete itemData._id;\n\n        const classLevel = match.ddbItem._classLevel || 1;\n        if (itemData.system) {\n          itemData.system.levels = classLevel;\n        }\n\n        if (itemData.system?.advancement) {\n          itemData.system.advancement = itemData.system.advancement.filter(\n            adv => adv.type === \"ScaleValue\"\n          );\n        }\n\n        DnDBCharacterTransformer.applyItemState(itemData, match.ddbItem);\n\n        LogUtil.log(\"DnDBCharacterImporter: Adding class directly\", [\n          itemData.name,\n          `Level ${classLevel}`,\n          \"No advancement flow\"\n        ]);\n\n        itemsToAdd.push(itemData);\n      } catch (error) {\n        LogUtil.warn(\"DnDBCharacterImporter: Failed to process class item\", [\n          match.foundryName,\n          error.message\n        ]);\n      }\n    }\n\n    if (itemsToAdd.length > 0) {\n      await actor.createEmbeddedDocuments(\"Item\", itemsToAdd);\n      LogUtil.log(\"DnDBCharacterImporter: Added class items\", [itemsToAdd.length]);\n    }\n  }\n\n  /**\n   * Get the import tier that would be used for a character\n   * Useful for preview/UI purposes\n   * @param {string|number} characterId - DDB character ID\n   * @returns {Promise<Object>} Preview of import tier and match stats\n   */\n  static async previewImport(characterId) {\n    if (this._hasDDBImporter()) {\n      return {\n        tier: \"A\",\n        method: \"ddb-importer\",\n        matchRate: 1.0,\n        matched: [],\n        unmatched: []\n      };\n    }\n\n    const ddbCharacter = await DnDBCharacterFetcher.fetchCharacter(characterId);\n    if (!ddbCharacter) {\n      return { error: \"fetch_failed\" };\n    }\n\n    const matchResult = await DnDBCompendiumMatcher.matchCharacterItems(ddbCharacter);\n\n    return {\n      tier: matchResult.tier,\n      method: \"compendium-match\",\n      matchRate: matchResult.matchRate,\n      matched: matchResult.matched.length,\n      unmatched: matchResult.unmatched.length,\n      characterName: ddbCharacter.name\n    };\n  }\n}\n","import { MODULE } from \"../../../constants/General.mjs\";\nimport { getSettings } from \"../../../constants/Settings.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../../utils/SettingsUtil.mjs\";\nimport { DnDBeyondIntegration } from \"../../integrations/DnDBeyondIntegration.mjs\";\nimport { PatronSessionManager } from \"../../managers/PatronSessionManager.mjs\";\nimport { DnDBCharacterImporter } from \"../../integrations/dnd-beyond/DnDBCharacterImporter.mjs\";\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\nconst PROXY_BASE_URL = \"https://proxy.carolingian.io\";\n\n/**\n * Premium Features Dialog - ApplicationV2 component for managing premium feature settings\n * including D&D Beyond integration and Patreon authentication\n * @extends {HandlebarsApplicationMixin(ApplicationV2)}\n */ \nexport class PremiumFeaturesDialog extends HandlebarsApplicationMixin(ApplicationV2) {\n  static FLAG_LAST_TAB = \"premiumDialogLastTab\";\n\n  constructor(options = {}) {\n    super(options);\n    this._authStatus = null;\n    this._campaignCharacters = [];\n    this._isLoadingCharacters = false;\n    this._patronVerified = false;\n    this._ddbGameLogStatus = \"unknown\";\n    this._initialDataLoaded = false;\n    this.tabGroups[\"primary\"] = PremiumFeaturesDialog.getLastActiveTab();\n  }\n\n  /**\n   * Get the last active tab from user flags\n   * @returns {string} The last active tab id\n   */\n  static getLastActiveTab() {\n    return game.user.getFlag(MODULE.ID, PremiumFeaturesDialog.FLAG_LAST_TAB) || \"authentication\";\n  }\n\n  /**\n   * Save the last active tab to user flags\n   * @param {string} tabId - The tab id to save\n   */\n  static setLastActiveTab(tabId) {\n    game.user.setFlag(MODULE.ID, PremiumFeaturesDialog.FLAG_LAST_TAB, tabId);\n  }\n\n  /**\n   * Default application configuration\n   */\n  static DEFAULT_OPTIONS = {\n    id: \"flash5e-premium-features-dialog\",\n    tag: \"div\",\n    window: {\n      icon: \"fas fa-gem\",\n      title: \"FLASH_ROLLS.settings.premiumFeatures.title\",\n      contentClasses: [\"standard-form\", \"crlngn\", \"flash5e\", \"tabbed-settings\"],\n      resizable: true\n    },\n    position: {\n      width: 620,\n      height: \"auto\"\n    },\n    actions: {\n      authenticatePatreon: PremiumFeaturesDialog.#onAuthenticatePatreon,\n      refreshSession: PremiumFeaturesDialog.#onRefreshSession,\n      logout: PremiumFeaturesDialog.#onLogout,\n      testConnection: PremiumFeaturesDialog.#onTestConnection,\n      testGameLog: PremiumFeaturesDialog.#onTestGameLog,\n      refreshCharacters: PremiumFeaturesDialog.#onRefreshCharacters,\n      mapCharacter: PremiumFeaturesDialog.#onMapCharacter,\n      unlinkCharacter: PremiumFeaturesDialog.#onUnlinkCharacter,\n      importCharacter: PremiumFeaturesDialog.#onImportCharacter,\n      syncCharacter: PremiumFeaturesDialog.#onSyncCharacter,\n      importAll: PremiumFeaturesDialog.#onImportAll,\n      syncAll: PremiumFeaturesDialog.#onSyncAll,\n      save: PremiumFeaturesDialog.#onSave,\n      toggleDdbSettings: PremiumFeaturesDialog.#onToggleDdbSettings\n    }\n  };\n\n  /**\n   * Define template parts for tabbed interface\n   */\n  static PARTS = {\n    tabs: {\n      template: \"templates/generic/tab-navigation.hbs\"\n    },\n    authentication: {\n      template: `modules/${MODULE.ID}/templates/premium-authentication.hbs`\n    },\n    ddbSettings: {\n      template: `modules/${MODULE.ID}/templates/premium-ddb-settings.hbs`\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\"\n    }\n  };\n\n  /**\n   * Tab configuration\n   */\n  static TABS = {\n    primary: {\n      initial: \"authentication\",\n      tabs: [\n        { id: \"authentication\", icon: \"\", group: \"primary-tabs\", label: \"FLASH_ROLLS.settings.premiumFeatures.tabs.authentication\" },\n        { id: \"ddbSettings\", icon: \"\", group: \"primary-tabs\", label: \"FLASH_ROLLS.settings.premiumFeatures.tabs.ddbSettings\" }\n      ],\n      labelPrefix: \"\"\n    }\n  };\n\n  /**\n   * Override changeTab to remember the last active tab\n   * @param {string} tab - The tab id to activate\n   * @param {string} group - The tab group\n   * @param {object} options - Additional options\n   */\n  changeTab(tab, group, options = {}) {\n    super.changeTab(tab, group, options);\n    if (group === \"primary-tabs\") {\n      PremiumFeaturesDialog.setLastActiveTab(tab);\n      if (tab === \"ddbSettings\") {\n        this._autoTestDDBConnection();\n      }\n    }\n  }\n\n  /**\n   * Prepare application rendering context\n   */\n  async _prepareContext(options = {}) {\n    const context = await super._prepareContext(options);\n    return context;\n  }\n\n  /**\n   * Prepare context for each template part\n   * @param {string} partId - The part ID being rendered\n   * @param {Object} context - The base context\n   * @param {Object} options - Render options\n   * @returns {Promise<Object>} The prepared context for this part\n   */\n  async _preparePartContext(partId, context, options) {\n    const partContext = await super._preparePartContext(partId, context, options);\n    const SETTINGS = getSettings();\n\n    if (partId in context.tabs) {\n      partContext.tab = context.tabs[partId];\n    }\n\n    const ddbCampaignId = SettingsUtil.get(SETTINGS.ddbCampaignId.tag) || \"\";\n    const ddbUserId = SettingsUtil.get(SETTINGS.ddbUserId.tag) || \"\";\n    const ddbCobaltCookie = SettingsUtil.get(SETTINGS.ddbCobaltCookie.tag) || \"\";\n    const ddbNoAutoConsumeSpellSlot = SettingsUtil.get(SETTINGS.ddbNoAutoConsumeSpellSlot.tag) || false;\n    const ddbImportOwnership = SettingsUtil.get(SETTINGS.ddbImportOwnership.tag) ?? true;\n    const hasSessionToken = !!PatronSessionManager.getSessionToken();\n\n    const ddbStatusInfo = this._getDDBConnectionStatusInfo(this._ddbGameLogStatus);\n    const patreonStatusInfo = this._getPatreonStatusInfo();\n    const patronStatus = PatronSessionManager.getStatus();\n    const canTestGameLog = patronStatus.isPatron && ddbCampaignId && ddbUserId && ddbCobaltCookie;\n\n    const hasDDBImporter = game.modules.get(\"ddb-importer\")?.active;\n    const canShowCharacters = patronStatus.isPatron && ddbCampaignId && ddbCobaltCookie;\n\n    const charactersWithMapping = this._campaignCharacters.map(char => {\n      const mappingInfo = this._findActorForCharacter(char.id, char.name);\n      return {\n        ...char,\n        mappedActorId: mappingInfo.actor?.id,\n        mappedActorName: mappingInfo.actor?.name,\n        isMapped: !!mappingInfo.actor,\n        mappingSource: mappingInfo.source\n      };\n    });\n\n    switch (partId) {\n      case \"tabs\":\n        break;\n      case \"footer\":\n        partContext.buttons = [\n          { type: \"button\", icon: \"fas fa-save\", label: \"FLASH_ROLLS.ui.buttons.save\", action: \"save\" }\n        ];\n        break;\n      case \"authentication\":\n      case \"ddbSettings\":\n        const mappedCount = charactersWithMapping.filter(c => c.isMapped).length;\n        const unmappedCount = charactersWithMapping.length - mappedCount;\n        const characterCountText = game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.characterCountText\", {\n          count: charactersWithMapping.length\n        });\n        const patronStatus = PatronSessionManager.getStatus();\n        const patronTierName = this._getTierName(patronStatus.tier);\n        Object.assign(partContext, {\n          ddbCampaignId,\n          ddbUserId,\n          ddbCobaltCookie,\n          ddbNoAutoConsumeSpellSlot,\n          ddbImportOwnership,\n          hasSessionToken,\n          proxyAuthUrl: `${PROXY_BASE_URL}/auth/patreon`,\n          patronStatus,\n          patronTierName,\n          patreonStatusClass: patreonStatusInfo.cssClass,\n          patreonStatusIcon: patreonStatusInfo.icon,\n          patreonStatusText: patreonStatusInfo.text,\n          ddbStatusClass: ddbStatusInfo.cssClass,\n          ddbStatusIcon: ddbStatusInfo.icon,\n          ddbStatusText: ddbStatusInfo.text,\n          ddbIsConnected: this._ddbGameLogStatus === \"connected\",\n          patronVerified: patronStatus.isPatron,\n          canShowCharacters: patronStatus.isPatron && canShowCharacters,\n          canTestGameLog: patronStatus.isPatron && canTestGameLog,\n          isLoadingCharacters: this._isLoadingCharacters,\n          campaignCharacters: charactersWithMapping,\n          hasCharacters: charactersWithMapping.length > 0,\n          hasDDBImporter,\n          characterCount: characterCountText,\n          hasMappedCharacters: mappedCount > 0,\n          hasUnmappedCharacters: unmappedCount > 0\n        });\n        break;\n    }\n\n    return partContext;\n  }\n\n  /**\n   * Find a Foundry actor for a DnDB character\n   * @param {string} characterId - DnDB character ID\n   * @param {string} characterName - Character name\n   * @returns {Object} { actor, source }\n   */\n  _findActorForCharacter(characterId, characterName) {\n    const mappings = DnDBeyondIntegration.getMappings();\n    const mappedActorId = mappings[characterId];\n    if (mappedActorId) {\n      const actor = game.actors.get(mappedActorId);\n      if (actor) {\n        return { actor, source: \"manual\" };\n      }\n    }\n\n    const actorByDDBFlag = game.actors.find(a => {\n      const dndbeyond = a.flags?.ddbimporter?.dndbeyond;\n      if (!dndbeyond) return false;\n      if (dndbeyond.characterId && String(dndbeyond.characterId) === String(characterId)) {\n        return true;\n      }\n      if (dndbeyond.roUrl && dndbeyond.roUrl.includes(`/characters/${characterId}`)) {\n        return true;\n      }\n      if (dndbeyond.url && dndbeyond.url.includes(`/characters/${characterId}`)) {\n        return true;\n      }\n      return false;\n    });\n    if (actorByDDBFlag) {\n      return { actor: actorByDDBFlag, source: \"ddbimporter\" };\n    }\n\n    return { actor: null, source: null };\n  }\n\n  /**\n   * Get Patreon status display info\n   * @returns {Object} Status display information\n   */\n  _getPatreonStatusInfo() {\n    const patronStatus = PatronSessionManager.getStatus();\n    if (patronStatus.isPatron) {\n      return {\n        cssClass: \"connected\",\n        icon: \"fa-circle-check\",\n        text: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.patreonVerified\")\n      };\n    }\n    return {\n      cssClass: \"disconnected\",\n      icon: \"fa-circle-xmark\",\n      text: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.patreonNotVerified\")\n    };\n  }\n\n  /**\n   * Get tier name from tier amount in cents\n   * @param {number} tierCents - Tier amount in cents\n   * @returns {string} Tier name\n   */\n  _getTierName(tierCents) {\n    if (!tierCents || tierCents === 0) return \"Free\";\n    if (tierCents >= 99999) return \"Special\";\n    if (tierCents >= 500) return \"Gatewarden\";\n    if (tierCents >= 200) return \"Avowed\";\n    return \"Free\";\n  }\n\n  /**\n   * Get D&D Beyond connection status display info\n   * @param {string} status - Connection status from DnDBeyondIntegration\n   * @returns {Object} Status display information\n   */\n  _getDDBConnectionStatusInfo(status) {\n    switch (status) {\n      case \"connected\":\n        return {\n          cssClass: \"connected\",\n          icon: \"fa-circle-check\",\n          text: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.statusConnected\")\n        };\n      case \"connecting\":\n      case \"testing\":\n        return {\n          cssClass: \"connecting\",\n          icon: \"fa-spinner fa-spin\",\n          text: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.statusConnecting\")\n        };\n      case \"error\":\n        return {\n          cssClass: \"disconnected\",\n          icon: \"fa-circle-xmark\",\n          text: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.statusError\")\n        };\n      case \"unknown\":\n        return {\n          cssClass: \"unknown\",\n          icon: \"\",\n          text: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.statusNotTested\")\n        };\n      default:\n        return {\n          cssClass: \"disconnected\",\n          icon: \"fa-circle-xmark\",\n          text: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.statusDisconnected\")\n        };\n    }\n  }\n\n  /**\n   * Fetch campaign characters from proxy\n   * @param {boolean} [showLoading=true] - Whether to show loading state and trigger re-renders\n   */\n  async _fetchCampaignCharacters(showLoading = true) {\n    const SETTINGS = getSettings();\n    const campaignId = SettingsUtil.get(SETTINGS.ddbCampaignId.tag);\n    const cobaltCookie = SettingsUtil.get(SETTINGS.ddbCobaltCookie.tag);\n    const sessionToken = PatronSessionManager.getSessionToken();\n\n    if (!sessionToken || !campaignId || !cobaltCookie) {\n      return [];\n    }\n\n    try {\n      this._isLoadingCharacters = true;\n      if (showLoading) this._updateRefreshButtonSpinner(true);\n\n      const response = await fetch(`${PROXY_BASE_URL}/ddb/campaign/${campaignId}/characters`, {\n        headers: {\n          \"Authorization\": `Bearer ${sessionToken}`,\n          \"X-Cobalt-Cookie\": cobaltCookie\n        }\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}`);\n      }\n\n      const data = await response.json();\n      this._campaignCharacters = data.characters || [];\n      LogUtil.log(\"PremiumFeaturesDialog: Fetched characters\", [this._campaignCharacters]);\n\n    } catch (error) {\n      LogUtil.error(\"PremiumFeaturesDialog: Failed to fetch characters\", [error]);\n      this._campaignCharacters = [];\n    } finally {\n      this._isLoadingCharacters = false;\n      if (showLoading) {\n        this._updateRefreshButtonSpinner(false);\n        this._updateCharacterList();\n      }\n    }\n  }\n\n  /**\n   * Update the refresh button spinner state\n   * @param {boolean} spinning - Whether the spinner should be spinning\n   */\n  _updateRefreshButtonSpinner(spinning) {\n    const refreshBtn = this.element?.querySelector('[data-action=\"refreshCharacters\"] i');\n    if (refreshBtn) {\n      if (spinning) {\n        refreshBtn.classList.add('fa-spin');\n      } else {\n        refreshBtn.classList.remove('fa-spin');\n      }\n    }\n  }\n\n  /**\n   * Update the character list in the DOM without full re-render\n   */\n  _updateCharacterList() {\n    const fieldset = this.element?.querySelector('.campaign-characters');\n    if (!fieldset) return;\n\n    const hasDDBImporter = game.modules.get(\"ddb-importer\")?.active;\n    const charactersWithMapping = this._campaignCharacters.map(char => {\n      const mappingInfo = this._findActorForCharacter(char.id, char.name);\n      return {\n        ...char,\n        mappedActorId: mappingInfo.actor?.id,\n        mappedActorName: mappingInfo.actor?.name,\n        isMapped: !!mappingInfo.actor,\n        mappingSource: mappingInfo.source\n      };\n    });\n\n    let listHtml = '';\n    if (charactersWithMapping.length > 0) {\n      const mappedCount = charactersWithMapping.filter(c => c.isMapped).length;\n      const unmappedCount = charactersWithMapping.length - mappedCount;\n      const characterCountText = game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.characterCountText\", {\n        count: charactersWithMapping.length\n      });\n\n      listHtml = `\n        <div class=\"character-list-header\">\n          <span class=\"character-count\">${characterCountText}</span>\n          <div class=\"bulk-actions\">\n            <button type=\"button\" data-action=\"importAll\" class=\"import-all-btn\"\n                    ${!hasDDBImporter || unmappedCount === 0 ? 'disabled' : ''}\n                    data-tooltip=\"${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.importAllTooltip')}\">\n              <i class=\"fas fa-download\"></i>\n              ${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.importAll')}\n            </button>\n            <button type=\"button\" data-action=\"syncAll\" class=\"sync-all-btn\"\n                    ${!hasDDBImporter || mappedCount === 0 ? 'disabled' : ''}\n                    data-tooltip=\"${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.syncAllTooltip')}\">\n              <i class=\"fas fa-sync\"></i>\n              ${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.syncAll')}\n            </button>\n          </div>\n        </div>\n        <ul class=\"character-list\">`;\n      for (const char of charactersWithMapping) {\n        const mappedClass = char.isMapped ? 'mapped' : 'unmapped';\n        const avatarHtml = char.avatarUrl\n          ? `<img src=\"${char.avatarUrl}\" alt=\"${char.name}\" />`\n          : '<i class=\"fas fa-user\"></i>';\n\n        const mappingStatusHtml = char.isMapped\n          ? `<span class=\"mapping-status mapped\" data-tooltip=\"${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.mappedTo')} ${char.mappedActorName}\">\n               <i class=\"fas fa-circle-check\"></i> #${char.id}\n             </span>`\n          : `<span class=\"mapping-status unmapped\" data-tooltip=\"${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.notMapped')}\">\n               <i class=\"fas fa-circle-question\"></i> ${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.notMapped')}\n             </span>`;\n\n        const linkBtnHtml = char.isMapped\n          ? `<button type=\"button\" data-action=\"unlinkCharacter\" data-character-id=\"${char.id}\" data-character-name=\"${char.name}\"\n                     class=\"unlink-btn\" data-tooltip=\"${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.unlinkCharacter')}\">\n               <i class=\"fas fa-link-slash\"></i>\n             </button>`\n          : `<button type=\"button\" data-action=\"mapCharacter\" data-character-id=\"${char.id}\" data-character-name=\"${char.name}\"\n                     class=\"map-btn\" data-tooltip=\"${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.mapCharacter')}\">\n               <i class=\"fas fa-link\"></i>\n             </button>`;\n\n        const actionBtnHtml = char.isMapped\n          ? `<button type=\"button\" data-action=\"syncCharacter\" data-character-id=\"${char.id}\" data-actor-id=\"${char.mappedActorId}\"\n                     ${hasDDBImporter ? `data-tooltip=\"${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.syncCharacter')}\"` : `disabled data-tooltip=\"${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.ddbImporterRequired')}\"`}\n                     class=\"sync-btn\"><i class=\"fas fa-sync\"></i></button>`\n          : `<button type=\"button\" data-action=\"importCharacter\" data-character-id=\"${char.id}\" data-character-name=\"${char.name}\"\n                     data-tooltip=\"${hasDDBImporter ? game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.importCharacter') : game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.importCharacterCompendium')}\"\n                     class=\"import-btn\"><i class=\"fas fa-download\"></i></button>`;\n\n        listHtml += `\n          <li class=\"character-item ${mappedClass}\">\n            <div class=\"character-avatar\">${avatarHtml}</div>\n            <div class=\"character-info\">\n              <span class=\"character-name\">${char.name}</span>\n              ${mappingStatusHtml}\n            </div>\n            <div class=\"character-actions\">\n              ${linkBtnHtml}\n              ${actionBtnHtml}\n            </div>\n          </li>`;\n      }\n      listHtml += '</ul>';\n      if (!hasDDBImporter) {\n        listHtml += `<p class=\"hint ddb-importer-hint\"><i class=\"fas fa-info-circle\"></i> ${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.ddbImporterHint')}</p>`;\n      }\n    } else {\n      listHtml = `<p class=\"no-characters\">${game.i18n.localize('FLASH_ROLLS.settings.premiumFeatures.noCharacters')}</p>`;\n    }\n\n    const existingHeader = fieldset.querySelector('.character-list-header');\n    const existingList = fieldset.querySelector('.character-list, .no-characters, .loading-characters');\n    const existingHint = fieldset.querySelector('.ddb-importer-hint');\n    if (existingHeader) existingHeader.remove();\n    if (existingList) existingList.remove();\n    if (existingHint) existingHint.remove();\n\n    const formGroup = fieldset.querySelector('.form-group');\n    if (formGroup) {\n      formGroup.insertAdjacentHTML('beforebegin', listHtml);\n    } else {\n      fieldset.insertAdjacentHTML('beforeend', listHtml);\n    }\n    this._attachCharacterClickListeners();\n  }\n\n  /**\n   * Verify Patreon status\n   */\n  async _verifyPatreonStatus() {\n    const sessionToken = PatronSessionManager.getSessionToken();\n\n    if (!sessionToken) {\n      this._patronVerified = false;\n      return;\n    }\n\n    try {\n      const response = await fetch(`${PROXY_BASE_URL}/auth/status`, {\n        headers: { \"Authorization\": `Bearer ${sessionToken}` }\n      });\n      const data = await response.json();\n      this._patronVerified = data.authenticated && data.isPatron;\n    } catch {\n      this._patronVerified = false;\n    }\n  }\n\n  /**\n   * Handle save button click\n   */\n  static async #onSave(event, target) {\n    const SETTINGS = getSettings();\n\n    const ddbCampaignId = this.element.querySelector('input[name=\"ddbCampaignId\"]')?.value;\n    const ddbUserId = this.element.querySelector('input[name=\"ddbUserId\"]')?.value;\n    const ddbCobaltCookie = this.element.querySelector('input[name=\"ddbCobaltCookie\"]')?.value;\n    const ddbNoAutoConsumeSpellSlot = this.element.querySelector('input[name=\"ddbNoAutoConsumeSpellSlot\"]')?.checked;\n    const ddbImportOwnership = this.element.querySelector('input[name=\"ddbImportOwnership\"]')?.checked;\n\n    if (ddbCampaignId !== undefined) {\n      await SettingsUtil.set(SETTINGS.ddbCampaignId.tag, ddbCampaignId);\n    }\n    if (ddbUserId !== undefined) {\n      await SettingsUtil.set(SETTINGS.ddbUserId.tag, ddbUserId);\n    }\n    if (ddbCobaltCookie !== undefined) {\n      await SettingsUtil.set(SETTINGS.ddbCobaltCookie.tag, ddbCobaltCookie);\n    }\n    if (ddbNoAutoConsumeSpellSlot !== undefined) {\n      await SettingsUtil.set(SETTINGS.ddbNoAutoConsumeSpellSlot.tag, ddbNoAutoConsumeSpellSlot);\n    }\n    if (ddbImportOwnership !== undefined) {\n      await SettingsUtil.set(SETTINGS.ddbImportOwnership.tag, ddbImportOwnership);\n    }\n\n    ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.notifications.settingsUpdated\"));\n    this.close();\n  }\n\n  /**\n   * Handle toggle DDB settings fieldset collapse/expand\n   */\n  static #onToggleDdbSettings(event, target) {\n    const fieldset = target.closest(\".collapsible-fieldset\");\n    if (!fieldset) return;\n\n    const isCollapsed = fieldset.classList.toggle(\"collapsed\");\n    const toggleIcon = fieldset.querySelector(\".toggle-icon\");\n    if (toggleIcon) {\n      toggleIcon.classList.toggle(\"fa-caret-down\", !isCollapsed);\n      toggleIcon.classList.toggle(\"fa-caret-right\", isCollapsed);\n    }\n  }\n\n  /**\n   * Handle Patreon authentication button click\n   */\n  static async #onAuthenticatePatreon(event, target) {\n    console.log(`${MODULE.ID} | Opening Patreon authentication popup`);\n\n    const messageHandler = async (event) => {\n      if (event.origin !== new URL(PROXY_BASE_URL).origin) {\n        console.log(`${MODULE.ID} | Ignoring message from unexpected origin: ${event.origin}`);\n        return;\n      }\n\n      if (event.data && event.data.type === 'patreon-auth-success') {\n        console.log(`${MODULE.ID} | Received auth success message from popup`, event.data);\n        window.removeEventListener('message', messageHandler);\n\n        try {\n          const sessionToken = event.data.sessionToken;\n          if (sessionToken) {\n            PatronSessionManager.setSessionToken(sessionToken);\n            LogUtil.log(\"Session token received and stored\");\n          } else {\n            LogUtil.warn(\"No session token in auth success message\");\n          }\n          const status = await PatronSessionManager.getInstance().validateSession(true);\n          LogUtil.log(\"Session validated successfully\", [status]);\n\n          const instance = PremiumFeaturesDialog.getInstance();\n          if (instance && instance.rendered) {\n            LogUtil.log(\"Refreshing existing dialog\");\n            instance.render();\n          } else {\n            LogUtil.log(\"Opening new dialog\");\n            new PremiumFeaturesDialog().render(true);\n          }\n\n          if (status.isPatron) {\n            ui.notifications.info(\n              game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.connectionSuccess\", {\n                name: status.name || \"Patron\"\n              })\n            );\n            DnDBeyondIntegration.initialize();\n          } else {\n            ui.notifications.warn(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.patreonNotVerified\"));\n          }\n        } catch (err) {\n          LogUtil.error(\"Session validation failed:\", [err]);\n          ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.connectionFailed\"));\n        }\n      }\n    };\n\n    window.addEventListener('message', messageHandler);\n\n    const authWindow = window.open(\n      `${PROXY_BASE_URL}/auth/patreon`,\n      'patreon-auth',\n      'width=600,height=800,left=200,top=100'\n    );\n\n    if (!authWindow) {\n      console.error(`${MODULE.ID} | Popup blocked`);\n      window.removeEventListener('message', messageHandler);\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.popupBlocked\"));\n      return;\n    }\n\n    console.log(`${MODULE.ID} | Popup opened, waiting for success message`);\n\n    setTimeout(() => {\n      window.removeEventListener('message', messageHandler);\n      console.log(`${MODULE.ID} | Message listener timeout after 2 minutes`);\n    }, 120000);\n  }\n\n  /**\n   * Handle refresh session button click\n   */\n  static async #onRefreshSession(event, target) {\n    await PatronSessionManager.getInstance().validateSession(true);\n    this.render();\n  }\n\n  /**\n   * Handle logout button click\n   */\n  static async #onLogout(event, target) {\n    await PatronSessionManager.logout();\n    this.render();\n  }\n\n  /**\n   * Handle test connection button click - validates the current session\n   */\n  static async #onTestConnection(event, target) {\n    const sessionToken = PatronSessionManager.getSessionToken();\n\n    if (!sessionToken) {\n      ui.notifications.warn(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.notConnected\"));\n      return;\n    }\n\n    try {\n      const response = await fetch(`${PROXY_BASE_URL}/auth/status`, {\n        headers: {\n          \"Authorization\": `Bearer ${sessionToken}`\n        }\n      });\n\n      const data = await response.json();\n\n      if (data.authenticated && data.isPatron) {\n        this._patronVerified = true;\n        ui.notifications.info(\n          game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.connectionSuccess\", {\n            name: data.name || \"Patron\"\n          })\n        );\n        this._updatePatreonStatusIndicator();\n        try {\n          await this._fetchCampaignCharacters();\n        } catch (e) {\n          LogUtil.log(\"Character fetch skipped - DDB settings may not be configured yet\");\n        }\n      } else if (data.authenticated && !data.isPatron) {\n        this._patronVerified = false;\n        ui.notifications.warn(\n          game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.notPatron\", {\n            reason: data.reason || \"Unknown\"\n          })\n        );\n        this._updatePatreonStatusIndicator();\n      } else {\n        this._patronVerified = false;\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.connectionFailed\"));\n        this._updatePatreonStatusIndicator();\n      }\n    } catch (error) {\n      LogUtil.error(\"Test connection failed:\", [error]);\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.connectionError\"));\n    }\n  }\n\n  /**\n   * Automatically test DDB connection when switching to ddbSettings tab\n   * Silent test - only updates status indicator, no notifications unless error\n   * @private\n   */\n  async _autoTestDDBConnection() {\n    const patronStatus = PatronSessionManager.getStatus();\n    const sessionToken = PatronSessionManager.getSessionToken();\n    if (!patronStatus.isPatron || !sessionToken) return;\n\n    const SETTINGS = getSettings();\n    const campaignId = SettingsUtil.get(SETTINGS.ddbCampaignId.tag)?.trim();\n    const userId = SettingsUtil.get(SETTINGS.ddbUserId.tag)?.trim();\n    const cobaltCookie = SettingsUtil.get(SETTINGS.ddbCobaltCookie.tag)?.trim();\n\n    if (!campaignId || !userId || !cobaltCookie) return;\n\n    this._ddbGameLogStatus = \"testing\";\n    this._updateDDBStatusIndicator();\n\n    try {\n      const response = await fetch(`${PROXY_BASE_URL}/ddb/test`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Authorization\": `Bearer ${sessionToken}`\n        },\n        body: JSON.stringify({ cobaltCookie, userId, gameId: campaignId })\n      });\n\n      const data = await response.json();\n\n      if (response.ok && data.success) {\n        this._ddbGameLogStatus = \"connected\";\n        this._collapseDdbSettingsFieldset();\n      } else {\n        this._ddbGameLogStatus = \"error\";\n      }\n    } catch (error) {\n      LogUtil.error(\"Auto DDB connection test failed:\", [error]);\n      this._ddbGameLogStatus = \"error\";\n    }\n\n    this._updateDDBStatusIndicator();\n  }\n\n  /**\n   * Handle test game log button click - tests the DDB credentials\n   */\n  static async #onTestGameLog(event, target) {\n    const patronStatus = PatronSessionManager.getStatus();\n    const sessionToken = PatronSessionManager.getSessionToken();\n\n    if (!patronStatus.isPatron || !sessionToken) {\n      await foundry.applications.api.DialogV2.prompt({\n        window: { title: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.label\") },\n        content: `<p>${game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.patreonRequired\")}</p>`,\n        ok: { label: game.i18n.localize(\"Close\") }\n      });\n      return;\n    }\n\n    const campaignId = this.element.querySelector('input[name=\"ddbCampaignId\"]')?.value?.trim();\n    const userId = this.element.querySelector('input[name=\"ddbUserId\"]')?.value?.trim();\n    const cobaltCookie = this.element.querySelector('input[name=\"ddbCobaltCookie\"]')?.value?.trim();\n\n    if (!campaignId || !userId || !cobaltCookie) {\n      ui.notifications.warn(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.missingDDBCredentials\"));\n      return;\n    }\n\n    this._ddbGameLogStatus = \"testing\";\n    this._updateDDBStatusIndicator();\n\n    try {\n      const response = await fetch(`${PROXY_BASE_URL}/ddb/test`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Authorization\": `Bearer ${sessionToken}`\n        },\n        body: JSON.stringify({ cobaltCookie, userId, gameId: campaignId })\n      });\n\n      const data = await response.json();\n\n      if (response.ok && data.success) {\n        this._ddbGameLogStatus = \"connected\";\n        ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.gameLogTestSuccess\"));\n        this._collapseDdbSettingsFieldset();\n      } else {\n        this._ddbGameLogStatus = \"error\";\n        ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.gameLogTestFailed\", { error: data.error || \"Unknown error\" }));\n      }\n    } catch (error) {\n      LogUtil.error(\"Game log test failed:\", [error]);\n      this._ddbGameLogStatus = \"error\";\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.connectionError\"));\n    }\n\n    this._updateDDBStatusIndicator();\n  }\n\n  /**\n   * Handle refresh characters button click\n   */\n  static async #onRefreshCharacters(event, target) {\n    await this._fetchCampaignCharacters();\n  }\n\n  /**\n   * Handle map character button click\n   */\n  static async #onMapCharacter(event, target) {\n    const characterId = target.dataset.characterId;\n    const characterName = target.dataset.characterName;\n    const dialogInstance = this;\n\n    const actors = game.actors.filter(a => a.type === \"character\");\n    const options = actors.map(a => `<option value=\"${a.id}\">${a.name}</option>`).join(\"\");\n\n    const content = `\n      <div class=\"form-group\">\n        <label>${game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.selectActor\")}</label>\n        <select name=\"actorId\">\n          <option value=\"\">${game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.noActor\")}</option>\n          ${options}\n        </select>\n      </div>\n    `;\n\n    const result = await foundry.applications.api.DialogV2.prompt({\n      window: {\n        title: game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.mapCharacterTitle\", { name: characterName }),\n        icon: \"fas fa-link\"\n      },\n      content,\n      ok: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.buttons.save\"),\n        icon: \"fas fa-save\",\n        callback: (event, button, dialog) => button.form.elements.actorId.value\n      },\n      rejectClose: false\n    });\n\n    if (result) {\n      await DnDBeyondIntegration.mapCharacter(characterId, result);\n      ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.characterMapped\"));\n      dialogInstance._updateCharacterList();\n\n      const DDBImporter = game.modules.get(\"ddb-importer\")?.api;\n      if (DDBImporter?.importCharacter) {\n        const actor = game.actors.get(result);\n        if (actor) {\n          try {\n            ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.syncingCharacter\", { name: actor.name }));\n            await DDBImporter.importCharacter({ actor });\n            ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.characterSynced\", { name: actor.name }));\n          } catch (error) {\n            LogUtil.error(\"Character sync after mapping failed:\", [error]);\n            ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.syncFailed\"));\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * Handle unlink character button click\n   */\n  static async #onUnlinkCharacter(event, target) {\n    const characterId = target.dataset.characterId;\n    const characterName = target.dataset.characterName;\n\n    const mappingInfo = this._findActorForCharacter(characterId, characterName);\n    if (!mappingInfo.actor) {\n      await DnDBeyondIntegration.unmapCharacter(characterId);\n      ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.characterUnmapped\"));\n      this._updateCharacterList();\n      return;\n    }\n\n    const confirmed = await foundry.applications.api.DialogV2.confirm({\n      window: {\n        title: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.unlinkCharacter\"),\n        icon: \"fas fa-link-slash\"\n      },\n      content: `<p>${game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.unlinkConfirm\", { name: mappingInfo.actor.name })}</p>`,\n      yes: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.buttons.delete\"),\n        icon: \"fas fa-trash\",\n        class: \"danger\"\n      },\n      no: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.buttons.cancelButton\"),\n        icon: \"fas fa-times\"\n      },\n      rejectClose: false\n    });\n\n    if (!confirmed) return;\n\n    await mappingInfo.actor.delete();\n    await DnDBeyondIntegration.unmapCharacter(characterId);\n    ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.characterUnmapped\"));\n    this._updateCharacterList();\n  }\n\n\n  /**\n   * Handle import character button click\n   * Uses DDB Importer if available, otherwise falls back to compendium matching\n   */\n  static async #onImportCharacter(event, target) {\n    const characterId = target.dataset.characterId;\n    const characterName = target.dataset.characterName;\n    const dialogInstance = this;\n\n    try {\n      ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.importingCharacter\", { name: characterName }));\n\n      const actor = await DnDBCharacterImporter.importCharacter(characterId);\n\n      if (actor) {\n        dialogInstance._updateCharacterList();\n      }\n    } catch (error) {\n      LogUtil.error(\"Character import failed:\", [error]);\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.importFailed\"));\n    }\n  }\n\n  /**\n   * Handle sync character button click (uses ddb-importer)\n   */\n  static async #onSyncCharacter(event, target) {\n    const actorId = target.dataset.actorId;\n\n    if (!game.modules.get(\"ddb-importer\")?.active) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.ddbImporterRequired\"));\n      return;\n    }\n\n    const actor = game.actors.get(actorId);\n    if (!actor) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.actorNotFound\"));\n      return;\n    }\n\n    try {\n      ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.syncingCharacter\", { name: actor.name }));\n\n      const DDBImporter = game.modules.get(\"ddb-importer\")?.api;\n      if (DDBImporter?.importCharacter) {\n        await DDBImporter.importCharacter({ actor });\n        ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.characterSynced\", { name: actor.name }));\n        this._updateCharacterList();\n      } else {\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.ddbImporterAPINotFound\"));\n      }\n    } catch (error) {\n      LogUtil.error(\"Character sync failed:\", [error]);\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.syncFailed\"));\n    }\n  }\n\n  /**\n   * Show/hide bulk operation overlay\n   * @param {boolean} show - Whether to show or hide the overlay\n   * @param {string} message - Message to display in the overlay\n   */\n  _setBulkOperationOverlay(show, message = \"\") {\n    const fieldset = this.element?.querySelector('.campaign-characters');\n    const overlay = this.element?.querySelector('.bulk-operation-overlay');\n    if (!overlay || !fieldset) return;\n\n    const messageEl = overlay.querySelector('.overlay-message');\n    if (messageEl) messageEl.textContent = message;\n\n    if (show) {\n      fieldset.classList.add('bulk-operation-active');\n      overlay.classList.remove('hidden');\n    } else {\n      fieldset.classList.remove('bulk-operation-active');\n      overlay.classList.add('hidden');\n    }\n  }\n\n  /**\n   * Handle import all button click\n   */\n  static async #onImportAll(event, target) {\n    if (!game.modules.get(\"ddb-importer\")?.active) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.ddbImporterRequired\"));\n      return;\n    }\n\n    const unmappedCharacters = (this._campaignCharacters || []).filter(char => {\n      const mappingInfo = this._findActorForCharacter(char.id, char.name);\n      return !mappingInfo.actor;\n    });\n\n    if (unmappedCharacters.length === 0) {\n      ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.noCharactersToImport\"));\n      return;\n    }\n\n    const DDBImporter = game.modules.get(\"ddb-importer\")?.api;\n    if (!DDBImporter?.importCharacter) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.ddbImporterAPINotFound\"));\n      return;\n    }\n\n    let imported = 0;\n    let failed = 0;\n\n    const SETTINGS = getSettings();\n    const giveOwnership = SettingsUtil.get(SETTINGS.ddbImportOwnership.tag) ?? true;\n    const ownershipLevel = giveOwnership ? CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER : CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER;\n\n    for (const char of unmappedCharacters) {\n      this._setBulkOperationOverlay(true, game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.bulkImportProgress\", {\n        current: imported + failed + 1,\n        total: unmappedCharacters.length,\n        name: char.name\n      }));\n\n      try {\n        const actor = await Actor.create({\n          name: char.name || \"New Character\",\n          type: \"character\",\n          ownership: { default: ownershipLevel },\n          flags: {\n            ddbimporter: {\n              dndbeyond: {\n                characterId: char.id,\n                url: `https://www.dndbeyond.com/characters/${char.id}`\n              }\n            }\n          }\n        });\n\n        await DDBImporter.importCharacter({ actor });\n        await DnDBeyondIntegration.mapCharacter(char.id, actor.id);\n        imported++;\n      } catch (error) {\n        LogUtil.error(`Failed to import ${char.name}:`, [error]);\n        failed++;\n      }\n    }\n\n    this._setBulkOperationOverlay(false);\n    ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.bulkImportComplete\", {\n      imported,\n      failed\n    }));\n    this._updateCharacterList();\n  }\n\n  /**\n   * Handle sync all button click\n   */\n  static async #onSyncAll(event, target) {\n    if (!game.modules.get(\"ddb-importer\")?.active) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.ddbImporterRequired\"));\n      return;\n    }\n\n    const mappedCharacters = (this._campaignCharacters || []).filter(char => {\n      const mappingInfo = this._findActorForCharacter(char.id, char.name);\n      return !!mappingInfo.actor;\n    }).map(char => ({\n      ...char,\n      actor: this._findActorForCharacter(char.id, char.name).actor\n    }));\n\n    if (mappedCharacters.length === 0) {\n      ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.noCharactersToSync\"));\n      return;\n    }\n\n    const DDBImporter = game.modules.get(\"ddb-importer\")?.api;\n    if (!DDBImporter?.importCharacter) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.ddbImporterAPINotFound\"));\n      return;\n    }\n\n    let synced = 0;\n    let failed = 0;\n\n    for (const char of mappedCharacters) {\n      this._setBulkOperationOverlay(true, game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.bulkSyncProgress\", {\n        current: synced + failed + 1,\n        total: mappedCharacters.length,\n        name: char.actor.name\n      }));\n\n      try {\n        await DDBImporter.importCharacter({ actor: char.actor });\n        synced++;\n      } catch (error) {\n        LogUtil.error(`Failed to sync ${char.actor.name}:`, [error]);\n        failed++;\n      }\n    }\n\n    this._setBulkOperationOverlay(false);\n    ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.settings.premiumFeatures.bulkSyncComplete\", {\n      synced,\n      failed\n    }));\n    this._updateCharacterList();\n  }\n\n  /**\n   * Load initial data in background - does not block rendering\n   */\n  async _loadInitialData() {\n    if (this._initialDataLoaded) return;\n    this._initialDataLoaded = true;\n\n    const sessionToken = PatronSessionManager.getSessionToken();\n\n    if (sessionToken) {\n      await this._verifyPatreonStatus();\n      this._updatePatreonStatusIndicator();\n      if (this._patronVerified) {\n        this.render({ parts: [\"ddbSettings\"] });\n        await this._fetchCampaignCharacters();\n\n        const activeTab = this.tabGroups[\"primary\"];\n        if (activeTab === \"ddbSettings\") {\n          this._autoTestDDBConnection();\n        }\n      }\n    }\n  }\n\n  /**\n   * Render callback\n   */\n  async _onRender(context, options) {\n    const hintToggles = this.element.querySelectorAll('.toggle-hint');\n    hintToggles.forEach(toggle => {\n      toggle.addEventListener('click', () => {\n        this.element.querySelectorAll('p.hint:not(.on)').forEach(p => p.classList.toggle('shown'));\n      });\n    });\n\n    const campaignIdInput = this.element.querySelector('input[name=\"ddbCampaignId\"]');\n    const userIdInput = this.element.querySelector('input[name=\"ddbUserId\"]');\n    const cobaltCookieInput = this.element.querySelector('input[name=\"ddbCobaltCookie\"]');\n\n    const debouncedRefresh = this._debounce(async () => {\n      if (!PatronSessionManager.isPatron()) return;\n\n      const SETTINGS = getSettings();\n      const campaignId = campaignIdInput?.value?.trim();\n      const userId = userIdInput?.value?.trim();\n      const cobaltCookie = cobaltCookieInput?.value?.trim();\n\n      if (campaignId) await SettingsUtil.set(SETTINGS.ddbCampaignId.tag, campaignId);\n      if (userId) await SettingsUtil.set(SETTINGS.ddbUserId.tag, userId);\n      if (cobaltCookie) await SettingsUtil.set(SETTINGS.ddbCobaltCookie.tag, cobaltCookie);\n\n      await this._fetchCampaignCharacters();\n    }, 1000);\n\n    [campaignIdInput, userIdInput, cobaltCookieInput].forEach(input => {\n      if (input) {\n        input.addEventListener(\"input\", debouncedRefresh);\n      }\n    });\n\n    this._attachCharacterClickListeners();\n\n    this._loadInitialData();\n  }\n\n  /**\n   * Attach click listeners to mapped character items to open their sheets\n   */\n  _attachCharacterClickListeners() {\n    const mappedItems = this.element?.querySelectorAll('.character-item.mapped');\n    mappedItems?.forEach(item => {\n      item.style.cursor = 'pointer';\n      item.addEventListener('click', (event) => {\n        if (event.target.closest('button')) return;\n        event.stopPropagation();\n        const syncBtn = item.querySelector('[data-action=\"syncCharacter\"]');\n        const actorId = syncBtn?.dataset.actorId;\n        if (actorId) {\n          const actor = game.actors.get(actorId);\n          actor?.sheet?.render(true);\n        }\n      });\n    });\n  }\n\n  /**\n   * Debounce helper function\n   * @param {Function} func - Function to debounce\n   * @param {number} wait - Milliseconds to wait\n   * @returns {Function} Debounced function\n   */\n  _debounce(func, wait) {\n    let timeout;\n    return (...args) => {\n      clearTimeout(timeout);\n      timeout = setTimeout(() => func.apply(this, args), wait);\n    };\n  }\n\n  /**\n   * Update the D&D Beyond status indicator directly in the DOM without re-rendering\n   */\n  _updateDDBStatusIndicator() {\n    const indicator = this.element?.querySelector(\".ddb-status .status-indicator\");\n    if (!indicator) return;\n\n    const statusInfo = this._getDDBConnectionStatusInfo(this._ddbGameLogStatus);\n    indicator.className = `status-indicator ${statusInfo.cssClass}`;\n    indicator.querySelector(\"i\").className = `fas ${statusInfo.icon}`;\n    indicator.querySelector(\"span\").textContent = statusInfo.text;\n  }\n\n  /**\n   * Collapse the D&D Beyond settings fieldset after successful connection\n   */\n  _collapseDdbSettingsFieldset() {\n    const fieldset = this.element?.querySelector(\".collapsible-fieldset\");\n    if (!fieldset || fieldset.classList.contains(\"collapsed\")) return;\n\n    fieldset.classList.add(\"collapsed\");\n    const toggleIcon = fieldset.querySelector(\".toggle-icon\");\n    if (toggleIcon) {\n      toggleIcon.classList.remove(\"fa-caret-down\");\n      toggleIcon.classList.add(\"fa-caret-right\");\n    }\n  }\n\n  /**\n   * Update the Patreon status indicator directly in the DOM without re-rendering\n   */\n  _updatePatreonStatusIndicator() {\n    const indicator = this.element?.querySelector(\".patreon-status .status-indicator\");\n    if (!indicator) return;\n\n    const statusInfo = this._getPatreonStatusInfo();\n    indicator.className = `status-indicator ${statusInfo.cssClass}`;\n    indicator.querySelector(\"i\").className = `fas ${statusInfo.icon}`;\n    indicator.querySelector(\"span\").textContent = statusInfo.text;\n  }\n\n  /**\n   * Update the D&D Beyond connection status indicator in the UI\n   * @param {string} status - The connection status\n   */\n  updateDDBConnectionStatus(status) {\n    this._ddbGameLogStatus = status;\n    this._updateDDBStatusIndicator();\n\n    if (status === \"connected\" || status === \"disconnected\") {\n      this._fetchCampaignCharacters();\n    }\n  }\n\n  /**\n   * Update the Patreon status indicator in the UI\n   */\n  updatePatreonStatus() {\n    const indicator = this.element?.querySelector(\".patreon-status .status-indicator\");\n    if (!indicator) return;\n\n    const statusInfo = this._getPatreonStatusInfo();\n\n    indicator.className = `status-indicator ${statusInfo.cssClass}`;\n    indicator.querySelector(\"i\").className = `fas ${statusInfo.icon}`;\n    indicator.querySelector(\"span\").textContent = statusInfo.text;\n  }\n\n  /**\n   * Get the currently open PremiumFeaturesDialog instance\n   * @returns {PremiumFeaturesDialog|null}\n   */\n  static getInstance() {\n    return Object.values(ui.windows).find(w => w instanceof PremiumFeaturesDialog) || null;\n  }\n}\n","import { MODULE, MODULE_ID, ROLL_TYPES } from '../../constants/General.mjs';\nimport { HOOKS_CORE } from '../../constants/Hooks.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SocketUtil } from '../utils/SocketUtil.mjs';\nimport { SidebarController } from '../managers/SidebarController.mjs';\nimport { getPlayerOwner, isPlayerOwned, hasTokenInScene, updateCanvasTokenSelection, delay, buildRollTypes, NotificationManager, filterActorsForDeathSaves, categorizeActorsByOwnership, adjustMenuOffset, getActorData } from '../helpers/Helpers.mjs';\nimport { RollHandlers } from '../handlers/RollHandlers.mjs';\nimport { RollHelpers } from '../helpers/RollHelpers.mjs';\nimport { ensureCombatForInitiative, filterActorsForInitiative } from '../helpers/RollValidationHelpers.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { FlashAPI } from '../core/FlashAPI.mjs';\nimport { ModuleHelpers } from '../helpers/ModuleHelpers.mjs';\nimport { ChatMessageManager } from '../managers/ChatMessageManager.mjs';\nimport { RollMenuActorUtil } from '../utils/RollMenuActorUtil.mjs';\nimport { RollMenuConfig } from '../managers/roll-menu/RollMenuConfig.mjs';\nimport { RollMenuDragManager } from '../managers/roll-menu/RollMenuDragManager.mjs';\nimport { ActorStatusManager } from '../managers/ActorStatusManager.mjs';\nimport { ActorDragUtil } from '../utils/ActorDragUtil.mjs';\nimport { ActorDropUtil } from '../utils/ActorDropUtil.mjs';\nimport { RollMenuEventManager } from '../managers/roll-menu/RollMenuEventManager.mjs';\nimport { RollMenuOrchestrator } from '../managers/roll-menu/RollMenuOrchestrator.mjs';\nimport { RollMenuActorProcessor } from '../managers/roll-menu/RollMenuActorProcessor.mjs';\nimport { RollMenuExecutor } from '../managers/roll-menu/RollMenuExecutor.mjs';\nimport { RollMenuStateManager } from '../managers/roll-menu/RollMenuStateManager.mjs';\nimport { RollMenuStatusManager } from '../managers/roll-menu/RollMenuStatusManager.mjs';\nimport { ModuleSettingsMenu } from '../ui/dialogs/ModuleSettingsMenu.mjs';\nimport { PremiumFeaturesDialog } from '../ui/dialogs/PremiumFeaturesDialog.mjs';\nimport { IconLayoutUtil } from '../utils/IconLayoutUtil.mjs';\nimport { PatronSessionManager } from '../managers/PatronSessionManager.mjs';\n    \n\n/**\n * Roll Requests Menu Application\n * Extends Foundry's ApplicationV2 with Handlebars support to provide a menu interface for GMs to request rolls from players\n */\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\nexport default class RollRequestsMenu extends HandlebarsApplicationMixin(ApplicationV2) {\n  /**\n   * Singleton instance of the menu\n   * @type {RollRequestsMenu|null}\n   */\n  static #instance = null;\n\n  /**\n   * Debounce timer for refresh operations\n   * @type {number|null}\n   */\n  static #refreshDebounceTimer = null;\n\n  /**\n   * Debounce delay in milliseconds\n   * @type {number}\n   */\n  static #REFRESH_DEBOUNCE_DELAY = 250;\n\n  constructor(options = {}) {\n    LogUtil.log('RollRequestsMenu.constructor', [options]);\n    super(options);\n    \n    this.selectedActors = new Set();\n    this.currentTab = 'pc';\n    this.selectedSubmenu = 'request-types';\n    this.selectedRequestType = null;\n    this.isLocked = game.user.getFlag(MODULE.ID, 'menuLocked') ?? false; \n    this.optionsExpanded = game.user.getFlag(MODULE.ID, 'menuOptionsExpanded') ?? false;\n    this.accordionStates = game.user.getFlag(MODULE.ID, 'menuAccordionStates') ?? {};\n    this.groupExpansionStates = game.user.getFlag(MODULE.ID, 'groupExpansionStates') ?? {};\n    this.isSearchFocused = game.user.getFlag('flash-rolls-5e', 'searchFocused') ?? false;\n    this.actorFilters = game.user.getFlag(MODULE.ID, 'actorFilters') ?? {\n      inCombat: false,\n      visible: false,\n      removeDead: false\n    };\n    \n    this.isDragging = false;\n    this.isCustomPosition = false;\n    this.customPosition = RollMenuDragManager.loadCustomPosition();\n  }\n\n  static get DEFAULT_OPTIONS() {\n    SettingsUtil.updateColorScheme();\n    const classes = ['flash-rolls-menu', 'themed'];\n    if (SettingsUtil.coreColorScheme) {\n      classes.push(`theme-${SettingsUtil.coreColorScheme}`);\n    }\n    return {\n      id: 'flash-rolls-menu',\n      classes,\n      tag: 'div',\n      window: {\n        frame: false,\n        resizable: false,\n        minimizable: false\n      },\n      position: {},\n      dragDrop: [\n        {\n          dropSelector: '.actor-list'\n        }\n      ]\n    };\n  }\n\n  static PARTS = {\n    main: {\n      template: `modules/${MODULE.ID}/templates/requests-menu.hbs`\n    }\n  };  \n  \n  async _prepareContext(options) {\n    const context = await super._prepareContext(options);\n    const preparedContext = await RollMenuActorProcessor.prepareActorContext(this, context);\n\n    // Add layout information to context\n    const SETTINGS = getSettings();\n    preparedContext.menuLayout = SettingsUtil.get(SETTINGS.menuLayout.tag);\n    preparedContext.maxIconsPerRow = SettingsUtil.get(SETTINGS.maxIconsPerRow.tag) || 5;\n\n    // Add icon data for dynamic rendering\n    preparedContext.enabledModuleIcons = IconLayoutUtil.getEnabledIcons('moduleActions');\n    preparedContext.enabledActorIcons = IconLayoutUtil.getEnabledIcons('actorActions');\n    preparedContext.iconConfigs = IconLayoutUtil.getIconConfigurations();\n\n    this._lastPreparedContext = preparedContext;\n    return preparedContext;\n  }\n\n\n  /**\n   * Override _renderFrame to control where the element is inserted in the DOM\n   * @override\n   */\n  async _renderFrame(options) {\n    const frame = await super._renderFrame(options);\n    \n    const customPosition = this.customPosition || RollMenuDragManager.loadCustomPosition();\n    if (customPosition?.isCustom) {\n      this.isCustomPosition = true;\n      this.customPosition = customPosition;\n    }\n    \n    const chatNotifications = document.querySelector('#chat-notifications');\n    if (chatNotifications && frame) {\n      chatNotifications.insertBefore(frame, chatNotifications.firstChild);\n    }\n    \n    return frame;\n  }\n\n  /**\n   * Called after the application is rendered\n   * Verifies if roll controls are visible and adjusts the offset of the menu\n   */\n  _onRender(context, options) {\n    super._onRender(context, options);\n\n    const menu = document.querySelector(\"#flash-rolls-menu\");\n    if(menu){\n      const SETTINGS = getSettings();\n      const isCompactMode = SettingsUtil.get(SETTINGS.compactMode.tag);\n      if(isCompactMode){\n        menu.classList.add(\"compact\");\n      }else{\n        menu.classList.remove(\"compact\");\n      }\n\n      const menuLayout = SettingsUtil.get(SETTINGS.menuLayout.tag);\n      menu.setAttribute(\"data-layout\", menuLayout);\n\n      const lockMenuPosition = SettingsUtil.get(SETTINGS.lockMenuPosition.tag);\n      if (lockMenuPosition && this.isLocked) {\n        menu.classList.add('position-locked');\n      } else {\n        menu.classList.remove('position-locked');\n      }\n    }\n    \n    RollMenuDragManager.applyCustomPosition(this, this.customPosition);\n    const dropZones = this.element.querySelectorAll('.actor-list');\n\n    // Remove existing listeners\n    if (this._boundGlobalDragEnd) {\n      document.removeEventListener('dragend', this._boundGlobalDragEnd);\n    }\n\n    dropZones.forEach((zone, index) => {\n      zone.removeEventListener('dragover', this._boundDragOver);\n      zone.removeEventListener('drop', this._boundDrop);\n      zone.removeEventListener('dragenter', this._boundDragEnter);\n      zone.removeEventListener('dragleave', this._boundDragLeave);\n\n      this._boundDragOver = (e) => {\n        this._onDragOver(e);\n      };\n\n      this._boundDrop = (e) => {\n        this._onDrop(e);\n      };\n\n      this._boundDragEnter = (e) => {\n        e.preventDefault();\n      };\n\n      this._boundDragLeave = (e) => {\n        ActorDropUtil.handleDragLeave(e);\n      };\n\n      zone.addEventListener('dragover', this._boundDragOver);\n      zone.addEventListener('drop', this._boundDrop);\n      zone.addEventListener('dragenter', this._boundDragEnter);\n      zone.addEventListener('dragleave', this._boundDragLeave);\n    });\n\n    this._boundGlobalDragEnd = (e) => {\n      this._onGlobalDragEnd(e);\n    };\n    document.addEventListener('dragend', this._boundGlobalDragEnd);\n\n    adjustMenuOffset();\n    \n    if (this.optionsExpanded) {\n      const optionsToggle = this.element.querySelector('.options-toggle');\n      const optionsElement = this.element.querySelector('li.options');\n      const toggleBtn = this.element.querySelector('.options-toggle-btn');\n      \n      optionsToggle?.classList.add('expanded');\n      optionsElement?.classList.add('expanded');\n    }\n    \n    this._tokenControlHook = Hooks.on(HOOKS_CORE.CONTROL_TOKEN, this._onTokenControlChange.bind(this));\n    this._updateItemHook = Hooks.on(HOOKS_CORE.UPDATE_ITEM, this._onItemUpdate.bind(this));\n    this._createItemHook = Hooks.on(HOOKS_CORE.CREATE_ITEM, this._onItemUpdate.bind(this));\n    this._deleteItemHook = Hooks.on(HOOKS_CORE.DELETE_ITEM, this._onItemUpdate.bind(this));\n    this._patronStatusHook = Hooks.on(`${MODULE.ID}.patronStatusChanged`, this._onPatronStatusChange.bind(this));\n\n    ActorDragUtil.initializeActorDrag(this);\n    this._updateRequestTypesVisibilityNoRender();\n    this._updateGemIconStatus();\n\n    RollMenuEventManager.attachListeners(this, this.element);\n  }\n\n  /**\n   * Handle token control changes\n   */\n  _onTokenControlChange(token, controlled) {\n    if (!this.rendered) return;\n\n    if (this._ignoreTokenControl) return;\n    if (this._tokenUpdateTimeout) {\n      clearTimeout(this._tokenUpdateTimeout);\n    }\n\n    this._tokenUpdateTimeout = setTimeout(() => {\n      const previousSelection = new Set(this.selectedActors);\n\n      this._initializeFromSelectedTokens();\n\n      const allActorIds = new Set([...previousSelection, ...this.selectedActors]);\n      for (const actorId of allActorIds) {\n        this._updateActorSelectionUI(actorId);\n      }\n\n      this._updateGroupSelectionUI();\n\n      this._updateSelectAllState();\n      this._updateRequestTypesVisibilityNoRender();\n\n      if (controlled && token?.id) {\n        this._scrollToActor(token.id);\n      }\n\n      this._tokenUpdateTimeout = null;\n    }, 100);\n  }\n\n  /**\n   * Handle patron status changes from PatronSessionManager\n   * Updates the gem icon visual state\n   */\n  _onPatronStatusChange(status) {\n    if (!this.rendered) return;\n    this._updateGemIconStatus();\n  }\n\n  /**\n   * Update the gem icon CSS classes and tooltip based on patron status\n   */\n  _updateGemIconStatus() {\n    if (!this.element) return;\n\n    const premiumBtn = this.element.querySelector('#flash5e-premium-features');\n    const gemIcon = premiumBtn?.querySelector('i.fa-gem');\n    if (!gemIcon) return;\n\n    gemIcon.classList.remove('patron-connected-ddb', 'patron-connected', 'patron-disconnected');\n\n    const patronStatus = PatronSessionManager.getStatus();\n\n    if (patronStatus.isPatron && patronStatus.ddbConnected) {\n      gemIcon.classList.add('patron-connected-ddb', 'gem-icon');\n    } else if (patronStatus.isPatron) {\n      gemIcon.classList.add('patron-connected', 'gem-icon');\n    } else {\n      gemIcon.classList.add('patron-disconnected', 'gem-icon');\n    }\n\n    const title = game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.label\");\n    const patreonLabel = game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.tooltipPatreon\");\n    const ddbLabel = game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.tooltipDDB\");\n    const verifiedText = patronStatus.isPatron\n      ? game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.tooltipVerified\")\n      : game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.tooltipNotVerified\");\n    const ddbText = patronStatus.ddbConnected\n      ? game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.tooltipOn\")\n      : game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.tooltipOff\");\n\n    const tooltip = `<strong>${title}</strong><br/><b>${patreonLabel}</b> ${verifiedText}<br/><b>${ddbLabel}</b> ${ddbText}`;\n    premiumBtn.setAttribute('data-tooltip', tooltip);\n  }\n\n  _scrollToActor(uniqueId) {\n    if (!this.element) return;\n\n    const token = canvas.tokens?.get(uniqueId);\n    if (!token) return;\n\n    const groupId = token.document.getFlag(MODULE_ID, 'groupId');\n\n    if (groupId && this.currentTab === 'group') {\n      const groupElement = this.element.querySelector(`.actor.actor-group[data-actor-id=\"${groupId}\"]`);\n      if (groupElement) {\n        this._scrollElementIntoView(groupElement);\n      }\n      return;\n    }\n\n    let actorElement = this.element.querySelector(`.actor.drag-wrapper[data-id=\"${uniqueId}\"]`);\n    if (!actorElement) return;\n\n    const isGroupMember = actorElement.closest('.group-members');\n    if (isGroupMember) {\n      const groupElement = actorElement.closest('.actor.actor-group');\n      if (groupElement) {\n        actorElement = groupElement;\n      }\n    }\n\n    this._scrollElementIntoView(actorElement);\n  }\n\n  _scrollElementIntoView(element) {\n    if (!element || !this.element) return;\n\n    const scrollContainer = this.element.querySelector('.main-content ul.actors > li.actor-list');\n    if (!scrollContainer) return;\n\n    const containerRect = scrollContainer.getBoundingClientRect();\n    const elementRect = element.getBoundingClientRect();\n\n    const isHorizontal = this.element.dataset.layout === 'horizontal';\n\n    const isOutOfView = isHorizontal\n      ? elementRect.left < containerRect.left || elementRect.right > containerRect.right\n      : elementRect.top < containerRect.top || elementRect.bottom > containerRect.bottom;\n\n    if (isOutOfView) {\n      element.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });\n    }\n  }\n  \n  /**\n   * Handle item updates on actors\n   * Re-renders the menu if the item affects character AC\n   */\n  _onItemUpdate(item, changes, options, userId) {\n    if (!this.rendered) return;\n    \n    const affectsAC = item.type === 'equipment' || \n                      changes.system?.equipped !== undefined ||\n                      changes.system?.attunement !== undefined;\n    if (!affectsAC) return;\n\n    const actor = item.parent;\n    if (!actor || actor.documentName !== 'Actor') return;\n    \n    const currentTab = this.currentTab;\n    const isPlayerOwned = Object.entries(actor.ownership)\n      .some(([uid, level]) => {\n        const user = game.users.get(uid);\n        return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n      });\n    \n    const shouldUpdate = (currentTab === 'pc' && isPlayerOwned) || \n                         (currentTab === 'npc' && !isPlayerOwned && hasTokenInScene(actor)) ||\n                         (currentTab === 'group');\n    \n    if (shouldUpdate) {\n      if (this._itemUpdateTimeout) {\n        clearTimeout(this._itemUpdateTimeout);\n      }\n      \n      this._itemUpdateTimeout = setTimeout(() => {\n        this.render();\n        this._itemUpdateTimeout = null;\n      }, 500);\n    }\n  }\n\n  /**\n   * Handle clicks outside the menu\n   */\n  _onClickOutside = (event) => {\n    const menu = this.element;\n    if (!menu) return;\n\n    // Check if click is on filter tooltip - if outside tooltip, close it (even when locked)\n    const filterTooltip = menu.querySelector('.actor-filter-tooltip');\n    if (filterTooltip && !event.target.closest('.actor-filter-tooltip') && !event.target.closest('#flash5e-filter-actors')) {\n      filterTooltip.remove();\n      return;\n    }\n\n    // Only proceed with menu closing logic if not locked\n    if (this.isLocked) return;\n\n    if (event.target.closest('.flash-rolls-menu')) return;\n    if (menu.contains(event.target)) return;\n    // if (event.target.closest('#flash-rolls-icon')) return;\n    // if (event.target.closest('.dialog, .app, .notification, .application')) return;\n    // if (event.target.closest('.actor-tab')) return;\n    this.close();\n  }\n\n\n  /**\n   * Handle roll requests toggle\n   */\n  async _onToggleRollRequests(event) {\n    return RollMenuStateManager.handleToggleRollRequests(event);\n  }\n\n  /**\n   * Handle skip dialogs toggle\n   */\n  async _onToggleSkipDialogs(event) {\n    return RollMenuStateManager.handleToggleSkipDialogs(event);\n  }\n\n  /**\n   * Handle skip dialogs toggle\n   */\n  async _onToggleGroupRollsMsg(event) {\n    return RollMenuStateManager.handleToggleGroupRollsMsg(event);\n  }\n\n  /**\n   * Handle select all toggle\n   */\n  _onToggleSelectAll(event) {\n    return RollMenuStateManager.handleToggleSelectAll(event, this);\n  }\n\n  /**\n   * Handle actor filter toggle\n   */\n  _onToggleActorFilter(event) {\n    return RollMenuStateManager.handleToggleActorFilter(event, this);\n  }\n\n  /**\n   * Handle lock toggle\n   */\n  _onToggleLock(event) {\n    return RollMenuStateManager.handleToggleLock(event, this);\n  }\n  \n  /**\n   * Handle options toggle\n   */\n  async _onToggleOptions(event) {\n    return RollMenuStateManager.handleToggleOptions(event, this);\n  }\n\n  /**\n   * Handle open settings button click\n   */\n  async _onOpenSettings(event) {\n    event.preventDefault();\n    event.stopPropagation();\n    new ModuleSettingsMenu().render(true);\n  }\n\n  /**\n   * Handle open premium features button click\n   */\n  async _onOpenPremiumFeatures(event) {\n    event.preventDefault();\n    event.stopPropagation();\n    new PremiumFeaturesDialog().render(true);\n  }\n\n  /**\n   * Handle context menu on premium features button\n   * @param {MouseEvent} event - The context menu event\n   */\n  _onPremiumFeaturesContextMenu(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const patronStatus = PatronSessionManager.getStatus();\n    const menuItems = [];\n\n    if (!patronStatus.isPatron) {\n      menuItems.push({\n        name: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.contextReconnect\"),\n        icon: '<i class=\"fab fa-patreon\"></i>',\n        callback: () => {\n          new PremiumFeaturesDialog().render(true);\n        }\n      });\n    }\n\n    if (menuItems.length === 0) return;\n\n    const contextMenu = new foundry.applications.ui.ContextMenu(\n      this.element,\n      '#flash5e-premium-features',\n      menuItems,\n      { eventName: 'contextmenu' }\n    );\n    contextMenu.render(event.currentTarget, { event });\n  }\n\n  /**\n   * Check if the current user can drop actors into the menu\n   * @param {string} selector - The drop target selector\n   * @returns {boolean} Whether the drop is allowed\n   */\n  _canDragDrop(selector) {\n    const canDrop = ActorDropUtil.canDrop(selector);\n    return canDrop;\n  }\n\n  /**\n   * Handle drag over events for visual feedback\n   * @param {DragEvent} event - The drag over event\n   */\n  _onDragOver(event) {\n    ActorDropUtil.handleDragOver(event, this);\n  }\n\n  /**\n   * Handle drop events when actors are dropped into the menu\n   * @param {DragEvent} event - The drop event\n   */\n  async _onDrop(event) {\n    await ActorDropUtil.handleDrop(event, this);\n  }\n\n  /**\n   * Handle global drag end events to reset drag state when any drag operation ends\n   * @param {DragEvent} event - The drag end event\n   */\n  _onGlobalDragEnd(event) {\n    ActorDropUtil.handleDragLeave(event);\n  }\n\n  /**\n   * Override close to clean up global event listeners\n   * @override\n   */\n  async close(options = {}) {\n    if (this._boundGlobalDragEnd) {\n      document.removeEventListener('dragend', this._boundGlobalDragEnd);\n      this._boundGlobalDragEnd = null;\n    }\n\n    return super.close(options);\n  }\n\n  /**\n   * Initialize selected actors from currently selected tokens\n   */\n  _initializeFromSelectedTokens() {\n    LogUtil.log(\"_initializeFromSelectedTokens called\", {\n      _ignoreTokenControl: this._ignoreTokenControl,\n      currentSelectedActors: Array.from(this.selectedActors),\n      controlledTokensCount: canvas.tokens?.controlled?.length || 0\n    });\n\n    const controlledTokens = canvas.tokens?.controlled || [];\n    this.selectedActors.clear();\n\n    for (const token of controlledTokens) {\n      if (token.actor) {\n        const uniqueId = token.id;\n        this.selectedActors.add(uniqueId);\n      }\n    }\n  }\n  \n  /**\n   * Handle tab click\n   */\n  async _onTabClick(event) {\n    const tab = event.currentTarget.dataset.tab;\n    LogUtil.log('_onTabClick #0', [tab]);\n    // if (tab === this.currentTab) return;\n    \n    this.selectedRequestType = null;\n    \n    this.currentTab = tab;\n    await this.render();\n  }\n\n  /**\n   * Handle tab double-click to clear all selections\n   */\n  async _onTabDoubleClick(event) {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    this._ignoreTokenControl = true;\n    this.selectedActors.clear();\n    canvas.tokens?.releaseAll();\n    this.selectedRequestType = null;\n    \n    setTimeout(() => {\n      this._ignoreTokenControl = false;\n    }, 200);\n    \n    await this.render();\n    this._updateRequestTypesVisibility();\n  }\n\n  /**\n   * Handle submenu tab click (rolls vs status effects)\n   */\n  async _onSubmenuTabClick(event) {\n    const tab = event.currentTarget.dataset.tab;\n    LogUtil.log('_onSubmenuTabClick', [tab]);\n    \n    if (tab === this.selectedSubmenu) return;\n    \n    this.selectedSubmenu = tab;\n    await this.render();\n    \n    // Re-apply hover-visible class after render since mouse is still over the menu\n    const accordion = this.element.querySelector('.request-types-accordion');\n    if (accordion && this.selectedActors.size > 0) {\n      accordion.classList.add('hover-visible');\n    }\n  }\n\n  /**\n   * Handle status effect click to apply to selected actors\n   */\n  async _onStatusEffectClick(event) {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const statusEffectId = event.currentTarget.dataset.id;\n    LogUtil.log('_onStatusEffectClick', [statusEffectId]);\n    \n    await RollMenuStatusManager.toggleStatusOnSelected(statusEffectId, this);\n  }\n\n  /**\n   * Handle click on actor row\n   */\n  _onActorClick(event) {\n    if (event.target.closest('.actor-select')) return;\n    \n    const wrapperElement = event.currentTarget;\n    \n    const uniqueId = wrapperElement.dataset.id;\n    const actorId = wrapperElement.dataset.actorId;\n    const tokenId = wrapperElement.dataset.tokenId;\n    \n    // Check if this is a group actor\n    if (wrapperElement.classList.contains('actor-group')) {\n      this._toggleGroupSelection(actorId);\n    } else {\n      this._toggleActorSelection(uniqueId, actorId, tokenId);\n    }\n  }\n  \n  /**\n   * Toggle actor selection state\n   */\n  _toggleActorSelection(uniqueId, actorId, tokenId) {\n    return RollMenuStateManager.toggleActorSelection(uniqueId, actorId, tokenId, this);\n  }\n\n  /**\n   * Toggle group selection - selects/deselects members using stored token associations\n   */\n  async _toggleGroupSelection(groupActorId) {\n    const groupActor = game.actors.get(groupActorId);\n    if (!groupActor || (groupActor.type !== 'group' && groupActor.type !== 'encounter')) {\n      return;\n    }\n\n    // Get stored token associations from flags (new scene-based format)\n    const currentScene = game.scenes.current;\n    const tokenAssociationsByScene = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n    const tokenAssociations = tokenAssociationsByScene[currentScene?.id] || {};\n    const members = [];\n\n\n    // Check if any members have token associations on the current scene\n    const hasAssociationsOnCurrentScene = Object.entries(tokenAssociations).some(([actorId, tokenUuids]) => {\n      if (!Array.isArray(tokenUuids) || tokenUuids.length === 0) return false;\n      return tokenUuids.some(tokenUuid => {\n        try {\n          const tokenDoc = fromUuidSync(tokenUuid);\n          const hasAssociation = tokenDoc && tokenDoc.actorId === actorId && tokenDoc.parent === currentScene;\n          return hasAssociation;\n        } catch (error) {\n          return false;\n        }\n      });\n    });\n\n\n    if (groupActor.type === 'group') {\n      for (const member of groupActor.system.members || []) {\n        if (member.actor) {\n          const memberActorId = member.actor.id;\n          const associatedTokenIds = tokenAssociations[memberActorId] || [];\n\n\n          if (hasAssociationsOnCurrentScene && associatedTokenIds.length > 0) {\n            // Use only tokens from associations that exist on current scene\n            for (const tokenUuid of associatedTokenIds) {\n              try {\n                const tokenDoc = fromUuidSync(tokenUuid);\n                const isValid = tokenDoc && tokenDoc.actorId === member.actor.id && tokenDoc.parent === currentScene;\n                if (isValid) {\n                  members.push({ actor: member.actor, uniqueId: tokenDoc.id });\n                }\n              } catch (error) {\n                LogUtil.log(`Failed to resolve token UUID: ${tokenUuid}`, [error]);\n              }\n            }\n          } else if (!hasAssociationsOnCurrentScene) {\n            const memberTokens = currentScene?.tokens.filter(token => token.actorId === member.actor.id) || [];\n            if (memberTokens.length > 0) {\n              memberTokens.forEach(tokenDoc => {\n                members.push({ actor: member.actor, uniqueId: tokenDoc.id });\n              });\n            } else {\n              members.push({ actor: member.actor, uniqueId: member.actor.id });\n            }\n          }\n        }\n      }\n    } else if (groupActor.type === 'encounter') {\n      for (const member of groupActor.system.members || []) {\n        try {\n          const memberActor = await fromUuid(member.uuid);\n          if (memberActor) {\n            const memberActorId = memberActor.id;\n            const associatedTokenIds = tokenAssociations[memberActorId] || [];\n\n            if (hasAssociationsOnCurrentScene && associatedTokenIds.length > 0) {\n              // Use only tokens from associations that exist on current scene\n              for (const tokenUuid of associatedTokenIds) {\n                try {\n                  const tokenDoc = fromUuidSync(tokenUuid);\n                  if (tokenDoc && tokenDoc.actorId === memberActor.id && tokenDoc.parent === currentScene) {\n                    members.push({ actor: memberActor, uniqueId: tokenDoc.id });\n                  }\n                } catch (error) {\n                  console.warn(`Failed to resolve token UUID: ${tokenUuid}`, error);\n                }\n              }\n            } else if (!hasAssociationsOnCurrentScene) {\n              // No token associations on current scene, fall back to all tokens or base actor\n              const memberTokens = currentScene?.tokens.filter(token => token.actorId === memberActor.id) || [];\n              if (memberTokens.length > 0) {\n                memberTokens.forEach(tokenDoc => {\n                  members.push({ actor: memberActor, uniqueId: tokenDoc.id });\n                });\n              } else {\n                members.push({ actor: memberActor, uniqueId: memberActor.id });\n              }\n            }\n          }\n        } catch (error) {\n          console.warn(`Failed to resolve member UUID: ${member.uuid}`, error);\n        }\n      }\n    }\n\n\n    if (members.length === 0) return;\n\n    // Check if all members are currently selected\n    const allMembersSelected = members.every(member => \n      this.selectedActors.has(member.uniqueId)\n    );\n\n    // Toggle selection for all members\n    for (const member of members) {\n      // If uniqueId is different from actor.id, it's a token ID\n      const tokenId = member.uniqueId !== member.actor.id ? member.uniqueId : null;\n\n      if (allMembersSelected) {\n        // Deselect all members\n        if (this.selectedActors.has(member.uniqueId)) {\n          this._toggleActorSelection(member.uniqueId, member.actor.id, tokenId);\n        }\n      } else {\n        // Select all members\n        if (!this.selectedActors.has(member.uniqueId)) {\n          this._toggleActorSelection(member.uniqueId, member.actor.id, tokenId);\n        }\n      }\n    }\n\n    // Update the group's visual selection state\n    this._updateGroupSelectionUI(groupActorId, members);\n  }\n  \n  /**\n   * Update the visual state of an actor element without re-rendering\n   */\n  _updateActorSelectionUI(actorId) {\n    return RollMenuStateManager.updateActorSelectionUI(actorId, this);\n  }\n\n  /**\n   * Update the visual selection state of group elements\n   * @param {string} [groupActorId] - Optional: specific group actor ID to update\n   * @param {Array} [members] - Optional: group members array\n   */\n  _updateGroupSelectionUI(groupActorId = null, members = null) {\n    if (groupActorId && members) {\n      // Update specific group\n      this._updateSingleGroupSelection(groupActorId, members);\n    } else {\n      // Update all groups - get data from context\n      const context = this._lastPreparedContext || {};\n      const groups = context.groups || [];\n      \n      groups.forEach(groupData => {\n        if (groupData.isGroup && groupData.members) {\n          this._updateSingleGroupSelection(groupData.id, groupData.members);\n        }\n      });\n    }\n  }\n\n  /**\n   * Update selection state for a single group\n   * @param {string} groupActorId - Group actor ID\n   * @param {Array} members - Group members array\n   */\n  _updateSingleGroupSelection(groupActorId, members) {\n    // Find all group elements for this actor (there might be multiple if group has tokens)\n    const groupElements = this.element.querySelectorAll(`[data-actor-id=\"${groupActorId}\"].actor-group`);\n    \n    groupElements.forEach(groupElement => {\n      // Calculate three-state selection value using the members parameter\n      const selectedMembersCount = members.filter(member => \n        this.selectedActors.has(member.uniqueId)\n      ).length;\n      \n      let selectionState;\n      if (selectedMembersCount === 0) {\n        selectionState = 'false';\n      } else if (selectedMembersCount === members.length) {\n        selectionState = 'true';\n      } else {\n        selectionState = 'partial';\n      }\n      \n      // Update data-group-selected attribute with three-state value\n      groupElement.setAttribute('data-group-selected', selectionState);\n      \n      // Remove selected class since we're using data attribute for styling\n      groupElement.classList.remove('selected');\n    });\n  }\n\n  /**\n   * Update request types visibility based on actor selection\n   */\n  _updateRequestTypesVisibility() {\n    return RollMenuStateManager.updateRequestTypesVisibility(this);\n  }\n  \n  /**\n   * Update request types visibility without re-rendering\n   */\n  _updateRequestTypesVisibilityNoRender() {\n    return RollMenuStateManager.updateRequestTypesVisibilityNoRender(this);\n  }\n\n  /**\n   * Update select all checkbox state\n   */\n  _updateSelectAllState() {\n    return RollMenuStateManager.updateSelectAllState(this);\n  }\n\n  /**\n   * Handle search input\n   */\n  _onSearchInput(event) {\n    const searchTerm = event.target.value.toLowerCase().trim();\n    \n    // Handle request-types tab\n    if (this.selectedSubmenu === 'request-types') {\n      const requestTypesContainer = this.element.querySelector('.request-types');\n      if (!requestTypesContainer) return;\n      \n      const requestItems = requestTypesContainer.querySelectorAll('.request-type-item');\n      \n      requestItems.forEach(requestItem => {\n        const requestName = requestItem.querySelector('.request-type-name')?.textContent.toLowerCase() || '';\n        const subItems = requestItem.querySelectorAll('.sub-item');\n        let hasVisibleSubItems = false;\n        \n        if (subItems.length > 0) {\n          subItems.forEach(subItem => {\n            const subItemName = subItem.querySelector('.sub-item-name')?.textContent.toLowerCase() || '';\n            const isVisible = subItemName.includes(searchTerm);\n            subItem.classList.toggle('hidden', !isVisible);\n            if (isVisible) hasVisibleSubItems = true;\n          });\n          \n          const categoryMatches = requestName.includes(searchTerm);\n          const shouldShowCategory = searchTerm === '' || categoryMatches || hasVisibleSubItems;\n          requestItem.classList.toggle('hidden', !shouldShowCategory);\n          \n          if (searchTerm && hasVisibleSubItems) {\n            const nestedList = requestItem.querySelector('.roll-types-nested');\n            const accordionToggle = requestItem.querySelector('.accordion-toggle');\n            if (nestedList && accordionToggle) {\n              nestedList.style.display = 'block';\n              accordionToggle.classList.add('expanded');\n            }\n          }\n        } else {\n          const isVisible = searchTerm === '' || requestName.includes(searchTerm);\n          requestItem.classList.toggle('hidden', !isVisible);\n        }\n      });\n    }\n    // Handle status-effects tab\n    else if (this.selectedSubmenu === 'status-effects') {\n      const statusEffectsContainer = this.element.querySelector('.status-effects');\n      if (!statusEffectsContainer) return;\n      \n      const statusItems = statusEffectsContainer.querySelectorAll('.status-effect');\n      \n      statusItems.forEach(statusItem => {\n        const statusName = statusItem.querySelector('.status-effect-name')?.textContent.toLowerCase() || '';\n        const statusId = statusItem.dataset.id?.toLowerCase() || '';\n        const isVisible = searchTerm === '' || statusName.includes(searchTerm) || statusId.includes(searchTerm);\n        statusItem.classList.toggle('hidden', !isVisible);\n      });\n    }\n  }\n\n  /**\n   * Handle accordion toggle\n   */\n  async _onAccordionToggle(event) {\n    event.stopPropagation();\n    \n    const requestHeader = event.target.closest('.request-type-header');\n    const requestItem = requestHeader.closest('.request-type-item');\n    const requestId = requestItem.dataset.id;\n    const accordionToggle = requestItem.querySelector('.accordion-toggle');\n    const nestedList = requestItem.querySelector('.roll-types-nested');\n    \n    if (!nestedList) return;\n    \n    const isExpanded = accordionToggle.classList.contains('expanded');\n    accordionToggle.classList.toggle('expanded', !isExpanded);\n    nestedList.style.display = isExpanded ? 'none' : 'flex';\n    this.accordionStates[requestId] = !isExpanded;\n    await game.user.setFlag(MODULE.ID, 'menuAccordionStates', this.accordionStates);\n  }\n\n  /**\n   * Handle request type click\n   */\n  async _onRequestTypeClick(event) {\n    const requestItem = event.currentTarget;\n    const requestType = requestItem.dataset.id;\n    const rollOption = MODULE.ROLL_REQUEST_OPTIONS[requestType];\n    \n    if (!rollOption) {\n      LogUtil.error('Unknown request type:', [requestType]);\n      return;\n    }\n    \n    if (this.selectedRequestType === requestType) {\n      this.selectedRequestType = null;\n    } else {\n      this.selectedRequestType = requestType;\n    }\n    \n    if (rollOption.subList) {\n      await this.render();\n    } else if (this.selectedRequestType) {\n      this._triggerRoll(requestType, null);\n    }\n  }\n\n  /**\n   * Handle roll type click (sub-item in accordion)\n   */\n  _onRollTypeClick(event) {\n    LogUtil.log('_onRollTypeClick');\n    const rollKey = event.currentTarget.dataset.id;\n    const parentType = event.currentTarget.dataset.parent;\n    const requestType = parentType || this.selectedRequestType;\n    this._triggerRoll(requestType, rollKey);\n  }\n\n  /**\n   * Handle macro button click\n   */\n  async _onMacroButtonClick(event) {\n    LogUtil.log('_onMacroButtonClick');\n    \n    const element = event.currentTarget;\n    const elementId = element.dataset.id || null;\n    const parentType = element.dataset.parent;\n    \n    // For top-level request types (no parent), the requestType is the element's dataset.id\n    // For sub-items, the requestType is the parentType and rollKey is the element's dataset.id\n    let requestType, rollKey;\n    if (parentType) {\n      // This is a sub-item (like \"Acrobatics\" under \"Skill Check\")\n      requestType = parentType;\n      rollKey = elementId;\n    } else {\n      // This is a top-level item (like \"Intelligence\" ability check)\n      requestType = elementId;\n      rollKey = null; // Top-level items don't have a specific rollKey\n    }\n    \n    if (!requestType) {\n      FlashAPI.notify('warn',\"No roll type selected for macro creation\");\n      return;\n    }\n    \n    // Get currently selected actors\n    const selectedActorIds = Array.from(this.selectedActors);\n    if (selectedActorIds.length === 0) {\n      FlashAPI.notify('warn',\"No actors selected for macro creation\");\n      return;\n    }\n    \n    // Create macro data object\n    const macroData = {\n      requestType,\n      rollKey,\n      actorIds: selectedActorIds,\n      config: {}\n    };\n    \n    try {\n      // Use the API to create the macro\n      await FlashAPI.createMacro(macroData);\n    } catch (error) {\n      LogUtil.error(\"Failed to create macro\", [error]);\n      ui.notifications.error(\"Failed to create macro: \" + error.message);\n    }\n  }\n\n  /**\n   * Defines who rolls for each selected actor (GM or player)\n   * Orchestrates the roll actions accordingly\n   * @param {Object} config - Roll configuration\n   * @param {Array} pcActors - PC actors with owners\n   * @param {Actor[]} npcActors - NPC actors\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {Array} actorsData - Array of actor entries with unique IDs\n   */\n  async _orchestrateRollsForActors(config, pcActors, npcActors, rollMethodName, rollKey, actorsData) {\n    return RollMenuOrchestrator.orchestrateRollsForActors(config, pcActors, npcActors, rollMethodName, rollKey, actorsData);\n  }\n\n  /**\n   * Handle hit die refill dialog for actors with no available hit dice\n   * @param {Actor|Actor[]} actors - Single actor or array of actors to potentially refill hit dice for\n   * @returns {Promise<boolean>} True if refill succeeded or not needed, false if cancelled\n   */\n  async _handleHitDieRefill(actorsToRefill) {\n    return RollMenuOrchestrator.handleHitDieRefill(actorsToRefill);\n  }\n\n  /**\n   * Method called from menu items to trigger the roll for selected actors\n   * @param {string} requestType - The type of roll request (e.g., 'skill', 'ability')\n   * @param {string} rollKey - The specific roll key (e.g., 'acr' for Acrobatics)\n   */\n  async _triggerRoll(requestType, rollKey) {\n    return RollMenuOrchestrator.triggerRoll(requestType, rollKey, this);\n  }\n  \n  /**\n   * Send a roll request to a player\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} config - Roll configuration from dialog\n   * @param {boolean} suppressNotification - If true, don't show individual notification\n   * @param {string} groupRollId - Optional group roll ID for multi-actor rolls\n   */\n  async _sendRollRequestToPlayer(actor, owner, requestType, rollKey, config, suppressNotification = false, groupRollId = null) {\n    return RollMenuOrchestrator.sendRollRequestToPlayer(actor, owner, requestType, rollKey, config, suppressNotification, groupRollId);\n  }\n  \n  /**\n   * Send a consolidated notification for multiple roll requests\n   * @param {Array} successfulRequests - Array of {actor, owner} objects\n   * @param {string} rollMethodName - The type of roll being requested\n   * @param {string} rollKey - The specific roll key (if applicable)\n   */\n  _showConsolidatedNotification(successfulRequests, rollMethodName, rollKey) {\n    return RollMenuOrchestrator.showConsolidatedNotification(successfulRequests, rollMethodName, rollKey);\n  }\n  \n  /**\n   * Handle rolling for NPC actors locally\n   * @param {Actor[]} actors \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  async _handleGMRolls(actors, requestType, rollKey, rollProcessConfig) {\n    return RollMenuExecutor.handleGMRolls(actors, requestType, rollKey, rollProcessConfig);\n  }\n\n  /**\n   * Handle GM rolls with token information preserved\n   * @param {Array} actorEntries - Array of actor entries with unique IDs\n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig \n   */\n  async _handleGMRollsWithTokens(actorEntries, requestType, rollKey, rollProcessConfig) {\n    return RollMenuExecutor.handleGMRollsWithTokens(actorEntries, requestType, rollKey, rollProcessConfig);\n  }\n  \n  /**\n   * Execute local roll for a GM actor with token context\n   * @param {Actor} actor \n   * @param {Token} token \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  async _initiateRollForToken(actor, token, requestType, rollKey, rollProcessConfig) {\n    return RollMenuExecutor.initiateRollForToken(actor, token, requestType, rollKey, rollProcessConfig);\n  }\n\n  /**\n   * Execute local roll for a GM actor\n   * @param {Actor} actor \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  async _initiateRoll(actor, requestType, rollKey, rollProcessConfig) {\n    return RollMenuExecutor.initiateRoll(actor, requestType, rollKey, rollProcessConfig);\n  }\n\n  /**\n   * Clean up when closing\n   */\n  async _onClose(options) {\n    LogUtil.log('_onClose',[options]);\n\n    if(!this.element) { return; }\n    \n    if (this.isCustomPosition && this.element.parentElement === document.body) {\n      const chatNotifications = document.querySelector('#chat-notifications');\n      if (chatNotifications) {\n        chatNotifications.insertBefore(this.element, chatNotifications.firstChild);\n      }\n      this.element.style.position = '';\n      this.element.style.inset = '';\n      this.element.style.top = '';\n      this.element.style.left = '';\n      this.element.style.right = '';\n      this.element.style.bottom = '';\n      this.element.classList.remove('custom-position');\n    }\n    \n    await super._onClose(options);\n    \n    this.selectedActors.clear();\n    this.selectedRequestType = null;\n    document.removeEventListener('click', this._onClickOutside, true);\n    \n    // Clean up search focus flag\n    game.user.setFlag(MODULE_ID, 'searchFocused', false);\n    \n    this._cleanupHooks();\n    this._cleanupTimeouts();\n    \n    if (RollRequestsMenu.#instance === this) {\n      RollRequestsMenu.#instance = null;\n    }\n  }\n\n  /**\n   * Override render positioning to use CSS instead of inline styles\n   */\n  setPosition(position={}) {\n    LogUtil.log('setPosition');\n    // Don't set any inline position styles - let CSS handle it\n    return this;\n  }\n  \n  /**\n   * Clean up hook listeners\n   * @private\n   */\n  _cleanupHooks() {\n    const hooks = [\n      { hook: HOOKS_CORE.CONTROL_TOKEN, property: '_tokenControlHook' },\n      { hook: HOOKS_CORE.UPDATE_ITEM, property: '_updateItemHook' },\n      { hook: HOOKS_CORE.CREATE_ITEM, property: '_createItemHook' },\n      { hook: HOOKS_CORE.DELETE_ITEM, property: '_deleteItemHook' },\n      { hook: `${MODULE.ID}.patronStatusChanged`, property: '_patronStatusHook' }\n    ];\n\n    hooks.forEach(({ hook, property }) => {\n      if (this[property]) {\n        Hooks.off(hook, this[property]);\n        this[property] = null;\n      }\n    });\n  }\n  \n  /**\n   * Clean up timeout references\n   * @private\n   */\n  _cleanupTimeouts() {\n    const timeouts = [\n      '_tokenUpdateTimeout',\n      '_actorUpdateTimeout', \n      '_itemUpdateTimeout'\n    ];\n    \n    timeouts.forEach(property => {\n      if (this[property]) {\n        clearTimeout(this[property]);\n        this[property] = null;\n      }\n    });\n  }\n  \n\n  /**\n   * Toggle the roll requests menu open/closed\n   * @static\n   */\n  static toggle() {\n    \n    // Clean up orphaned menu, if present\n    const existingMenus = document.querySelectorAll('#flash-rolls-menu');\n    existingMenus.forEach(menu => {\n      menu.remove();\n    });\n    \n    if (!this.#instance) {\n      this.#instance = new RollRequestsMenu();\n      this.#instance._initializeFromSelectedTokens();\n      this.#instance.render(true);\n    } else {\n      if (this.#instance.rendered) {\n        this.#instance.close();\n      } else {\n        this.#instance._initializeFromSelectedTokens();\n        this.#instance.render(true);\n      }\n    }\n  }\n\n  /**\n   * Refresh the menu if it's currently open (debounced)\n   * @static\n   * @param {boolean} immediate - If true, refresh immediately without debouncing\n   */\n  static refreshIfOpen(immediate = false) {\n    if (!this.#instance || !this.#instance.rendered) {\n      return;\n    }\n\n    if (immediate) {\n      this._performRefresh();\n      return;\n    }\n\n    if (this.#refreshDebounceTimer) {\n      clearTimeout(this.#refreshDebounceTimer);\n    }\n\n    this.#refreshDebounceTimer = setTimeout(() => {\n      this._performRefresh();\n      this.#refreshDebounceTimer = null;\n    }, this.#REFRESH_DEBOUNCE_DELAY);\n  }\n\n  /**\n   * Perform the actual refresh operation\n   * @static\n   * @private\n   */\n  static _performRefresh() {\n    if (!this.#instance || !this.#instance.rendered) {\n      return;\n    }\n\n    this.#instance.render();\n  }\n\n  /**\n   * Get the current menu instance\n   * @returns {RollRequestsMenu|null} The current instance or null if not created\n   */\n  static getInstance() {\n    return this.#instance;\n  }\n\n  /**\n   * Get DOM elements for currently selected actors\n   * @returns {HTMLElement[]} Array of actor wrapper elements for selected actors\n   */\n  getSelectedActorElements() {\n    if (!this.element) return [];\n    \n    return Array.from(this.element.querySelectorAll('.actor.drag-wrapper.selected'));\n  }\n\n  /**\n   * Show the menu automatically if setting is enabled\n   * Called during module initialization\n   * @static\n   */\n  static showOnLoadIfEnabled() {\n    const SETTINGS = getSettings();\n    const showOnLoad = SettingsUtil.get(SETTINGS.showMenuOnLoad.tag);\n    \n    if (showOnLoad && game.user.isGM) {\n      const existingMenus = document.querySelectorAll('#flash-rolls-menu');\n      existingMenus.forEach(menu => {\n        menu.remove();\n      });\n      \n      if (!this.#instance) {\n        this.#instance = new RollRequestsMenu();\n        this.#instance._initializeFromSelectedTokens();\n      } else if (!this.#instance.rendered) {\n        this.#instance._initializeFromSelectedTokens();\n      }\n\n      this.#instance?.render(true);\n      if (this.#instance) {\n        this.#instance.isLocked = true;\n      }\n    }\n  }\n}\n","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { MODULE_ID } from '../../constants/General.mjs';\nimport { getActorData } from '../helpers/Helpers.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { FlashAPI } from '../core/FlashAPI.mjs';\n\n/**\n * Manages token placement functionality\n * Allows GMs to create and place tokens on canvas by clicking\n */\nexport class TokenPlacementManager {\n\n  static _isPlacingTokens = false;\n  static _previewTokens = [];\n  static _actorsToPlace = [];\n  static _placementIndex = 0;\n  static _canvasClickHandler = null;\n  static _canvasRightClickHandler = null;\n  static _canvasMoveHandler = null;\n  static _canvasRightDownHandler = null;\n  static _canvasRightUpHandler = null;\n  static _rightMouseDown = false;\n\n  /**\n   * Place tokens for selected actors on the canvas\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async placeTokensForSelectedActors(menu) {\n    if (!game.user.isGM) {\n      FlashAPI.notify('warn', \"Only GMs can place tokens\");\n      return;\n    }\n\n    if (menu.selectedActors.size === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelectedForPlacement\"));\n      return;\n    }\n\n    if (this._isPlacingTokens) {\n      FlashAPI.notify('warn', \"Token placement already in progress\");\n      return;\n    }\n\n    const actorsToPlace = [];\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n\n      if (actor.type === 'group' || actor.type === 'encounter') {\n        const members = actor.system.members || [];\n        for (const member of members) {\n          const memberActor = member.actor || (member.uuid ? await fromUuid(member.uuid) : null);\n          if (memberActor) {\n            actorsToPlace.push(memberActor);\n          }\n        }\n      } else {\n        actorsToPlace.push(actor);\n      }\n    }\n\n    if (actorsToPlace.length === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelectedForPlacement\"));\n      return;\n    }\n\n    this._actorsToPlace = actorsToPlace;\n    this._placementIndex = 0;\n    this._isPlacingTokens = true;\n\n    await this._createPreviewTokens();\n    this._attachCanvasHandlers();\n\n    FlashAPI.notify('info', `Click to place ${actorsToPlace.length} token(s) one at a time, right-click to skip current token`);\n  }\n\n  /**\n   * Create preview tokens that follow the mouse cursor\n   */\n  static async _createPreviewTokens() {\n    this._previewTokens = [];\n\n    for (const actor of this._actorsToPlace) {\n      const baseActor = actor.isToken ? actor.baseActor : actor;\n      const tokenData = await baseActor.getTokenDocument();\n\n      const previewData = {\n        ...tokenData.toObject(),\n        x: 0,\n        y: 0,\n        alpha: 0.5,\n        actorLink: false\n      };\n\n      this._previewTokens.push({\n        actor: baseActor,\n        data: previewData\n      });\n    }\n  }\n\n  /**\n   * Attach canvas event handlers for placement\n   */\n  static _attachCanvasHandlers() {\n    this._canvasMoveHandler = (event) => this._onCanvasMouseMove(event);\n    this._canvasClickHandler = (event) => this._onCanvasClick(event);\n    this._canvasRightClickHandler = (event) => this._onCanvasRightClick(event);\n    this._canvasRightDownHandler = (event) => { this._rightMouseDown = true; };\n    this._canvasRightUpHandler = (event) => { this._rightMouseDown = false; };\n\n    canvas.stage.on('mousemove', this._canvasMoveHandler);\n    canvas.stage.on('click', this._canvasClickHandler);\n    canvas.stage.on('rightclick', this._canvasRightClickHandler);\n    canvas.stage.on('rightdown', this._canvasRightDownHandler);\n    canvas.stage.on('rightup', this._canvasRightUpHandler);\n  }\n\n  /**\n   * Handle mouse move to update preview token position\n   * @param {PIXI.InteractionEvent} event - The mouse move event\n   */\n  static async _onCanvasMouseMove(event) {\n    if (!this._isPlacingTokens) return;\n    if (this._placementIndex >= this._previewTokens.length) return;\n\n    const position = event.data.getLocalPosition(canvas.tokens);\n    const snapped = canvas.grid.getSnappedPoint({ x: position.x, y: position.y }, { mode: CONST.GRID_SNAPPING_MODES.CENTER });\n\n    if (canvas.controls?.children) {\n      try {\n        const children = Array.from(canvas.controls.children);\n        for (const child of children) {\n          if (child._flashRollsPlacementPreview) {\n            canvas.controls.removeChild(child);\n            if (child.destroy) child.destroy();\n          }\n        }\n      } catch (error) {\n        LogUtil.warn(\"Error clearing preview graphics\", error);\n      }\n    }\n\n    const currentPreview = this._previewTokens[this._placementIndex];\n    const tokenData = currentPreview.data;\n    const gridSize = canvas.grid.size;\n\n    try {\n      const texture = await foundry.canvas.loadTexture(tokenData.texture.src);\n      const ghostToken = new PIXI.Sprite(texture);\n\n      const tokenWidth = tokenData.width * gridSize;\n      const tokenHeight = tokenData.height * gridSize;\n\n      ghostToken.anchor.set(0);\n      ghostToken.x = snapped.x - tokenWidth / 2;\n      ghostToken.y = snapped.y - tokenHeight / 2;\n      ghostToken.width = tokenWidth;\n      ghostToken.height = tokenHeight;\n      ghostToken.alpha = 0.5;\n      ghostToken.tint = 0x00ccff;\n      ghostToken._flashRollsPlacementPreview = true;\n\n      if (canvas.controls) {\n        canvas.controls.addChild(ghostToken);\n      }\n\n      const progressText = `${this._placementIndex + 1}/${this._previewTokens.length}`;\n      const text = new PIXI.Text(progressText, {\n        fontSize: 20,\n        fill: 0xffffff,\n        stroke: 0x000000,\n        strokeThickness: 4\n      });\n      text.anchor.set(0.5);\n      text.x = snapped.x;\n      text.y = snapped.y - tokenHeight / 2 - 20;\n      text._flashRollsPlacementPreview = true;\n\n      if (canvas.controls) {\n        canvas.controls.addChild(text);\n      }\n    } catch (error) {\n      LogUtil.warn(\"Error drawing placement preview\", error);\n    }\n  }\n\n  /**\n   * Handle canvas click to place current token\n   * @param {PIXI.InteractionEvent} event - The click event\n   */\n  static async _onCanvasClick(event) {\n    if (!this._isPlacingTokens) return;\n    if (this._placementIndex >= this._previewTokens.length) return;\n\n    const position = event.data.getLocalPosition(canvas.tokens);\n    const snapped = canvas.grid.getSnappedPoint({ x: position.x, y: position.y }, { mode: CONST.GRID_SNAPPING_MODES.CENTER });\n\n    const gridSize = canvas.grid.size;\n    const currentPreview = this._previewTokens[this._placementIndex];\n\n    const tokenData = {\n      ...currentPreview.data,\n      x: snapped.x - (currentPreview.data.width * gridSize) / 2,\n      y: snapped.y - (currentPreview.data.height * gridSize) / 2,\n      alpha: 1,\n      actorLink: false\n    };\n\n    try {\n      await canvas.scene.createEmbeddedDocuments('Token', [tokenData]);\n      this._placementIndex++;\n\n      if (this._placementIndex >= this._previewTokens.length) {\n        const totalPlaced = this._previewTokens.length;\n        this._cleanup();\n        FlashAPI.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.tokensPlaced\", {\n          count: totalPlaced\n        }));\n      }\n    } catch (error) {\n      LogUtil.error(\"Failed to create token\", [error, currentPreview.actor.name]);\n    }\n  }\n\n\n  /**\n   * Handle right-click to skip current token\n   * @param {PIXI.InteractionEvent} event - The right-click event\n   */\n  static _onCanvasRightClick(event) {\n    if (!this._isPlacingTokens) return;\n    if (this._placementIndex >= this._previewTokens.length) return;\n\n    if (this._rightMouseDown) {\n      return;\n    }\n\n    event.stopPropagation();\n\n    this._previewTokens.splice(this._placementIndex, 1);\n    this._actorsToPlace.splice(this._placementIndex, 1);\n\n    if (this._previewTokens.length === 0 || this._placementIndex >= this._previewTokens.length) {\n      this._cleanup();\n      FlashAPI.notify('info', game.i18n.localize(\"FLASH_ROLLS.notifications.tokenPlacementCancelled\"));\n    } else {\n      this._clearPreviewGraphics();\n    }\n  }\n\n  /**\n   * Clear all preview graphics from canvas\n   */\n  static _clearPreviewGraphics() {\n    if (!canvas.controls?.children) return;\n\n    try {\n      const children = Array.from(canvas.controls.children);\n      for (const child of children) {\n        if (child._flashRollsPlacementPreview) {\n          canvas.controls.removeChild(child);\n          if (child.destroy) child.destroy();\n        }\n      }\n    } catch (error) {\n      LogUtil.warn(\"Error clearing preview graphics\", error);\n    }\n  }\n\n  /**\n   * Clean up placement mode and handlers\n   */\n  static _cleanup() {\n    this._isPlacingTokens = false;\n    this._previewTokens = [];\n    this._actorsToPlace = [];\n    this._placementIndex = 0;\n\n    if (this._canvasMoveHandler) {\n      canvas.stage.off('mousemove', this._canvasMoveHandler);\n      this._canvasMoveHandler = null;\n    }\n\n    if (this._canvasClickHandler) {\n      canvas.stage.off('click', this._canvasClickHandler);\n      this._canvasClickHandler = null;\n    }\n\n    if (this._canvasRightClickHandler) {\n      canvas.stage.off('rightclick', this._canvasRightClickHandler);\n      this._canvasRightClickHandler = null;\n    }\n\n    if (this._canvasRightDownHandler) {\n      canvas.stage.off('rightdown', this._canvasRightDownHandler);\n      this._canvasRightDownHandler = null;\n    }\n\n    if (this._canvasRightUpHandler) {\n      canvas.stage.off('rightup', this._canvasRightUpHandler);\n      this._canvasRightUpHandler = null;\n    }\n\n    this._rightMouseDown = false;\n\n    this._clearPreviewGraphics();\n  }\n\n  /**\n   * Check if token placement is currently active\n   * @returns {boolean} True if placing tokens\n   */\n  static isPlacing() {\n    return this._isPlacingTokens;\n  }\n\n  /**\n   * Place tokens at a specific location automatically\n   * @param {string[]} actorIds - Array of actor/token IDs to place\n   * @param {Object} location - Location to place tokens {x: number, y: number}\n   */\n  static async placeTokensAtLocation(actorIds, location) {\n    if (!game.user.isGM) {\n      FlashAPI.notify('warn', \"Only GMs can place tokens\");\n      return;\n    }\n\n    if (!actorIds || actorIds.length === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelectedForPlacement\"));\n      return;\n    }\n\n    if (!location || typeof location.x !== 'number' || typeof location.y !== 'number') {\n      ui.notifications.error(\"Invalid location provided for token placement\");\n      return;\n    }\n\n    const actorsToPlace = [];\n\n    for (const uniqueId of actorIds) {\n      const actor = getActorData(uniqueId);\n      if (!actor) {\n        LogUtil.warn(`Could not find actor for ID: ${uniqueId}`);\n        continue;\n      }\n\n      if (actor.type === 'group' || actor.type === 'encounter') {\n        const members = actor.system.members || [];\n        for (const member of members) {\n          const memberActor = member.actor || (member.uuid ? await fromUuid(member.uuid) : null);\n          if (memberActor) {\n            actorsToPlace.push(memberActor);\n          }\n        }\n      } else {\n        actorsToPlace.push(actor);\n      }\n    }\n\n    if (actorsToPlace.length === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelectedForPlacement\"));\n      LogUtil.warn(\"No valid actors found for placement\", actorIds);\n      return;\n    }\n\n    const snapped = canvas.grid.getSnappedPoint({ x: location.x, y: location.y }, { mode: CONST.GRID_SNAPPING_MODES.CENTER });\n    const gridSize = canvas.grid.size;\n    const tokensCreated = [];\n\n    for (const actor of actorsToPlace) {\n      const baseActor = actor.isToken ? actor.baseActor : actor;\n      const tokenData = await baseActor.getTokenDocument();\n\n      const finalTokenData = {\n        ...tokenData.toObject(),\n        x: snapped.x - (tokenData.width * gridSize) / 2,\n        y: snapped.y - (tokenData.height * gridSize) / 2,\n        alpha: 1,\n        actorLink: false\n      };\n\n      try {\n        const created = await canvas.scene.createEmbeddedDocuments('Token', [finalTokenData]);\n        tokensCreated.push(...created);\n      } catch (error) {\n        LogUtil.error(\"Failed to create token\", [error, baseActor.name]);\n      }\n    }\n  }\n}\n","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { MODULE_ID } from '../../constants/General.mjs';\nimport { getActorData } from '../helpers/Helpers.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { FlashAPI } from '../core/FlashAPI.mjs';\n\n/**\n * Manages token teleportation functionality\n * Allows GMs to teleport tokens to different locations or scenes with optional animations\n */\nexport class TokenTeleportManager {\n\n  static _isTeleporting = false;\n  static _isPerformingTeleport = false;\n  static _tokensToTeleport = [];\n  static _tokenDataToTeleport = [];\n  static _sourceScene = null;\n  static _canvasClickHandler = null;\n  static _canvasRightClickHandler = null;\n  static _canvasMoveHandler = null;\n  static _canvasRightDownHandler = null;\n  static _canvasRightUpHandler = null;\n  static _escapeKeyHandler = null;\n  static _targetScene = null;\n  static _rightMouseDown = false;\n  static _rightMouseDownPosition = null;\n  static _hasDragged = false;\n\n  /**\n   * Teleport selected tokens\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async teleportSelectedTokens(menu) {\n    if (!game.user.isGM) {\n      FlashAPI.notify('warn',\"Only GMs can teleport tokens\");\n      return;\n    }\n\n    if (menu.selectedActors.size === 0) {\n      FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.notifications.noTokensSelectedForTeleport\"));\n      return;\n    }\n\n    if (this._isTeleporting) {\n      FlashAPI.notify('warn',\"Teleportation already in progress\");\n      return;\n    }\n\n    const tokensToTeleport = [];\n    const tokenDataToTeleport = [];\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n\n      const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n      const token = tokenId ? canvas.tokens.get(tokenId) : canvas.tokens.placeables.find(t => t.actor?.id === actor.id);\n\n      if (token) {\n        tokensToTeleport.push(token);\n        tokenDataToTeleport.push({\n          id: token.id,\n          sceneId: canvas.scene.id,\n          x: token.document.x,\n          y: token.document.y,\n          width: token.document.width,\n          height: token.document.height,\n          documentData: token.document.toObject()\n        });\n      }\n    }\n\n    if (tokensToTeleport.length === 0) {\n      FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.notifications.noTokensSelectedForTeleport\"));\n      return;\n    }\n\n    this._tokensToTeleport = tokensToTeleport;\n    this._tokenDataToTeleport = tokenDataToTeleport;\n    this._sourceScene = canvas.scene;\n    this._targetScene = canvas.scene;\n    this._isTeleporting = true;\n\n    await this._enterPlacementMode();\n  }\n\n  /**\n   * Get fresh token references from stored data\n   * @returns {Array} Array of token objects\n   */\n  static _getTokensFromData() {\n    const tokens = [];\n    for (const data of this._tokenDataToTeleport) {\n      const scene = game.scenes.get(data.sceneId);\n      if (!scene) continue;\n\n      const token = scene.tokens.get(data.id);\n      if (token) {\n        const tokenObj = canvas.scene.id === data.sceneId ? canvas.tokens.get(data.id) : null;\n        tokens.push(tokenObj || { document: token, id: data.id });\n      }\n    }\n    return tokens;\n  }\n\n  /**\n   * Enter placement mode and show ghost token preview\n   * @param {boolean} showNotification - Whether to show the ready notification\n   */\n  static async _enterPlacementMode(showNotification = true) {\n    if (this._targetScene.id === this._sourceScene.id) {\n      const tokens = this._getTokensFromData();\n      tokens.forEach(token => {\n        if (token.alpha !== undefined) {\n          token.alpha = 0.5;\n        }\n      });\n    }\n\n    this._attachCanvasHandlers();\n\n    const tokenCount = this._tokenDataToTeleport?.length || 0;\n    const sceneName = this._targetScene.name;\n    LogUtil.log(`Teleport ready with ${tokenCount} tokens on scene: ${sceneName}`, this._tokenDataToTeleport);\n\n    if (showNotification) {\n      FlashAPI.notify('info',game.i18n.format(\"FLASH_ROLLS.notifications.teleportReady\", {\n        count: tokenCount\n      }));\n    }\n  }\n\n  /**\n   * Handle scene change during teleport mode\n   * Called from canvasReady hook when user navigates to a new scene\n   */\n  static async _onSceneChange() {\n    if (!this._isTeleporting) {\n      LogUtil.log(\"_onSceneChange called but not teleporting\");\n      return;\n    }\n\n    if (this._targetScene?.id === canvas.scene?.id) {\n      LogUtil.log(\"_onSceneChange - Same scene, skipping\");\n      return;\n    }\n\n    LogUtil.log(\"_onSceneChange - Before cleanup\", {\n      currentScene: canvas.scene?.name,\n      targetScene: this._targetScene?.name,\n      tokenCount: this._tokenDataToTeleport?.length,\n      hasHandlers: {\n        move: !!this._canvasMoveHandler,\n        click: !!this._canvasClickHandler,\n        rightclick: !!this._canvasRightClickHandler\n      }\n    });\n\n    this._targetScene = canvas.scene;\n    LogUtil.log(`Scene changed to ${this._targetScene.name} during teleport`, this._tokenDataToTeleport);\n\n    this._removeCanvasHandlers();\n    this._clearPreviewGraphics();\n\n    LogUtil.log(\"_onSceneChange - About to re-enter placement mode\", {\n      canvasReady: !!canvas?.stage,\n      sceneId: this._targetScene?.id\n    });\n\n    setTimeout(async () => {\n      await this._enterPlacementMode(false);\n\n      LogUtil.log(\"_onSceneChange - After re-entering placement mode\", {\n        hasHandlers: {\n          move: !!this._canvasMoveHandler,\n          click: !!this._canvasClickHandler,\n          rightclick: !!this._canvasRightClickHandler\n        }\n      });\n    }, 100);\n  }\n\n  /**\n   * Attach canvas event handlers for teleportation\n   */\n  static _attachCanvasHandlers() {\n    LogUtil.log(\"Attaching canvas handlers for teleportation\");\n\n    this._canvasMoveHandler = (event) => this._onCanvasMouseMove(event);\n    this._canvasClickHandler = (event) => this._onCanvasClick(event);\n    this._canvasRightClickHandler = (event) => this._onCanvasRightClick(event);\n    this._canvasRightDownHandler = (event) => {\n      const position = event.data.getLocalPosition(canvas.tokens);\n      this._rightMouseDownPosition = { x: position.x, y: position.y };\n      this._hasDragged = false;\n    };\n    this._canvasRightUpHandler = (event) => {\n      setTimeout(() => {\n        this._rightMouseDownPosition = null;\n        this._hasDragged = false;\n      }, 300);\n    };\n    this._escapeKeyHandler = (event) => {\n      if (event.key === 'Escape' && this._isTeleporting) {\n        event.preventDefault();\n        event.stopPropagation();\n        LogUtil.log(\"Cancelling teleport via ESC key\");\n        this._cleanup();\n        FlashAPI.notify('info',game.i18n.localize(\"FLASH_ROLLS.notifications.teleportCancelled\"));\n      }\n    };\n\n    if (!canvas?.stage) {\n      LogUtil.warn(\"Canvas stage not available\");\n      return;\n    }\n\n    canvas.stage.on('mousemove', this._canvasMoveHandler);\n    canvas.stage.on('click', this._canvasClickHandler);\n    canvas.stage.on('rightclick', this._canvasRightClickHandler);\n    canvas.stage.on('rightdown', this._canvasRightDownHandler);\n    canvas.stage.on('rightup', this._canvasRightUpHandler);\n    document.addEventListener('keydown', this._escapeKeyHandler);\n\n    LogUtil.log(\"Canvas handlers attached successfully\");\n  }\n\n  /**\n   * Handle mouse move to show preview\n   * @param {PIXI.InteractionEvent} event - The mouse move event\n   */\n  static async _onCanvasMouseMove(event) {\n    if (this._rightMouseDownPosition) {\n      const position = event.data.getLocalPosition(canvas.tokens);\n      const dragDistance = Math.sqrt(\n        Math.pow(position.x - this._rightMouseDownPosition.x, 2) +\n        Math.pow(position.y - this._rightMouseDownPosition.y, 2)\n      );\n      if (dragDistance > 5) {\n        this._hasDragged = true;\n      }\n    }\n\n    if (!this._isTeleporting || !this._targetScene || this._tokenDataToTeleport.length === 0) {\n      return;\n    }\n\n    if (this._isPerformingTeleport) {\n      return;\n    }\n\n    if (!canvas?.controls) {\n      return;\n    }\n\n    const position = event.data.getLocalPosition(canvas.tokens);\n    const snapped = this._snapToHalfGrid(position.x, position.y);\n\n    if (canvas.controls?.children) {\n      try {\n        const children = Array.from(canvas.controls.children);\n        for (const child of children) {\n          if (child !== this._cursorIndicator && child._flashRollsTeleportPreview) {\n            canvas.controls.removeChild(child);\n            if (child.destroy) child.destroy();\n          }\n        }\n      } catch (error) {\n        LogUtil.warn(\"Error clearing preview graphics\", error);\n      }\n    }\n\n    const sourceGridSize = this._sourceScene.grid.size;\n    const targetGridSize = canvas.grid.size;\n\n    const boundingBox = this._calculateBoundingBox(this._tokenDataToTeleport, sourceGridSize);\n    const groupCenterX = boundingBox.x + boundingBox.width / 2;\n    const groupCenterY = boundingBox.y + boundingBox.height / 2;\n\n    const isSameScene = this._targetScene.id === this._sourceScene.id;\n\n    try {\n      for (let i = 0; i < this._tokenDataToTeleport.length; i++) {\n        const tokenData = this._tokenDataToTeleport[i];\n        const tokenDoc = this._sourceScene.tokens.get(tokenData.id);\n        if (!tokenDoc) continue;\n\n        const sourceTokenWidth = tokenData.width * sourceGridSize;\n        const sourceTokenHeight = tokenData.height * sourceGridSize;\n        const sourceTokenCenterX = tokenData.x + sourceTokenWidth / 2;\n        const sourceTokenCenterY = tokenData.y + sourceTokenHeight / 2;\n\n        const relativeGridX = (sourceTokenCenterX - groupCenterX) / sourceGridSize;\n        const relativeGridY = (sourceTokenCenterY - groupCenterY) / sourceGridSize;\n\n        const newCenterX = snapped.x + (relativeGridX * targetGridSize);\n        const newCenterY = snapped.y + (relativeGridY * targetGridSize);\n\n        const targetTokenWidth = tokenData.width * targetGridSize;\n        const targetTokenHeight = tokenData.height * targetGridSize;\n\n        const newX = newCenterX - targetTokenWidth / 2;\n        const newY = newCenterY - targetTokenHeight / 2;\n\n        const texture = await foundry.canvas.loadTexture(tokenDoc.texture.src);\n        const ghostToken = new PIXI.Sprite(texture);\n        ghostToken.anchor.set(0);\n        ghostToken.x = newX;\n        ghostToken.y = newY;\n        ghostToken.width = targetTokenWidth;\n        ghostToken.height = targetTokenHeight;\n        ghostToken.alpha = 0.5;\n        ghostToken.tint = 0x00ccff;\n        ghostToken._flashRollsTeleportPreview = true;\n        canvas.controls.addChild(ghostToken);\n      }\n    } catch (error) {\n      LogUtil.warn(\"Error drawing teleport preview\", error);\n      return;\n    }\n  }\n\n  /**\n   * Handle canvas click to perform teleportation\n   * @param {PIXI.InteractionEvent} event - The click event\n   */\n  static async _onCanvasClick(event) {\n    if (!this._isTeleporting || this._isPerformingTeleport) return;\n\n    const position = event.data.getLocalPosition(canvas.tokens);\n    const snapped = this._snapToHalfGrid(position.x, position.y);\n\n    await this._performTeleport(snapped);\n  }\n\n  /**\n   * Perform the actual teleportation\n   * @param {Object} destination - The destination point {x, y}\n   */\n  static async _performTeleport(destination) {\n    this._isPerformingTeleport = true;\n\n    const gridSize = this._sourceScene.grid.size;\n    const boundingBox = this._calculateBoundingBox(this._tokenDataToTeleport, gridSize);\n    const groupCenterX = boundingBox.x + boundingBox.width / 2;\n    const groupCenterY = boundingBox.y + boundingBox.height / 2;\n\n    const isSameScene = this._targetScene.id === this._sourceScene.id;\n\n    try {\n      if (isSameScene) {\n        await this._performSameSceneTeleport(destination, groupCenterX, groupCenterY, gridSize);\n      } else {\n        await this._performCrossSceneTeleport(destination, groupCenterX, groupCenterY, gridSize);\n      }\n    } catch (error) {\n      LogUtil.error(\"Failed to teleport tokens\", [error]);\n      ui.notifications.error(\"Failed to teleport tokens\");\n      this._isPerformingTeleport = false;\n      this._cleanup();\n    }\n  }\n\n  /**\n   * Perform teleportation within the same scene with instant movement\n   * @param {Object} destination - The destination point\n   * @param {number} groupCenterX - X coordinate of group center\n   * @param {number} groupCenterY - Y coordinate of group center\n   * @param {number} gridSize - Grid size in pixels\n   */\n  static async _performSameSceneTeleport(destination, groupCenterX, groupCenterY, gridSize) {\n    const SETTINGS = getSettings();\n    const animationPath = SettingsUtil.get(SETTINGS.teleportAnimationPath.tag);\n\n    const tokens = this._getTokensFromData();\n    if (tokens.length === 0) {\n      FlashAPI.notify('warn',\"No valid tokens found for teleportation\");\n      this._cleanup();\n      return [];\n    }\n\n    const fadeUpdates = this._tokenDataToTeleport.map(tokenData => ({\n      _id: tokenData.id,\n      alpha: 0.3\n    }));\n    await this._sourceScene.updateEmbeddedDocuments('Token', fadeUpdates, { animate: false });\n\n    if (animationPath || this._hasJB2A()) {\n      await this._playDepartureAnimations(tokens);\n    }\n\n    const updates = [];\n    const arrivalPositions = [];\n    for (const tokenData of this._tokenDataToTeleport) {\n      const tokenWidth = tokenData.width * gridSize;\n      const tokenHeight = tokenData.height * gridSize;\n      const tokenCenterX = tokenData.x + tokenWidth / 2;\n      const tokenCenterY = tokenData.y + tokenHeight / 2;\n\n      const relativeFromGroupCenterX = tokenCenterX - groupCenterX;\n      const relativeFromGroupCenterY = tokenCenterY - groupCenterY;\n\n      const newCenterX = destination.x + relativeFromGroupCenterX;\n      const newCenterY = destination.y + relativeFromGroupCenterY;\n\n      const snappedPosition = this._sourceScene.grid.getSnappedPoint(\n        { x: newCenterX, y: newCenterY },\n        { mode: CONST.GRID_SNAPPING_MODES.CENTER }\n      );\n\n      const newX = snappedPosition.x - tokenWidth / 2;\n      const newY = snappedPosition.y - tokenHeight / 2;\n\n      updates.push({\n        _id: tokenData.id,\n        x: newX,\n        y: newY,\n        alpha: 0.3\n      });\n\n      arrivalPositions.push({\n        x: snappedPosition.x,\n        y: snappedPosition.y\n      });\n    }\n\n    await this._sourceScene.updateEmbeddedDocuments('Token', updates, { animate: false });\n\n    if (animationPath || this._hasJB2A()) {\n      await this._playArrivalAnimations(arrivalPositions);\n    }\n\n    const showUpdates = this._tokenDataToTeleport.map(tokenData => ({\n      _id: tokenData.id,\n      alpha: 1\n    }));\n\n    await this._sourceScene.updateEmbeddedDocuments('Token', showUpdates, { animate: false });\n\n    const tokenIds = this._tokenDataToTeleport.map(t => t.id);\n    const tokenCount = this._tokenDataToTeleport.length;\n    this._cleanup();\n\n    return tokenIds;\n  }\n\n  /**\n   * Perform teleportation to a different scene\n   * @param {Object} destination - The destination point\n   * @param {number} groupCenterX - X coordinate of group center\n   * @param {number} groupCenterY - Y coordinate of group center\n   * @param {number} sourceGridSize - Source scene grid size in pixels\n   */\n  static async _performCrossSceneTeleport(destination, groupCenterX, groupCenterY, sourceGridSize) {\n    const SETTINGS = getSettings();\n    const animationPath = SettingsUtil.get(SETTINGS.teleportAnimationPath.tag);\n\n    const tokens = this._getTokensFromData();\n    if (tokens.length === 0) {\n      FlashAPI.notify('warn',\"No valid tokens found for teleportation\");\n      this._cleanup();\n      return [];\n    }\n\n    const fadeUpdates = this._tokenDataToTeleport.map(tokenData => ({\n      _id: tokenData.id,\n      alpha: 0.3\n    }));\n    await this._sourceScene.updateEmbeddedDocuments('Token', fadeUpdates, { animate: false });\n\n    if (animationPath || this._hasJB2A()) {\n      await this._playDepartureAnimations(tokens);\n    }\n\n    await this._sourceScene.deleteEmbeddedDocuments('Token', this._tokenDataToTeleport.map(t => t.id));\n\n    const targetGridSize = this._targetScene.grid.size;\n    const tokenCreateData = [];\n    const arrivalPositions = [];\n\n    for (const tokenData of this._tokenDataToTeleport) {\n      const sourceTokenWidth = tokenData.width * sourceGridSize;\n      const sourceTokenHeight = tokenData.height * sourceGridSize;\n      const sourceTokenCenterX = tokenData.x + sourceTokenWidth / 2;\n      const sourceTokenCenterY = tokenData.y + sourceTokenHeight / 2;\n\n      const relativeGridX = (sourceTokenCenterX - groupCenterX) / sourceGridSize;\n      const relativeGridY = (sourceTokenCenterY - groupCenterY) / sourceGridSize;\n\n      const newCenterX = destination.x + (relativeGridX * targetGridSize);\n      const newCenterY = destination.y + (relativeGridY * targetGridSize);\n\n      const snappedPosition = this._targetScene.grid.getSnappedPoint(\n        { x: newCenterX, y: newCenterY },\n        { mode: CONST.GRID_SNAPPING_MODES.CENTER }\n      );\n\n      const targetTokenWidth = tokenData.width * targetGridSize;\n      const targetTokenHeight = tokenData.height * targetGridSize;\n\n      const newX = snappedPosition.x - targetTokenWidth / 2;\n      const newY = snappedPosition.y - targetTokenHeight / 2;\n\n      const data = foundry.utils.duplicate(tokenData.documentData);\n      data.x = newX;\n      data.y = newY;\n\n      tokenCreateData.push(data);\n      arrivalPositions.push({\n        x: snappedPosition.x,\n        y: snappedPosition.y\n      });\n    }\n\n    const createdTokens = await this._targetScene.createEmbeddedDocuments('Token', tokenCreateData.map(data => ({\n      ...data,\n      alpha: 0.3\n    })));\n\n    if (animationPath || this._hasJB2A()) {\n      await this._playArrivalAnimations(arrivalPositions);\n    }\n\n    await this._targetScene.updateEmbeddedDocuments('Token', createdTokens.map(t => ({\n      _id: t.id,\n      alpha: 1\n    })));\n\n    const tokenIds = createdTokens.map(t => t.id);\n    this._cleanup();\n\n    return tokenIds;\n  }\n\n  /**\n   * Play teleport animations (departure and arrival on same scene)\n   * @param {Array} tokens - Tokens to teleport\n   * @param {Object} destination - Destination point\n   * @param {Object} center - Center point of tokens\n   */\n  static async _playTeleportAnimations(tokens, destination, center) {\n    await this._playDepartureAnimations(tokens);\n\n    await new Promise(resolve => setTimeout(resolve, 100));\n\n    const arrivalPositions = tokens.map(token => {\n      const relativeX = token.document.x - center.x;\n      const relativeY = token.document.y - center.y;\n      return {\n        x: destination.x + relativeX + (token.document.width * canvas.grid.size / 2),\n        y: destination.y + relativeY + (token.document.height * canvas.grid.size / 2)\n      };\n    });\n\n    await this._playArrivalAnimations(arrivalPositions);\n  }\n\n  /**\n   * Play departure animations for tokens\n   * @param {Array} tokens - Tokens departing\n   */\n  static async _playDepartureAnimations(tokens) {\n    const SETTINGS = getSettings();\n    let animationPath = SettingsUtil.get(SETTINGS.teleportAnimationPath.tag);\n\n    if (!animationPath && this._hasJB2A()) {\n      animationPath = await this._getDefaultJB2APath();\n    }\n\n    if (!animationPath) return;\n\n    if (this._hasSequencer()) {\n      const gridSize = canvas.grid.size;\n      for (const token of tokens) {\n        const centerX = token.document.x + (token.document.width * gridSize / 2);\n        const centerY = token.document.y + (token.document.height * gridSize / 2);\n\n        new Sequence()\n          .effect()\n          .file(animationPath)\n          .atLocation({ x: centerX, y: centerY })\n          .scale(0.5)\n          .fadeIn(50)\n          .fadeOut(100)\n          .forUsers(game.users.map(u => u.id))\n          .play();\n      }\n\n      await new Promise(resolve => setTimeout(resolve, 400));\n    }\n  }\n\n  /**\n   * Play arrival animations at positions\n   * @param {Array} positions - Array of {x, y} positions\n   */\n  static async _playArrivalAnimations(positions) {\n    const SETTINGS = getSettings();\n    let animationPath = SettingsUtil.get(SETTINGS.teleportAnimationPath.tag);\n\n    if (!animationPath && this._hasJB2A()) {\n      animationPath = await this._getDefaultJB2APath();\n    }\n\n    if (!animationPath) return;\n\n    if (this._hasSequencer()) {\n      for (const pos of positions) {\n        new Sequence()\n          .effect()\n          .file(animationPath)\n          .atLocation(pos)\n          .scale(0.5)\n          .fadeIn(50)\n          .fadeOut(100)\n          .forUsers(game.users.map(u => u.id))\n          .play();\n      }\n\n      await new Promise(resolve => setTimeout(resolve, 250));\n    }\n  }\n\n  /**\n   * Get JB2A module if available\n   * @returns {Module|null} JB2A module or null\n   */\n  static _getJB2AModule() {\n    return game.modules.get('JB2A_DnD5e') || game.modules.get('jb2a_patreon');\n  }\n\n  /**\n   * Check if JB2A module is active\n   * @returns {boolean} True if JB2A is available\n   */\n  static _hasJB2A() {\n    const module = this._getJB2AModule();\n    return module?.active;\n  }\n\n  /**\n   * Check if Sequencer module is active\n   * @returns {boolean} True if Sequencer is available\n   */\n  static _hasSequencer() {\n    return game.modules.get('sequencer')?.active;\n  }\n\n  /**\n   * Get default JB2A teleport animation path\n   * @returns {string} Path to animation\n   */\n  static async _getDefaultJB2APath() {\n    if (this._hasSequencer() && window.Sequencer?.Database) {\n      const possiblePaths = [\n        'jb2a.teleportation.circle.blue',\n        'jb2a.teleport.circle.blue',\n        'jb2a.teleportation.blue'\n      ];\n\n      for (const dbPath of possiblePaths) {\n        if (Sequencer.Database.entryExists(dbPath)) {\n          LogUtil.log(`Found JB2A teleport animation via Sequencer: ${dbPath}`);\n          return dbPath;\n        }\n      }\n    }\n\n    const jb2aModule = this._getJB2AModule();\n    if (jb2aModule?.active) {\n      const modulePath = jb2aModule.id;\n      const filePath = `modules/${modulePath}/Library/Generic/Energy/Teleport/Teleport01_01_Regular_Blue_500x300.webm`;\n\n      LogUtil.log(`Using JB2A teleport animation file path: ${filePath}`);\n      return filePath;\n    }\n\n    LogUtil.warn(\"JB2A module not found, animations disabled\");\n    return null;\n  }\n\n  /**\n   * Create animated cursor indicator\n   */\n  static _createCursorIndicator() {\n    if (!canvas?.controls?.ruler) {\n      LogUtil.warn(\"Canvas controls not ready for cursor indicator\");\n      return;\n    }\n\n    if (this._cursorIndicator) {\n      this._cursorIndicator.destroy({ children: true });\n      this._cursorIndicator = null;\n    }\n\n    if (this._cursorAnimation) {\n      clearInterval(this._cursorAnimation);\n      this._cursorAnimation = null;\n    }\n\n    if (!canvas?.controls) {\n      LogUtil.warn(\"Canvas controls not available for cursor indicator\");\n      return;\n    }\n\n    this._cursorIndicator = new PIXI.Container();\n    this._cursorIndicator.zIndex = 1000;\n    canvas.controls.addChild(this._cursorIndicator);\n\n    const circle1 = new PIXI.Graphics();\n    circle1.lineStyle(3, 0x00ff00, 1);\n    circle1.drawCircle(0, 0, 20);\n    this._cursorIndicator.addChild(circle1);\n\n    const circle2 = new PIXI.Graphics();\n    circle2.lineStyle(3, 0x00ff00, 0.6);\n    circle2.drawCircle(0, 0, 30);\n    this._cursorIndicator.addChild(circle2);\n\n    const circle3 = new PIXI.Graphics();\n    circle3.lineStyle(3, 0x00ff00, 0.3);\n    circle3.drawCircle(0, 0, 40);\n    this._cursorIndicator.addChild(circle3);\n\n    let animationFrame = 0;\n    this._cursorAnimation = setInterval(() => {\n      if (!this._cursorIndicator || !this._cursorIndicator.parent) {\n        if (this._cursorAnimation) {\n          clearInterval(this._cursorAnimation);\n          this._cursorAnimation = null;\n        }\n        return;\n      }\n\n      animationFrame += 0.05;\n\n      const scale1 = 1 + Math.sin(animationFrame) * 0.3;\n      const scale2 = 1 + Math.sin(animationFrame + 1) * 0.3;\n      const scale3 = 1 + Math.sin(animationFrame + 2) * 0.3;\n\n      circle1.alpha = 0.8 + Math.sin(animationFrame) * 0.2;\n      circle2.alpha = 0.5 + Math.sin(animationFrame + 1) * 0.3;\n      circle3.alpha = 0.3 + Math.sin(animationFrame + 2) * 0.2;\n\n      circle1.scale.set(scale1);\n      circle2.scale.set(scale2);\n      circle3.scale.set(scale3);\n    }, 50);\n\n    LogUtil.log(\"Cursor indicator created and animation started\");\n  }\n\n  /**\n   * Handle right-click to cancel teleportation\n   * @param {PIXI.InteractionEvent} event - The right-click event\n   */\n  static _onCanvasRightClick(event) {\n    if (!this._isTeleporting) return;\n\n    if (this._hasDragged) {\n      LogUtil.log(\"Ignoring right-click due to drag\");\n      return;\n    }\n\n    event.stopPropagation();\n    LogUtil.log(\"Cancelling teleport via right-click\");\n    this._cleanup();\n    FlashAPI.notify('info', game.i18n.localize(\"FLASH_ROLLS.notifications.teleportCancelled\"));\n  }\n\n  /**\n   * Calculate center point of multiple positions\n   * @param {Array} positions - Array of {x, y} positions\n   * @returns {Object} Center point {x, y}\n   */\n  static _calculateCenterPoint(positions) {\n    if (positions.length === 0) return { x: 0, y: 0 };\n\n    const sum = positions.reduce((acc, pos) => ({\n      x: acc.x + pos.x,\n      y: acc.y + pos.y\n    }), { x: 0, y: 0 });\n\n    return {\n      x: sum.x / positions.length,\n      y: sum.y / positions.length\n    };\n  }\n\n  /**\n   * Snap position to half-grid intervals\n   * @param {number} x - X coordinate\n   * @param {number} y - Y coordinate\n   * @returns {Object} Snapped position {x, y}\n   */\n  static _snapToHalfGrid(x, y) {\n    const gridSize = canvas.grid.size;\n    const halfGrid = gridSize / 2;\n\n    const snappedX = Math.round(x / halfGrid) * halfGrid;\n    const snappedY = Math.round(y / halfGrid) * halfGrid;\n\n    return { x: snappedX, y: snappedY };\n  }\n\n  /**\n   * Calculate bounding box of multiple tokens\n   * @param {Array} tokenDataArray - Array of token data objects with {x, y, width, height}\n   * @param {number} gridSize - Grid size in pixels\n   * @returns {Object} Bounding box {x, y, width, height}\n   */\n  static _calculateBoundingBox(tokenDataArray, gridSize) {\n    if (tokenDataArray.length === 0) return { x: 0, y: 0, width: 0, height: 0 };\n\n    let minX = Infinity;\n    let minY = Infinity;\n    let maxX = -Infinity;\n    let maxY = -Infinity;\n\n    for (const tokenData of tokenDataArray) {\n      const tokenWidth = tokenData.width * gridSize;\n      const tokenHeight = tokenData.height * gridSize;\n\n      minX = Math.min(minX, tokenData.x);\n      minY = Math.min(minY, tokenData.y);\n      maxX = Math.max(maxX, tokenData.x + tokenWidth);\n      maxY = Math.max(maxY, tokenData.y + tokenHeight);\n    }\n\n    return {\n      x: minX,\n      y: minY,\n      width: maxX - minX,\n      height: maxY - minY\n    };\n  }\n\n  /**\n   * Calculate relative positions of tokens from a center point\n   * @param {Array} tokens - Array of tokens\n   * @returns {Array} Array of {token, relativeX, relativeY}\n   */\n  static _calculateRelativePositions(tokens) {\n    const positions = tokens.map(t => ({ x: t.document.x, y: t.document.y }));\n    const center = this._calculateCenterPoint(positions);\n\n    return tokens.map(token => ({\n      token: token,\n      relativeX: token.document.x - center.x,\n      relativeY: token.document.y - center.y\n    }));\n  }\n\n  /**\n   * Remove canvas event handlers without cleaning up state\n   */\n  static _removeCanvasHandlers() {\n    if (this._canvasMoveHandler) {\n      canvas.stage?.off('mousemove', this._canvasMoveHandler);\n      this._canvasMoveHandler = null;\n    }\n\n    if (this._canvasClickHandler) {\n      canvas.stage?.off('click', this._canvasClickHandler);\n      this._canvasClickHandler = null;\n    }\n\n    if (this._canvasRightClickHandler) {\n      canvas.stage?.off('rightclick', this._canvasRightClickHandler);\n      this._canvasRightClickHandler = null;\n    }\n\n    if (this._canvasRightDownHandler) {\n      canvas.stage?.off('rightdown', this._canvasRightDownHandler);\n      this._canvasRightDownHandler = null;\n    }\n\n    if (this._canvasRightUpHandler) {\n      canvas.stage?.off('rightup', this._canvasRightUpHandler);\n      this._canvasRightUpHandler = null;\n    }\n\n    if (this._escapeKeyHandler) {\n      document.removeEventListener('keydown', this._escapeKeyHandler);\n      this._escapeKeyHandler = null;\n    }\n  }\n\n  /**\n   * Clean up teleportation mode and handlers\n   */\n  static _cleanup() {\n    const tokens = this._getTokensFromData();\n    tokens.forEach(token => {\n      if (token.alpha !== undefined) {\n        token.alpha = 1;\n      }\n    });\n\n    this._clearPreviewGraphics();\n\n    this._isTeleporting = false;\n    this._isPerformingTeleport = false;\n    this._tokensToTeleport = [];\n    this._tokenDataToTeleport = [];\n    this._sourceScene = null;\n    this._targetScene = null;\n    this._rightMouseDown = false;\n    this._rightMouseDownPosition = null;\n\n    this._removeCanvasHandlers();\n  }\n\n  /**\n   * Clear all preview graphics from canvas\n   */\n  static _clearPreviewGraphics() {\n    if (!canvas?.controls?.children) return;\n\n    try {\n      const children = Array.from(canvas.controls.children);\n      for (const child of children) {\n        if (child._flashRollsTeleportPreview) {\n          canvas.controls.removeChild(child);\n          child.destroy();\n        }\n      }\n    } catch (error) {\n      LogUtil.warn(\"Error clearing preview graphics\", error);\n    }\n\n    this._rightMouseDown = false;\n    this._rightMouseDownPosition = null;\n  }\n\n  /**\n   * Check if teleportation is currently active\n   * @returns {boolean} True if teleporting\n   */\n  static isTeleporting() {\n    return this._isTeleporting;\n  }\n\n  /**\n   * Teleport tokens to a specific destination scene and location automatically\n   * @param {string[]} actorIds - Array of actor/token IDs to teleport\n   * @param {string|Object} destinationScene - Scene ID, name, or scene object\n   * @param {Object} centerLocation - Center location {x: number, y: number}\n   */\n  static async teleportToDestination(actorIds, destinationScene, centerLocation) {\n    if (!game.user.isGM) {\n      FlashAPI.notify('warn',\"Only GMs can teleport tokens\");\n      return;\n    }\n\n    if (this._isPerformingTeleport) {\n      LogUtil.log('Teleport already in progress, queueing...');\n      await new Promise(resolve => {\n        const checkInterval = setInterval(() => {\n          if (!this._isPerformingTeleport) {\n            clearInterval(checkInterval);\n            resolve();\n          }\n        }, 50);\n      });\n    }\n\n    if (!actorIds || actorIds.length === 0) {\n      FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.notifications.noTokensSelectedForTeleport\"));\n      return;\n    }\n\n    if (!destinationScene || !centerLocation || typeof centerLocation.x !== 'number' || typeof centerLocation.y !== 'number') {\n      ui.notifications.error(\"Invalid destination scene or location provided for teleportation\");\n      return;\n    }\n\n    let targetScene;\n    if (typeof destinationScene === 'string') {\n      targetScene = game.scenes.get(destinationScene) || game.scenes.getName(destinationScene);\n      if (!targetScene) {\n        ui.notifications.error(`Scene \"${destinationScene}\" not found`);\n        return;\n      }\n    } else if (destinationScene instanceof Scene) {\n      targetScene = destinationScene;\n    } else {\n      ui.notifications.error(\"Invalid destination scene provided\");\n      return;\n    }\n\n    const tokensToTeleport = [];\n    const tokenDataToTeleport = [];\n    const invalidIds = [];\n\n    for (const tokenId of actorIds) {\n      const token = canvas.tokens.get(tokenId);\n\n      if (token) {\n        tokensToTeleport.push(token);\n        tokenDataToTeleport.push({\n          id: token.id,\n          sceneId: canvas.scene.id,\n          x: token.document.x,\n          y: token.document.y,\n          width: token.document.width,\n          height: token.document.height,\n          documentData: token.document.toObject()\n        });\n      } else {\n        invalidIds.push(tokenId);\n      }\n    }\n\n    if (invalidIds.length > 0) {\n      LogUtil.warn(`Invalid token IDs provided: ${invalidIds.join(', ')}`);\n      if (tokensToTeleport.length === 0) {\n        ui.notifications.error(\"No valid tokens found. Ensure you're using token IDs, not actor IDs.\");\n        return;\n      } else {\n        FlashAPI.notify('warn',`Some token IDs were invalid and skipped. ${tokensToTeleport.length} token(s) will be teleported.`);\n      }\n    }\n\n    if (tokensToTeleport.length === 0) {\n      FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.notifications.noTokensSelectedForTeleport\"));\n      return;\n    }\n\n    this._tokensToTeleport = tokensToTeleport;\n    this._tokenDataToTeleport = tokenDataToTeleport;\n    this._sourceScene = canvas.scene;\n    this._targetScene = targetScene;\n    this._isTeleporting = true;\n    this._isPerformingTeleport = true;\n\n    const snapped = targetScene.grid.getSnappedPoint(centerLocation, { mode: CONST.GRID_SNAPPING_MODES.CENTER });\n\n    const sourceGridSize = canvas.scene.grid.size;\n    const boundingBox = this._calculateBoundingBox(tokenDataToTeleport, sourceGridSize);\n    const groupCenterX = boundingBox.x + boundingBox.width / 2;\n    const groupCenterY = boundingBox.y + boundingBox.height / 2;\n\n    let teleportedTokenIds = [];\n    try {\n      if (targetScene.id === canvas.scene.id) {\n        teleportedTokenIds = await this._performSameSceneTeleport(snapped, groupCenterX, groupCenterY, sourceGridSize);\n      } else {\n        await targetScene.view();\n        teleportedTokenIds = await this._performCrossSceneTeleport(snapped, groupCenterX, groupCenterY, sourceGridSize);\n      }\n    } catch (error) {\n      LogUtil.error(\"Error during teleportation\", [error]);\n      this._cleanup();\n      throw error;\n    }\n\n    if (teleportedTokenIds.length > 0) {\n      await new Promise(resolve => setTimeout(resolve, 50));\n\n      const teleportedTokens = teleportedTokenIds\n        .map(id => canvas.tokens.get(id))\n        .filter(t => t);\n\n      if (teleportedTokens.length > 0) {\n        canvas.tokens.releaseAll();\n        teleportedTokens.forEach(token => token.control({ releaseOthers: false }));\n\n        const avgX = teleportedTokens.reduce((sum, t) => sum + t.center.x, 0) / teleportedTokens.length;\n        const avgY = teleportedTokens.reduce((sum, t) => sum + t.center.y, 0) / teleportedTokens.length;\n        await canvas.animatePan({ x: avgX, y: avgY, duration: 150 });\n      }\n    }\n  }\n}\n","import { LogUtil } from \"../../utils/LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../constants/General.mjs\";\nimport { GeneralUtil } from \"../../utils/GeneralUtil.mjs\";\nimport { FlashAPI } from \"../../core/FlashAPI.mjs\";\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\nconst { FormDataExtended } = foundry.applications.ux;\n\n/**\n * Dialog for selecting transformation target and settings\n */\nexport class TransformationDialog extends HandlebarsApplicationMixin(ApplicationV2) {\n\n  /**\n   * Show transformation dialog and return selected options\n   * @param {Actor[]} actors - Actors being transformed\n   * @returns {Promise<Object|null>} Object with targetActor, settings, renderSheet, or null if cancelled\n   */\n  static async show(actors) {\n    return new Promise((resolve) => {\n      const dialog = new this({\n        actors,\n        resolve\n      });\n      dialog.render(true);\n    });\n  }\n\n  static DEFAULT_OPTIONS = {\n    id: \"flash5e-transformation-dialog\",\n    tag: \"form\",\n    window: {\n      title: \"\",//FLASH_ROLLS.ui.dialogs.transformation.title\n      icon: \"fa-solid fa-frog\",\n      contentClasses: [\"standard-form\", \"crlngn\", \"flash5e\", \"transformation-dialog\"]\n    },\n    position: {\n      width: 560,\n      height: \"auto\"\n    },\n    form: {\n      handler: TransformationDialog.#onSubmit,\n      submitOnChange: false,\n      closeOnSubmit: false\n    },\n    actions: {\n      transform: TransformationDialog.#onTransform,\n      cancel: TransformationDialog.#onCancel\n    }\n  };\n\n  static PARTS = {\n    content: {\n      template: `modules/${MODULE_ID}/templates/transformation-dialog.hbs`\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\"\n    }\n  };\n\n  constructor(options = {}) {\n    super(options);\n\n    this.actors = options.actors || [];\n    this.resolve = options.resolve;\n    this.selectedActorUuid = null;\n    this.selectedActorName = \"\";\n    this.selectedPreset = \"polymorph\";\n    this.showCustomSettings = false;\n  }\n\n  async _prepareContext(options) {\n    const context = await super._prepareContext(options);\n    return context;\n  }\n\n  async _preparePartContext(partId, context, options) {\n    context = await super._preparePartContext(partId, context, options);\n\n    switch (partId) {\n      case \"content\": {\n        context.actors = this.actors;\n        context.actorCount = this.actors.length;\n        context.actorNames = this.actors.map(a => a.name).join(\", \");\n        context.selectedActorName = this.selectedActorName;\n\n        const favoritesData = game.settings.get(\"flash-rolls-5e\", \"transform-favorites\") || [];\n        const favoriteUuids = new Set(favoritesData);\n\n        context.favorites = [];\n        for (const uuid of favoritesData) {\n          const actor = await fromUuid(uuid);\n          if (actor) {\n            context.favorites.push({\n              uuid,\n              name: actor.name,\n              img: actor.img\n            });\n          }\n        }\n\n        if (this.selectedActorUuid) {\n          const actor = await fromUuid(this.selectedActorUuid);\n          context.selectedActor = {\n            uuid: this.selectedActorUuid,\n            name: this.selectedActorName,\n            img: actor?.img,\n            isFavorite: favoriteUuids.has(this.selectedActorUuid)\n          };\n        } else {\n          context.selectedActor = null;\n        }\n\n        context.selectedPreset = this.selectedPreset;\n        context.showCustomSettings = this.showCustomSettings;\n        context.presets = [\n          {\n            value: \"polymorph\",\n            label: \"FLASH_ROLLS.ui.dialogs.transformation.presets.polymorph\",\n            description: \"FLASH_ROLLS.ui.dialogs.transformation.presets.polymorphDesc\"\n          },\n          {\n            value: \"wildshape\",\n            label: \"FLASH_ROLLS.ui.dialogs.transformation.presets.wildshape\",\n            description: \"FLASH_ROLLS.ui.dialogs.transformation.presets.wildshapeDesc\"\n          },\n          {\n            value: \"appearance\",\n            label: \"FLASH_ROLLS.ui.dialogs.transformation.presets.appearance\",\n            description: \"FLASH_ROLLS.ui.dialogs.transformation.presets.appearanceDesc\"\n          },\n          {\n            value: \"custom\",\n            label: \"FLASH_ROLLS.ui.dialogs.transformation.presets.custom\",\n            description: \"FLASH_ROLLS.ui.dialogs.transformation.presets.customDesc\"\n          }\n        ];\n        break;\n      }\n      case \"footer\": {\n        context.buttons = [\n          {\n            type: \"button\",\n            icon: \"fa-solid fa-times\",\n            label: \"FLASH_ROLLS.ui.buttons.cancelButton\",\n            action: \"cancel\"\n          },\n          {\n            type: \"button\",\n            icon: \"fa-solid fa-wand-magic-sparkles\",\n            label: \"FLASH_ROLLS.ui.dialogs.transformation.transform\",\n            action: \"transform\"\n          }\n        ];\n        break;\n      }\n    }\n\n    return context;\n  }\n\n  /**\n   * Attach event listeners after rendering\n   * @param {ApplicationRenderContext} context - Render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   */\n  _onRender(context, options) {\n    super._onRender(context, options);\n\n    const selectBtn = this.element.querySelector('.select-actor-btn');\n    const actorImageContainer = this.element.querySelector('.actor-image-container');\n    const actorImagePlaceholder = this.element.querySelector('.actor-image-placeholder');\n    const clearBtn = this.element.querySelector('.clear-actor-btn');\n    const presetSelector = this.element.querySelector('.preset-selector');\n    const favoriteItems = this.element.querySelectorAll('.favorite-item');\n    const toggleFavoriteBtns = this.element.querySelectorAll('.toggle-favorite-btn');\n    const favoritesSection = this.element.querySelector('.form-group.favorites-section');\n    const selectedActorImg = this.element.querySelector('.selected-actor-preview .actor-image-container img');\n\n    if (selectBtn) {\n      selectBtn.addEventListener('click', (event) => {\n        event.preventDefault();\n        this._onSelectActor();\n      });\n    }\n\n    if (actorImageContainer) {\n      actorImageContainer.addEventListener('click', (event) => {\n        if (!event.target.closest('.toggle-favorite-btn')) {\n          event.preventDefault();\n          this._onSelectActor();\n        }\n      });\n    }\n\n    if (actorImagePlaceholder) {\n      actorImagePlaceholder.addEventListener('click', (event) => {\n        event.preventDefault();\n        this._onSelectActor();\n      });\n    }\n\n    if (clearBtn) {\n      clearBtn.addEventListener('click', (event) => {\n        event.preventDefault();\n        this._onClearActor();\n      });\n    }\n\n    if (presetSelector) {\n      presetSelector.addEventListener('change', (event) => this._onPresetChange(event));\n    }\n\n    favoriteItems.forEach(item => {\n      item.addEventListener('click', (event) => {\n        if (!event.target.closest('.toggle-favorite-btn')) {\n          this._onSelectFavorite(item.dataset.uuid);\n        }\n      });\n    });\n\n    toggleFavoriteBtns.forEach(btn => {\n      const isFavorite = btn.dataset.isFavorite === \"true\";\n      btn.title = isFavorite\n        ? game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.transformation.removeFromFavorites\")\n        : game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.transformation.addToFavorites\");\n\n      btn.addEventListener('click', (event) => {\n        event.preventDefault();\n        event.stopPropagation();\n        this._onToggleFavorite(btn.dataset.uuid);\n      });\n    });\n\n    if (favoritesSection) {\n      this._setupDragAndDrop(favoritesSection);\n    }\n\n    if (selectedActorImg) {\n      selectedActorImg.addEventListener('error', () => {\n        selectedActorImg.classList.add('hidden');\n      });\n    }\n  }\n\n  /**\n   * Setup drag and drop for favorites section\n   * @param {HTMLElement} element - Favorites section element\n   * @private\n   */\n  _setupDragAndDrop(element) {\n    element.addEventListener('dragover', (event) => {\n      event.preventDefault();\n      event.dataTransfer.dropEffect = 'copy';\n      element.classList.add('drag-over');\n    });\n\n    element.addEventListener('dragleave', (event) => {\n      if (event.target === element) {\n        element.classList.remove('drag-over');\n      }\n    });\n\n    element.addEventListener('drop', async (event) => {\n      event.preventDefault();\n      element.classList.remove('drag-over');\n\n      const data = TextEditor.getDragEventData(event);\n      if (data.type === 'Actor') {\n        const actor = await fromUuid(data.uuid);\n        if (actor && actor.type === 'npc') {\n          await this._onToggleFavorite(data.uuid);\n        } else if (actor && actor.type !== 'npc') {\n          FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.transformation.onlyNPCs\"));\n        }\n      }\n    });\n  }\n\n  /**\n   * Handle actor selection button click\n   * Opens actor browser for world actors and compendia\n   * @private\n   */\n  async _onSelectActor() {\n    const uuid = await this._showActorBrowser();\n    if (uuid) {\n      this.selectedActorUuid = uuid;\n      const actor = await fromUuid(uuid);\n\n      if (actor) {\n        this.selectedActorName = actor.name;\n        this.render(true);\n      }\n    }\n  }\n\n  /**\n   * Show DnD5e compendium browser to select target actor\n   * Uses monsters tab to get full filtering options (CR, Size, Type, Habitat)\n   * Locks to NPC actors for transformation\n   * @returns {Promise<string|null>} Selected actor UUID or null\n   * @private\n   */\n  async _showActorBrowser() {\n    return dnd5e.applications.CompendiumBrowser.selectOne({\n      tab: \"monsters\",\n      filters: {\n        locked: {\n          documentClass: \"Actor\",\n          types: new Set([\"npc\"])\n        }\n      }\n    });\n  }\n\n  /**\n   * Handle clear actor selection\n   * @private\n   */\n  _onClearActor() {\n    this.selectedActorUuid = null;\n    this.selectedActorName = \"\";\n    this.render(true);\n  }\n\n  /**\n   * Handle selecting a favorite actor\n   * @param {string} uuid - Actor UUID\n   * @private\n   */\n  async _onSelectFavorite(uuid) {\n    const actor = await fromUuid(uuid);\n    if (actor) {\n      const wasEmpty = !this.selectedActorUuid;\n      this.selectedActorUuid = uuid;\n      this.selectedActorName = actor.name;\n\n      if (wasEmpty) {\n        this.render(true);\n        return;\n      }\n\n      const imgContainer = this.element.querySelector('.selected-actor-preview .actor-image-container');\n      const img = imgContainer?.querySelector('img');\n      const toggleBtn = this.element.querySelector('.selected-actor-preview .toggle-favorite-btn');\n      const preview = this.element.querySelector('.selected-actor-preview');\n\n      if (img && imgContainer) {\n        img.src = actor.img;\n        img.alt = actor.name;\n        img.classList.remove('hidden');\n      }\n\n      if (toggleBtn) {\n        toggleBtn.dataset.uuid = uuid;\n        const icon = toggleBtn.querySelector('i');\n        const favorites = game.settings.get(\"flash-rolls-5e\", \"transform-favorites\") || [];\n        const isFavorite = favorites.includes(uuid);\n\n        if (icon) {\n          if (isFavorite) {\n            icon.classList.remove('faded');\n          } else {\n            icon.classList.add('faded');\n          }\n        }\n\n        toggleBtn.title = game.i18n.localize(isFavorite ?\n          \"FLASH_ROLLS.ui.dialogs.transformation.removeFromFavorites\" :\n          \"FLASH_ROLLS.ui.dialogs.transformation.addToFavorites\"\n        );\n      }\n\n      if (preview) {\n        preview.dataset.tooltip = actor.name;\n      }\n    }\n  }\n\n  /**\n   * Handle toggling favorite status\n   * @param {string} uuid - Actor UUID\n   * @private\n   */\n  async _onToggleFavorite(uuid) {\n    const favorites = game.settings.get(\"flash-rolls-5e\", \"transform-favorites\") || [];\n    const favoriteSet = new Set(favorites);\n\n    const wasRemoved = favoriteSet.has(uuid);\n    if (wasRemoved) {\n      favoriteSet.delete(uuid);\n    } else {\n      favoriteSet.add(uuid);\n    }\n\n    await game.settings.set(\"flash-rolls-5e\", \"transform-favorites\", Array.from(favoriteSet));\n\n    if (wasRemoved) {\n      this.render(true);\n    } else {\n      const toggleBtn = this.element.querySelector(`.toggle-favorite-btn[data-uuid=\"${uuid}\"]`);\n      if (toggleBtn) {\n        const icon = toggleBtn.querySelector('i');\n        if (icon) {\n          icon.classList.remove('faded');\n        }\n        toggleBtn.title = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.transformation.removeFromFavorites\");\n      }\n\n      this.render(true);\n    }\n  }\n\n  /**\n   * Handle preset change\n   * @param {Event} event - Change event\n   * @private\n   */\n  _onPresetChange(event) {\n    this.selectedPreset = event.target.value;\n    this.showCustomSettings = this.selectedPreset === 'custom';\n    this.render(true);\n  }\n\n  /**\n   * Handle form submission\n   * @param {Event} event - Form submit event\n   * @param {HTMLFormElement} form - The form element\n   * @param {FormDataExtended} formData - The form data\n   * @private\n   */\n  static async #onSubmit(event, form, formData) {\n    event.preventDefault();\n  }\n\n  /**\n   * Handle transform button click\n   * @param {Event} event - Click event\n   * @param {HTMLElement} target - Target element\n   * @private\n   */\n  static async #onTransform(event, target) {\n    const dialog = this;\n\n    if (!dialog.selectedActorUuid) {\n      FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.transformation.noActorSelected\"));\n      return;\n    }\n\n    const targetActor = await fromUuid(dialog.selectedActorUuid);\n    if (!targetActor) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.invalidActorUuid\"));\n      return;\n    }\n\n    const formData = new FormDataExtended(dialog.element).object;\n    const renderSheet = formData.renderSheet || false;\n\n    let settings;\n    if (dialog.selectedPreset === 'custom') {\n      const keep = new Set();\n      if (formData['keep-mental']) keep.add('mental');\n      if (formData['keep-physical']) keep.add('physical');\n      if (formData['keep-saves']) keep.add('saves');\n      if (formData['keep-skills']) keep.add('skills');\n      if (formData['keep-spells']) keep.add('spells');\n      if (formData['keep-items']) keep.add('items');\n      if (formData['keep-hp']) keep.add('hp');\n\n      settings = new dnd5e.dataModels.settings.TransformationSetting({\n        keep,\n        transformTokens: !!formData['transform-tokens']\n      });\n    } else {\n      settings = dialog._createPresetSettings(dialog.selectedPreset);\n    }\n\n    if (dialog.resolve) {\n      dialog.resolve({ targetActor, settings, renderSheet });\n    }\n\n    dialog.close();\n  }\n\n  /**\n   * Handle cancel button click\n   * @private\n   */\n  static #onCancel() {\n    const dialog = this;\n\n    if (dialog.resolve) {\n      dialog.resolve(null);\n    }\n    dialog.close();\n  }\n\n  /**\n   * Create transformation settings from preset\n   * @param {string} preset - Preset name\n   * @returns {TransformationSetting} Settings object\n   * @private\n   */\n  _createPresetSettings(preset) {\n    switch (preset) {\n      case \"wildshape\":\n        return new dnd5e.dataModels.settings.TransformationSetting({\n          preset: \"wildshape\"\n        });\n\n      case \"appearance\":\n        return new dnd5e.dataModels.settings.TransformationSetting({\n          effects: new Set([\"all\"]),\n          keep: new Set([\"self\"])\n        });\n\n      case \"polymorph\":\n      default:\n        return new dnd5e.dataModels.settings.TransformationSetting({\n          keep: new Set([\"mental\"]),\n          transformTokens: true\n        });\n    }\n  }\n}\n\n","import { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { getActorData } from \"../helpers/Helpers.mjs\";\nimport { TransformationDialog } from \"../ui/dialogs/TransformationDialog.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\nimport { FlashAPI } from \"../core/FlashAPI.mjs\";\n\n/**\n * Manager for actor transformation (polymorph/wild shape)\n * Handles transformation orchestration, animations, and reversion\n */\nexport class TransformationManager {\n\n  /**\n   * Transform selected actors from the menu (interactive mode)\n   * @param {Object} menu - The roll requests menu instance\n   * @returns {Promise<void>}\n   */\n  static async transformSelectedActors(menu) {\n    if (!menu || !menu.selectedActors || menu.selectedActors.size === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n      return;\n    }\n\n    const actorIds = Array.from(menu.selectedActors);\n    await this.transformActors(actorIds);\n  }\n\n  /**\n   * Transform actors into a target actor\n   * @param {string[]} actorIds - Array of actor/token IDs to transform\n   * @param {string} [targetActorUuid] - UUID of actor to transform into (shows dialog if omitted)\n   * @param {Object} [options] - Transformation options\n   * @param {string} [options.preset] - Preset name: \"wildshape\", \"polymorph\", or \"custom\"\n   * @param {Object} [options.settings] - Custom TransformationSetting configuration\n   * @param {boolean} [options.renderSheet=false] - Show actor sheet after transformation\n   * @param {boolean} [options.skipRevertCheck=false] - Skip checking if actors are already transformed\n   * @returns {Promise<void>}\n   */\n  static async transformActors(actorIds, targetActorUuid = null, options = {}) {\n    LogUtil.log('TransformationManager.transformActors', [actorIds, targetActorUuid, options]);\n\n    if (!actorIds || actorIds.length === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n      return;\n    }\n\n    if (!game.user.isGM) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.gmOnly\"));\n      return;\n    }\n\n    const actors = actorIds.map(id => getActorData(id)).filter(a => a);\n    if (actors.length === 0) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.noValidActorsSelected\"));\n      return;\n    }\n\n    const transformedActors = actors.filter(a => a.getFlag(\"dnd5e\", \"isPolymorphed\"));\n    if (transformedActors.length > 0 && !options.skipRevertCheck) {\n      const revert = await foundry.applications.api.DialogV2.confirm({\n        window: {\n          title: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.transformation.revertTitle\")\n        },\n        content: `<p>${game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.transformation.revertConfirm\")}</p>`,\n        rejectClose: false,\n        modal: true\n      });\n\n      if (revert) {\n        const idsToRevert = transformedActors.map(a => {\n          const token = canvas.tokens.placeables.find(t => t.actor === a);\n          return token ? token.document.id : a.id;\n        });\n        await this.revertTransformation(idsToRevert);\n        return;\n      }\n    }\n\n    let targetActor;\n    let transformSettings;\n\n    if (targetActorUuid) {\n      targetActor = await fromUuid(targetActorUuid);\n      if (!targetActor) {\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.invalidActorUuid\"));\n        return;\n      }\n\n      transformSettings = this._createTransformSettings(options.preset, options.settings);\n    } else {\n      const dialogResult = await TransformationDialog.show(actors);\n      if (!dialogResult) {\n        return;\n      }\n\n      targetActor = dialogResult.targetActor;\n      transformSettings = dialogResult.settings;\n      options.renderSheet = dialogResult.renderSheet ?? false;\n    }\n\n    await this._performTransformations(actors, targetActor, transformSettings, options);\n  }\n\n  /**\n   * Revert transformed actors to original form\n   * @param {string[]} actorIds - Array of actor/token IDs to revert\n   * @returns {Promise<void>}\n   */\n  static async revertTransformation(actorIds) {\n    LogUtil.log('TransformationManager.revertTransformation', [actorIds]);\n\n    if (!actorIds || actorIds.length === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n      return;\n    }\n\n    const actors = actorIds.map(id => getActorData(id)).filter(a => a);\n    if (actors.length === 0) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.noValidActorsSelected\"));\n      return;\n    }\n\n    const transformedActors = actors.filter(a => a.getFlag(\"dnd5e\", \"isPolymorphed\"));\n    if (transformedActors.length === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.notTransformed\"));\n      return;\n    }\n\n    const tokens = this._getTokensForActors(transformedActors);\n    if (tokens.length > 0 && (this._hasJB2A() || this._hasCustomAnimation())) {\n      await this._playTransformationAnimation(tokens);\n    }\n\n    let successCount = 0;\n    for (const actor of transformedActors) {\n      try {\n        await actor.revertOriginalForm();\n        successCount++;\n      } catch (error) {\n        LogUtil.error(`Failed to revert ${actor.name}:`, [error]);\n        ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.notifications.transformationFailed\", {\n          name: actor.name,\n          error: error.message\n        }));\n      }\n    }\n\n    if (successCount > 0) {\n      FlashAPI.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.reversionSuccess\", {\n        count: successCount\n      }));\n    }\n  }\n\n  /**\n   * Perform transformations for all actors\n   * @param {Actor[]} actors - Actors to transform\n   * @param {Actor} targetActor - Actor to transform into\n   * @param {TransformationSetting} settings - Transformation settings\n   * @param {Object} options - Additional options\n   * @returns {Promise<void>}\n   * @private\n   */\n  static async _performTransformations(actors, targetActor, settings, options = {}) {\n    const tokens = this._getTokensForActors(actors);\n\n    if (tokens.length > 0 && (this._hasJB2A() || this._hasCustomAnimation())) {\n      this._playTransformationAnimation(tokens);\n    }\n\n    let successCount = 0;\n    for (const actor of actors) {\n      try {\n        const sanitizedTarget = this._sanitizeTargetActor(actor, targetActor);\n        await actor.transformInto(sanitizedTarget, settings, {\n          renderSheet: options.renderSheet ?? false\n        });\n        successCount++;\n\n        await new Promise(resolve => setTimeout(resolve, 200));\n      } catch (error) {\n        LogUtil.error(`Failed to transform ${actor.name}:`, [error]);\n        ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.notifications.transformationFailed\", {\n          name: actor.name,\n          error: error.message\n        }));\n      }\n    }\n\n    if (successCount > 0) {\n      FlashAPI.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.transformationSuccess\", {\n        count: successCount,\n        target: targetActor.name\n      }));\n    }\n  }\n\n  /**\n   * Play transformation animation using Sequencer\n   * @param {Token[]} tokens - Tokens to animate\n   * @returns {Promise<void>}\n   * @private\n   */\n  static async _playTransformationAnimation(tokens) {\n    if (!tokens || tokens.length === 0) return;\n\n    let animationPath = this._getAnimationPath();\n    if (!animationPath && this._hasJB2A()) {\n      animationPath = await this._getDefaultJB2APath();\n    }\n\n    if (!animationPath) return;\n\n    try {\n      for (const token of tokens) {\n        const { x: centerX, y: centerY } = token.center;\n\n        new Sequence()\n          .effect()\n          .file(animationPath)\n          .atLocation({ x: centerX, y: centerY })\n          .scale(0.6)\n          .fadeIn(200)\n          .fadeOut(400)\n          .duration(1500)\n          .forUsers(game.users.map(u => u.id))\n          .play();\n\n        await new Promise(resolve => setTimeout(resolve, 200));\n      }\n\n      await new Promise(resolve => setTimeout(resolve, 1000));\n    } catch (error) {\n      LogUtil.warn(`Transformation animation file not found: ${animationPath}`, [error]);\n      FlashAPI.notify('warn', game.i18n.format(\"FLASH_ROLLS.notifications.animationFileNotFound\", {\n        path: animationPath\n      }));\n    }\n  }\n\n  /**\n   * Get tokens for actors\n   * @param {Actor[]} actors - Actors to get tokens for\n   * @returns {Token[]} Array of tokens\n   * @private\n   */\n  static _getTokensForActors(actors) {\n    const tokens = [];\n\n    for (const actor of actors) {\n      const token = canvas.tokens.placeables.find(t => t.actor === actor);\n      if (token) {\n        tokens.push(token);\n      }\n    }\n\n    return tokens;\n  }\n\n  /**\n   * Create transformation settings based on preset or custom config\n   * @param {string} [preset] - Preset name\n   * @param {Object} [customSettings] - Custom settings configuration\n   * @returns {TransformationSetting} Transformation settings\n   * @private\n   */\n  static _createTransformSettings(preset, customSettings) {\n    if (customSettings) {\n      return new dnd5e.dataModels.settings.TransformationSetting(customSettings);\n    }\n\n    switch (preset) {\n      case \"wildshape\":\n        return new dnd5e.dataModels.settings.TransformationSetting({\n          preset: \"wildshape\"\n        });\n\n      case \"polymorph\":\n        return new dnd5e.dataModels.settings.TransformationSetting({\n          keep: new Set([\"mental\"]),\n          transformTokens: true\n        });\n\n      default:\n        return new dnd5e.dataModels.settings.TransformationSetting({\n          keep: new Set([\"mental\"]),\n          transformTokens: true\n        });\n    }\n  }\n\n  /**\n   * Get JB2A module if available\n   * @returns {Module|null} JB2A module or null\n   * @private\n   */\n  static _getJB2AModule() {\n    return game.modules.get('JB2A_DnD5e') || game.modules.get('jb2a_patreon');\n  }\n\n  /**\n   * Check if JB2A module is available\n   * @returns {boolean} True if JB2A is active\n   * @private\n   */\n  static _hasJB2A() {\n    const module = this._getJB2AModule();\n    return module?.active;\n  }\n\n  /**\n   * Check if Sequencer module is active\n   * @returns {boolean} True if Sequencer is active\n   * @private\n   */\n  static _hasSequencer() {\n    return game.modules.get('sequencer')?.active;\n  }\n\n  /**\n   * Get default JB2A transformation animation path\n   * @returns {Promise<string|null>} Path to animation or null\n   * @private\n   */\n  static async _getDefaultJB2APath() {\n    if (this._hasSequencer() && window.Sequencer?.Database) {\n      const possiblePaths = [\n        'jb2a.smoke.puff.centered.grey.1',\n        'jb2a.smoke.puff.centered.grey',\n        'jb2a.smoke.puff.grey'\n      ];\n\n      for (const dbPath of possiblePaths) {\n        if (Sequencer.Database.entryExists(dbPath)) {\n          LogUtil.log(`Found JB2A transformation animation via Sequencer: ${dbPath}`);\n          return dbPath;\n        }\n      }\n    }\n\n    const jb2aModule = this._getJB2AModule();\n    if (jb2aModule?.active) {\n      const modulePath = jb2aModule.id;\n      const filePath = `modules/${modulePath}/Library/Generic/Smoke/SmokePuff01_02_Regular_Grey_400x400.webm`;\n\n      LogUtil.log(`Using JB2A transformation animation file path: ${filePath}`);\n      return filePath;\n    }\n\n    LogUtil.warn(\"JB2A module not found, transformation animations disabled\");\n    return null;\n  }\n\n  /**\n   * Check if custom animation path is configured\n   * @returns {boolean} True if custom path exists\n   * @private\n   */\n  static _hasCustomAnimation() {\n    return !!this._getAnimationPath();\n  }\n\n  /**\n   * Get custom animation path from settings\n   * @returns {string|null} Animation file path or null\n   * @private\n   */\n  static _getAnimationPath() {\n    try {\n      const SETTINGS = getSettings();\n      if (!SETTINGS.transformAnimationPath?.tag) return null;\n      const path = game.settings.get(\"flash-rolls-5e\", SETTINGS.transformAnimationPath.tag);\n      return path && path.trim() !== \"\" ? path : null;\n    } catch (error) {\n      return null;\n    }\n  }\n\n  /**\n   * Sanitize target actor to only include abilities present in source actor\n   * Prevents DnD5e transformInto errors when target has extra abilities that source doesn't have\n   * This handles cases where actors have optional abilities (san, hon) that aren't present in all actors\n   * @param {Actor} sourceActor - Actor being transformed (original form)\n   * @param {Actor} targetActor - Actor to transform into (new form)\n   * @returns {Actor} Sanitized target actor or original if no sanitization needed\n   * @private\n   */\n  static _sanitizeTargetActor(sourceActor, targetActor) {\n    if (!sourceActor?.system?.abilities || !targetActor?.system?.abilities) {\n      return targetActor;\n    }\n\n    const sourceData = sourceActor.toObject();\n    const targetData = targetActor.toObject();\n\n    const sourceAbilityKeys = Object.keys(sourceData.system.abilities);\n    const targetAbilityKeys = Object.keys(targetData.system.abilities);\n\n    LogUtil.log(`Sanitization check - Source (${sourceActor.name}) toObject:`, sourceAbilityKeys);\n    LogUtil.log(`Sanitization check - Target (${targetActor.name}) toObject:`, targetAbilityKeys);\n\n    const extraAbilities = targetAbilityKeys.filter(key => !sourceAbilityKeys.includes(key));\n\n    if (extraAbilities.length === 0) {\n      LogUtil.log('No extra abilities found in serialized data - skipping sanitization');\n      return targetActor;\n    }\n\n    LogUtil.log(`Sanitizing target actor ${targetActor.name}: removing abilities not present in source toObject`, extraAbilities);\n\n    for (const abilityKey of extraAbilities) {\n      delete targetData.system.abilities[abilityKey];\n    }\n\n    LogUtil.log('Sanitized data abilities:', Object.keys(targetData.system.abilities));\n\n    const TempActor = CONFIG.Actor.documentClass;\n    const tempActor = new TempActor(targetData, { temporary: true });\n\n    LogUtil.log('Temp actor abilities after creation:', Object.keys(tempActor.system.abilities));\n\n    return tempActor;\n  }\n}\n","import { MODULE, ROLL_TYPES } from \"../../constants/General.mjs\";\nimport { RollMenuOrchestrator } from \"../managers/roll-menu/RollMenuOrchestrator.mjs\";\nimport RollRequestsMenu from \"../ui/RollRequestsMenu.mjs\";\nimport { getActorData, getFullRollName } from \"../helpers/Helpers.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { RollHelpers } from \"../helpers/RollHelpers.mjs\";\nimport { ChatMessageManager } from \"../managers/ChatMessageManager.mjs\";\nimport { ModuleSettingsMenu } from \"../ui/dialogs/ModuleSettingsMenu.mjs\";\nimport { PremiumFeaturesDialog } from \"../ui/dialogs/PremiumFeaturesDialog.mjs\";\nimport { RollMenuEventManager } from \"../managers/roll-menu/RollMenuEventManager.mjs\";\nimport { TokenMovementManager } from \"../utils/TokenMovementManager.mjs\";\nimport { RollMenuStateManager } from \"../managers/roll-menu/RollMenuStateManager.mjs\";\nimport { SidebarController } from \"../managers/SidebarController.mjs\";\nimport { TokenPlacementManager } from \"../managers/TokenPlacementManager.mjs\";\nimport { TokenTeleportManager } from \"../managers/TokenTeleportManager.mjs\";\nimport { TransformationManager } from \"../managers/TransformationManager.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\n\n/**\n * Public API for Flash Token Bar 5e that can be used by other modules\n * Accessible via FlashAPI or game.modules.get('flash-rolls-5e').api\n * Legacy access: FlashRolls5e (deprecated, use FlashAPI instead)\n */\nexport class FlashAPI {\n  \n  /**\n   * Request a roll for specified actors\n   * @param {Object} options - Roll request options\n   * @param {string} options.requestType - The type of roll request (lowercase from ROLL_TYPES, e.g., 'skill', 'ability', 'savingthrow')\n   * @param {string} [options.rollKey=null] - The specific roll key (e.g., 'acr' for Acrobatics, 'str' for Strength)\n   * @param {string[]} [options.actorIds=[]] - Array of actor IDs or token IDs to roll for\n   * @param {number} [options.dc] - Difficulty Class for the roll\n   * @param {string} [options.situationalBonus] - Situational bonus (e.g., '+2', '1d4')\n   * @param {boolean} [options.advantage] - Roll with advantage\n   * @param {boolean} [options.disadvantage] - Roll with disadvantage\n   * @param {string} [options.rollMode] - Roll visibility mode (CONST.DICE_ROLL_MODES: 'publicroll', 'gmroll', 'blindroll', 'selfroll')\n   * @param {boolean} [options.skipRollDialog] - Skip the roll dialog\n   * @param {boolean} [options.sendAsRequest] - Send to players instead of rolling locally\n   * @param {string} [options.groupRollId=null] - Group roll identifier for combining multiple rolls into one message\n   * @param {boolean} [options.isContestedRoll=false] - Whether this is part of a contested roll\n   * @returns {Promise<void>}\n   */\n  static async requestRoll(options = {}) {\n    try {\n      // Validate input parameters\n      if (!options || typeof options !== 'object') {\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.invalidMacroData\"));\n        return;\n      }\n\n      const { requestType, rollKey = null, actorIds = [], dc, situationalBonus, advantage, disadvantage, rollMode, skipRollDialog, sendAsRequest = true, groupRollId = null, isContestedRoll = false, workflowId = null } = options;\n\n      if (!requestType) {\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.missingRequestType\"));\n        return;\n      }\n\n      const fromMidiWorkflow = !!workflowId;\n      const config = { dc, situationalBonus, advantage, disadvantage, rollMode, skipRollDialog, sendAsRequest, groupRollId, isContestedRoll, fromMidiWorkflow };\n\n      LogUtil.log('FlashAPI.requestRoll', [requestType, rollKey, actorIds, 'workflowId:', workflowId, 'fromMidiWorkflow:', fromMidiWorkflow, config]);\n      \n      // Find roll option by either uppercase key or lowercase name\n      let rollOption = MODULE.ROLL_REQUEST_OPTIONS[requestType];\n      if (!rollOption) {\n        // Try finding by lowercase name if not found by key\n        const rollRequestOptions = Object.values(MODULE.ROLL_REQUEST_OPTIONS);\n        rollOption = rollRequestOptions.find(option => option.name === requestType);\n      }\n      \n      if (!rollOption) {\n        ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.notifications.unknownRequestType\", {\n          requestType: requestType\n        }));\n        return;\n      }\n      \n      const normalizedRequestType = rollOption.name;\n      \n      if (actorIds.length === 0) {\n        FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n        return;\n      }\n      \n      // Validate actorIds array\n      if (!Array.isArray(actorIds)) {\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.invalidActorIdsFormat\"));\n        return;\n      }\n      \n      // Create actor data array and track invalid IDs\n      const invalidActorIds = [];\n      const actorsData = [];\n      \n      for (const uniqueId of actorIds) {\n        const actor = getActorData(uniqueId);\n        if (!actor) {\n          invalidActorIds.push(uniqueId);\n          continue;\n        }\n        \n        let tokenId = null;\n        if (!game.actors.get(uniqueId)) {\n          tokenId = uniqueId;\n        }\n        \n        actorsData.push({\n          actor,\n          uniqueId,\n          tokenId\n        });\n      }\n      \n      // Show notification for invalid actors but continue with valid ones\n      if (invalidActorIds.length > 0) {\n        const invalidIds = invalidActorIds.join(', ');\n        FlashAPI.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.invalidActorIds\", {\n          numIds: invalidActorIds.length,\n          invalidIds: invalidIds\n        }));\n      }\n      \n      if (actorsData.length === 0) {\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.noValidActorsSelected\"));\n        return;\n      }\n      \n      // Create a mock menu object with the necessary properties\n      const mockMenu = {\n        selectedActors: new Set(actorIds),\n        selectedRequestType: requestType,\n        isLocked: true,\n        close: () => {}\n      };\n\n      // Use orchestrator to handle the roll request\n      return RollMenuOrchestrator.triggerRoll(normalizedRequestType, rollKey, mockMenu, config);\n    } catch (error) {\n      LogUtil.error('FlashAPI.requestRoll - Execution error:', [error]);\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.macroExecutionFailed\"));\n      return;\n    }\n  }\n  \n  /**\n   * Get list of available roll types\n   * @returns {Object} Available roll request options with name and label only\n   */\n  static getAvailableRollTypes() {\n    const cleanedOptions = {};\n    \n    for (const [key, option] of Object.entries(MODULE.ROLL_REQUEST_OPTIONS)) {\n      cleanedOptions[key] = {\n        name: option.name,\n        label: option.label\n      };\n    }\n    \n    return cleanedOptions;\n  }\n  \n  /**\n   * Get currently selected actors from the roll requests menu\n   * @param {boolean} tokenOnly - If true, only return token IDs (filters out actors without tokens on canvas)\n   * @returns {string[]} Array of selected actor/token IDs\n   */\n  static getSelectedActors(tokenOnly = false) {\n    const menu = RollRequestsMenu.getInstance();\n    if (menu && menu.selectedActors) {\n      const selectedIds = Array.from(menu.selectedActors);\n\n      if (!tokenOnly) {\n        return selectedIds;\n      }\n\n      return selectedIds.map(uniqueId => {\n        const token = canvas.tokens.placeables.find(t => t.id === uniqueId);\n        if (token) {\n          return token.id;\n        }\n        const actor = game.actors.get(uniqueId);\n        if (actor) {\n          const actorToken = canvas.tokens.placeables.find(t => t.actor?.id === actor.id);\n          if (actorToken) {\n            return actorToken.id;\n          }\n        }\n        return null;\n      }).filter(id => id !== null);\n    }\n    return [];\n  }\n  \n  /**\n   * Check if the roll requests menu is currently open\n   * @returns {boolean} True if menu is rendered and visible\n   */\n  static isMenuOpen() {\n    const menu = RollRequestsMenu.getInstance();\n    return menu && menu.rendered;\n  }\n  \n  /**\n   * Create a macro for a specific roll type and configuration\n   * @param {Object} macroData - Macro configuration data\n   * @param {string} macroData.requestType - The type of roll request\n   * @param {string} macroData.rollKey - The specific roll key (null for non-nested rolls)\n   * @param {string[]} macroData.actorIds - Array of actor IDs to include in macro\n   * @param {Object} macroData.config - Roll configuration\n   * @returns {Promise<Macro>} Created macro document\n   */\n  static async createMacro(macroData) {\n    const SETTINGS = getSettings();\n    const addMacrosToFolder = SettingsUtil.get(SETTINGS.addMacrosToFolder.tag);\n    \n    LogUtil.log('FlashAPI.createMacro', [macroData]);\n    \n    const { requestType, rollKey = null, actorIds = [], config = {} } = macroData;\n    \n    let rollOption = MODULE.ROLL_REQUEST_OPTIONS[requestType];\n    if (!rollOption) {\n      const rollRequestOptions = Object.values(MODULE.ROLL_REQUEST_OPTIONS);\n      rollOption = rollRequestOptions.find(option => option.name === requestType);\n    }\n    if (!rollOption) {\n      FlashAPI.notify('warn', `Unknown request type: ${requestType}`);\n      return;\n    }\n    \n    // Generate macro name using label property\n    let macroName = rollOption.label;\n    LogUtil.log('FlashAPI.createMacro', [macroName, rollOption.subList]);\n    if (rollKey && rollOption.subList && Array.isArray(rollOption.subList)) {\n      const subItem = rollOption.subList.find(item => item.id === rollKey);\n      if (subItem) {\n        macroName = subItem.name;\n      }\n    } else if (rollKey) {\n      const fullName = getFullRollName(rollOption.name, rollKey);\n      macroName = fullName;\n    }\n    \n    const requestOptions = {\n      requestType: rollOption.name,\n      ...(rollKey && { rollKey }),\n      ...(actorIds.length > 0 && { actorIds }),\n      ...config\n    };\n    \n    if (requestOptions.advantage === undefined) requestOptions.advantage = false;\n    if (requestOptions.disadvantage === undefined) requestOptions.disadvantage = false;\n    \n    const command = `// Flash Token Bar: ${macroName} - ${rollKey || ''}\n    try {\n      FlashAPI.requestRoll(${JSON.stringify(requestOptions, null, 2)});\n    } catch (error) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.macroDataMalformed\"));\n    }`;\n    let folderId = null;\n    if (addMacrosToFolder) {\n      folderId = await this._ensureFlashRollsFolder();\n    }\n\n    // Create the macro\n    const macroDocumentData = {\n      name: `Flash Token Bar: ${macroName}`,\n      type: \"script\",\n      command: command,\n      img: \"modules/flash-rolls-5e/assets/bolt-circle.svg\",\n      ...(folderId && { folder: folderId }),\n      flags: {\n        \"flash-rolls-5e\": {\n          requestType,\n          rollKey,\n          actorIds,\n          config\n        }\n      }\n    };\n    \n    const macro = await Macro.create(macroDocumentData);\n    FlashAPI.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.macroCreated\", {\n      macroName: macro.name\n    }));\n    \n    // Open the macro configuration sheet for editing\n    macro.sheet.render(true);\n    \n    return macro;\n  }\n  \n  /**\n   * Ensure 'Flash Token Bar' folder exists, creating it if necessary\n   * @returns {Promise<string|null>} The folder ID or null if creation failed\n   * @private\n   */\n  static async _ensureFlashRollsFolder() {\n    const folderName = 'Flash Token Bar';\n    let folder = game.folders.find(f => f.type === 'Macro' && f.name === folderName);\n    \n    if (!folder) {\n      try {\n        folder = await Folder.create({\n          name: folderName,\n          type: 'Macro',\n          color: '#302437',\n          sort: 0\n        });\n        LogUtil.log('Created Flash Token Bar macro folder', [folder]);\n      } catch (error) {\n        LogUtil.error('Failed to create Flash Token Bar macro folder:', [error]);\n        FlashAPI.notify('warn', 'Failed to create Flash Token Bar macro folder. Macro will be created without folder organization.');\n        return null;\n      }\n    }\n    \n    return folder?.id || null;\n  }\n  \n  /**\n   * Calculate group roll results using Flash Token Bar 5e calculation methods\n   * @param {Object} options - Group roll calculation options\n   * @param {number|string} options.method - Calculation method: 1/\"Standard Rule\", 2/\"Group Average\", 3/\"Leader with Help\", 4/\"Weakest Link\"\n   * @param {Object[]} options.rollResults - Array of roll results with { actorId, total, actorName? }\n   * @param {number} options.dc - Difficulty Class to check against\n   * @param {Object[]} [options.actors] - Array of actor objects (auto-resolved from rollResults actorId if not provided)\n   * @param {string} [options.rollType] - Type of roll (required for methods 3 & 4, e.g., 'skill', 'ability')\n   * @param {string} [options.rollKey] - Specific roll key (required for methods 3 & 4, e.g., 'acr', 'str')\n   * @returns {Object} Calculation result with { success, result, details, method, actorResults }\n   * \n   * @example\n   * // Standard Rule example (accepts method as number or string)\n   * const result = FlashAPI.calculateGroupRoll({\n   *   method: \"Standard Rule\", // or method: 1\n   *   rollResults: [\n   *     { actorId: \"ABC\", total: 15 }, // actorName optional - will be looked up\n   *     { actorId: \"DEF\", total: 12, actorName: \"Rogue\" }, // or provided\n   *     { actorId: \"GHI\", total: 8 }\n   *   ],\n   *   dc: 12\n   * });\n   * // Returns: { \n   * //   success: true, \n   * //   result: 1, // 1=success, 0=failure for Standard Rule\n   * //   details: { finalResult: true, successes: 2, failures: 1, summary: \"...\" },\n   * //   method: 'Standard Rule',\n   * //   actorResults: [{ actorId: \"ABC\", actorName: \"Someone\", total: 15, passed: true }, ...]\n   * // }\n   */\n  static calculateGroupRoll(options = {}) {\n    const { rollResults, dc, rollType, rollKey } = options;\n    let { method, actors } = options;\n    \n    // Convert string method names to numbers\n    const methodMap = {\n      \"standard rule\": 1,\n      \"group average\": 2, \n      \"leader with help\": 3,\n      \"weakest link\": 4\n    };\n    \n    if (typeof method === 'string') {\n      const normalizedMethod = method.toLowerCase();\n      method = methodMap[normalizedMethod];\n      if (!method) {\n        ui.notifications.error(`Invalid method name: \"${options.method}\". Valid options: \"Standard Rule\", \"Group Average\", \"Leader with Help\", \"Weakest Link\", or numbers 1-4`);\n        return null;\n      }\n    }\n    \n    // Validate required parameters\n    if (!method || ![1, 2, 3, 4].includes(method)) {\n      ui.notifications.error(\"Method must be 1-4 or valid method name: 'Standard Rule', 'Group Average', 'Leader with Help', 'Weakest Link'\");\n      return null;\n    }\n    \n    if (!Array.isArray(rollResults) || rollResults.length === 0) {\n      ui.notifications.error(\"rollResults must be a non-empty array\");\n      return null;\n    }\n    \n    if (typeof dc !== 'number' || dc < 0) {\n      ui.notifications.error(\"dc must be a positive number\");\n      return null;\n    }\n    \n    // Validate rollResults format and enhance with actor names\n    const enhancedRollResults = [];\n    for (let i = 0; i < rollResults.length; i++) {\n      const roll = rollResults[i];\n      if (!roll.hasOwnProperty('total') || typeof roll.total !== 'number') {\n        ui.notifications.error(`rollResults[${i}] must have a 'total' property with a numeric value`);\n        return null;\n      }\n      if (!roll.actorId) {\n        ui.notifications.error(`rollResults[${i}] must have an 'actorId' property`);\n        return null;\n      }\n      \n      // Get actor name if not provided\n      let actorName = roll.actorName;\n      if (!actorName) {\n        const actorData = getActorData(roll.actorId);\n        actorName = actorData?.name || roll.actorId;\n      }\n      \n      enhancedRollResults.push({\n        ...roll,\n        actorName,\n        passed: roll.total >= dc\n      });\n    }\n    \n    // Methods 3 and 4 require additional parameters\n    if ([3, 4].includes(method)) {\n      if (!rollType) {\n        ui.notifications.error(\"rollType is required for Leader with Help and Weakest Link methods\");\n        return null;\n      }\n      if (!rollKey) {\n        ui.notifications.error(\"rollKey is required for Leader with Help and Weakest Link methods\");\n        return null;\n      }\n      \n      // Auto-resolve actors from rollResults if not provided\n      if (!Array.isArray(actors) || actors.length === 0) {\n        actors = [];\n        for (const roll of enhancedRollResults) {\n          const actor = getActorData(roll.actorId);\n          if (actor) {\n            actors.push(actor);\n          }\n        }\n        \n        if (actors.length === 0) {\n          ui.notifications.error(\"No valid actors could be resolved from the rollResults for Leader with Help and Weakest Link methods\");\n          return null;\n        }\n      }\n    }\n    \n    try {\n      let calculationResult;\n      let methodName;\n      \n      switch (method) {\n        case 1: // Standard Rule\n          calculationResult = RollHelpers.calculateStandardRule(rollResults, dc);\n          methodName = 'Standard Rule';\n          return {\n            success: calculationResult.finalResult,\n            result: calculationResult.finalResult ? 1 : 0, // 1=success, 0=failure\n            details: calculationResult,\n            method: methodName,\n            actorResults: enhancedRollResults\n          };\n          \n        case 2: // Group Average\n          calculationResult = RollHelpers.calculateGroupAverage(rollResults, dc);\n          methodName = 'Group Average';\n          return {\n            success: calculationResult.success,\n            result: calculationResult.finalResult, // Numeric average result\n            details: calculationResult,\n            method: methodName,\n            actorResults: enhancedRollResults\n          };\n          \n        case 3: // Leader with Help\n          calculationResult = RollHelpers.calculateLeaderWithHelp(rollResults, dc, actors, rollType, rollKey);\n          methodName = 'Leader with Help';\n          // Add isLeadRoll property to identify the leader\n          const enhancedResultsWithLeader = enhancedRollResults.map(result => ({\n            ...result,\n            isLeadRoll: result.actorId === calculationResult.leaderActorId\n          }));\n          return {\n            success: calculationResult.success,\n            result: calculationResult.finalResult, // Modified leader result\n            details: calculationResult,\n            method: methodName,\n            actorResults: enhancedResultsWithLeader\n          };\n          \n        case 4: // Weakest Link\n          calculationResult = RollHelpers.calculateWeakestLink(rollResults, dc, actors, rollType, rollKey);\n          methodName = 'Weakest Link';\n          // Add isLeadRoll property to identify the weakest link (the \"lead\" in this context)\n          const enhancedResultsWithWeakest = enhancedRollResults.map(result => ({\n            ...result,\n            isLeadRoll: result.actorId === calculationResult.weakestActorId\n          }));\n          return {\n            success: calculationResult.success,\n            result: calculationResult.finalResult, // Modified weakest result\n            details: calculationResult,\n            method: methodName,\n            actorResults: enhancedResultsWithWeakest\n          };\n          \n        default:\n          ui.notifications.error(`Invalid calculation method: ${method}`);\n          return null;\n      }\n    } catch (error) {\n      LogUtil.error('FlashAPI.calculateGroupRoll - Error:', [error]);\n      ui.notifications.error(`Error calculating group roll: ${error.message}`);\n      return null;\n    }\n  }\n\n  static async createGroupRollMessage(actorEntries, rollType, rollKey, config = {}, groupRollId) {\n    return ChatMessageManager.createGroupRollMessage(actorEntries, rollType, rollKey, config, groupRollId);\n  }\n\n  /**\n   * Toggle the menu lock state\n   * When locked, the menu won't close when clicking outside\n   */\n  static async toggleLockMenu() {\n    const currentLockState = game.user.getFlag(MODULE.ID, 'menuLocked') ?? false;\n    const newLockState = !currentLockState;\n\n    await game.user.setFlag(MODULE.ID, 'menuLocked', newLockState);\n\n    const menu = RollRequestsMenu.getInstance();\n    if (menu && menu.rendered) {\n      menu.isLocked = newLockState;\n      const lockIcon = menu.element?.querySelector('#flash5e-actors-lock');\n      if (lockIcon) {\n        lockIcon.classList.remove('fa-lock-keyhole', 'fa-lock-keyhole-open');\n        lockIcon.classList.add(newLockState ? 'fa-lock-keyhole' : 'fa-lock-keyhole-open');\n      }\n    }\n  }\n\n  /**\n   * Toggle the roll requests enabled state\n   * Controls whether the module intercepts and processes roll requests\n   */\n  static async toggleRollRequests() {\n    const SETTINGS = getSettings();\n    const currentValue = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const newValue = !currentValue;\n\n    await SettingsUtil.set(SETTINGS.rollRequestsEnabled.tag, newValue);\n\n    SidebarController.updateRollRequestsIcon(newValue);\n    SettingsUtil.applyRollRequestsEnabled(newValue);\n\n    const menu = RollRequestsMenu.getInstance();\n    if (menu && menu.rendered) {\n      await menu.render();\n    }\n  }\n\n  /**\n   * Toggle the skip roll dialogs setting\n   * When enabled, rolls are made immediately without showing configuration dialogs\n   */\n  static async toggleSkipDialogs() {\n    const SETTINGS = getSettings();\n    const currentValue = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n    await SettingsUtil.set(SETTINGS.skipRollDialog.tag, !currentValue);\n\n    const menu = RollRequestsMenu.getInstance();\n    if (menu && menu.rendered) {\n      await menu.render();\n    }\n  }\n\n  /**\n   * Toggle the group rolls message setting\n   * When enabled, multiple rolls are combined into a single chat message\n   */\n  static async toggleGroupRolls() {\n    const SETTINGS = getSettings();\n    const currentValue = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    await SettingsUtil.set(SETTINGS.groupRollsMsgEnabled.tag, !currentValue);\n\n    const menu = RollRequestsMenu.getInstance();\n    if (menu && menu.rendered) {\n      await menu.render();\n    }\n  }\n\n  /**\n   * Toggle the show options list on hover setting\n   * When enabled, the roll request options list is shown when hovering over the menu\n   */\n  static async toggleShowOptions() {\n    const SETTINGS = getSettings();\n    const currentValue = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag);\n    await SettingsUtil.set(SETTINGS.showOptionsListOnHover.tag, !currentValue);\n\n    const menu = RollRequestsMenu.getInstance();\n    if (menu && menu.rendered) {\n      await menu.render();\n    }\n  }\n\n  /**\n   * Open the module settings dialog\n   */\n  static openSettings() {\n    new ModuleSettingsMenu().render(true);\n  }\n\n  /**\n   * Open the premium features dialog\n   */\n  static openPremiumFeatures() {\n    new PremiumFeaturesDialog().render(true);\n  }\n\n  /**\n   * Toggle select all actors in the Roll Requests Menu\n   * Toggles between selecting all and deselecting all based on current state\n   * @param {string} tab - Optional tab to switch to before selecting ('pc', 'npc', or 'group')\n   */\n  static async selectAllActors(tab) {\n    const menu = RollRequestsMenu.getInstance();\n    if (!menu || !menu.rendered) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.menuNotOpen\"));\n      return;\n    }\n\n    if (tab && ['pc', 'npc', 'group'].includes(tab)) {\n      if (menu.currentTab !== tab) {\n        menu.currentTab = tab;\n        await menu.render();\n      }\n    }\n\n    const selectAllCheckbox = menu.element?.querySelector('#flash5e-actors-all');\n    if (selectAllCheckbox) {\n      selectAllCheckbox.checked = !selectAllCheckbox.checked;\n      selectAllCheckbox.dispatchEvent(new Event('change'));\n    }\n  }\n\n  /**\n   * Apply actor filters or open the actor filter dialog\n   * @param {Object} filters - Optional filter configuration { inCombat: boolean, visible: boolean, removeDead: boolean }\n   */\n  static async filterActors(filters) {\n    const menu = RollRequestsMenu.getInstance();\n    if (!menu || !menu.rendered) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.menuNotOpen\"));\n      return;\n    }\n\n    if (filters && typeof filters === 'object') {\n      const validFilters = {\n        inCombat: !!filters.inCombat,\n        visible: !!filters.visible,\n        removeDead: !!filters.removeDead\n      };\n\n      menu.actorFilters = validFilters;\n      await game.user.setFlag(MODULE.ID, 'actorFilters', validFilters);\n      menu.render();\n    } else {\n      const filterButton = menu.element?.querySelector('#flash5e-filter-actors');\n      if (filterButton) {\n        filterButton.click();\n      }\n    }\n  }\n\n  /**\n   * Get the current actor filter values\n   * @returns {Object} Current filter configuration { inCombat: boolean, visible: boolean, removeDead: boolean }\n   */\n  static getActorFilters() {\n    return game.user.getFlag(MODULE.ID, 'actorFilters') || {\n      inCombat: false,\n      visible: false,\n      removeDead: false\n    };\n  }\n\n  /**\n   * Toggle targeting for actors\n   * If actorIds are provided, toggles targeting for those actors\n   * If no actorIds provided, uses menu selection (or clears all targets if nothing selected)\n   * @param {string[]} actorIds - Array of actor/token IDs to toggle targeting for\n   */\n  static toggleTargets(actorIds) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      actorIds.forEach(uniqueId => {\n        const actor = getActorData(uniqueId);\n        if (!actor) return;\n\n        const actorId = actor.id;\n        const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n        RollMenuEventManager.toggleActorTargetById(actorId, tokenId);\n      });\n    } else if (menu && menu.rendered) {\n      RollMenuEventManager.toggleTargetsForSelected(menu);\n    }\n  }\n\n  /**\n   * Heal actors to full HP\n   * @param {string[]} actorIds - Array of actor/token IDs to heal\n   */\n  static healAll(actorIds) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      actorIds.forEach(uniqueId => {\n        const actor = getActorData(uniqueId);\n        if (!actor) return;\n\n        const actorId = actor.id;\n        const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n        RollMenuEventManager.healActorById(actorId, tokenId);\n      });\n    } else if (menu && menu.rendered) {\n      RollMenuEventManager.healSelectedActors(menu);\n    }\n  }\n\n  /**\n   * Set actor HP to 0\n   * @param {string[]} actorIds - Array of actor/token IDs to set HP to 0\n   */\n  static killAll(actorIds) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      actorIds.forEach(uniqueId => {\n        const actor = getActorData(uniqueId);\n        if (!actor) return;\n\n        const actorId = actor.id;\n        const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n        RollMenuEventManager.killActorById(actorId, tokenId);\n      });\n    } else if (menu && menu.rendered) {\n      RollMenuEventManager.killSelectedActors(menu);\n    }\n  }\n\n  /**\n   * Remove all status effects from actors\n   * @param {string[]} actorIds - Array of actor/token IDs to remove status effects from\n   */\n  static async removeStatusEffects(actorIds) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      let totalRemoved = 0;\n      for (const uniqueId of actorIds) {\n        const actor = getActorData(uniqueId);\n        if (!actor) continue;\n\n        const statusEffects = actor.appliedEffects.filter(effect =>\n          effect.statuses?.size > 0 || effect.flags?.core?.statusId\n        );\n\n        for (const effect of statusEffects) {\n          try {\n            await effect.delete();\n            totalRemoved++;\n          } catch (error) {\n            LogUtil.error(`Failed to remove status effect from ${actor.name}`, [error]);\n          }\n        }\n      }\n\n      if (totalRemoved > 0) {\n        FlashAPI.notify('info', `Removed ${totalRemoved} status effects`);\n      }\n    } else if (menu && menu.rendered) {\n      await RollMenuEventManager.removeAllStatusEffectsFromSelected(menu);\n    }\n  }\n\n  /**\n   * Open character sheets for actors\n   * @param {string[]} actorIds - Array of actor/token IDs to open sheets for\n   */\n  static openSheets(actorIds) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      actorIds.forEach(uniqueId => {\n        const actor = getActorData(uniqueId);\n        if (!actor) return;\n\n        const actorId = actor.id;\n        const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n        RollMenuEventManager.openActorSheetById(actorId, tokenId);\n      });\n    } else if (menu && menu.rendered) {\n      RollMenuEventManager.openSheetsForSelected(menu);\n    }\n  }\n\n  /**\n   * Create a group or encounter from selected actors\n   * @param {string[]} actorIds - Array of actor/token IDs to group\n   */\n  static async groupSelected(actorIds) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      const tempMenu = { selectedActors: new Set(actorIds) };\n      await RollMenuEventManager.createGroupFromSelected(tempMenu);\n    } else if (menu && menu.rendered) {\n      await RollMenuEventManager.createGroupFromSelected(menu);\n    } else {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n    }\n  }\n\n  /**\n   * Toggle movement restriction for actors\n   * @param {string[]} actorIds - Array of actor/token IDs to toggle movement for\n   */\n  static async toggleMovement(actorIds) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      const tempMenu = { selectedActors: new Set(actorIds) };\n      await TokenMovementManager.toggleMovementForSelected(tempMenu);\n    } else if (menu && menu.rendered) {\n      await TokenMovementManager.toggleMovementForSelected(menu);\n    } else {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n    }\n  }\n\n  /**\n   * Open the contested roll dialog for selected actors\n   * @param {string[]} actorIds - Array of actor/token IDs for contested roll\n   */\n  static async openContestedRoll(actorIds) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      const tempMenu = { selectedActors: new Set(actorIds) };\n      await RollMenuEventManager.openContestedRollDialog(tempMenu);\n    } else if (menu && menu.rendered) {\n      await RollMenuEventManager.openContestedRollDialog(menu);\n    } else {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n    }\n  }\n\n  /**\n   * Place tokens for selected actors on the canvas\n   * @param {string[]} actorIds - Array of actor/token IDs to place\n   * @param {Object} [location] - Optional location to place tokens {x: number, y: number}. If not provided, enters interactive placement mode.\n   */\n  static async placeTokens(actorIds, location = null) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      if (location && typeof location === 'object' && typeof location.x === 'number' && typeof location.y === 'number') {\n        await TokenPlacementManager.placeTokensAtLocation(actorIds, location);\n      } else {\n        const tempMenu = { selectedActors: new Set(actorIds) };\n        await TokenPlacementManager.placeTokensForSelectedActors(tempMenu);\n      }\n    } else if (menu && menu.rendered) {\n      await TokenPlacementManager.placeTokensForSelectedActors(menu);\n    } else {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n    }\n  }\n\n  /**\n   * Teleport tokens to a destination scene and location\n   * @param {string[]} actorIds - Array of actor/token IDs to teleport\n   * @param {string|Object} [destinationScene] - Optional scene ID, name, or scene object. If not provided, enters interactive teleport mode.\n   * @param {Object} [centerLocation] - Optional center location {x: number, y: number}. Required if destinationScene is provided.\n   */\n  static async teleportTokens(actorIds, destinationScene = null, centerLocation = null) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      if (destinationScene && centerLocation && typeof centerLocation === 'object' && typeof centerLocation.x === 'number' && typeof centerLocation.y === 'number') {\n        await TokenTeleportManager.teleportToDestination(actorIds, destinationScene, centerLocation);\n      } else {\n        const tempMenu = { selectedActors: new Set(actorIds) };\n        await TokenTeleportManager.teleportSelectedTokens(tempMenu);\n      }\n    } else if (menu && menu.rendered) {\n      await TokenTeleportManager.teleportSelectedTokens(menu);\n    } else {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n    }\n  }\n\n  /**\n   * Transform actors into a target actor\n   * @param {string[]} actorIds - Array of actor/token IDs to transform\n   * @param {string} [targetActorUuid] - UUID of actor to transform into (shows dialog if omitted)\n   * @param {Object} [options] - Transformation options\n   * @param {string} [options.preset] - Preset name: \"wildshape\", \"polymorph\", or \"custom\"\n   * @param {Object} [options.settings] - Custom TransformationSetting configuration\n   * @param {boolean} [options.renderSheet=false] - Show actor sheet after transformation\n   * @returns {Promise<void>}\n   */\n  static async transformActors(actorIds, targetActorUuid = null, options = {}) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      await TransformationManager.transformActors(actorIds, targetActorUuid, options);\n    } else if (menu && menu.rendered) {\n      await TransformationManager.transformSelectedActors(menu);\n    } else {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n    }\n  }\n\n  /**\n   * Revert transformed actors to original form\n   * @param {string[]} actorIds - Array of actor/token IDs to revert\n   * @returns {Promise<void>}\n   */\n  static async revertTransformation(actorIds) {\n    const menu = RollRequestsMenu.getInstance();\n\n    if (actorIds && actorIds.length > 0) {\n      await TransformationManager.revertTransformation(actorIds);\n    } else if (menu && menu.rendered) {\n      const selectedActorIds = Array.from(menu.selectedActors);\n      await TransformationManager.revertTransformation(selectedActorIds);\n    } else {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n    }\n  }\n\n  /**\n   * Show a notification to the user\n   * @param {string} type - Notification type ('info', 'warn', 'error')\n   * @param {string} message - Message to display\n   */\n  static notify(type, message) {\n    GeneralUtil.notify(type, message);\n  }\n}","import { MODULE_ID } from '../../constants/General.mjs';\nimport { LogUtil } from './LogUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SettingsUtil } from './SettingsUtil.mjs';\nimport { GeneralUtil } from './GeneralUtil.mjs';\nimport { FlashAPI } from '../core/FlashAPI.mjs';\n\n/**\n * Utility for managing libWrapper integrations\n * Provides centralized control for prototype overrides with graceful degradation\n */\nexport class LibWrapperUtil {\n  static #registeredWrappers = new Set();\n  static #libWrapperChecked = false;\n  static #libWrapperAvailable = false;\n\n  /**\n   * Check if libWrapper module is available\n   * @returns {boolean} True if libWrapper is active and available\n   */\n  static isAvailable() {\n    if (!this.#libWrapperChecked) {\n      this.#libWrapperAvailable = game.modules.get('lib-wrapper')?.active ?? false;\n      this.#libWrapperChecked = true;\n    }\n    return this.#libWrapperAvailable;\n  }\n\n  /**\n   * Register a wrapper using libWrapper if available\n   * @param {string} target - The target to wrap (e.g., 'Token.prototype.animate')\n   * @param {Function} fn - The wrapper function\n   * @param {string} type - The wrapper type ('WRAPPER', 'MIXED', 'OVERRIDE')\n   * @param {Object} options - Additional options\n   * @param {boolean} options.required - If false, silently fail when libWrapper unavailable\n   * @returns {boolean} True if registration succeeded\n   */\n  static register(target, fn, type = 'WRAPPER', options = {}) {\n    if (!this.isAvailable()) {\n      if (options.required) {\n        LogUtil.warn(`LibWrapperUtil.register - libWrapper required but not available for: ${target}`);\n      }\n      return false;\n    }\n\n    try {\n      libWrapper.register(MODULE_ID, target, fn, type);\n      this.#registeredWrappers.add(target);\n      LogUtil.log(`LibWrapperUtil.register - Successfully registered: ${target}`);\n      return true;\n    } catch (error) {\n      LogUtil.error(`LibWrapperUtil.register - Failed to register ${target}:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Unregister a specific wrapper\n   * @param {string} target - The target to unregister\n   */\n  static unregister(target) {\n    if (!this.isAvailable()) return;\n\n    try {\n      libWrapper.unregister(MODULE_ID, target);\n      this.#registeredWrappers.delete(target);\n      LogUtil.log(`LibWrapperUtil.unregister - Successfully unregistered: ${target}`);\n    } catch (error) {\n      LogUtil.error(`LibWrapperUtil.unregister - Failed to unregister ${target}:`, error);\n    }\n  }\n\n  /**\n   * Unregister all wrappers registered by this module\n   */\n  static unregisterAll() {\n    if (!this.isAvailable()) return;\n\n    for (const target of this.#registeredWrappers) {\n      this.unregister(target);\n    }\n    this.#registeredWrappers.clear();\n    LogUtil.log('LibWrapperUtil.unregisterAll - All wrappers unregistered');\n  }\n\n  /**\n   * Get all registered wrapper targets\n   * @returns {string[]} Array of registered targets\n   */\n  static getRegisteredWrappers() {\n    return Array.from(this.#registeredWrappers);\n  }\n\n  /**\n   * Show a one-time notification about missing libWrapper\n   * Only shows if libWrapper is not available and user hasn't seen the notification\n   * If libWrapper IS available, resets the notification flag so it can show again if libWrapper is later removed\n   */\n  static showMissingLibWrapperNotification() {\n    if (!game.user.isGM) return;\n\n    const SETTINGS = getSettings();\n\n    if (this.isAvailable()) {\n      const alreadyShown = SettingsUtil.get(SETTINGS.libWrapperNotificationShown.tag);\n      if (alreadyShown) {\n        SettingsUtil.set(SETTINGS.libWrapperNotificationShown.tag, false);\n      }\n      return;\n    }\n\n    const alreadyShown = SettingsUtil.get(SETTINGS.libWrapperNotificationShown.tag);\n\n    if (!alreadyShown) {\n      FlashAPI.notify('info',\n        game.i18n.localize('FLASH_ROLLS.notifications.libWrapperRecommended'),\n        { permanent: true, console: false }\n      );\n      SettingsUtil.set(SETTINGS.libWrapperNotificationShown.tag, true);\n    }\n  }\n}\n","import { getSettings } from \"../../../constants/Settings.mjs\";\nimport { getSettingMenus } from \"../../../constants/SettingMenus.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\"\nimport { SettingsUtil } from \"../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../utils/GeneralUtil.mjs\";\nimport { FlashAPI } from \"../../core/FlashAPI.mjs\";\nimport { IconLayoutUtil } from \"../../utils/IconLayoutUtil.mjs\";\nimport { LibWrapperUtil } from \"../../utils/LibWrapperUtil.mjs\";\n\nconst { FormDataExtended } = foundry.applications.ux;\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * Tabbed Settings Menu application for managing all module settings in a unified interface.\n * Provides a tabbed form interface for accessing all settings categories in one place.\n * @extends {HandlebarsApplicationMixin(ApplicationV2)}\n */ \nexport class ModuleSettingsMenu extends HandlebarsApplicationMixin(ApplicationV2) {\n  static #element;\n  static #activeTab;\n  static #requireReload;\n  static selectedTheme;\n\n  /**\n   * Default application options\n   * @static\n   */\n  static DEFAULT_OPTIONS = {\n    id: \"flash-rolls-settings\",\n    tag: \"form\",\n    window: {\n      icon: \"fas fa-cog\",\n      title: \"FLASH_ROLLS.settings.moduleSettingsMenu.title\",\n      contentClasses: [\"standard-form\", \"crlngn\", \"flash5e\", \"tabbed-settings\"],\n      resizable: true\n    },\n    position: {\n      width: 700,\n      height: \"auto\"\n    },\n    actions: {\n      redefine: ModuleSettingsMenu.#onReset\n    },\n    form: {\n      handler: ModuleSettingsMenu.#onSubmit,\n      closeOnSubmit: true\n    }\n  }\n\n  /**\n   * Template parts used for rendering the application\n   * @static\n   */\n  static PARTS = {\n    tabs: {\n      template: \"templates/generic/tab-navigation.hbs\",\n      isGMOnly: false\n    },\n    generalSettings: {\n      menuKey: \"generalSettings\",\n      template: \"modules/flash-rolls-5e/templates/settings-general.hbs\",\n      isGMOnly: true\n    },\n    interfaceSettings: {\n      menuKey: \"interfaceSettings\",\n      template: \"modules/flash-rolls-5e/templates/settings-interface.hbs\",\n      isGMOnly: true\n    },\n    groupRolls: {\n      menuKey: \"groupRollsSettings\",\n      template: \"modules/flash-rolls-5e/templates/settings-group-rolls.hbs\",\n      isGMOnly: true\n    },\n    rollRequests: {\n      menuKey: \"rollRequestsSettings\",\n      template: \"modules/flash-rolls-5e/templates/settings-roll-requests.hbs\",\n      isGMOnly: true\n    },\n    integrations: {\n      menuKey: \"integrationSettings\",\n      template: \"modules/flash-rolls-5e/templates/settings-integrations.hbs\",\n      isGMOnly: true\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n      isGMOnly: false\n    }\n  };\n\n  /**\n   * Tab configuration for the application\n   * @static\n   */\n  static TABS = {\n    primary: {\n      initial: \"interfaceSettings\",\n      tabs: ModuleSettingsMenu.#getTabs(),\n      labelPrefix: \"\"\n    }\n  };\n\n  /** @inheritDoc */\n  _configureRenderParts(options) {\n    const parts = super._configureRenderParts(options);\n    const restrictedTabs = ModuleSettingsMenu.getRestrictedTabs();\n\n    if(!game.user.isGM){\n      restrictedTabs.forEach(tab => {\n        delete parts[tab];\n      })\n    }\n\n    return parts;\n  }\n\n  /** @inheritDoc */\n  async _prepareContext(options) {\n    const context = await super._prepareContext(options);\n    context.activeTab = options.activeTab || Object.keys(context.tabs)[0];\n    context.isGM = game.user.isGM;\n    context.interceptWarning = GeneralUtil.isModuleOn(\"midi-qol\");\n    context.interceptWarning = game.i18n.localize(\"FLASH_ROLLS.notifications.interceptWarning\");\n\n    return context;\n  }\n\n   /** @inheritDoc */\n   async _preparePartContext(partId, context, options) {\n    const partContext = await super._preparePartContext(partId, context, options);\n    if ( partId in context.tabs ) partContext.tab = partContext.tabs[partId];\n    const SETTINGS = getSettings();\n    const SETTINGS_MENUS = getSettingMenus();\n    const restrictedTabs = ModuleSettingsMenu.getRestrictedTabs();\n\n    if(!game.user.isGM){\n      restrictedTabs.forEach(tab => {\n        delete partContext.tabs[tab];\n      })\n    }\n    switch ( partId ) {\n      case \"tabs\": {\n        break;\n      }\n      case \"footer\": {\n        partContext.buttons = [\n          { type: \"button\", icon: \"\", label: \"FLASH_ROLLS.ui.buttons.reset\", action: 'redefine' },\n          { type: \"submit\", icon: \"\", label: \"FLASH_ROLLS.ui.buttons.save\" }\n        ];\n        break;\n      }\n      default: {\n        partContext.tab = partContext.tabs[partId];\n        const partKey = ModuleSettingsMenu.PARTS[partId]?.menuKey || null;\n        if(partKey){\n          const menuContext = ModuleSettingsMenu.getMenuContext(partKey);\n          \n          if (menuContext.fields) {\n            partContext.fields = {\n              ...partContext.fields,\n              ...menuContext.fields\n            }\n          }\n\n          if (menuContext.fieldDefaults) {\n            partContext.fieldDefaults = {\n              ...partContext.fieldDefaults,\n              ...menuContext.fieldDefaults\n            }\n          }\n\n          if (menuContext.fieldValues) {\n            Object.assign(partContext, menuContext.fieldValues);\n          }\n\n          // Add icon layout data for interface settings\n          if (partId === 'interfaceSettings') {\n            partContext.iconConfigs = IconLayoutUtil.getIconConfigurations();\n\n            // Build complete icon list from mappings, then apply saved settings\n            const configs = IconLayoutUtil.getIconConfigurations();\n            const SETTINGS = getSettings();\n            const defaultIconsLayout = SETTINGS.menuIconsLayout.default;\n            const savedSettings = partContext.menuIconsLayout || {};\n\n            // Create a function to merge icon configs with default and saved settings\n            const buildIconList = (iconType, iconConfigs) => {\n              const defaultIcons = defaultIconsLayout[iconType] || [];\n              const savedIcons = savedSettings[iconType] || [];\n\n              const defaultIconsMap = new Map(defaultIcons.map(icon => [icon.id, icon]));\n              const savedIconsMap = new Map(savedIcons.map(icon => [icon.id, icon]));\n\n              // Get all available icons from mappings\n              const allIcons = Object.keys(iconConfigs).map((iconId, index) => {\n                const config = iconConfigs[iconId];\n                const defaultIcon = defaultIconsMap.get(iconId);\n                const savedIcon = savedIconsMap.get(iconId);\n\n                return {\n                  id: iconId,\n                  icon: config.icon,\n                  // Priority: saved settings > default settings > disabled for new icons\n                  enabled: savedIcon ? savedIcon.enabled : (defaultIcon ? defaultIcon.enabled : false),\n                  order: savedIcon ? savedIcon.order : (defaultIcon ? defaultIcon.order : index),\n                  label: game.i18n.localize(config.labelKey || iconId)\n                };\n              });\n\n              // Sort by order\n              return allIcons.sort((a, b) => a.order - b.order);\n            };\n\n            partContext.menuIconsLayout = {\n              moduleActions: buildIconList('moduleActions', configs.moduleActions),\n              actorActions: buildIconList('actorActions', configs.actorActions)\n            };\n          }\n\n          partContext.sidebarTabs = Object.values(foundry.applications?.sidebar?.tabs || {}).map(tab => ({\n            tabName: tab.tabName,\n            name: tab.name,\n            hideForGM: false,\n            hideForPlayer: false,\n            localizedName: `FLASH_ROLLS.settings.sidebarTabs.${tab.name}`\n          }));\n        }\n        break;\n      }\n    }\n    LogUtil.log(\"_preparePartContext\", [partContext, partId]);\n    return partContext;\n  }\n\n  /**\n   * Retrieves the context object containing fields, field values, and field defaults for a specific menu\n   * @param {string} menuKey - The key of the setting menu\n   * @returns {object} The context object containing fields, field values, and field defaults\n   */\n  static getMenuContext(menuKey){\n    const SETTINGS = getSettings();\n    const fieldNames = SETTINGS[menuKey]?.fields || null;\n    if(!fieldNames) return {};\n    const fields = {};\n    const fieldValues = {};\n    const fieldDefaults = {};\n\n    fieldNames.forEach((fieldName) => {\n      if(SETTINGS[fieldName]) {\n        const value = SettingsUtil.get(SETTINGS[fieldName].tag);\n        fields[fieldName] = SETTINGS[fieldName];\n        fieldValues[fieldName] = value!== undefined ? value : SETTINGS[fieldName].default;\n        fieldDefaults[fieldName] = SETTINGS[fieldName].default;\n      }\n    });\n\n    return {fields: fields, fieldValues: fieldValues, fieldDefaults: fieldDefaults};\n  }\n\n  /**\n   * Retrieves the keys of setting menus that are restricted to GMs\n   * @returns {string[]} Array of setting menu keys\n   */\n  static getRestrictedTabs(){\n    const restrictedTabs = [];\n    Object.entries(ModuleSettingsMenu.PARTS).forEach((entry, index) => {\n      if(entry[0]!==\"tabs\" && entry[0]!==\"footer\" && entry[1].isGMOnly){\n        restrictedTabs.push(entry[0]);\n      }\n    });\n    return restrictedTabs;\n  }\n\n  /**\n   * Handles post-render operations\n   * @protected\n   * @param {object} context - The render context\n   * @param {object} options - The render options\n   */\n  _onRender = (context, options) => {\n    const SETTINGS = getSettings();\n    ModuleSettingsMenu.#element = this.element;\n\n    const hintToggles = ModuleSettingsMenu.#element.querySelectorAll('.toggle-hint');\n    hintToggles.forEach(toggle => {\n      toggle.addEventListener('click', () => {\n        ModuleSettingsMenu.#element.querySelectorAll('p.hint').forEach(p => p.classList.toggle('shown'));\n      });\n    });\n\n    // Initialize icon drag and drop functionality\n    const iconContainer = ModuleSettingsMenu.#element.querySelector('.icon-arrangement-container');\n    if (iconContainer) {\n      IconLayoutUtil.initializeDragAndDrop(iconContainer);\n    }\n    \n    const selects = ModuleSettingsMenu.#element.querySelectorAll('select[data-current-value]');\n    selects.forEach(select => {\n      const currentValue = String(select.dataset.currentValue);\n      const option = select.querySelector(`option[value=\"${currentValue}\"]`);\n      if (option) {\n        option.selected = true;\n      }\n    });\n    \n    // Set up range input synchronization\n    this.#setupRangeInputs();\n  }\n\n  /**\n   * Set up synchronization between range sliders and number inputs\n   */\n  #setupRangeInputs() {\n    const rangeGroups = ModuleSettingsMenu.#element.querySelectorAll('.form-group.range');\n    rangeGroups.forEach(group => {\n      const rangeInput = group.querySelector('input[type=\"range\"]');\n      const valueInput = group.querySelector('input[type=\"number\"]');\n      this.#handleRangeInputs(rangeInput, valueInput);\n    });\n  }\n\n  /**\n   * Handle synchronization between range slider and number input\n   * @param {HTMLInputElement} rangeInput - The range slider input\n   * @param {HTMLInputElement} valueInput - The number input\n   */\n  #handleRangeInputs(rangeInput, valueInput) {\n    if (rangeInput && valueInput) {\n      const min = parseInt(rangeInput.min, 10);\n      const max = parseInt(rangeInput.max, 10);\n\n      // Listener for the range slider's input event\n      rangeInput.addEventListener('input', () => {\n        valueInput.value = rangeInput.value;\n      });\n\n      // Listener for the number input's input event (while typing)\n      valueInput.addEventListener('input', () => {\n        const currentValueString = valueInput.value;\n        if (currentValueString === \"\" || currentValueString === \"-\") {\n          return;\n        }\n        const currentValue = parseInt(currentValueString, 10);\n        if (!isNaN(currentValue) && currentValue >= min && currentValue <= max) {\n          rangeInput.value = currentValue;\n        }\n      });\n\n      // Listener for the number input's change event (after typing/blur/enter)\n      valueInput.addEventListener('change', () => {\n        let value = parseInt(valueInput.value, 10);\n\n        if (isNaN(value) || value < min) {\n          value = min;\n        } else if (value > max) {\n          value = max;\n        }\n        \n        valueInput.value = value; // Update the input field to the clamped/validated value\n        rangeInput.value = value; // Sync the slider\n      });\n\n      // Set initial value for the number input from the range slider\n      valueInput.value = rangeInput.value;\n    }\n  }\n\n  /**\n   * Handles form submission and updates left controls settings\n   * @private\n   * @static\n   * @param {Event} event - The form submission event\n   * @param {HTMLFormElement} form - The form element\n   * @param {FormData} formData - The form data object\n   * @returns {Promise<void>}\n   */\n  static async #onSubmit(event, form, formData) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    let confirmReload = ModuleSettingsMenu.updateSettings(formData);\n\n    if(confirmReload){\n      GeneralUtil.confirmReload();\n    }\n  }\n\n  static updateSettings(formData){\n    let confirmReload = false;\n    const SETTINGS = getSettings();\n    const html = ModuleSettingsMenu.#element;\n    const activeContent = html.querySelector(\".form-content.active\");\n    const activeTab = activeContent.dataset.tab;\n    ModuleSettingsMenu.#activeTab = activeTab;\n\n    if(!formData){\n      return;\n    }\n\n    // Convert FormData into an object with proper keys\n    let settings;\n    if (formData.object) {\n      settings = foundry.utils.expandObject(formData.object);\n    } \n\n    let fieldNames = [];\n\n    Object.entries(settings).forEach(([fieldName, value]) => {\n      // Skip auxiliary form fields like range value inputs\n      if(fieldName.endsWith('_value')) return;\n      \n      LogUtil.log(\"updateSettings #1\", [SETTINGS, SETTINGS[fieldName]]);\n      if(settings[fieldName] !== undefined && SETTINGS[fieldName]) {\n        const currSetting = SettingsUtil.get(SETTINGS[fieldName].tag);\n        SettingsUtil.set(SETTINGS[fieldName].tag, settings[fieldName]);\n        \n        if(SETTINGS[fieldName]?.requiresReload && currSetting !== settings[fieldName]){\n          confirmReload = true;\n        }\n      }\n    });\n\n    FlashAPI.notify('info',game.i18n.localize('FLASH_ROLLS.notifications.settingsUpdated'));\n    return confirmReload;\n  }\n\n  /** @inheritDoc */\n  changeTab(tab, group, options) {\n    super.changeTab(tab, group, options);\n    ModuleSettingsMenu.#activeTab = tab;\n  }\n\n  /**\n   * Resets form fields to their default values\n   * @private\n   * @static\n   * @param {Event} a - The reset event\n   * @param {HTMLElement} b - The form element\n   * @returns {Promise<void>}\n   */\n  static async #onReset(a, b){\n    const SETTINGS = getSettings();\n    const html = ModuleSettingsMenu.#element;\n    const activeContent = html.querySelector(\".form-content.active\");\n    const activeTab = activeContent.dataset.tab;\n    const menuKey = ModuleSettingsMenu.PARTS[activeTab].menuKey;\n    const defaults = SETTINGS[menuKey].default;\n\n    // Handle icon layout reset for interface settings\n    if (activeTab === 'interfaceSettings') {\n      IconLayoutUtil.resetToDefault();\n      const app = foundry.applications.instances.get('flash-rolls-settings');\n      if (app) {\n        await app.renderPart('interfaceSettings', { force: true });\n        return;\n      }\n    }\n\n    const inputs = activeContent.querySelectorAll(\"input, select\");\n    inputs.forEach(inputField => {\n      const nameParts = inputField.name.split('.');\n      let defaultValue = defaults;\n      for (const part of nameParts) {\n        defaultValue = defaultValue?.[part];\n      }\n      if (defaultValue !== undefined) {\n        inputField.value = defaultValue;\n        if (inputField.type === 'checkbox') {\n          inputField.checked = defaultValue;\n        }\n      }\n    });\n\n    LogUtil.log(\"#onReset\", [ModuleSettingsMenu.#activeTab, activeTab, a, b]);\n  }\n\n  static #getTabs() {\n    const tabList = [];\n    Object.entries(ModuleSettingsMenu.PARTS).forEach(([key, value]) => {\n      if(value.menuKey) {\n        tabList.push({\n          id: key,\n          icon: '',\n          group: 'primary-tabs',\n          label: `FLASH_ROLLS.settings.moduleSettingsMenu.tabs.${key}`\n        })\n      }\n    })\n    return tabList;\n  }\n\n}\n","import { ModuleSettingsMenu } from '../components/ui/dialogs/ModuleSettingsMenu.mjs';\nimport { PremiumFeaturesDialog } from '../components/ui/dialogs/PremiumFeaturesDialog.mjs';\n\nexport function getSettingMenus() {\n  return {\n    moduleSettingsMenu: {\n      tab: '',\n      tag: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      name: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      icon: \"fas fa-cog\",\n      propType: ModuleSettingsMenu,\n      restricted: true\n    },\n    premiumFeatures: {\n      tab: '',\n      tag: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.label\"),\n      name: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.label\"),\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.buttonLabel\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.premiumFeatures.hint\"),\n      icon: \"fas fa-gem\",\n      propType: PremiumFeaturesDialog,\n      restricted: true\n    }\n  };\n}","import { MODULE_ID } from \"../../constants/General.mjs\";\nimport { getSettings, SETTING_SCOPE } from \"../../constants/Settings.mjs\";\nimport { getSettingMenus } from \"../../constants/SettingMenus.mjs\";\nimport { getDefaultIconLayout } from \"../../constants/IconMappings.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport RollRequestsMenu from \"../ui/RollRequestsMenu.mjs\";\nimport { GeneralUtil } from \"./GeneralUtil.mjs\";\nimport { TokenMovementManager } from \"./TokenMovementManager.mjs\";\n\n/**\n * Utility class for managing module settings\n */\nexport class SettingsUtil {\n  static coreColorScheme = \"dark\";\n  \n  /**\n   * Register all module settings\n   * @static\n   */\n  static registerSettings() {\n    const SETTINGS = getSettings();\n    var isDebugOn = SettingsUtil.get(SETTINGS.debugMode.tag);\n    if(isDebugOn){CONFIG.debug.hooks = true};\n\n    /* Register each of the settings defined in the SETTINGS constant */\n    const settingsList = Object.entries(SETTINGS);\n    settingsList.forEach((entry) => {\n      const setting = entry[1]; \n\n      const settingObj = { \n        name: setting.label,\n        hint: setting.hint,\n        default: setting.default,\n        type: setting.propType,\n        scope: setting.scope,\n        config: setting.config,\n        requiresReload: setting.requiresReload || false,\n        restricted: setting.scope === SETTING_SCOPE.world,\n        onChange: value => SettingsUtil.apply(setting.tag, value)\n      }\n      if(setting.choices){\n        settingObj.choices = setting.choices;\n      }\n\n      LogUtil.log('registerSettings', [settingObj, settingObj.scope]);\n\n      try {\n        game.settings.register(MODULE_ID, setting.tag, settingObj);\n      } catch (error) {\n        LogUtil.log(`Setting ${setting.tag} already registered or error:`, error);\n      }\n    });\n    \n  }\n\n  /**\n   * Register the settings menu - should be called during ready hook\n   * @static\n   */\n  static registerSettingsMenu() {\n    const settingMenus = Object.entries(getSettingMenus());\n\n    for (const [menuKey, menuData] of settingMenus) {\n      if ((menuData.restricted && game.user?.isGM) || !menuData.restricted) {\n        const menuObj = {\n          name: menuData.tag,\n          label: menuData.label,\n          hint: menuData.hint,\n          icon: menuData.icon,\n          type: menuData.propType,\n          restricted: menuData.restricted\n        };\n        game.settings.registerMenu(MODULE_ID, menuData.tag, menuObj);\n      }\n    }\n\n    SettingsUtil.updateColorScheme();\n    SettingsUtil.validateAndUpdateIconLayout();\n    SettingsUtil.checkMidiQol();\n    SettingsUtil.initializeMaxIconsPerRow();\n  }\n\n  /**\n   * Verify if Midi-QoL is installed and active\n   * Disable incompatible settings if true\n   */\n  static checkMidiQol(){\n    const SETTINGS = getSettings();\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n    const isRollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n    \n    LogUtil.log('checkMidiQol', [isMidiActive, isRollInterceptionEnabled]);\n    \n    // if(game.user?.isGM && isMidiActive && isRollInterceptionEnabled){\n    //   // SettingsUtil.set(SETTINGS.rollInterceptionEnabled.tag, false);\n    //   // ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.notifications.interceptWarning\"), {permanent: true});\n    // }\n  }\n\n  static updateColorScheme(){\n    // const uiConfig = SettingsUtil.get(\"uiConfig\", \"core\"); \n    const foundryUiConfig = game.settings.get('core','uiConfig'); \n    let interfaceTheme = foundryUiConfig?.colorScheme?.interface;\n    \n    // If Browser Default, detect browser preference\n    if (!interfaceTheme) {\n      if (matchMedia(\"(prefers-color-scheme: dark)\").matches) {\n        interfaceTheme = \"dark\";\n      } else if (matchMedia(\"(prefers-color-scheme: light)\").matches) {\n        interfaceTheme = \"light\";\n      }\n    }\n    \n    SettingsUtil.coreColorScheme = interfaceTheme;\n    LogUtil.log('SettingsUtil.updateColorScheme', [foundryUiConfig, SettingsUtil.coreColorScheme]);\n  }\n  \n  /**\n   * Retrieves the value of a module setting\n   * @param {string} settingName - Name of the setting to retrieve\n   * @param {string} [moduleName=MODULE_ID] - ID of the module the setting belongs to\n   * @returns {*} Current value of the setting\n   */\n  static get(settingName, moduleName=MODULE_ID){\n    if(!settingName){ return null; }\n\n    let setting = false;\n\n    try {\n      if(moduleName===MODULE_ID){\n        setting = game.settings.get(moduleName, settingName);\n      }else{\n        const client = game.settings.storage.get(\"client\");\n        let selectedSetting = client[`${moduleName}.${settingName}`];\n        //\n        if(selectedSetting===undefined){\n          const world = game.settings.storage.get(\"world\");\n          selectedSetting = world.getSetting(`${moduleName}.${settingName}`);\n          setting = selectedSetting?.value;\n        }\n      }\n    } catch (error) {\n      // Setting not registered yet, return default\n      LogUtil.log(`Setting ${moduleName}.${settingName} not found, returning false`);\n      return false;\n    }\n\n    return setting;\n  }\n  \n  /**\n   * Updates the value of a module setting\n   * @param {string} settingName - Name of the setting to update\n   * @param {*} newValue - New value to set\n   * @param {string} [moduleName=MODULE_ID] - ID of the module the setting belongs to\n   * @returns {Promise<boolean>} True if setting was updated successfully\n   */\n  static async set(settingName, newValue, moduleName=MODULE_ID){\n    if(!settingName){ return false; }\n\n    let selectedSetting = game.settings.storage.get(\"client\")[`${moduleName}.${settingName}`];\n\n    if(!selectedSetting){\n      const world = game.settings.storage.get(\"world\");\n      selectedSetting = world.getSetting(`${moduleName}.${settingName}`);\n      LogUtil.log('SettingsUtil.set - world Setting?', [selectedSetting]);\n    }\n\n    try{\n      await game.settings.set(moduleName, settingName, newValue);\n      LogUtil.log('SettingsUtil.set - success', [moduleName, settingName]);\n    }catch(e){\n      LogUtil.error('SettingsUtil.set - error', [e]);\n    }\n\n    return true;\n  }\n\n  static apply(settingName, newValue){\n    const SETTINGS = getSettings();\n    switch(settingName){\n      case SETTINGS.rollRequestsEnabled.tag:\n        SettingsUtil.applyRollRequestsEnabled(newValue);\n        break;\n      case SETTINGS.rollInterceptionEnabled.tag:\n        SettingsUtil.applyRollInterceptionEnabled(newValue);\n        break;\n      case SETTINGS.compactMode.tag:\n        SettingsUtil.applyCompactMode(newValue);\n        break;\n      case SETTINGS.menuLayout.tag:\n        SettingsUtil.applyMenuLayout(newValue);\n        break;\n      case SETTINGS.menuIconsLayout.tag:\n        SettingsUtil.applyMenuIconsLayout(newValue);\n        break;\n      case SETTINGS.maxIconsPerRow.tag:\n        SettingsUtil.applyMaxIconsPerRow(newValue);\n        break;\n      case SETTINGS.actorStatsToShow.tag:\n        SettingsUtil.applyActorStatsToShow(newValue);\n        break;\n      case SETTINGS.autoBlockMovementInCombat.tag:\n        SettingsUtil.applyAutoBlockMovementInCombat(newValue);\n        break;\n      default:\n        break;\n    }\n  }\n\n  static applyRollInterceptionEnabled(newValue){\n    SettingsUtil.checkMidiQol();\n  }\n\n  static applyRollRequestsEnabled(newValue){\n    const requestsIcon = document.querySelector(\".chat-controls .flash-rolls-icon\");\n    if(!requestsIcon){ return; }\n    \n    if(newValue){\n      requestsIcon.classList.add(\"active\");\n    }else{\n      requestsIcon.classList.remove(\"active\");\n    }\n  }\n\n  static applyCompactMode(newValue){\n    const SETTINGS = getSettings();\n    const isCompactMode = newValue || SettingsUtil.get(SETTINGS.compactMode.tag);\n\n    LogUtil.log('applyCompactMode', [isCompactMode]);\n    \n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  static applyMenuLayout(newValue){\n    const SETTINGS = getSettings();\n    const menuLayout = newValue || SettingsUtil.get(SETTINGS.menuLayout.tag);\n\n    LogUtil.log('applyMenuLayout', [menuLayout]);\n\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  static applyMenuIconsLayout(newValue){\n    const SETTINGS = getSettings();\n    const menuIconsLayout = newValue || SettingsUtil.get(SETTINGS.menuIconsLayout.tag);\n\n    LogUtil.log('applyMenuIconsLayout', [menuIconsLayout]);\n\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  static applyActorStatsToShow(newValue){\n    LogUtil.log('applyActorStatsToShow', [newValue]);\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  static initializeMaxIconsPerRow(){\n    const SETTINGS = getSettings();\n    const maxIconsPerRow = SettingsUtil.get(SETTINGS.maxIconsPerRow.tag) || 5;\n    GeneralUtil.addCSSVars('--fr5e-menu-icons-limit', maxIconsPerRow);\n    LogUtil.log('initializeMaxIconsPerRow', [maxIconsPerRow]);\n  }\n\n  static applyMaxIconsPerRow(newValue){\n    const SETTINGS = getSettings();\n    let maxIconsPerRow = newValue || SettingsUtil.get(SETTINGS.maxIconsPerRow.tag) || 5;\n\n    const IconLayoutUtil = game.modules.get(MODULE_ID)?.api?.IconLayoutUtil;\n    if (IconLayoutUtil) {\n      const enabledActorIcons = IconLayoutUtil.getEnabledIcons('actorActions');\n      if (enabledActorIcons && maxIconsPerRow > enabledActorIcons.length) {\n        maxIconsPerRow = enabledActorIcons.length;\n      }\n    }\n\n    if (maxIconsPerRow < 1) maxIconsPerRow = 1;\n\n    LogUtil.log('applyMaxIconsPerRow', [maxIconsPerRow, newValue]);\n\n    GeneralUtil.addCSSVars('--fr5e-menu-icons-limit', maxIconsPerRow);\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Validate and update the menuIconsLayout setting to include any missing icons\n   * and remove any obsolete icons that no longer exist in IconMappings\n   * @static\n   */\n  static async validateAndUpdateIconLayout() {\n    const SETTINGS = getSettings();\n    const currentLayout = SettingsUtil.get(SETTINGS.menuIconsLayout.tag);\n    const defaultLayout = getDefaultIconLayout();\n\n    if (!currentLayout) {\n      LogUtil.log('validateAndUpdateIconLayout - no current layout found, using default');\n      return;\n    }\n\n    let updated = false;\n    const updatedLayout = foundry.utils.deepClone(currentLayout);\n\n    // Check each icon type (moduleActions, actorActions)\n    for (const [iconType, defaultIcons] of Object.entries(defaultLayout)) {\n      if (!updatedLayout[iconType]) {\n        updatedLayout[iconType] = [];\n      }\n\n      // Get valid icon IDs from the default layout (these are the ones that should exist)\n      const validIds = new Set(defaultIcons.map(icon => icon.id));\n\n      // Remove icons that are no longer in the IconMappings\n      const originalLength = updatedLayout[iconType].length;\n      updatedLayout[iconType] = updatedLayout[iconType].filter(icon => {\n        if (!validIds.has(icon.id)) {\n          LogUtil.log(`validateAndUpdateIconLayout - removed obsolete icon: ${icon.id} from ${iconType}`);\n          updated = true;\n          return false;\n        }\n        return true;\n      });\n\n      // Get existing icon IDs after filtering\n      const existingIds = new Set(updatedLayout[iconType].map(icon => icon.id));\n\n      // Find the highest order number in existing icons\n      let maxOrder = Math.max(\n        ...updatedLayout[iconType].map(icon => icon.order || 0),\n        -1\n      );\n\n      // Add any missing icons from the default layout\n      for (const defaultIcon of defaultIcons) {\n        if (!existingIds.has(defaultIcon.id)) {\n          maxOrder++;\n          updatedLayout[iconType].push({\n            ...defaultIcon,\n            order: maxOrder\n          });\n          updated = true;\n          LogUtil.log(`validateAndUpdateIconLayout - added missing icon: ${defaultIcon.id} to ${iconType}`);\n        }\n      }\n    }\n\n    // Save the updated layout if changes were made\n    if (updated) {\n      await SettingsUtil.set(SETTINGS.menuIconsLayout.tag, updatedLayout);\n      LogUtil.log('validateAndUpdateIconLayout - updated layout', updatedLayout);\n    } else {\n      LogUtil.log('validateAndUpdateIconLayout - no changes needed');\n    }\n  }\n\n  /**\n   * Apply auto-block movement in combat setting changes\n   * @param {boolean} newValue - The new setting value\n   * @static\n   */\n  static applyAutoBlockMovementInCombat(newValue) {\n    if (!game.user.isGM) return;\n\n    const activeCombat = game.combat;\n    if (!activeCombat) return;\n\n    LogUtil.log('applyAutoBlockMovementInCombat', [newValue, activeCombat]);\n\n    if (newValue) {\n      TokenMovementManager.onCombatStart(activeCombat, {});\n    } else {\n      TokenMovementManager.onCombatEnd(activeCombat);\n    }\n  }\n}\n","import { ActorStatusManager } from '../managers/ActorStatusManager.mjs';\nimport { LogUtil } from './LogUtil.mjs';\nimport { HOOKS_CORE } from '../../constants/Hooks.mjs';\n\n/**\n * Utility class for managing Flash Token Bar status icons in the Actor Directory\n */\nexport class ActorDirectoryIconUtil {\n  /**\n   * Initialize the Actor Directory icon system\n   */\n  static initialize() {\n    LogUtil.log('ActorDirectoryIconUtil.initialize');\n    \n    // Hook into Actor Directory renders\n    Hooks.on(HOOKS_CORE.RENDER_ACTOR_DIRECTORY, this.onRenderActorDirectory.bind(this));\n    \n    // Hook into actor flag changes to update icons\n    Hooks.on(HOOKS_CORE.UPDATE_ACTOR, this.onUpdateActor.bind(this));\n    \n    // Update any already-rendered Actor Directory\n    this.updateExistingDirectory();\n  }\n\n  /**\n   * Update icons in an already-rendered Actor Directory\n   */\n  static updateExistingDirectory() {\n    // Find any existing Actor Directory\n    const actorDirectory = ui.actors;\n    if (actorDirectory && actorDirectory.rendered && actorDirectory.element) {\n      LogUtil.log('ActorDirectoryIconUtil.updateExistingDirectory - Found rendered directory, adding icons');\n      this.onRenderActorDirectory(actorDirectory, actorDirectory.element);\n    } else {\n      LogUtil.log('ActorDirectoryIconUtil.updateExistingDirectory - No rendered directory found');\n    }\n  }\n\n  /**\n   * Handle Actor Directory render to add status icons\n   * @param {ActorDirectory} app - The Actor Directory application\n   * @param {HTMLElement} html - The rendered HTML\n   */\n  static onRenderActorDirectory(app, html) {\n    const actorItems = html.querySelectorAll('.directory-item.actor');\n    actorItems.forEach((element) => {\n      const actorId = element.dataset.entryId || element.dataset.documentId;\n      if (actorId) {\n        this.updateActorIcon(element, actorId);\n      }\n    });\n  }\n\n  /**\n   * Handle actor updates to refresh icons when status changes\n   * @param {Actor} actor - The updated actor\n   * @param {Object} changes - The changes made to the actor\n   */\n  static onUpdateActor(actor, changes) {\n    const flagChanges = changes.flags?.['flash-rolls-5e'];\n    if (flagChanges) {\n      LogUtil.log('ActorDirectoryIconUtil.onUpdateActor - Flash Token Bar flags changed', [actor.name, flagChanges]);\n      this.refreshActorIcon(actor.id);\n    }\n  }\n\n  /**\n   * Update the Flash Token Bar status icon for a specific actor element\n   * @param {HTMLElement} actorElement - The actor directory item element\n   * @param {string} actorId - The actor ID\n   */\n  static updateActorIcon(actorElement, actorId) {\n    const existingIcon = actorElement.querySelector('span.fas.fa-bolt, span.fas.fa-bolt-slash');\n    if (existingIcon) {\n      existingIcon.remove();\n    }\n\n    const actor = game.actors.get(actorId);\n    if (!actor) return;\n\n    const isFavorite = ActorStatusManager.isFavorite(actor);\n    const isBlocked = ActorStatusManager.isBlocked(actor);\n\n    if (!isFavorite && !isBlocked) return;\n    const icon = document.createElement('span');\n    \n    if (isBlocked) {\n      icon.className = 'fas fa-bolt-slash';\n      icon.dataset.tooltip = game.i18n.localize(\"FLASH_ROLLS.contextMenu.unblockFromMenu\");\n      icon.dataset.tooltipDirection = 'LEFT';\n      // Add click handler to unblock\n      icon.addEventListener('click', (event) => {\n        event.preventDefault();\n        event.stopPropagation();\n        ActorStatusManager.toggleBlocked(actorId, false);\n      });\n    } else if (isFavorite) {\n      icon.className = 'fas fa-bolt';\n      icon.dataset.tooltip = game.i18n.localize(\"FLASH_ROLLS.contextMenu.blockFromMenu\");\n      icon.dataset.tooltipDirection = 'LEFT';\n      // Add click handler to remove from favorites (same as unblock action)\n      icon.addEventListener('click', (event) => {\n        event.preventDefault();\n        event.stopPropagation();\n        ActorStatusManager.toggleFavorite(actorId, false);\n      });\n    }\n    \n    // Add cursor pointer style to indicate clickability\n    icon.style.cursor = 'pointer';\n    actorElement.appendChild(icon);\n  }\n\n  /**\n   * Refresh the icon for a specific actor by ID\n   * @param {string} actorId - The actor ID\n   */\n  static refreshActorIcon(actorId) {\n    const actorElement = document.querySelector(`.directory-item.actor[data-entry-id=\"${actorId}\"], .directory-item.actor[data-document-id=\"${actorId}\"]`);\n    if (actorElement) {\n      this.updateActorIcon(actorElement, actorId);\n    }\n  }\n\n  /**\n   * Refresh all actor icons in the directory\n   */\n  static refreshAllIcons() {\n    LogUtil.log('ActorDirectoryIconUtil.refreshAllIcons');\n    \n    const actorItems = document.querySelectorAll('.directory-item.actor');\n    actorItems.forEach(element => {\n      const actorId = element.dataset.entryId || element.dataset.documentId;\n      if (actorId) {\n        this.updateActorIcon(element, actorId);\n      }\n    });\n  }\n}","import { HOOKS_DND5E } from '../../constants/Hooks.mjs';\nimport { MODULE_ID, ACTIVITY_TYPES } from '../../constants/General.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { RollHelpers } from '../helpers/RollHelpers.mjs';\nimport { HooksManager } from '../core/HooksManager.mjs';\nimport { BaseActivityManager } from '../managers/BaseActivityManager.mjs';\nimport { MidiActivityManager } from '../managers/MidiActivityManager.mjs';\nimport { DnDBRollExecutor } from '../integrations/dnd-beyond/DnDBRollExecutor.mjs';\nimport { DnDBIntegration } from '../integrations/dnd-beyond/DnDBIntegration.mjs';\n\n/**\n * Handles roll-specific hooks\n * Contains only hook handler methods - registration is handled by HooksManager\n */\nexport class RollHooksHandler {\n\n  // ========================================\n  // GM-ONLY METHODS\n  // ========================================\n\n  /**\n   * Handle pre-roll hook on GM side to check for skip dialog conditions\n   * Only applies skip dialog logic to GM-side local rolls, never to roll requests sent to players\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialogOptions - Dialog display options\n   * @param {Object} messageOptions - Chat message options\n   */\n  static onPreRollGM(config, dialogOptions, messageOptions) {\n    // const SETTINGS = getSettings();\n    // if (config._flashRollsProcessed || BaseActivityManager.isMidiActive || !SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag)) return;\n    if (config._flashRollsProcessed || BaseActivityManager.isMidiActive) return;\n    config._flashRollsProcessed = true;\n\n    LogUtil.log(\"RollHooksHandler.onPreRollGM\", [config, dialogOptions, messageOptions]);\n\n    if (config.subject?.item) {\n      config.rolls = RollHelpers.consolidateRolls(config.rolls);\n      const areSkipKeysPressed = GeneralUtil.areSkipKeysPressed(config.event);\n      const stored = config.subject.item.getFlag(MODULE_ID, 'tempAttackConfig') || config.subject.item.getFlag(MODULE_ID, 'tempDamageConfig') || config.subject.item.getFlag(MODULE_ID, 'tempSaveConfig');\n      LogUtil.log(\"RollHooksHandler.onPreRollGM - flag\", [stored]);\n\n      if (stored?.skipRollDialog === true || areSkipKeysPressed) {\n        dialogOptions.configure = false;\n        LogUtil.log(\"RollHooksHandler.onPreRollGM - Local GM roll, skipping dialog via stored flag\");\n      }\n    }\n\n    if (DnDBRollExecutor.hasPendingDamageRoll() || DnDBRollExecutor.isDnDBDamageInProgress() || DnDBIntegration.hasPendingRoll()) {\n      dialogOptions.configure = false;\n      LogUtil.log(\"RollHooksHandler.onPreRollGM - DnDB roll detected, skipping dialog\");\n    }\n  }\n\n  // ========================================\n  // PLAYER-ONLY METHODS\n  // ========================================\n  /**\n   * Handle pre-roll initiative dialog to apply stored configuration from GM request\n   * Always forces dialog to show on player side regardless of GM's skip dialog settings\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialogOptions - Dialog display options\n   * @param {Object} messageOptions - Chat message options\n   */\n  static onPreRollInitiativeDialog(config, dialogOptions, messageOptions) {\n    // const SETTINGS = getSettings();\n    // if (config._flashRollsProcessed || !SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag)) return;\n    if (config._flashRollsProcessed) return;\n    config._flashRollsProcessed = true;\n\n    const actor = config.subject;\n    const areSkipKeysPressed = GeneralUtil.areSkipKeysPressed(config.event);\n    const storedConfig = actor.getFlag(MODULE_ID, 'tempInitiativeConfig');\n\n    LogUtil.log(\"RollHooksHandler.onPreRollInitiativeDialog triggered\", [config, storedConfig, dialogOptions, messageOptions]);\n\n    if (!storedConfig) {\n      LogUtil.log(\"RollHooksHandler.onPreRollInitiativeDialog - No stored config, player-initiated roll, returning early\");\n      return;\n    }\n\n    dialogOptions.configure = true;\n    LogUtil.log(\"RollHooksHandler.onPreRollInitiativeDialog - Player roll request, always showing dialog\");\n\n    config.advantage = storedConfig?.advantage || config.advantage || false;\n    config.disadvantage = storedConfig?.disadvantage || config.disadvantage || false;\n\n    config.rollMode = storedConfig?.rollMode || config.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n    messageOptions.rollMode = storedConfig?.rollMode || messageOptions.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n\n    if (storedConfig?.rolls?.[0]?.data?.situational && config.rolls?.[0]?.data) {\n      config.rolls[0].data.situational = storedConfig.rolls[0].data.situational;\n    }\n  }\n\n  /**\n   * Handle pre-roll attack hook to apply stored configuration from GM request\n   * Delegates Midi-specific logic to MidiActivityManager\n   */\n  static onPreRollAttackV2(config, dialogOptions, messageOptions) {\n    // const SETTINGS = getSettings();\n    // if (config._flashRollsProcessed || !SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag)) return;\n    if (config._flashRollsProcessed) return;\n    config._flashRollsProcessed = true;\n\n    LogUtil.log(\"RollHooksHandler.onPreRollAttackV2 triggered\", [config, dialogOptions, messageOptions]);\n\n    const stored = config.subject?.item?.getFlag(MODULE_ID, 'tempAttackConfig');\n\n    if (!stored) {\n      LogUtil.log(\"RollHooksHandler.onPreRollAttackV2 - No stored config, player-initiated roll, returning early\");\n      return;\n    }\n\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n    if (isMidiActive && config.midiOptions) {\n      MidiActivityManager.onPreRollAttackV2(config, dialogOptions, messageOptions);\n    }\n\n    dialogOptions.configure = true;\n    LogUtil.log(\"RollHooksHandler.onPreRollAttackV2 - Player roll request, always showing dialog\");\n\n    if (stored.attackMode) config.attackMode = stored.attackMode;\n    if (stored.ammunition) config.ammunition = stored.ammunition;\n    if (stored.mastery !== undefined) config.mastery = stored.mastery;\n    config.advantage = stored.advantage || false;\n    config.disadvantage = stored.disadvantage || false;\n    messageOptions.rollMode = stored.rollMode || messageOptions.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n\n    if (stored.situational) {\n      if (!config.rolls || config.rolls.length === 0) {\n        config.rolls = [{\n          parts: [],\n          data: {},\n          options: {}\n          }];\n      }\n\n      if (!config.rolls[0].data) {\n        config.rolls[0].data = {};\n      }\n      config.rolls[0].data.situational = stored.situational;\n    }\n    LogUtil.log(\"RollHooksHandler.onPreRollAttackV2 - Applied stored configuration to attack roll\", [config, messageOptions]);\n  }\n\n  /**\n   * Handle pre-roll damage hook to apply stored configuration from GM request\n   * Delegates Midi-specific logic to MidiActivityManager\n   */\n  static onPreRollDamageV2(config, dialogOptions, messageOptions) {\n    // const SETTINGS = getSettings();\n    // if (config._flashRollsProcessed || !SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag)) return;\n    if (config._flashRollsProcessed) return;\n    config._flashRollsProcessed = true;\n\n    LogUtil.log(\"RollHooksHandler.onPreRollDamageV2 triggered\", [config, dialogOptions, messageOptions]);\n\n    const stored = config.subject?.item?.getFlag(MODULE_ID, 'tempDamageConfig');\n\n    if (!stored) {\n      LogUtil.log(\"RollHooksHandler.onPreRollDamageV2 - No stored config, player-initiated roll, returning early\");\n      return;\n    }\n\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n    config.rolls = RollHelpers.consolidateRolls(config.rolls);\n\n    if (isMidiActive && config.midiOptions) {\n      MidiActivityManager.onPreRollDamageV2(config, dialogOptions, messageOptions);\n    }\n\n    dialogOptions.configure = true;\n    LogUtil.log(\"RollHooksHandler.onPreRollDamageV2 - Found stored request config from flag\", [stored, stored.situational]);\n\n    if (stored.critical) config.critical = stored.critical;\n    messageOptions.rollMode = stored.rollMode || messageOptions.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n\n    LogUtil.log(\"RollHooksHandler.onPreRollDamageV2 triggered #1\", [config, dialogOptions, messageOptions]);\n\n    if (stored.situational) {\n      if (!config.rolls || config.rolls.length === 0) {\n        config.rolls = [{\n          parts: [],\n          data: {},\n          options: {}\n        }];\n      }\n\n      if (!config.rolls[0].data) {\n        config.rolls[0].data = {};\n      }\n      config.rolls[0].data.situational = stored.situational;\n      config._flashRollsSituational = stored.situational;\n    }\n    LogUtil.log(\"RollHooksHandler.onPreRollDamageV2 - Applied stored configuration to damage roll\", [config, messageOptions]);\n  }\n\n  /**\n   * Handle pre-roll ability check hook to force configuration dialog for roll requests\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialog - Dialog options\n   * @param {Object} message - Message options\n   */\n  static onPreRollAbilityCheck(config, dialog, message) {\n    if (config._flashRollsProcessed) return;\n    config._flashRollsProcessed = true;\n\n    LogUtil.log(\"RollHooksHandler.onPreRollAbilityCheck\", [config, dialog, message]);\n    if (config.isRollRequest) {\n      dialog.configure = true;\n    }\n  }\n\n  // ========================================\n  // COMMON METHODS (BOTH GM AND PLAYERS)\n  // ========================================\n\n  /**\n   * Handle pre-roll hit die to fix situational bonus concatenation issue\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialogOptions - Dialog display options\n   * @param {Object} messageOptions - Chat message options\n   */\n  static onPreRollHitDieV2(config, dialogOptions, messageOptions) {\n    if (config._flashRollsProcessed) return;\n    config._flashRollsProcessed = true;\n\n    LogUtil.log(\"RollHooksHandler.onPreRollHitDieV2 triggered\", [config, dialogOptions, messageOptions]);\n\n    if (config.rolls && config.rolls.length > 1) {\n      const allSituationalBonuses = [];\n\n      for(let i = 0; i < config.rolls.length; i++){\n        const roll = config.rolls[i];\n        if (roll && roll.data && roll.data.situational) {\n          allSituationalBonuses.push(roll.data.situational);\n        }\n      }\n\n      if (allSituationalBonuses.length > 0) {\n        if (!config.rolls[0].data) {\n          config.rolls[0].data = {};\n        }\n\n        const uniqueBonuses = [...new Set(allSituationalBonuses)];\n\n        config.rolls[0].data.situational = uniqueBonuses.map(bonus => {\n          const trimmedBonus = bonus.toString().trim();\n          if (trimmedBonus.startsWith('-')) {\n            return `(${trimmedBonus})`;\n          } else if (trimmedBonus.startsWith('+')) {\n            return `${trimmedBonus.substring(1)}`;\n          } else {\n            return `${trimmedBonus}`;\n          }\n        }).join(' + ');\n\n        if(game.user.isGM && !config.rolls[0].parts.find(p => p.includes(\"@situational\"))){\n          config.rolls[0].parts.push(\"@situational\");\n        }\n      }\n\n      config.rolls = config.rolls.slice(0, 1);\n      LogUtil.log(\"RollHooksHandler.onPreRollHitDieV2 - Cleaned up hit die rolls\", config.rolls);\n    }\n  }\n\n  /**\n   * Handle post-roll configuration to add requested-by information to message\n   * @param {Array} rolls - The rolls that were made\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialog - Dialog that was shown\n   * @param {Object} message - Message configuration\n   */\n  static onPostRollConfig(rolls, config, dialog, message) {\n    if (config._showRequestedBy && rolls.length > 0) {\n      message.data = message.data || {};\n      message.data._showRequestedBy = true;\n      message.data._requestedBy = config._requestedBy;\n    }\n  }\n\n  /**\n   * Handle rollDamageV2 hook to schedule template removal after damage is rolled\n   * @param {Array} rolls - The damage rolls\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialog - Dialog options\n   * @param {Object} message - Message options\n   */\n  static onRollDamageV2(rolls, config, dialog, message) {\n    const item = config.subject?.item;\n    LogUtil.log(\"RollHooksHandler.onRollDamageV2 - scheduled template removal\", [item?.name, item?.uuid]);\n\n    if (!item) return;\n\n    if (HooksManager.templateRemovalTimers.has(item.uuid)) {\n      LogUtil.log(\"RollHooksHandler.onRollDamageV2 - template removal already scheduled for item\", [item.uuid]);\n      return;\n    }\n\n    HooksManager.templateRemovalTimers.add(item.uuid);\n\n    const SETTINGS = getSettings();\n    const timeoutSeconds = SettingsUtil.get(SETTINGS.templateRemovalTimeout.tag);\n    const timeoutMs = timeoutSeconds * 1000;\n\n    setTimeout(() => {\n      GeneralUtil.removeTemplateForItem(item);\n      HooksManager.templateRemovalTimers.delete(item.uuid);\n    }, timeoutMs);\n  }\n}","import { MODULE_ID } from '../../constants/General.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport { LibWrapperUtil } from '../utils/LibWrapperUtil.mjs';\nimport { HOOKS_CORE, HOOKS_DND5E } from '../../constants/Hooks.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport RollRequestsMenu from '../ui/RollRequestsMenu.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { FlashAPI } from '../core/FlashAPI.mjs';\n\n/**\n * Tracks token placement from group actors and maintains tokenAssociations.\n * This manager handles the association between group/encounter actors and their member tokens\n * when placed on the scene via the \"Place Members\" button.\n */\nexport class GroupTokenTracker {\n  /**\n   * Track of pending group token placements\n   * @type {Map<string, {groupActor: Actor, memberActorIds: string[]}>}\n   */\n  static pendingPlacements = new Map();\n\n  /**\n   * Cache for associations being built during active placement operations\n   * Prevents race conditions when multiple tokens are created simultaneously\n   * @type {Map<string, Object>}\n   */\n  static activeAssociations = new Map();\n\n  /**\n   * Initialize the group token tracker by setting up hooks and wrapping necessary methods.\n   * This should be called once during module initialization.\n   */\n  static initialize() {\n    LogUtil.log('GroupTokenTracker.initialize');\n\n    this.setupPlaceMembersTracking();\n\n    Hooks.on(HOOKS_CORE.CREATE_TOKEN, this.onCreateToken.bind(this));\n    Hooks.on(HOOKS_CORE.DELETE_TOKEN, this.onDeleteToken.bind(this));\n    Hooks.on(HOOKS_CORE.DELETE_ACTOR, this.onDeleteActor.bind(this));\n    Hooks.on(HOOKS_CORE.UPDATE_ACTOR, this.onUpdateActor.bind(this));\n    Hooks.on(HOOKS_CORE.CANVAS_READY, this.onCanvasReady.bind(this));\n    Hooks.on(HOOKS_DND5E.RENDER_GROUP_ACTOR_SHEET, this.onRenderActorSheet.bind(this));\n    Hooks.on(HOOKS_DND5E.RENDER_ENCOUNTER_ACTOR_SHEET, this.onRenderActorSheet.bind(this));\n\n    if (game.user.isGM) {\n      setTimeout(() => this.migrateLegacyAssociationsForAllGroups(), 500);\n    }\n  }\n\n  /**\n   * Migrate legacy associations for all group actors\n   */\n  static async migrateLegacyAssociationsForAllGroups() {\n    const SETTINGS = getSettings();\n\n    // Check if migration has already been completed (with fallback if setting doesn't exist yet)\n    let migrationCompleted = false;\n    try {\n      migrationCompleted = game.settings.get(MODULE_ID, SETTINGS.legacyTokenAssociationsMigrated.tag);\n    } catch (error) {\n      LogUtil.log('GroupTokenTracker: Migration setting not yet registered, proceeding with migration check');\n    }\n\n    if (migrationCompleted) {\n      LogUtil.log('GroupTokenTracker: Legacy migration already completed globally');\n      return;\n    }\n\n    const hasLegacyActors = game.actors.some(actor =>\n      (actor.type === 'group' || actor.type === 'encounter') &&\n      actor.getFlag(MODULE_ID, 'tokenAssociations') &&\n      !actor.getFlag(MODULE_ID, 'tokenAssociationsByScene')\n    );\n\n    if (!hasLegacyActors) {\n      LogUtil.log('GroupTokenTracker: No legacy associations to migrate, setting global flag');\n      try {\n        await game.settings.set(MODULE_ID, SETTINGS.legacyTokenAssociationsMigrated.tag, true);\n      } catch (error) {\n        LogUtil.log('GroupTokenTracker: Could not set migration flag, setting may not be registered yet');\n      }\n      return;\n    }\n\n    const groupActors = game.actors.filter(actor =>\n      (actor.type === 'group' || actor.type === 'encounter') &&\n      actor.getFlag(MODULE_ID, 'tokenAssociations') &&\n      !actor.getFlag(MODULE_ID, 'tokenAssociationsByScene')\n    );\n\n    for (const groupActor of groupActors) {\n      await this.migrateLegacyAssociations(groupActor);\n    }\n\n    try {\n      await game.settings.set(MODULE_ID, SETTINGS.legacyTokenAssociationsMigrated.tag, true);\n      LogUtil.log(`GroupTokenTracker: Migrated legacy associations for ${groupActors.length} group actors and set global completion flag`);\n    } catch (error) {\n      LogUtil.log(`GroupTokenTracker: Migrated legacy associations for ${groupActors.length} group actors but could not set completion flag`);\n    }\n  }\n\n  /**\n   * Set up tracking for when the placeMembers action is triggered from group sheets.\n   * This hooks into both the button clicks and token creation to track tokens that are\n   * specifically created from the placeMembers operation, not manual token placement.\n   */\n  static setupPlaceMembersTracking() {\n    Hooks.on(HOOKS_CORE.PRE_CREATE_TOKEN, (tokenDoc, data, options, userId) => {\n      if (userId !== game.user.id || !game.user.isGM) return;\n      LogUtil.log('preCreateToken',[tokenDoc, data, options, userId])\n\n      for (const [groupId, placement] of this.pendingPlacements.entries()) {\n        if (placement.memberActorIds.includes(data.actorId) && placement.isPlacing) {\n          tokenDoc.updateSource({\n            flags: {\n              [MODULE_ID]: {\n                groupId: groupId,\n                fromGroupPlacement: true\n              }\n            }\n          });\n        }\n      }\n    });\n\n    this._wrapPlaceMembersMethod();\n  }\n\n  /**\n   * Wrap the placeMembers method on group/encounter actors to track token placement\n   */\n  static _wrapPlaceMembersMethod() {\n    const registered = LibWrapperUtil.register(\n      'CONFIG.Actor.dataModels.group.prototype.placeMembers',\n      async function(wrapped, ...args) {\n        const groupActor = this.parent;\n        await GroupTokenTracker._trackPlaceMembers(groupActor);\n        return wrapped(...args);\n      },\n      'WRAPPER'\n    );\n\n    if (!registered) {\n      LogUtil.log('GroupTokenTracker: libWrapper not available, using fallback wrapping for group.placeMembers');\n      const originalPlaceMembers = CONFIG.Actor.dataModels.group.prototype.placeMembers;\n      CONFIG.Actor.dataModels.group.prototype.placeMembers = async function(...args) {\n        const groupActor = this.parent;\n        await GroupTokenTracker._trackPlaceMembers(groupActor);\n        return originalPlaceMembers.call(this, ...args);\n      };\n    }\n\n    if (CONFIG.Actor.dataModels.encounter) {\n      const registeredEncounter = LibWrapperUtil.register(\n        'CONFIG.Actor.dataModels.encounter.prototype.placeMembers',\n        async function(wrapped, ...args) {\n          const groupActor = this.parent;\n          await GroupTokenTracker._trackPlaceMembers(groupActor);\n          return wrapped(...args);\n        },\n        'WRAPPER'\n      );\n\n      if (!registeredEncounter) {\n        LogUtil.log('GroupTokenTracker: libWrapper not available, using fallback wrapping for encounter.placeMembers');\n        const originalEncounterPlaceMembers = CONFIG.Actor.dataModels.encounter.prototype.placeMembers;\n        CONFIG.Actor.dataModels.encounter.prototype.placeMembers = async function(...args) {\n          const groupActor = this.parent;\n          await GroupTokenTracker._trackPlaceMembers(groupActor);\n          return originalEncounterPlaceMembers.call(this, ...args);\n        };\n      }\n    }\n  }\n\n\n  /**\n   * Track a placeMembers operation for a group actor.\n   * Stores information about which actors will be placed so we can associate the tokens when created.\n   * Sets isPlacing flag to true initially, which gets set to false once TokenPlacement starts.\n   * Only tokens created while isPlacing=true will be associated with the group.\n   * Clears any existing associations for the current scene before tracking new placement.\n   *\n   * @param {Actor} groupActor - The group actor placing members\n   */\n  static async _trackPlaceMembers(groupActor) {\n    LogUtil.log('GroupTokenTracker: placeMembers clicked for', groupActor.name);\n\n    const currentScene = game.scenes.current;\n    if (currentScene) {\n      await this.removeGroupAssociations(groupActor, currentScene);\n    }\n\n    const members = await groupActor.system.getPlaceableMembers();\n    const memberActorIds = members.map(m => m.actor.id);\n    const expectedTokenCount = members.reduce((sum, m) => {\n      const quantity = m.quantity?.value || 1;\n      return sum + quantity;\n    }, 0);\n\n    this.pendingPlacements.set(groupActor.id, {\n      groupActor: groupActor,\n      memberActorIds: memberActorIds,\n      expectedTokenCount: expectedTokenCount,\n      placedTokenCount: 0,\n      timestamp: Date.now(),\n      isPlacing: true  // Flag to track active placement phase\n    });\n\n    const currentFlag = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n    this.activeAssociations.set(groupActor.id, JSON.parse(JSON.stringify(currentFlag)));\n\n    setTimeout(() => {\n      const placement = this.pendingPlacements.get(groupActor.id);\n      if (placement) {\n        placement.isPlacing = true;\n        LogUtil.log(`GroupTokenTracker: Token placement phase active for group ${groupActor.name}`);\n      }\n    }, 100);\n    \n    setTimeout(() => {\n      const placement = this.pendingPlacements.get(groupActor.id);\n      if (placement && placement.timestamp === this.pendingPlacements.get(groupActor.id)?.timestamp) {\n        LogUtil.log(`GroupTokenTracker: Timeout reached for group ${groupActor.name}, cleaning up`);\n        this.pendingPlacements.delete(groupActor.id);\n        this.activeAssociations.delete(groupActor.id); // Clean up the cache\n      }\n    }, 120000); // 2 minutes\n  }\n\n  /**\n   * Handle token creation to associate with groups.\n   * Only processes tokens that have the fromGroupPlacement flag, which indicates they were\n   * created from the placeMembers operation, not from manual drag-and-drop.\n   * Tracks placed token count and removes pending placement when all expected tokens are placed.\n   *\n   * @param {TokenDocument} tokenDoc - The created token document\n   * @param {object} options - Creation options\n   * @param {string} userId - User who created the token\n   */\n  static async onCreateToken(tokenDoc, options, userId) {\n\n    if (userId !== game.user.id) return;\n    await this.cleanupCopiedTokenFlags(tokenDoc);\n    if (!game.user.isGM) return;\n\n    const fromGroupPlacement = tokenDoc.getFlag(MODULE_ID, 'fromGroupPlacement');\n    const groupId = tokenDoc.getFlag(MODULE_ID, 'groupId');\n\n\n    if (!fromGroupPlacement || !groupId) {\n      await this.cleanupDanglingAssociations();\n      return;\n    }\n\n    const placement = this.pendingPlacements.get(groupId);\n    if (!placement) return;\n\n    const actorId = tokenDoc.actorId;\n    const sceneId = tokenDoc.parent.id;\n    const tokenUuid = tokenDoc.uuid;\n    const currentAssociations = this.activeAssociations.get(groupId) || {};\n\n    if (!currentAssociations[sceneId]) {\n      currentAssociations[sceneId] = {};\n    }\n\n    if (!currentAssociations[sceneId][actorId]) {\n      currentAssociations[sceneId][actorId] = [];\n    }\n\n    const existingUuids = [...currentAssociations[sceneId][actorId]]; // Create a copy to avoid race conditions\n\n    if (!existingUuids.includes(tokenUuid)) {\n      existingUuids.push(tokenUuid);\n      currentAssociations[sceneId][actorId] = existingUuids;\n\n      this.activeAssociations.set(groupId, currentAssociations);\n      await placement.groupActor.setFlag(MODULE_ID, 'tokenAssociationsByScene', currentAssociations);\n      await tokenDoc.unsetFlag(MODULE_ID, 'fromGroupPlacement');\n\n      placement.placedTokenCount++;\n\n      if (placement.placedTokenCount >= placement.expectedTokenCount) {\n        placement.isPlacing = false;  // Stop marking new tokens as from this placement\n        LogUtil.log(`GroupTokenTracker: All tokens placed for group ${placement.groupActor.name}, cleaning up`);\n        this.pendingPlacements.delete(groupId);\n        this.activeAssociations.delete(groupId); // Clean up the cache\n\n        setTimeout(() => {\n          this._reRenderGroupSheets(groupId);\n        }, 100);\n      } else {\n        this._reRenderGroupSheets(groupId);\n      }\n    }\n\n    await this.cleanupDanglingAssociations();\n  }\n\n  /**\n   * Handle actor deletion to clean up token flags.\n   * When a group/encounter actor is deleted, remove the groupId flag from all associated tokens.\n   *\n   * @param {Actor} actor - The deleted actor\n   * @param {object} options - Deletion options\n   * @param {string} userId - User who deleted the actor\n   */\n  static async onDeleteActor(actor, options, userId) {\n    if (actor.type !== 'group' && actor.type !== 'encounter') return;\n    if (!game.user.isGM) return;\n\n    LogUtil.log(`GroupTokenTracker: Group/encounter ${actor.name} deleted, cleaning up token flags`);\n\n    const associations = actor.getFlag(MODULE_ID, 'tokenAssociationsByScene');\n    if (!associations) {\n      LogUtil.log(`GroupTokenTracker: No associations found for deleted group ${actor.name}`);\n      return;\n    }\n\n    LogUtil.log(`GroupTokenTracker: Found associations for ${Object.keys(associations).length} scene(s)`);\n\n    // Clear groupId flags from all associated tokens across all scenes\n    let successCount = 0;\n    let failCount = 0;\n\n    for (const [sceneId, sceneAssociations] of Object.entries(associations)) {\n      const scene = game.scenes.get(sceneId);\n      LogUtil.log('GroupTokenTracker: Processing scene', [scene?.name || sceneId, sceneAssociations]);\n\n      for (const [actorId, tokenUuids] of Object.entries(sceneAssociations)) {\n        LogUtil.log('GroupTokenTracker: Processing tokens for actor', [actorId, tokenUuids]);\n\n        for (const uuid of tokenUuids) {\n          try {\n            const token = await fromUuid(uuid);\n            if (token) {\n              await token.unsetFlag(MODULE_ID, 'groupId');\n              LogUtil.log(`GroupTokenTracker: Removed groupId flag from token ${token.name} in scene ${scene?.name || sceneId}`);\n              successCount++;\n            } else {\n              LogUtil.log(`GroupTokenTracker: Token ${uuid} no longer exists`);\n              failCount++;\n            }\n          } catch (error) {\n            LogUtil.log(`GroupTokenTracker: Failed to remove flag from token ${uuid}`, error);\n            failCount++;\n          }\n        }\n      }\n    }\n\n    LogUtil.log(`GroupTokenTracker: Cleaned up token flags for deleted group ${actor.name} - ${successCount} succeeded, ${failCount} failed`);\n  }\n\n  /**\n   * Handle actor updates to clean up associations when members are removed from groups\n   */\n  static async onUpdateActor(actor, changes, options, userId) {\n    if (actor.type !== 'group' && actor.type !== 'encounter') return;\n    if (!game.user.isGM) return;\n    if (!changes.system?.members) return;\n\n    LogUtil.log(`GroupTokenTracker: Group/encounter ${actor.name} updated, checking for removed members`);\n\n    const associations = actor.getFlag(MODULE_ID, 'tokenAssociationsByScene');\n    if (!associations) return;\n\n    const currentMemberIds = new Set();\n    if (actor.type === 'group') {\n      for (const member of actor.system.members || []) {\n        if (member.actor?.id) currentMemberIds.add(member.actor.id);\n      }\n    } else {\n      for (const member of actor.system.members || []) {\n        try {\n          const memberActor = await fromUuid(member.uuid);\n          if (memberActor?.id) currentMemberIds.add(memberActor.id);\n        } catch (error) {\n          LogUtil.log(`GroupTokenTracker: Failed to resolve member UUID ${member.uuid}`, error);\n        }\n      }\n    }\n\n    let hasChanges = false;\n    const updatedAssociations = { ...associations };\n\n    for (const [sceneId, sceneAssociations] of Object.entries(updatedAssociations)) {\n      for (const actorId of Object.keys(sceneAssociations)) {\n        if (!currentMemberIds.has(actorId)) {\n          LogUtil.log(`GroupTokenTracker: Member ${actorId} removed from group ${actor.name}, cleaning up associations`);\n\n          const tokenUuids = sceneAssociations[actorId];\n          for (const uuid of tokenUuids) {\n            try {\n              const token = await fromUuid(uuid);\n              if (token) {\n                await token.unsetFlag(MODULE_ID, 'groupId');\n                LogUtil.log(`GroupTokenTracker: Removed groupId flag from token ${token.name}`);\n              }\n            } catch (error) {\n              LogUtil.log(`GroupTokenTracker: Failed to remove flag from token ${uuid}`, error);\n            }\n          }\n\n          delete sceneAssociations[actorId];\n          hasChanges = true;\n        }\n      }\n\n      if (Object.keys(sceneAssociations).length === 0) {\n        delete updatedAssociations[sceneId];\n      }\n    }\n\n    if (hasChanges) {\n      if (Object.keys(updatedAssociations).length === 0) {\n        await actor.unsetFlag(MODULE_ID, 'tokenAssociationsByScene');\n      } else {\n        await actor.setFlag(MODULE_ID, 'tokenAssociationsByScene', updatedAssociations);\n      }\n      LogUtil.log(`GroupTokenTracker: Cleaned up associations for removed members from group ${actor.name}`);\n\n      this._reRenderGroupSheets(actor.id);\n    }\n  }\n\n  /**\n   * Handle token deletion to remove it from group associations.\n   * When a token is deleted, check if it has a groupId flag indicating it belongs to a group.\n   * If so, remove it from the group's tokenAssociationsByScene to keep the associations clean.\n   *\n   * @param {TokenDocument} tokenDoc - The deleted token document\n   * @param {object} options - Deletion options\n   * @param {string} userId - User who deleted the token\n   */\n  static async onDeleteToken(tokenDoc, options, userId) {\n    const groupId = tokenDoc.getFlag(MODULE_ID, 'groupId');\n    if (!groupId) return;\n\n    const groupActor = game.actors.get(groupId);\n    if (!groupActor) return;\n\n    const actorId = tokenDoc.actorId;\n    const sceneId = tokenDoc.parent.id;\n    const tokenUuid = tokenDoc.uuid;\n\n    LogUtil.log(`GroupTokenTracker: onDeleteToken - Token ${tokenDoc.name} deleted from scene ${sceneId}, group ${groupActor.name}`);\n\n    const associations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene');\n    if (!associations || !associations[sceneId] || !associations[sceneId][actorId]) {\n      LogUtil.log(`GroupTokenTracker: No associations found for this token`);\n      return;\n    }\n\n    const tokenIndex = associations[sceneId][actorId].indexOf(tokenUuid);\n    if (tokenIndex === -1) {\n      LogUtil.log(`GroupTokenTracker: Token UUID not found in associations`);\n      return;\n    }\n\n    LogUtil.log(`GroupTokenTracker: Removing deleted token ${tokenUuid} from group ${groupId}`);\n\n    associations[sceneId][actorId].splice(tokenIndex, 1);\n\n    if (associations[sceneId][actorId].length === 0) {\n      delete associations[sceneId][actorId];\n    }\n\n    if (Object.keys(associations[sceneId]).length === 0) {\n      delete associations[sceneId];\n    }\n\n    if (Object.keys(associations).length === 0) {\n      await groupActor.unsetFlag(MODULE_ID, 'tokenAssociationsByScene');\n    } else {\n      await groupActor.setFlag(MODULE_ID, 'tokenAssociationsByScene', associations);\n    }\n\n    await this.cleanupDanglingAssociations();\n\n    this._reRenderGroupSheets(groupId);\n  }\n\n  /**\n   * Re-render open group/encounter actor sheets to reflect updated token associations\n   */\n  static _reRenderGroupSheets(groupActorId = null) {\n    if (foundry.applications.instances) {\n      for (const app of foundry.applications.instances.values()) {\n        if (app.document?.type === 'group' || app.document?.type === 'encounter') {\n          if (!groupActorId || app.document.id === groupActorId) {\n            LogUtil.log(`GroupTokenTracker: Re-rendering ApplicationV2 sheet for ${app.document.name}`);\n            app.render({ force: true });\n          }\n        }\n      }\n    }\n\n    if (ui.windows) {\n      for (const app of Object.values(ui.windows)) {\n        if (app.document?.type === 'group' || app.document?.type === 'encounter') {\n          if (!groupActorId || app.document.id === groupActorId) {\n            LogUtil.log(`GroupTokenTracker: Re-rendering legacy sheet for ${app.document.name}`);\n            app.render(false);\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * Clean up old pending placements that are older than the timeout period.\n   * This prevents memory leaks from placement operations that were started but never completed.\n   * Called automatically after successful placement operations.\n   */\n  static cleanupOldPendingPlacements() {\n    const now = Date.now();\n    const timeout = 5000;\n\n    for (const [groupId, placement] of this.pendingPlacements.entries()) {\n      if (now - placement.timestamp > timeout) {\n        LogUtil.log(`GroupTokenTracker: Cleaning up old pending placement for group ${groupId}`);\n        this.pendingPlacements.delete(groupId);\n      }\n    }\n  }\n\n  /**\n   * Clear associations for tokens that no longer exist in their respective scenes.\n   * This maintenance function ensures the tokenAssociationsByScene flag doesn't contain\n   * references to tokens that have been deleted or moved to other scenes.\n   * Should be called periodically or when switching scenes.\n   *\n   * @param {Actor} groupActor - The group actor to clean\n   */\n  static async cleanupInvalidTokens(groupActor) {\n    if (groupActor.type !== 'group' && groupActor.type !== 'encounter') return;\n\n    const associations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene');\n    if (!associations) return;\n\n    let hasChanges = false;\n    const cleanedAssociations = {};\n\n    for (const [sceneId, sceneAssociations] of Object.entries(associations)) {\n      const scene = game.scenes.get(sceneId);\n      if (!scene) {\n        LogUtil.log(`GroupTokenTracker: Scene ${sceneId} no longer exists, removing associations`);\n        hasChanges = true;\n        continue;\n      }\n\n      const cleanedSceneAssociations = {};\n\n      for (const [actorId, tokenUuids] of Object.entries(sceneAssociations)) {\n        const validTokenUuids = tokenUuids.filter(tokenUuid => {\n          try {\n            const token = fromUuidSync(tokenUuid);\n            return token && token.actorId === actorId && token.parent.id === sceneId;\n          } catch (error) {\n            LogUtil.log(`GroupTokenTracker: Invalid token UUID ${tokenUuid}, removing`);\n            return false;\n          }\n        });\n\n        if (validTokenUuids.length > 0) {\n          cleanedSceneAssociations[actorId] = validTokenUuids;\n        }\n\n        if (validTokenUuids.length !== tokenUuids.length) {\n          hasChanges = true;\n        }\n      }\n\n      if (Object.keys(cleanedSceneAssociations).length > 0) {\n        cleanedAssociations[sceneId] = cleanedSceneAssociations;\n      }\n    }\n\n    if (hasChanges) {\n      if (Object.keys(cleanedAssociations).length === 0) {\n        await groupActor.unsetFlag(MODULE_ID, 'tokenAssociationsByScene');\n      } else {\n        await groupActor.setFlag(MODULE_ID, 'tokenAssociationsByScene', cleanedAssociations);\n      }\n      LogUtil.log(`GroupTokenTracker: Cleaned invalid tokens for group ${groupActor.name}`);\n    }\n  }\n\n  /**\n   * Clean up dangling token associations across all group actors.\n   * This method checks all group/encounter actors and removes associations to tokens that no longer exist.\n   * Called automatically when tokens are created or deleted to maintain data integrity.\n   */\n  static async cleanupDanglingAssociations() {\n    const groupActors = game.actors.filter(actor =>\n      (actor.type === 'group' || actor.type === 'encounter') &&\n      actor.getFlag(MODULE_ID, 'tokenAssociationsByScene')\n    );\n\n    for (const groupActor of groupActors) {\n      await this.cleanupInvalidTokens(groupActor);\n    }\n\n    LogUtil.log(`GroupTokenTracker: Cleaned dangling associations for ${groupActors.length} group actors`);\n  }\n\n  /**\n   * Check if a token is associated with a group.\n   * Utility method to determine if a given token belongs to a group actor.\n   *\n   * @param {TokenDocument} tokenDoc - The token to check\n   * @returns {Actor|null} The group actor if the token is associated, null otherwise\n   */\n  static getGroupForToken(tokenDoc) {\n    const groupId = tokenDoc.getFlag(MODULE_ID, 'groupId');\n    if (!groupId) return null;\n\n    return game.actors.get(groupId) || null;\n  }\n\n  /**\n   * Get all tokens associated with a group actor in the specified scene.\n   * Returns a map of actor IDs to their associated token documents.\n   *\n   * @param {Actor} groupActor - The group actor\n   * @param {Scene} [scene] - The scene to get tokens from (defaults to active scene)\n   * @returns {Map<string, TokenDocument[]>} Map of actor IDs to token documents\n   */\n  static getGroupTokens(groupActor, scene = null) {\n    const targetScene = scene || game.scenes.active;\n    const result = new Map();\n\n    if (!targetScene) return result;\n\n    const associations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n    const sceneAssociations = associations[targetScene.id];\n\n    if (!sceneAssociations) return result;\n\n    for (const [actorId, tokenUuids] of Object.entries(sceneAssociations)) {\n      const tokens = tokenUuids\n        .map(uuid => {\n          try {\n            return fromUuidSync(uuid);\n          } catch (error) {\n            LogUtil.log(`GroupTokenTracker: Invalid token UUID ${uuid}`);\n            return null;\n          }\n        })\n        .filter(token => token && token.actorId === actorId && token.parent.id === targetScene.id);\n\n      if (tokens.length > 0) {\n        result.set(actorId, tokens);\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Get all tokens associated with a group actor across all scenes.\n   * Returns a map of scene IDs to maps of actor IDs to token documents.\n   *\n   * @param {Actor} groupActor - The group actor\n   * @returns {Map<string, Map<string, TokenDocument[]>>} Map of scene IDs to actor token maps\n   */\n  static getAllGroupTokens(groupActor) {\n    const associations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n    const result = new Map();\n\n    for (const [sceneId, sceneAssociations] of Object.entries(associations)) {\n      const scene = game.scenes.get(sceneId);\n      if (!scene) continue;\n\n      const sceneTokens = new Map();\n\n      for (const [actorId, tokenUuids] of Object.entries(sceneAssociations)) {\n        const tokens = tokenUuids\n          .map(uuid => {\n            try {\n              return fromUuidSync(uuid);\n            } catch (error) {\n              return null;\n            }\n          })\n          .filter(token => token && token.actorId === actorId);\n\n        if (tokens.length > 0) {\n          sceneTokens.set(actorId, tokens);\n        }\n      }\n\n      if (sceneTokens.size > 0) {\n        result.set(sceneId, sceneTokens);\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Validate and clean up Flash Token Bar 5e module flags from tokens that shouldn't have them.\n   * This handles cases where tokens have inherited flags but aren't properly associated,\n   * including copy-pasted tokens and orphaned associations.\n   *\n   * @param {TokenDocument} tokenDoc - The newly created token document\n   */\n  static async cleanupCopiedTokenFlags(tokenDoc) {\n    const moduleFlags = tokenDoc.getFlag(MODULE_ID);\n    if (!moduleFlags) return;\n\n    const groupId = moduleFlags.groupId;\n    const fromGroupPlacement = moduleFlags.fromGroupPlacement;\n\n    // Skip validation if this is a legitimate group placement in progress\n    if (fromGroupPlacement) return;\n\n    let shouldCleanup = false;\n    const reasons = [];\n\n    // Check if token has groupId but isn't in any group's associations\n    if (groupId) {\n      const groupActor = game.actors.get(groupId);\n      const sceneId = tokenDoc.parent.id;\n      const tokenUuid = tokenDoc.uuid;\n\n      if (!groupActor) {\n        shouldCleanup = true;\n        reasons.push('group actor no longer exists');\n      } else {\n        const associations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene');\n        const isAssociated = associations?.[sceneId]?.[tokenDoc.actorId]?.includes(tokenUuid);\n\n        if (!isAssociated) {\n          shouldCleanup = true;\n          reasons.push('not in group associations');\n        }\n      }\n    }\n\n    // Check for movement restrictions that might be inherited\n    if (moduleFlags.movementRestriction && !groupId) {\n      // Token has movement restriction but no group association\n      // This suggests it inherited the flag from a copy operation\n      shouldCleanup = true;\n      reasons.push('orphaned movement restriction');\n    }\n\n    if (shouldCleanup) {\n      LogUtil.log(`GroupTokenTracker: Cleaning up invalid module flags from token ${tokenDoc.name} (${tokenDoc.id})`);\n      LogUtil.log(`GroupTokenTracker: Cleanup reasons:`, reasons);\n      LogUtil.log(`GroupTokenTracker: Removing flags:`, Object.keys(moduleFlags));\n\n      await tokenDoc.unsetFlag(MODULE_ID);\n    }\n  }\n\n  /**\n   * Add legacy support for migration from old tokenAssociations format\n   * This method migrates old tokenAssociations data to the new tokenAssociationsByScene format\n   * Searches all scenes to preserve tokens that may exist in inactive scenes\n   *\n   * @param {Actor} groupActor - The group actor to migrate\n   */\n  static async migrateLegacyAssociations(groupActor) {\n    const legacyAssociations = groupActor.getFlag(MODULE_ID, 'tokenAssociations');\n    const newAssociations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene');\n\n    if (!legacyAssociations || newAssociations) return;\n\n    LogUtil.log(`GroupTokenTracker: Migrating legacy associations for group ${groupActor.name}`);\n\n    const migratedAssociations = {};\n    let totalMigrated = 0;\n\n    // Search all scenes for tokens matching the legacy token IDs\n    for (const scene of game.scenes) {\n      const sceneAssociations = {};\n\n      for (const [actorId, tokenIds] of Object.entries(legacyAssociations)) {\n        const validUuids = tokenIds\n          .map(tokenId => {\n            const token = scene.tokens.get(tokenId);\n            return token && token.actorId === actorId ? token.uuid : null;\n          })\n          .filter(uuid => uuid !== null);\n\n        if (validUuids.length > 0) {\n          sceneAssociations[actorId] = validUuids;\n          totalMigrated += validUuids.length;\n        }\n      }\n\n      if (Object.keys(sceneAssociations).length > 0) {\n        migratedAssociations[scene.id] = sceneAssociations;\n      }\n    }\n\n    // Only save if we found tokens to migrate\n    if (Object.keys(migratedAssociations).length > 0) {\n      await groupActor.setFlag(MODULE_ID, 'tokenAssociationsByScene', migratedAssociations);\n      LogUtil.log(`GroupTokenTracker: Migrated ${totalMigrated} tokens across ${Object.keys(migratedAssociations).length} scenes for group ${groupActor.name}`);\n    } else {\n      LogUtil.log(`GroupTokenTracker: No valid tokens found to migrate for group ${groupActor.name}`);\n    }\n\n    // Always remove legacy flag after migration attempt\n    await groupActor.unsetFlag(MODULE_ID, 'tokenAssociations');\n  }\n\n  /**\n   * Check if associations need syncing and sync if there's a mismatch\n   */\n  static async checkAndSyncAssociations(groupActor, scene) {\n    const members = groupActor.type === 'group'\n      ? (groupActor.system.members || []).map(m => ({ actor: m.actor, quantity: 1 }))\n      : await Promise.all((groupActor.system.members || []).map(async m => {\n          const actor = await fromUuid(m.uuid);\n          const quantity = typeof m.quantity === 'object' ? (m.quantity?.value || 1) : (m.quantity || 1);\n          return { actor, quantity };\n        }));\n\n    const associations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n    const sceneAssociations = associations[scene.id] || {};\n\n    let needsSync = false;\n\n    for (const { actor: memberActor, quantity } of members) {\n      if (!memberActor) continue;\n\n      const memberActorId = memberActor.id;\n      const existingAssociations = sceneAssociations[memberActorId] || [];\n\n      const validExisting = existingAssociations.filter(uuid => {\n        try {\n          const token = fromUuidSync(uuid);\n          return token && token.parent.id === scene.id;\n        } catch {\n          return false;\n        }\n      });\n\n      const tokensInScene = scene.tokens.filter(t => {\n        if (t.actorId === memberActorId) return true;\n        if (t.actorLink) return false;\n        return t.actor?.prototypeToken?.actorId === memberActorId;\n      });\n      const neededCount = quantity;\n      const currentCount = validExisting.length;\n      const availableCount = tokensInScene.length;\n\n      if (currentCount !== neededCount && availableCount >= neededCount) {\n        needsSync = true;\n        break;\n      }\n\n      if (validExisting.length !== existingAssociations.length) {\n        needsSync = true;\n        break;\n      }\n    }\n\n    if (needsSync) {\n      await this.autoSyncTokens(groupActor, scene);\n    }\n\n    LogUtil.log(\"checkAndSyncAssociations\", [associations]);\n  }\n\n  /**\n   * Handle actor sheet rendering to inject token association UI\n   */\n  static async onRenderActorSheet(app, element, options) {\n    LogUtil.log(\"onRenderActorSheet\",[app, element, options]);\n\n    if (!app.document || !game.user.isGM || (app.document.type !== 'group' && app.document.type !== 'encounter')) {\n      return;\n    }\n\n    const mainContent = this._getMainContentElement(element);\n    if (!mainContent) return;\n\n    const currentScene = game.scenes.current;\n    if (!currentScene) return;\n\n    await this._cleanupInvalidAssociations(app.document);\n\n    const totalTokens = this._countValidTokens(app.document, currentScene);\n    const container = this._createTokenAssociationUI(app.document, currentScene, totalTokens);\n\n    this._removeExistingContainers(mainContent);\n    mainContent.appendChild(container);\n  }\n\n  /**\n   * Get the main content element from the sheet, handling different sheet types\n   */\n  static _getMainContentElement(element) {\n    let mainContent = element.querySelector('[data-container-id=\"main\"]');\n    if (!mainContent) {\n      mainContent = element;\n    }\n    return mainContent;\n  }\n\n  /**\n   * Remove any existing token association containers\n   */\n  static _removeExistingContainers(mainContent) {\n    const existingContainers = mainContent.querySelectorAll('.flash5e-token-associations');\n    existingContainers.forEach(c => c.remove());\n  }\n\n  /**\n   * Clean up associations for deleted scenes, invalid tokens, and removed members.\n   * This method validates associations on every sheet render, ensuring:\n   * - Only scenes that still exist are tracked\n   * - Only actors that are still members of the group have associations\n   * - Only valid tokens that exist in their scenes are tracked\n   * Acts as a safety net to catch stale associations that survive reload/sheet changes.\n   */\n  static async _cleanupInvalidAssociations(groupActor) {\n    const associations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n    let hasChanges = false;\n    LogUtil.log(\"onRenderActorSheet - tokenAssociationsByScene\",[associations]);\n\n    const currentMemberIds = new Set();\n    if (groupActor.type === 'group') {\n      for (const member of groupActor.system.members || []) {\n        if (member.actor?.id) currentMemberIds.add(member.actor.id);\n      }\n    } else {\n      for (const member of groupActor.system.members || []) {\n        try {\n          const memberActor = await fromUuid(member.uuid);\n          if (memberActor?.id) currentMemberIds.add(memberActor.id);\n        } catch (error) {\n          LogUtil.log(`GroupTokenTracker: Failed to resolve member UUID ${member.uuid}`, error);\n        }\n      }\n    }\n\n    for (const sceneId of Object.keys(associations)) {\n      const scene = game.scenes.get(sceneId);\n\n      if (!scene) {\n        delete associations[sceneId];\n        hasChanges = true;\n        continue;\n      }\n\n      const sceneAssociations = associations[sceneId];\n      for (const [actorId, tokenUuids] of Object.entries(sceneAssociations)) {\n        if (!currentMemberIds.has(actorId)) {\n          LogUtil.log(`GroupTokenTracker: Actor ${actorId} is not a member of group ${groupActor.name}, removing stale associations`);\n\n          for (const uuid of tokenUuids) {\n            try {\n              const token = await fromUuid(uuid);\n              if (token) {\n                await token.unsetFlag(MODULE_ID, 'groupId');\n                LogUtil.log(`GroupTokenTracker: Removed groupId flag from token ${token.name}`);\n              }\n            } catch (error) {\n              LogUtil.log(`GroupTokenTracker: Failed to remove flag from token ${uuid}`, error);\n            }\n          }\n\n          delete sceneAssociations[actorId];\n          hasChanges = true;\n          continue;\n        }\n\n        const validTokens = tokenUuids.filter(uuid => {\n          try {\n            const token = fromUuidSync(uuid);\n            return token && token.parent.id === sceneId;\n          } catch {\n            return false;\n          }\n        });\n\n        if (validTokens.length !== tokenUuids.length) {\n          hasChanges = true;\n        }\n\n        if (validTokens.length > 0) {\n          sceneAssociations[actorId] = validTokens;\n        } else {\n          delete sceneAssociations[actorId];\n        }\n      }\n\n      if (Object.keys(sceneAssociations).length === 0) {\n        delete associations[sceneId];\n        hasChanges = true;\n      }\n    }\n\n    if (hasChanges) {\n      if (Object.keys(associations).length === 0) {\n        await groupActor.unsetFlag(MODULE_ID, 'tokenAssociationsByScene');\n      } else {\n        await groupActor.setFlag(MODULE_ID, 'tokenAssociationsByScene', associations);\n      }\n      RollRequestsMenu.refreshIfOpen();\n    }\n  }\n\n  /**\n   * Count valid tokens for the group in the current scene\n   */\n  static _countValidTokens(groupActor, scene) {\n    const associations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n    const sceneAssociations = associations[scene.id] || {};\n\n    let totalTokens = 0;\n    for (const [actorId, tokenUuids] of Object.entries(sceneAssociations)) {\n      for (const uuid of tokenUuids) {\n        try {\n          const token = fromUuidSync(uuid);\n          if (token && token.parent.id === scene.id) {\n            totalTokens++;\n          }\n        } catch {\n        }\n      }\n    }\n    return totalTokens;\n  }\n\n  /**\n   * Create the token association UI container with text and buttons\n   */\n  static _createTokenAssociationUI(groupActor, scene, totalTokens) {\n    const container = document.createElement('div');\n    container.classList.add('sheet-body', 'flash5e-token-associations');\n\n    if (totalTokens === 0) {\n      container.classList.add('no-tokens');\n    }\n\n    const textDiv = document.createElement('div');\n    textDiv.textContent = totalTokens > 0\n      ? game.i18n.format('FLASH_ROLLS.ui.tokenAssociations.associatedTokens', { count: totalTokens })\n      : game.i18n.localize('FLASH_ROLLS.ui.tokenAssociations.noTokensInScene');\n\n    container.appendChild(textDiv);\n\n    if (totalTokens > 0) {\n      const buttonGroup = document.createElement('div');\n      buttonGroup.className = 'button-group';\n\n      const selectButton = document.createElement('button');\n      selectButton.type = 'button';\n      selectButton.className = 'flash5e-select-tokens';\n      selectButton.textContent = game.i18n.localize('FLASH_ROLLS.ui.inputs.selectTokens');\n      selectButton.addEventListener('click', async () => {\n        await this.selectGroupTokens(groupActor, scene);\n      });\n\n      buttonGroup.appendChild(selectButton);\n      container.appendChild(buttonGroup);\n    }\n\n    return container;\n  }\n\n  /**\n   * Remove all token associations for a group in the current scene\n   */\n  static async removeGroupAssociations(groupActor, scene) {\n    const associations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n    const sceneAssociations = associations[scene.id] || {};\n\n    if (Object.keys(sceneAssociations).length === 0) {\n      return;\n    }\n\n    const tokenUuids = [];\n    for (const uuids of Object.values(sceneAssociations)) {\n      tokenUuids.push(...uuids);\n    }\n\n    for (const uuid of tokenUuids) {\n      try {\n        const token = fromUuidSync(uuid);\n        if (token && token.parent.id === scene.id) {\n          await token.unsetFlag(MODULE_ID, 'groupId');\n        }\n      } catch (error) {\n        LogUtil.log(`GroupTokenTracker: Failed to remove groupId flag from token ${uuid}`, error);\n      }\n    }\n\n    delete associations[scene.id];\n\n    if (Object.keys(associations).length === 0) {\n      await groupActor.unsetFlag(MODULE_ID, 'tokenAssociationsByScene');\n    } else {\n      await groupActor.setFlag(MODULE_ID, 'tokenAssociationsByScene', associations);\n    }\n  }\n\n  /**\n   * Select all tokens associated with a group in the current scene\n   */\n  static async selectGroupTokens(groupActor, scene) {\n    const associations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n    const sceneAssociations = associations[scene.id] || {};\n\n    const tokens = [];\n    for (const tokenUuids of Object.values(sceneAssociations)) {\n      for (const uuid of tokenUuids) {\n        try {\n          const token = fromUuidSync(uuid);\n          if (token && token.parent.id === scene.id) {\n            const canvasToken = canvas.tokens.get(token.id);\n            if (canvasToken) {\n              tokens.push(canvasToken);\n            }\n          }\n        } catch (error) {\n          LogUtil.log(`GroupTokenTracker: Failed to resolve token ${uuid}`, error);\n        }\n      }\n    }\n\n    if (tokens.length === 0) {\n      FlashAPI.notify('warn',`No tokens found for ${groupActor.name} in ${scene.name}`);\n      return;\n    }\n\n    canvas.tokens.releaseAll();\n    for (const token of tokens) {\n      token.control({ releaseOthers: false });\n    }\n\n    if (tokens.length > 0) {\n      canvas.animatePan({ x: tokens[0].center.x, y: tokens[0].center.y, duration: 250 });\n    }\n  }\n\n  /**\n   * Auto-sync token associations when canvas is ready.\n   * Matches tokens in the scene with group/encounter members and creates associations\n   * for tokens that aren't already associated.\n   * Also re-renders any open group/encounter sheets to update the UI.\n   */\n  static async onCanvasReady(canvas) {\n    if (!game.user.isGM) return;\n\n    const currentScene = game.scenes.current;\n    if (!currentScene) return;\n\n    const groupActors = game.actors.filter(actor =>\n      actor.type === 'group' || actor.type === 'encounter'\n    );\n\n    await Promise.all(groupActors.map(groupActor => this.autoSyncTokens(groupActor, currentScene)));\n\n    RollRequestsMenu.refreshIfOpen();\n\n    setTimeout(() => {\n      this._reRenderGroupSheets();\n    }, 500);\n  }\n\n  /**\n   * Auto-sync tokens for a specific group/encounter actor in a scene.\n   * Matches available tokens with group members and creates associations.\n   *\n   * @param {Actor} groupActor - The group/encounter actor\n   * @param {Scene} scene - The scene to sync tokens in\n   */\n  static async autoSyncTokens(groupActor, scene) {\n    const associations = groupActor.getFlag(MODULE_ID, 'tokenAssociationsByScene') || {};\n    const sceneAssociations = associations[scene.id] || {};\n\n    const members = groupActor.type === 'group'\n      ? (groupActor.system.members || []).map(m => ({ actor: m.actor, quantity: 1 }))\n      : await Promise.all((groupActor.system.members || []).map(async m => {\n          const actor = await fromUuid(m.uuid);\n          const quantity = typeof m.quantity === 'object' ? (m.quantity?.value || 1) : (m.quantity || 1);\n          return { actor, quantity };\n        }));\n\n    let hasChanges = false;\n\n    for (const { actor: memberActor, quantity } of members) {\n      if (!memberActor) {\n        continue;\n      }\n\n      const memberActorId = memberActor.id;\n      const existingAssociations = sceneAssociations[memberActorId] || [];\n\n      const validExisting = existingAssociations.filter(uuid => {\n        try {\n          const token = fromUuidSync(uuid);\n          return token && token.parent.id === scene.id;\n        } catch {\n          return false;\n        }\n      });\n\n      const tokensInScene = scene.tokens.filter(t => {\n        const isLinkedMatch = t.actorId === memberActorId;\n        const isUnlinkedMatch = !t.actorLink && t.actor?.prototypeToken?.actorId === memberActorId;\n        return isLinkedMatch || isUnlinkedMatch;\n      });\n\n      const neededCount = quantity;\n      const currentCount = validExisting.length;\n\n      if (currentCount >= neededCount) {\n        if (validExisting.length !== existingAssociations.length) {\n          sceneAssociations[memberActorId] = validExisting;\n          hasChanges = true;\n        }\n        continue;\n      }\n\n      const unassociatedTokens = [];\n      for (const token of tokensInScene) {\n        const hasGroupFlag = token.getFlag(MODULE_ID, 'groupId');\n        const isAlreadyAssociated = validExisting.includes(token.uuid);\n        if (hasGroupFlag && hasGroupFlag !== groupActor.id) {\n          const oldGroup = game.actors.get(hasGroupFlag);\n          if (!oldGroup) {\n            // Old group doesn't exist, clear the stale flag\n            LogUtil.log(`GroupTokenTracker: Clearing stale groupId flag from token ${token.name}`);\n            await token.unsetFlag(MODULE_ID, 'groupId');\n          } else {\n            // Token belongs to a different existing group, skip it\n            LogUtil.log(`GroupTokenTracker: Token ${token.name} belongs to different group ${oldGroup.name}, skipping`);\n            continue;\n          }\n        }\n\n        if (!isAlreadyAssociated) {\n          unassociatedTokens.push(token);\n        }\n      }\n\n      const tokensToAssociate = unassociatedTokens.slice(0, neededCount - currentCount);\n\n      if (tokensToAssociate.length > 0) {\n        const newAssociations = [...validExisting, ...tokensToAssociate.map(t => t.uuid)];\n        sceneAssociations[memberActorId] = newAssociations;\n        hasChanges = true;\n\n        for (const token of tokensToAssociate) {\n          await token.setFlag(MODULE_ID, 'groupId', groupActor.id);\n        }\n\n      } else {\n      }\n    }\n\n    if (hasChanges) {\n      associations[scene.id] = sceneAssociations;\n      await groupActor.setFlag(MODULE_ID, 'tokenAssociationsByScene', associations);\n      LogUtil.log(`GroupTokenTracker: Auto-sync completed for group ${groupActor.name}`);\n    }\n  }\n}","import { MODULE_ID } from '../../constants/General.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\n\n/**\n * Manager for customizing token animation behavior\n */\nexport class TokenAnimationManager {\n  /**\n   * Initialize token animation customization by wrapping the Token.prototype.animate method\n   */\n  static initialize() {\n    const TokenClass = foundry.canvas.placeables.Token;\n    const originalAnimate = TokenClass.prototype.animate;\n\n    TokenClass.prototype.animate = async function(to, options = {}) {\n      const SETTINGS = getSettings();\n      const customMovementSpeed = SettingsUtil.get(SETTINGS.tokenMovementSpeed.tag);\n\n      if (customMovementSpeed && !options.movementSpeed) {\n        options.movementSpeed = customMovementSpeed;\n      }\n\n      return originalAnimate.call(this, to, options);\n    };\n  }\n}\n","import { getSettings } from '../../constants/Settings.mjs';\nimport { SettingsUtil } from './SettingsUtil.mjs';\nimport { LogUtil } from './LogUtil.mjs';\n\n/**\n * Utility for managing tooltip auto-dismiss behavior and custom delays\n */\nexport class TooltipUtil {\n  static dismissTimers = new Map();\n  static originalActivationMS = null;\n\n  /**\n   * Initialize tooltip customizations (auto-dismiss and custom delays)\n   */\n  static initialize() {\n    this.originalActivationMS = game.tooltip.constructor.TOOLTIP_ACTIVATION_MS;\n    this.#interceptTooltipEvents();\n    this.#wrapTooltipActivation();\n    this.#wrapTooltipDeactivation();\n  }\n\n  /**\n   * Intercept tooltip activation to handle custom delays\n   */\n  static #interceptTooltipEvents() {\n    const tooltip = game.tooltip;\n    const TooltipClass = tooltip.constructor;\n    const storedValue = TooltipClass.TOOLTIP_ACTIVATION_MS;\n\n    tooltip._frCustomDelayElement = null;\n\n    window.addEventListener(\"pointerenter\", (event) => {\n      if (event.target.dataset?.tooltip) {\n        tooltip._frCustomDelayElement = event.target;\n      }\n    }, { capture: true });\n\n    Object.defineProperty(TooltipClass, 'TOOLTIP_ACTIVATION_MS', {\n      get() {\n        const element = tooltip._frCustomDelayElement;\n        if (element?.closest?.('#flash-rolls-menu') && element.dataset.tooltipDelay) {\n          const customDelay = parseInt(element.dataset.tooltipDelay);\n          if (!isNaN(customDelay) && customDelay > 0) {\n            return customDelay;\n          }\n        }\n        return storedValue;\n      },\n      configurable: true\n    });\n  }\n\n  /**\n   * Wrap tooltip activation to add auto-dismiss or disable tooltips\n   */\n  static #wrapTooltipActivation() {\n    const originalActivate = game.tooltip.activate.bind(game.tooltip);\n\n    game.tooltip.activate = function(element, options = {}) {\n      const isFlashRollsMenu = element?.closest('#flash-rolls-menu');\n\n      if (isFlashRollsMenu) {\n        const SETTINGS = getSettings();\n        const autoDismissSeconds = SettingsUtil.get(SETTINGS.tooltipAutoDismiss.tag);\n\n        if (autoDismissSeconds === 0) {\n          return;\n        }\n\n        const result = originalActivate(element, options);\n        TooltipUtil.setupAutoDismiss(element, autoDismissSeconds);\n\n        return result;\n      }\n\n      return originalActivate(element, options);\n    };\n  }\n\n  /**\n   * Setup auto-dismiss for Flash Token Bar menu tooltips\n   * @param {HTMLElement} element - The element with the tooltip\n   * @param {number} autoDismissSeconds - Seconds before dismissing\n   */\n  static setupAutoDismiss(element, autoDismissSeconds) {\n    if (autoDismissSeconds > 0) {\n      TooltipUtil.scheduleAutoDismiss(element, autoDismissSeconds * 1000);\n    }\n  }\n\n  /**\n   * Wrap tooltip deactivation to clear timers\n   */\n  static #wrapTooltipDeactivation() {\n    const originalDeactivate = game.tooltip.deactivate.bind(game.tooltip);\n\n    game.tooltip.deactivate = function() {\n      const result = originalDeactivate();\n      TooltipUtil.clearAutoDismiss(game.tooltip.element);\n      TooltipUtil.lastHoveredElement = null;\n      return result;\n    };\n  }\n\n  /**\n   * Schedule auto-dismiss for a tooltip\n   * @param {HTMLElement} element - The element with the tooltip\n   * @param {number} delay - Delay in milliseconds before dismissing\n   */\n  static scheduleAutoDismiss(element, delay) {\n    this.clearAutoDismiss(element);\n\n    const timer = setTimeout(() => {\n      if (game.tooltip.element === element) {\n        game.tooltip.deactivate();\n      }\n      this.dismissTimers.delete(element);\n    }, delay);\n\n    this.dismissTimers.set(element, timer);\n  }\n\n  /**\n   * Clear auto-dismiss timer for an element\n   * @param {HTMLElement} element - The element to clear timer for\n   */\n  static clearAutoDismiss(element) {\n    const timer = this.dismissTimers.get(element);\n    if (timer) {\n      clearTimeout(timer);\n      this.dismissTimers.delete(element);\n    }\n  }\n}\n","import { getSettings } from '../../constants/Settings.mjs';\nimport { LogUtil } from './LogUtil.mjs';\nimport { SettingsUtil } from './SettingsUtil.mjs';\n\nexport class UpdateNewsUtil {\n  /**\n   * Get the URL for the update news JSON file\n   * @returns {string} The URL to the module-updates.json file\n   */\n  static getUpdateNewsUrl() {\n    const moduleVersion = game.modules.get('flash-rolls-5e')?.version;\n    const baseUrl = moduleVersion\n      ? `https://github.com/crlngn/flash-rolls-5e/releases/download/v${moduleVersion}/module-updates.json`\n      : ``;\n      // `https://github.com/crlngn/flash-rolls-5e/releases/latest/download/module-updates.json`;\n\n    // Use our custom CORS proxy service\n    return `https://proxy.carolingian.io/proxy?url=${encodeURIComponent(baseUrl)}&v=${moduleVersion}`;\n  }\n\n  /**\n   * Initialize the update news system\n   */\n  static init() {\n    if (!game.user?.isGM) return;\n    // this.cleanSetting();\n    this.checkForUpdates();\n  }\n\n  static getIdFromRawJson = async () => {\n    const rawUrl = \"https://raw.githubusercontent.com/crlngn/flash-rolls-5e/refs/heads/main/news/module-updates.json\";\n    const response = await fetch(rawUrl);\n    const json = response.ok ? await response.json() : null;\n\n    return json ? json.id || '' : '';\n  }\n\n  // call to clean up this setting from local storage\n  static async cleanSetting(){\n    const SETTINGS = getSettings();\n    await SettingsUtil.set(SETTINGS.lastUpdateId.tag, '');\n  }\n\n  /**\n   * Fetch and process update news from the remote JSON\n   * @private\n   */\n  static async checkForUpdates() {\n    const SETTINGS = getSettings();\n    try {\n      // Add a timeout to the fetch to prevent hanging\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 10000); // 5 second timeout\n\n      try {\n        const lastUpdateId = await SettingsUtil.get(SETTINGS.lastUpdateId.tag);\n        const rawVersion = await UpdateNewsUtil.getIdFromRawJson();\n        LogUtil.log('checkForUpdates...', [rawVersion, lastUpdateId]);\n        if(lastUpdateId === rawVersion){\n          return;\n        }\n        const response = await fetch(UpdateNewsUtil.getUpdateNewsUrl(), {\n          signal: controller.signal,\n          // Prevent uncaught errors for network issues\n          mode: 'cors',\n          // Don't send cookies or auth\n          credentials: 'omit'\n        });\n\n        clearTimeout(timeoutId);\n\n        if (!response.ok) {\n          LogUtil.warn(\"checkForUpdates | Failed to fetch update news\", [response.status, response.statusText]);\n          return;\n        }\n\n        const updateData = await response.json();\n\n        // Create and display the chat message\n        await this.displayUpdateNews(updateData);\n\n        // Save the current update ID\n        await SettingsUtil.set(SETTINGS.lastUpdateId.tag, rawVersion);\n        LogUtil.log('checkForUpdates | SUCCESS', [rawVersion]);\n      } catch (fetchError) {\n        clearTimeout(timeoutId);\n        // Handle fetch-specific errors\n        if (fetchError.name === 'AbortError') {\n          LogUtil.warn('checkForUpdates | Request timed out', [fetchError]);\n        } else {\n          LogUtil.warn('checkForUpdates | Fetch error', [fetchError.message]);\n        }\n      }\n    } catch (error) {\n      // This outer try/catch will handle any other errors\n      LogUtil.warn('checkForUpdates | Unexpected error', [error]);\n    }\n  }\n\n  /**\n   * Display the update news in the chat\n   * @param {Object} updateData - The update data from the JSON\n   * @param {string} updateData.id - Unique identifier for the update\n   * @param {string} updateData.title - Update title\n   * @param {string} updateData.content - Update content/description\n   * @param {string} [updateData.imageUrl] - Optional GIF/image URL\n   * @private\n   */\n  static async displayUpdateNews(updateData) {\n    try{\n      const content = `\n        <div class=\"crlngn-news\">\n          <h3>${updateData.title}</h3>\n          ${updateData.imageUrl ? `<img src=\"${updateData.imageUrl}\" alt=\"Update Preview\" />` : ''}\n          ${updateData.videoUrl ? `<div class=\"updates-media-container\"><video controls autoplay loop src=\"${updateData.videoUrl}\" alt=\"Update Preview\" style=\"width: 100%\"></video></div>` : ''}\n          <div class=\"crlngn-news-content\">\n          ${updateData.content}\n          </div>\n        </div>\n      `;\n\n      LogUtil.log('displayUpdateNews | Creating chat message', [updateData]);\n      const resp = await ChatMessage.create({\n        content,\n        whisper: [game.user.id],\n        speaker: { alias: 'Flash Token Bar 5e' }\n      });\n\n      LogUtil.log('displayUpdateNews | Chat message created', [resp, updateData]);\n\n    }catch(error){\n      LogUtil.error('displayUpdateNews | Error creating chat message', [error]);\n    }\n\n  }\n}\n","import { MODULE_ID, ROLL_TYPES, ROLL_REQUEST_OPTIONS, DICE_OPTIONS } from '../../constants/General.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport { FlashAPI } from '../core/FlashAPI.mjs';\nimport { getActorData } from '../helpers/Helpers.mjs';\nimport { TokenTeleportManager } from '../managers/TokenTeleportManager.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\n\n/**\n * Integration with Monk's Active Tiles module\n * Registers Flash Rolls 5e actions for use in tile triggers\n */\nexport class MonksActiveTilesIntegration {\n\n  static _pendingGroupRolls = new Map();\n\n  /**\n   * Registers tile group and single unified roll request action\n   */\n  static initialize() {\n    if (!game.modules.get('monks-active-tiles')?.active) {\n      LogUtil.log('MonksActiveTilesIntegration: Monk\\'s Active Tiles not active, skipping integration');\n      return;\n    }\n\n    Hooks.on(\"setupTileActions\", (app) => {\n      LogUtil.log('MonksActiveTilesIntegration: Registering Flash Rolls 5e tile actions');\n\n      app.registerTileGroup(MODULE_ID, 'Flash Token Bar 5e');\n      this._registerRequestRollAction(app);\n      this._registerHealAllAction(app);\n      this._registerKillAllAction(app);\n      // this._registerOpenSheetsAction(app);\n      this._registerToggleMovementAction(app);\n      this._registerTeleportTokensAction(app);\n      this._registerTransformActorsAction(app);\n    });\n  }\n\n  /**\n   * Register unified Request Roll tile action\n   */\n  static _registerRequestRollAction(app) {\n    app.registerTileAction(MODULE_ID, 'request-roll', {\n      name: game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.actions.requestRoll'),\n      group: MODULE_ID,\n      ctrls: [\n        {\n          id: 'entity',\n          name: 'Actors',\n          type: 'select',\n          subtype: 'entity',\n          options: { show: ['token', 'within', 'players', 'previous'] },\n          restrict: (entity) => {\n            return entity instanceof foundry.canvas.placeables.Token;\n          },\n          defaultType: 'tokens'\n        },\n        {\n          id: 'requestType',\n          name: 'Roll Type',\n          type: 'list',\n          list: () => {\n            const options = {};\n            for (const [key, option] of Object.entries(ROLL_REQUEST_OPTIONS)) {\n              options[option.name] = option.label;\n            }\n            return options;\n          },\n          required: true,\n          defvalue: ROLL_TYPES.SKILL,\n          onChange: async (app, field, action, data) => {\n            const requestType = $(field).val();\n            const option = Object.values(ROLL_REQUEST_OPTIONS).find(opt => opt.name === requestType);\n\n            const rollKeySelect = $('select[name=\"data.rollKey\"]', app.element);\n            if (rollKeySelect.length > 0) {\n              rollKeySelect.empty();\n\n              if (requestType === ROLL_TYPES.CUSTOM) {\n                for (const [key, label] of Object.entries(DICE_OPTIONS)) {\n                  rollKeySelect.append($('<option>', { value: key, text: label }));\n                }\n              } else if (option && option.subList) {\n                const configKey = option.subList;\n                let options = {};\n\n                if (configKey === 'abilities') {\n                  options = CONFIG.DND5E?.abilities || {};\n                  for (const [key, value] of Object.entries(options)) {\n                    rollKeySelect.append($('<option>', { value: key, text: value.label }));\n                  }\n                } else if (configKey === 'skills') {\n                  options = CONFIG.DND5E?.skills || {};\n                  for (const [key, value] of Object.entries(options)) {\n                    rollKeySelect.append($('<option>', { value: key, text: value.label }));\n                  }\n                } else if (configKey === 'tools') {\n                  options = CONFIG.DND5E?.tools || {};\n                  for (const [key, toolConfig] of Object.entries(options)) {\n                    const toolName = await this._getToolName(key, toolConfig);\n                    rollKeySelect.append($('<option>', { value: key, text: toolName }));\n                  }\n                }\n              }\n            }\n\n            app.checkConditional();\n          }\n        },\n        {\n          id: 'rollKey',\n          name: 'Roll Name',\n          type: 'list',\n          list: async (app) => {\n            const requestType = app.element?.querySelector('select[name=\"data.requestType\"]')?.value;\n            if (!requestType) return {};\n\n            if (requestType === ROLL_TYPES.CUSTOM) {\n              return DICE_OPTIONS;\n            }\n\n            const option = Object.values(ROLL_REQUEST_OPTIONS).find(opt => opt.name === requestType);\n            if (!option || !option.subList) return {};\n\n            const configKey = option.subList;\n            const options = {};\n\n            if (configKey === 'abilities') {\n              for (const [key, value] of Object.entries(CONFIG.DND5E?.abilities || {})) {\n                options[key] = value.label;\n              }\n            } else if (configKey === 'skills') {\n              for (const [key, value] of Object.entries(CONFIG.DND5E?.skills || {})) {\n                options[key] = value.label;\n              }\n            } else if (configKey === 'tools') {\n              for (const [key, toolConfig] of Object.entries(CONFIG.DND5E?.tools || {})) {\n                options[key] = await MonksActiveTilesIntegration._getToolName(key, toolConfig);\n              }\n            }\n\n            return options;\n          },\n          conditional: (app) => {\n            const requestType = app.element?.querySelector('select[name=\"data.requestType\"]')?.value;\n            if (!requestType) return false;\n\n            if (requestType === ROLL_TYPES.CUSTOM) return true;\n\n            const option = Object.values(ROLL_REQUEST_OPTIONS).find(opt => opt.name === requestType);\n            return option && option.subList !== null;\n          }\n        },\n        {\n          id: 'dc',\n          name: 'Difficulty Class (DC)',\n          type: 'number',\n          defvalue: 10,\n          min: 0,\n          max: 50\n        },\n        {\n          id: 'advantage',\n          name: 'Advantage/Disadvantage',\n          type: 'list',\n          list: () => {\n            return {\n              'normal': 'Normal',\n              'advantage': 'Advantage',\n              'disadvantage': 'Disadvantage'\n            };\n          },\n          defvalue: 'normal'\n        },\n        {\n          id: 'bonus',\n          name: 'Situational Bonus',\n          type: 'text',\n          help: \"Enter a bonus/penalty (e.g., '+2', '-1', '1d4')\"\n        },\n        {\n          id: 'skipRollDialog',\n          name: 'Skip Roll Dialog',\n          type: 'checkbox',\n          defvalue: false\n        }\n      ],\n      fn: async (args) => {\n        const { action, tokens, tile } = args;\n\n        if (TokenTeleportManager._isTeleporting) {\n          LogUtil.log('MATT Action - Skipping action because teleportation is in progress');\n          return {};\n        }\n\n        let entities = tokens;\n\n        if (action.data?.entity?.id === 'within' && tile && typeof tile.entitiesWithin === 'function') {\n          const withinEntities = tile.entitiesWithin({ collection: 'tokens' });\n          if (Array.isArray(withinEntities) && withinEntities.length > 0) {\n            entities = withinEntities;\n          }\n        } else if (action.data?.entity?.id === 'players') {\n          entities = canvas.tokens.placeables.filter(t => t.actor?.hasPlayerOwner);\n        } else if (action.data?.entity?.id && typeof action.data.entity.id === 'string' &&\n                   !['tokens', 'within', 'players', 'previous'].includes(action.data.entity.id)) {\n          const entityId = action.data.entity.id;\n          const resolvedEntity = await fromUuid(entityId);\n          if (resolvedEntity) {\n            entities = [resolvedEntity];\n          }\n        }\n\n        const actorIds = this._resolveActorIds(null, entities);\n\n        if (!actorIds || actorIds.length === 0) {\n          FlashAPI.notify('warn',game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound'));\n          return {};\n        }\n\n        const groupRollId = this._generateGroupRollId(tile, action);\n\n        if (this._pendingGroupRolls.has(groupRollId)) {\n          const pending = this._pendingGroupRolls.get(groupRollId);\n          for (const actorId of actorIds) {\n            if (!pending.actorIds.includes(actorId)) {\n              pending.actorIds.push(actorId);\n            }\n          }\n          return {};\n        }\n\n        this._pendingGroupRolls.set(groupRollId, {\n          actorIds: [...actorIds],\n          action: action,\n          tile: tile\n        });\n\n        await new Promise(resolve => setTimeout(resolve, 50));\n\n        const pending = this._pendingGroupRolls.get(groupRollId);\n        this._pendingGroupRolls.delete(groupRollId);\n\n        const options = {\n          requestType: action.data.requestType,\n          actorIds: pending.actorIds,\n          dc: action.data.dc,\n          advantage: action.data.advantage === 'advantage' ? true : false,\n          disadvantage: action.data.advantage === 'disadvantage' ? true : false,\n          skipRollDialog: action.data.skipRollDialog === true,\n          sendAsRequest: true,\n          groupRollId: groupRollId\n        };\n\n        if (action.data.rollKey) {\n          options.rollKey = action.data.rollKey;\n        }\n\n        if (action.data.bonus) {\n          options.situationalBonus = action.data.bonus;\n        }\n        await FlashAPI.requestRoll(options);\n\n        return {};\n      },\n      content: async (trigger, action) => {\n        const requestType = action.data?.requestType;\n        const rollOption = Object.values(ROLL_REQUEST_OPTIONS).find(opt => opt.name === requestType);\n        const typeName = rollOption?.label || requestType || 'Unknown';\n\n        let rollKeyName = '';\n        if (action.data?.rollKey) {\n          if (action.data.rollKey.length === 3) {\n            rollKeyName = ` (${this._getSkillName(action.data.rollKey) || this._getAbilityName(action.data.rollKey) || action.data.rollKey})`;\n          } else {\n            rollKeyName = ` (${action.data.rollKey})`;\n          }\n        }\n\n        const dc = action.data?.dc ? ` DC ${action.data.dc}` : '';\n        const advType = action.data?.advantage || 'normal';\n        const advLabel = this._getAdvantageLabel(advType);\n        const bonus = action.data?.bonus ? ` (${action.data.bonus})` : '';\n        const skipDialog = action.data?.skipRollDialog ? ' [Skip Dialog]' : '';\n\n        return `<div>Request <span class=\"value\">${typeName}${rollKeyName}</span>${dc}${advLabel ? ' ' + advLabel : ''}${bonus}${skipDialog}</div>`;\n      }\n    });\n  }\n\n  /**\n   * Register Full Heal tile action\n   */\n  static _registerHealAllAction(app) {\n    app.registerTileAction(MODULE_ID, 'heal-all', {\n      name: game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.actions.healAll'),\n      group: MODULE_ID,\n      ctrls: [\n        {\n          id: 'entity',\n          name: 'Actors',\n          type: 'select',\n          subtype: 'entity',\n          options: { show: ['token', 'within', 'players', 'previous'] },\n          restrict: (entity) => {\n            return entity instanceof foundry.canvas.placeables.Token;\n          },\n          defaultType: 'tokens'\n        }\n      ],\n      fn: async (args) => {\n        const { action, tokens, tile } = args;\n\n        if (TokenTeleportManager._isTeleporting) {\n          LogUtil.log('MATT Action - Skipping action because teleportation is in progress');\n          return {};\n        }\n\n        let entities = tokens;\n\n        if (action.data?.entity?.id === 'within' && tile && typeof tile.entitiesWithin === 'function') {\n          const withinEntities = tile.entitiesWithin({ collection: 'tokens' });\n          if (Array.isArray(withinEntities) && withinEntities.length > 0) {\n            entities = withinEntities;\n          }\n        } else if (action.data?.entity?.id === 'players') {\n          entities = canvas.tokens.placeables.filter(t => t.actor?.hasPlayerOwner);\n        } else if (action.data?.entity?.id && typeof action.data.entity.id === 'string' &&\n                   !['tokens', 'within', 'players', 'previous'].includes(action.data.entity.id)) {\n          const entityId = action.data.entity.id;\n          const resolvedEntity = await fromUuid(entityId);\n          if (resolvedEntity) {\n            entities = [resolvedEntity];\n          }\n        }\n\n        const actorIds = this._resolveActorIds(null, entities);\n\n        if (!actorIds || actorIds.length === 0) {\n          FlashAPI.notify('warn',game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound'));\n          return {};\n        }\n\n        await FlashAPI.healAll(actorIds);\n        return {};\n      },\n      content: async (trigger, action) => {\n        return `<div>${game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.content.healAll')}</div>`;\n      }\n    });\n  }\n\n  /**\n   * Register Kill All tile action\n   */\n  static _registerKillAllAction(app) {\n    app.registerTileAction(MODULE_ID, 'kill-all', {\n      name: game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.actions.killAll'),\n      group: MODULE_ID,\n      ctrls: [\n        {\n          id: 'entity',\n          name: 'Actors',\n          type: 'select',\n          subtype: 'entity',\n          options: { show: ['token', 'within', 'players', 'previous'] },\n          restrict: (entity) => {\n            return entity instanceof foundry.canvas.placeables.Token;\n          },\n          defaultType: 'tokens'\n        }\n      ],\n      fn: async (args) => {\n        const { action, tokens, tile } = args;\n\n        if (TokenTeleportManager._isTeleporting) {\n          LogUtil.log('MATT Action - Skipping action because teleportation is in progress');\n          return {};\n        }\n\n        let entities = tokens;\n\n        if (action.data?.entity?.id === 'within' && tile && typeof tile.entitiesWithin === 'function') {\n          const withinEntities = tile.entitiesWithin({ collection: 'tokens' });\n          if (Array.isArray(withinEntities) && withinEntities.length > 0) {\n            entities = withinEntities;\n          }\n        } else if (action.data?.entity?.id === 'players') {\n          entities = canvas.tokens.placeables.filter(t => t.actor?.hasPlayerOwner);\n        } else if (action.data?.entity?.id && typeof action.data.entity.id === 'string' &&\n                   !['tokens', 'within', 'players', 'previous'].includes(action.data.entity.id)) {\n          const entityId = action.data.entity.id;\n          const resolvedEntity = await fromUuid(entityId);\n          if (resolvedEntity) {\n            entities = [resolvedEntity];\n          }\n        }\n\n        const actorIds = this._resolveActorIds(null, entities);\n\n        if (!actorIds || actorIds.length === 0) {\n          FlashAPI.notify('warn',game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound'));\n          return {};\n        }\n\n        await FlashAPI.killAll(actorIds);\n        return {};\n      },\n      content: async (trigger, action) => {\n        return `<div>${game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.content.killAll')}</div>`;\n      }\n    });\n  }\n\n  /**\n   * Register Open Sheets tile action\n   */\n  static _registerOpenSheetsAction(app) {\n    app.registerTileAction(MODULE_ID, 'open-sheets', {\n      name: game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.actions.openSheets'),\n      group: MODULE_ID,\n      ctrls: [\n        {\n          id: 'entity',\n          name: 'Actors',\n          type: 'select',\n          subtype: 'entity',\n          options: { show: ['token', 'within', 'players', 'previous'] },\n          restrict: (entity) => {\n            return entity instanceof foundry.canvas.placeables.Token;\n          },\n          defaultType: 'tokens'\n        }\n      ],\n      fn: async (args) => {\n        const { action, tokens, tile } = args;\n\n        if (TokenTeleportManager._isTeleporting) {\n          LogUtil.log('MATT Action - Skipping action because teleportation is in progress');\n          return {};\n        }\n\n        let entities = tokens;\n\n        if (action.data?.entity?.id === 'within' && tile && typeof tile.entitiesWithin === 'function') {\n          const withinEntities = tile.entitiesWithin({ collection: 'tokens' });\n          if (Array.isArray(withinEntities) && withinEntities.length > 0) {\n            entities = withinEntities;\n          }\n        } else if (action.data?.entity?.id === 'players') {\n          entities = canvas.tokens.placeables.filter(t => t.actor?.hasPlayerOwner);\n        } else if (action.data?.entity?.id && typeof action.data.entity.id === 'string' &&\n                   !['tokens', 'within', 'players', 'previous'].includes(action.data.entity.id)) {\n          const entityId = action.data.entity.id;\n          const resolvedEntity = await fromUuid(entityId);\n          if (resolvedEntity) {\n            entities = [resolvedEntity];\n          }\n        }\n\n        const actorIds = this._resolveActorIds(null, entities);\n\n        if (!actorIds || actorIds.length === 0) {\n          FlashAPI.notify('warn',game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound'));\n          return {};\n        }\n\n        await FlashAPI.openSheets(actorIds);\n        return {};\n      },\n      content: async (trigger, action) => {\n        return `<div>${game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.content.openSheets')}</div>`;\n      }\n    });\n  }\n\n  /**\n   * Register Toggle Movement tile action\n   */\n  static _registerToggleMovementAction(app) {\n    app.registerTileAction(MODULE_ID, 'toggle-movement', {\n      name: game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.actions.toggleMovement'),\n      group: MODULE_ID,\n      ctrls: [\n        {\n          id: 'entity',\n          name: 'Actors',\n          type: 'select',\n          subtype: 'entity',\n          options: { show: ['token', 'within', 'players', 'previous'] },\n          restrict: (entity) => {\n            return entity instanceof foundry.canvas.placeables.Token;\n          },\n          defaultType: 'tokens'\n        }\n      ],\n      fn: async (args) => {\n        const { action, tokens, tile } = args;\n\n        if (TokenTeleportManager._isTeleporting) {\n          LogUtil.log('MATT Action - Skipping action because teleportation is in progress');\n          return {};\n        }\n\n        let entities = tokens;\n\n        if (action.data?.entity?.id === 'within' && tile && typeof tile.entitiesWithin === 'function') {\n          const withinEntities = tile.entitiesWithin({ collection: 'tokens' });\n          if (Array.isArray(withinEntities) && withinEntities.length > 0) {\n            entities = withinEntities;\n          }\n        } else if (action.data?.entity?.id === 'players') {\n          entities = canvas.tokens.placeables.filter(t => t.actor?.hasPlayerOwner);\n        } else if (action.data?.entity?.id && typeof action.data.entity.id === 'string' &&\n                   !['tokens', 'within', 'players', 'previous'].includes(action.data.entity.id)) {\n          const entityId = action.data.entity.id;\n          const resolvedEntity = await fromUuid(entityId);\n          if (resolvedEntity) {\n            entities = [resolvedEntity];\n          }\n        }\n\n        const actorIds = this._resolveActorIds(null, entities);\n\n        if (!actorIds || actorIds.length === 0) {\n          FlashAPI.notify('warn',game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound'));\n          return {};\n        }\n\n        await FlashAPI.toggleMovement(actorIds);\n        return {};\n      },\n      content: async (trigger, action) => {\n        return `<div>${game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.content.toggleMovement')}</div>`;\n      }\n    });\n  }\n\n  /**\n   * Register Teleport Tokens tile action\n   */\n  static _registerTeleportTokensAction(app) {\n    app.registerTileAction(MODULE_ID, 'teleport-tokens', {\n      name: game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.actions.teleportTokens'),\n      group: MODULE_ID,\n      ctrls: [\n        {\n          id: 'entity',\n          name: 'Actors',\n          type: 'select',\n          subtype: 'entity',\n          options: { show: ['token', 'within', 'players', 'previous'] },\n          restrict: (entity) => {\n            return entity instanceof foundry.canvas.placeables.Token;\n          },\n          defaultType: 'tokens'\n        },\n        {\n          id: 'location',\n          name: 'Select Coordinates',\n          type: 'select',\n          subtype: 'either',\n          options: { show: ['either', 'tile', 'previous'] },\n          restrict: (entity, document) => {\n            return (entity instanceof foundry.canvas.placeables.Tile || entity instanceof Scene);\n          },\n          required: true,\n          placeholder: 'Select a location'\n        },\n        {\n          id: 'snap',\n          name: 'Snap to Grid',\n          type: 'checkbox',\n          defvalue: true\n        }\n      ],\n      fn: async (args) => {\n        const { action, tokens, tile, value } = args;\n\n        LogUtil.log('MATT Teleport - Initial args:', [{\n          actionEntityId: action.data?.entity?.id,\n          tokensCount: tokens?.length,\n          valueTokensCount: value?.tokens?.length\n        }]);\n\n        let entities = [];\n\n        if (action.data?.entity?.id === 'within' && tile && typeof tile.entitiesWithin === 'function') {\n          const withinEntities = tile.entitiesWithin({ collection: 'tokens' });\n\n          const tileObject = tile.document ? tile : canvas.tiles.get(tile.id);\n          entities = this._filterTokensWithinTileBounds(withinEntities, tileObject);\n        } else if (action.data?.entity?.id === 'players') {\n          entities = canvas.tokens.placeables.filter(t => t.actor?.hasPlayerOwner);\n        } else if (action.data?.entity?.id && typeof action.data.entity.id === 'string' &&\n                   !['tokens', 'within', 'players', 'previous'].includes(action.data.entity.id)) {\n          const entityId = action.data.entity.id;\n          const resolvedEntity = await fromUuid(entityId);\n          if (resolvedEntity) {\n            entities = [resolvedEntity];\n          }\n        } else if (value?.tokens && Array.isArray(value.tokens) && value.tokens.length > 0) {\n          entities = value.tokens;\n        } else if (tokens && Array.isArray(tokens) && tokens.length > 0) {\n          entities = tokens;\n        }\n\n        const tokenIds = [];\n        for (const entity of entities) {\n          if (entity instanceof foundry.canvas.placeables.Token || entity instanceof TokenDocument) {\n            tokenIds.push(entity.id);\n          } else if (entity?.id) {\n            tokenIds.push(entity.id);\n          }\n        }\n\n        if (!tokenIds || tokenIds.length === 0) {\n          FlashAPI.notify('warn',game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound'));\n          return {};\n        }\n\n        const locationData = action.data?.location;\n\n        if (!locationData) {\n          await FlashAPI.teleportTokens(tokenIds);\n          return {};\n        }\n\n        let centerLocation;\n        let sceneId = locationData.sceneId || null;\n        let selectedTile = null;\n\n        if (value?.stopdata?.tile) {\n          selectedTile = value.stopdata.tile;\n          sceneId = selectedTile.document?.parent?.id || canvas.scene.id;\n        } else if (locationData.id && typeof locationData.id === 'string' && !locationData.x && !locationData.y) {\n          const entity = await fromUuid(locationData.id);\n          if (entity instanceof foundry.canvas.placeables.Tile) {\n            selectedTile = entity;\n            sceneId = entity.document.parent?.id || canvas.scene.id;\n          }\n        }\n\n        if (!selectedTile) {\n          if (locationData.x !== undefined && locationData.y !== undefined) {\n            centerLocation = { x: locationData.x, y: locationData.y };\n          } else if (value?.location) {\n            centerLocation = { x: value.location.x, y: value.location.y };\n            if (value.location.sceneId) {\n              sceneId = value.location.sceneId;\n            }\n          }\n\n          if (!centerLocation) {\n            LogUtil.warn('No valid location coordinates found, entering interactive mode', locationData);\n            await FlashAPI.teleportTokens(tokenIds);\n            return {};\n          }\n        }\n\n        const targetScene = sceneId ? game.scenes.get(sceneId) : canvas.scene;\n        if (!targetScene) {\n          ui.notifications.error(`Scene not found: ${sceneId}`);\n          return {};\n        }\n\n        const shouldSnap = action.data?.snap !== false;\n\n        if (selectedTile) {\n          const tileDoc = selectedTile.document;\n          const tileBounds = {\n            x: tileDoc.x,\n            y: tileDoc.y,\n            width: tileDoc.width,\n            height: tileDoc.height\n          };\n\n          const tokenData = [];\n          for (const tokenId of tokenIds) {\n            const token = canvas.tokens.get(tokenId);\n            if (!token) continue;\n\n            const tokenWidth = token.document.width * targetScene.grid.size;\n            const tokenHeight = token.document.height * targetScene.grid.size;\n\n            const maxX = tileBounds.x + tileBounds.width - tokenWidth;\n            const maxY = tileBounds.y + tileBounds.height - tokenHeight;\n\n            const randomX = tileBounds.x + Math.random() * (maxX - tileBounds.x);\n            const randomY = tileBounds.y + Math.random() * (maxY - tileBounds.y);\n\n            let finalLocation = { x: randomX, y: randomY };\n\n            if (shouldSnap) {\n              finalLocation = targetScene.grid.getSnappedPoint(finalLocation, { mode: CONST.GRID_SNAPPING_MODES.CENTER });\n            }\n\n            tokenData.push({ tokenId, finalLocation });\n          }\n\n          for (const { tokenId, finalLocation } of tokenData) {\n            await FlashAPI.teleportTokens([tokenId], targetScene, finalLocation);\n          }\n        } else {\n          await FlashAPI.teleportTokens(tokenIds, targetScene, centerLocation);\n        }\n\n        return {};\n      },\n      content: async (trigger, action) => {\n        const location = action.data?.location;\n        let locationText = 'coordinates';\n\n        if (location?.id === 'previous') {\n          locationText = 'previous location';\n        } else if (location?.id === 'origin') {\n          locationText = 'trigger origin';\n        } else if (location?.id) {\n          locationText = location.id;\n        }\n\n        let sceneText = '';\n        if (location?.sceneId && location.sceneId !== canvas.scene?.id) {\n          const scene = game.scenes.get(location.sceneId);\n          sceneText = scene ? ` in <span class=\"value\">${scene.name}</span>` : ' in Unknown Scene';\n        }\n\n        const snap = action.data?.snap ?? true;\n        const snapText = snap ? ' (snap to grid)' : '';\n\n        return `<div>${game.i18n.format('FLASH_ROLLS.ui.dialogs.matt.content.teleport', {\n          location: `<span class=\"value\">${locationText}</span>`,\n          scene: sceneText,\n          snap: snapText\n        })}</div>`;\n      }\n    });\n  }\n\n  /**\n   * Register Transform Actors tile action\n   */\n  static _registerTransformActorsAction(app) {\n    app.registerTileAction(MODULE_ID, 'transform-actors', {\n      name: game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.actions.transformActors'),\n      group: MODULE_ID,\n      ctrls: [\n        {\n          id: 'entity',\n          name: game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.transform.actors'),\n          type: 'select',\n          subtype: 'entity',\n          options: { show: ['token', 'within', 'players', 'previous'] },\n          restrict: (entity) => {\n            return entity instanceof foundry.canvas.placeables.Token;\n          },\n          defaultType: 'tokens'\n        },\n        {\n          id: 'targetActorUuid',\n          name: game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.transform.targetCreature'),\n          type: 'select',\n          subtype: 'entity',\n          options: { show: ['actor'] },\n          restrict: (entity) => {\n            return entity instanceof Actor;\n          },\n          required: false,\n          help: 'Leave empty to show selection dialog'\n        },\n        {\n          id: 'preset',\n          name: game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.transform.preset'),\n          type: 'list',\n          list: () => {\n            return {\n              'polymorph': game.i18n.localize('FLASH_ROLLS.ui.dialogs.transformation.presets.polymorph'),\n              'wildshape': game.i18n.localize('FLASH_ROLLS.ui.dialogs.transformation.presets.wildshape'),\n              'appearance': game.i18n.localize('FLASH_ROLLS.ui.dialogs.transformation.presets.appearance'),\n              'custom': game.i18n.localize('FLASH_ROLLS.ui.dialogs.transformation.presets.custom')\n            };\n          },\n          defvalue: 'polymorph'\n        },\n        {\n          id: 'revert',\n          name: game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.transform.revert'),\n          type: 'checkbox',\n          defvalue: false\n        }\n      ],\n      fn: async (args) => {\n        const { action, tokens, tile } = args;\n\n        if (TokenTeleportManager._isTeleporting) {\n          LogUtil.log('MATT Action - Skipping action because teleportation is in progress');\n          return {};\n        }\n\n        let entities = tokens;\n\n        if (action.data?.entity?.id === 'within' && tile && typeof tile.entitiesWithin === 'function') {\n          const withinEntities = tile.entitiesWithin({ collection: 'tokens' });\n          if (Array.isArray(withinEntities) && withinEntities.length > 0) {\n            entities = withinEntities;\n          }\n        } else if (action.data?.entity?.id === 'players') {\n          entities = canvas.tokens.placeables.filter(t => t.actor?.hasPlayerOwner);\n        } else if (action.data?.entity?.id && typeof action.data.entity.id === 'string' &&\n                   !['tokens', 'within', 'players', 'previous'].includes(action.data.entity.id)) {\n          const entityId = action.data.entity.id;\n          const resolvedEntity = await fromUuid(entityId);\n          if (resolvedEntity) {\n            entities = [resolvedEntity];\n          }\n        }\n\n        const tokenDocs = [];\n        for (const entity of entities) {\n          let tokenDoc = null;\n          if (entity instanceof TokenDocument) {\n            tokenDoc = entity;\n          } else if (entity instanceof foundry.canvas.placeables.Token) {\n            tokenDoc = entity.document;\n          } else if (entity instanceof Actor) {\n            const token = canvas.tokens.placeables.find(t => t.actor?.id === entity.id);\n            if (token) tokenDoc = token.document;\n          }\n          if (tokenDoc && !tokenDocs.includes(tokenDoc)) {\n            tokenDocs.push(tokenDoc);\n          }\n        }\n\n        if (!tokenDocs || tokenDocs.length === 0) {\n          FlashAPI.notify('warn',game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.warnings.noActorsFound'));\n          return {};\n        }\n\n        const actors = tokenDocs.map(td => td.actor).filter(a => a);\n\n        if (action.data?.revert) {\n          const transformedTokenDocIds = tokenDocs\n            .filter(td => td.actor?.getFlag(\"dnd5e\", \"isPolymorphed\"))\n            .map(td => td.id);\n\n          if (transformedTokenDocIds.length > 0) {\n            await FlashAPI.revertTransformation(transformedTokenDocIds);\n          }\n        } else {\n          const nonTransformedTokenDocIds = tokenDocs\n            .filter(td => !td.actor?.getFlag(\"dnd5e\", \"isPolymorphed\"))\n            .map(td => td.id);\n\n          if (nonTransformedTokenDocIds.length === 0) {\n            return {};\n          }\n\n          let targetUuid = null;\n          if (action.data?.targetActorUuid) {\n            if (typeof action.data.targetActorUuid === 'string') {\n              targetUuid = action.data.targetActorUuid.trim() || null;\n            } else if (action.data.targetActorUuid.id) {\n              const entity = await fromUuid(action.data.targetActorUuid.id);\n              targetUuid = entity?.uuid || null;\n            }\n          }\n          const preset = action.data?.preset || 'polymorph';\n          const skipRevertCheck = true;\n\n          await FlashAPI.transformActors(nonTransformedTokenDocIds, targetUuid, { preset, skipRevertCheck });\n        }\n\n        return {};\n      },\n      content: async (trigger, action) => {\n        const isRevert = action.data?.revert;\n\n        if (isRevert) {\n          return `<div>${game.i18n.localize('FLASH_ROLLS.ui.dialogs.matt.content.revertTransformation')}</div>`;\n        }\n\n        let targetUuid = null;\n        if (action.data?.targetActorUuid) {\n          if (typeof action.data.targetActorUuid === 'string') {\n            targetUuid = action.data.targetActorUuid.trim() || null;\n          } else if (action.data.targetActorUuid.id) {\n            targetUuid = action.data.targetActorUuid.id;\n          }\n        }\n\n        const preset = action.data?.preset || 'polymorph';\n\n        let targetText = 'selection dialog';\n        if (targetUuid) {\n          try {\n            const targetActor = await fromUuid(targetUuid);\n            targetText = targetActor?.name || 'Unknown Actor';\n          } catch (e) {\n            targetText = 'Invalid UUID';\n          }\n        }\n\n        return `<div>${game.i18n.format('FLASH_ROLLS.ui.dialogs.matt.content.transform', {\n          target: `<span class=\"value\">${targetText}</span>`,\n          preset: preset\n        })}</div>`;\n      }\n    });\n  }\n\n  /**\n   * Filter tokens to only those truly within tile bounds\n   * @param {Array} entities - Array of token entities from MATT\n   * @param {Object} tile - The tile object to check bounds against\n   * @returns {Array} Filtered array of tokens within tile bounds\n   */\n  static _filterTokensWithinTileBounds(entities, tile) {\n    if (!Array.isArray(entities) || entities.length === 0 || !tile || !tile.document) {\n      return [];\n    }\n\n    const tileDoc = tile.document;\n    const tileBounds = {\n      x: tileDoc.x,\n      y: tileDoc.y,\n      x2: tileDoc.x + tileDoc.width,\n      y2: tileDoc.y + tileDoc.height\n    };\n\n    return entities.filter(entity => {\n      const token = entity instanceof foundry.canvas.placeables.Token ? entity : canvas.tokens.get(entity.id);\n      if (!token) return false;\n\n      const tokenX = token.document.x;\n      const tokenY = token.document.y;\n      const tokenWidth = token.document.width * canvas.grid.size;\n      const tokenHeight = token.document.height * canvas.grid.size;\n      const tokenCenterX = tokenX + tokenWidth / 2;\n      const tokenCenterY = tokenY + tokenHeight / 2;\n\n      const isWithin = tokenCenterX >= tileBounds.x &&\n                      tokenCenterX <= tileBounds.x2 &&\n                      tokenCenterY >= tileBounds.y &&\n                      tokenCenterY <= tileBounds.y2;\n\n      return isWithin;\n    });\n  }\n\n  /**\n   * Resolve actor IDs from token documents\n   */\n  static _resolveActorIds(entityData, entities) {\n    const actorIds = [];\n\n    if (!entities || entities.length === 0) {\n      return actorIds;\n    }\n\n    for (let i = 0; i < entities.length; i++) {\n      const entity = entities[i];\n\n      let actorId = null;\n\n      if (entity instanceof TokenDocument || entity?.documentName === 'Token') {\n        actorId = entity.actor?.id;\n      } else if (entity instanceof foundry.canvas.placeables.Token) {\n        actorId = entity.document?.actor?.id || entity.actor?.id;\n      } else if (entity instanceof Actor) {\n        actorId = entity.id;\n      } else if (entity?.actorId) {\n        actorId = entity.actorId;\n      } else if (entity?.actor?.id) {\n        actorId = entity.actor.id;\n      }\n\n      if (actorId && !actorIds.includes(actorId)) {\n        actorIds.push(actorId);\n      } else if (actorId) {\n      }\n    }\n\n    return actorIds;\n  }\n\n  /**\n   * Get localized skill name from skill ID\n   */\n  static _getSkillName(skillId) {\n    if (!skillId) return null;\n    return CONFIG.DND5E?.skills?.[skillId]?.label || null;\n  }\n\n  /**\n   * Get localized ability name from ability ID\n   */\n  static _getAbilityName(abilityId) {\n    if (!abilityId) return null;\n    return CONFIG.DND5E?.abilities?.[abilityId]?.label || null;\n  }\n\n  /**\n   * Get tool name from tool ID and config\n   */\n  static async _getToolName(toolId, toolConfig) {\n    if (!toolId) return toolId;\n\n    const actors = game.actors?.contents || [];\n    for (const actor of actors) {\n      const tool = actor.system?.tools?.[toolId];\n      if (tool?.label) {\n        return tool.label;\n      }\n    }\n\n    if (toolConfig?.id) {\n      try {\n        const item = await fromUuid(toolConfig.id);\n        if (item?.name) return item.name;\n      } catch (error) {\n        LogUtil.log(`MonksActiveTilesIntegration: Failed to fetch tool name for ${toolId}`, error);\n      }\n    }\n\n    const capitalizedId = toolId.charAt(0).toUpperCase() + toolId.slice(1);\n    return capitalizedId;\n  }\n\n  /**\n   * Get human-readable advantage label\n   */\n  static _getAdvantageLabel(advType) {\n    switch (advType) {\n      case 'advantage':\n        return 'with Advantage';\n      case 'disadvantage':\n        return 'with Disadvantage';\n      default:\n        return '';\n    }\n  }\n\n  /**\n   * Generate a stable groupRollId for tile actions to combine simultaneous triggers\n   * @param {Object} tile - The triggering tile\n   * @param {Object} action - The action being executed\n   * @returns {string} Stable groupRollId\n   */\n  static _generateGroupRollId(tile, action) {\n    if (!tile?.id) {\n      return foundry.utils.randomID();\n    }\n    const timestamp = Math.floor(Date.now() / 100);\n    return `matt-${tile.id}-${action._id || 'action'}-${timestamp}`;\n  }\n}\n","import { HOOKS_CORE, HOOKS_DND5E, HOOKS_MIDI_QOL, HOOKS_MODULE, HOOKS_TIDY5E } from \"../../constants/Hooks.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { DiceConfigUtil } from \"../utils/DiceConfigUtil.mjs\";\nimport { RollInterceptor } from \"../handlers/RollInterceptor.mjs\";\nimport { RollHelpers } from \"../helpers/RollHelpers.mjs\";\nimport { updateSidebarClass, isSidebarExpanded } from \"../helpers/Helpers.mjs\";\nimport { SidebarController } from \"../managers/SidebarController.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { MODULE_ID } from \"../../constants/General.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\nimport { ModuleHelpers } from \"../helpers/ModuleHelpers.mjs\";\nimport { ChatMessageManager } from \"../managers/ChatMessageManager.mjs\";\nimport RollRequestsMenu from \"../ui/RollRequestsMenu.mjs\";\nimport { ActorStatusManager } from \"../managers/ActorStatusManager.mjs\";\nimport { ActorDirectoryIconUtil } from \"../utils/ActorDirectoryIconUtil.mjs\";\nimport { FlashAPI } from \"./FlashAPI.mjs\";\nimport { RollMenuDragManager } from \"../managers/roll-menu/RollMenuDragManager.mjs\";\nimport { RollHooksHandler } from \"../handlers/RollHooksHandler.mjs\";\nimport { BaseActivityManager } from \"../managers/BaseActivityManager.mjs\";\nimport { GroupTokenTracker } from \"../managers/GroupTokenTracker.mjs\";\nimport { TokenMovementManager } from \"../utils/TokenMovementManager.mjs\";\nimport { TokenAnimationManager } from \"../managers/TokenAnimationManager.mjs\";\nimport { TokenTeleportManager } from \"../managers/TokenTeleportManager.mjs\";\nimport { TooltipUtil } from \"../utils/TooltipUtil.mjs\";\nimport { UpdateNewsUtil } from \"../utils/UpdateNewsUtil.mjs\";\nimport { MidiActivityManager } from \"../managers/MidiActivityManager.mjs\";\nimport { LibWrapperUtil } from \"../utils/LibWrapperUtil.mjs\";\nimport { MonksActiveTilesIntegration } from \"../integrations/MonksActiveTilesIntegration.mjs\";\nimport { DnDBeyondIntegration } from \"../integrations/DnDBeyondIntegration.mjs\";\nimport { PatronSessionManager } from \"../managers/PatronSessionManager.mjs\";\n\n/**\n * Utility class for managing all module hooks in one place\n */\nexport class HooksManager {\n  static registeredHooks = new Map();\n  static midiTimeout = null;\n  static throttleTimers = {};\n  static activityConfigCache = new Map(); // In-memory cache for activity configs\n  static CACHE_EXPIRY_MS = 30000; // 30 seconds expiry for cache entries\n  static templateRemovalTimers = new Set(); // Track items that already have template removal scheduled\n\n  /**\n   * Get activity config from cache with automatic cleanup of expired entries\n   * @param {string} key - The cache key to retrieve\n   * @returns {object|null} The cached config or null if not found/expired\n   */\n  static getActivityConfigFromCache(key) {\n    const entry = HooksManager.activityConfigCache.get(key);\n    if (!entry) return null;\n\n    // Check if entry has expired\n    const now = Date.now();\n    if (now - entry.timestamp > HooksManager.CACHE_EXPIRY_MS) {\n      HooksManager.activityConfigCache.delete(key);\n      LogUtil.log('getActivityConfigFromCache - deleted expired entry', [key]);\n      return null;\n    }\n\n    return entry.config;\n  }\n\n  /**\n   * Initialize main module hooks\n   */\n  static initialize() {\n    Hooks.once(HOOKS_CORE.INIT, this._onInit.bind(this));\n    Hooks.once(HOOKS_CORE.READY, this._onReady.bind(this));\n    Hooks.on(HOOKS_CORE.CANVAS_READY, this._onCanvasReady.bind(this));\n    Hooks.on(HOOKS_MODULE.READY, ()=>{\n      LogUtil.log(\"flash-rolls-5e.ready hook\", []);\n    })\n    Hooks.on(HOOKS_CORE.GET_CHAT_MESSAGE_CONTEXT_OPTIONS, (document, contextOptions) => {\n      LogUtil.log(\"getChatMessageContextOptions hook\", [document, contextOptions]);\n      if (!game.user.isGM) return;\n      \n      this._addGroupRollContextOptions(document, contextOptions);\n    });\n    \n    Hooks.on(HOOKS_CORE.CLIENT_SETTING_CHANGED, this._onClientSettingChanged.bind(this));\n\n    this._registerTidy5eHooks();\n\n    Hooks.once(HOOKS_CORE.GET_ACTOR_CONTEXT_OPTIONS, (html, contextOptions) => {\n      LogUtil.log(\"getActorContextOptions hook\", [html, contextOptions]);\n      \n      if (!game.user.isGM) return;\n\n      contextOptions.push({\n        name: game.i18n.localize(\"FLASH_ROLLS.contextMenu.unblockFromMenu\"),\n        icon: '<i class=\"fas fa-bolt\"></i>',\n        callback: li => {\n          const actorId = li.dataset.entryId;\n          if (actorId) {\n            ActorStatusManager.toggleBlocked(actorId, false);\n          }\n          return actorId;\n        },\n        condition: li => {\n          const actorId = li?.dataset?.entryId;\n          const isBlocked = ActorStatusManager.isBlocked(actorId);\n          return isBlocked;\n        }\n      });\n\n      contextOptions.push({\n        name: game.i18n.localize(\"FLASH_ROLLS.contextMenu.blockFromMenu\"),\n        icon: '<i class=\"fas fa-bolt-slash\"></i>',\n        callback: li => {\n          const actorId = li.dataset.entryId;\n          if (actorId) {\n            ActorStatusManager.toggleBlocked(actorId, true);\n          }\n          return actorId;\n        },\n        condition: li => {\n          const actorId = li?.dataset?.entryId;\n          const isBlocked = ActorStatusManager.isBlocked(actorId);\n          return !isBlocked;\n        }\n      });\n    });\n  }\n\n  /**\n   * Add context menu options for group roll messages\n   * @param {ChatMessage} message - The chat message document\n   * @param {Array} contextOptions - Array of context menu options\n   */\n  static _addGroupRollContextOptions(chatLog, contextOptions) {\n    LogUtil.log(\"_addGroupRollContextOptions\", [chatLog, contextOptions]);\n    \n    // Add \"Hide NPCs from Players\" option\n    contextOptions.push({\n      name: game.i18n.localize(\"FLASH_ROLLS.contextMenu.hideNPCsFromPlayers\"),\n      icon: '<i class=\"fas fa-eye-slash\"></i>',\n      callback: li => {\n        const messageId = li.dataset.messageId;\n        const message = game.messages.get(messageId);\n        if (message) {\n          message.setFlag(MODULE_ID, 'npcHiddenOverride', true);\n          FlashAPI.notify('info', game.i18n.localize(\"FLASH_ROLLS.notifications.npcHiddenFromPlayers\"));\n        }\n      },\n      condition: li => {\n        const messageId = li.dataset.messageId;\n        if (!messageId) return false;\n        const message = game.messages.get(messageId);\n        if (!message || !message.getFlag(MODULE_ID, 'isGroupRoll')) return false;\n        \n        const SETTINGS = getSettings();\n        const globalHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n        const messageHidden = message.getFlag(MODULE_ID, 'npcHiddenOverride');\n        const currentlyHidden = messageHidden !== undefined ? messageHidden : globalHidden;\n        \n        return !currentlyHidden;\n      }\n    });\n\n    // Add \"Show NPCs to Players\" option\n    contextOptions.push({\n      name: game.i18n.localize(\"FLASH_ROLLS.contextMenu.showNPCsToPlayers\"),\n      icon: '<i class=\"fas fa-eye\"></i>',\n      callback: li => {\n        const messageId = li.dataset.messageId;\n        const message = game.messages.get(messageId);\n        if (message) {\n          const SETTINGS = getSettings();\n          const globalHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n\n          if (globalHidden) {\n            message.setFlag(MODULE_ID, 'npcHiddenOverride', false);\n          } else {\n            message.unsetFlag(MODULE_ID, 'npcHiddenOverride');\n          }\n          FlashAPI.notify('info', game.i18n.localize(\"FLASH_ROLLS.notifications.npcVisibleToPlayers\"));\n        }\n      },\n      condition: li => {\n        const messageId = li.dataset.messageId;\n        if (!messageId) return false;\n        const message = game.messages.get(messageId);\n        if (!message || !message.getFlag(MODULE_ID, 'isGroupRoll')) return false;\n\n        const SETTINGS = getSettings();\n        const globalHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n        const messageHidden = message.getFlag(MODULE_ID, 'npcHiddenOverride');\n        const currentlyHidden = messageHidden !== undefined ? messageHidden : globalHidden;\n\n        return currentlyHidden;\n      }\n    });\n\n    contextOptions.push({\n      name: game.i18n.localize(\"FLASH_ROLLS.contextMenu.showAllResultsToPlayers\"),\n      icon: '<i class=\"fas fa-eye\"></i>',\n      callback: li => {\n        const messageId = li.dataset.messageId;\n        const message = game.messages.get(messageId);\n        if (message) {\n          message.setFlag(MODULE_ID, 'showAllResultsToPlayers', true);\n        }\n      },\n      condition: li => {\n        const messageId = li.dataset.messageId;\n        if (!messageId) return false;\n        const message = game.messages.get(messageId);\n        if (!message || !message.getFlag(MODULE_ID, 'isGroupRoll')) return false;\n\n        const showAllResults = message.getFlag(MODULE_ID, 'showAllResultsToPlayers');\n        return !showAllResults;\n      }\n    });\n  }\n  \n  /**\n   * Triggered when Foundry initializes\n   */\n  static _onInit() {\n    const SETTINGS = getSettings();\n    document.body.classList.add(\"flash5e\");\n    SettingsUtil.registerSettings();\n    DiceConfigUtil.initialize();\n    this._registerHook(HOOKS_CORE.RENDER_CHAT_MESSAGE, ChatMessageManager.onRenderChatMessage.bind(ChatMessageManager));\n    this._registerHook(HOOKS_CORE.RENDER_ROLL_RESOLVER, this._onRenderRollResolver.bind(this));\n    MonksActiveTilesIntegration.initialize();\n  }\n  \n  /**\n   * Triggered when Foundry is ready (fully loaded)\n   */\n  static _onReady() {\n    LogUtil.log(\"CONFIG.DND5E\",[CONFIG.DND5E]);\n    SettingsUtil.registerSettingsMenu();\n    ActorDirectoryIconUtil.initialize();\n    SidebarController.addSidebarControls(ui.sidebar, ui.sidebar?.element);\n    UpdateNewsUtil.init();\n    PatronSessionManager.initialize();\n\n    if (game.user.isGM) {\n      LibWrapperUtil.showMissingLibWrapperNotification();\n    }\n\n    // Listen for browser color scheme changes\n    if (matchMedia) {\n      matchMedia(\"(prefers-color-scheme: dark)\").addEventListener(\"change\", this._onBrowserColorSchemeChanged.bind(this));\n    }\n\n    if(GeneralUtil.isModuleOn(\"midi-qol\")){\n      Hooks.once(HOOKS_MIDI_QOL.READY, this._initModule.bind(this));\n    }else{\n      this._initModule();\n    }\n    LogUtil.log(\"HooksManager.ready\", [canvas]);\n  }\n\n\n  static async _initModule() {\n    const SETTINGS = getSettings();\n    const isDebugOn = SettingsUtil.get(SETTINGS.debugMode.tag);\n    if (isDebugOn) {\n      CONFIG.debug.hooks = true;\n    }\n    \n    await ChatMessageManager.initialize();\n\n    // Register all hooks after determining user role\n    this._registerHooks();\n\n    TokenAnimationManager.initialize();\n    TooltipUtil.initialize();\n\n    if (game.user.isGM) {\n      RollInterceptor.initialize();\n      RollRequestsMenu.showOnLoadIfEnabled();\n      GroupTokenTracker.initialize();\n      // Initialize user connections for dice config\n      game.users.forEach(user => {\n        this._onUserConnected(user);\n      });\n    } else {\n      DiceConfigUtil.getDiceConfig();\n    }\n    updateSidebarClass(isSidebarExpanded());\n    TokenMovementManager.initializeCombatMovementRestrictions();\n\n    // Initialize public API for other modules\n    const module = game.modules.get(\"flash-rolls-5e\");\n    if (module) {\n      module.api = FlashAPI;\n    }\n\n    globalThis.FlashAPI = FlashAPI;\n    globalThis.FlashRolls5e = FlashAPI;\n    Hooks.call(\"flash-rolls-5e.ready\");\n\n    DnDBeyondIntegration.initialize();\n  }\n  \n  /**\n   * Register all hooks based on user role\n   */\n  static _registerHooks() {\n    this._registerCommonHooks();\n\n    if (game.user.isGM) {\n      this._registerGMOnlyHooks();\n    } else {\n      this._registerPlayerOnlyHooks();\n    }\n  }\n\n  /**\n   * Register hooks common to both GM and players\n   */\n  static _registerCommonHooks() {\n    // UI and Sidebar hooks\n    this._registerHook(HOOKS_CORE.RENDER_SIDEBAR, this._onRenderSidebar.bind(this));\n    this._registerHook(HOOKS_CORE.CHANGE_SIDEBAR_TAB, this._onSidebarUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.COLLAPSE_SIDE_BAR, this._onSidebarUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.REFRESH_MEASURED_TEMPLATE, this.onRefreshTemplate.bind(this));\n    this._registerHook(HOOKS_CORE.CANVAS_READY, this._onCanvasReady.bind(this));\n\n    // Chat message hooks (delegated to ChatMessageManager)\n    this._registerHook(HOOKS_CORE.CREATE_CHAT_MESSAGE, ChatMessageManager.onCreateChatMessage.bind(ChatMessageManager));\n    this._registerHook(HOOKS_CORE.PRE_CREATE_CHAT_MESSAGE, ChatMessageManager.onPreCreateChatMessage.bind(ChatMessageManager));\n    this._registerHook(HOOKS_CORE.RENDER_CHAT_LOG, ChatMessageManager.onRenderChatLog.bind(ChatMessageManager));\n\n    // Token movement restriction hook\n    this._registerHook(HOOKS_CORE.PRE_UPDATE_TOKEN, this._onPreUpdateToken.bind(this));\n\n\n    // Roll configuration hooks\n    this._registerHook(HOOKS_DND5E.RENDER_ROLL_CONFIGURATION_DIALOG, this._onRenderRollConfigDialog.bind(this));\n    this._registerHook(HOOKS_DND5E.RENDER_SKILL_TOOL_ROLL_DIALOG, this._onRenderSkillToolDialog.bind(this));\n\n    // Roll hooks (delegated to RollHooksHandler)\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_HIT_DIE_V2, RollHooksHandler.onPreRollHitDieV2.bind(RollHooksHandler));\n    this._registerHook(HOOKS_DND5E.POST_ROLL_CONFIG, RollHooksHandler.onPostRollConfig.bind(RollHooksHandler));\n    this._registerHook(HOOKS_DND5E.ROLL_DAMAGE_V2, RollHooksHandler.onRollDamageV2.bind(RollHooksHandler));\n  }\n\n  /**\n   * Register GM-only hooks\n   */\n  static _registerGMOnlyHooks() {\n    // User connection\n    this._registerHook(HOOKS_CORE.USER_CONNECTED, this._onUserConnected.bind(this));\n\n    // Roll interception (delegated to RollHooksHandler)\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_V2, RollHooksHandler.onPreRollGM.bind(RollHooksHandler));\n\n    // Activity hooks - GM side (delegated to BaseActivityManager)\n    this._registerHook(HOOKS_DND5E.PRE_USE_ACTIVITY, BaseActivityManager.onPreUseActivityGM.bind(BaseActivityManager));\n    this._registerHook(HOOKS_DND5E.POST_USE_ACTIVITY, BaseActivityManager.onPostUseActivityGM.bind(BaseActivityManager));\n\n    // Combat hooks for tracking status changes\n    this._registerHook(HOOKS_CORE.CREATE_COMBATANT, this._onCombatChange.bind(this));\n    this._registerHook(HOOKS_CORE.DELETE_COMBATANT, this._onCombatChange.bind(this));\n    this._registerHook(HOOKS_CORE.UPDATE_COMBAT, this._onCombatChange.bind(this));\n    this._registerHook(HOOKS_CORE.DELETE_COMBAT, this._onCombatChange.bind(this));\n\n    // Combat hooks for automatic movement blocking\n    this._registerHook(HOOKS_CORE.COMBAT_START, this._onCombatStart.bind(this));\n    this._registerHook(HOOKS_CORE.COMBAT_TURN_CHANGE, this._onCombatTurnChange.bind(this));\n    this._registerHook(HOOKS_CORE.DELETE_COMBAT, this._onDeleteCombat.bind(this));\n    this._registerHook(HOOKS_CORE.CREATE_COMBATANT, this._onCreateCombatant.bind(this));\n\n    // ActiveEffect hooks for tracking status effect changes\n    this._registerHook(HOOKS_CORE.CREATE_ACTIVE_EFFECT, this._onActiveEffectChange.bind(this));\n    this._registerHook(HOOKS_CORE.DELETE_ACTIVE_EFFECT, this._onActiveEffectChange.bind(this));\n    this._registerHook(HOOKS_CORE.UPDATE_ACTIVE_EFFECT, this._onActiveEffectChange.bind(this));\n\n    // Updates for roll requests menu refresh\n    this._registerHook(HOOKS_CORE.UPDATE_SETTING, this._onSettingUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.UPDATE_SCENE, this._onSceneUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.UPDATE_ACTOR, this._onActorUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.UPDATE_TOKEN, this._onTokenUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.CREATE_TOKEN, this._onCreateToken.bind(this));\n    this._registerHook(HOOKS_CORE.DELETE_TOKEN, this._onDeleteToken.bind(this));\n    this._registerHook(HOOKS_CORE.CREATE_ACTOR, this._onCreateActor.bind(this));\n    this._registerHook(HOOKS_CORE.DELETE_ACTOR, this._onDeleteActor.bind(this));\n    this._registerHook(HOOKS_CORE.RENDER_CHAT_INPUT, this._onRenderChatInput.bind(this));\n  }\n\n  /**\n   * Register player-only hooks\n   */\n  static _registerPlayerOnlyHooks() {\n    // Player-specific roll hooks (delegated to RollHooksHandler)\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_INITIATIVE_DIALOG, RollHooksHandler.onPreRollInitiativeDialog.bind(RollHooksHandler));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_ATTACK_V2, RollHooksHandler.onPreRollAttackV2.bind(RollHooksHandler));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_DAMAGE_V2, RollHooksHandler.onPreRollDamageV2.bind(RollHooksHandler));\n    Hooks.on(HOOKS_DND5E.PRE_ROLL_ABILITY_CHECK, RollHooksHandler.onPreRollAbilityCheck.bind(RollHooksHandler));\n\n    // Activity hooks - Player side (delegated to BaseActivityManager)\n    this._registerHook(HOOKS_DND5E.PRE_USE_ACTIVITY, BaseActivityManager.onPreUseActivityPlayer.bind(BaseActivityManager));\n    this._registerHook(HOOKS_DND5E.POST_USE_ACTIVITY, BaseActivityManager.onPostUseActivityPlayer.bind(BaseActivityManager));\n  }\n\n  static _onSidebarUpdate(tab) {\n    LogUtil.log(\"_onSidebarUpdate\", [tab]);\n    updateSidebarClass(isSidebarExpanded());\n  }\n  \n  /**\n   * Handle chat input rendering to sync hotbar offset class with menu\n   */\n  static _onRenderChatInput() {\n    LogUtil.log(\"_onRenderChatInput - syncing offset and faded-ui classes\");\n    // Find the menu element directly since we can't access the private instance\n    const menuElement = document.querySelector('#flash-rolls-menu');\n    if (menuElement && menuElement.classList.contains('docked-bottom')) {\n      // Use setTimeout to ensure hotbar class changes have been applied\n      setTimeout(async () => {\n        // Create a minimal menu-like object with the element\n        const menuProxy = { element: menuElement };\n        RollMenuDragManager.syncOffsetClass(menuProxy);\n        RollMenuDragManager.syncFadedUIClass(menuProxy);\n      }, 50);\n    }\n  }\n  \n\n  \n  /**\n   * Triggered whenever roll configuration dialog is rendered. \n   * Used to add custom situational bonus from data, since the default DnD5e dialog does not seem to handle that\n   */\n  static _onRenderRollConfigDialog(app, html, data) {\n    LogUtil.log(\"_onRenderRollConfigDialog #0\", [ app, data ]);\n    if (app._flashRollsApplied) return;\n    \n    // const isDamageRoll = app instanceof dnd5e.applications.dice.DamageRollConfigurationDialog;\n    // LogUtil.log(\"_onRenderRollConfigDialog - isDamageRoll?\", [isDamageRoll, app.constructor.name]);\n    \n    const isInitiativeRoll = app.config?.hookNames?.includes('initiativeDialog') || \n                           app.element?.id?.includes('initiative');\n    \n    if (isInitiativeRoll) {\n      const actor = app.config?.subject;\n      if (!actor) return;\n      \n      if (!app._flashRollsTitleApplied) {\n        html.querySelector('.window-title').textContent = game.i18n.localize(\"DND5E.Initiative\");\n        html.querySelector('.window-subtitle').textContent = actor.name;\n        app._flashRollsTitleApplied = true;\n      }\n      \n      const storedConfig = actor.getFlag(MODULE_ID, 'tempInitiativeConfig');      \n      if (storedConfig) {\n        app._flashRollsApplied = true;\n        const situationalInput = html.querySelector('input[name*=\"situational\"]');\n        setTimeout(() => {\n          situationalInput.dispatchEvent(new Event('change', {\n            bubbles: true,\n            cancelable: false\n          }));\n        }, 50);\n      }\n      \n      return;\n    }else{\n      const situationalInputs = html.querySelectorAll('input[name*=\"situational\"]');\n      \n      situationalInputs.forEach((input, index) => { \n        LogUtil.log(\"_onRenderRollConfigDialog - processing input\", [index, input.name, input.value]);\n        if (!input.value && app.config?.rolls?.[0]?.data?.situational) {\n          input.value = app.config.rolls[0].data.situational;\n        }\n        \n        app.config.scaling = true;\n        if (input.value) {\n          app._flashRollsApplied = true;\n\n          if (app.config?.rolls?.[0]?.data) {\n            delete app.config.rolls[0].data.situational;\n          }\n          \n          setTimeout(() => {\n\n            input.dispatchEvent(new Event('change', {\n              bubbles: true,\n              cancelable: false\n            }));\n          }, 150);\n        }\n      });\n    }\n    \n  }\n\n  /**\n   * Customize the Roll Resolver dialog title\n   * @param {RollResolver} app - The roll resolver application\n   * @param {jQuery} html - The rendered HTML\n   */\n  static _onRenderRollResolver(app, html) {\n    try {\n      const roll = app.roll;\n      if (!roll) return;\n\n      LogUtil.log('_onRenderRollResolver - roll options:', [roll.options]);\n\n      const messageData = roll.options?.messageData;\n      if (!messageData?.flags?.[MODULE_ID]) {\n        LogUtil.log('_onRenderRollResolver - no metadata found in messageData');\n        return;\n      }\n\n      const { rollType, rollKey } = messageData.flags[MODULE_ID];\n      if (!rollType) {\n        LogUtil.log('_onRenderRollResolver - no rollType found');\n        return;\n      }\n\n      LogUtil.log('_onRenderRollResolver - found metadata', [rollType, rollKey]);\n\n      const title = html[0].querySelector('.window-title');\n      if (!title) {\n        LogUtil.log('_onRenderRollResolver - no title element found');\n        return;\n      }\n\n      let rollTypeDisplay;\n      switch (rollType.toLowerCase()) {\n        case 'ability':\n        case 'abilitycheck':\n          rollTypeDisplay = `${game.i18n.localize(CONFIG.DND5E.abilities[rollKey]?.label || rollKey)} ${game.i18n.localize(\"DND5E.AbilityCheck\")}`;\n          break;\n        case 'save':\n        case 'savingthrow':\n          rollTypeDisplay = `${game.i18n.localize(CONFIG.DND5E.abilities[rollKey]?.label || rollKey)} ${game.i18n.localize(\"DND5E.SavingThrow\")}`;\n          break;\n        case 'skill':\n          rollTypeDisplay = game.i18n.localize(CONFIG.DND5E.skills[rollKey]?.label || rollKey);\n          break;\n        case 'tool':\n          rollTypeDisplay = game.i18n.localize(CONFIG.DND5E.tools?.[rollKey]?.label || rollKey);\n          break;\n        case 'initiative':\n        case 'initiativedialog':\n          rollTypeDisplay = game.i18n.localize(\"DND5E.Initiative\");\n          break;\n        case 'deathsave':\n          rollTypeDisplay = game.i18n.localize(\"DND5E.DeathSave\");\n          break;\n        case 'hitdie':\n          rollTypeDisplay = `${game.i18n.localize(\"DND5E.HitDie\")} (${rollKey})`;\n          break;\n        default:\n          return;\n      }\n\n      title.textContent = rollTypeDisplay;\n    } catch (error) {\n      LogUtil.error('Error customizing Roll Resolver title:', [error]);\n    }\n  }\n\n  /**\n   * Intercept group roll message creation (GM only) - currently unused\n   */\n  static _onPreCreateChatMessageGM(message, data, options, userId) {\n    LogUtil.log(\"_onPreCreateChatMessageGM\", [message, data, options, userId]);\n  }\n\n  /**\n   * Add \"Select Targeted\" button to damage roll messages with saves\n   * @param {ChatMessage} message - The chat message\n   * @param {jQuery} html - The rendered HTML\n   */\n  static _addSelectTargetsButton(message, html) {\n    if(!game.user.isGM) return;\n    LogUtil.log(\"_addSelectTargetsButton #0\", [message, html, html.querySelector('.message-content')]);\n    if (message.flags?.dnd5e?.roll?.type !== 'damage' || html.querySelector('.select-targeted')) return;\n    \n    const button = document.createElement('button');\n    button.className = 'select-targeted';\n    button.type = 'button';\n    button.setAttribute(\"data-tooltip-direction\", \"LEFT\");\n    button.setAttribute(\"data-tooltip\", \"Select Targeted\");\n    button.innerHTML = '<i class=\"fas fa-crosshairs\"></i>';\n    \n    button.addEventListener('click', (event) => {\n      event.preventDefault();\n      this._selectTargetedTokens(event);\n    });\n    \n    html.querySelector('.message-content').appendChild(button);\n    message.update({\n      content: html\n    });\n  }\n  \n  /**\n   * Select all currently targeted tokens as damage targets\n   * @param {ChatMessage} message - The chat message\n   */\n  static _selectTargetedTokens(event) {\n    const message = event.currentTarget.closest('.chat-message');\n    const targets = message.querySelectorAll(\"[data-target-uuid]\");\n    \n    if (targets.length === 0) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noTargetedTokens\"));\n      return;\n    }\n\n    for ( let i=0; i < targets.length; i++ ) {\n      const target = targets[i];\n      const actorId = target.dataset.targetUuid.split('Actor.')[1];\n      const tokens = canvas.tokens.placeables.filter(t => {\n        return t.document.actor?.id === actorId || t.document.baseActor?.id === actorId;\n      });\n      tokens.forEach((token, jQuerj) => {\n        if(token && token.control){\n          token.control({ releaseOthers: i===0 });\n        }\n      });\n    }\n  }\n  \n  /**\n   * Request dice configuration from the connected user\n   */\n  static _onUserConnected(user) {\n    if (user.active && user.id !== game.user.id) {\n      setTimeout(() => {\n        if (user.active) {\n          DiceConfigUtil.requestDiceConfigFromUser(user.id);\n        }\n      }, 500);\n    }\n  }\n\n  /**\n   * Register Tidy5e Sheets hooks once the module is ready\n   */\n  static _registerTidy5eHooks() {\n    Hooks.once(HOOKS_TIDY5E.READY, () => {\n      LogUtil.log('Tidy5e Sheets ready - registering hooks');\n      Hooks.on(HOOKS_TIDY5E.PRE_PROMPT_GROUP_SKILL_ROLL, this._onTidy5eGroupSkillRoll.bind(this));\n      Hooks.on(HOOKS_TIDY5E.RENDER_ACTOR_SHEET, GroupTokenTracker.onRenderActorSheet.bind(GroupTokenTracker));\n      Hooks.on(HOOKS_TIDY5E.RENDER_GROUP_SHEET_QUADRONE, GroupTokenTracker.onRenderActorSheet.bind(GroupTokenTracker));\n      Hooks.on(HOOKS_TIDY5E.RENDER_GROUP_SHEET_CLASSIC, GroupTokenTracker.onRenderActorSheet.bind(GroupTokenTracker));\n      Hooks.on(HOOKS_TIDY5E.RENDER_ENCOUNTER_SHEET_QUADRONE, GroupTokenTracker.onRenderActorSheet.bind(GroupTokenTracker));\n      Hooks.on(HOOKS_TIDY5E.RENDER_ENCOUNTER_SHEET_CLASSIC, GroupTokenTracker.onRenderActorSheet.bind(GroupTokenTracker));\n    });\n  }\n\n  /**\n   * Handle Tidy5e group skill roll prompt\n   * @param {Application} app - The sheet application instance\n   * @param {Object} options - Roll configuration options\n   * @param {string} options.skill - The skill key (e.g., 'acr' for Acrobatics)\n   * @param {string} options.ability - The ability key (e.g., 'dex' for Dexterity)\n   * @param {Event} options.event - The triggering event\n   * @returns {boolean} False to prevent the default prompt, true to allow it\n   */\n  static _onTidy5eGroupSkillRoll(app, options) {\n    LogUtil.log('HooksManager._onTidy5eGroupSkillRoll', [app, options]);\n\n    if (!game.user.isGM) return true;\n\n    const SETTINGS = getSettings();\n    const interceptEnabled = SettingsUtil.get(SETTINGS.interceptTidySheetsGroupRolls.tag);\n\n    if (!interceptEnabled) {\n      LogUtil.log('Tidy5e group roll interception disabled', []);\n      return true;\n    }\n\n    const { skill, ability, event } = options;\n\n    if (!app?.actor?.system?.members) {\n      LogUtil.warn('Tidy5e group roll: No members found', [app]);\n      return true;\n    }\n\n    const members = app.actor.system.members;\n    const actorIds = members.map(m => m.actor.id).filter(id => id);\n\n    if (actorIds.length === 0) {\n      LogUtil.warn('Tidy5e group roll: No valid actor IDs', [members]);\n      return true;\n    }\n\n    const skipRollDialog = RollHelpers.shouldSkipRollDialog({isPC: true, sendRequest: true});\n    const groupRollId = foundry.utils.randomID();\n\n    FlashAPI.requestRoll({\n      requestType: 'skill',\n      rollKey: skill,\n      actorIds,\n      ability,\n      skipRollDialog,\n      groupRollId,\n      sendAsRequest: true\n    });\n\n    return false;\n  }\n\n  /**\n   * Handle token creation events to refresh roll requests menu\n   * @param {TokenDocument} tokenDoc - The token document\n   * @param {Object} options - Creation options\n   * @param {string} userId - The user ID who performed the action\n   */\n  static _onCreateToken(tokenDoc, options, userId) {\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Handle token pre-update events to intercept movement restrictions\n   * @param {TokenDocument} tokenDoc - The token document\n   * @param {Object} updateData - The update data\n   * @param {Object} options - Update options\n   * @param {string} userId - The user ID who performed the action\n   * @returns {boolean|void} False to prevent the update, otherwise allow\n   */\n  static _onPreUpdateToken(tokenDoc, updateData, options, userId) {\n    LogUtil.log('HooksManager._onPreUpdateToken called', {\n      tokenDoc,\n      updateData,\n      options,\n      userId,\n      userIsGM: game.users.get(userId)?.isGM\n    });\n\n    const user = game.users.get(userId);\n    if (!user) return;\n\n    const isMovementAllowed = TokenMovementManager.isMovementAllowed(tokenDoc, user, updateData);\n    LogUtil.log('Movement check result:', { isMovementAllowed, user: user.name, token: tokenDoc.name });\n\n    if (!isMovementAllowed) {\n      FlashAPI.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.movementRestricted\"));\n      LogUtil.log('Movement blocked for token:', tokenDoc.name);\n      return false;\n    }\n  }\n\n  /**\n   * Handle token deletion events to refresh roll requests menu and clean up group associations\n   * @param {TokenDocument} tokenDoc - The token document\n   * @param {Object} options - Deletion options\n   * @param {string} userId - The user ID who performed the action\n   */\n  static _onDeleteToken(tokenDoc, options, userId) {\n    GroupTokenTracker.onDeleteToken(tokenDoc, options, userId);\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Handle actor creation events to refresh roll requests menu\n   * @param {Actor} actor - The actor document\n   * @param {Object} options - Creation options\n   * @param {string} userId - The user ID who performed the action\n   */\n  static _onCreateActor(actor, options, userId) {\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Handle actor deletion events to refresh roll requests menu\n   * @param {Actor} actor - The actor document\n   * @param {Object} options - Deletion options\n   * @param {string} userId - The user ID who performed the action\n   */\n  static _onDeleteActor(actor, options, userId) {\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  static _onSettingUpdate(setting, value, options, userId) {\n    const SETTINGS = getSettings();\n    const MODULE = { ID: 'flash-rolls-5e' };\n\n    if (setting.key === `${MODULE.ID}.${SETTINGS.showOnlyPCsWithToken.tag}` ||\n        setting.key === `${MODULE.ID}.${SETTINGS.compactMode.tag}` ||\n        setting.key === `${MODULE.ID}.${SETTINGS.menuLayout.tag}`) {\n\n      LogUtil.log('HooksManager._onSettingUpdate - Re-rendering roll requests menu due to setting change', [setting.key]);\n      RollRequestsMenu.refreshIfOpen();\n    }else if(setting.key === `core.uiConfig`){\n      SettingsUtil.updateColorScheme();\n      RollRequestsMenu.refreshIfOpen();\n      GeneralUtil.confirmReload(\n        game.i18n.localize(\"FLASH_ROLLS.ui.reloadRequiredTitle\"),\n        game.i18n.localize(\"FLASH_ROLLS.ui.uiConfigReloadLabel\")\n      );\n    }\n  }\n\n  static _onSceneUpdate(scene, changes, options, userId) {\n    if (changes.active === true) {\n      LogUtil.log('HooksManager._onSceneUpdate - Re-rendering roll requests menu due to active scene change');\n      RollRequestsMenu.refreshIfOpen();\n    }\n  }\n\n  /**\n   * Handle canvas ready event when scene viewing changes\n   * @param {Canvas} canvas - The canvas instance\n   */\n  static _onCanvasReady(canvas) {\n    LogUtil.log('HooksManager._onCanvasReady - Re-rendering roll requests menu due to scene view change');\n    RollRequestsMenu.refreshIfOpen();\n\n    const isTeleporting = TokenTeleportManager.isTeleporting();\n    LogUtil.log(\"HooksManager._onCanvasReady - Checking for teleport\", { isTeleporting });\n\n    if (isTeleporting) {\n      LogUtil.log(\"HooksManager._onCanvasReady - Calling TokenTeleportManager._onSceneChange\");\n      TokenTeleportManager._onSceneChange();\n    }\n  }\n\n  static _onActorUpdate(actor, changes, options, userId) {\n    LogUtil.log(\"HooksManager._onActorUpdate\", [actor, changes]);\n    LogUtil.log(\"HooksManager._onActorUpdate - changes.effects:\", [changes.effects]);\n\n    const ownershipChanged = changes['==ownership'] !== undefined;\n    const statsChanged = changes.system?.attributes?.hp ||\n                        changes.system?.attributes?.ac ||\n                        changes.system?.attributes?.spell?.dc ||\n                        changes.system?.skills?.prc ||\n                        changes.system?.abilities ||\n                        changes.system?.attributes?.prof;\n\n    // Check for effects changes (including death status)\n    const effectsChanged = changes.effects !== undefined;\n\n    LogUtil.log(\"HooksManager._onActorUpdate - triggers:\", [\n      'statsChanged:', statsChanged,\n      'ownershipChanged:', ownershipChanged,\n      'effectsChanged:', effectsChanged\n    ]);\n\n    if (!statsChanged && !ownershipChanged && !effectsChanged) return;\n\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Handle token updates that affect filtering (visibility, status effects)\n   * @param {TokenDocument} tokenDoc - Token document that was updated\n   * @param {object} changes - Changed data\n   * @param {object} options - Update options\n   * @param {string} userId - User ID who made the change\n   */\n  static _onTokenUpdate(tokenDoc, changes, options, userId) {\n    LogUtil.log(\"HooksManager._onTokenUpdate\", [tokenDoc, changes]);\n\n    const visibilityChanged = changes.hidden !== undefined;\n\n    if (!visibilityChanged) return;\n\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Handle combat-related changes (for combat status)\n   * @param {...any} args - Hook arguments\n   */\n  static _onCombatChange(...args) {\n    LogUtil.log(\"HooksManager._onCombatChange\", args);\n    LogUtil.log(\"HooksManager._onCombatChange - Re-rendering roll requests menu due to combat status change\");\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Handle ActiveEffect changes (for status effects like death)\n   * @param {ActiveEffect} effect - The active effect\n   * @param {Object} changes - Changes object (for updates)\n   * @param {Object} options - Update options\n   * @param {string} userId - ID of updating user\n   */\n  static _onActiveEffectChange(effect, changes, options, userId) {\n    LogUtil.log(\"HooksManager._onActiveEffectChange\", [effect, changes, options, userId]);\n\n    // Only refresh if the effect is on an actor (not an item or other document)\n    if (!effect.parent || effect.parent.documentName !== 'Actor') {\n      LogUtil.log(\"HooksManager._onActiveEffectChange - Effect not on actor, skipping\");\n      return;\n    }\n\n    LogUtil.log(\"HooksManager._onActiveEffectChange - Re-rendering roll requests menu due to status effect change\");\n    LogUtil.log(\"HooksManager._onActiveEffectChange - Effect statuses:\", effect.statuses);\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Handle render ApplicationV2\n   */\n  static _onRenderApplicationV2(app, html, options) {\n    LogUtil.log(\"_onRenderApplicationV2\", [app, html, options]);\n  }\n\n  /**\n   * Handle render Sidebar\n   */\n  static _onRenderSidebar(app, html, options) {\n    LogUtil.log(\"_onRenderSidebar\", [app, html]);\n    if(game.ready){\n      SidebarController.addSidebarControls(app, html);\n    }\n  }\n  \n  /**\n   * Register a hook and track it\n   * @param {string} hookName - The hook name\n   * @param {Function} handler - The handler function\n   * @private\n   */\n  static _registerHook(hookName, handler) {\n    const hookId = Hooks.on(hookName, handler);\n    this.registeredHooks.set(`${hookName}_${hookId}`, hookId);\n    return hookId;\n  }\n  \n  /**\n   * Unregister all hooks (for cleanup)\n   */\n  static unregisterAll() {\n    this.registeredHooks.forEach((hookId, key) => {\n      const hookName = key.split('_')[0];\n      Hooks.off(hookName, hookId);\n    });\n    this.registeredHooks.clear();\n  }\n  \n  /**\n   * Check if a hook is registered\n   * @param {string} hookName - The hook name to check\n   * @returns {boolean}\n   */\n  static isRegistered(hookName) {\n    for (const key of this.registeredHooks.keys()) {\n      if (key.startsWith(`${hookName}_`)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Handle rendering of skill/tool configuration dialog to fix message flavor\n   */\n  static _onRenderSkillToolDialog(app, html, data) {\n    LogUtil.log(\"_onRenderSkillToolDialog triggered\", [app]);\n    if (app._abilityFlavorFixed) return;\n    \n    const abilitySelect = html.querySelector('select[name=\"ability\"]');\n    if (!abilitySelect) return;\n    \n    if (app.config?.isRollRequest && app.config?.ability) {\n      const selectedAbility = abilitySelect.value;\n      const configAbility = app.config.ability;\n\n      if (selectedAbility === configAbility) {\n        app._abilityFlavorFixed = true;\n        \n        setTimeout(() => {\n          const changeEvent = new Event('change', {\n            bubbles: true,\n            cancelable: true\n          });\n          abilitySelect.dispatchEvent(changeEvent);\n        }, 50);\n      }\n    }\n  }\n\n  /**\n   * TEMPLATES\n   */\n  static onRefreshTemplate(template, options) {\n    if(!template.isOwner){ return; }\n    const throttleKey = `refresh-template-${template.id}`;\n    const SETTINGS = getSettings();\n    const targettingSetting = SettingsUtil.get(SETTINGS.templateAutoTarget.tag);\n    \n    if (HooksManager.throttleTimers[throttleKey]) {\n      clearTimeout(HooksManager.throttleTimers[throttleKey]);\n    }\n\n    HooksManager.throttleTimers[throttleKey] = setTimeout(() => {\n      let maxDisposition = 3;\n\n      switch(targettingSetting){\n        case 1:\n          maxDisposition = 3; break;\n        case 2: \n          maxDisposition = 0; break;\n        default: \n          return;\n      }\n\n      game.user.targets.forEach(t => t.setTarget(false, { releaseOthers: false }));\n      \n      const tokensToTarget = [];\n      for(let token of canvas.tokens.placeables){\n        if(token.document.disposition <= maxDisposition && template.shape.contains(token.center.x-template.x,token.center.y-template.y)){\n          tokensToTarget.push(token);\n        }\n      }\n      \n      tokensToTarget.forEach((token, i) => {\n        token.setTarget(true, { \n          releaseOthers: i === 0,  // Only release others on first token\n          groupSelection: true \n        });\n      });\n      \n      if (tokensToTarget.length > 0) {\n        game.user.broadcastActivity({ targets: game.user.targets.ids });\n      }\n      \n      delete HooksManager.throttleTimers[throttleKey];\n    }, 50);\n  }\n\n  /**\n   * Handle client setting changes (including core.uiConfig)\n   * @param {string} key - The setting key that changed\n   * @param {*} value - The new value\n   * @param {Object} options - Additional options\n   */\n  static _onClientSettingChanged(key, value, options) {\n    LogUtil.log('HooksManager._onClientSettingChanged', [key, value, options]);\n    \n    // Check if the UI config changed (includes color scheme)\n    if (key === \"core.uiConfig\") {\n      this._updateMenuColorScheme();\n    }\n  }\n\n  /**\n   * Handle browser color scheme changes\n   */\n  static _onBrowserColorSchemeChanged() {\n    LogUtil.log('HooksManager._onBrowserColorSchemeChanged - Browser color scheme changed');\n    \n    // Only update if we're using browser default (interface theme is undefined)\n    const foundryUiConfig = game.settings.get('core','uiConfig');\n    if (!foundryUiConfig?.colorScheme?.interface) {\n      this._updateMenuColorScheme();\n    }\n  }\n\n  /**\n   * Update the menu's color scheme classes\n   */\n  static _updateMenuColorScheme() {\n    const oldColorScheme = SettingsUtil.coreColorScheme;\n    SettingsUtil.updateColorScheme();\n    const newColorScheme = SettingsUtil.coreColorScheme;\n\n    // Update the menu if it's open and color scheme changed\n    const menuInstance = RollRequestsMenu.getInstance();\n    if (menuInstance?.rendered && menuInstance.classList) {\n      // Remove old theme class\n      if (oldColorScheme) {\n        menuInstance.classList.remove(`theme-${oldColorScheme}`);\n      }\n      // Add new theme class\n      if (newColorScheme) {\n        menuInstance.classList.add(`theme-${newColorScheme}`);\n      }\n    }\n  }\n\n  /**\n   * Handle combat start for automatic movement blocking\n   * @param {Combat} combat - The combat instance\n   * @param {object} updateData - Update data\n   */\n  static _onCombatStart(combat, updateData) {\n    TokenMovementManager.onCombatStart(combat, updateData);\n  }\n\n  /**\n   * Handle combat turn change for movement control\n   * @param {Combat} combat - The combat instance\n   * @param {object} prior - The prior turn state\n   * @param {object} current - The current turn state\n   */\n  static _onCombatTurnChange(combat, prior, current) {\n    TokenMovementManager.onCombatTurnChange(combat, prior, current);\n  }\n\n  /**\n   * Handle combat deletion for movement cleanup\n   * @param {Combat} combat - The combat instance\n   */\n  static _onDeleteCombat(combat) {\n    TokenMovementManager.onCombatEnd(combat);\n  }\n\n  /**\n   * Handle combatant creation for movement control\n   * @param {Combatant} combatant - The combatant document\n   * @param {object} options - Creation options\n   * @param {string} userId - The user ID who created the combatant\n   */\n  static _onCreateCombatant(combatant, options, userId) {\n    TokenMovementManager.onCreateCombatant(combatant, options, userId);\n  }\n}","import { getSettings } from \"../../constants/Settings.mjs\";\nimport { SOCKET_CALLS } from \"../../constants/General.mjs\";\nimport { SocketUtil } from \"../utils/SocketUtil.mjs\";\nimport { DiceConfigUtil } from \"../utils/DiceConfigUtil.mjs\";\nimport { HooksManager } from \"./HooksManager.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { RollRequestManager } from \"../managers/RollRequestManager.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { HOOKS_CORE } from \"../../constants/Hooks.mjs\";\nimport { ActorDirectoryIconUtil } from \"../utils/ActorDirectoryIconUtil.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\nimport { GroupTokenTracker } from \"../managers/GroupTokenTracker.mjs\";\n\n/**\n * @typedef {import(\"./RollRequestManager.mjs\").RollRequestData} RollRequestData\n */\n\n/**\n * Main class handling core module initialization and setup\n * Manages module lifecycle, hooks, and core functionality\n */\nexport class Main {\n  /**\n   * Initialize the module and set up core hooks\n   * @static\n   */\n  static init(){\n    SocketUtil.initialize(Main.registerSocketCalls);\n    HooksManager.initialize();\n  }\n\n  // Wrapper methods for socket calls to DiceConfigUtil\n  static getDiceConfig() {\n    return DiceConfigUtil.getDiceConfig();\n  }\n  \n  static receiveDiceConfig(userId, diceConfig) {\n    DiceConfigUtil.receiveDiceConfig(userId, diceConfig);\n  }\n\n  /**\n   * Handle roll request from GM on player side\n   * @param {RollRequestData} requestData - The roll request data\n   */\n  static async handleRollRequest(requestData) {\n    LogUtil.log('Main.handleRollRequest', requestData);\n    return RollRequestManager.handleRequest(requestData);\n  }\n\n  /**\n   * Register methods with socketlib for remote execution\n   */\n  static registerSocketCalls() {\n    SocketUtil.registerCall(SOCKET_CALLS.getDiceConfig, Main.getDiceConfig);\n    SocketUtil.registerCall(SOCKET_CALLS.receiveDiceConfig, Main.receiveDiceConfig);\n    SocketUtil.registerCall(SOCKET_CALLS.handleRollRequest, Main.handleRollRequest);\n    SocketUtil.registerCall(SOCKET_CALLS.removeTemplate, GeneralUtil.removeTemplate);\n    SocketUtil.registerCall(SOCKET_CALLS.broadcastRollComplete, Main.handleBroadcastRollComplete);\n    SocketUtil.registerCall(SOCKET_CALLS.deleteChatMessage, Main.handleDeleteChatMessage);\n  }\n\n  /**\n   * Handle chat message deletion request from player side\n   * Only GM should delete messages to avoid permission issues with midi-qol template cleanup\n   * @param {string} messageId - The ID of the chat message to delete\n   */\n  static async handleDeleteChatMessage(messageId) {\n    if (!game.user.isGM) return;\n    const message = game.messages.get(messageId);\n    if (message) {\n      await message.delete().catch(err => {\n        LogUtil.error('Main.handleDeleteChatMessage - Failed to delete message', [err]);\n      });\n    }\n  }\n\n  /**\n   * Handle broadcast roll complete - fires the hook locally on each client\n   * This is called via socket on all clients when a roll completes\n   * @param {Object} hookData - Serialized hook data\n   */\n  static handleBroadcastRollComplete(hookData) {\n    LogUtil.log('Main.handleBroadcastRollComplete', [hookData]);\n    if (hookData.roll && !(hookData.roll instanceof Roll)) {\n      hookData.roll = Roll.fromJSON(JSON.stringify(hookData.roll));\n    }\n    Hooks.callAll(\"flash-rolls-5e.rollComplete\", hookData);\n  }\n}\n","import \"./styles/vars.css\";\nimport \"./styles/main.css\";\nimport \"./styles/chat-messages.css\";\n\nimport \"./lib/libwrapper-shim.js\";\nimport { Main } from \"./components/core/Main.mjs\";\n\n// Initialize the module\nMain.init();\n","import { MODULE_ID } from \"../../../constants/General.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../../utils/SettingsUtil.mjs\";\nimport { getSettings } from \"../../../constants/Settings.mjs\";\nimport { RollHelpers } from \"../../helpers/RollHelpers.mjs\";\nimport { ChatMessageManager } from \"../../managers/ChatMessageManager.mjs\";\nimport { GeneralUtil } from \"../../utils/GeneralUtil.mjs\";\nimport { FlashAPI } from \"../../core/FlashAPI.mjs\";\n\n/**\n * Contested Roll Dialog for requesting different roll types from selected actors\n */\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\nexport class ContestedRollDialog extends HandlebarsApplicationMixin(ApplicationV2) {\n  constructor(options = {}) {\n    super(options);\n    this.actors = options.actors || [];\n    this.rollSelections = new Map();\n    this.rollMode = \"publicroll\";\n    this.flavor = \"\";\n    this.hideNpcNames = false;\n  }\n\n  /**\n   * Default application configuration\n   */\n  static DEFAULT_OPTIONS = {\n    id: \"flash5e-contested-roll-dialog\",\n    classes: [\"flash5e-dialog\", \"flash5e-contested-roll-dialog\"],\n    tag: \"div\",\n    window: {\n      title: \"FLASH_ROLLS.ui.dialogs.contestedRoll.title\",\n      icon: \"fas fa-swords\",\n      resizable: false,\n      positioned: true,\n      frame: true\n    },\n    position: {\n      width: 540,\n      height: \"auto\"\n    },\n    actions: {\n      request: ContestedRollDialog.prototype._onRequest,\n      \"show-code\": ContestedRollDialog.prototype._onShowCode\n    }\n  };\n\n  /**\n   * Define template parts\n   */\n  static PARTS = {\n    main: {\n      template: `modules/${MODULE_ID}/templates/contested-roll-dialog.hbs`\n    }\n  };\n\n  /**\n   * Prepare application rendering context\n   */\n  async _prepareContext(options = {}) {\n    const context = await super._prepareContext(options);\n\n    const abilities = {};\n    for (const [key, config] of Object.entries(CONFIG.DND5E.abilities)) {\n      abilities[key] = {\n        label: game.i18n.localize(config.label),\n        abbreviation: game.i18n.localize(config.abbreviation)\n      };\n    }\n\n    const skills = {};\n    for (const [key, config] of Object.entries(CONFIG.DND5E.skills)) {\n      skills[key] = {\n        label: game.i18n.localize(config.label)\n      };\n    }\n\n    return {\n      ...context,\n      actors: this.actors.map(a => {\n        const actor = a.actor || a;\n        return {\n          id: actor.id,\n          name: actor.name,\n          img: actor.img\n        };\n      }),\n      abilities,\n      skills,\n      rollMode: this.rollMode,\n      flavor: this.flavor,\n      hideNpcNames: this.hideNpcNames\n    };\n  }\n\n  /**\n   * Attach event listeners\n   */\n  _attachPartListeners(partId, htmlElement, options) {\n    super._attachPartListeners(partId, htmlElement, options);\n\n    const rollModeSelect = htmlElement.querySelector('.roll-mode-select');\n    if (rollModeSelect) {\n      rollModeSelect.addEventListener('change', (event) => {\n        this.rollMode = event.target.value;\n      });\n    }\n\n    const flavorInput = htmlElement.querySelector('input[name=\"flavor\"]');\n    if (flavorInput) {\n      flavorInput.addEventListener('input', (event) => {\n        this.flavor = event.target.value;\n      });\n    }\n\n    const hideNpcCheckbox = htmlElement.querySelector('input[name=\"hideNpcNames\"]');\n    if (hideNpcCheckbox) {\n      hideNpcCheckbox.addEventListener('change', (event) => {\n        this.hideNpcNames = event.target.checked;\n      });\n    }\n\n    const actorRollSelects = htmlElement.querySelectorAll('.actor-roll-type');\n    actorRollSelects.forEach(select => {\n      const actorId = select.dataset.actorId;\n      if (select.value) {\n        this.rollSelections.set(actorId, select.value);\n      }\n\n      select.addEventListener('change', (event) => {\n        const actorId = event.target.dataset.actorId;\n        this.rollSelections.set(actorId, event.target.value);\n      });\n    });\n  }\n\n  /**\n   * Handle request button click\n   */\n  async _onRequest(event, target) {\n    if (this.actors.length === 0) {\n      FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n      return;\n    }\n\n    for (const actorEntry of this.actors) {\n      const actor = actorEntry.actor || actorEntry;\n      const selection = this.rollSelections.get(actor.id);\n      if (!selection) {\n        FlashAPI.notify('warn',game.i18n.format(\"FLASH_ROLLS.notifications.noRollSelected\", { name: actor.name }));\n        return;\n      }\n    }\n\n    const result = {\n      actors: this.actors.map(actorEntry => {\n        const actor = actorEntry.actor || actorEntry;\n        return {\n          actor: actor,\n          uniqueId: actorEntry.uniqueId || actor.id,\n          tokenId: actorEntry.tokenId || null,\n          rollType: this.rollSelections.get(actor.id)\n        };\n      }),\n      rollMode: this.rollMode,\n      flavor: this.flavor,\n      hideNpcNames: this.hideNpcNames\n    };\n\n    await this._executeContestedRolls(result);\n    this.close();\n  }\n\n  /**\n   * Execute contested rolls for all actors\n   */\n  async _executeContestedRolls(config) {\n    LogUtil.log('_executeContestedRolls', [config]);\n\n    const SETTINGS = getSettings();\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    const groupRollId = groupRollsMsgEnabled ? foundry.utils.randomID() : null;\n    LogUtil.log('ContestedRoll - groupRollId', [groupRollId]);\n\n    const contestedConfig = { ...config, isContestedRoll: true };\n\n    if (groupRollId) {\n      const actorEntries = config.actors.map(actorConfig => {\n        const actor = actorConfig.actor;\n        const uniqueId = actorConfig.uniqueId || actor.id;\n        const tokenId = actorConfig.tokenId || null;\n        const [type, key] = actorConfig.rollType.split(':');\n        const rollType = type;\n\n        return {\n          actor: actor,\n          uniqueId: uniqueId,\n          tokenId: tokenId,\n          rollType: rollType,\n          rollKey: key\n        };\n      });\n\n      const firstRollType = config.actors[0].rollType.split(':');\n      const rollType = firstRollType[0];\n      const rollKey = firstRollType[1];\n\n      await ChatMessageManager.createGroupRollMessage(\n        actorEntries,\n        rollType,\n        rollKey,\n        contestedConfig,\n        groupRollId\n      );\n    }\n\n    for (const actorConfig of config.actors) {\n      await this._executeRollForActor(actorConfig, contestedConfig, groupRollId);\n    }\n  }\n\n  /**\n   * Execute a single roll for an actor\n   */\n  async _executeRollForActor(actorConfig, config, groupRollId = null) {\n    const actor = actorConfig.actor;\n    const tokenId = actorConfig.tokenId;\n    const [type, key] = actorConfig.rollType.split(':');\n\n    LogUtil.log('_executeRollForActor', [actor.name, type, key, 'tokenId:', tokenId, 'groupRollId:', groupRollId]);\n\n    const SETTINGS = getSettings();\n    const isPlayerOwned = RollHelpers.isPlayerOwned(actor);\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const skipRollDialog = RollHelpers.shouldSkipRollDialog({\n      isPC: isPlayerOwned,\n      isNPC: !isPlayerOwned,\n      sendRequest: isPlayerOwned && rollRequestsEnabled\n    });\n\n    try {\n      if (type === 'dice') {\n        const roll = await new Roll(key, actor.getRollData()).evaluate();\n\n        const speakerData = { actor };\n        if (tokenId) {\n          const token = canvas.tokens?.get(tokenId) || game.scenes.active?.tokens?.get(tokenId);\n          if (token) {\n            speakerData.token = token;\n          }\n        }\n        const speaker = ChatMessage.implementation.getSpeaker(speakerData);\n\n        const flavor = config.flavor || game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.contestedRoll.customRoll\");\n\n        const messageData = {\n          speaker,\n          flavor\n        };\n\n        if (config.rollMode) {\n          messageData.rollMode = config.rollMode;\n        }\n\n        if (groupRollId) {\n          messageData.flags = {\n            \"flash-rolls-5e\": {\n              groupRollId: groupRollId,\n              isContestedRoll: true\n            }\n          };\n        }\n\n        await roll.toMessage(messageData);\n      } else {\n        const requestType = type === 'ability' ? 'abilitycheck' : type;\n        const uniqueId = tokenId || actor.id;\n\n        await FlashAPI.requestRoll({\n          requestType: requestType,\n          rollKey: key,\n          actorIds: [uniqueId],\n          sendAsRequest: isPlayerOwned && rollRequestsEnabled,\n          skipRollDialog: skipRollDialog,\n          groupRollId: groupRollId,\n          isContestedRoll: config.isContestedRoll || false\n        });\n      }\n    } catch (error) {\n      LogUtil.error('Error executing roll', [error]);\n      ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.notifications.rollFailed\", { name: actor.name }), [error]);\n    }\n  }\n\n  /**\n   * Handle show code button click to create a macro\n   */\n  async _onShowCode(event, target) {\n    LogUtil.log('ContestedRollDialog _onShowCode', []);\n\n    for (const actorEntry of this.actors) {\n      const actor = actorEntry.actor || actorEntry;\n      const selection = this.rollSelections.get(actor.id);\n      if (!selection) {\n        FlashAPI.notify('warn',game.i18n.format(\"FLASH_ROLLS.notifications.noRollSelected\", { name: actor.name }));\n        return;\n      }\n    }\n\n    const macroCode = this._generateMacroCode();\n    LogUtil.log('Generated macro code:', [macroCode]);\n\n    try {\n      await this._createContestedRollMacro(macroCode);\n      this.close();\n    } catch (error) {\n      LogUtil.error('Failed to create macro:', [error]);\n      ui.notifications.error(`Failed to create macro: ${error.message}`);\n    }\n  }\n\n  /**\n   * Generate macro code for the current configuration\n   */\n  _generateMacroCode() {\n    const firstActor = this.actors[0].actor || this.actors[0];\n    const firstSelection = this.rollSelections.get(firstActor.id);\n    if (!firstSelection) {\n      FlashAPI.notify('warn',\"Please select a roll type for all actors before creating a macro.\");\n      return null;\n    }\n\n    const firstRoll = firstSelection.split(':');\n    const firstType = firstRoll[0] === 'ability' ? 'abilitycheck' : firstRoll[0];\n    const firstKey = firstRoll[1];\n\n    const rollCommands = this.actors.map(actorEntry => {\n      const a = actorEntry.actor || actorEntry;\n      const selection = this.rollSelections.get(a.id);\n      if (!selection) {\n        return null;\n      }\n      const [type, key] = selection.split(':');\n      const requestType = type === 'ability' ? 'abilitycheck' : type;\n\n      if (type === 'dice') {\n        return `  // ${a.name}: Custom Dice Roll\n  const actor${a.id} = game.actors.get(\"${a.id}\");\n  if (actor${a.id}) {\n    const roll = await new Roll(\"${key}\", actor${a.id}.getRollData()).evaluate();\n    await roll.toMessage({\n      speaker: ChatMessage.implementation.getSpeaker({ actor: actor${a.id} }),\n      flavor: \"${this.flavor || 'Custom Roll'}\",\n      rollMode: \"${this.rollMode}\",\n      flags: {\n        \"flash-rolls-5e\": {\n          groupRollId: groupRollId,\n          isContestedRoll: true\n        }\n      }\n    });\n  }`;\n      } else {\n        return `  // ${a.name}: ${type}:${key}\n  await FlashAPI.requestRoll({\n    requestType: \"${requestType}\",\n    rollKey: \"${key}\",\n    actorIds: [\"${a.id}\"],\n    skipRollDialog: true,\n    groupRollId: groupRollId,\n    isContestedRoll: true\n  });`;\n      }\n    });\n\n    if (rollCommands.includes(null)) {\n      return null;\n    }\n\n    const joinedCommands = rollCommands.join('\\n\\n');\n\n    const actorEntriesCode = this.actors.map(actorEntry => {\n      const a = actorEntry.actor || actorEntry;\n      return `    {\n      actor: game.actors.get(\"${a.id}\"),\n      uniqueId: \"${a.id}\",\n      tokenId: null\n    }`;\n    }).join(',\\n');\n\n    return `// Flash Token Bar: Contested Roll\n// Roll Mode: ${this.rollMode}\n${this.flavor ? `// Flavor: ${this.flavor}` : ''}\n\n(async () => {\n  try {\n    const groupRollId = foundry.utils.randomID();\n\n    const actorEntries = [\n${actorEntriesCode}\n    ];\n\n    await FlashAPI.createGroupRollMessage(\n      actorEntries,\n      \"${firstType}\",\n      \"${firstKey}\",\n      { rollMode: \"${this.rollMode}\", flavor: \"${this.flavor}\", isContestedRoll: true },\n      groupRollId\n    );\n\n${joinedCommands}\n  } catch (error) {\n    ui.notifications.error(\"Failed to execute contested roll: \" + error.message);\n  }\n})();`;\n  }\n\n  /**\n   * Create a macro with the contested roll configuration\n   */\n  async _createContestedRollMacro(command) {\n    const SETTINGS = getSettings();\n    const addMacrosToFolder = SettingsUtil.get(SETTINGS.addMacrosToFolder.tag);\n\n    let folderId = null;\n    if (addMacrosToFolder) {\n      folderId = await this._ensureFlashRollsFolder();\n    }\n\n    const actorNames = this.actors.map(actorEntry => {\n      const a = actorEntry.actor || actorEntry;\n      return a.name;\n    }).join(' vs ');\n    const macroName = `Contested Roll: ${actorNames}`;\n\n    const macroDocumentData = {\n      name: macroName,\n      type: \"script\",\n      command: command,\n      img: \"modules/flash-rolls-5e/assets/bolt-circle.svg\",\n      ...(folderId && { folder: folderId }),\n      flags: {\n        \"flash-rolls-5e\": {\n          type: \"contested-roll\",\n          actors: this.actors.map(actorEntry => {\n            const a = actorEntry.actor || actorEntry;\n            return a.id;\n          }),\n          rollSelections: Array.from(this.rollSelections.entries()),\n          rollMode: this.rollMode,\n          flavor: this.flavor\n        }\n      }\n    };\n\n    const macro = await Macro.create(macroDocumentData);\n    FlashAPI.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.macroCreated\", {\n      macroName: macro.name\n    }));\n\n    macro.sheet.render(true);\n    return macro;\n  }\n\n  /**\n   * Ensure Flash Token Bar folder exists for macro organization\n   */\n  async _ensureFlashRollsFolder() {\n    const folderName = \"Flash Token Bar\";\n    let folder = game.folders.find(f => f.type === \"Macro\" && f.name === folderName);\n\n    if (!folder) {\n      try {\n        folder = await Folder.create({\n          name: folderName,\n          type: \"Macro\",\n          color: \"#302437\",\n          sort: 0\n        });\n        LogUtil.log('Created Flash Token Bar macro folder', [folder]);\n      } catch (error) {\n        LogUtil.error('Failed to create Flash Token Bar macro folder:', [error]);\n        FlashAPI.notify('warn',\"Failed to create Flash Token Bar macro folder. Macro will be created without folder organization.\");\n        return null;\n      }\n    }\n\n    return folder?.id || null;\n  }\n\n  /**\n   * Handle delete actor button click\n   */\n  async _onDeleteActor(event, target) {\n    const actorId = target.dataset.actorId;\n    LogUtil.log('ContestedRollDialog _onDeleteActor', [actorId]);\n\n    this.actors = this.actors.filter(a => a.id !== actorId);\n    this.rollSelections.delete(actorId);\n\n    await this.render(true);\n  }\n\n  /**\n   * Show the dialog\n   */\n  static async show(actors) {\n    if (!actors || actors.length === 0) {\n      FlashAPI.notify('warn',game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n      return null;\n    }\n\n    const dialog = new this({ actors });\n    dialog.render(true);\n    return dialog;\n  }\n}","import { MODULE } from \"../../../constants/General.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\";\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * Dialog showing character import results with matched/unmatched items\n * Used for Tier B and C imports when DDB Importer is not available\n */\nexport class CharacterImportResultsDialog extends HandlebarsApplicationMixin(ApplicationV2) {\n  constructor(options = {}) {\n    super(options);\n    this.importData = options.importData || {};\n    this._resolve = null;\n  }\n\n  static DEFAULT_OPTIONS = {\n    classes: [\"flash5e-dialog\", \"flash5e-import-results-dialog\"],\n    tag: \"div\",\n    window: {\n      title: \"FLASH_ROLLS.ui.dialogs.characterImport.resultsTitle\",\n      icon: \"fas fa-file-import\",\n      resizable: true,\n      positioned: true,\n      frame: true,\n      contentClasses: [\"standard-form\", \"crlngn\", \"flash5e\"]\n    },\n    position: {\n      width: 620,\n      height: \"auto\"\n    },\n    actions: {\n      confirm: CharacterImportResultsDialog.#onConfirm,\n      cancel: CharacterImportResultsDialog.#onCancel,\n      openDDBImporter: CharacterImportResultsDialog.#onOpenDDBImporter\n    }\n  };\n\n  get id() {\n    return `flash5e-import-results-${this.importData.characterName?.replace(/\\s+/g, \"-\") || \"unknown\"}`;\n  }\n\n  get title() {\n    if (this.importData.characterName) {\n      return game.i18n.format(\"FLASH_ROLLS.ui.dialogs.characterImport.resultsTitle\", {\n        name: this.importData.characterName\n      });\n    }\n    return game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.characterImport.resultsTitle\");\n  }\n\n  static PARTS = {\n    content: {\n      template: `modules/${MODULE.ID}/templates/character-import-results.hbs`\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\"\n    }\n  };\n\n  async _prepareContext(options = {}) {\n    const context = await super._prepareContext(options);\n    const { tier, matchRate, matched, unmatched, characterName, classInfo, raceName, backgroundName } = this.importData;\n\n    const matchPercentage = Math.round((matchRate || 0) * 100);\n\n    if (matched) {\n      matched.forEach((item, index) => {\n        item._itemKey = `item-${index}`;\n      });\n    }\n\n    if (unmatched) {\n      unmatched.forEach((item, index) => {\n        item._unmatchedKey = `unmatched-${index}`;\n      });\n    }\n\n    const groupedMatched = this._groupByType(matched || []);\n    const groupedUnmatched = this._groupByType(unmatched || []);\n\n    return {\n      ...context,\n      characterName,\n      tier,\n      matchPercentage,\n      matchedCount: matched?.length || 0,\n      unmatchedCount: unmatched?.length || 0,\n      totalCount: (matched?.length || 0) + (unmatched?.length || 0),\n      isTierB: tier === \"B\",\n      isTierC: tier === \"C\",\n      groupedMatched,\n      groupedUnmatched,\n      hasUnmatched: (unmatched?.length || 0) > 0,\n      classInfo,\n      raceName,\n      backgroundName\n    };\n  }\n\n  async _preparePartContext(partId, context, options) {\n    const partContext = await super._preparePartContext(partId, context, options);\n\n    if (partId === \"footer\") {\n      partContext.buttons = [\n        { type: \"button\", icon: \"fas fa-times\", label: \"Cancel\", action: \"cancel\" },\n        { type: \"button\", icon: \"fas fa-check\", label: \"Create Actor\", action: \"confirm\", cssClass: \"primary\" }\n      ];\n    }\n\n    return partContext;\n  }\n\n  /**\n   * Group items by their type for organized display, sorted alphabetically by name\n   * @param {Array} items - Array of matched or unmatched items\n   * @returns {Object} Items grouped by type with items sorted by name\n   * @private\n   */\n  _groupByType(items) {\n    const groups = {};\n    const typeLabels = {\n      spell: \"Spells\",\n      weapon: \"Weapons\",\n      equipment: \"Equipment\",\n      consumable: \"Consumables\",\n      feat: \"Features & Feats\",\n      tool: \"Tools\",\n      class: \"Classes\",\n      subclass: \"Subclasses\",\n      background: \"Background\",\n      race: \"Species\",\n      species: \"Species\",\n      unknown: \"Other\"\n    };\n\n    for (const item of items) {\n      const rawType = item.foundryType || item.type || \"unknown\";\n      const type = rawType.toLowerCase();\n      if (!groups[type]) {\n        groups[type] = {\n          label: typeLabels[type] || rawType,\n          items: []\n        };\n      }\n      groups[type].items.push(item);\n    }\n\n    for (const group of Object.values(groups)) {\n      group.items.sort((a, b) => {\n        const nameA = (a.foundryName || a.ddbItem?.definition?.name || a.ddbItem?.name || a.name || \"\").toLowerCase();\n        const nameB = (b.foundryName || b.ddbItem?.definition?.name || b.ddbItem?.name || b.name || \"\").toLowerCase();\n        return nameA.localeCompare(nameB);\n      });\n    }\n\n    return groups;\n  }\n\n  /**\n   * Factory method to show dialog and wait for user decision\n   * @param {Object} importData - Import data to display\n   * @returns {Promise<Object|null>} Modified importData with selections, or null if cancelled\n   */\n  static async show(importData) {\n    return new Promise((resolve) => {\n      const dialog = new CharacterImportResultsDialog({ importData });\n      dialog._resolve = resolve;\n      dialog.render(true);\n    });\n  }\n\n  /**\n   * @override\n   */\n  _onRender(context, options) {\n    super._onRender(context, options);\n    this.element.querySelectorAll(\".source-select\").forEach(select => {\n      select.addEventListener(\"change\", this._onSourceChange.bind(this));\n    });\n\n    const createAllCheckbox = this.element.querySelector(\"#createAllHomebrew\");\n    if (createAllCheckbox) {\n      createAllCheckbox.addEventListener(\"change\", this._onCreateAllChange.bind(this));\n    }\n  }\n\n  /**\n   * Handle \"create all homebrew\" checkbox change\n   * @param {Event} event\n   */\n  _onCreateAllChange(event) {\n    const isChecked = event.target.checked;\n    this.element.querySelectorAll(\".create-homebrew-checkbox\").forEach(checkbox => {\n      checkbox.checked = isChecked;\n    });\n  }\n\n  /**\n   * Get list of unmatched items that should be created as homebrew\n   * @returns {Array} Array of unmatched items to create\n   */\n  _getHomebrewToCreate() {\n    const toCreate = [];\n    this.element.querySelectorAll(\".create-homebrew-checkbox:checked\").forEach(checkbox => {\n      const itemKey = checkbox.dataset.itemKey;\n      const item = this.importData.unmatched?.find(u => u._unmatchedKey === itemKey);\n      if (item) {\n        toCreate.push(item);\n      }\n    });\n    return toCreate;\n  }\n\n  /**\n   * Handle source selection change\n   * @param {Event} event\n   */\n  _onSourceChange(event) {\n    const select = event.target;\n    const selectedIndex = parseInt(select.value, 10);\n    const itemKey = select.dataset.itemKey;\n\n    for (const item of this.importData.matched) {\n      if (item.allMatches && item._itemKey === itemKey) {\n        const newMatch = item.allMatches[selectedIndex];\n        item.selectedIndex = selectedIndex;\n        item.foundryUuid = newMatch.uuid;\n        item.foundryName = newMatch.name;\n        item.source = newMatch.source;\n        item.sourceLabel = newMatch.sourceLabel;\n        item.sourceVersion = newMatch.sourceVersion;\n        item.sourceTitle = newMatch.sourceTitle;\n        item.matchType = newMatch.matchType;\n        break;\n      }\n    }\n  }\n\n  /**\n   * Handle confirm button click\n   * @param {Event} event\n   * @param {HTMLElement} target\n   */\n  static #onConfirm(event, target) {\n    if (this._resolve) {\n      this.importData.homebrewToCreate = this._getHomebrewToCreate();\n      this._resolve(this.importData);\n    }\n    this.close();\n  }\n\n  /**\n   * Handle cancel button click\n   * @param {Event} event\n   * @param {HTMLElement} target\n   */\n  static #onCancel(event, target) {\n    if (this._resolve) {\n      this._resolve(null);\n    }\n    this.close();\n  }\n\n  /**\n   * Handle open DDB Importer link\n   * @param {Event} event\n   * @param {HTMLElement} target\n   */\n  static #onOpenDDBImporter(event, target) {\n    window.open(\"https://foundryvtt.com/packages/ddb-importer\", \"_blank\");\n  }\n\n  /** @override */\n  close(options = {}) {\n    if (this._resolve && !options._resolved) {\n      this._resolve(null);\n    }\n    return super.close(options);\n  }\n}\n"],"file":"scripts/flash-rolls-5e.js"}