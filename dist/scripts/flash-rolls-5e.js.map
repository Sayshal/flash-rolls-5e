{"version":3,"file":"flash-rolls-5e.js","sources":["../../src/constants/IconMappings.mjs","../../src/constants/Settings.mjs","../../src/constants/General.mjs","../../src/constants/Hooks.mjs","../../src/components/utils/LogUtil.mjs","../../src/components/utils/SocketUtil.mjs","../../src/components/utils/DiceConfigUtil.mjs","../../src/components/utils/GeneralUtil.mjs","../../src/components/utils/IconLayoutUtil.mjs","../../src/components/ui/dialogs/ModuleSettingsMenu.mjs","../../src/constants/SettingMenus.mjs","../../src/components/helpers/ModuleHelpers.mjs","../../src/components/helpers/Helpers.mjs","../../src/components/helpers/RollHelpers.mjs","../../src/components/managers/ActivityManager.mjs","../../src/components/managers/SidebarController.mjs","../../src/components/ui/dialogs/CustomRollDialog.mjs","../../src/components/managers/ChatMessageManager.mjs","../../src/components/handlers/RollHandlers.mjs","../../src/components/helpers/RollValidationHelpers.mjs","../../src/components/utils/RollMenuActorUtil.mjs","../../src/components/handlers/RollInterceptor.mjs","../../src/components/managers/roll-menu/OfflinePlayerManager.mjs","../../src/components/managers/roll-menu/RollMenuOrchestrator.mjs","../../src/components/core/FlashRollsAPI.mjs","../../src/components/ui/dialogs/gm-dialogs/GMRollConfigMixin.mjs","../../src/components/ui/dialogs/gm-dialogs/GMRollConfigDialog.mjs","../../src/components/ui/dialogs/gm-dialogs/GMHitDieConfigDialog.mjs","../../src/components/ui/dialogs/gm-dialogs/GMSkillToolConfigDialog.mjs","../../src/components/ui/dialogs/gm-dialogs/GMDamageConfigDialog.mjs","../../src/components/ui/dialogs/gm-dialogs/GMAttackConfigDialog.mjs","../../src/components/managers/roll-menu/RollMenuConfig.mjs","../../src/components/managers/roll-menu/RollMenuDragManager.mjs","../../src/components/managers/ActorStatusManager.mjs","../../src/components/utils/ActorDragUtil.mjs","../../src/components/utils/ActorDropUtil.mjs","../../src/components/managers/roll-menu/RollMenuEventManager.mjs","../../src/components/managers/roll-menu/RollMenuStatusManager.mjs","../../src/components/managers/roll-menu/RollMenuStateManager.mjs","../../src/components/managers/roll-menu/RollMenuActorProcessor.mjs","../../src/components/managers/roll-menu/RollMenuExecutor.mjs","../../src/components/ui/RollRequestsMenu.mjs","../../src/components/utils/SettingsUtil.mjs","../../src/components/utils/ActorDirectoryIconUtil.mjs","../../src/components/handlers/RollHooksHandler.mjs","../../src/components/core/HooksManager.mjs","../../src/components/managers/RollRequestManager.mjs","../../src/components/core/Main.mjs","../../src/module.mjs"],"sourcesContent":["/**\n * Icon mappings and configuration for menu icons\n */\n\nexport const ICON_TYPES = {\n  MODULE_ACTIONS: \"moduleActions\",\n  ACTOR_ACTIONS: \"actorActions\"\n};\n\n/**\n * Module action icon configurations\n * Maps icon IDs to their properties and labels\n */\nexport const MODULE_ACTION_ICONS = {\n  \"lock-menu\": {\n    id: \"lock-menu\",\n    icon: \"fa-lock-keyhole\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.lockMenu\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.lockMenu\",\n    element: \"flash5e-actors-lock\",\n    type: \"button\"\n  },\n  \"toggle-requests\": {\n    id: \"toggle-requests\",\n    icon: \"fa-bolt\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.toggleRollRequests\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.toggleRollRequests\",\n    element: \"flash-rolls-toggle\",\n    type: \"checkbox\"\n  },\n  \"skip-dialogs\": {\n    id: \"skip-dialogs\",\n    icon: \"fa-square-question\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.skipRollDialog\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.skipRollDialog\",\n    element: \"flash5e-skip-dialogs\",\n    type: \"checkbox\"\n  },\n  \"group-rolls\": {\n    id: \"group-rolls\",\n    icon: \"fa-users-rectangle\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.groupRollsMsg\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.groupRollsMsg\",\n    element: \"flash5e-group-rolls-msg\",\n    type: \"checkbox\"\n  },\n  \"show-options\": {\n    id: \"show-options\",\n    icon: \"fa-bars-sort\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.showOptionsListOnHover\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.showOptionsListOnHover\",\n    element: \"flash5e-toggle-list\",\n    type: \"checkbox\"\n  },\n  \"open-settings\": {\n    id: \"open-settings\",\n    icon: \"fa-cog\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.openSettings\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.openSettings\",\n    element: \"flash5e-open-settings\",\n    type: \"button\"\n  }\n};\n\n/**\n * Actor action icon configurations\n * Maps icon IDs to their properties and labels\n */\nexport const ACTOR_ACTION_ICONS = {\n  \"select-all\": {\n    id: \"select-all\",\n    icon: \"fa-object-group\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.selectAll\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.selectAll\",\n    element: \"flash5e-actors-all\",\n    type: \"checkbox\",\n    cssClass: \"bulk-action\"\n  },\n  \"filter-actors\": {\n    id: \"filter-actors\",\n    icon: \"fa-filter-list\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.filterActors\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.filterActors\",\n    element: \"flash5e-filter-actors\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"toggle-targets\": {\n    id: \"toggle-targets\",\n    icon: \"fa-crosshairs\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.toggleTargets\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.toggleTargets\",\n    element: \"flash5e-targets\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"heal-all\": {\n    id: \"heal-all\",\n    icon: \"fa-heart-pulse\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.healAll\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.healAll\",\n    element: \"flash5e-heal-selected\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"kill-all\": {\n    id: \"kill-all\",\n    icon: \"fa-skull\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.killAll\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.killAll\",\n    element: \"flash5e-kill-selected\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"remove-status\": {\n    id: \"remove-status\",\n    icon: \"fa-sparkles\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.removeStatus\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.removeStatus\",\n    element: \"flash5e-remove-effects\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"open-sheets\": {\n    id: \"open-sheets\",\n    icon: \"fa-square-user\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.openSheets\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.openSheets\",\n    element: \"flash5e-sheets\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  },\n  \"group-selected\": {\n    id: \"group-selected\",\n    icon: \"fa-users-medical\",\n    labelKey: \"FLASH_ROLLS.ui.inputs.groupSelected\",\n    tooltipKey: \"FLASH_ROLLS.ui.inputs.groupSelected\",\n    element: \"flash5e-group-selected\",\n    type: \"button\",\n    cssClass: \"bulk-action\"\n  }\n};\n\n/**\n * Get all icon configurations by type\n * @param {string} type - Icon type (moduleActions or actorActions)\n * @returns {Object} Icon configurations\n */\nexport function getIconConfigurations(type) {\n  switch (type) {\n    case ICON_TYPES.MODULE_ACTIONS:\n      return MODULE_ACTION_ICONS;\n    case ICON_TYPES.ACTOR_ACTIONS:\n      return ACTOR_ACTION_ICONS;\n    default:\n      return {};\n  }\n}\n\n/**\n * Get icon configuration by ID\n * @param {string} iconId - Icon ID\n * @param {string} type - Icon type\n * @returns {Object|null} Icon configuration or null if not found\n */\nexport function getIconConfiguration(iconId, type) {\n  const configurations = getIconConfigurations(type);\n  return configurations[iconId] || null;\n}\n\n/**\n * Get default icon layout configuration\n * @returns {Object} Default icon layout\n */\nexport function getDefaultIconLayout() {\n  return {\n    moduleActions: [\n      { id: \"lock-menu\", icon: \"fa-lock-keyhole\", enabled: true, order: 0 },\n      { id: \"toggle-requests\", icon: \"fa-bolt\", enabled: true, order: 1 },\n      { id: \"skip-dialogs\", icon: \"fa-square-question\", enabled: true, order: 2 },\n      { id: \"group-rolls\", icon: \"fa-users-rectangle\", enabled: true, order: 3 },\n      { id: \"show-options\", icon: \"fa-bars-sort\", enabled: true, order: 4 },\n      { id: \"open-settings\", icon: \"fa-cog\", enabled: true, order: 5 }\n    ],\n    actorActions: [\n      { id: \"filter-actors\", icon: \"fa-filter-list\", enabled: true, order: 0 },\n      { id: \"select-all\", icon: \"fa-object-group\", enabled: true, order: 1 },\n      { id: \"toggle-targets\", icon: \"fa-crosshairs\", enabled: true, order: 2 },\n      { id: \"heal-all\", icon: \"fa-heart-pulse\", enabled: true, order: 3 },\n      { id: \"kill-all\", icon: \"fa-skull\", enabled: true, order: 4 },\n      { id: \"remove-status\", icon: \"fa-sparkles\", enabled: true, order: 5 },\n      { id: \"open-sheets\", icon: \"fa-square-user\", enabled: true, order: 6 },\n      { id: \"group-selected\", icon: \"fa-users-medical\", enabled: true, order: 7 }\n    ]\n  };\n}","import { getDefaultIconLayout } from \"./IconMappings.mjs\";\n\nexport const SETTING_INPUT = {\n  select: \"select\", \n  checkbox: \"checkbox\"\n}\nexport const SETTING_SCOPE = {\n  client: \"client\",\n  world: \"world\"\n}\nconst iconsMenuDefault = getDefaultIconLayout();\n\n/**\n * Get all module settings\n * @returns {Object} Module settings\n */\nexport const getSettings = () => {\n  return {\n    generalSettings: {\n      tag: \"flash5e-general-settings\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      title: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      propType: Object,\n      fields: [\n        'showMenuOnLoad',\n        'skipRollDialog',\n        'skipRollDialogOption',\n        'showOnlyPCsWithToken',\n        'addMacrosToFolder',\n        'templateAutoTarget',\n        'removeTemplate',\n        'templateRemovalTimeout'\n      ],\n      default: {\n        showMenuOnLoad: false,\n        skipRollDialog: false,\n        skipRollDialogOption: 1,\n        showOnlyPCsWithToken: true,\n        addMacrosToFolder: true,\n        templateAutoTarget: 1,\n        removeTemplate: true,\n        templateRemovalTimeout: 5\n      },\n      scope: SETTING_SCOPE.world,\n      config: false, \n      requiresReload: false \n    },\n\n    interfaceSettings: {\n      tag: \"flash5e-interface-settings\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      title: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      propType: Object,\n      fields: [\n        'showMenuOnLoad',\n        'compactMode',\n        'menuLayout',\n        'menuIconsLayout'\n      ],\n      default: {\n        showMenuOnLoad: false,\n        compactMode: true,\n        menuLayout: \"vertical\",\n        menuIconsLayout: iconsMenuDefault,\n      },\n      scope: SETTING_SCOPE.world,\n      config: false, \n      requiresReload: false \n    },\n\n    groupRollsSettings: {\n      tag: \"flash5e-group-rolls-settings\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      title: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      propType: Object,\n      fields: [\n        'groupRollsMsgEnabled',\n        'groupRollResultMode',\n        'showGroupDCToPlayers',\n        'groupRollNPCHidden'\n      ],\n      default: {\n        groupRollsMsgEnabled: true,\n        groupRollResultMode: 1,\n        showGroupDCToPlayers: false,\n        groupRollNPCHidden: true\n      },\n      scope: SETTING_SCOPE.world,\n      config: false, \n      requiresReload: false \n    },\n\n    rollRequestsSettings: {\n      tag: \"flash5e-roll-request-settings\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      title: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      propType: Object,\n      fields: [\n        'rollInterceptionEnabled',\n        'useGMTargetTokens',\n        'consumptionConfigMode',\n        'placeTemplateForPlayer',\n        'showOfflineNotifications',\n        'initiateCombatOnRequest',\n        'publicPlayerRolls'\n      ],\n      default: {\n        rollInterceptionEnabled: true,\n        useGMTargetTokens: true,\n        consumptionConfigMode: 2,\n        placeTemplateForPlayer: false,\n        showOfflineNotifications: true,\n        initiateCombatOnRequest: true,\n        publicPlayerRolls: true\n      },\n      scope: SETTING_SCOPE.world,\n      config: false, \n      requiresReload: false \n    },\n\n    showGroupDCToPlayers: {\n      tag: \"show-group-dc-to-players\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showGroupDCToPlayers.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showGroupDCToPlayers.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    groupRollNPCHidden: {\n      tag: \"group-roll-npc-hidden\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollNPCHidden.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollNPCHidden.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    \n    rollRequestsEnabled: {\n      tag: \"roll-requests-enabled\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.rollRequestsEnabled.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.rollRequestsEnabled.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: true\n    },\n    \n    groupRollsMsgEnabled: {\n      tag: \"group-roll-enabled\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollsMsgEnabled.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollsMsgEnabled.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    groupRollResultMode: {\n      tag: \"group-roll-result-mode\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.hint\"),\n      propType: Number, \n      inputType: SETTING_INPUT.select,\n      choices: {\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.1\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.2\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.3\"),\n        4: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.4\")\n      },\n      default: 1,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    consumptionConfigMode: {\n      tag: \"consumption-config\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.hint\"),\n      propType: Number, \n      inputType: SETTING_INPUT.select,\n      choices: {\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.1\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.2\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.3\"),\n        4: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.4\")\n      },\n      default: 2,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    \n    placeTemplateForPlayer: {\n      tag: \"place-template-for-player\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.placeTemplateForPlayer.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.placeTemplateForPlayer.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    skipRollDialog: {\n      tag: \"skip-roll-dialog\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialog.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialog.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    skipRollDialogOption: {\n      tag: \"skip-roll-dialog-options\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialogOption.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialogOption.hint\"),\n      propType: Number, \n      inputType: SETTING_INPUT.select,\n      choices: {\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialogOption.choices.1\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialogOption.choices.2\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialogOption.choices.3\")\n      },\n      default: 1,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    useGMTargetTokens: {\n      tag: \"use-gm-target-tokens\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.useGMTargetTokens.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.useGMTargetTokens.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    rollInterceptionEnabled: {\n      tag: \"roll-interception-on\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.rollInterceptionEnabled.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.rollInterceptionEnabled.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    publicPlayerRolls: {\n      tag: \"public-player-rolls\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.publicPlayerRolls.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.publicPlayerRolls.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showOfflineNotifications: {\n      tag: \"show-offline-notifications\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showOfflineNotifications.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showOfflineNotifications.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showRequestNotifications: {\n      tag: \"show-request-notifications\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showRequestNotifications.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showRequestNotifications.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    initiateCombatOnRequest: {\n      tag: \"initiate-combat-on-request\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.initiateCombatOnRequest.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.initiateCombatOnRequest.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showOnlyPCsWithToken: {\n      tag: \"show-only-pcs-with-token\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showOnlyPCsWithToken.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showOnlyPCsWithToken.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    compactMode: {\n      tag: \"compact-mode\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.compactMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.compactMode.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    menuLayout: {\n      tag: \"menu-layout\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.menuLayout.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.menuLayout.hint\"),\n      propType: String, \n      inputType: SETTING_INPUT.select,\n      choices: {\n        \"vertical\": game.i18n.localize(\"FLASH_ROLLS.settings.menuLayout.choices.vertical\"),\n        \"horizontal\": game.i18n.localize(\"FLASH_ROLLS.settings.menuLayout.choices.horizontal\")\n      },\n      default: \"vertical\",\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showOptionsListOnHover: {\n      tag: \"show-list-on-hover\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showOptionsListOnHover.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showOptionsListOnHover.hint\"),\n      propType: Boolean,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    templateAutoTarget: { \n      tag: \"template-auto-target\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.hint\"),\n      propType: Number,\n      choices: {\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.choices.all.label\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.choices.notFriendly.label\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.choices.none.label\"),\n      },\n      inputType: SETTING_INPUT.select,\n      default: 1,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    removeTemplate: {\n      tag: \"remove-template\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.removeTemplate.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.removeTemplate.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    templateRemovalTimeout: {\n      tag: \"template-removal-timeout\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.templateRemovalTimeout.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.templateRemovalTimeout.hint\"),\n      propType: Number,\n      default: 5,\n      scope: SETTING_SCOPE.world,\n      config: false,\n      range: {\n        min: 0,\n        max: 30,\n        step: 1\n      }\n    },\n\n    debugMode: {\n      tag: \"debug-mode-on\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.debugMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.debugMode.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.client,\n      config: true\n    },\n\n    showMenuOnLoad: {\n      tag: \"show-menu-on-world-load\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showMenuOnLoad.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showMenuOnLoad.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    addMacrosToFolder: {\n      tag: \"add-macros-to-folder\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.addMacrosToFolder.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.addMacrosToFolder.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    menuIconsLayout: {\n      tag: \"menu-icons-layout\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.menuIconsLayout.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.menuIconsLayout.hint\"),\n      propType: Object,\n      default: iconsMenuDefault,\n      scope: SETTING_SCOPE.world,\n      config: false\n    }\n  };\n};\n","/**\n * Module ID constant\n * @constant\n * @type {string}\n */\nexport const MODULE_ID = \"flash-rolls-5e\";\n\n/**\n * Debug tag for console logging\n * @constant\n * @type {Array}\n */\nexport const DEBUG_TAG = [\n  `%cFlash Rolls 5e`,\n  `color:rgb(47, 151, 161); font-weight: bold;`,\n  `|`,\n];\n\nexport const SOCKET_CALLS = {\n  receiveDiceConfig: \"receiveDiceConfig\",\n  getDiceConfig: \"getDiceConfig\",\n  handleRollRequest: \"handleRollRequest\",\n  removeTemplate: \"removeTemplate\"\n};\n\nexport const HOOK_NAMES = {\n  ATTACK: { name: \"attack\", requestType: \"attack\" },\n  DAMAGE: { name: \"damage\", requestType: \"damage\" },\n  SAVE: { name: \"save\", requestType: \"damage\" },\n  SAVING_THROW: { name: \"savingthrow\", requestType: \"check\" },\n  ABILITY_CHECK: { name: \"abilitycheck\", requestType: \"check\" },\n  CONCENTRATION: { name: \"concentration\", requestType: \"check\" },\n  DEATH_SAVE: { name: \"deathsave\", requestType: \"save\" }, \n  SKILL: { name: \"skill\", requestType: \"check\" },\n  TOOL: { name: \"tool\", requestType: \"check\" },\n  HIT_DIE: { name: \"hitdie\", requestType: \"formula\" },\n  INITIATIVE: { name: \"initiative\", requestType: \"check\" },\n  FORMULA: { name: \"formula\", requestType: \"formula\" },\n  RECHARGE: { name: \"recharge\", requestType: \"formula\" },\n  D20_TEST: { name: \"d20Test\", requestType: \"formula\" },\n  SHORT_REST: { name: \"shortRest\", requestType: \"formula\" },\n  LONG_REST: { name: \"longRest\", requestType: \"formula\" },\n};\n\nexport const ACTIVITY_TYPES = {\n  ATTACK: \"attack\",\n  CAST: \"cast\",\n  CHECK: \"check\",\n  DAMAGE: \"damage\",\n  ENCHANT: \"enchant\",\n  FORWARD: \"forward\",\n  HEAL: \"heal\",\n  ORDER: \"order\",\n  SAVE: \"save\",\n  SUMMON: \"summon\",\n  TRANSFORM: \"transform\",\n  UTILITY: \"utility\"\n};\n\nexport const CALL_TYPE = {\n  ACTIVITY: \"activity\",\n  CHECK: \"check\",\n}\n\nexport const BUTTON_ACTION_TYPES = {\n  ROLL_REQUEST: \"rollRequest\",\n  ROLL_ATTACK: \"rollAttack\",\n  ROLL_DAMAGE: \"rollDamage\"\n}\n\n/**\n * Roll types used throughout the module\n * @constant\n * @type {Object}\n */\nexport const ROLL_TYPES = {\n  ABILITY: \"ability\",\n  ABILITY_CHECK: \"abilitycheck\",\n  ATTACK: \"attack\",\n  CONCENTRATION: \"concentration\",\n  CUSTOM: \"custom\",\n  DEATH_SAVE: \"deathsave\",\n  FORMULA: \"formula\",\n  DAMAGE: \"damage\",\n  HEALING: \"healing\",\n  HIT_DIE: \"hitdie\",\n  INITIATIVE: \"initiative\",\n  INITIATIVE_DIALOG: \"initiativedialog\",\n  ITEM_SAVE: \"itemsave\",\n  SAVE: \"save\",\n  SAVING_THROW: \"savingthrow\",\n  SKILL: \"skill\",\n  TOOL: \"tool\"\n}\n\nexport const ROLL_REQUEST_OPTIONS = {\n  ABILITY_CHECK: { name: ROLL_TYPES.ABILITY_CHECK, label: \"Ability Check\", subList: \"abilities\", actorPath: 'system.abilities' },\n  SAVING_THROW: { name: ROLL_TYPES.SAVING_THROW, label: \"Saving Throw\", subList: \"abilities\", actorPath: 'system.abilities' },\n  SKILL: { name: ROLL_TYPES.SKILL, label: \"Skill Check\", subList: \"skills\", actorPath: 'system.skills' },\n  TOOL: { name: ROLL_TYPES.TOOL, label: \"Tool Check\", subList: \"tools\", actorPath: 'system.tools' },\n  CONCENTRATION: { name: ROLL_TYPES.CONCENTRATION, label: \"Concentration Check\", subList: null, actorPath: '' },\n  INITIATIVE: { name: ROLL_TYPES.INITIATIVE, label: \"Initiative Roll\", subList: null, actorPath: '' },\n  DEATH_SAVE: { name: ROLL_TYPES.DEATH_SAVE, label: \"Death Save\", subList: null, actorPath: '' },\n  // ITEM_SAVE: { name: ROLL_TYPES.ITEM_SAVE, label: \"Item Save\", subList: null, actorPath: '' },\n  HIT_DIE: { name: ROLL_TYPES.HIT_DIE, label: \"Hit Die\", subList: null, actorPath: '' },\n  CUSTOM: { name: ROLL_TYPES.CUSTOM, label: \"Custom Roll\", subList: null, actorPath: '' },\n}\n\n/**\n * Module configuration object\n * @constant\n * @type {Object}\n */\nexport const MODULE = {\n  ID: MODULE_ID,\n  ROLL_REQUEST_OPTIONS: ROLL_REQUEST_OPTIONS\n}\n","/**\n * Core Foundry hooks\n * @constant\n * @type {Object}\n */\nexport const HOOKS_CORE = {\n  INIT: \"init\",\n  READY: \"ready\",\n  RENDER_CHAT_MESSAGE: \"renderChatMessageHTML\",\n  RENDER_CHAT_LOG: \"renderChatLog\",\n  RENDER_CHAT_INPUT: \"renderChatInput\",\n  // RENDER_SIDEBAR_TAB: \"renderSidebarTab\",\n  CHANGE_SIDEBAR_TAB: \"changeSidebarTab\", \n  RENDER_SIDEBAR: \"renderSidebar\",\n  RENDER_APPLICATION_V2: \"renderApplicationV2\",\n  UPDATE_SCENE: \"updateScene\",\n  RENDER_SCENE_NAVIGATION: \"renderSceneNavigation\",\n  RENDER_ROLL_RESOLVER: \"renderRollResolver\",\n  USER_CONNECTED: \"userConnected\",\n  PRE_CREATE_CHAT_MESSAGE: \"preCreateChatMessage\",\n  CREATE_CHAT_MESSAGE: \"createChatMessage\",\n  RENDER_ROLL_CONFIGURATION_DIALOG: \"renderRollConfigurationDialog\",\n  COLLAPSE_SIDE_BAR: \"collapseSidebar\",\n  REFRESH_MEASURED_TEMPLATE: \"refreshMeasuredTemplate\",\n  CONTROL_TOKEN: \"controlToken\",\n  UPDATE_TOKEN: \"updateToken\",\n  DELETE_TOKEN: \"deleteToken\",\n  CREATE_TOKEN: \"createToken\",\n  UPDATE_ACTOR: \"updateActor\",\n  UPDATE_ITEM: \"updateItem\",\n  CREATE_ITEM: \"createItem\",\n  DELETE_ITEM: \"deleteItem\",\n  UPDATE_SETTING: \"updateSetting\",\n  CLIENT_SETTING_CHANGED: \"clientSettingChanged\",\n  GET_ACTOR_CONTEXT_OPTIONS: \"getActorContextOptions\",\n  GET_CHAT_MESSAGE_CONTEXT_OPTIONS: \"getChatMessageContextOptions\",\n  RENDER_ACTOR_DIRECTORY: \"renderActorDirectory\",\n  CREATE_COMBATANT: \"createCombatant\",\n  DELETE_COMBATANT: \"deleteCombatant\",\n  UPDATE_COMBAT: \"updateCombat\",\n  DELETE_COMBAT: \"deleteCombat\",\n  CREATE_ACTIVE_EFFECT: \"createActiveEffect\",\n  DELETE_ACTIVE_EFFECT: \"deleteActiveEffect\",\n  UPDATE_ACTIVE_EFFECT: \"updateActiveEffect\"\n};\n\n/**\n * Socketlib hooks\n */\nexport const HOOKS_SOCKET = {\n  READY: \"socketlib.ready\"\n}\n\n/**\n * Midi-QOL hooks\n */\nexport const HOOKS_MIDI_QOL = {\n  READY: \"midi-qol.ready\"\n}\n\n/**\n * DnD5e hooks\n */\nexport const HOOKS_DND5E = {\n  // General Rolling Process\n  PRE_ROLL_V2: \"dnd5e.preRollV2\",\n\n  // Activity\n  PRE_USE_ACTIVITY: \"dnd5e.preUseActivity\",\n  POST_USE_ACTIVITY: \"dnd5e.postUseActivity\",\n  \n  // Ability Checks & Saving Throws\n  PRE_ROLL_ABILITY_CHECK: \"dnd5e.preRollAbilityCheckV2\",\n  PRE_ROLL_SAVING_THROW: \"dnd5e.preRollSavingThrowV2\",\n  ROLL_ABILITY_CHECK: \"dnd5e.rollAbilityCheckV2\",\n  ROLL_SAVING_THROW: \"dnd5e.rollSavingThrowV2\",\n  \n  // Concentration\n  PRE_BEGIN_CONCENTRATING: \"dnd5e.preBeginConcentrating\",\n  BEGIN_CONCENTRATING: \"dnd5e.beginConcentrating\",\n  PRE_END_CONCENTRATION: \"dnd5e.preEndConcentration\",\n  END_CONCENTRATION: \"dnd5e.endConcentration\",\n  PRE_ROLL_CONCENTRATION_V2: \"dnd5e.preRollConcentrationV2\",\n  ROLL_CONCENTRATION_V2: \"dnd5e.rollConcentrationV2\",\n  \n  // Damage\n  PRE_CALCULATE_DAMAGE: \"dnd5e.preCalculateDamage\",\n  CALCULATE_DAMAGE: \"dnd5e.calculateDamage\",\n  PRE_APPLY_DAMAGE: \"dnd5e.preApplyDamage\",\n  APPLY_DAMAGE: \"dnd5e.applyDamage\",\n  \n  // Death Saves\n  PRE_ROLL_DEATH_SAVE_V2: \"dnd5e.preRollDeathSaveV2\",\n  ROLL_DEATH_SAVE_V2: \"dnd5e.rollDeathSaveV2\",\n  POST_ROLL_DEATH_SAVE: \"dnd5e.postRollDeathSave\",\n  \n  // Skills & Tools\n  PRE_ROLL_SKILL_V2: \"dnd5e.preRollSkillV2\",\n  PRE_ROLL_TOOL_V2: \"dnd5e.preRollToolV2\",\n  ROLL_SKILL_V2: \"dnd5e.rollSkillV2\",\n  ROLL_TOOL_V2: \"dnd5e.rollToolV2\",\n  \n  // Hit Dice\n  PRE_ROLL_HIT_DIE_V2: \"dnd5e.preRollHitDieV2\",\n  ROLL_HIT_DIE_V2: \"dnd5e.rollHitDieV2\",\n  \n  // Hit Points\n  PRE_ROLL_CLASS_HIT_POINTS: \"dnd5e.preRollClassHitPoints\",\n  ROLL_CLASS_HIT_POINTS: \"dnd5e.rollClassHitPoints\",\n  PRE_ROLL_NPC_HIT_POINTS: \"dnd5e.preRollNPCHitPoints\",\n  ROLL_NPC_HIT_POINTS: \"dnd5e.rollNPChitPoints\",\n  \n  // Initiative\n  PRE_CONFIGURE_INITIATIVE: \"dnd5e.preConfigureInitiative\",\n  PRE_ROLL_INITIATIVE_DIALOG: \"dnd5e.preRollInitiativeDialog\",\n  // PRE_ROLL_INITIATIVE_DIALOG_V2: \"dnd5e.preRollInitiativeDialogV2\",\n  PRE_ROLL_INITIATIVE: \"dnd5e.preRollInitiative\",\n  ROLL_INITIATIVE: \"dnd5e.rollInitiative\",\n  \n  // Attacks\n  PRE_ROLL_ATTACK_V2: \"dnd5e.preRollAttackV2\",\n  ROLL_ATTACK_V2: \"dnd5e.rollAttackV2\",\n  POST_ROLL_ATTACK: \"dnd5e.postRollAttack\",\n  \n  // Damage Rolls\n  PRE_ROLL_DAMAGE_V2: \"dnd5e.preRollDamageV2\",\n  ROLL_DAMAGE_V2: \"dnd5e.rollDamageV2\",\n  \n  // Formula Rolls\n  PRE_ROLL_FORMULA_V2: \"dnd5e.preRollFormulaV2\",\n  ROLL_FORMULA_V2: \"dnd5e.rollFormulaV2\",\n  \n  // Recharge Rolls\n  PRE_ROLL_RECHARGE_V2: \"dnd5e.preRollRechargeV2\",\n  ROLL_RECHARGE_V2: \"dnd5e.rollRechargeV2\",\n  \n  // Car Display\n  PRE_DISPLAY_CARD_V2: \"dnd5e.preDisplayCardV2\",\n  DISPLAY_CARD: \"dnd5e.displayCard\",\n\n  // Config\n  BUILD_ROLL_CONFIG: \"dnd5e.buildRollConfig\",\n  POST_BUILD_ROLL_CONFIG: \"dnd5e.postBuildRollConfig\",\n  POST_ROLL_CONFIG: \"dnd5e.postRollConfiguration\",\n  RENDER_ROLL_CONFIGURATION_DIALOG: \"renderRollConfigurationDialog\",\n  RENDER_SKILL_TOOL_ROLL_DIALOG: \"renderSkillToolRollConfigurationDialog\",\n  RENDER_FORMULA_ROLL_DIALOG: \"renderFormulaRollConfigurationDialog\"\n}\n\n/**\n * Flash Rolls 5e Hooks\n * @constant\n * @type {Object}\n */\nexport const HOOKS_MODULE = {\n  READY: \"ready\"\n}","import { DEBUG_TAG, MODULE_ID } from \"../../constants/General.mjs\";\n\n/**\n * Handles logging operations in the module\n * Provides methods for debug, warning, and error logging with module context\n */\nexport class LogUtil {\n  /** @type {boolean} Whether debug logging is enabled */\n  static debugOn = false;\n\n  /**\n   * Logs information to the console, adding module name and reference\n   * @param {string} ref - Reference information to log after module name\n   * @param {Array|*} data - array of items to log on console, or a single item that will be wrapped in an array\n   * @param {boolean} [bypassSettings=false] - Whether to bypass debug settings check\n   */\n  static log(ref=\"\", data=[], bypassSettings=false) {\n    try {\n      const debugSetting = game.settings.get(MODULE_ID, \"debug-mode-on\") || LogUtil.debugOn;\n      const isDebugModeOn = bypassSettings || debugSetting;\n      if(!isDebugModeOn) { return; }\n      \n      // Ensure data is an array\n      const dataArray = Array.isArray(data) ? data : [data];\n      console.log(...DEBUG_TAG, ref, ...dataArray);\n    } catch(e) {\n      // If settings aren't available yet, check bypassSettings\n      if (bypassSettings || LogUtil.debugOn) {\n        // Ensure data is an array\n        const dataArray = Array.isArray(data) ? data : [data];\n        console.log(...DEBUG_TAG, ref, ...dataArray);\n      }\n    }\n  }\n\n  /**\n   * Outputs warning on console, adding module name and reference\n   * @param {string} ref - Reference information to log after module name\n   * @param {Array|*} data - array of items to log on console, or a single item that will be wrapped in an array\n   */\n  static warn(ref=\"\", data=[]) {\n    // Ensure data is an array\n    const dataArray = Array.isArray(data) ? data : [data];\n    console.warn(...DEBUG_TAG, ref, ...dataArray);\n  }\n\n  /**\n   * Logs an error to the console and/or UI notification\n   * @param {string} strRef - Reference string for the error\n   * @param {Array|*} data - array of items to log on console, or a single item that will be wrapped in an array\n   * @param {object} options - Error logging configuration\n   * @param {boolean} [options.ui=false] - Whether to show UI notification\n   * @param {boolean} [options.console=true] - Whether to log to console\n   * @param {boolean} [options.permanent=false] - Whether UI notification should be permanent\n   * @static\n   */\n  static error(strRef, data=[], options = { ui: false, console: true, permanent: false }) {\n    // Ensure data is an array\n    const dataArray = Array.isArray(data) ? data : [data];\n    \n    if(options.ui) {\n      ui.notifications?.error(strRef, { localize: true, permanent: options.permanent });\n    }\n    if(options.console) console.error(...DEBUG_TAG, strRef, ...dataArray);\n  }\n}","import { MODULE_ID } from \"../../constants/General.mjs\";\nimport { HOOKS_SOCKET } from \"../../constants/Hooks.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\n\n/**\n * Utility class for managing socket communication using socketlib.\n */\nexport class SocketUtil {\n  static socket;\n  static _activeExecutions = new Map();\n\n  /**\n   * Initializes the socket module and registers it with socketlib.\n   * This should be called once during FoundryVTT initialization.\n   * \n   * @param {Function} callbackFunc - Optional callback to execute after registration.\n   */\n  static initialize = (callbackFunc) => {\n    LogUtil.log('initialize', [callbackFunc]);\n\n    Hooks.once(HOOKS_SOCKET.READY, () => { \n      // Check if socketlib is available before registering the module\n      if (typeof socketlib === \"undefined\") {\n        LogUtil.error(\"SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled.\");\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.socketlibMissing\"), {permanent: true});\n        return;\n      }\n\n      try { \n        // Register the module with socketlib\n        SocketUtil.socket = socketlib.registerModule(MODULE_ID);\n\n        // Execute callback function if provided\n        if (callbackFunc) {\n          callbackFunc();\n        }\n\n      } catch (e) {\n        LogUtil.error(\"SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled.\", [e]);\n      }\n    });\n  }\n\n  /**\n   * Registers a callback function that can be called remotely via the socket.\n   * \n   * @param {string} name - The name of the remote function.\n   * @param {Function} func - The function to be executed remotely.\n   */\n  static registerCall = (name, func) => {\n    LogUtil.log('registerCall', [name]);\n    if (SocketUtil.socket) {\n      SocketUtil.socket.register(name, func);\n    } else {\n    }\n  }\n\n  /**\n   * Sends a message via the socket (currently only logs it and calls a callback).\n   * \n   * @param {*} value - The message or data to send.\n   * @param {Function} callback - The callback function to execute after sending.\n   */\n  static sendMessage = (value, callback) => {\n    LogUtil.log('sendMessage', [value]);\n    if (callback) {\n        callback();\n    }\n  }\n\n  /**\n   * Executes a function as the GM.\n   * \n   * @param {Function} handler - The function to execute.\n   * @param {...*} parameters - The parameters to pass to the function.\n   * @returns {Promise} A promise resolving when the function executes.\n   */\n  static execForGMs = async (handler, ...parameters) => {\n    LogUtil.log('execForGMs', [handler, ...parameters]);\n    if (!SocketUtil.socket) {\n      return;\n    }\n    return await SocketUtil.socket.executeForAllGMs(handler, ...parameters);\n  }\n\n  /**\n   * Executes a function for all connected clients.\n   * \n   * @param {Function} handler - The function to execute.\n   * @param {...*} parameters - The parameters to pass to the function.\n   * @returns {Promise} A promise resolving when the function executes for all clients.\n   */\n  static execForAll = async (handler, ...parameters) => {\n    if (!SocketUtil.socket) {\n      return;\n    }\n    return await SocketUtil.socket.executeForEveryone(handler, ...parameters);\n  }\n\n\n  /**\n   * Executes a function as the specified user.\n   * @param {Function|string} handler - The function to execute or the name of a registered function.\n   * @param {String} userId - the id of the user that should execute this function\n   * @param {...*} parameters - The parameters to pass to the function.\n   * @returns {Promise} A promise resolving when the function executes.\n   */\n  static execForUser = async (handler, userId, ...parameters) => {\n    LogUtil.log('execForUser #0', [handler, userId, ...parameters]);\n    if (!SocketUtil.socket) {\n        return;\n    }\n\n    LogUtil.log('execForUser #1', [userId === game.user.id]);\n    if(userId === game.user.id){\n      return null; // Break the recursion\n    }\n    const executionKey = `${handler}-${userId}`;\n    \n    LogUtil.log('execForUser #2', [SocketUtil._activeExecutions.has(executionKey)]);\n    // Check if this exact execution is already in progress\n    if (SocketUtil._activeExecutions.has(executionKey)) {\n        return null; // Break the recursion\n    }\n    // Mark this execution as active\n    SocketUtil._activeExecutions.set(executionKey, true);\n    \n    try {\n      const resp = await SocketUtil.socket.executeAsUser(handler, userId, ...parameters);\n      LogUtil.log('execForUser #3 - response', [resp]);\n      return resp;\n    } catch (error) {\n      LogUtil.error('execForUser #4 - error', [error]);\n      return null;\n    } finally {\n      LogUtil.log('execForUser #5 - success', []);\n      // Always clean up, even if there was an error\n      SocketUtil._activeExecutions.delete(executionKey);\n    }\n  }\n\n  /**\n   * Serializes an object for transport, handling Roll objects properly\n   * @param {*} data - The data to serialize\n   * @returns {*} - Serialized data\n   */\n  static serializeForTransport(data, hasRolls=false) { \n    LogUtil.log('serializeForTransport', [data, hasRolls]);\n    // Handle null or undefined\n    if (data == null) return data;\n    \n    if (hasRolls && data.rolls && Array.isArray(data.rolls)) {\n      // data.rolls = data.rolls.map(r => SocketUtil.serializeForTransport(r));\n      \n      data.rolls = data.rolls.map(r => {\n        if(r instanceof Roll){\n          let serialized = r.toJSON();\n          return serialized;\n        }else{\n          return r;\n        }\n      });\n    }\n    \n    return data;\n  }\n\n  /**\n   * Deserializes data received from transport, reconstructing Roll objects\n   * @param {*} data - The serialized data\n   * @returns {*} - Deserialized data with reconstructed objects\n   */\n  static deserializeFromTransport(data, hasRolls=false) {\n    LogUtil.log('deserializeFromTransport', [data, hasRolls]);\n    let result = { ...data };\n    if (!data) return result;\n\n    if(hasRolls && data.rolls && data.rolls.length > 0){\n      const rolls = result.rolls.map(r => {\n        let roll = r;\n        if(typeof r === 'string'){\n          roll = Roll.fromJSON(r);\n        } else if (r instanceof Roll) {\n          roll = r;  // Already a Roll object\n        } else {\n          // Object that needs to be converted to Roll\n          roll = Roll.fromJSON(JSON.stringify(r));\n        }\n        return roll;\n      })\n      result.rolls = [...rolls];\n      return result;\n    }\n    \n    return result;\n  }\n\n}\n","import { SocketUtil } from './SocketUtil.mjs';\n\n/**\n * Utility class for managing dice configurations across users\n */\nexport class DiceConfigUtil {\n  /**\n   * @type {Object} Current user's dice configuration\n   */\n  static diceConfig = {};\n  \n  /**\n   * @type {Object} All player dice configurations (GM only)\n   */\n  static playerDiceConfigs = {};\n  \n  /**\n   * Initialize the dice configuration for current user\n   */\n  static initialize() {\n    this.setDiceConfig();\n  }\n  \n  /**\n   * Set dice configuration from client settings\n   * @returns {Object} The dice configuration\n   */\n  static setDiceConfig() {\n    if (!game.user) return {};\n    \n    const clientSettings = game.settings.storage.get(\"client\");\n    this.diceConfig = clientSettings[`core.diceConfiguration`] || '';\n    \n    return this.diceConfig;\n  }\n  \n  /**\n   * Get the current user's dice configuration\n   * @returns {Object} The dice configuration\n   */\n  static getDiceConfig() {\n    if (!game.user) return {};\n    \n    // Ensure we have the latest configuration\n    this.setDiceConfig();\n    \n    // If GM, send config to GMs via socket\n    if (game.user.isGM) {\n      this._sendDiceConfigToGMs();\n    }\n    \n    return this.diceConfig;\n  }\n  \n  /**\n   * Send dice configuration to all GMs\n   * @private\n   */\n  static _sendDiceConfigToGMs() {\n    SocketUtil.execForGMs('receiveDiceConfig', game.user.id, this.diceConfig);\n  }\n  \n  /**\n   * Receive and store dice configuration from a player\n   * @param {string} userId - The user ID\n   * @param {string} diceConfig - The serialized dice configuration\n   */\n  static receiveDiceConfig(userId, diceConfig) {\n    if (game.user?.isGM || userId === game.user?.id) {\n      this.playerDiceConfigs[userId] = diceConfig ? JSON.parse(diceConfig) : {};\n    }\n  }\n  \n  /**\n   * Get dice configuration for a specific user\n   * @param {string} userId - The user ID\n   * @returns {Object} The user's dice configuration\n   */\n  static getUserDiceConfig(userId) {\n    if (userId === game.user?.id) {\n      return this.diceConfig;\n    }\n    \n    return this.playerDiceConfigs[userId] || {};\n  }\n  \n  /**\n   * Request dice configuration from a specific user\n   * @param {string} userId - The user ID to request from\n   */\n  static requestDiceConfigFromUser(userId) {\n    SocketUtil.execForUser('getDiceConfig', userId);\n  }\n  \n  /**\n   * Request dice configuration from all active non-GM users\n   */\n  static requestDiceConfigFromAllPlayers() {\n    if (!game.user?.isGM) return;\n    \n    game.users.forEach(user => {\n      if (user.active && !user.isGM && user.id !== game.user.id) {\n        this.requestDiceConfigFromUser(user.id);\n      }\n    });\n  }\n  \n  /**\n   * Clear all stored player dice configurations\n   */\n  static clearPlayerConfigs() {\n    this.playerDiceConfigs = {};\n  }\n  \n  /**\n   * Check if a user has dice configuration stored\n   * @param {string} userId - The user ID\n   * @returns {boolean} True if configuration exists\n   */\n  static hasUserConfig(userId) {\n    if (userId === game.user?.id) {\n      return !!this.diceConfig;\n    }\n    \n    return !!this.playerDiceConfigs[userId];\n  }\n}","import { getSettings } from \"../../constants/Settings.mjs\";\nimport { LogUtil } from \"./LogUtil.mjs\";\nimport { SettingsUtil } from \"./SettingsUtil.mjs\";\nimport { SocketUtil } from \"./SocketUtil.mjs\";\n\n/**\n * Utility class providing general-purpose functionality for the module */\nexport class GeneralUtil {\n  /**\n   * Checks if module is currently installed and active\n   * @param {string} moduleName \n   * @returns {boolean}\n   */\n  static isModuleOn(moduleName){\n    const module = game.modules?.get(moduleName);\n    LogUtil.log('isModuleOn', [moduleName, module, module?.active]);\n    return module?.active ? true : false;\n  }\n\n  /**\n   * Finds and returns the first element matching the selector within the parent element\n   * @param {HTMLElement} parent - The parent element to search within\n   * @param {string} selector - CSS selector string\n   * @returns {HTMLElement|null} The first matching element or null if not found\n   */\n  static html(parent, selector) {\n    return parent.querySelector(selector);\n  }\n\n  /**\n   * Gets the full width of an element including margins and borders\n   * @param {HTMLElement} element - The element to measure\n   * @returns {number} The full width in pixels\n   */\n  static getFullWidth(element) {\n    const style = window.getComputedStyle(element);\n    if (style.width === '0px') {\n      return 0;\n    }\n    return element.offsetWidth;\n  }\n\n  /**\n   * Prevents dialog flicker by applying opacity transition\n   * @param {HTMLElement} element - The dialog element to apply the transition to\n   * @param {number} delay - Delay in milliseconds before fading in (default: 100)\n   */\n  static preventDialogFlicker(element, delay = 0) {\n    if (!element) return;\n\n    element.style.opacity = '0';\n    element.style.transition = 'opacity 0.15s ease-in';\n\n    requestAnimationFrame(() => {\n      if (element) {\n        element.style.opacity = '1';\n      }\n    });\n  }\n\n  /**\n   * Adds CSS variables to a style element\n   * @param {string} varName \n   * @param {string} varValue \n   */\n  static addCSSVars(varName, varValue) {\n    let bodyStyle = document.querySelector('style#flash5e-vars');\n    \n    if (!bodyStyle) {\n      const body = document.querySelector('body.flash5e');\n      if(!body){return}\n      \n      const existingStyle = body.querySelector('style#flash5e-vars');\n      if (existingStyle) {\n        existingStyle.remove();\n      }\n      \n      bodyStyle = document.createElement('style');\n      bodyStyle.id = 'flash5e-vars';\n      bodyStyle.textContent = 'body.flash5e {\\n}\\n';\n      body.prepend(bodyStyle);\n    }\n    \n    let cssText = bodyStyle.textContent;\n    \n    let ruleStart = cssText.indexOf('body.flash5e {');\n    let ruleEnd = cssText.indexOf('}', ruleStart);\n    \n    if (ruleStart === -1) {\n      cssText = 'body.flash5e {\\n}\\n';\n      ruleStart = 0;\n      ruleEnd = cssText.indexOf('}');\n    }\n    \n    const rulePart = cssText.substring(ruleStart + 'body.flash5e {'.length, ruleEnd);\n    \n    const declarations = rulePart.split(';')\n      .map(decl => decl.trim())\n      .filter(decl => decl !== '');\n    \n    const varsMap = {};\n    declarations.forEach(decl => {\n      const parts = decl.split(':');\n      if (parts.length >= 2) {\n        const name = parts[0].trim();\n        const value = parts.slice(1).join(':').trim(); // Handle values that might contain colons\n        if (name) varsMap[name] = value;\n      }\n    });\n    \n    if (varName.includes('i18n') && \n        typeof varValue === 'string' && \n        !varValue.startsWith('\"') && \n        !varValue.startsWith(\"'\") && \n        !varValue.match(/^url\\(|^rgba?\\(|^hsla?\\(/)) {\n      varValue = `\"${varValue}\"`;\n    }\n    \n    varsMap[varName] = varValue;\n    \n    const newRuleContent = Object.entries(varsMap)\n      .map(([name, value]) => `  ${name}: ${value};`)\n      .join('\\n');\n    \n    const newCss = \n      cssText.substring(0, ruleStart) + \n      'body.flash5e {\\n' + \n      newRuleContent + \n      '\\n}' + \n      cssText.substring(ruleEnd + 1);\n    \n    bodyStyle.textContent = newCss;\n  }\n  \n  /**\n   * Gets the offset bottom of an element\n   * @param {HTMLElement} element \n   * @returns {number}\n   */\n  static getOffsetBottom(element) {\n    const offsetTop = element.offsetTop;\n    const elementHeight = element.offsetHeight;\n    return window.innerHeight - (offsetTop + elementHeight);\n  }\n\n  /**\n   * Retrieves a list of all available fonts\n   * @returns {Promise<string[]>}\n   */\n  static async getAllFonts() {\n    const foundryFonts = new Set(Object.keys(CONFIG.fontDefinitions));\n    const customFontsObj = game.settings.get(\"core\", \"fonts\") || {};\n    const customFonts = Object.entries(customFontsObj).map(([fontFamily]) => fontFamily);\n  \n    const cssImportedFonts = await this.processStyleSheets();\n  \n    const allFonts = Array.from(new Set([\n      ...foundryFonts,\n      ...customFonts,\n      ...cssImportedFonts\n    ]))\n    .filter(f => !/FontAwesome|Font Awesome|FoundryVTT/.test(f))\n    .map(f => f.replace(/['\"]/g, '').trim())\n    .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));\n\n    return allFonts || [];\n  }\n\n  // Helper function to format font names\n  /**\n   * Formats a font name by cleaning it and wrapping it in quotes if it contains spaces\n   * @param {string} fontName - The font name to format\n   * @returns {string} The formatted font name\n   */\n  static wrapFontName = (fontName) => {\n    const cleanName = fontName.replace(/['\"`]/g, '');\n    return cleanName.includes(' ') ? `\"${cleanName}\"` : cleanName;\n  }\n\n  /**\n   * Adds custom CSS to a style element\n   * @param {string} content - CSS content to add\n   * @param {string} [id='flash5e-custom-css'] - ID for the style element\n   * @param {boolean} [checkForDuplicates=true] - Whether to check for duplicate rules\n   */\n  static addCustomCSS(content, id = 'flash5e-custom-css', checkForDuplicates = true) {\n    if (!content) {\n      return;\n    }\n    \n    let customStyle = document.querySelector('#' + id);\n    \n    if (!customStyle) {\n      customStyle = document.createElement('style');\n      customStyle.id = id;\n      customStyle.textContent = '';\n      document.head.appendChild(customStyle);\n    }\n\n    const importRegex = /@import\\s+(?:url\\()?\\s*['\"]?[^'\")]+['\"]?\\s*\\)?\\s*;/g;\n    const imports = [];\n    let contentWithoutImports = content;\n    let match;\n    while ((match = importRegex.exec(content)) !== null) {\n      imports.push(match[0]);\n    }\n    \n    contentWithoutImports = content.replace(importRegex, '').trim();\n    \n    if (!checkForDuplicates) {\n      customStyle.textContent = imports.join('\\n') + (imports.length ? '\\n\\n' : '') + contentWithoutImports;\n      return;\n    }\n    \n    if (!customStyle.textContent.includes(contentWithoutImports)) {\n      const currentContent = customStyle.textContent;\n      const existingImports = [];\n      let currentMatch;\n      while ((currentMatch = importRegex.exec(currentContent)) !== null) {\n        existingImports.push(currentMatch[0]);\n      }\n      \n      const currentContentWithoutImports = currentContent.replace(importRegex, '').trim();\n      const newImports = imports.filter(imp => !existingImports.includes(imp));\n      const allImports = [...existingImports, ...newImports];\n      customStyle.textContent = allImports.join('\\n') + \n                               (allImports.length ? '\\n\\n' : '') + \n                               currentContentWithoutImports +\n                               (currentContentWithoutImports && contentWithoutImports ? '\\n\\n' : '') +\n                               contentWithoutImports;\n    }\n  }\n  \n  /**\n   * Performs a smooth scroll with custom duration\n   * @param {HTMLElement} element - The element to scroll\n   * @param {number} to - The target scroll position\n   * @param {string} [direction=\"horizontal\"] - The scroll direction (\"horizontal\" or \"vertical\")\n   * @param {number} [duration=300] - Duration of the animation in milliseconds\n   * @param {Function} [onComplete] - Optional callback to run when animation completes\n   * @returns {number} Animation ID that can be used to cancel the animation\n   */\n  static smoothScrollTo(element, to, direction = \"horizontal\", duration = 300, onComplete = null) {\n    // Cancel any existing animation if it has the same ID as the element\n    const animationId = element.dataset.scrollAnimationId;\n    if (animationId) {\n      cancelAnimationFrame(Number(animationId));\n    }\n    \n    // Determine if we're scrolling horizontally or vertically\n    const isHorizontal = direction === \"horizontal\";\n    const start = isHorizontal ? element.scrollLeft : element.scrollTop;\n    const change = to - start;\n    \n    // If there's no change or the element isn't scrollable, exit early\n    if (change === 0) {\n      if (onComplete) onComplete();\n      return null;\n    }\n    \n    const startTime = performance.now();\n    \n    const animateScroll = (currentTime) => {\n      const elapsedTime = currentTime - startTime;\n      \n      if (elapsedTime >= duration) {\n        if (isHorizontal) {\n          element.scrollLeft = to;\n        } else {\n          element.scrollTop = to;\n        }\n        \n        delete element.dataset.scrollAnimationId;\n        if (onComplete) onComplete();\n        return;\n      }\n      \n      const progress = elapsedTime / duration;\n      const easeProgress = progress < 0.5 \n        ? 2 * progress * progress \n        : 1 - Math.pow(-2 * progress + 2, 2) / 2;\n      \n      if (isHorizontal) {\n        element.scrollLeft = start + change * easeProgress;\n      } else {\n        element.scrollTop = start + change * easeProgress;\n      }\n      \n      const newAnimationId = requestAnimationFrame(animateScroll);\n      element.dataset.scrollAnimationId = newAnimationId;\n      return newAnimationId;\n    };\n    \n    const newAnimationId = requestAnimationFrame(animateScroll);\n    element.dataset.scrollAnimationId = newAnimationId;\n    return newAnimationId;\n  }\n\n  /**\n   * Opens a confirmation dialog to reload the page using DialogV2\n   * @param {string} [title=\"\"] - The title of the confirmation dialog\n   * @param {string} [content=\"\"] - The content message\n   * @param {Object} [options={}] - Additional dialog options\n   * @returns {Promise<boolean>} Resolves to true if confirmed, false otherwise\n   */\n  static confirmReload(\n    title = game.i18n.localize(\"FLASH_ROLLS.ui.reloadRequiredTitle\"), \n    content = game.i18n.localize(\"FLASH_ROLLS.ui.reloadRequiredLabel\"),\n    options = {}) {\n    \n    const dialogConfig = {\n      window: {\n        title\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      },\n      content,\n      yes: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.reloadButton\"),\n        callback: () => {\n          LogUtil.log(\"Reloading page after confirmation\");\n          window.location.reload();\n          return true;\n        }\n      },\n      no: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.cancelButton\"),\n        callback: () => false\n      },\n      defaultYes: false,\n      rejectClose: false\n    };\n    \n    mergeObject(dialogConfig, options);\n    return foundry.applications.api.DialogV2.confirm(dialogConfig);\n  }\n\n  /**\n   * Alias for Foundry's method to render Handlebars template\n   * @param {string} templatePath \n   * @param {Object} data \n   * @returns {Promise<string>} Rendered template HTML\n   */\n  static renderTemplate(templatePath, data){\n    return foundry.applications.handlebars.renderTemplate(templatePath, data);\n  }\n\n  /**\n   * Alias for Foundry's method to load Handlebars template\n   * @param {string} templatePath \n   * @returns {Promise<HandlebarsTemplate>} Loaded template object\n   */\n  static loadTemplate(templatePath){\n    return foundry.applications.handlebars.loadTemplate(templatePath);\n  }\n\n  /**\n   * Alias for Foundry's method to load Handlebars template\n   * @param {string[]} templatePaths \n   * @returns {Promise<HandlebarsTemplate>} Loaded template object\n   */\n  static loadTemplates(templatePaths){\n    if(!Array.isArray(templatePaths)) templatePaths = [templatePaths];\n    return foundry.applications.handlebars.loadTemplates(templatePaths);\n  }\n\n  /**\n   * Validates if a string is a valid CSS rule or selector\n   * @param {string} cssString - CSS rule or selector to validate\n   * @return {boolean} Whether the CSS is valid\n   */\n  static isValidCSSRule(cssString) {\n    if (!cssString || typeof cssString !== \"string\") return false;\n    const trimmedCSS = cssString.trim();\n    if (!trimmedCSS) return false;\n    try {\n      const style = document.createElement(\"style\");\n      const testCSS = `${trimmedCSS} { color: inherit; }`;\n      style.textContent = testCSS;\n      document.head.appendChild(style);\n      const isValid = Boolean(style.sheet && style.sheet.cssRules && style.sheet.cssRules.length > 0);\n      document.head.removeChild(style);\n      return isValid;\n    } catch (error) {\n      LogUtil.log(\"CSS validation error:\", [error, cssString]);\n      return false;\n    }\n  }\n\n  /**\n   * Processes CSS rules with nested selectors to create valid CSS for multiple target selectors\n   * @param {string} cssRules - CSS rules that may contain nested selectors\n   * @param {string} targetSelectors - Comma-separated list of selectors to apply the rules to\n   * @return {string} Valid CSS with properly combined selectors\n   */\n  static processCSSRules(cssRules, targetSelectors) {\n    if (!cssRules || !targetSelectors) return \"\";\n    const parsedCSS = this.#parseCSS(cssRules);\n    const mainStyle = targetSelectors + \" {\\n\" + parsedCSS.baseProperties.join(\"\\n\") + \"\\n}\";\n    const processedRules = [];\n    const rulesByContent = new Map();\n    \n    parsedCSS.nestedRules.forEach(rule => {\n      const { selector, content } = rule;\n      \n      if (selector.startsWith(\"&\")) {\n        const pseudoSelector = selector.substring(1);\n        const combinedSelectors = targetSelectors.split(\",\")\n          .map(s => s.trim())\n          .filter(Boolean)\n          .map(s => s + pseudoSelector)\n          .join(\", \");\n        \n        processedRules.push(`${combinedSelectors} {\\n${content}\\n}`);\n        return;\n      }\n      \n      if (!rulesByContent.has(content)) {\n        rulesByContent.set(content, []);\n      }\n      \n      const selectors = selector.split(\",\").map(s => s.trim());\n      const targetList = targetSelectors.split(\",\").map(s => s.trim()).filter(Boolean);\n      \n      selectors.forEach(nestedSelector => {\n        targetList.forEach(targetSelector => {\n          rulesByContent.get(content).push(`${targetSelector} ${nestedSelector}`);\n        });\n      });\n    });\n    \n    rulesByContent.forEach((selectors, content) => {\n      processedRules.push(`${selectors.join(\", \")} {\\n${content}\\n}`);\n    });\n    \n    return mainStyle + \"\\n\\n\" + processedRules.join(\"\\n\\n\");\n  }\n  \n  /**\n   * Parses CSS string into a structured format with base properties and nested rules\n   * @param {string} css - CSS string to parse\n   * @return {Object} Object with baseProperties array and nestedRules array\n   * @private\n   */\n  static #parseCSS(css) {\n    const baseProperties = [];\n    const nestedRules = [];\n    const lines = css.split(\"\\n\");\n    \n    let currentNested = null;\n    let braceCount = 0;\n    \n    for (let i = 0; i < lines.length; i++) {\n      const line = lines[i].trim();\n      if (!line) continue;\n      \n      const openBraces = (line.match(/{/g) || []).length;\n      const closeBraces = (line.match(/}/g) || []).length;\n      \n      if (line.includes(\"{\") && !currentNested) {\n        const selector = line.substring(0, line.indexOf(\"{\")).trim();\n        currentNested = { selector, content: \"\", startLine: i };\n        braceCount = 1;\n        \n        const contentAfterBrace = line.substring(line.indexOf(\"{\") + 1).trim();\n        if (contentAfterBrace && !contentAfterBrace.includes(\"}\")) {\n          currentNested.content += contentAfterBrace + \"\\n\";\n        }\n      } else if (currentNested) {\n        braceCount += openBraces - closeBraces;\n        \n        if (braceCount > 0) {\n          currentNested.content += line + \"\\n\";\n        } \n        else {\n          currentNested.content = currentNested.content.replace(/}\\s*$/, \"\").trim();\n          nestedRules.push(currentNested);\n          currentNested = null;\n        }\n      } else if (!line.includes(\"{\") && !line.includes(\"}\")) {\n        baseProperties.push(line);\n      }\n    }\n    \n    return { baseProperties, nestedRules };\n  }\n\n  /**\n   * Get the player owner of an actor\n   * @param {Actor} actor \n   * @returns {User|null}\n   */\n  static getActorOwner(actor) {\n    const ownership = actor.ownership || {};\n\n    for (const [userId, level] of Object.entries(ownership)) {\n      if (level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER) {\n        const user = game.users.get(userId);\n        if (user && !user.isGM) {\n          return user;\n        }\n      }\n    }\n\n    if(ownership?.default >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){\n      const user = game.users.filter(user => !user.isGM)[0];\n      if (user) {\n        return user;\n      }\n    }\n    \n    return null;\n  }\n\n  /**\n   * Opens a confirmation dialog to reload the page using DialogV2\n   * @param {string} [title=\"\"] - The title of the confirmation dialog\n   * @param {string} [content=\"\"] - The content message\n   * @param {Object} [options={}] - Additional dialog options\n   * @returns {Promise<boolean>} Resolves to true if confirmed, false otherwise\n   */\n  static confirmReload(\n    title = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.reloadRequiredTitle\"), \n    content = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.reloadRequiredLabel\"),\n    options = {}) {\n    \n    const dialogConfig = {\n      window: {\n        title\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      },\n      content,\n      yes: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.buttons.reloadButton\"),\n        callback: () => {\n          LogUtil.log(\"Reloading page after confirmation\");\n          window.location.reload();\n          return true;\n        }\n      },\n      no: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.buttons.cancelButton\"),\n        callback: () => false\n      },\n      defaultYes: false,\n      rejectClose: false\n    };\n    \n    mergeObject(dialogConfig, options);\n    return foundry.applications.api.DialogV2.confirm(dialogConfig);\n  }\n\n  /**\n   * Removes the MeasuredTemplate \n   * @param {Item5e} item \n   */\n  static async removeTemplateForItem (item) {\n    const SETTINGS = getSettings();\n    const removeTemplateSettingOn = SettingsUtil.get(SETTINGS.removeTemplate.tag);\n    LogUtil.log(\"removeTemplateForItem\", [item, removeTemplateSettingOn]);\n    if(!removeTemplateSettingOn){ return; }\n\n    // If not GM, send request to GM via existing socket\n    if (!game.user.isGM) {\n      LogUtil.log(\"removeTemplateForItem - requesting GM to remove template\", [item?.uuid]);\n      SocketUtil.execForGMs(\"removeTemplate\", item?.uuid);\n      return;\n    }\n    \n    try {\n      // Get templates that match this item UUID\n      const templates = canvas.templates.objects.children.filter(mt => {\n        return mt.document.flags.dnd5e.item === item?.uuid;\n      });\n\n      if(templates.length > 0){\n        // Double-check that templates still exist in the scene before deletion\n        const templateIds = templates.map(t => t.id);\n        const existingTemplates = canvas.scene.templates.filter(t => templateIds.includes(t.id));\n        \n        if (existingTemplates.length > 0) {\n          LogUtil.log(\"removeTemplateForItem - removing templates\", [item?.uuid, existingTemplates.length]);\n          await canvas.scene.deleteEmbeddedDocuments('MeasuredTemplate', existingTemplates.map(t => t.id));\n        } else {\n          LogUtil.log(\"removeTemplateForItem - templates already removed\", [item?.uuid]);\n        }\n      }\n    } catch (error) {\n      LogUtil.log(\"removeTemplateForItem - template not found or already deleted\", [item?.uuid, error.message]);\n    }\n    \n  }\n\n  /**\n   * Removes template by UUID - called via socket from player side\n   * @param {string} itemUuid - The UUID of the item whose template should be removed\n   */\n  static async removeTemplate(itemUuid) {\n    LogUtil.log(\"removeTemplate\", [itemUuid]);\n    try {\n      const item = await fromUuid(itemUuid);\n      if (item && game.user.isGM) {\n        return GeneralUtil.removeTemplateForItem(item);\n      }\n    } catch (error) {\n      LogUtil.error(\"removeTemplate - error\", [error]);\n    }\n  }\n\n  static areSkipKeysPressed(event){\n    if (!event) return false;\n\n    // Use D&D 5e's areKeysPressed function to properly handle all platforms including Mac Cmd key\n    const { areKeysPressed } = game.dnd5e.utils || {};\n    if (!areKeysPressed) {\n      // Fallback if function not available\n      return event.shiftKey || event.altKey || event.ctrlKey || event.metaKey || false;\n    }\n\n    return areKeysPressed(event, \"skipDialogNormal\") ||      // Shift\n           areKeysPressed(event, \"skipDialogAdvantage\") ||   // Alt\n           areKeysPressed(event, \"skipDialogDisadvantage\");  // Ctrl/Cmd\n  }\n}\n","import { MODULE_ACTION_ICONS, ACTOR_ACTION_ICONS, ICON_TYPES, getIconConfiguration, getDefaultIconLayout } from '../../constants/IconMappings.mjs';\nimport { SettingsUtil } from './SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\n\n/**\n * Utility class for managing icon layout and drag-and-drop functionality\n */\nexport class IconLayoutUtil {\n\n  /**\n   * Initialize drag and drop functionality for icon lists\n   * @param {HTMLElement} container - The settings container element\n   */\n  static initializeDragAndDrop(container) {\n    const iconLists = container.querySelectorAll('.sortable-icon-list');\n\n    iconLists.forEach(list => {\n      this.setupListEventListeners(list);\n    });\n\n    // Setup toggle functionality\n    const toggles = container.querySelectorAll('.icon-toggle');\n    toggles.forEach(toggle => {\n      toggle.addEventListener('change', this.handleIconToggle.bind(this));\n    });\n  }\n\n  /**\n   * Setup event listeners for a sortable list\n   * @param {HTMLElement} list - The list element\n   */\n  static setupListEventListeners(list) {\n    list.addEventListener('dragover', this.handleDragOver.bind(this));\n    list.addEventListener('drop', this.handleDrop.bind(this));\n    list.addEventListener('dragenter', this.handleDragEnter.bind(this));\n    list.addEventListener('dragleave', this.handleDragLeave.bind(this));\n\n    // Setup draggable items\n    const items = list.querySelectorAll('.icon-item');\n    items.forEach(item => {\n      item.addEventListener('dragstart', this.handleDragStart.bind(this));\n      item.addEventListener('dragend', this.handleDragEnd.bind(this));\n    });\n  }\n\n  /**\n   * Handle drag start event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDragStart(event) {\n    const item = event.target.closest('.icon-item');\n    if (!item) return;\n\n    item.classList.add('dragging');\n    event.dataTransfer.effectAllowed = 'move';\n    event.dataTransfer.setData('text/html', item.outerHTML);\n    event.dataTransfer.setData('text/plain', JSON.stringify({\n      iconId: item.dataset.iconId,\n      iconType: item.closest('.sortable-icon-list').dataset.iconType,\n      order: parseInt(item.dataset.order)\n    }));\n  }\n\n  /**\n   * Handle drag end event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDragEnd(event) {\n    const item = event.target.closest('.icon-item');\n    if (!item) return;\n\n    item.classList.remove('dragging');\n\n    // Clean up any drag state\n    document.querySelectorAll('.sortable-icon-list').forEach(list => {\n      list.classList.remove('drag-over');\n    });\n\n    // Remove any placeholders\n    document.querySelectorAll('.drag-placeholder').forEach(placeholder => {\n      placeholder.remove();\n    });\n  }\n\n  /**\n   * Handle drag over event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDragOver(event) {\n    event.preventDefault();\n    event.dataTransfer.dropEffect = 'move';\n\n    const list = event.currentTarget;\n    const draggingItem = document.querySelector('.icon-item.dragging');\n    if (!draggingItem) return;\n\n    // Only allow dropping within the same icon type\n    const draggedIconType = draggingItem.closest('.sortable-icon-list').dataset.iconType;\n    const targetIconType = list.dataset.iconType;\n\n    if (draggedIconType !== targetIconType) {\n      event.dataTransfer.dropEffect = 'none';\n      return;\n    }\n\n    const afterElement = this.getDragAfterElement(list, event.clientY);\n    if (afterElement == null) {\n      list.appendChild(draggingItem);\n    } else {\n      list.insertBefore(draggingItem, afterElement);\n    }\n  }\n\n  /**\n   * Handle drag enter event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDragEnter(event) {\n    event.preventDefault();\n    const list = event.currentTarget;\n    list.classList.add('drag-over');\n  }\n\n  /**\n   * Handle drag leave event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDragLeave(event) {\n    const list = event.currentTarget;\n    const rect = list.getBoundingClientRect();\n\n    if (event.clientX < rect.left || event.clientX > rect.right ||\n        event.clientY < rect.top || event.clientY > rect.bottom) {\n      list.classList.remove('drag-over');\n    }\n  }\n\n  /**\n   * Handle drop event\n   * @param {DragEvent} event - The drag event\n   */\n  static handleDrop(event) {\n    event.preventDefault();\n    const list = event.currentTarget;\n    list.classList.remove('drag-over');\n\n    // Update the order and save settings\n    this.updateIconOrder(list);\n  }\n\n  /**\n   * Get the element that the dragged item should be inserted before\n   * @param {HTMLElement} container - The container element\n   * @param {number} y - The y coordinate\n   * @returns {HTMLElement|null} The element to insert before\n   */\n  static getDragAfterElement(container, y) {\n    const draggableElements = [...container.querySelectorAll('.icon-item:not(.dragging)')];\n\n    return draggableElements.reduce((closest, child) => {\n      const box = child.getBoundingClientRect();\n      const offset = y - box.top - box.height / 2;\n\n      if (offset < 0 && offset > closest.offset) {\n        return { offset: offset, element: child };\n      } else {\n        return closest;\n      }\n    }, { offset: Number.NEGATIVE_INFINITY }).element;\n  }\n\n  /**\n   * Handle icon toggle event\n   * @param {Event} event - The change event\n   */\n  static handleIconToggle(event) {\n    const toggle = event.target;\n    const iconItem = toggle.closest('.icon-item');\n    const isEnabled = toggle.checked;\n\n    // Update visual state\n    iconItem.dataset.enabled = isEnabled;\n    if (isEnabled) {\n      iconItem.classList.remove('disabled');\n    } else {\n      iconItem.classList.add('disabled');\n    }\n\n    // Update settings\n    const list = iconItem.closest('.sortable-icon-list');\n    this.updateIconOrder(list);\n  }\n\n  /**\n   * Update icon order in the list and save to settings\n   * @param {HTMLElement} list - The sortable list\n   */\n  static updateIconOrder(list) {\n    const iconType = list.dataset.iconType;\n    const items = [...list.querySelectorAll('.icon-item')];\n\n    const updatedIcons = items.map((item, index) => ({\n      id: item.dataset.iconId,\n      icon: this.getIconClass(item.dataset.iconId, iconType),\n      enabled: item.dataset.enabled === 'true',\n      order: index\n    }));\n\n    // Get current settings\n    const SETTINGS = getSettings();\n    const currentLayout = SettingsUtil.get(SETTINGS.menuIconsLayout.tag) || getDefaultIconLayout();\n\n    // Update the specific icon type\n    const updatedLayout = {\n      ...currentLayout,\n      [iconType]: updatedIcons\n    };\n\n    // Save to settings\n    SettingsUtil.set(SETTINGS.menuIconsLayout.tag, updatedLayout);\n\n    // Trigger menu refresh if needed\n    if (game.flashRolls?.menu) {\n      game.flashRolls.menu.render(false);\n    }\n  }\n\n  /**\n   * Get icon class for a given icon ID and type\n   * @param {string} iconId - The icon ID\n   * @param {string} iconType - The icon type\n   * @returns {string} The icon class\n   */\n  static getIconClass(iconId, iconType) {\n    const config = getIconConfiguration(iconId, iconType);\n    return config ? config.icon : '';\n  }\n\n  /**\n   * Get enabled icons in order for rendering\n   * @param {string} iconType - The icon type (moduleActions or actorActions)\n   * @returns {Array} Array of enabled icons in order\n   */\n  static getEnabledIcons(iconType) {\n    const SETTINGS = getSettings();\n    const layout = SettingsUtil.get(SETTINGS.menuIconsLayout.tag) || getDefaultIconLayout();\n    const icons = layout[iconType] || [];\n\n    return icons\n      .filter(icon => icon.enabled)\n      .sort((a, b) => a.order - b.order);\n  }\n\n  /**\n   * Get all icons (enabled and disabled) in order for settings display\n   * @param {string} iconType - The icon type\n   * @returns {Array} Array of all icons in order\n   */\n  static getAllIcons(iconType) {\n    const SETTINGS = getSettings();\n    const layout = SettingsUtil.get(SETTINGS.menuIconsLayout.tag) || getDefaultIconLayout();\n    const icons = layout[iconType] || [];\n\n    return icons.sort((a, b) => a.order - b.order);\n  }\n\n  /**\n   * Get icon configurations for template rendering\n   * @returns {Object} Icon configurations object\n   */\n  static getIconConfigurations() {\n    return {\n      moduleActions: MODULE_ACTION_ICONS,\n      actorActions: ACTOR_ACTION_ICONS\n    };\n  }\n\n  /**\n   * Reset icons to default layout\n   * @param {string} iconType - Optional icon type to reset, or all if not specified\n   */\n  static resetToDefault(iconType = null) {\n    const SETTINGS = getSettings();\n    const defaultLayout = getDefaultIconLayout();\n\n    if (iconType) {\n      const currentLayout = SettingsUtil.get(SETTINGS.menuIconsLayout.tag) || {};\n      const updatedLayout = {\n        ...currentLayout,\n        [iconType]: defaultLayout[iconType]\n      };\n      SettingsUtil.set(SETTINGS.menuIconsLayout.tag, updatedLayout);\n    } else {\n      SettingsUtil.set(SETTINGS.menuIconsLayout.tag, defaultLayout);\n    }\n  }\n}","import { getSettings } from \"../../../constants/Settings.mjs\";\nimport { getSettingMenus } from \"../../../constants/SettingMenus.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\"\nimport { SettingsUtil } from \"../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../utils/GeneralUtil.mjs\";\nimport { IconLayoutUtil } from \"../../utils/IconLayoutUtil.mjs\";\n\nconst { FormDataExtended } = foundry.utils;\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * Tabbed Settings Menu application for managing all module settings in a unified interface.\n * Provides a tabbed form interface for accessing all settings categories in one place.\n * @extends {HandlebarsApplicationMixin(ApplicationV2)}\n */ \nexport class ModuleSettingsMenu extends HandlebarsApplicationMixin(ApplicationV2) {\n  static #element;\n  static #activeTab;\n  static #requireReload;\n  static selectedTheme;\n\n  /**\n   * Default application options\n   * @static\n   */\n  static DEFAULT_OPTIONS = {\n    id: \"flash-rolls-settings\",\n    tag: \"form\",\n    window: {\n      icon: \"fas fa-cog\",\n      title: \"FLASH_ROLLS.settings.moduleSettingsMenu.title\",\n      contentClasses: [\"standard-form\", \"crlngn\", \"flash5e\", \"tabbed-settings\"],\n      resizable: true\n    },\n    position: {\n      width: 700,\n      height: \"auto\"\n    },\n    actions: {\n      redefine: ModuleSettingsMenu.#onReset\n    },\n    form: {\n      handler: ModuleSettingsMenu.#onSubmit,\n      closeOnSubmit: true\n    }\n  }\n\n  /**\n   * Template parts used for rendering the application\n   * @static\n   */\n  static PARTS = {\n    tabs: {\n      template: \"templates/generic/tab-navigation.hbs\",\n      isGMOnly: false\n    },\n    generalSettings: {\n      menuKey: \"generalSettings\",\n      template: \"modules/flash-rolls-5e/templates/settings-general.hbs\",\n      isGMOnly: true\n    },\n    interfaceSettings: {\n      menuKey: \"interfaceSettings\",\n      template: \"modules/flash-rolls-5e/templates/settings-interface.hbs\",\n      isGMOnly: true\n    },\n    groupRolls: {\n      menuKey: \"groupRollsSettings\",\n      template: \"modules/flash-rolls-5e/templates/settings-group-rolls.hbs\",\n      isGMOnly: true\n    },\n    rollRequests: {\n      menuKey: \"rollRequestsSettings\",\n      template: \"modules/flash-rolls-5e/templates/settings-roll-requests.hbs\",\n      isGMOnly: true\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n      isGMOnly: false\n    }\n  };\n\n  /**\n   * Tab configuration for the application\n   * @static\n   */\n  static TABS = {\n    primary: {\n      initial: \"interfaceSettings\",\n      tabs: ModuleSettingsMenu.#getTabs(),\n      labelPrefix: \"\"\n    }\n  };\n\n  /** @inheritDoc */\n  _configureRenderParts(options) {\n    const parts = super._configureRenderParts(options);\n    const restrictedTabs = ModuleSettingsMenu.getRestrictedTabs();\n\n    if(!game.user.isGM){\n      restrictedTabs.forEach(tab => {\n        delete parts[tab];\n      })\n    }\n\n    return parts;\n  }\n\n  /** @inheritDoc */\n  async _prepareContext(options) {\n    const context = await super._prepareContext(options);\n    context.activeTab = options.activeTab || Object.keys(context.tabs)[0];\n    context.isGM = game.user.isGM;\n    context.midiQolActive = GeneralUtil.isModuleOn(\"midi-qol\");\n    context.midiQolActiveWarning = game.i18n.localize(\"FLASH_ROLLS.notifications.midiQolActive\");\n    \n    return context;\n  }\n\n   /** @inheritDoc */\n   async _preparePartContext(partId, context, options) {\n    const partContext = await super._preparePartContext(partId, context, options);\n    if ( partId in context.tabs ) partContext.tab = partContext.tabs[partId];\n    const SETTINGS = getSettings();\n    const SETTINGS_MENUS = getSettingMenus();\n    const restrictedTabs = ModuleSettingsMenu.getRestrictedTabs();\n\n    if(!game.user.isGM){\n      restrictedTabs.forEach(tab => {\n        delete partContext.tabs[tab];\n      })\n    }\n    switch ( partId ) {\n      case \"tabs\": {\n        break;\n      }\n      case \"footer\": {\n        partContext.buttons = [\n          { type: \"button\", icon: \"\", label: \"FLASH_ROLLS.ui.buttons.reset\", action: 'redefine' },\n          { type: \"submit\", icon: \"\", label: \"FLASH_ROLLS.ui.buttons.save\" }\n        ];\n        break;\n      }\n      default: {\n        partContext.tab = partContext.tabs[partId];\n        const partKey = ModuleSettingsMenu.PARTS[partId]?.menuKey || null;\n        if(partKey){\n          const menuContext = ModuleSettingsMenu.getMenuContext(partKey);\n          \n          if (menuContext.fields) {\n            partContext.fields = {\n              ...partContext.fields,\n              ...menuContext.fields\n            }\n          }\n\n          if (menuContext.fieldDefaults) {\n            partContext.fieldDefaults = {\n              ...partContext.fieldDefaults,\n              ...menuContext.fieldDefaults\n            }\n          }\n\n          if (menuContext.fieldValues) {\n            Object.assign(partContext, menuContext.fieldValues);\n          }\n\n          // Add icon layout data for interface settings\n          if (partId === 'interfaceSettings') {\n            partContext.iconConfigs = IconLayoutUtil.getIconConfigurations();\n\n            // Build complete icon list from mappings, then apply saved settings\n            const configs = IconLayoutUtil.getIconConfigurations();\n            const SETTINGS = getSettings();\n            const defaultIconsLayout = SETTINGS.menuIconsLayout.default;\n            const savedSettings = partContext.menuIconsLayout || {};\n\n            // Create a function to merge icon configs with default and saved settings\n            const buildIconList = (iconType, iconConfigs) => {\n              const defaultIcons = defaultIconsLayout[iconType] || [];\n              const savedIcons = savedSettings[iconType] || [];\n\n              const defaultIconsMap = new Map(defaultIcons.map(icon => [icon.id, icon]));\n              const savedIconsMap = new Map(savedIcons.map(icon => [icon.id, icon]));\n\n              // Get all available icons from mappings\n              const allIcons = Object.keys(iconConfigs).map((iconId, index) => {\n                const config = iconConfigs[iconId];\n                const defaultIcon = defaultIconsMap.get(iconId);\n                const savedIcon = savedIconsMap.get(iconId);\n\n                return {\n                  id: iconId,\n                  icon: config.icon,\n                  // Priority: saved settings > default settings > disabled for new icons\n                  enabled: savedIcon ? savedIcon.enabled : (defaultIcon ? defaultIcon.enabled : false),\n                  order: savedIcon ? savedIcon.order : (defaultIcon ? defaultIcon.order : index),\n                  label: game.i18n.localize(config.labelKey || iconId)\n                };\n              });\n\n              // Sort by order\n              return allIcons.sort((a, b) => a.order - b.order);\n            };\n\n            partContext.menuIconsLayout = {\n              moduleActions: buildIconList('moduleActions', configs.moduleActions),\n              actorActions: buildIconList('actorActions', configs.actorActions)\n            };\n          }\n\n          partContext.sidebarTabs = Object.values(foundry.applications?.sidebar?.tabs || {}).map(tab => ({\n            tabName: tab.tabName,\n            name: tab.name,\n            hideForGM: false,\n            hideForPlayer: false,\n            localizedName: `FLASH_ROLLS.settings.sidebarTabs.${tab.name}`\n          }));\n        }\n        break;\n      }\n    }\n    LogUtil.log(\"_preparePartContext\", [partContext, partId]);\n    return partContext;\n  }\n\n  /**\n   * Retrieves the context object containing fields, field values, and field defaults for a specific menu\n   * @param {string} menuKey - The key of the setting menu\n   * @returns {object} The context object containing fields, field values, and field defaults\n   */\n  static getMenuContext(menuKey){\n    const SETTINGS = getSettings();\n    const fieldNames = SETTINGS[menuKey]?.fields || null;\n    if(!fieldNames) return {};\n    const fields = {};\n    const fieldValues = {};\n    const fieldDefaults = {};\n\n    fieldNames.forEach((fieldName) => {\n      if(SETTINGS[fieldName]) {\n        const value = SettingsUtil.get(SETTINGS[fieldName].tag);\n        fields[fieldName] = SETTINGS[fieldName];\n        fieldValues[fieldName] = value!== undefined ? value : SETTINGS[fieldName].default;\n        fieldDefaults[fieldName] = SETTINGS[fieldName].default;\n      }\n    });\n\n    return {fields: fields, fieldValues: fieldValues, fieldDefaults: fieldDefaults};\n  }\n\n  /**\n   * Retrieves the keys of setting menus that are restricted to GMs\n   * @returns {string[]} Array of setting menu keys\n   */\n  static getRestrictedTabs(){\n    const restrictedTabs = [];\n    Object.entries(ModuleSettingsMenu.PARTS).forEach((entry, index) => {\n      if(entry[0]!==\"tabs\" && entry[0]!==\"footer\" && entry[1].isGMOnly){\n        restrictedTabs.push(entry[0]);\n      }\n    });\n    return restrictedTabs;\n  }\n\n  /**\n   * Handles post-render operations\n   * @protected\n   * @param {object} context - The render context\n   * @param {object} options - The render options\n   */\n  _onRender = (context, options) => {\n    const SETTINGS = getSettings();\n    ModuleSettingsMenu.#element = this.element;\n\n    const hintToggles = ModuleSettingsMenu.#element.querySelectorAll('.toggle-hint');\n    hintToggles.forEach(toggle => {\n      toggle.addEventListener('click', () => {\n        ModuleSettingsMenu.#element.querySelectorAll('p.hint').forEach(p => p.classList.toggle('shown'));\n      });\n    });\n\n    // Initialize icon drag and drop functionality\n    const iconContainer = ModuleSettingsMenu.#element.querySelector('.icon-arrangement-container');\n    if (iconContainer) {\n      IconLayoutUtil.initializeDragAndDrop(iconContainer);\n    }\n    \n    const selects = ModuleSettingsMenu.#element.querySelectorAll('select[data-current-value]');\n    selects.forEach(select => {\n      const currentValue = String(select.dataset.currentValue);\n      const option = select.querySelector(`option[value=\"${currentValue}\"]`);\n      if (option) {\n        option.selected = true;\n      }\n    });\n    \n    // Set up range input synchronization\n    this.#setupRangeInputs();\n  }\n\n  /**\n   * Set up synchronization between range sliders and number inputs\n   */\n  #setupRangeInputs() {\n    const rangeGroups = ModuleSettingsMenu.#element.querySelectorAll('.form-group.range');\n    rangeGroups.forEach(group => {\n      const rangeInput = group.querySelector('input[type=\"range\"]');\n      const valueInput = group.querySelector('input[type=\"number\"]');\n      this.#handleRangeInputs(rangeInput, valueInput);\n    });\n  }\n\n  /**\n   * Handle synchronization between range slider and number input\n   * @param {HTMLInputElement} rangeInput - The range slider input\n   * @param {HTMLInputElement} valueInput - The number input\n   */\n  #handleRangeInputs(rangeInput, valueInput) {\n    if (rangeInput && valueInput) {\n      const min = parseInt(rangeInput.min, 10);\n      const max = parseInt(rangeInput.max, 10);\n\n      // Listener for the range slider's input event\n      rangeInput.addEventListener('input', () => {\n        valueInput.value = rangeInput.value;\n      });\n\n      // Listener for the number input's input event (while typing)\n      valueInput.addEventListener('input', () => {\n        const currentValueString = valueInput.value;\n        if (currentValueString === \"\" || currentValueString === \"-\") {\n          return;\n        }\n        const currentValue = parseInt(currentValueString, 10);\n        if (!isNaN(currentValue) && currentValue >= min && currentValue <= max) {\n          rangeInput.value = currentValue;\n        }\n      });\n\n      // Listener for the number input's change event (after typing/blur/enter)\n      valueInput.addEventListener('change', () => {\n        let value = parseInt(valueInput.value, 10);\n\n        if (isNaN(value) || value < min) {\n          value = min;\n        } else if (value > max) {\n          value = max;\n        }\n        \n        valueInput.value = value; // Update the input field to the clamped/validated value\n        rangeInput.value = value; // Sync the slider\n      });\n\n      // Set initial value for the number input from the range slider\n      valueInput.value = rangeInput.value;\n    }\n  }\n\n  /**\n   * Handles form submission and updates left controls settings\n   * @private\n   * @static\n   * @param {Event} event - The form submission event\n   * @param {HTMLFormElement} form - The form element\n   * @param {FormData} formData - The form data object\n   * @returns {Promise<void>}\n   */\n  static async #onSubmit(event, form, formData) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    let confirmReload = ModuleSettingsMenu.updateSettings(formData);\n\n    if(confirmReload){\n      GeneralUtil.confirmReload();\n    }\n  }\n\n  static updateSettings(formData){\n    let confirmReload = false;\n    const SETTINGS = getSettings();\n    const html = ModuleSettingsMenu.#element;\n    const activeContent = html.querySelector(\".form-content.active\");\n    const activeTab = activeContent.dataset.tab;\n    ModuleSettingsMenu.#activeTab = activeTab;\n\n    if(!formData){\n      return;\n    }\n\n    // Convert FormData into an object with proper keys\n    let settings;\n    if (formData.object) {\n      settings = foundry.utils.expandObject(formData.object);\n    } \n\n    let fieldNames = [];\n\n    Object.entries(settings).forEach(([fieldName, value]) => {\n      // Skip auxiliary form fields like range value inputs\n      if(fieldName.endsWith('_value')) return;\n      \n      LogUtil.log(\"updateSettings #1\", [SETTINGS, SETTINGS[fieldName]]);\n      if(settings[fieldName] !== undefined && SETTINGS[fieldName]) {\n        const currSetting = SettingsUtil.get(SETTINGS[fieldName].tag);\n        SettingsUtil.set(SETTINGS[fieldName].tag, settings[fieldName]);\n        \n        if(SETTINGS[fieldName]?.requiresReload && currSetting !== settings[fieldName]){\n          confirmReload = true;\n        }\n      }\n    });\n\n    ui.notifications.info(game.i18n.localize('FLASH_ROLLS.notifications.settingsUpdated'));\n    return confirmReload;\n  }\n\n  /** @inheritDoc */\n  changeTab(tab, group, options) {\n    super.changeTab(tab, group, options);\n    ModuleSettingsMenu.#activeTab = tab;\n  }\n\n  /**\n   * Resets form fields to their default values\n   * @private\n   * @static\n   * @param {Event} a - The reset event\n   * @param {HTMLElement} b - The form element\n   * @returns {Promise<void>}\n   */\n  static async #onReset(a, b){\n    const SETTINGS = getSettings();\n    const html = ModuleSettingsMenu.#element;\n    const activeContent = html.querySelector(\".form-content.active\");\n    const activeTab = activeContent.dataset.tab;\n    const menuKey = ModuleSettingsMenu.PARTS[activeTab].menuKey;\n    const defaults = SETTINGS[menuKey].default;\n\n    const inputs = activeContent.querySelectorAll(\"input, select\");\n    inputs.forEach(inputField => {\n      inputField.value = defaults[inputField.name];\n      if(inputField.type==='checkbox'){\n        inputField.checked = defaults[inputField.name];\n      }\n    });\n\n    LogUtil.log(\"#onReset\", [ModuleSettingsMenu.#activeTab, activeTab, a, b]);\n  }\n\n  static #getTabs() {\n    const tabList = [];\n    Object.entries(ModuleSettingsMenu.PARTS).forEach(([key, value]) => {\n      if(value.menuKey) {\n        tabList.push({\n          id: key,\n          icon: '',\n          group: 'primary-tabs',\n          label: `FLASH_ROLLS.settings.moduleSettingsMenu.tabs.${key}`\n        })\n      }\n    })\n    return tabList;\n  }\n\n}\n","import { ModuleSettingsMenu } from '../components/ui/dialogs/ModuleSettingsMenu.mjs';\n\n// Opens Patreon URL when instantiated\nclass PatreonSupport extends FormApplication {\n  constructor(...args) {\n    super(...args);\n    window.open('https://www.patreon.com/c/carolingiandev/membership', '_blank');\n    this.close();\n  }\n  \n  render() {\n    this.close();\n    return this;\n  }\n}\n\nexport function getSettingMenus() {\n  return {\n    moduleSettingsMenu: {\n      tab: '',\n      tag: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      name: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"), \n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      icon: \"fas fa-cog\",  \n      propType: ModuleSettingsMenu,\n      restricted: true\n    },\n    supportPatreon: {\n      tab: '',\n      tag: game.i18n.localize(\"FLASH_ROLLS.settings.supportPatreon.label\"),\n      name: game.i18n.localize(\"FLASH_ROLLS.settings.supportPatreon.label\"),\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.supportPatreon.buttonLabel\"), \n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.supportPatreon.hint\"),\n      icon: \"fas fa-heart\",  \n      propType: PatreonSupport,\n      restricted: false\n    }\n  };\n}","import { MODULE_ID } from \"../../constants/General.mjs\";\nimport { HooksManager } from \"../core/HooksManager.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\n\n/**\n * Helper functions for module management\n */\nexport class ModuleHelpers {\n  static midiTimeout = null;\n\n  /**\n   * Check if a module is installed and active\n   * @param {string} moduleId - The module ID to check\n   * @returns {boolean} - True if the module is installed and active\n   */\n  static isModuleActive(moduleId) {\n    const module = game.modules.get(moduleId);\n    return module && module.active;\n  }\n\n  /**\n   * Get the MidiQOL API if available\n   * @returns {Object|null} - The MidiQOL API or null if not available\n   */\n  static getMidiQOL() {\n    if (this.isModuleActive('midi-qol') && typeof MidiQOL !== 'undefined') {\n      return MidiQOL;\n    }\n    return null;\n  }\n\n}","/**\n * Helper functions for the Flash Rolls 5e module\n */\nimport { MODULE, ROLL_TYPES } from '../../constants/General.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\n\n/**\n * Get display name for roll type with optional details\n * @param {string} rollType - The type of roll\n * @param {string} rollKey - Optional key for the specific roll (ability, skill, etc.)\n * @returns {string} Formatted display string\n */\nexport function getRollTypeDisplay(rollType, rollKey) {\n  let display = game.i18n.localize(`FLASH_ROLLS.rollTypes.${rollType}`) || rollType;\n  \n  // Normalize rollType to lowercase for consistent comparisons\n  const normalizedRollType = rollType?.toLowerCase();\n  \n  if (rollKey) {\n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        display += ` (${CONFIG.DND5E.skills[rollKey]?.label || rollKey})`;\n        break;\n      case ROLL_TYPES.SAVE:\n        display += ` (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n        break;\n      case ROLL_TYPES.ABILITY:\n        display += ` (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n        break;\n      case ROLL_TYPES.TOOL:\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          display += ` (${toolItem?.name || rollKey})`;\n        } else {\n          display += ` (${rollKey})`;\n        }\n        break;\n      case ROLL_TYPES.CUSTOM:\n        display = `${display}: ${rollKey}`;\n        break;\n    }\n  }\n  \n  return display;\n}\n\n/**\n * Get the full name for a rollKey based on roll type\n * @param {string} rollType - The type of roll (normalized to lowercase)\n * @param {string} rollKey - The key for the specific roll\n * @returns {string} Full name or original rollKey if not found\n */\nexport function getFullRollName(rollType, rollKey) {\n  if (!rollKey) return '';\n  \n  const normalizedRollType = rollType?.toLowerCase();\n  \n  switch (normalizedRollType) {\n    case ROLL_TYPES.SKILL:\n      return CONFIG.DND5E.skills[rollKey]?.label || rollKey;\n    case ROLL_TYPES.SAVE:\n    case ROLL_TYPES.SAVING_THROW:\n      return CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n    case ROLL_TYPES.ABILITY:\n    case ROLL_TYPES.ABILITY_CHECK:\n      return CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n    case ROLL_TYPES.TOOL:\n      const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n      if (toolData?.id) {\n        const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n        return toolItem?.name || rollKey;\n      }\n      return rollKey;\n    default:\n      return rollKey;\n  }\n}\n\n/**\n * Show batched notifications to player\n * @param {Array} pendingNotifications - Array of notification objects\n * @param {Function} getRollTypeDisplayFn - Function to get roll type display (default: getRollTypeDisplay)\n */\nexport function showBatchedNotifications(pendingNotifications, getRollTypeDisplayFn = getRollTypeDisplay) {\n  if (pendingNotifications.length === 0) return;\n  \n  // Group by roll type\n  const notificationsByType = {};\n  for (const notif of pendingNotifications) {\n    const key = `${notif.rollType}_${notif.rollKey || ''}`;\n    if (!notificationsByType[key]) {\n      notificationsByType[key] = {\n        rollType: notif.rollType,\n        rollKey: notif.rollKey,\n        actors: [],\n        gm: notif.gm\n      };\n    }\n    notificationsByType[key].actors.push(notif.actor);\n  }\n  \n  const entries = Object.values(notificationsByType);\n  if (entries.length === 1 && entries[0].actors.length === 1) {\n    // Single roll request - use original format\n    const entry = entries[0];\n    ui.notifications.info(game.i18n.format('FLASH_ROLLS.notifications.rollRequestReceived', {\n      gm: entry.gm,\n      rollType: getRollTypeDisplayFn(entry.rollType, entry.rollKey)\n    }));\n  } else {\n    // Multiple requests - create consolidated message\n    const messages = [];\n    for (const entry of entries) {\n      const rollTypeDisplay = getRollTypeDisplayFn(entry.rollType, entry.rollKey);\n      const actorNames = entry.actors.join(\", \");\n      messages.push(`${rollTypeDisplay} (${actorNames})`);\n    }\n    \n    ui.notifications.info(game.i18n.format('FLASH_ROLLS.notifications.rollRequestsReceivedMultiple', {\n      gm: entries[0].gm,\n      requests: messages.join(\"; \")\n    }));\n  }\n}\n\n/**\n * Check if an actor is owned by a player (not GM)\n * @param {Actor} actor - The actor to check\n * @returns {User|null} The player owner, or null if not player-owned\n */\nexport function getPlayerOwner(actor) {\n  const ownership = actor.ownership || {};\n  \n  for (const [userId, level] of Object.entries(ownership)) {\n    if (level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER) {\n      const user = game.users.get(userId);\n      if (user && !user.isGM) {\n        return user;\n      }\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Get actor stats for display (ability scores and modifiers)\n * @param {Actor} actor - The actor to get stats for\n * @returns {Array} Array of stat objects with name, value, and modifier\n */\nexport function getActorStats(actor) {\n  if (!actor?.system?.abilities) return [];\n  \n  return Object.entries(actor.system.abilities).map(([key, ability]) => ({\n    name: key.toUpperCase(),\n    value: ability.value || 10,\n    modifier: ability.mod >= 0 ? `+${ability.mod}` : `${ability.mod}`\n  }));\n}\n\n/**\n * Apply target tokens to user\n * @param {Array<string>} tokenIds - Array of token IDs to target\n * @param {User} user - User to apply targets for (default: game.user)\n */\nexport function applyTargetTokens(tokenIds, user = game.user) {\n  if (!tokenIds?.length) return;\n\n  tokenIds.forEach((id, index) => {\n    LogUtil.log('applyTargetTokens', [id, canvas.tokens.placeables.map(t => t.id)]);\n    const token = canvas.tokens.placeables.find(t => t.id === id); //canvas.tokens.get(id);\n    if (token) {\n      token.setTarget(true, { releaseOthers: index === 0 });\n    }else{\n      LogUtil.warn('applyTargetTokens - Token not found:', [id]);\n    }\n  });\n  \n  // const tokens = tokenIds\n  //   .map(id => canvas.tokens.get(id))\n  //   .filter(t => t);\n  // LogUtil.log('applyTargetTokens', [tokenIds, canvas.tokens.placeables.map(t => t.id)]);\n    \n  // tokens.forEach(t => t.setTarget(true, { user }));\n}\n\n/**\n * Clear all target tokens for user\n * @param {User} user - User to clear targets for (default: game.user)\n */\nexport function clearTargetTokens(user = game.user) {\n  user.targets.forEach(t => t.setTarget(false, { user }));\n}\n\n/**\n * Format a notification message for multiple actors\n * @param {Array<string>} actorNames - Array of actor names\n * @param {string} action - The action being performed\n * @returns {string} Formatted message\n */\nexport function formatMultiActorNotification(actorNames, action) {\n  if (actorNames.length === 0) return \"\";\n  if (actorNames.length === 1) return `${actorNames[0]} ${action}`;\n  \n  const and = game.i18n.localize(\"FLASH_ROLLS.common.and\");\n  \n  if (actorNames.length === 2) return `${actorNames[0]} ${and} ${actorNames[1]} ${action}`;\n  \n  const lastActor = actorNames[actorNames.length - 1];\n  const otherActors = actorNames.slice(0, -1).join(\", \");\n  return `${otherActors}, ${and} ${lastActor} ${action}`;\n}\n\n/**\n * Check if an actor is owned by a player (not GM)\n * @param {Actor} actor - The actor to check\n * @returns {boolean} True if owned by a player\n */\nexport function isPlayerOwned(actor) {\n  // Skip non-character actors\n  if (actor.type !== 'character' && actor.type !== 'npc') return false;\n  \n  return Object.entries(actor.ownership)\n    .some(([userId, level]) => {\n      const user = game.users.get(userId);\n      return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n    });\n}\n\n/**\n * Check if actor has token in current scene\n * @param {Actor} actor - The actor to check\n * @returns {boolean} True if actor has token in current scene\n */\nexport function hasTokenInScene(actor) {\n  // Skip non-character actors\n  if (actor.type !== 'character' && actor.type !== 'npc') return false;\n  \n  const currentScene = game.scenes.active;\n  return currentScene && currentScene.tokens.some(token => token.actorId === actor.id);\n}\n\n/**\n * Update token selection on canvas based on actor selection\n * @param {string} actorId - The actor ID\n * @param {boolean} selected - Whether to select or deselect\n */\nexport function updateCanvasTokenSelection(actorId, selected, tokenId = null) {\n  const scene = game.scenes.active;\n  if (!scene) return;\n  \n  let tokens;\n  if (tokenId) {\n    const specificToken = canvas.tokens.placeables.find(t => t.id === tokenId);\n    tokens = specificToken ? [specificToken] : [];\n  } else {\n    tokens = canvas.tokens.placeables.filter(t => t.actor?.id === actorId);\n  }\n  \n  for (const token of tokens) {\n    if (selected) {\n      token.control({ releaseOthers: false });\n    } else {\n      token.release();\n    }\n  }\n}\n\n/**\n * Delay execution for a specified time\n * @param {number} ms - Milliseconds to delay\n * @returns {Promise} Promise that resolves after the delay\n */\nexport function delay(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Check if the sidebar is expanded\n * @returns {boolean} True if sidebar is expanded\n */\nexport function isSidebarExpanded() {\n  return ui?.sidebar?.expanded || false;\n}\n\n/**\n * Update body class based on sidebar state\n * @param {boolean} isExpanded - Whether sidebar is expanded\n */\nexport function updateSidebarClass(isExpanded) {\n  const body = document.querySelector(\"body\"); \n  if (isExpanded) {\n    body.classList.add(\"flash5e-sidebar-expanded\"); \n  } else {\n    body.classList.remove(\"flash5e-sidebar-expanded\"); \n  }\n  adjustMenuOffset();\n}\n\n/**\n * Build roll types array for a selected request type\n * @param {string} selectedRequestType - The type of roll request\n * @param {Set} selectedActors - Set of selected actor IDs\n * @returns {Array} Array of roll type objects with id, name, and rollable properties\n */\nexport function buildRollTypes(selectedRequestType, selectedActors) {\n  const rollTypes = [];\n  \n  if (!selectedRequestType) {\n    return rollTypes;\n  }\n  \n  const selectedOption = MODULE.ROLL_REQUEST_OPTIONS[selectedRequestType];\n  if (!selectedOption || !selectedOption.subList) {\n    return rollTypes;\n  }\n  \n  const configData = CONFIG.DND5E[selectedOption.subList];\n  \n  if (configData) {\n    for (const [key, data] of Object.entries(configData)) {\n      let label = data.label || data.name || key;\n      \n      if (selectedOption.subList === 'tools' && CONFIG.DND5E.enrichmentLookup?.tools?.[key]) {\n        const toolData = CONFIG.DND5E.enrichmentLookup.tools[key];\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          label = toolItem?.name || label;\n        }\n      }\n      \n      rollTypes.push({\n        id: key,\n        name: label,\n        rollable: true\n      });\n    }\n    \n    rollTypes.sort((a, b) => a.name.localeCompare(b.name));\n  }\n  \n  return rollTypes;\n}\n\n/**\n * Unified notification system with batching support\n */\nexport class NotificationManager {\n  static pendingNotifications = [];\n  static notificationTimer = null;\n  static NOTIFICATION_BATCH_DELAY = 500; // ms to wait for additional notifications\n  \n  /**\n   * Show a notification with optional batching for roll requests\n   * @param {string} type - Notification type (info, warn, error)\n   * @param {string} message - Message to display\n   * @param {Object} options - Options for the notification\n   * @param {boolean} options.batch - Whether to batch this notification\n   * @param {Object} options.batchData - Data for batched notifications\n   */\n  static notify(type, message, options = {}) {\n    if (!options.batch) {\n      ui.notifications[type](message);\n      return;\n    }\n    \n    if (options.batchData) {\n      NotificationManager.pendingNotifications.push(options.batchData);\n      \n      if (NotificationManager.notificationTimer) {\n        clearTimeout(NotificationManager.notificationTimer);\n      }\n      \n      NotificationManager.notificationTimer = setTimeout(() => {\n        showBatchedNotifications(NotificationManager.pendingNotifications);\n        NotificationManager.pendingNotifications = [];\n        NotificationManager.notificationTimer = null;\n      }, NotificationManager.NOTIFICATION_BATCH_DELAY);\n    }\n  }\n  \n  /**\n   * Show roll request sent notifications (GM side)\n   * @param {Object} requestsByPlayer - Grouped requests by player\n   * @param {string} rollTypeName - Display name of the roll type\n   */\n  static notifyRollRequestsSent(requestsByPlayer, rollTypeName) {\n    const successfulRequests = Object.entries(requestsByPlayer);\n    \n    if (successfulRequests.length === 0) return;\n    \n    // Single player, single actor\n    if (successfulRequests.length === 1) {\n      const playerData = Object.values(requestsByPlayer)[0];\n      const actorNames = playerData.actors.map(a => a.name).join(\", \");\n      ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.rollRequestsSentSingle\", { \n        rollType: rollTypeName,\n        actors: actorNames,\n        player: playerData.player.name\n      }));\n    } else {\n      // Multiple players\n      const playerSummaries = successfulRequests.map(([playerId, data]) => {\n        const actorNames = data.actors.map(a => a.name).join(\", \");\n        return `${data.player.name} (${actorNames})`;\n      });\n      ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.rollRequestsSentMultiple\", { \n        rollType: rollTypeName,\n        count: successfulRequests.length,\n        players: playerSummaries.join(\"; \")\n      }));\n    }\n  }\n  \n  /**\n   * Clear any pending notifications\n   */\n  static clearPending() {\n    if (NotificationManager.notificationTimer) {\n      clearTimeout(NotificationManager.notificationTimer);\n      NotificationManager.notificationTimer = null;\n    }\n    NotificationManager.pendingNotifications = [];\n  }\n}\n\n/**\n * Filter actors based on death save requirements\n * @param {Actor[]} actors - Array of actors to filter\n * @returns {Actor[]} Array of actors that need death saves\n */\nexport function filterActorsForDeathSaves(actors) {\n  const actorsNeedingDeathSaves = [];\n  const actorsSkippingDeathSaves = [];\n  \n  for (const actor of actors) {\n    const hp = actor.system.attributes.hp?.value || 0;\n    const deathSaves = actor.system.attributes.death || {};\n    const successes = deathSaves.success || 0;\n    const failures = deathSaves.failure || 0;\n    \n    // Check if actor needs a death save\n    if (hp <= 0 && successes < 3 && failures < 3) {\n      actorsNeedingDeathSaves.push(actor);\n    } else {\n      actorsSkippingDeathSaves.push(actor.name);\n    }\n  }\n  \n  // Notify about actors that don't need death saves\n  if (actorsSkippingDeathSaves.length > 0) {\n    NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.actorsSkippingDeathSave\", {\n      actors: actorsSkippingDeathSaves.join(\", \")\n    }));\n  }\n  \n  return actorsNeedingDeathSaves;\n}\n\n/**\n * Categorize actors by ownership (PC vs NPC)\n * @param {Actor[]} actors - Array of actors to categorize\n * @returns {{pcActors: Array, npcActors: Actor[]}} Object with categorized actors\n */\nexport function categorizeActorsByOwnership(actors) {\n  const pcActors = [];\n  const npcActors = [];\n  \n  for (const actor of actors) {\n    const owner = getPlayerOwner(actor);\n    if (owner) {\n      pcActors.push({ actor, owner });\n    } else {\n      npcActors.push(actor);\n    }\n  }\n  \n  return { pcActors, npcActors };\n}\n\nexport function addHDUpdate(updates, newUpdate){\n  const existingIndex = updates.findIndex(update => update._id === newUpdate._id);\n  if(existingIndex > -1){\n    updates[existingIndex] = foundry.utils.mergeObject(\n      updates[existingIndex],\n      newUpdate\n    )\n  }else{\n    updates.push(newUpdate);\n  }\n}\n\n/**\n * Adjust the offset vars for the roll menu based on the state of the roll privacy controls\n */\nexport function adjustMenuOffset(isExpanded=true){\n  const rollPrivacyVertical = document.querySelector('#chat-notifications #roll-privacy');\n  const controlsWidth = rollPrivacyVertical ? GeneralUtil.getFullWidth(rollPrivacyVertical) : 36;\n  const isCrlngnUIOn = document.querySelector('body.crlngn-tabs') ? true : false;\n  \n  GeneralUtil.addCSSVars('--flash-rolls-menu-offset', (isCrlngnUIOn ? controlsWidth : controlsWidth + 16) + 'px');\n}\n\n/**\n * Find the actor data from actor ID, token ID, or token document ID\n * @param {string} uniqueId - The ID of the actor, token, or token document\n * @returns {Actor|null} The actor document, or null if not found\n */\nexport function getActorData(uniqueId){\n  // First check if this is a token ID\n  const tokenDoc = game.scenes.active?.tokens.get(uniqueId);\n  if (tokenDoc?.actor) return tokenDoc.actor;\n\n  const token = canvas.tokens?.get(uniqueId);\n  if (token?.actor) return token.actor;\n\n  const actor = game.actors.get(uniqueId);\n  return actor || null;\n}\n\nexport function showConsumptionConfig(){\n  const SETTINGS = getSettings();\n  const consumptionConfigMode = SettingsUtil.get(SETTINGS.consumptionConfigMode.tag);\n\n  switch (consumptionConfigMode) {\n    case 1:\n      return false;\n    case 2:\n      return game.user.isGM;\n    case 3:\n      return !game.user.isGM;\n    default:\n      return true;\n  }\n}\n  \n/**\n * Returns a consumption config object based on current situation\n * @param {Object} consume \n * @param {Boolean} isLocalRoll \n * @returns \n */\nexport function getConsumptionConfig(consume, isLocalRoll=true){\n  // const showConsumptionDialog = showConsumptionConfig();\n  let response = { ...consume };\n\n  if(game.user.isGM){\n    response.action = isLocalRoll ? consume.action : false;\n    response.resources = isLocalRoll ? consume.resources : [];\n    response.spellSlot = isLocalRoll ? consume.spellSlot : false;\n  }\n  return response;\n}\n\n/**\n * Returns a create config object based on current situation\n * Template placement logic:\n * - If the roll is local, always prompt for template placement\n * @param {*} createConfig \n * @param {*} isLocalRoll \n * @returns \n */\nexport function getCreateConfig(createConfig, isLocalRoll=true){\n  const SETTINGS = getSettings();\n  const placeTemplateForPlayer = SettingsUtil.get(SETTINGS.placeTemplateForPlayer.tag);\n  const withTemplate = createConfig.measuredTemplate === true;\n  const promptForTemplate = game.user.isGM ? isLocalRoll || placeTemplateForPlayer : !placeTemplateForPlayer\n\n  LogUtil.log(\"getCreateConfig\", [createConfig, isLocalRoll, placeTemplateForPlayer, withTemplate, promptForTemplate]);\n  return {\n    ...createConfig,\n    measuredTemplate: withTemplate ? promptForTemplate : false\n  }\n}","import { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { ROLL_TYPES, MODULE_ID } from \"../../constants/General.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { getPlayerOwner } from \"./Helpers.mjs\";\n\n/**\n * Helper functions for roll handling\n */\nexport const RollHelpers = {\n  /**\n   * Add situational bonus to a roll configuration\n   * @param {BasicRollProcessConfiguration} config - The process configuration with rolls array\n   * @param {string} situational - The situational bonus formula\n   * @returns {BasicRollProcessConfiguration} The modified config\n   */\n  addSituationalBonus(config, situational) {\n    LogUtil.log(\"Config before adding bonus:\", [situational, config]);\n    if (situational && config.rolls?.[0]) {\n      if (!config.rolls[0].parts) config.rolls[0].parts = [];\n      if (!config.rolls[0].data) config.rolls[0].data = {};\n      \n      config.rolls[0].data.situational = situational;\n      // Only add @situational if it's not already in parts\n      if (!config.rolls[0].parts.includes(\"@situational\")) {\n        config.rolls[0].parts.push(\"@situational\");\n      }\n      LogUtil.log(\"Config after adding bonus:\", [config]);\n    }\n    return config;\n  },\n\n  /**\n   * Async helper to unset activity config flag\n   * @param {Item5e} item - The item to update\n   * @returns {Promise<void>}\n   */\n  async unsetActivityFlag(item) {\n    if(!game.user.isGM || !item) return;\n    // Clean up any existing config first\n    const existingConfig = item.getFlag(MODULE_ID, 'tempActivityConfig');\n    if (existingConfig) {\n      LogUtil.log('updateActivityConfigFlag - cleaning up existing config', [existingConfig]);\n      await item.unsetFlag(MODULE_ID, 'tempActivityConfig');\n    }\n  },\n\n  /**\n   * Async helper to update activity config flag\n   * @param {Item5e} item - The item to update\n   * @param {Object} newConfig - The new configuration to store\n   * @returns {Promise<void>}\n   */\n  async updateActivityConfigFlag(item, newConfig) {\n    // Set the new config\n    LogUtil.log('updateActivityConfigFlag - storing new activity config', [newConfig]);\n    await item.setFlag(MODULE_ID, 'tempActivityConfig', newConfig);\n  },\n\n  /**\n   * Build base configuration for all roll types\n   * @param {Object} requestData - The roll request data\n   * @param {Object} requestData.config - Configuration from the request\n   * @param {boolean} [requestData.config.advantage] - Roll with advantage\n   * @param {boolean} [requestData.config.disadvantage] - Roll with disadvantage\n   * @param {string} [requestData.config.situational] - Situational bonus formula\n   * @param {number} [requestData.config.target] - DC value\n   * @param {string} [requestData.config.requestedBy] - Name of requester\n   * @param {BasicRollConfiguration} rollConfig - Individual roll configuration with parts[], data{}, options{}\n   * @param {string[]} [rollConfig.parts=[]] - Roll formula parts\n   * @param {Object} [rollConfig.data={}] - Roll data for formula resolution\n   * @param {Object} [rollConfig.options={}] - Roll options\n   * @param {Object} [additionalConfig={}] - Additional configuration specific to the roll type\n   * @returns {BasicRollProcessConfiguration} The process configuration for D&D5e actor roll methods\n   */\n  buildRollConfig(requestData, rollConfig, additionalConfig = {}) {\n    LogUtil.log('RollHelpers.buildRollConfig - incoming rollConfig', [\n      'parts:', rollConfig.parts,\n      'data:', rollConfig.data,\n      'requestData.config.situational:', requestData.config.situational\n    ]);\n    \n    // Build BasicRollProcessConfiguration\n    const config = {\n      rolls: [{\n        parts: rollConfig.parts || [],\n        data: rollConfig.data || {},\n        options: {\n          ...rollConfig.options || {},\n          // Preserve the _fromFlashRolls flag if it exists\n          ...(rollConfig.options?._fromFlashRolls && { _fromFlashRolls: true })\n        }\n      }],\n      advantage: requestData.config.advantage || false,\n      disadvantage: requestData.config.disadvantage || false,\n      target: requestData.config.target,\n      subject: null,\n      chatMessage: true,\n      legacy: false,\n      // Include rollMode if it's in the config\n      ...(requestData.config.rollMode && { rollMode: requestData.config.rollMode }),\n      ...additionalConfig\n    };\n    \n    const situational = requestData.config.situational;\n    if (situational) {\n      this.addSituationalBonus(config, situational);\n    }\n    \n    return this.ensureRollFlags(config, requestData);\n  },\n\n  /**\n   * Ensure roll config has the required flags to prevent re-interception\n   * @param {BasicRollProcessConfiguration} config - The process configuration\n   * @param {Object} requestData - The roll request data\n   * @param {Object} requestData.config - Configuration object\n   * @param {string} [requestData.config.requestedBy] - Name of requester\n   * @returns {BasicRollProcessConfiguration} The updated config with required flags\n   */\n  ensureRollFlags(config, requestData) {\n    config.isRollRequest = game.user.isGM ? false : true;\n    config._showRequestedBy = true;\n    config._requestedBy = requestData.config.requestedBy || 'GM';\n\n    return config;\n  },\n\n  /**\n   * Validate and normalize actors array\n   * @param {Actor[]|string[]} actors - Array of Actor documents or actor IDs\n   * @returns {Actor[]|null} Array of valid actors or null if no valid actors\n   */\n  validateActors(actors) {\n    if (!actors || actors.length === 0) return null;\n    \n    // Convert actor IDs to Actor documents if needed\n    if (typeof actors[0] === 'string') {\n      actors = actors.map(actorId => game.actors.get(actorId)).filter(a => a);\n    }\n    \n    return actors.length > 0 ? actors : null;\n  },\n\n  /**\n   * Determine the appropriate roll class based on roll type\n   * @param {string} rollType - The type of roll\n   * @returns {typeof BasicRoll} The appropriate roll class\n   */\n  getRollClass(rollType) {\n    const normalizedType = rollType?.toLowerCase();\n    \n    if ([ROLL_TYPES.DAMAGE, ROLL_TYPES.HEALING].includes(normalizedType)) {\n      return CONFIG.Dice.DamageRoll || CONFIG.Dice.BasicRoll;\n    } else if ([ROLL_TYPES.FORMULA, ROLL_TYPES.CUSTOM, ROLL_TYPES.HIT_DIE].includes(normalizedType)) {\n      return CONFIG.Dice.BasicRoll;\n    }\n    \n    return CONFIG.Dice.D20Roll;\n  },\n\n  /**\n   * Check if DC field should be shown for a roll type\n   * @param {string} rollType - The type of roll\n   * @returns {boolean} Whether to show DC field\n   */\n  shouldShowDC(rollType) {\n    const normalizedType = rollType?.toLowerCase();\n    return [\n      ROLL_TYPES.SAVE,\n      ROLL_TYPES.SAVING_THROW,\n      ROLL_TYPES.ABILITY,\n      ROLL_TYPES.ABILITY_CHECK,\n      ROLL_TYPES.CONCENTRATION,\n      ROLL_TYPES.SKILL,\n      ROLL_TYPES.TOOL\n    ].includes(normalizedType);\n  },\n\n  /**\n   * Create base roll configuration for dialog\n   * @param {Actor} actor - The actor to roll for\n   * @param {string} rollType - The type of roll\n   * @param {string} rollKey - The specific roll key\n   * @returns {Object} Base roll configuration\n   */\n  createBaseRollConfig(actor, rollType, rollKey) {\n    const normalizedType = rollType?.toLowerCase();\n    \n    const rollConfig = {\n      data: actor.getRollData(),\n      subject: actor,\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n    \n    switch (normalizedType) {\n      case ROLL_TYPES.SKILL:\n        rollConfig.skill = rollKey;\n        break;\n      case ROLL_TYPES.TOOL:\n        rollConfig.tool = rollKey;\n        break;\n      case ROLL_TYPES.SAVE:\n      case ROLL_TYPES.SAVING_THROW:\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.ABILITY_CHECK:\n        rollConfig.ability = rollKey;\n        break;\n      case ROLL_TYPES.HIT_DIE:\n        rollConfig.rolls[0].options.flavor = \"Hit Die\";\n        break;\n    }\n    \n    return rollConfig;\n  },\n\n  /**\n   * Create standard message configuration\n   * @param {Actor} actor - The actor creating the message\n   * @param {string} [rollMode] - Optional roll mode to set\n   * @returns {Object} Message configuration\n   */\n  createMessageConfig(actor, rollMode = null) {\n    const config = {\n      create: false,\n      data: {\n        speaker: ChatMessage.getSpeaker({ actor })\n      }\n    };\n    \n    if (rollMode) {\n      config.rollMode = rollMode;\n    }\n    \n    return config;\n  },\n\n  /**\n   * Execute a roll dialog and return the result\n   * @param {Class} DialogClass - The dialog class to instantiate\n   * @param {Object} rollConfig - Roll configuration\n   * @param {Object} messageConfig - Message configuration\n   * @param {Object} dialogOptions - Dialog options\n   * @returns {Promise<Object|null>} Dialog result or null if cancelled\n   */\n  async triggerRollDialog(DialogClass, rollConfig, messageConfig, dialogOptions) {\n    const app = new DialogClass(rollConfig, messageConfig, dialogOptions);\n    \n    const result = await new Promise(resolve => {\n      app.addEventListener(\"close\", () => {\n        resolve({\n          rolls: app.rolls,\n          config: app.config,\n          message: app.message,\n          sendRequest: app.sendRequest,\n          critical: app.config.critical,\n          isCritical: app.config.isCritical\n        });\n      }, { once: true });\n      app.render({ force: true });\n    });\n    \n    return result;\n  },\n\n  /**\n   * Process dialog result into final roll configuration\n   * @param {Object} result - Result from dialog\n   * @param {Actor[]} actors - Array of actors\n   * @param {string} rollType - The type of roll\n   * @param {string} rollKey - The specific roll key\n   * @param {Object} options - Additional options\n   * @returns {Object|null} Final roll process configuration or null if cancelled\n   */\n  processDialogResult(result, actors, rollType, rollKey, options = {}) {\n    // If no rolls or user cancelled\n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    const normalizedType = rollType?.toLowerCase();\n    const firstRoll = result.rolls[0];\n    \n    // Extract advantage mode\n    let advantage = false;\n    let disadvantage = false;\n    \n    if (firstRoll?.options?.advantageMode !== undefined) {\n      advantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE;\n      disadvantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE;\n    }\n    \n    // Extract roll data\n    const situational = firstRoll?.data?.situational || \"\";\n    const target = firstRoll?.options?.target;\n    \n    // Build roll process configuration\n    const rollProcessConfig = {\n      rolls: [{\n        parts: firstRoll?.parts?.slice() || [],\n        data: situational ? { situational } : {},\n        options: target ? { target } : {}\n      }],\n      subject: actors[0],\n      advantage,\n      disadvantage,\n      target,\n      sendRequest: result.sendRequest,\n      isRollRequest: result.sendRequest,\n      skipRollDialog: result.config?.skipRollDialog || options.skipRollDialog || false,\n      chatMessage: true\n    };\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = this.determineRollMode(isPublicRollsOn, result.message?.rollMode);\n    rollProcessConfig.rollMode = rollMode;\n    \n    if (result.config?.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedType)) {\n      rollProcessConfig.ability = result.config.ability;\n    }\n    \n    return rollProcessConfig;\n  },\n\n  /**\n   * Determine the final roll mode for GM dialogs\n   * @param {boolean} isPublicRollsOn - Whether public rolls setting is enabled\n   * @param {string} messageRollMode - Roll mode from message (user's selection in dialog)\n   * @returns {string} Final roll mode\n   */\n  determineRollMode(isPublicRollsOn, messageRollMode) {\n    // If user explicitly selected a roll mode in the dialog, use it\n    if (messageRollMode) {\n      return messageRollMode;\n    }\n    \n    // For GM dialogs, always default to the GM's core roll mode setting\n    // Individual actor roll modes will be determined later based on actor type\n    return game.settings.get(\"core\", \"rollMode\");\n  },\n\n  /**\n   * Check if actor is player owned\n   * @param {Actor} actor - The actor to check\n   * @returns {boolean} Whether the actor is player owned\n   */\n  isPlayerOwned(actor) {\n    return Object.entries(actor.ownership)\n      .some(([userId, level]) => {\n        const user = game.users.get(userId);\n        return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n      });\n  },\n\n  /**\n   * Check if actor is player owned\n   * @param {Actor} actor - The actor to check\n   * @returns {boolean} Whether the actor is player owned\n   */\n  isPlayerOwnerActive(actor) {\n    const playerOwner = getPlayerOwner(actor);\n    return playerOwner && playerOwner.active;\n  },\n\n  /* -------------------------------------------- */\n  /*  Group Roll Calculation Methods              */\n  /* -------------------------------------------- */\n\n  /**\n   * Calculate group roll result using Standard Rule - At least half the group must succeed\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total, success, failure }\n   * @param {number} dc - The DC to check against\n   * @returns {Object} Result object with { finalResult, successes, failures, summary }\n   */\n  calculateStandardRule(rollResults, dc) {\n    const successes = rollResults.filter(r => r.total >= dc).length;\n    const failures = rollResults.length - successes;\n    const halfThreshold = Math.ceil(rollResults.length / 2);\n    \n    return {\n      finalResult: successes >= halfThreshold,\n      successes,\n      failures,\n      summary: game.i18n.format(\"FLASH_ROLLS.groupRoll.standardRule.summary\", {\n        successes,\n        total: rollResults.length,\n        threshold: halfThreshold\n      }),\n      method: 'Standard Rule'\n    };\n  },\n\n  /**\n   * Calculate group roll result using Group Average - Simple average of all rolls, rounded down\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total }\n   * @param {number} dc - The DC to check against\n   * @returns {Object} Result object with { finalResult, average, success, summary }\n   */\n  calculateGroupAverage(rollResults, dc) {\n    const sum = rollResults.reduce((acc, r) => acc + r.total, 0);\n    const average = Math.floor(sum / rollResults.length);\n    \n    return {\n      finalResult: average,\n      average,\n      success: average >= dc,\n      summary: game.i18n.format(\"FLASH_ROLLS.groupRoll.groupAverage.summary\", {\n        average,\n        dc\n      }),\n      method: 'Group Average'\n    };\n  },\n\n  /**\n   * Calculate group roll result using Leader with Help - Result from actor with highest bonus, plus other successes minus other failures\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total, modifier }\n   * @param {number} dc - The DC to check against\n   * @param {Actor[]} actors - Array of actors to get modifiers from\n   * @param {string} rollType - Type of roll (skill, save, ability)\n   * @param {string} rollKey - The specific roll key (e.g., 'ath', 'dex')\n   * @returns {Object} Result object with { finalResult, leaderRoll, bonus, penalty, success, summary }\n   */\n  calculateLeaderWithHelp(rollResults, dc, actors, rollType, rollKey) {\n    let highestModifier = -999;\n    let leaderIndex = -1;\n    let leaderActorId = null;\n    let leaderModifier = 0;\n    \n    // Find the leader by checking each roll result's corresponding actor\n    for (let i = 0; i < rollResults.length; i++) {\n      const result = rollResults[i];\n      const actor = actors.find(a => a.id === result.actorId);\n      if (!actor) continue;\n      \n      const modifier = this._getActorModifier(actor, rollType, rollKey);\n      if (modifier > highestModifier) {\n        highestModifier = modifier;\n        leaderIndex = i;\n        leaderActorId = actor.id;\n        leaderModifier = modifier;\n      }\n    }\n    \n    if (leaderIndex === -1) {\n      return {\n        finalResult: 0,\n        error: 'No leader found',\n        method: 'Leader with Help'\n      };\n    }\n    \n    const leaderResult = rollResults[leaderIndex];\n    \n    // Count successes and failures from other members (excluding the leader by index, not actorId)\n    const otherResults = rollResults.filter((r, index) => index !== leaderIndex);\n    const successes = otherResults.filter(r => r.total >= dc).length;\n    const failures = otherResults.filter(r => r.total < dc).length;\n    const adjustedResult = leaderResult.total + successes - failures;\n    \n    // Choose appropriate summary based on successes and failures\n    let summaryKey;\n    let summaryData = {\n      leaderRoll: leaderResult.total,\n      adjustedResult,\n      dc\n    };\n    \n    if (successes > 0 && failures > 0) {\n      summaryKey = \"FLASH_ROLLS.groupRoll.leaderWithHelp.summary\";\n      summaryData.bonus = successes;\n      summaryData.penalty = failures;\n    } else if (successes > 0) {\n      summaryKey = \"FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlySuccess\";\n      summaryData.bonus = successes;\n      summaryData.successWord = successes === 1 \n        ? game.i18n.localize(\"FLASH_ROLLS.groupRoll.leaderWithHelp.successSingular\")\n        : game.i18n.localize(\"FLASH_ROLLS.groupRoll.leaderWithHelp.successPlural\");\n    } else if (failures > 0) {\n      summaryKey = \"FLASH_ROLLS.groupRoll.leaderWithHelp.summaryOnlyFailure\";\n      summaryData.penalty = failures;\n      summaryData.failureWord = failures === 1\n        ? game.i18n.localize(\"FLASH_ROLLS.groupRoll.leaderWithHelp.failureSingular\")\n        : game.i18n.localize(\"FLASH_ROLLS.groupRoll.leaderWithHelp.failurePlural\");\n    } else {\n      summaryKey = \"FLASH_ROLLS.groupRoll.leaderWithHelp.summaryNoModifiers\";\n    }\n    \n    return {\n      finalResult: adjustedResult,\n      leaderRoll: leaderResult.total,\n      leaderName: actors.find(a => a.id === leaderActorId)?.name,\n      leaderActorId,\n      leaderModifier,\n      bonus: successes,\n      penalty: failures,\n      success: adjustedResult >= dc,\n      summary: game.i18n.format(summaryKey, summaryData),\n      method: 'Leader with Help'\n    };\n  },\n\n  /**\n   * Calculate group roll result using Weakest Link - Result from actor with lowest modifier, plus number of group successes\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total }\n   * @param {number} dc - The DC to check against\n   * @param {Actor[]} actors - Array of actors to get modifiers from\n   * @param {string} rollType - Type of roll (skill, save, ability)\n   * @param {string} rollKey - The specific roll key (e.g., 'ath', 'dex')\n   * @returns {Object} Result object with { finalResult, weakestRoll, bonus, success, summary }\n   */\n  calculateWeakestLink(rollResults, dc, actors, rollType, rollKey) {\n    let lowestModifier = 999;\n    let weakestActorId = null;\n    let weakestModifierValue = 0;\n    \n    for (const actor of actors) {\n      const modifier = this._getActorModifier(actor, rollType, rollKey);\n      if (modifier < lowestModifier) {\n        lowestModifier = modifier;\n        weakestActorId = actor.id;\n        weakestModifierValue = modifier;\n      }\n    }\n    \n    const weakestResult = rollResults.find(r => r.actorId === weakestActorId);\n    if (!weakestResult) {\n      return {\n        finalResult: 0,\n        error: 'Weakest link actor did not roll',\n        method: 'Weakest Link'\n      };\n    }\n    \n    // Count successes excluding the weakest actor\n    const successes = rollResults.filter(r => r.actorId !== weakestActorId && r.total >= dc).length;\n    const adjustedResult = weakestResult.total + successes;\n    \n    const successWord = successes === 1 ? \n      game.i18n.localize(\"FLASH_ROLLS.groupRoll.weakestLink.successSingular\") : \n      game.i18n.localize(\"FLASH_ROLLS.groupRoll.weakestLink.successPlural\");\n    \n    return {\n      finalResult: adjustedResult,\n      weakestRoll: weakestResult.total,\n      weakestName: actors.find(a => a.id === weakestActorId)?.name,\n      weakestActorId,\n      weakestModifier: weakestModifierValue,\n      bonus: successes,\n      success: adjustedResult >= dc,\n      summary: game.i18n.format(\"FLASH_ROLLS.groupRoll.weakestLink.summary\", {\n        weakestRoll: weakestResult.total,\n        bonus: successes,\n        successWord,\n        adjustedResult,\n        dc\n      }),\n      method: 'Weakest Link'\n    };\n  },\n\n  /**\n   * Get the modifier for a specific roll type and key from an actor\n   * @private\n   * @param {Actor} actor - The actor to get the modifier from\n   * @param {string} rollType - Type of roll (skill, save, ability)\n   * @param {string} rollKey - The specific roll key\n   * @returns {number} The modifier value\n   */\n  _getActorModifier(actor, rollType, rollKey) {\n    const normalizedType = rollType?.toLowerCase();\n    \n    switch (normalizedType) {\n      case ROLL_TYPES.SKILL:\n        return actor.system.skills[rollKey]?.total || \n               actor.system.skills[rollKey]?.mod || 0;\n      \n      case ROLL_TYPES.SAVE:\n      case ROLL_TYPES.SAVING_THROW:\n        // Support both old and new D&D 5e data structure\n        return actor.system.abilities[rollKey]?.save?.value || \n               actor.system.abilities[rollKey]?.save || 0;\n      \n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.ABILITY_CHECK:\n        return actor.system.abilities[rollKey]?.mod || 0;\n      \n      case ROLL_TYPES.TOOL:\n        if (actor.system.tools?.[rollKey]) {\n          return actor.system.tools[rollKey].total || \n                 actor.system.tools[rollKey].mod || 0;\n        }\n        const tool = actor.items.find(i => \n          i.type === 'tool' && \n          i.system.toolType === rollKey\n        );\n        return tool?.system.bonus || 0;\n      \n      default:\n        return 0;\n    }\n  },\n\n  /**\n   * Get the group roll result based on the selected calculation method\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total }\n   * @param {number} dc - The DC to check against\n   * @param {Actor[]} actors - Array of actors (needed for some methods)\n   * @param {string} rollType - Type of roll (needed for modifier calculation)\n   * @param {string} rollKey - The specific roll key (needed for modifier calculation)\n   * @returns {Object} Result object with { complete, success, result }\n   */\n  getGroupResult(rollResults, dc, actors, rollType, rollKey) {\n    const complete = rollResults.every(r => r.total !== null && r.total !== undefined);\n    \n    if (!complete) {\n      return {\n        complete: false,\n        success: false,\n        result: 0\n      };\n    }\n\n    const SETTINGS = getSettings();\n    const resultMode = SettingsUtil.get(SETTINGS.groupRollResultMode.tag) || 1;\n    \n    let calculationResult;\n    \n    switch (resultMode) {\n      case 1: // Standard Rule\n        calculationResult = this.calculateStandardRule(rollResults, dc);\n        return {\n          complete: true,\n          success: calculationResult.finalResult,\n          result: calculationResult.finalResult ? 1 : 0,\n          details: calculationResult\n        };\n        \n      case 2: // Group Average\n        calculationResult = this.calculateGroupAverage(rollResults, dc);\n        return {\n          complete: true,\n          success: calculationResult.success,\n          result: calculationResult.finalResult,\n          details: calculationResult\n        };\n        \n      case 3: // Leader with Help\n        calculationResult = this.calculateLeaderWithHelp(rollResults, dc, actors, rollType, rollKey);\n        return {\n          complete: true,\n          success: calculationResult.success,\n          result: calculationResult.finalResult,\n          details: calculationResult\n        };\n        \n      case 4: // Weakest Link\n        calculationResult = this.calculateWeakestLink(rollResults, dc, actors, rollType, rollKey);\n        return {\n          complete: true,\n          success: calculationResult.success,\n          result: calculationResult.finalResult,\n          details: calculationResult\n        };\n        \n      default:\n        calculationResult = this.calculateStandardRule(rollResults, dc);\n        return {\n          complete: true,\n          success: calculationResult.finalResult,\n          result: calculationResult.finalResult ? 1 : 0,\n          details: calculationResult\n        };\n    }\n  },\n  /**\n   * Consolidate data from multiple rolls into a single roll by merging their data\n   * Uses the first roll as the base and merges data from subsequent rolls\n   * @param {Object[]} rolls - Array of roll configurations to consolidate\n   * @returns {Object[]} Array with single consolidated roll\n   */\n  consolidateRolls(rolls) {\n    if (!rolls || rolls.length === 0) return rolls;\n    if (rolls.length === 1) return rolls;\n    \n    let consolidatedRoll = rolls[0];\n    \n    for (let i = 1; i < rolls.length; i++) {\n      if (rolls[i]) {\n        consolidatedRoll = foundry.utils.mergeObject(\n          consolidatedRoll,\n          rolls[i],\n          {\n            insertKeys: true, // true - add new keys from source\n            insertValues: true, // true - add new array values\n            overwrite: false, // false - don't overwrite existing non-null values in target\n            inplace: true // true - modify the target object in place\n          }\n        );\n      }\n    }\n    \n    return [consolidatedRoll];\n  },\n\n  /**\n   * Determine if challenge details (DC, success/failure) should be displayed for a player\n   * Based on D&D 5e's challengeVisibility setting\n   * @param {Object} rollProcessConfig - Roll process configuration from GM\n   * @returns {boolean} True if challenge details should be shown\n   */\n  shouldDisplayChallengeForPlayer(rollProcessConfig) {\n    // GM and message author always see challenges\n    if (game.user.isGM) return true;\n    \n    // Check if this message was sent by the current player\n    const requestedBy = rollProcessConfig._requestedBy;\n    if (requestedBy === game.user.name) return true;\n    \n    // Check D&D 5e challenge visibility setting\n    const challengeVisibility = game.settings.get(\"dnd5e\", \"challengeVisibility\");\n    switch (challengeVisibility) {\n      case \"all\": \n        return true;\n      case \"player\": \n        // Show if the message author is not the GM (i.e., another player)\n        return requestedBy !== game.users.find(u => u.isGM)?.name;\n      default: \n        // \"hide\" or any other value\n        return false;\n    }\n  },\n\n  /**\n   * Determine if roll dialog should be skipped based on settings and context\n   * @param {boolean} [sendRequest] - Whether this is a roll request (for interceptions)\n   * @returns {boolean} Whether to skip the roll dialog\n   */\n  shouldSkipRollDialog(sendRequest = null, {isPC = false, isNPC = false}) {\n    const SETTINGS = getSettings();\n    const skipRollDialog = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n    \n    // 1. If skipRollDialog setting is false, always return false\n    if (!skipRollDialog) {\n      return false;\n    }\n    \n    const skipRollDialogOption = SettingsUtil.get(SETTINGS.skipRollDialogOption.tag);\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    \n    LogUtil.log('RollHelpers.shouldSkipRollDialog', [\n      'skipRollDialogOption:', skipRollDialogOption,\n      'rollRequestsEnabled:', rollRequestsEnabled,\n      'sendRequest:', sendRequest,\n      'isPC:', isPC,\n      'isNPC:', isNPC,\n      'test:',\n      (sendRequest===true || (sendRequest !== false && rollRequestsEnabled === true))\n    ]);\n    \n    switch (skipRollDialogOption) {\n      case 1: // all rolls\n        return true;\n      case 2: // Only request rolls\n        LogUtil.log('RollHelpers.shouldSkipRollDialog!!!', [(isPC===true && sendRequest===true), (isPC===true && sendRequest !== false && rollRequestsEnabled === true)]);\n        return (isPC===true && sendRequest===true) || (isPC===true && sendRequest !== false && rollRequestsEnabled === true);\n      case 3: // Only non-request rolls\n        return isNPC===true;\n      default:\n        return false;\n    }\n  }\n};\n\n","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { ROLL_TYPES, MODULE_ID, ACTIVITY_TYPES } from '../../constants/General.mjs';\nimport { ModuleHelpers } from '../helpers/ModuleHelpers.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { getConsumptionConfig, getCreateConfig, isPlayerOwned, showConsumptionConfig } from '../helpers/Helpers.mjs';\nimport { RollHelpers } from '../helpers/RollHelpers.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { HOOKS_DND5E } from '../../constants/Hooks.mjs';\nimport { HooksManager } from '../core/HooksManager.mjs';\n\n/**\n * @typedef {Object} ActivityUseConfiguration\n * @property {object|false} create\n * @property {boolean} create.measuredTemplate - Should this item create a template?\n * @property {object} concentration\n * @property {boolean} concentration.begin - Should this usage initiate concentration?\n * @property {string|null} concentration.end - ID of an active effect to end concentration on.\n * @property {object|false} consume\n * @property {boolean} consume.action - Should action economy be tracked? Currently only handles legendary actions.\n * @property {boolean|number[]} consume.resources - Set to `true` or `false` to enable or disable all resource\n *                                                   consumption or provide a list of consumption target indexes\n *                                                   to only enable those targets.\n * @property {boolean} consume.spellSlot - Should this spell consume a spell slot?\n * @property {Event} event - The browser event which triggered the item usage, if any.\n * @property {boolean|number} scaling - Number of steps above baseline to scale this usage, or `false` if\n *                                      scaling is not allowed.\n * @property {object} spell\n * @property {number} spell.slot - The spell slot to consume.\n * @property {boolean} [subsequentActions=true] - Trigger subsequent actions defined by this activity.\n * @property {object} [cause]\n * @property {string} [cause.activity] - Relative UUID to the activity that caused this one to be used.\n *                                       Activity must be on the same actor as this one.\n * @property {boolean|number[]} [cause.resources] - Control resource consumption on linked item.\n * @property {BasicRollConfiguration[]} [rolls] - Roll configurations for this activity\n */\n\n/**\n * Handles D&D5e 4.x activities\n */\nexport class ActivityManager {\n\n  // ========================================\n  // GM-ONLY METHODS\n  // ========================================\n\n  /**\n   * Handle pre-use activity hook on GM side\n   * Prevents usage message on GM side when sending activity requests for player-owned actors\n   * @param {Activity} activity - The activity being used\n   * @param {ActivityUseConfiguration} config - Configuration for the activity use\n   * @param {Object} dialog - Dialog configuration\n   * @param {Object} message - Message configuration\n   */\n  static onPreUseActivityGM(activity, config, dialog, message) {\n    const SETTINGS = getSettings();\n    const requestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const rollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n    const isMidiOn = GeneralUtil.isModuleOn('midi-qol');\n    if (!requestsEnabled || !rollInterceptionEnabled) return;\n\n    const actor = activity.actor;\n    const actorOwner = GeneralUtil.getActorOwner(actor);\n    const isPlayerActor = isPlayerOwned(actor) && actorOwner.active;\n    const isLocalRoll = !isPlayerActor || config.isRollRequest===false;\n\n    activity.item.unsetFlag(MODULE_ID, 'tempAttackConfig');\n    activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n    activity.item.unsetFlag(MODULE_ID, 'tempSaveConfig');\n\n    if (isMidiOn && isLocalRoll) return;\n    if (!actor) return;\n    LogUtil.log(\"ActivityManager.onPreUseActivityGM #1\", [config, isLocalRoll]);\n    \n    // Store original configs before processing if this will be sent as a roll request\n    if (actorOwner && actorOwner.active && !actorOwner.isGM) {\n      config._originalConsume = structuredClone(config.consume || {});\n      config._originalCreate = structuredClone(config.create || {});\n    }\n    \n    const showConsumptionDialog = showConsumptionConfig();\n    dialog.configure = dialog.configure ? showConsumptionDialog : false;\n\n    config.consume = getConsumptionConfig(config.consume || {}, isLocalRoll);\n    config.create = getCreateConfig(config.create || {}, isLocalRoll);\n\n    if (actorOwner && actorOwner.active && !actorOwner.isGM) {\n      LogUtil.log(\"ActivityManager.onPreUseActivityGM - Preventing usage message for player-owned actor\", [actor.name]);\n      message.create = false;\n    }\n  }\n\n  /**\n   * Handle post-use activity hook on GM side\n   * Triggers damage rolls for save activities and stores activity configuration for caching\n   * @param {Activity} activity - Activity that was used\n   * @param {ActivityUseConfiguration} config - Configuration that was used\n   * @param {Object} results - Results of the activity use\n   */\n  static onPostUseActivityGM(activity, config, results) {\n    const SETTINGS = getSettings();\n    const requestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const rollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n    const isMidiOn = GeneralUtil.isModuleOn('midi-qol');\n    const actor = activity.actor;\n    LogUtil.log(\"ActivityManager.onPostUseActivityGM\", [activity, config, results]);\n\n    if (!requestsEnabled || !rollInterceptionEnabled || !actor) return;\n\n    const actorOwner = GeneralUtil.getActorOwner(actor);\n    const isOwnerActive = actorOwner && actorOwner.active && actorOwner.id !== game.user.id;\n    // const isPlayerActor = isPlayerOwned(actor) && actorOwner.active;\n    const isLocalRoll = !isOwnerActive || config.isRollRequest===false;\n\n    if (isMidiOn && isLocalRoll) return;\n    const skipRollDialog = RollHelpers.shouldSkipRollDialog(isOwnerActive, {isPC: isOwnerActive, isNPC: !isOwnerActive});\n    results.configure = config.skipRollDialog !== undefined ? !config.skipRollDialog : (isOwnerActive && !skipRollDialog);\n\n    LogUtil.log(\"ActivityManager.onPostUseActivityGM - skipRollDialog\", [skipRollDialog, config.skipRollDialog]);\n    if (config.skipRollDialog === false && (!actorOwner?.active || actorOwner.isGM)) {\n      LogUtil.log(\"ActivityManager.onPostUseActivityGM - Preventing usage message - no owning player for actor\", [activity.actor]);\n      return;\n    }\n\n    // Store activity configuration for GM dialogs to access spell/scaling/consume/create data\n    if (activity.item) {\n      const activityConfig = {\n        spell: config.spell || {},\n        scaling: config.scaling,\n        consume: config._originalConsume || config.consume || {},\n        create: config._originalCreate || config.create || {}\n      };\n\n      const cacheKey = activity.item.id;\n      const cacheEntry = {\n        config: activityConfig,\n        timestamp: Date.now()\n      };\n      HooksManager.activityConfigCache.set(cacheKey, cacheEntry);\n      LogUtil.log('ActivityManager.onPostUseActivityGM - storing activity config in cache', [cacheKey, activityConfig]);\n    }\n\n    if (isMidiOn){\n      LogUtil.log(\"ActivityManager.onPostUseActivityGM -  MIDI QOL is active\", [activity]);\n\n      activity.midiOptions = {\n        workflowOptions: {\n          autoFastForward: 'none',\n          fastForwardSpells: false,\n          autoFastDamage: false,\n          autoRollAttack: false,\n          autoRollDamage: 'none'\n        }\n      }\n      // const damageRoll = await workflow.activity.rollDamage({\n      //   ...damageConfig,\n      //   workflow: workflow\n      // }, {\n      //   ...config.dialog,\n      //   configure: true\n      // }, {});\n    \n      // return;\n    } \n\n    // Trigger damage roll for save activities (only when sending to players, not for local MIDI rolls)\n    if (activity.type === ACTIVITY_TYPES.SAVE && activity.damage?.parts?.length > 0 && !isMidiOn) {\n      LogUtil.log(\"ActivityManager.onPostUseActivityGM - triggering save damage roll\", [activity, config]);\n\n      const shouldShowDialog = config.skipRollDialog !== undefined ? !config.skipRollDialog : (isOwnerActive && !skipRollDialog);\n\n      activity.rollDamage(config, {\n        configure: shouldShowDialog\n      }, {});\n    }\n  }\n\n  // ========================================\n  // PLAYER-ONLY METHODS\n  // ========================================\n\n  /**\n   * Handle pre-use activity hook on player side\n   * Configures Midi-QOL options for Flash Rolls compatibility\n   * @param {Activity} activity - The activity being used\n   * @param {ActivityUseConfiguration} config - Configuration for the activity use\n   * @param {Object} dialog - Dialog configuration\n   * @param {Object} message - Message configuration\n   */\n  static onPreUseActivityPlayer(activity, config, dialog, message) {\n    const SETTINGS = getSettings();\n    const requestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const rollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n    if (!requestsEnabled || !rollInterceptionEnabled) return;\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n\n    LogUtil.log(\"ActivityManager.onPreUseActivityPlayer\", [activity, config, dialog, message]);\n\n    const actor = activity.actor;\n\n    // Clear any existing flags\n    activity.item.unsetFlag(MODULE_ID, 'tempAttackConfig');\n    activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n    activity.item.unsetFlag(MODULE_ID, 'tempSaveConfig');\n\n    if (!actor) return;\n\n    const showConsumptionDialog = showConsumptionConfig();\n    dialog.configure = dialog.configure ? showConsumptionDialog : false;\n\n    config.consume = getConsumptionConfig(config.consume || {}, true);\n    config.create = getCreateConfig(config.create || {}, true);\n\n    // // Configure Midi-QOL options for Flash Rolls compatibility\n    // if (isMidiActive && config.midiOptions &&\n    //   (activity.type === ACTIVITY_TYPES.DAMAGE || activity.type === ACTIVITY_TYPES.SAVE)) {\n\n    //   const existingWorkflowOptions = config.midiOptions.workflowOptions || {};\n    //   config.midiOptions = {\n    //     ...config.midiOptions,\n    //     fastForwardDamage: false,\n    //     workflowOptions: {\n    //       ...existingWorkflowOptions,\n    //       fastForwardDamage: false,\n    //       autoRollAttack: false,\n    //       autoRollDamage: false,\n    //       forceCompletion: false\n    //     }\n    //   }\n\n    //   LogUtil.log(\"ActivityManager.onPreUseActivityPlayer - configured midiOptions for Flash Rolls compatibility\", [config.midiOptions]);\n    // }\n  }\n\n  /**\n   * Handle post-use activity hook on player side\n   * Also configures Midi-QOL options for Flash Rolls compatibility\n   * @param {Activity} activity - Activity that was used\n   * @param {ActivityUseConfiguration} config - Configuration that was used\n   * @param {Object} results - Results of the activity use\n   */\n  static onPostUseActivityPlayer(activity, config, results) {\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n\n    // Configure Midi-QOL options for Flash Rolls compatibility\n    if (activity.midiOptions) {\n      activity.midiOptions = {\n        ...activity.midiOptions,\n        fastForwardDamage: true,\n        autoRollAttack: false,\n        autoRollDamage: true\n      }\n    }\n    LogUtil.log(\"ActivityManager.onPostUseActivityPlayer\", [activity, config, results, isMidiActive, activity.target?.template.count]);\n    const hasTemplate = activity.target?.template.count > 0;\n    const templateNotPlaced = config.create.measuredTemplate !== true;\n    const isEmanation = activity.target?.template?.type === \"radius\";\n    const shouldTriggerDamageRoll = (!isMidiActive || (isMidiActive && hasTemplate && templateNotPlaced && !isEmanation))\n    \n    // Trigger damage roll for save activities\n    // If Midi-QoL is active, only trigger if template is not placed, in which case Midi does not trigger damage\n    if (shouldTriggerDamageRoll && (activity.type === ACTIVITY_TYPES.SAVE && activity.damage?.parts?.length > 0)) {\n      LogUtil.log(\"ActivityManager.onPostUseActivityPlayer - triggering save damage roll\", [activity, config]);\n      const shouldShowDialog = config.skipRollDialog !== undefined ? !config.skipRollDialog : true;\n\n      activity.rollDamage(config, {\n        configure: shouldShowDialog\n      }, {\n        create: true\n      });\n    }\n  }\n\n  \n  /**\n   * Find the appropriate activity for a given roll type on an item\n   * @param {Item5e} item - The item to search for activities\n   * @param {string} rollType - The type of roll (attack, damage)\n   * @returns {Activity5e|null} - The found activity or null\n   */\n  static findActivityForRoll(item, rollType) {\n    if (!item?.system?.activities) return null;\n    \n    const activities = item.system.activities;\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    switch (normalizedRollType) {\n      case ROLL_TYPES.ATTACK:\n        const attackActivities = activities.getByType(\"attack\");\n        return attackActivities?.[0] || null;\n        \n      case ROLL_TYPES.DAMAGE:\n        const damageAttackActivities = activities.getByType(\"attack\");\n        if (damageAttackActivities?.length > 0) return damageAttackActivities[0];\n        \n        const damageActivities = activities.getByType(\"damage\");\n        if (damageActivities?.length > 0) return damageActivities[0];\n        \n        const saveActivities = activities.getByType(\"save\");\n        if (saveActivities?.length > 0) return saveActivities[0];\n        \n        return null;\n        \n      case ROLL_TYPES.ITEM_SAVE:\n        const itemSaveActivities = activities.getByType(\"save\");\n        return itemSaveActivities?.[0] || null;\n        \n      default:\n        return null;\n    }\n  }\n  \n  /**\n   * Get all activities of a specific type from an item\n   * @param {Item5e} item - The item to search\n   * @param {string} activityType - The activity type (attack, damage, save, etc.)\n   * @returns {Activity5e[]} - Array of activities\n   */\n  static getActivitiesByType(item, activityType) {\n    if (!item?.system?.activities) return [];\n    return item.system.activities.getByType(activityType);\n  }\n  \n  /**\n   * Check if an item has activities suitable for a given roll type\n   * @param {Item5e} item - The item to check\n   * @param {string} rollType - The type of roll\n   * @returns {boolean} - Whether the item has suitable activities\n   */\n  static hasActivityForRoll(item, rollType) {\n    LogUtil.log('hasActivityForRoll', [item, rollType]);\n    return !!this.findActivityForRoll(item, rollType);\n  }\n  \n  /**\n   * GM LOCAL ROLL OR PLAYER SIDE ROLL\n   * Execute a roll using the appropriate activity method\n   * As a workaround for _triggerSubsequentActions stripping off usage config, \n   * we store request configuration in flags (e.g. tempAttackConfig) \n   * and retrieve it in the respective preRoll hook callback\n   * Template placement: GM always gets prompted when executing. \n   * Player gets prompted if 'placeTemplateForPlayer' setting is false\n   * \n   * @param {Actor5e} actor - The actor performing the roll\n   * @param {string} rollType - The type of roll\n   * @param {string} itemId - The item ID\n   * @param {string} activityId - The activity ID (optional)\n   * @param {Object} config - Roll configuration\n   * @param {ActivityUseConfiguration} config.usage - Activity usage configuration\n   * @param {BasicRollDialogConfiguration} config.dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} config.message - Message configuration\n   */\n  static async executeActivityRoll(actor, rollType, itemId, activityId, config) {\n    LogUtil.log('executeActivityRoll #0', [actor, rollType, itemId, activityId, config]);\n    const SETTINGS = getSettings();\n    const promptForTemplate = game.user.isGM || SettingsUtil.get(SETTINGS.placeTemplateForPlayer.tag) === false;\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n    const item = actor.items.get(itemId);\n    if (!item) {\n      LogUtil.error(`Item not found on actor`, [actor, itemId]);\n      return;\n    }\n    \n    let activity = (activityId ? item.system.activities?.get(activityId) : this.findActivityForRoll(item, rollType)) || null;\n    let damageConfig = null;\n\n    if (!activity) {\n      LogUtil.error(`Activity not found on item`, [item, activityId, rollType]);\n      return;\n    }\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    if (activity) {\n      switch (normalizedRollType) {\n        case ROLL_TYPES.ATTACK:\n          await this.executeAttackActivity(actor, activity, config);\n          break;\n        case ROLL_TYPES.DAMAGE:\n          LogUtil.log('executeActivityRoll - damage roll #0', [activity, config]);\n          // if(!isMidiActive) {\n          //   config.message.create = true;\n          // }else{\n          //   config.dialog.configure = !game.user.isGM;\n          // }\n          damageConfig = {\n            critical: config.usage.critical || {},\n            situational: config.usage.rolls[0].data.situational || \"\",\n            rollMode: config.message?.rollMode,\n            create: config.message?.create !== false,\n            scaling: config.usage.scaling,\n            skipRollDialog: config.usage.skipRollDialog,\n            consume: config.usage.consume\n          };\n          config.usage = {\n            ...config.usage,\n            consume: getConsumptionConfig(config.usage.consume || {}, true),\n            create: getCreateConfig(config.usage.create || {}, true)\n          }\n          await activity.item.setFlag(MODULE_ID, 'tempDamageConfig', damageConfig);\n          LogUtil.log('executeActivityRoll - flag set', [damageConfig]);\n\n          const isDamageOnlyActivity = activity.type === ACTIVITY_TYPES.DAMAGE || activity.type === ACTIVITY_TYPES.SAVE || !activity?.attack;\n          const isSaveActivity = activity.type === ACTIVITY_TYPES.SAVE;\n          const isAttackActivity = activity.type === ACTIVITY_TYPES.ATTACK;\n\n          switch(activity.type){\n            case ACTIVITY_TYPES.DAMAGE:\n              await this.executeDamageActivity(actor, activity, config);\n              break;\n            case ACTIVITY_TYPES.SAVE:\n              await this.executeSaveActivity(actor, activity, config);\n              break;\n            case ACTIVITY_TYPES.HEAL:\n              await this.executeHealActivity(actor, activity, config);\n              break;\n            case ACTIVITY_TYPES.ATTACK:\n              await this.executeDamagefromAttack(actor, activity, config, damageConfig);\n              break;\n            default:\n              LogUtil.error('executeActivityRoll | untracked activity type', [activity.type]);\n              break;\n          }\n\n          /*\n          if(isMidiActive && isDamageOnlyActivity){\n            await this.midiActivityRoll(activity, config.usage);\n          } else if(!game.user.isGM && isDamageOnlyActivity){\n            LogUtil.log('executeActivityRoll - calling damage use', [activity, config]);\n            await activity.use(config.usage, config.dialog, config.message);\n          }\n          \n          try {\n            if(isMidiActive) {\n              const MidiQOL = ModuleHelpers.getMidiQOL();\n              if (MidiQOL) {\n                const workflow = MidiQOL.Workflow?.getWorkflow(activity.uuid);\n                workflow.midiOptions = {\n                  fastForward: false,\n                  autoFastDamage: false,\n                  autoRollDamage: false\n                }\n                \n                if(workflow && isSaveActivity){ \n                  const damageRoll = await workflow.activity.rollDamage({\n                    ...damageConfig,\n                    workflow: workflow\n                  }, {\n                    ...config.dialog,\n                    configure: true\n                  }, {});\n                }\n                \n                // await activity.rollDamage(damageConfig, config.dialog, config.message);\n                return;\n              }\n            }else{\n              LogUtil.log('executeActivityRoll - isDamageOnlyActivity', [isDamageOnlyActivity, activity, damageConfig, config]);\n              if(isDamageOnlyActivity && config.usage.skipRollDialog){\n                await activity.use(config.usage, {\n                  ...config.dialog,\n                  configure: !config.usage.skipRollDialog,\n                }, config.message);\n              }\n              if((isDamageOnlyActivity && !isSaveActivity) || isAttackActivity){\n                config.usage.consume = getConsumptionConfig(config.usage.consume || {}, true);\n                config.usage.create = getCreateConfig(config.usage.create || {});\n\n                if(activity.type !== ACTIVITY_TYPES.DAMAGE && activity.type !== ACTIVITY_TYPES.HEAL){\n                  // Only call rollDamage if it wasn't already handled by use() on player side\n                  await activity.rollDamage(damageConfig, config.dialog, config.message);\n                }\n              }\n            }\n          } catch (error) {\n            LogUtil.error(\"executeActivityRoll - damage roll error\",[error]);\n          } finally {\n            await activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n          }\n          return;\n        default:\n          LogUtil.log('executeActivityRoll - unknown roll type', [normalizedRollType]);\n          await activity.use(config.usage, config.dialog, config.message);\n          return;\n          */\n      }\n      return;\n    }\n      \n    throw new Error(`No suitable method found for ${normalizedRollType} on item ${item.name}`);\n  }\n\n\n  /**\n   * Calls activity use for attack requests \n   * or for local GM activity use if player is offline\n   * Stores tempAttackConfig flag so full config data can be retrieved in preRoll hook\n   */\n  static async executeAttackActivity(actor, activity, config){\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n    LogUtil.log('executeAttackActivity', [config]);\n          \n    const rollRequestConfig = {\n      attackMode: config.usage.attackMode,\n      ammunition: config.usage.ammunition,\n      mastery: config.usage.mastery,\n      situational: config.usage.rolls?.[0]?.data?.situational,\n      advantage: config.usage.advantage,\n      disadvantage: config.usage.disadvantage,\n      rollMode: config.message?.rollMode,\n      skipRollDialog: config.usage.skipRollDialog,\n      consume: config.usage.consume,\n      create: config.usage.create\n    };\n    config.message.create = true;\n    await activity.item.setFlag(MODULE_ID, 'tempAttackConfig', rollRequestConfig);\n    \n    try {\n      if(isMidiActive){\n        config.usage.consume = getConsumptionConfig(config.usage.consume || {}, true);\n        await this.midiActivityRoll(activity, config.usage);\n      }else{\n        await activity.use(config.usage, config.dialog, config.message);\n      }\n    } catch (error) {\n      LogUtil.error('executeAttackActivity - attack roll error', [error]);\n    } finally {\n      await activity.item.unsetFlag(MODULE_ID, 'tempAttackConfig');\n    }\n  }\n\n  static async executeSaveActivity(actor, activity, config, damageConfig){\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n    try {\n      \n      if(isMidiActive){\n        config.usage.consume = getConsumptionConfig(config.usage.consume || {}, true);\n        await this.midiActivityRoll(activity, config.usage);\n\n        // const MidiQOL = ModuleHelpers.getMidiQOL();\n        // const workflow = MidiQOL.Workflow?.getWorkflow(activity.uuid);\n        // if (!MidiQOL || !workflow) return;\n        // workflow.midiOptions = {\n        //   fastForward: false,\n        //   autoFastDamage: false,\n        //   autoRollDamage: false\n        // }\n        \n        // const damageRoll = await workflow.activity.rollDamage({\n        //   ...damageConfig,\n        //   workflow: workflow\n        // }, {\n        //   ...config.dialog,\n        //   configure: true\n        // }, {});\n      }else{\n        LogUtil.log('executeSaveActivity - calling activity use', [activity, config]);\n        await activity.use(config.usage, config.dialog, config.message);\n      }\n    } catch (error) {\n      LogUtil.error('executeSaveActivity - save roll error', [error]);\n    } finally {\n      await activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n      await activity.item.unsetFlag(MODULE_ID, 'tempSaveConfig');\n    }\n  }\n\n  static async executeDamageActivity(actor, activity, config){\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n    try {\n      if(isMidiActive){\n        config.usage.consume = getConsumptionConfig(config.usage.consume || {}, true);\n        await this.midiActivityRoll(activity, config.usage);\n      }else{\n        LogUtil.log('executeDamageActivity - calling damage use', [activity, config]);\n        await activity.use(config.usage, config.dialog, config.message);\n      }\n    } catch (error) {\n      LogUtil.error('executeDamageActivity - roll error', [error]);\n    } finally {\n      await activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n    }\n  }\n\n  static async executeHealActivity(actor, activity, config){\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n    try {\n      if(isMidiActive){\n        config.usage.consume = getConsumptionConfig(config.usage.consume || {}, true);\n        await this.midiActivityRoll(activity, config.usage);\n      }else{\n        LogUtil.log('executeHealActivity - calling use', [activity, config]);\n        await activity.use(config.usage, config.dialog, config.message);\n      }\n    } catch (error) {\n      LogUtil.error('executeHealActivity - roll error', [error]);\n    } finally {\n      await activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n    }\n  }\n\n  static async executeDamagefromAttack(actor, activity, config, damageConfig){\n    await activity.rollDamage(damageConfig, config.dialog, config.message);\n  }\n  \n  /**\n   * Get display information for an activity\n   * @param {Activity5e} activity - The activity\n   * @returns {Object} - Display information\n   */\n  static getActivityDisplayInfo(activity) {\n    LogUtil.log('getActivityDisplayInfo', [activity]);\n    if (!activity) return null;\n    \n    return {\n      name: activity.name || activity.constructor.metadata.label,\n      type: activity.type,\n      icon: activity.constructor.metadata.icon,\n      canAttack: activity.type === 'attack',\n      canDamage: ['attack', 'damage', 'save'].includes(activity.type),\n      canSave: activity.type === 'save'\n    };\n  }\n  \n  /**\n   * Get damage formula string from an activity\n   * @param {Activity5e} activity - The activity\n   * @returns {string|null} - Combined damage formula or null\n   */\n  static getDamageFormula(activity) {\n    LogUtil.log('getDamageFormula', [activity]);\n    if (!activity?.damage?.parts?.length) return null;\n    \n    // Extract all damage formulas and combine them\n    const formulas = activity.damage.parts.map(part => part.formula).filter(f => f);\n    return formulas.length > 0 ? formulas.join(' + ') : null;\n  }\n\n  static async midiActivityRoll(activity, config = {}) {\n    LogUtil.log('midiActivityRoll', [activity, config]);\n    \n    const MidiQOL = ModuleHelpers.getMidiQOL();\n    if (!MidiQOL) {\n      LogUtil.warn('MidiQOL is not active');\n      return;\n    }\n    \n    let defaultConfig = {\n      consume: {\n        action: false,\n        resources: [],\n        spellSlot: false\n      }\n    };\n    let defaultOptions = {\n      consume: {\n        action: false,\n        resources: [],\n        spellSlot: false\n      },\n      fastForward: false,\n      fastForwardAttack: false,\n      dialogOptions: {\n        fastForward: false,\n        fastForwardAttack: false,\n        fastForwardDamage: false\n      },\n      // targetUuids: targets.map(i => i.document.uuid),\n      configureDialog: true,\n      // ignoreUserTargets: true,\n      midiOptions: {\n        autoRollAttack: false,\n        autoFastAttack: false,\n        autoRollDamage: 'none',\n        autoFastDamage: false,\n        fastForward: false,\n        fastForwardAttack: false,\n        fastForwardDamage: false,\n        // autoConsumeResource: \"none\"\n      }\n    };\n    activity.midiProperties = {\n      ...activity.midiProperties,\n      forceDamageDialog: \"always\"\n    }\n\n    // options = genericUtils.mergeObject(defaultOptions, options);\n    config = {...defaultOptions, ...config};\n\n    LogUtil.log('midiActivityRoll - config', [config]);\n\n    //defaultOptions\n    return await MidiQOL.completeActivityUse(activity, config, {});\n    // return await MidiQOL.completeItemUse(item, config, defaultOptions);\n  }\n\n}","import { getSettings } from \"../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport RollRequestsMenu from \"../ui/RollRequestsMenu.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\n\n/**\n * Utility class for managing sidebar controls\n */\nexport class SidebarController {\n  /**\n   * Add the roll request bolt icon to sidebar\n   * @param {SidebarTab} app - The sidebar tab application\n   * @param {jQuery} html - The rendered HTML\n   */\n  static addSidebarControls(app, html) {\n    LogUtil.log(\"addSidebarControls\",[app, html]);\n    if (!game.user.isGM || !app || app.id !== \"sidebar\") return;\n    \n    // Find the chat controls container\n    const chatControls = document.querySelector(\"#roll-privacy\");\n    LogUtil.log(\"addSidebarControls\",[chatControls]);\n\n    if (!chatControls || chatControls.querySelector('.flash-rolls-icon')) {\n      return;\n    }\n    \n    // Get current settings to determine initial state\n    const SETTINGS = getSettings();\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    \n    // Create the roll request icon\n    const rollRequestIcon = document.createElement('button');\n    rollRequestIcon.id = \"flash-rolls-icon\"; \n    rollRequestIcon.setAttribute(\"data-tooltip-direction\", \"RIGHT\");\n    rollRequestIcon.className = `ui-control icon chat-control-icon flash-rolls-icon${rollRequestsEnabled ? ' active' : ''}`;\n    rollRequestIcon.title = game.i18n.localize('FLASH_ROLLS.ui.menus.rollRequestsTitle');\n    rollRequestIcon.innerHTML = `<i class=\"fas fa-bolt${rollRequestsEnabled ? '' : '-slash'}\"></i>`;\n    \n    // Insert before the d20 dice icon\n    const firstChatControlIcon = chatControls.firstChild;\n    if (firstChatControlIcon) {\n      firstChatControlIcon.parentNode.insertBefore(rollRequestIcon, firstChatControlIcon);\n    } else {\n      chatControls.insertBefore(rollRequestIcon, chatControls.firstChild);\n    }\n\n    LogUtil.log(\"addSidebarControls\",[firstChatControlIcon, rollRequestIcon]);\n    \n    rollRequestIcon.addEventListener(\"click\", (event) => {\n      event.stopPropagation();\n      event.preventDefault();\n      RollRequestsMenu.toggle();\n    });\n  }\n  \n  /**\n   * Update the roll requests icon based on enabled state\n   * @param {boolean} enabled - Whether roll requests are enabled\n   */\n  static updateRollRequestsIcon(enabled) {\n    const icon = document.querySelector('#flash-rolls-icon i');\n    if (icon) {\n      icon.className = `fas fa-bolt${enabled ? '' : '-slash'}`;\n    }\n  }\n}","import { MODULE } from \"../../../constants/General.mjs\";\nimport { LogUtil } from \"../../utils/LogUtil.mjs\";\n\n/**\n * Custom Roll Dialog - ApplicationV2 component for custom roll formulas\n */\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\nexport class CustomRollDialog extends HandlebarsApplicationMixin(ApplicationV2) {\n  constructor(options = {}) {\n    super(options);\n    this.formula = options.formula || \"\";\n    this.readonly = options.readonly || false;\n    this.actor = options.actor;\n    this.callback = options.callback;\n    this.diceCounts = {};\n  }\n\n  /**\n   * Default application configuration\n   */\n  static get DEFAULT_OPTIONS() {\n    return foundry.utils.mergeObject(super.DEFAULT_OPTIONS, {\n      classes: [\"flash5e-dialog\", \"flash5e-custom-roll-dialog\"],\n      tag: \"div\",\n      window: {\n        title: \"FLASH_ROLLS.ui.dialogs.customRollTitle\",\n        icon: \"fas fa-dice-d20\",\n        resizable: false,\n        positioned: true,\n        frame: true\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      }\n    });\n  }\n  \n  /**\n   * Override to provide unique ID per actor\n   */\n  get id() {\n    return `flash5e-custom-roll-dialog-${this.actor?.id || 'unknown'}`;\n  }\n  \n  /**\n   * Override to provide unique title per actor\n   */\n  get title() {\n    const baseTitle = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.customRollTitle\");\n    if (this.actor) {\n      return `${baseTitle} - ${this.actor.name}`;\n    }\n    return baseTitle;\n  }\n  \n  /**\n   * Override to handle action clicks\n   */\n  _onClickAction(event, target) {\n    const action = target.dataset.action;\n    switch (action) {\n      case \"rollDice\":\n        return this.rollDice(event, target);\n      case \"addDie\":\n        return this.addDie(event, target);\n      case \"cancel\":\n        return this.cancel(event, target);\n    }\n  }\n\n  /**\n   * Prepare application rendering context\n   */\n  async _prepareContext(options = {}) {\n    const context = await super._prepareContext(options);\n    return {\n      ...context,\n      formula: this.formula,\n      readonly: this.readonly\n    };\n  }\n\n  /**\n   * Define template parts\n   */\n  static PARTS = {\n    main: {\n      template: `modules/${MODULE.ID}/templates/custom-roll-dialog.hbs`\n    },\n    footer: {\n      template: `modules/${MODULE.ID}/templates/custom-roll-dialog-footer.hbs`\n    }\n  };\n\n  /**\n   * Add event listeners\n   */\n  _attachPartListeners(partId, htmlElement, options) {\n    super._attachPartListeners(partId, htmlElement, options);\n    \n    const formulaInput = htmlElement.querySelector('#custom-roll-formula');\n    const validationMessage = htmlElement.querySelector('#formula-validation-message');\n    \n    if (formulaInput && !this.readonly) {\n      formulaInput.addEventListener('input', (event) => {\n        this.formula = event.target.value.trim();\n        this.updateValidationMessage(validationMessage);\n      });\n      \n      if (this.formula) {\n        this.updateValidationMessage(validationMessage);\n      }\n    }\n  }\n  \n  /**\n   * Update the validation message based on formula validity\n   * @param {HTMLElement} messageElement - The validation message element\n   */\n  updateValidationMessage(messageElement) {\n    if (!messageElement) return;\n    \n    if (!this.formula) {\n      messageElement.textContent = '&nbsp;';\n      messageElement.classList.remove('error', 'success');\n      return;\n    }\n    \n    const isValid = this.validateFormula(this.formula);\n    \n    if (isValid) {\n      messageElement.textContent = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.formulaValid\");\n      messageElement.classList.remove('error');\n      messageElement.classList.add('success');\n    } else {\n      messageElement.textContent = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.formulaInvalid\");\n      messageElement.classList.remove('success');\n      messageElement.classList.add('error');\n    }\n  }\n\n  /**\n   * Handle dice button click\n   * @param {Event} event\n   * @param {HTMLElement} target\n   */\n  addDie(event, target) {\n    const die = target.dataset.die;\n    \n    const formulaInput = this.element.querySelector('#custom-roll-formula');\n    if (!formulaInput) return;\n    \n    const currentFormula = formulaInput.value.trim();\n    \n    if (currentFormula) {\n      const diceRegex = /(\\d*)d(\\d+)/g;\n      const diceMap = new Map();\n      \n      let remainingFormula = currentFormula;\n      let match;\n      \n      while ((match = diceRegex.exec(currentFormula)) !== null) {\n        const count = parseInt(match[1] || '1');\n        const dieType = match[2];\n        diceMap.set(dieType, (diceMap.get(dieType) || 0) + count);\n        remainingFormula = remainingFormula.replace(match[0], '').trim();\n      }\n      \n      const newDieType = die.substring(1); // Remove 'd' prefix\n      diceMap.set(newDieType, (diceMap.get(newDieType) || 0) + 1);\n      \n      const diceParts = [];\n      for (const [dieType, count] of diceMap) {\n        diceParts.push(`${count}d${dieType}`);\n      }\n      \n      remainingFormula = remainingFormula.replace(/^\\+\\s*|\\s*\\+\\s*$|\\s*\\+\\s*\\+/g, '').trim();\n      \n      if (remainingFormula && remainingFormula !== '+') {\n        this.formula = `${diceParts.join(' + ')} + ${remainingFormula}`;\n      } else {\n        this.formula = diceParts.join(' + ');\n      }\n    } else {\n      this.formula = `1${die}`;\n    }\n    formulaInput.value = this.formula;\n    \n    formulaInput.dispatchEvent(new Event('input'));\n  }\n\n  /**\n   * Validate the formula using Roll.validate\n   * @param {string} formula\n   * @returns {boolean}\n   */\n  validateFormula(formula) {\n    if (!formula || formula.trim() === \"\") return false;\n    \n    try {\n      return Roll.validate(formula);\n    } catch (error) {\n      try {\n        new Roll(formula, this.actor?.getRollData() || {});\n        return true;\n      } catch (e) {\n        return false;\n      }\n    }\n  }\n\n  /**\n   * Handle roll button click\n   */\n  async rollDice() {\n    LogUtil.log('rollDice');\n    if (!this.validateFormula(this.formula)) {\n      ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.notifications.invalidFormula\", {\n        formula: this.formula || \"empty\"\n      }));\n      return;\n    }\n    \n    if (this.callback) {\n      await this.callback(this.formula);\n    }\n    \n    this.close();\n  }\n\n  /**\n   * Handle cancel button click\n   */\n  cancel() {\n    this.close();\n  }\n\n  /**\n   * Show the dialog and return a promise for the formula\n   * @param {Object} options\n   * @returns {Promise<string|null>}\n   */\n  static async prompt(options = {}) {\n    return new Promise((resolve) => {\n      const dialog = new this({\n        ...options,\n        callback: (formula) => resolve(formula)\n      });\n      \n      dialog.addEventListener(\"close\", () => {\n        if (!dialog._resolved) {\n          resolve(null);\n        }\n      });\n      \n      dialog.render(true);\n    });\n  }\n\n  /**\n   * Override close to track resolution\n   */\n  async close(options = {}) {\n    this._resolved = true;\n    return super.close(options);\n  }\n}","import { HOOKS_CORE } from \"../../constants/Hooks.mjs\";\nimport { MODULE_ID, ROLL_TYPES } from \"../../constants/General.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { RollHelpers } from \"../helpers/RollHelpers.mjs\";\nimport { RollHandlers } from \"../handlers/RollHandlers.mjs\";\nimport { HooksManager } from \"../core/HooksManager.mjs\";\n\n/**\n * Utility class for managing group roll chat messages\n */\nexport class ChatMessageManager {\n  /**\n   * Map of requestId to chat message document\n   * @type {Map<string, ChatMessage>}\n   */\n  static groupRollMessages = new Map();\n  \n  /**\n   * Map of requestId to pending roll data\n   * @type {Map<string, Object>}\n   */\n  static pendingRolls = new Map();\n  \n  /**\n   * Set of message IDs that are scheduled for deletion\n   * @type {Set<string>}\n   */\n  static messagesScheduledForDeletion = new Set();\n  \n  /**\n   * Queue for serializing group message updates\n   * @type {Map<string, Promise>}\n   */\n  static updateQueue = new Map();\n  \n  /**\n   * Path to the group roll template\n   * @type {string}\n   */\n  static templatePath = 'modules/flash-rolls-5e/templates/chat-msg-group-roll.hbs';\n  \n  /**\n   * Initialize the ChatMessageManager\n   */\n  static async initialize() {\n    LogUtil.log('ChatMessageManager.initialize');\n    await this.preloadTemplate();\n  }\n\n  /**\n   * Handle chat message creation for debugging purposes\n   * @param {ChatMessage} message - The created message\n   * @param {Object} options - Creation options\n   * @param {string} userId - ID of the user who created the message\n   */\n  static onCreateChatMessage(message, options, userId, data) {\n    LogUtil.log('ChatMessageManager.onCreateChatMessage', [message, options, userId, data]);\n  }\n\n  /**\n   * Handle pre-create chat message to add group roll flags and requested-by flavor\n   * @param {ChatMessage} message - The message being created\n   * @param {Object} data - Message data\n   * @param {Object} options - Creation options\n   * @param {string} userId - ID of the creating user\n   */\n  static onPreCreateChatMessage(message, data, options, userId) {\n    LogUtil.log('ChatMessageManager.onPreCreateChatMessage', [message, data, options, userId]);\n\n    if (data._showRequestedBy && data.rolls?.length > 0) {\n      const requestedBy = data._requestedBy || 'GM';\n      const requestedText = game.i18n.format('FLASH_ROLLS.chat.requestedBy', { gm: requestedBy });\n\n      const currentFlavor = data.flavor || '';\n      data.flavor = currentFlavor ? `${currentFlavor} ${requestedText}` : requestedText;\n    }\n\n    if (data.flags?.[MODULE_ID]?.groupRollId) {\n      LogUtil.log('ChatMessageManager.onPreCreateChatMessage - Found groupRollId in data flags', [data]);\n    }\n\n    if (data.rolls?.length > 0 || data.flags?.core?.initiativeRoll) {\n      const speaker = data.speaker;\n      const actorId = speaker?.actor;\n\n      if (actorId) {\n        let actor = game.actors.get(actorId);\n\n        if (!actor && speaker?.token) {\n          const token = canvas.tokens.get(speaker.token);\n          if (token?.actor) {\n            actor = token.actor;\n            LogUtil.log('ChatMessageManager.onPreCreateChatMessage - Using token actor from speaker', [actor.name, actor.id]);\n          }\n        }\n\n        if (!actor) {\n          LogUtil.log('ChatMessageManager.onPreCreateChatMessage - No actor found', [actorId, speaker]);\n          return;\n        }\n\n        if (game.user.isGM) {\n          const baseActorId = actor.isToken ? actor.actor?.id : actor.id;\n          const checkIds = [actorId, baseActorId].filter(id => id);\n\n          for (const [groupRollId, pendingData] of ChatMessageManager.pendingRolls.entries()) {\n            const actorEntries = pendingData.actorEntries || (pendingData.actors ? pendingData.actors.map(id => ({ actorId: id })) : []);\n            if (checkIds.some(id => actorEntries.some(entry => entry.actorId === id))) {\n              data.flags = data.flags || {};\n              data.flags[MODULE_ID] = data.flags[MODULE_ID] || {};\n              data.flags[MODULE_ID].groupRollId = groupRollId;\n              data.flags.rsr5e = { processed: true, quickRoll: false};\n              LogUtil.log('ChatMessageManager.onPreCreateChatMessage - Added groupRollId flag (GM)', [groupRollId, actorId]);\n              break;\n            }\n          }\n        } else {\n          let storedGroupRollId = actor.getFlag(MODULE_ID, 'tempGroupRollId');\n          if (!storedGroupRollId && actor.isToken) {\n            const baseActor = game.actors.get(actor.actor?.id);\n            if (baseActor) {\n              storedGroupRollId = baseActor.getFlag(MODULE_ID, 'tempGroupRollId');\n              LogUtil.log('ChatMessageManager.onPreCreateChatMessage - Checking base actor for tempGroupRollId', [baseActor.id, storedGroupRollId]);\n            }\n          }\n\n          if (storedGroupRollId) {\n            actor.unsetFlag(MODULE_ID, 'tempGroupRollId');\n            if (actor.isToken) {\n              const baseActor = game.actors.get(actor.actor?.id);\n              if (baseActor) {\n                baseActor.unsetFlag(MODULE_ID, 'tempGroupRollId');\n              }\n            }\n          }\n\n          let storedInitConfig = actor.getFlag(MODULE_ID, 'tempInitiativeConfig');\n\n          if (!storedInitConfig && actor.isToken) {\n            const baseActor = game.actors.get(actor.actor?.id);\n            if (baseActor) {\n              storedInitConfig = baseActor.getFlag(MODULE_ID, 'tempInitiativeConfig');\n            }\n          }\n\n          if (storedInitConfig?.groupRollId || storedGroupRollId) {\n            data.flags = data.flags || {};\n            data.flags[MODULE_ID] = data.flags[MODULE_ID] || {};\n            data.flags[MODULE_ID].groupRollId = storedGroupRollId || storedInitConfig?.groupRollId || '';\n            data.flags.rsr5e = { processed: true, quickRoll: false};\n          }\n        }\n      }\n    }\n\n    if (data.rolls?.length > 0 && data.rolls[0]) {\n      try {\n        const rollData = data.rolls[0];\n        if (rollData.options?._customFlavor) {\n          data.flavor = rollData.options._customFlavor;\n        }\n      } catch (error) {\n        LogUtil.error(\"ChatMessageManager.onPreCreateChatMessage - flavor error\", [error]);\n      }\n    }\n  }\n\n  /**\n   * Handle rendering of chat messages to process group rolls and add UI elements\n   * @param {ChatMessage} message - The message being rendered\n   * @param {HTMLElement} html - The rendered HTML\n   * @param {Object} context - Rendering context\n   */\n  static onRenderChatMessage(message, html, context) {\n    LogUtil.log(\"ChatMessageManager.onRenderChatMessage #0\", [message, html, context]);\n\n    ChatMessageManager.interceptRollMessage(message, html, context);\n\n    if (message.getFlag(MODULE_ID, 'isGroupRoll')) {\n      const SETTINGS = getSettings();\n      const globalHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n      const messageHidden = message.getFlag(MODULE_ID, 'npcHiddenOverride');\n      const isGM = game.user.isGM;\n\n      const shouldHideNPCs = (messageHidden !== undefined ? messageHidden : globalHidden) && !isGM;\n\n      if (shouldHideNPCs) {\n        const flagData = message.getFlag(MODULE_ID, 'rollData');\n        if (flagData && flagData.results) {\n          const actorResults = html.querySelectorAll('.actor-result');\n          actorResults.forEach((element, index) => {\n            const result = flagData.results[index];\n            if (result) {\n              const actor = game.actors.get(result.actorId);\n              const shouldHide = actor && !actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER);\n\n              if (shouldHide) {\n                element.classList.add('npc-hidden');\n              }\n            }\n          });\n        }\n      }\n\n      ChatMessageManager._attachGroupRollListeners(html, message);\n    }\n\n    this._addSelectTargetsButton(message, html);\n\n    if(game.user.isGM){\n      let item = context.subject?.item;\n      if (!item && message.flags?.dnd5e?.item?.uuid) {\n        item = fromUuidSync(message.flags.dnd5e.item.uuid);\n      }\n\n      if (item) {\n        setTimeout(() => {\n          HooksManager.activityConfigCache.delete(item.id);\n          LogUtil.log(\"ChatMessageManager.onRenderChatMessage - cleared activity config cache\", [item.id]);\n        }, 1000);\n      }\n    }\n\n    if (!game.user.isGM) {\n      const hasFlashRollsFlag = message.flags?.[MODULE_ID]?.isFlashRollRequest ||\n                               message.flags?.[MODULE_ID]?.groupRollId ||\n                               message.getFlag('dnd5e', 'roll')?._requestedBy;\n\n      if (hasFlashRollsFlag) {\n        const challengeVisibility = game.settings.get(\"dnd5e\", \"challengeVisibility\");\n\n        let showDC = true;\n        switch(challengeVisibility) {\n          case \"none\":\n            showDC = false;\n            break;\n          case \"all\":\n            showDC = true;\n            break;\n          case \"player\":\n            showDC = message.author.id === game.user.id || !message.author.isGM;\n            break;\n          default:\n            showDC = true;\n            break;\n        }\n\n        if (showDC===false) {\n          setTimeout(() => {\n            const chatCard = html.querySelectorAll(\"[data-display-challenge]\");\n            chatCard.forEach((el) => delete el.dataset.displayChallenge);\n\n            const diceTotals = html.querySelectorAll(\".success, .failure, .critical, .fumble\");\n            diceTotals?.forEach((el) => {\n              el.classList.remove(\"success\", \"failure\", \"critical\", \"fumble\");\n            });\n\n            diceTotals?.forEach((el) => el.querySelector(\".icons\")?.remove());\n\n            html.querySelectorAll(\".save-dc, .dc, .target-dc\").forEach((el) => {\n              const text = el.textContent;\n              if (text && text.includes(\"DC\")) {\n                el.textContent = text.replace(/DC\\s*\\d+/gi, \"\");\n              }\n            });\n          }, 50);\n        }\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Handle rendering of chat log to attach listeners to existing group roll messages\n   * @param {Application} app - The chat log application\n   * @param {HTMLElement} html - The rendered HTML\n   */\n  static onRenderChatLog(app, html) {\n    const groupRollElements = html.querySelectorAll('.flash5e-group-roll');\n    groupRollElements.forEach(element => {\n      const messageElement = element.closest('.chat-message');\n      if (messageElement) {\n        const messageId = messageElement.dataset.messageId;\n        const message = game.messages.get(messageId);\n        if (message && message.getFlag(MODULE_ID, 'isGroupRoll')) {\n\n          const SETTINGS = getSettings();\n          const globalHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n          const messageHidden = message.getFlag(MODULE_ID, 'npcHiddenOverride');\n          const isGM = game.user.isGM;\n\n          const shouldHideNPCs = (messageHidden !== undefined ? messageHidden : globalHidden) && !isGM;\n\n          if (shouldHideNPCs) {\n            const flagData = message.getFlag(MODULE_ID, 'rollData');\n            if (flagData && flagData.results) {\n              const actorResults = element.querySelectorAll('.actor-result');\n              actorResults.forEach((actorElement, index) => {\n                const result = flagData.results[index];\n                if (result) {\n                  const actor = game.actors.get(result.actorId);\n                  const shouldHide = actor && !actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER);\n\n                  if (shouldHide) {\n                    actorElement.classList.add('npc-hidden');\n                  }\n                }\n              });\n            }\n          }\n\n          ChatMessageManager._attachGroupRollListeners(element, message);\n        }\n      }\n    });\n\n    const damageMessages = html.querySelectorAll('.chat-message');\n    damageMessages.forEach(messageElement => {\n      const messageId = messageElement.dataset.messageId;\n      const message = game.messages.get(messageId);\n\n      if (message?.flags?.dnd5e?.roll?.type === 'damage' && message.flags?.dnd5e?.item?.uuid) {\n        const itemUuid = message.flags.dnd5e.item.uuid;\n        const item = fromUuidSync(itemUuid);\n\n        if (item && !HooksManager.templateRemovalTimers.has(itemUuid)) {\n          LogUtil.log(\"ChatMessageManager.onRenderChatLog - scheduling template removal for rendered damage message\", [item.name, itemUuid]);\n\n          HooksManager.templateRemovalTimers.add(itemUuid);\n\n          const SETTINGS = getSettings();\n          const timeoutSeconds = SettingsUtil.get(SETTINGS.templateRemovalTimeout.tag);\n          const timeoutMs = timeoutSeconds * 1000;\n\n          setTimeout(() => {\n            GeneralUtil.removeTemplateForItem(item);\n            HooksManager.templateRemovalTimers.delete(itemUuid);\n          }, timeoutMs);\n        }\n      }\n    });\n  }\n\n  /**\n   * Add \"Select Targeted\" button to damage roll messages with saves\n   * @param {ChatMessage} message - The chat message\n   * @param {jQuery} html - The rendered HTML\n   */\n  static _addSelectTargetsButton(message, html) {\n    if(!game.user.isGM) return;\n    LogUtil.log(\"ChatMessageManager._addSelectTargetsButton #0\", [message, html, html.querySelector('.message-content')]);\n    if (message.flags?.dnd5e?.roll?.type !== 'damage' || html.querySelector('.select-targeted')) return;\n\n    const button = document.createElement('button');\n    button.className = 'select-targeted';\n    button.type = 'button';\n    button.setAttribute(\"data-tooltip-direction\", \"LEFT\");\n    button.setAttribute(\"data-tooltip\", \"Select Targeted\");\n    button.innerHTML = '<i class=\"fas fa-crosshairs\"></i>';\n\n    button.addEventListener('click', (event) => {\n      event.preventDefault();\n      this._selectTargetedTokens(event);\n    });\n\n    html.querySelector('.message-content').appendChild(button);\n    message.update({\n      content: html\n    });\n  }\n\n  /**\n   * Select all currently targeted tokens as damage targets\n   * @param {Event} event - The click event\n   */\n  static _selectTargetedTokens(event) {\n    const message = event.currentTarget.closest('.chat-message');\n    const targets = message.querySelectorAll(\"[data-target-uuid]\");\n\n    if (targets.length === 0) {\n      ui.notifications.warn(game.i18n.localize(\"FLASH_ROLLS.notifications.noTargetedTokens\"));\n      return;\n    }\n\n    for ( let i=0; i < targets.length; i++ ) {\n      const target = targets[i];\n      const actorId = target.dataset.targetUuid.split('Actor.')[1];\n      const tokens = canvas.tokens.placeables.filter(t => {\n        return t.document.actor?.id === actorId || t.document.baseActor?.id === actorId;\n      });\n      tokens.forEach((token, j) => {\n        if(token && token.control){\n          token.control({ releaseOthers: i===0 });\n        }\n      });\n    }\n  }\n  \n\n  /**\n   * Static method to attach group roll listeners to HTML elements\n   * @param {HTMLElement} html - The HTML element containing group roll elements\n   * @param {ChatMessage} message - The chat message instance\n   */\n  static _attachGroupRollListeners(html, message) {\n    html.querySelectorAll('.actor-result').forEach(element => {\n      element.addEventListener('click', (event) => {\n        if (event.target.closest('.dice-btn.rollable')) {\n          return;\n        }\n        \n        event.preventDefault();\n        event.stopPropagation();\n        \n        const actorResult = element;\n        \n        LogUtil.log('actor-result click', [element]);\n\n        if (actorResult.classList.contains('expanded')) {\n          actorResult.classList.remove('expanded');\n        } else {\n          actorResult.classList.add('expanded');\n        }\n      });\n    });\n    \n    html.querySelectorAll('.dice-btn.rollable').forEach(diceBtn => {\n      diceBtn.addEventListener('click', async (event) => {\n        event.preventDefault();\n        event.stopPropagation();\n        event.stopImmediatePropagation();\n        \n        const dataset = diceBtn.dataset;\n        const actorId = dataset.actorId;\n        const actor = game.actors.get(actorId);\n        \n        if (!actor) {\n          ui.notifications.warn(`Actor not found`);\n          return;\n        }\n        \n        const canRoll = game.user.isGM || actor.isOwner;\n        if (!canRoll) {\n          ui.notifications.warn(`You don't have permission to roll for ${actor.name}`);\n          return;\n        }\n        \n        const rollType = dataset.type?.toLowerCase();\n        const rollKey = dataset.rollKey;\n        const groupRollId = dataset.groupRollId;\n        const dc = dataset.dc ? parseInt(dataset.dc) : null;\n        \n        LogUtil.log('Rollable dice clicked', [rollType, rollKey, actorId, groupRollId]);\n        \n        const requestData = {\n          rollKey: rollKey,\n          groupRollId: groupRollId,\n          config: {\n            advantage: false,\n            disadvantage: false,\n            target: dc,\n            rollMode: game.settings.get(\"core\", \"rollMode\")\n          }\n        };\n        \n        // Dialog configuration - show dialog for rolls\n        const dialogConfig = {\n          configure: true,\n          isRollRequest: true\n        };\n        \n        const messageConfig = {\n          rollMode: game.settings.get(\"core\", \"rollMode\"),\n          create: true,\n          isRollRequest: true\n        };\n        \n        const rollConfig = {\n          parts: [],\n          data: {},\n          options: {}\n        };\n        \n        try {\n          const handler = RollHandlers[rollType];\n          if (handler) {\n            await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n          } else {\n            let rollMethod;\n            switch(rollType) {\n              case ROLL_TYPES.SKILL:\n                rollMethod = 'rollSkill';\n                break;\n              case ROLL_TYPES.ABILITY:\n              case ROLL_TYPES.ABILITY_CHECK:\n                rollMethod = 'rollAbilityTest';\n                break;\n              case ROLL_TYPES.SAVE:\n              case ROLL_TYPES.SAVING_THROW:\n                rollMethod = 'rollAbilitySave';\n                break;\n              case ROLL_TYPES.TOOL:\n                rollMethod = 'rollToolCheck';\n                break;\n              default:\n                ui.notifications.warn(`Unknown roll type: ${rollType}`);\n                return;\n            }\n            \n            if (rollMethod && actor[rollMethod]) {\n              await actor[rollMethod](rollKey, {\n                ...requestData.config,\n                messageOptions: { \"flags.flash-rolls-5e.groupRollId\": groupRollId }\n              });\n            }\n          }\n        } catch (error) {\n          LogUtil.error('Error executing roll from chat', error);\n          ui.notifications.error(`Failed to execute roll: ${error.message}`);\n        }\n      });\n    });\n    \n    // Handle DC control visibility and input\n    const dcControl = html.querySelector('.group-roll-dc-control');\n    const dcInput = html.querySelector('.dc-input');\n    \n    if (dcControl) {\n      const showToPlayers = dcControl.dataset.showToPlayers === 'true';\n      if (!game.user.isGM) {\n        dcControl.style.display = 'none';\n      }\n      if (!game.user.isGM && !showToPlayers) {\n        const groupFooterDetails = html.querySelector('.group-roll-footer .group-result-details');\n        if (groupFooterDetails) {\n          groupFooterDetails.style.display = 'none';\n        }\n      }\n    }\n    \n    if (dcInput) {\n      if (!game.user.isGM) {\n        dcInput.readOnly = true;\n        dcInput.style.cursor = 'not-allowed';\n      } else {\n        let debounceTimer = null;\n        \n        const handleDCChange = async () => {\n          const newDC = parseInt(dcInput.value);\n          \n          if (!dcInput.value) return;\n          \n          if (isNaN(newDC) || newDC < 1 || newDC > 99) {\n            dcInput.value = '';\n            return;\n          }\n          \n          const messageId = dcInput.dataset.messageId;\n          const targetMessage = game.messages.get(messageId);\n          \n          if (targetMessage) {\n            await ChatMessageManager.updateGroupRollDC(targetMessage, newDC);\n          }\n        };\n        \n        dcInput.addEventListener('input', (e) => {\n          if (debounceTimer) {\n            clearTimeout(debounceTimer);\n          }\n          \n          debounceTimer = setTimeout(() => {\n            handleDCChange();\n          }, 750);\n        });\n        \n        dcInput.addEventListener('keypress', (e) => {\n          if (e.key === 'Enter') {\n            if (debounceTimer) {\n              clearTimeout(debounceTimer);\n            }\n            handleDCChange();\n          }\n        });\n      }\n    }\n  }\n  \n  /**\n   * Preload the Handlebars template\n   */\n  static async preloadTemplate() {\n    LogUtil.log('ChatMessageManager.preloadTemplate');\n    try {\n      await GeneralUtil.loadTemplates([this.templatePath]);\n    } catch (error) {\n      LogUtil.error('Failed to preload template', error);\n    }\n  }\n  \n  /**\n   * Create a group roll message for multiple actors\n   * @param {Array<{actor: Actor, uniqueId: string, tokenId: string|null}>} actorEntries - Array of actor entries with unique identifiers\n   * @param {string} rollType - Type of roll\n   * @param {string} rollKey - Specific roll key\n   * @param {Object} config - Roll configuration\n   * @param {string} groupRollId - Unique group roll identifier\n   * @returns {Promise<ChatMessage>} The created chat message\n   */\n  static async createGroupRollMessage(actorEntries, rollType, rollKey, config, groupRollId) {\n    LogUtil.log('ChatMessageManager.createGroupRollMessage', [actorEntries.length, rollType, rollKey, groupRollId]);\n    \n    const data = this.buildGroupRollData(actorEntries, rollType, rollKey, config);\n    if (!data) {\n      LogUtil.error('createGroupRollMessage - Failed to build group roll data');\n      return null;\n    }\n    data.groupRollId = groupRollId;\n    const validEntries = actorEntries.filter(entry => entry && entry.actor);\n    const hasPlayerOwnedActor = validEntries.some(entry => RollHelpers.isPlayerOwnerActive(entry.actor));\n    const rollMode = hasPlayerOwnedActor ? \n      CONST.DICE_ROLL_MODES.PUBLIC : \n      game.settings.get(\"core\", \"rollMode\");\n    \n    this.pendingRolls.set(groupRollId, {\n      actorEntries: validEntries.map(entry => ({ actorId: entry.actor.id, uniqueId: entry.uniqueId, tokenId: entry.tokenId })),\n      rollType,\n      rollKey,\n      config,\n      results: new Map()\n    });\n    \n    const message = await this.postGroupMessage(data, rollMode);    \n    return message;\n  }\n  \n  /**\n   * Build the data object for the group roll template\n   * @param {Array<{actor: Actor, uniqueId: string, tokenId: string|null}>} actorEntries - Array of actor entries with unique identifiers\n   * @param {string} rollType - Type of roll\n   * @param {string} rollKey - Specific roll key\n   * @param {Object} config - Roll configuration\n   * @returns {Object} Template data\n   */\n  static buildGroupRollData(actorEntries, rollType, rollKey, config) {\n    \n    const validEntries = actorEntries.filter(entry => entry && entry.actor);\n    if (validEntries.length === 0) {\n      LogUtil.error('buildGroupRollData - No valid actor entries found', [actorEntries]);\n      return null;\n    }\n    \n    let flavor = this._buildFlavorText(rollType, rollKey, config);\n    const dc = config?.dc || config?.target;\n    const results = validEntries.map(entry => ({\n      actorId: entry.actor.id,\n      uniqueId: entry.uniqueId,\n      tokenId: entry.tokenId,\n      actorImg: entry.actor.img || entry.actor.prototypeToken?.texture?.src || 'icons/svg/mystery-man.svg',\n      actorName: entry.tokenId ? \n        (canvas.tokens?.get(entry.tokenId)?.name || entry.actor.name) : \n        entry.actor.name,\n      isNPC: !entry.actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER),\n      rolled: false,\n      showDice: true,\n      total: null,\n      success: false,\n      failure: false\n    }));\n    \n    const supportsDC = RollHelpers.shouldShowDC(rollType);\n    const SETTINGS = getSettings();\n    const showDCToPlayers = SettingsUtil.get(SETTINGS.showGroupDCToPlayers.tag);\n    const groupRollNPCHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n    const isGM = game.user.isGM;\n    \n    // Add shouldHide flag to each result\n    results.forEach(result => {\n      result.shouldHide = result.isNPC && groupRollNPCHidden && !isGM;\n    });\n    \n    return {\n      flavor,\n      results,\n      showDC: dc !== undefined && dc !== null,\n      dc,\n      rollType,\n      rollKey,\n      supportsDC,\n      showDCToPlayers,\n      groupRollNPCHidden,\n      isGM,\n      actorEntries: validEntries.map(entry => ({ actorId: entry.actor.id, uniqueId: entry.uniqueId, tokenId: entry.tokenId })),\n      moduleId: MODULE_ID\n    };\n  }\n  \n  /**\n   * Build flavor text for the roll\n   * @private\n   */\n  static _buildFlavorText(rollType, rollKey, config) {\n    let flavor = '';\n    \n    switch(rollType?.toLowerCase()) {\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.ABILITY_CHECK:\n        const abilityLabel = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        flavor = game.i18n.format(\"DND5E.AbilityPromptTitle\", { ability: abilityLabel });\n        break;\n      case ROLL_TYPES.SAVE:\n      case ROLL_TYPES.SAVING_THROW:\n        const saveLabel = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        flavor = game.i18n.format(\"DND5E.SavePromptTitle\", { ability: saveLabel });\n        break;\n      case ROLL_TYPES.SKILL:\n        const skillLabel = CONFIG.DND5E.skills[rollKey]?.label || rollKey;\n        const skillAbility = config?.ability || CONFIG.DND5E.skills[rollKey]?.ability || 'int';\n        const skillAbilityLabel = CONFIG.DND5E.abilities[skillAbility]?.label || skillAbility;\n        LogUtil.log('buildFlavorText - skill', [config?.ability, skillLabel, skillAbility, skillAbilityLabel]);\n        flavor = game.i18n.format(\"DND5E.SkillPromptTitle\", { \n          skill: skillLabel,\n          ability: skillAbilityLabel\n        });\n        break;\n      case ROLL_TYPES.TOOL:\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        let toolLabel = rollKey;\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          toolLabel = toolItem?.name || rollKey;\n        }\n        const toolAbility = config?.ability || toolData?.ability || 'int';\n        const toolAbilityLabel = CONFIG.DND5E.abilities[toolAbility]?.label || toolAbility;\n        flavor = game.i18n.format(\"DND5E.ToolPromptTitle\", { \n          tool: toolLabel, \n          ability: toolAbilityLabel \n        });\n        break;\n      case ROLL_TYPES.CONCENTRATION:\n        flavor = game.i18n.localize(\"DND5E.Concentration\") || \"Concentration\";\n        break;\n      case ROLL_TYPES.DEATH_SAVE:\n        flavor = game.i18n.localize(\"DND5E.DeathSave\") || \"Death Saving Throw\";\n        break;\n      case ROLL_TYPES.HIT_DIE:\n      case 'hitdice':\n        flavor = game.i18n.localize(\"DND5E.HitDice\") || \"Hit Dice\";\n        break;\n      case ROLL_TYPES.HEALING:\n        flavor = config?.flavor || game.i18n.localize(\"DND5E.Healing\") || \"Healing\";\n        break;\n      case ROLL_TYPES.CUSTOM:\n        flavor = config?.flavor || rollKey || game.i18n.localize(\"DND5E.Roll\") || \"Custom Roll\";\n        break;\n      case ROLL_TYPES.FORMULA:\n        flavor = config?.flavor || rollKey || game.i18n.localize(\"DND5E.Roll\") || \"Custom Formula\";\n        break;\n      case ROLL_TYPES.ITEM_SAVE:\n        flavor = config?.flavor || game.i18n.localize(\"DND5E.SavingThrow\") || \"Saving Throw\";\n        break;\n      case ROLL_TYPES.INITIATIVE:\n        flavor = game.i18n.localize(\"DND5E.Initiative\");\n        break;\n      case ROLL_TYPES.ATTACK:\n        flavor = config?.flavor || game.i18n.localize(\"DND5E.Attack\") || \"Attack Roll\";\n        break;\n      case ROLL_TYPES.DAMAGE:\n        flavor = config?.flavor || game.i18n.localize(\"DND5E.Damage\") || \"Damage Roll\";\n        break;\n      default:\n        flavor = config?.flavor || \"Roll\";\n    }\n    \n    return flavor;\n  }\n  \n  /**\n   * Post a group message to chat\n   * @param {Object} data - Message data\n   * @param {string} [rollMode] - The roll mode for the message\n   * @returns {Promise<ChatMessage>} The created message\n   */\n  static async postGroupMessage(data, rollMode = null) {\n    LogUtil.log('postGroupMessage - groupRollId', [data.groupRollId, rollMode]);\n    \n    try {\n      const content = await GeneralUtil.renderTemplate(this.templatePath, data);\n      const messageData = {\n        content,\n        speaker: {\n          alias: \"Group Roll\"\n        },\n        flags: {\n          [MODULE_ID]: {\n            isGroupRoll: true,\n            groupRollId: data.groupRollId,\n            rollData: data\n          },\n          rsr5e: { processed: true, quickRoll: false}\n        }\n      };\n      if (rollMode) {\n        ChatMessage.applyRollMode(messageData, rollMode);\n      }\n      \n      const msg = await ChatMessage.create(messageData);\n      this.groupRollMessages.set(data.groupRollId, msg);\n      return msg;\n    } catch (error) {\n      LogUtil.error('Failed to post group message', error);\n      return null;\n    }\n  }\n  \n  /**\n   * Update a group roll message with a completed roll result\n   * @param {string} groupRollId - The group roll identifier\n   * @param {string} uniqueId - The unique identifier (token ID or actor ID) who rolled\n   * @param {Roll} roll - The completed roll\n   */\n  static async updateGroupRollMessage(groupRollId, uniqueId, roll) {\n    if (!game.user.isGM) {\n      return;\n    }\n    LogUtil.log('ChatMessageManager.updateGroupRollMessage #0', [groupRollId, uniqueId, roll ]);\n    \n    return await this._performGroupRollUpdate(groupRollId, uniqueId, roll);\n  }\n  \n  /**\n   * Internal method to perform the actual group roll update\n   * @param {string} groupRollId - The group roll identifier\n   * @param {string} uniqueId - The unique identifier (token ID or actor ID) who rolled\n   * @param {Roll} roll - The completed roll\n   * @private\n   */\n  static async _performGroupRollUpdate(groupRollId, uniqueId, roll) {\n    \n    let message = this.groupRollMessages.get(groupRollId);\n    let pendingData = this.pendingRolls.get(groupRollId);\n    \n    if (!message) {\n      const messages = game.messages.contents;\n      message = messages.find(m => \n        m.getFlag(MODULE_ID, 'groupRollId') === groupRollId &&\n        m.getFlag(MODULE_ID, 'isGroupRoll')\n      );\n      \n      if (message) {\n        this.groupRollMessages.set(groupRollId, message);\n        LogUtil.log('_performGroupRollUpdate - Found and registered group message', [groupRollId]);\n        \n        if (!pendingData) {\n          const flagData = message.getFlag(MODULE_ID, 'rollData');\n          pendingData = {\n            actorEntries: flagData.actorEntries || flagData.results.map(r => ({ actorId: r.actorId, uniqueId: r.uniqueId, tokenId: r.tokenId })),\n            results: new Map()\n          };\n          this.pendingRolls.set(groupRollId, pendingData);\n        }\n      }\n    }\n    \n    if (!message) {\n      LogUtil.log('No group message found for groupRollId', groupRollId);\n      return;\n    }\n    \n    // Store the result if pendingData exists\n    if (pendingData && pendingData.results) {\n      pendingData.results.set(uniqueId, {\n        total: roll.total,\n        roll: roll\n      });\n    }\n    \n    const flagData = message.getFlag(MODULE_ID, 'rollData');\n    LogUtil.log('_performGroupRollUpdate - Searching for uniqueId', [uniqueId, 'in results:', flagData.results.map(r => ({uniqueId: r.uniqueId, actorId: r.actorId, tokenId: r.tokenId}))]);\n    let resultIndex = flagData.results.findIndex(r => r.uniqueId === uniqueId);\n    \n    if (resultIndex === -1) {\n      // Attempt 1: Try matching by actorId directly\n      resultIndex = flagData.results.findIndex(r => r.actorId === uniqueId);\n      \n      // Attempt 2: If uniqueId is a tokenId, try finding by tokenId property\n      if (resultIndex === -1) {\n        resultIndex = flagData.results.findIndex(r => r.tokenId === uniqueId);\n      }\n      \n      // Attempt 3: extract actorId from speaker and match\n      if (resultIndex === -1 && message.speaker?.actor) {\n        const speakerActorId = message.speaker.actor;\n        resultIndex = flagData.results.findIndex(r => r.actorId === speakerActorId);\n      }\n      \n      // Attempt 4: If uniqueId looks like a token ID, try to get the actor from the token\n      if (resultIndex === -1) {\n        const token = canvas.tokens?.get(uniqueId) || game.scenes.active?.tokens?.get(uniqueId);\n        if (token && token.actor) {\n          const tokenActorId = token.actor.id;\n          LogUtil.log('_performGroupRollUpdate - Trying token actor match', [uniqueId, 'token actor:', tokenActorId]);\n          resultIndex = flagData.results.findIndex(r => \n            r.actorId === tokenActorId || r.uniqueId === tokenActorId\n          );\n        }\n      }\n    }\n    \n    if (resultIndex !== -1) {\n      flagData.results[resultIndex].rolled = true;\n      flagData.results[resultIndex].showDice = false;\n      flagData.results[resultIndex].total = roll.total;\n      \n      try {\n        let rollBreakdown = await roll.render();\n        flagData.results[resultIndex].rollBreakdown = rollBreakdown;\n      } catch (error) {\n        LogUtil.error('Error rendering roll breakdown', [error]);\n        flagData.results[resultIndex].rollBreakdown = null;\n      }\n      \n      if (flagData.showDC && flagData.dc) {\n        flagData.results[resultIndex].success = roll.total >= flagData.dc;\n        flagData.results[resultIndex].failure = roll.total < flagData.dc;\n      }\n    }else{\n      LogUtil.error('Group message id not found');\n      return;\n    }\n    \n    flagData.allRolled = flagData.results.every(r => r.rolled);\n    flagData.messageId = message.id;\n    flagData.supportsDC = RollHelpers.shouldShowDC(flagData.rollType);\n    \n    const SETTINGS = getSettings();\n    flagData.showDCToPlayers = SettingsUtil.get(SETTINGS.showGroupDCToPlayers.tag);\n    flagData.groupRollNPCHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n    flagData.isGM = game.user.isGM;\n    \n    // Ensure isNPC flag is set on results if not already present\n    if (flagData.results) {\n      flagData.results.forEach(result => {\n        if (result.isNPC === undefined) {\n          const actor = game.actors.get(result.actorId);\n          result.isNPC = actor ? !actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER) : false;\n        }\n        // Update shouldHide flag\n        result.shouldHide = result.isNPC && flagData.groupRollNPCHidden && !flagData.isGM;\n      });\n    }\n    \n    // Calculate group result if DC is set and roll type supports it\n    if (flagData.supportsDC && flagData.showDC && flagData.dc) {\n      const actors = flagData.actorEntries?.map(entry => game.actors.get(entry.actorId)).filter(a => a) || \n                     flagData.actors?.map(id => game.actors.get(id)).filter(a => a) || [];\n      \n      const groupResult = RollHelpers.getGroupResult(\n        flagData.results,\n        flagData.dc,\n        actors,\n        flagData.rollType,\n        flagData.rollKey\n      );\n      \n      flagData.groupResult = groupResult;\n      LogUtil.log('updateGroupRollMessage - COMPLETE?', [groupResult.complete]);\n      \n      if (groupResult.complete && groupResult.details) {\n        flagData.groupSummary = groupResult.details.summary;\n      }\n    }\n    \n    const newContent = await GeneralUtil.renderTemplate(this.templatePath, flagData);\n    await message.update({\n      content: newContent,\n      flags: {\n        [MODULE_ID]: {\n          rollData: flagData\n        }\n      }\n    });\n    \n    if (pendingData?.results && pendingData?.actorEntries) {\n      if (pendingData.results.size === pendingData.actorEntries.length) {\n        this.pendingRolls.delete(groupRollId);\n        setTimeout(() => {\n          this.groupRollMessages.delete(groupRollId);\n          this.updateQueue.delete(groupRollId);\n        }, 60000);\n      }\n    }\n  }\n  \n  /**\n   * Update group roll message with new DC value\n   * @param {ChatMessage} message - The chat message to update\n   * @param {number} newDC - The new DC value\n   */\n  static async updateGroupRollDC(message, newDC) {\n    const flagData = message.getFlag(MODULE_ID, 'rollData');\n    if (!flagData) return;\n    \n    flagData.supportsDC = RollHelpers.shouldShowDC(flagData.rollType);\n    if (!flagData.supportsDC) return;\n    \n    flagData.dc = newDC;\n    flagData.showDC = true;\n    flagData.results.forEach(result => {\n      if (result.rolled && result.total !== null) {\n        result.success = result.total >= newDC;\n        result.failure = result.total < newDC;\n      }\n    });\n    \n    const actors = flagData.actorEntries?.map(entry => game.actors.get(entry.actorId)).filter(a => a) || \n                   flagData.actors?.map(id => game.actors.get(id)).filter(a => a) || [];\n    \n    const groupResult = RollHelpers.getGroupResult(\n      flagData.results,\n      newDC,\n      actors,\n      flagData.rollType,\n      flagData.rollKey\n    );\n    \n    flagData.groupResult = groupResult;\n    \n    if (groupResult.complete && groupResult.details) {\n      flagData.groupSummary = groupResult.details.summary;\n    }\n    \n    flagData.allRolled = flagData.results.every(r => r.rolled);\n    flagData.messageId = message.id;\n    \n    const SETTINGS = getSettings();\n    flagData.showDCToPlayers = SettingsUtil.get(SETTINGS.showGroupDCToPlayers.tag);\n    flagData.groupRollNPCHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n    flagData.isGM = game.user.isGM;\n    \n    // Ensure isNPC flag is set on results if not already present\n    if (flagData.results) {\n      flagData.results.forEach(result => {\n        if (result.isNPC === undefined) {\n          const actor = game.actors.get(result.actorId);\n          result.isNPC = actor ? !actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER) : false;\n        }\n        // Update shouldHide flag\n        result.shouldHide = result.isNPC && flagData.groupRollNPCHidden && !flagData.isGM;\n      });\n    }\n    \n    const newContent = await GeneralUtil.renderTemplate(this.templatePath, flagData);\n    await message.update({\n      content: newContent,\n      flags: {\n        [MODULE_ID]: {\n          rollData: flagData\n        }\n      }\n    });\n  }\n  \n  /**\n   * Intercept individual roll messages and update group message instead\n   * @param {ChatMessage} message - The chat message document\n   * @param {HTMLElement} html - The rendered HTML element\n   * @param {Object} context - Rendering context\n   * @returns {boolean} Return false to prevent rendering\n   */\n  static interceptRollMessage(message, html, context) {\n    const SETTINGS = getSettings();\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    if (!groupRollsMsgEnabled) return;\n    \n    const actorId = message.speaker?.actor;\n    const tokenId = message.speaker?.token;\n    \n    // For unlinked tokens, we need to get the synthetic actor from the token\n    // because flags are set on the synthetic actor, not the base actor\n    let actor;\n    if (tokenId) {\n      const token = canvas.tokens?.get(tokenId) || game.scenes.active?.tokens?.get(tokenId);\n      actor = token?.actor;  // This gets the synthetic actor for unlinked tokens\n    }\n    if (!actor) {\n      actor = game.actors.get(actorId);\n    }\n\n    if (!actor) return;\n    \n    const uniqueId = tokenId || actorId;\n    const groupRollId = message.getFlag(MODULE_ID, 'groupRollId') || actor.getFlag(MODULE_ID, 'tempInitiativeConfig')?.groupRollId;\n\n    if (!groupRollId) {\n      LogUtil.log('interceptRollMessage #2 - no groupRollId in flag', [actor.name]);\n      return;\n    }\n    \n    if (!game.user.isGM && !this.groupRollMessages.has(groupRollId)) {\n      const messages = game.messages.contents;\n      const groupMessage = messages.find(m => \n        m.getFlag(MODULE_ID, 'groupRollId') === groupRollId &&\n        m.getFlag(MODULE_ID, 'isGroupRoll')\n      );\n      \n      if (groupMessage) {\n        this.groupRollMessages.set(groupRollId, groupMessage);\n        LogUtil.log('interceptRollMessage - Registered group roll message', [actor.name,groupRollId]);\n      }\n    }\n    \n    if (!this.groupRollMessages.has(groupRollId)) {\n      const messages = game.messages.contents;\n      const groupMessage = messages.find(m => \n        m.getFlag(MODULE_ID, 'groupRollId') === groupRollId &&\n        m.getFlag(MODULE_ID, 'isGroupRoll')\n      );\n      \n      if (groupMessage) {\n        LogUtil.log('interceptRollMessage - Found group message in chat log, registering', [groupRollId]);\n        this.groupRollMessages.set(groupRollId, groupMessage);\n      } else {\n        LogUtil.log('interceptRollMessage - No group message found in chat log either', [groupRollId]);\n        return;\n      }\n    }\n    \n    const roll = message.rolls?.[0];\n    if (!roll) return;\n    \n    if (html && html instanceof HTMLElement && html.style) {\n      html.style.display = 'none';\n    }\n    \n    if (game.user.isGM) {\n      LogUtil.log('interceptRollMessage - Updating group message', [groupRollId, uniqueId, actor.name, roll.total]);\n      this.updateGroupRollMessage(groupRollId, uniqueId, roll);\n      \n      const msgId = message.id;\n      if (this.messagesScheduledForDeletion.has(msgId)) {\n        return;\n      }\n      this.messagesScheduledForDeletion.add(msgId);\n      \n      if (msgId) {\n        setTimeout(async () => {\n          LogUtil.log('interceptRollMessage - deletion', [msgId]);\n          try {\n            const msgExists = game.messages.get(msgId);\n            if (msgExists) {\n              await message.delete();\n              LogUtil.log('interceptRollMessage - Deleted individual message', [msgId]);\n            } else {\n              LogUtil.log('interceptRollMessage - Message already deleted', [msgId]);\n            }\n          } catch (error) {\n            LogUtil.log('interceptRollMessage - Error deleting message', [msgId, error.message]);\n          } finally {\n            this.messagesScheduledForDeletion.delete(msgId);\n          }\n        }, 500);\n      }\n    } else {\n      // Player side - don't try to update the message (no permission)\n      LogUtil.log('interceptRollMessage - Player roll intercepted, GM will handle update', [groupRollId]);\n    }\n    \n    return;\n  }\n  \n  /**\n   * Check if a request should use group messaging\n   * @param {string} requestId - Request identifier\n   * @returns {boolean} True if this is a group roll\n   */\n  static isGroupRoll(requestId) {\n    return this.pendingRolls.has(requestId) || this.groupRollMessages.has(requestId);\n  }\n  \n  /**\n   * Add groupRollId to message flags if it's a group roll\n   * @param {Object} messageConfig - The message configuration object\n   * @param {Object} requestData - The request data containing the groupRollId\n   * @param {Actor} actor - The actor performing the roll (optional, for player flag storage)\n   */\n  static async addGroupRollFlag(messageConfig, requestData, actor = null) {\n    const SETTINGS = getSettings();\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    \n    LogUtil.log('addGroupRollFlag called', [messageConfig, requestData.groupRollId, this.isGroupRoll(requestData.groupRollId)]);\n    \n    if (!game.user.isGM && requestData.groupRollId && actor) {\n      await actor.setFlag(MODULE_ID, 'tempGroupRollId', requestData.groupRollId);\n      if (actor.isToken && actor.actor) {\n        await actor.actor.setFlag(MODULE_ID, 'tempGroupRollId', requestData.groupRollId);\n        LogUtil.log('addGroupRollFlag - Also stored tempGroupRollId on base actor for player', [requestData.groupRollId, actor.actor.id]);\n      }\n      \n      if (!this.groupRollMessages.has(requestData.groupRollId)) {\n        const messages = game.messages.contents;\n        const groupMessage = messages.find(m => \n          m.getFlag(MODULE_ID, 'groupRollId') === requestData.groupRollId &&\n          m.getFlag(MODULE_ID, 'isGroupRoll')\n        );\n        \n        if (groupMessage) {\n          this.groupRollMessages.set(requestData.groupRollId, groupMessage);\n          LogUtil.log('addGroupRollFlag - Registered group roll message on player side', [requestData.groupRollId]);\n        }\n      }\n    }\n    \n    // Add groupRollId for any multi-actor roll when setting is enabled\n    if (groupRollsMsgEnabled && requestData.groupRollId) {\n      const shouldAddFlag = game.user.isGM ? this.isGroupRoll(requestData.groupRollId) : true;\n      \n      if (shouldAddFlag) {\n        messageConfig.data = messageConfig.data || {};\n        messageConfig.data.flags = messageConfig.data.flags || {};\n        messageConfig.data.flags[MODULE_ID] = messageConfig.data.flags[MODULE_ID] || {};\n        messageConfig.data.flags[MODULE_ID].groupRollId = requestData.groupRollId;\n        messageConfig.data.flags.rsr5e = { processed: true, quickRoll: false};\n        \n        LogUtil.log('addGroupRollFlag - Added flag to messageConfig', [messageConfig]);\n      }\n    }\n  }\n  \n  /**\n   * Clean up old messages and data\n   */\n  static cleanup() {\n    const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);\n    \n    for (const [requestId, message] of this.groupRollMessages.entries()) {\n      if (message.timestamp < fiveMinutesAgo) {\n        this.groupRollMessages.delete(requestId);\n        this.pendingRolls.delete(requestId);\n      }\n    }\n  }\n}","import { ROLL_TYPES, MODULE_ID } from \"../../constants/General.mjs\";\nimport { ActivityManager } from \"../managers/ActivityManager.mjs\";\nimport { RollHelpers } from \"../helpers/RollHelpers.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { CustomRollDialog } from \"../ui/dialogs/CustomRollDialog.mjs\";\nimport { NotificationManager } from \"../helpers/Helpers.mjs\";\nimport { ChatMessageManager } from \"../managers/ChatMessageManager.mjs\";\n\n/**\n * Methods for handling different types of rolls\n * Called from GM side or player side to fulfill the roll request\n */\nexport const RollHandlers = {\n  ability: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      ability: requestData.rollKey\n    });\n    \n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n    await actor.rollAbilityCheck(config, dialogConfig, messageConfig);\n  },\n  \n  abilitycheck: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    return RollHandlers.ability(actor, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  save: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      ability: requestData.config?.ability || requestData.rollKey\n    });\n    \n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n    \n    await actor.rollSavingThrow(config, dialogConfig, messageConfig);\n  },\n  \n  savingthrow: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    return RollHandlers.save(actor, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  skill: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const defaultAbility = actor.system.skills?.[requestData.rollKey]?.ability || \n                          CONFIG.DND5E.skills?.[requestData.rollKey]?.ability || \n                          undefined;\n\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      skill: requestData.rollKey, \n      chooseAbility: dialogConfig.configure !== false, \n      ability: requestData.config.ability || defaultAbility \n    });\n    /*\n    if (requestData.config.ability && dialogConfig.configure === false) {\n      const skillLabel = CONFIG.DND5E.skills[requestData.rollKey]?.label || requestData.rollKey;\n      const abilityLabel = CONFIG.DND5E.abilities[requestData.config.ability]?.label || requestData.config.ability;\n      const flavor = game.i18n.format(\"DND5E.SkillPromptTitle\", { \n        skill: skillLabel, \n        ability: abilityLabel \n      });\n      messageConfig.data = messageConfig.data || {};\n      messageConfig.data.flavor = flavor;\n    }*/\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n    await actor.rollSkill(config, dialogConfig, messageConfig);\n  },\n\n  tool: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const toolConfig = actor.system.tools?.[requestData.rollKey];\n    const defaultAbility = toolConfig?.ability || \n                          CONFIG.DND5E.enrichmentLookup?.tools?.[requestData.rollKey]?.ability ||\n                          'int';\n\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      tool: requestData.rollKey,\n      chooseAbility: dialogConfig.configure !== false, \n      ability: requestData.config.ability || defaultAbility\n    });\n    /*\n    if (requestData.config.ability && dialogConfig.configure === false) {\n      const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[requestData.rollKey];\n      let toolLabel = requestData.rollKey;\n      if (toolData?.id) {\n        const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n        toolLabel = toolItem?.name || requestData.rollKey;\n      }\n      const abilityLabel = CONFIG.DND5E.abilities[requestData.config.ability]?.label || requestData.config.ability;\n      const flavor = game.i18n.format(\"DND5E.ToolPromptTitle\", { \n        tool: toolLabel, \n        ability: abilityLabel \n      });\n      messageConfig.data = messageConfig.data || {};\n      messageConfig.data.flavor = flavor;\n    }*/\n    LogUtil.log('RollHandlers.tool #2', [config, dialogConfig, messageConfig]);\n    \n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n    await actor.rollToolCheck(config, dialogConfig, messageConfig);\n  },\n\n  concentration: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig);\n    \n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n    await actor.rollConcentration(config, dialogConfig, messageConfig);\n  },\n\n  attack: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleActivityRoll(actor, ROLL_TYPES.ATTACK, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  damage: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleActivityRoll(actor, ROLL_TYPES.DAMAGE, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  itemsave: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleActivityRoll(actor, ROLL_TYPES.ITEM_SAVE, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  initiative: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    if (!game.combat) {\n      ui.notifications.warn(game.i18n.localize(\"COMBAT.NoneActive\"));\n      return;\n    }\n    const situational = requestData.config.situational || rollConfig.data?.situational || '';\n    const groupRollId = requestData.groupRollId;\n\n    let tokenActor = actor;\n    if (!actor.isToken) {\n      const token = canvas.tokens.placeables.find(t => t.actor?.id === actor.id);\n      if (token) {\n        tokenActor = token.actor;\n      } else {\n        ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.notifications.noTokensForInitiative\"));\n        return;\n      }\n    }\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n    \n    try {\n      if (dialogConfig.configure) {\n        LogUtil.log('RollHandlers.initiative - Dialog', []);\n        \n        if (requestData.config) {\n          const initiativeConfig = RollHelpers.buildRollConfig(requestData, rollConfig, {\n            ability: actor.system.attributes?.init?.ability || 'dex'\n          });\n          \n          const tempConfig = {\n            advantage: requestData.config.advantage || false,\n            disadvantage: requestData.config.disadvantage || false,\n            rollMode: requestData.config.rollMode || game.settings.get(\"core\", \"rollMode\"),\n            rolls: initiativeConfig.rolls,\n            groupRollId: requestData.groupRollId\n          };\n          await actor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n          await tokenActor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n        }\n        await tokenActor.rollInitiativeDialog();\n        await tokenActor.unsetFlag(MODULE_ID, 'tempInitiativeConfig');\n        await actor.unsetFlag(MODULE_ID, 'tempInitiativeConfig');\n\n      } else {\n        const tempConfig = {\n          rollMode: requestData.config.rollMode || game.settings.get(\"core\", \"rollMode\"),\n          groupRollId: requestData.groupRollId\n        };\n\n        await actor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n        await tokenActor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n\n        const rollOptions = {\n          createCombatants: true,\n          rerollInitiative: true\n        };\n        await tokenActor.rollInitiative(rollOptions);\n        await tokenActor.unsetFlag(MODULE_ID, 'tempInitiativeConfig');\n        await actor.unsetFlag(MODULE_ID, 'tempInitiativeConfig');\n      }\n    } catch (error) {\n      LogUtil.error('RollHandlers.initiative - Error', [error]);\n      NotificationManager.notify('error', `Initiative roll failed: ${error.message}`);\n    }\n  },\n  \n  // Alias for INITIATIVE_DIALOG\n  initiativedialog: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    return RollHandlers.initiative(actor, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  deathsave: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig);\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n    await actor.rollDeathSave(config, dialogConfig, messageConfig);\n  },\n\n  hitdie: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    dialogConfig.configure = game.user.isGM ? dialogConfig.configure : true;\n    \n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      denomination: requestData.rollKey // The hit die denomination (d6, d8, etc.)\n    });\n    LogUtil.log('RollHandlers.hitdie', [config, dialogConfig, messageConfig]);\n    await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n    await actor.rollHitDie(config, dialogConfig, messageConfig);\n  },\n\n  custom: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleCustomRoll(actor, requestData, dialogConfig, messageConfig);\n  },\n\n\n  /**\n   * Handle activity-based rolls (attack, damage, item save)\n   * @param {Actor5e} actor - The actor performing the roll\n   * @param {string} rollType - The type of roll from ROLL_TYPES\n   * @param {Object} requestData - The roll request data\n   * @param {string} requestData.rollKey - The item ID\n   * @param {string} requestData.activityId - The activity ID\n   * @param {Object} requestData.config - Configuration\n   * @param {string} [requestData.config.situational] - Situational bonus formula\n   * @param {BasicRollConfiguration} rollConfig - Individual roll configuration\n   * @param {BasicRollDialogConfiguration} dialogConfig - Dialog configuration\n   * @param {BasicRollMessageConfiguration} messageConfig - Message configuration\n   * @returns {Promise<void>}\n   */\n  async handleActivityRoll(actor, rollType, requestData, rollConfig, dialogConfig, messageConfig) {\n    LogUtil.log('RollHandlers.handleActivityRoll', [rollType, requestData, rollConfig]);\n    if (requestData.rollKey) {\n      const processConfig = RollHelpers.buildRollConfig(requestData, rollConfig);\n      \n      const rollOptions = processConfig.rolls?.[0]?.options || {};\n      const activityConfig = {\n        usage: {\n          ...requestData.config,\n          rolls: processConfig.rolls,\n          ...(rollOptions.attackMode && { attackMode: rollOptions.attackMode }),\n          ...(rollOptions.ammunition && { ammunition: rollOptions.ammunition }),\n          ...(rollOptions.mastery !== undefined && { mastery: rollOptions.mastery }),\n          // Ensure spell slot and scaling information is applied\n          ...(requestData.config.spell && { spell: requestData.config.spell }),\n          ...(requestData.config.scaling !== undefined && { scaling: requestData.config.scaling }),\n          ...(requestData.config.consume && { consume: requestData.config.consume }),\n          ...(requestData.config.create && { create: requestData.config.create })\n        },\n        dialog: {\n          ...dialogConfig,\n          configure: game.user.isGM && requestData.config.skipRollDialog!==undefined ? !requestData.config.skipRollDialog : dialogConfig.configure\n        },\n        message: messageConfig\n      };\n      \n      LogUtil.log('handleActivityRoll - final activity config', [activityConfig]);\n      \n      await ActivityManager.executeActivityRoll(\n        actor, \n        rollType, \n        requestData.rollKey, \n        requestData.activityId, \n        activityConfig\n      );\n    }\n  },\n\n  /**\n   * Handle a custom roll, creating a custom dialog\n   * @param {Actor5e} actor - The actor performing the roll\n   * @param {Object} requestData - The roll request data\n   * @param {string} requestData.rollKey - The roll formula\n   * @param {Object} requestData.config - Configuration object\n   * @param {string} [requestData.config.rollMode] - Roll visibility mode\n   * @param {string} [requestData.config.requestedBy] - Name of the requester\n   * @param {BasicRollDialogConfiguration} dialogConfig - Dialog configuration\n   * @param {BasicRollMessageConfiguration} messageConfig - Message configuration\n   * @returns {Promise<void>}\n   */\n  async handleCustomRoll(actor, requestData, dialogConfig, messageConfig) {\n    const formula = requestData.rollKey;\n    \n    if (dialogConfig?.configure === false) {\n      try {\n        const roll = new Roll(formula, actor.getRollData());\n        \n        roll.options = roll.options || {};\n        roll.options.isRollRequest = requestData.config?.isRollRequest !== false;\n        \n        await roll.evaluate();\n        await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n        \n        await roll.toMessage({\n          speaker: ChatMessage.getSpeaker({actor}),\n          flavor: game.i18n.localize(`FLASH_ROLLS.rollTypes.${ROLL_TYPES.CUSTOM}`),\n          rollMode: messageConfig?.rollMode || requestData.config?.rollMode || game.settings.get(\"core\", \"rollMode\"),\n          isRollRequest: requestData.config?.isRollRequest !== false,\n          create: messageConfig?.create !== false,\n          flags: messageConfig?.data?.flags\n        });\n      } catch (error) {\n        ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.ui.notifications.invalidFormula\", {formula: formula}));\n      }\n      return;\n    }\n    \n    const dialog = new CustomRollDialog({\n      formula: formula,\n      readonly: true,\n      actor: actor,\n      callback: async (confirmedFormula) => {\n        try {\n          const roll = new Roll(confirmedFormula, actor.getRollData());\n          \n          roll.options = roll.options || {};\n          roll.options.isRollRequest = true;\n          \n          await roll.evaluate();\n          await ChatMessageManager.addGroupRollFlag(messageConfig, requestData, actor);\n          \n          await roll.toMessage({\n            speaker: ChatMessage.getSpeaker({actor}),\n            flavor: game.i18n.localize(`FLASH_ROLLS.rollTypes.${ROLL_TYPES.CUSTOM}`),\n            rollMode: requestData.config.rollMode,\n            isRollRequest: true,\n            _showRequestedBy: true,\n            _requestedBy: requestData.config.requestedBy || 'GM',\n            flags: messageConfig?.data?.flags\n          });\n        } catch (error) {\n          ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.ui.notifications.invalidFormula\", {formula: confirmedFormula}));\n        }\n      }\n    });\n    \n    dialog.render(true);\n  },\n\n  /**\n   * Handle hit die recovery (used for refilling hit dice)\n   * @param {Actor5e} actor - The actor to recover hit dice for\n   * @returns {Promise<Object>} Result object with recovery details\n   */\n  async handleHitDieRecovery(actor) {\n    const result = foundry.utils.mergeObject({\n      type: \"long\",\n      deltas: {\n        hitDice: 0\n      },\n      newDay: false,\n      rolls: [],\n      updateData: {},\n      updateItems: []\n    }, {});\n    \n    if ( \"dhd\" in result ) result.deltas.hitDice = result.dhd;\n\n    actor._getRestHitDiceRecovery({ maxHitDice: actor.system.attributes.hd.max, type: \"long\" }, result);\n\n    result.dhd = result.deltas.hitDice;\n    result.longRest = true;\n\n    try {\n      if (result.updateData && Object.keys(result.updateData).length > 0) {\n        const updateResult = await actor.update(result.updateData, { isRest: false });\n      } else {\n        LogUtil.log('No actor updates to perform', []);\n      }\n      \n      if (result.updateItems && result.updateItems.length > 0) {\n        const itemUpdateResult = await actor.updateEmbeddedDocuments(\"Item\", result.updateItems, { isRest: false });\n      } else {\n        LogUtil.log('No item updates to perform', []);\n      }\n    } catch (error) {\n      LogUtil.error('Error during updates in handleHitDieRecovery:', [error]);\n      throw error;\n    }\n\n    LogUtil.log('handleHitDieRecovery #3', [result]);\n    // Return data summarizing the rest effects\n    return result;\n  }\n};","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { NotificationManager } from './Helpers.mjs';\n\n/**\n * Ensure combat exists for initiative rolls\n * @returns {Promise<boolean>} True if combat is ready, false if cancelled\n */\nexport async function ensureCombatForInitiative() {\n  if (!game.combat) {\n    const combat = await Combat.create({scene: game.scenes.active.id});\n    await combat.activate();\n    NotificationManager.notify('info', game.i18n.localize(\"FLASH_ROLLS.notifications.combatCreated\"));\n  }\n  return game.combat;\n}\n\n/**\n * Filter actors for initiative rolls, handling re-rolls\n * @param {string[]} actorIds - Array of actor IDs to filter\n * @param {Game} game - The game instance\n * @returns {Promise<string[]>} Filtered array of actor IDs\n */\nexport async function filterActorsForInitiative(actorIds, game) {\n  if (!game.combat) return actorIds;\n  \n  const actors = actorIds\n    .map(id => game.actors.get(id))\n    .filter(actor => actor);\n  \n  const actorsNamesWithInitiative = [];\n  const actorIdsWithInitiative = new Set();\n  \n  for (const actor of actors) {\n    const combatants = game.combat.getCombatantsByActor(actor.id);\n    const hasInitiative = combatants.some(c => c.initiative !== null);\n    if (hasInitiative) {\n      actorsNamesWithInitiative.push(actor.name);\n      actorIdsWithInitiative.add(actor.id);\n    }\n  };\n  LogUtil.log('filterActorsForInitiative', [actorsNamesWithInitiative]);\n  \n  // If any actors already have initiative, confirm re-roll\n  if (actorsNamesWithInitiative.length > 0) {\n    const reroll = await foundry.applications.api.DialogV2.confirm({\n      window: {\n        title: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.rerollInitiativeTitle\"),\n        classes: [\"flash5e-dialog\"]\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      },\n      content: \"<p>\" + game.i18n.format(\"FLASH_ROLLS.ui.dialogs.rerollInitiative\", {\n        actors: actorsNamesWithInitiative.join(\", \")\n      }) + \"</p>\",\n      rejectClose: false,\n      modal: true\n    });\n    \n    if (!reroll) { \n      const filteredIds = actorIds.filter(id => !actorIdsWithInitiative.has(id));\n      if (filteredIds.length === 0) {\n        NotificationManager.notify('info', game.i18n.localize(\"FLASH_ROLLS.notifications.allActorsHaveInitiative\"));\n      }\n      \n      return filteredIds;\n    } else {\n      if (game.user.isGM) {\n        for (const actorId of actorIdsWithInitiative) {\n          const combatants = game.combat.getCombatantsByActor(actorId);\n          LogUtil.log('filterActorsForInitiative - resetting initiative for combatants', [combatants]);\n          for (const c of combatants) {\n            await c.update({ initiative: null });\n          }\n        }\n      } else {\n        LogUtil.log('filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll');\n      }\n      \n      return actorIds;\n    }\n  }\n  \n  return actorIds;\n}","import { isPlayerOwned, hasTokenInScene } from '../helpers/Helpers.mjs';\nimport { LogUtil } from './LogUtil.mjs';\n\n/**\n * Utility class for actor-related operations in the Roll Requests Menu\n */\nexport class RollMenuActorUtil {\n  /**\n   * Get formatted stats for an actor\n   * @param {Actor} actor - The actor to get stats for\n   * @returns {Array<{abbrev: string, value: number}>} Array of stat objects\n   */\n  static getActorStats(actor) {\n    const system = actor.system;\n    const stats = [];\n\n    // HP\n    if (system.attributes?.hp) {\n      stats.push({\n        abbrev: 'HP',\n        value: system.attributes.hp.value\n      });\n    }\n    \n    // AC\n    if (system.attributes?.ac) {\n      stats.push({\n        abbrev: 'AC',\n        value: system.attributes.ac.value\n      });\n    }\n    \n    const spellDC = system.attributes?.spell?.dc;\n    if (spellDC) {\n      stats.push({\n        abbrev: 'DC',\n        value: spellDC\n      });\n    }\n    \n    if (system.skills?.prc?.passive) {\n      stats.push({\n        abbrev: 'PRC',\n        value: system.skills.prc.passive\n      });\n    }\n    \n    return stats;\n  }\n\n  /**\n   * Get HP percentage and color for an actor\n   * @param {Actor} actor - The actor to get HP data for\n   * @returns {{hpPercent: number, hpColor: string}} HP percentage and color\n   */\n  static getActorHPData(actor) {\n    const hp = actor.system.attributes?.hp;\n    if (!hp || !hp.max) {\n      return { hpPercent: 100, hpColor: 'var(--fr5e-color-hp-high)' };\n    }\n    \n    const hpPercent = Math.round((hp.value / hp.max) * 100);\n    const hpColor = hpPercent > 50 ? 'var(--fr5e-color-hp-high)' : 'var(--fr5e-color-hp-low)';\n    \n    return { hpPercent, hpColor };\n  }\n\n  /**\n   * Get valid actor IDs based on current tab\n   * @param {Array<string>} selectedActorIds - Array of selected actor IDs\n   * @param {string} currentTab - Current tab ('pc' or 'npc')\n   * @returns {Array<string>} Filtered array of valid actor IDs\n   */\n  static getValidActorIds(selectedActorIds, currentTab) {\n    return selectedActorIds.filter(actorId => {\n      const actor = game.actors.get(actorId);\n      if (!actor) return false;\n      const isPC = isPlayerOwned(actor);\n      const isNPC = !isPC && hasTokenInScene(actor);\n      \n      return (currentTab === 'pc' && isPC) || (currentTab === 'npc' && isNPC);\n    });\n  }\n}","import { HOOKS_DND5E } from '../../constants/Hooks.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport { SocketUtil } from '../utils/SocketUtil.mjs';\nimport { MODULE_ID, DEBUG_TAG, ROLL_TYPES, ACTIVITY_TYPES } from '../../constants/General.mjs';\nimport { GMRollConfigDialog, GMSkillToolConfigDialog, GMHitDieConfigDialog, GMDamageConfigDialog, GMAttackConfigDialog } from '../ui/dialogs/gm-dialogs/index.mjs';\nimport { RollHandlers } from './RollHandlers.mjs';\nimport { ensureCombatForInitiative, filterActorsForInitiative } from '../helpers/RollValidationHelpers.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { ModuleHelpers } from '../helpers/ModuleHelpers.mjs';\nimport { OfflinePlayerManager } from '../managers/roll-menu/OfflinePlayerManager.mjs';\nimport { RollHelpers } from '../helpers/RollHelpers.mjs';\n\n/**\n * Handles intercepting D&D5e rolls on the GM side and redirecting them to players\n */\nexport class RollInterceptor {  \n  /**\n   * @type {Set<string>} - Set of registered hook IDs for cleanup\n   */\n  static registeredHooks = new Set();\n  \n  /**\n   * Initialize the roll interceptor\n   */\n  static initialize() {\n    LogUtil.log('RollInterceptor.initialize');\n    if (!game.user.isGM) return;\n    \n    this.registerHooks();\n  }\n  \n  /**\n   * Register all necessary hooks for roll interception\n   */\n  static registerHooks() {\n    LogUtil.log('RollInterceptor.registerHooks');\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_ABILITY_CHECK, this._onPreRollIntercept.bind(this, ROLL_TYPES.ABILITY));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_SAVING_THROW, this._onPreRollIntercept.bind(this, ROLL_TYPES.SAVE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_SKILL_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.SKILL));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_TOOL_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.TOOL));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_ATTACK_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.ATTACK));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_DAMAGE_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.DAMAGE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_DEATH_SAVE_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.DEATH_SAVE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_HIT_DIE_V2, this._onPreRollIntercept.bind(this, ROLL_TYPES.HIT_DIE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_INITIATIVE, this._onPreRollInterceptInitiative.bind(this, ROLL_TYPES.INITIATIVE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_INITIATIVE_DIALOG, this._onPreRollInterceptInitiative.bind(this, ROLL_TYPES.INITIATIVE));\n  }\n  \n  /**\n   * Helper to register a hook and track it for cleanup\n   * @param {string} hookName \n   * @param {Function} handler \n   */\n  static _registerHook(hookName, handler) {\n    LogUtil.log('RollInterceptor._registerHook');\n    const hookId = Hooks.on(hookName, handler);\n    this.registeredHooks.add({ hookName, hookId });\n  }\n  \n  /**\n   * Unregister all hooks (for cleanup)\n   */\n  static unregisterHooks() {\n    LogUtil.log('RollInterceptor.unregisterHooks');\n    for (const { hookName, hookId } of this.registeredHooks) {\n      Hooks.off(hookName, hookId);\n    }\n    this.registeredHooks.clear();\n  }\n\n   /**\n   * Handle pre-roll initiative to intercept rolls\n   * @param {string} rollType - Type of roll being intercepted\n   * @param {Actor5e} actor - Actor for initiative\n   * @param {D20Roll} roll - Roll configuration object\n   * @returns {boolean|void} - Return false to prevent the roll\n   */\n  static _onPreRollInterceptInitiative(rollType, actor, roll) {\n    // LogUtil.log('_onPreRollInterceptInitiative', [rollType, actor, roll]);\n    return;\n  }\n\n  /**\n   * Handle pre-roll hooks to intercept rolls\n   * @param {string} rollType - Type of roll being intercepted\n   * @param {Object} config - Roll configuration object (or Actor for initiative)\n   * @param {Object} dialog - Dialog options\n   * @param {Object} message - Message options\n   * @returns {boolean|void} - Return false to prevent the roll\n   */\n  static _onPreRollIntercept(rollType, config, dialog, message) {\n    LogUtil.log('_onPreRollIntercept #0', [rollType, config, dialog, message]);\n    const SETTINGS = getSettings();\n    const requestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const rollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n    const isMidiOn = GeneralUtil.isModuleOn('midi-qol');\n\n    let actor;\n    if (rollType === ROLL_TYPES.INITIATIVE && config instanceof Actor) {\n      actor = config;\n      LogUtil.log('_onPreRollIntercept - Initiative', [config, dialog, message]);\n      if (dialog?.isRollRequest === false || message?.isRollRequest === false) {\n        return;\n      }\n    } else if (rollType === ROLL_TYPES.HIT_DIE) {\n      actor = dialog?.subject?.actor || dialog?.subject || dialog?.actor;\n    } else if(rollType === ROLL_TYPES.ATTACK || rollType === ROLL_TYPES.DAMAGE){\n      actor = config.subject?.actor;\n    } else {\n      actor = config.subject?.actor || config.subject || config.actor;\n    }\n\n    // Calculate these variables before using them\n    const owner = GeneralUtil.getActorOwner(actor);\n    const isPC = owner?.id === game.user.id && owner?.active;\n    const areSkipKeysPressed = GeneralUtil.areSkipKeysPressed(config.event);\n    const skipRollDialog = areSkipKeysPressed || SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n\n    if (!requestsEnabled || !rollInterceptionEnabled || config.isRollRequest === false) {\n      dialog.configure = areSkipKeysPressed ? false : config.isRollRequest!==undefined ? false : !RollHelpers.shouldSkipRollDialog(skipRollDialog, {isPC: isPC, isNPC: !isPC});\n      return;\n    }\n    LogUtil.log('_onPreRollIntercept #1', [requestsEnabled, rollInterceptionEnabled, config.isRollRequest]);\n\n    // Only intercept on GM side, if this is a request\n    if (!game.user.isGM) return;\n    if(isMidiOn && (owner?.isGM || !owner?.active)) return;\n\n    const hookNames = config?.hookNames || dialog?.hookNames || message?.hookNames || [];\n    const isInitiativeRoll = hookNames.includes('initiativeDialog') || hookNames.includes('initiative');\n    \n    if(rollType === ROLL_TYPES.ATTACK || rollType === ROLL_TYPES.DAMAGE){\n      const moduleFlags = config.subject?.item?.getFlag(MODULE_ID, 'tempAttackConfig') || config.subject?.item?.getFlag(MODULE_ID, 'tempDamageConfig');\n      dialog.configure = false;\n      LogUtil.log('_onPreRollIntercept - attack / damage - flag', [moduleFlags]);\n      if(moduleFlags){\n        LogUtil.log('_onPreRollIntercept - found module flags, skipping interception', [moduleFlags]);\n        return;\n      }\n    }\n    \n    // Override rollType if this is actually an initiative roll\n    if (isInitiativeRoll && rollType === ROLL_TYPES.ABILITY) {\n      LogUtil.log('RollInterceptor._onPreRollIntercept - Overriding ability to initiative', [hookNames]);\n      rollType = ROLL_TYPES.INITIATIVE;\n    }\n    \n    if ( config?.isRollRequest || config.sendRequest===false || \n         dialog?.isRollRequest || message?.isRollRequest) {\n      LogUtil.log('_onPreRollIntercept - skipping interception (roll request)', [config, dialog, message]);\n      return;\n    }\n\n    if(!rollInterceptionEnabled || //!rollRequestsEnabled ||\n      !actor || actor.documentName !== 'Actor') {\n      return;\n    }\n\n    if (rollType === ROLL_TYPES.ATTACK) {\n      message = {\n        ...message,\n        rollMode: CONST.DICE_ROLL_MODES.PUBLIC\n      };\n    }\n\n    const isMidiActive = isMidiOn && config.midiOptions;\n\n    if (config.sendRequest===false || config.skipRollDialog===true) { \n      LogUtil.log('_onPreRollIntercept - skipping interception', [dialog.configure, config.sendRequest]);\n      return;\n    }\n    \n    if(isMidiActive && game.user.isGM){\n      // if(config.midiOptions?.fastForward){\n      //   config.midiOptions = {\n      //     ...config.midiOptions,\n      //     consume: {\n      //       spellSlot: false\n      //     }\n      //   }\n      // }\n      LogUtil.log('_onPreRollIntercept - MidiActive', [config.midiOptions]);\n      this._showGMConfigDialog(actor, owner, rollType, config, dialog, message); \n      return false;\n    }\n    \n    LogUtil.log('_onPreRollIntercept - intercepting roll #1', [config, message]);\n    this._showGMConfigDialog(actor, owner, rollType, config, dialog, message); \n    \n    return false;\n  }\n  /**\n   * Handle initiative-specific pre-roll checks\n   * @param {Actor} actor\n   * @returns {Promise<boolean>} true if should continue with roll\n   */\n  static async _handleInitiativePreChecks(actor) {\n    if (!game.combat) {\n      const combatReady = await ensureCombatForInitiative();\n      if (!combatReady) return false;\n    }\n    \n    const filteredActorIds = await filterActorsForInitiative([actor.id], game);\n    return filteredActorIds.length > 0;\n  }\n\n  /**\n   * Get the appropriate dialog class for a roll type\n   * @param {string} rollType\n   * @returns {Class} The dialog class to use\n   */\n  static _getDialogClass(rollType) {\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    if ([ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      return GMSkillToolConfigDialog;\n    } else if (normalizedRollType === ROLL_TYPES.HIT_DIE) {\n      return GMHitDieConfigDialog;\n    } else if (normalizedRollType === ROLL_TYPES.ATTACK) {\n      return GMAttackConfigDialog;\n    } else if (normalizedRollType === ROLL_TYPES.DAMAGE) {\n      return GMDamageConfigDialog;\n    } else {\n      return GMRollConfigDialog;\n    }\n  }\n\n  /**\n   * Extract roll key and build roll config based on roll type\n   * @param {string} rollType\n   * @param {Object} config\n   * @param {Object} dialog\n   * @param {Actor} actor\n   * @returns {Object} {rollKey, rollConfig}\n   */\n  static _extractRollConfiguration(rollType, config, dialog, actor) {\n    const normalizedRollType = rollType?.toLowerCase();\n    let rollKey = null;\n    const rollConfig = {\n      rolls: [{\n        parts: [],\n        data: {},\n        options: {}\n      }]\n    };\n\n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        rollConfig.skill = config.skill;\n        rollConfig.ability = config.ability || config.subject?.ability;\n        rollKey = rollConfig.skill;\n        break;\n        \n      case ROLL_TYPES.TOOL:\n        rollConfig.tool = config.tool;\n        rollConfig.ability = config.ability || config.subject?.ability;\n        rollKey = rollConfig.tool;\n        break;\n        \n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.SAVE:\n        rollConfig.ability = config.ability || config.subject?.ability;\n        rollKey = rollConfig.ability;\n        if (rollConfig.ability === 'con' && config.targetValue !== undefined) {\n          rollType = ROLL_TYPES.CONCENTRATION;\n        }\n        break;\n        \n      case ROLL_TYPES.CONCENTRATION:\n        rollConfig.ability = 'con';\n        rollKey = 'con';\n        break;\n        \n      case ROLL_TYPES.INITIATIVE:\n      case ROLL_TYPES.INITIATIVE_DIALOG:\n        rollKey = actor.system.attributes?.init?.ability || 'dex';\n        break;\n        \n      case ROLL_TYPES.HIT_DIE:\n        rollConfig.denomination = typeof config === 'string' ? \n          config : (config.denomination || config.subject?.denomination);\n        rollKey = rollConfig.denomination;\n        break;\n        \n      case ROLL_TYPES.ATTACK:\n        if (dialog?.options) {\n          rollConfig.ammunition = dialog.options.ammunition;\n          rollConfig.attackMode = dialog.options.attackMode;\n          rollConfig.mastery = dialog.options.mastery;\n        }\n        rollKey = config.subject?.item?.id;\n        break;\n        \n      case ROLL_TYPES.DAMAGE:\n        rollConfig.item = config.subject?.item;\n        rollConfig.subject = config.subject;\n        rollConfig.critical = config.critical || {};\n        rollKey = config.subject?.item?.id;\n        break;\n    }\n\n    return { rollKey, rollConfig };\n  }\n\n  /**\n   * Show dialog and get configuration from user\n   * @param {Class} DialogClass\n   * @param {Actor} actor\n   * @param {string} rollType\n   * @param {string} rollKey\n   * @param {boolean} skipRollDialog\n   * @param {boolean} rollRequestsEnabled\n   * @param {Object} config\n   * @param {Object} dialog\n   * @returns {Promise<Object>} Dialog result or default config\n   */\n  static async _getDialogResult(DialogClass, actor, rollType, rollKey, skipRollDialog, rollRequestsEnabled, config, dialog) {\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    LogUtil.log('_getDialogResult', [actor, rollType, rollKey, config, dialog]);\n    if (skipRollDialog) {\n      return {\n        sendRequest: true,\n        advantage: false,\n        disadvantage: false,\n        skipRollDialog: false,\n        situational: \"\",\n        rollMode: game.settings.get(\"core\", \"rollMode\")\n      };\n    }\n\n    if (!DialogClass.initConfiguration) {\n      LogUtil.error('DialogClass.initConfiguration not found', [DialogClass, DialogClass.name]);\n      throw new Error(`DialogClass ${DialogClass.name} does not have initConfiguration method`);\n    }\n    \n    const dialogOptions = {\n      skipRollDialog: false,\n      sendRequest: rollRequestsEnabled && config.isRollRequest !== false\n    };\n\n    LogUtil.log('_getDialogResult - normalizedRollType', [normalizedRollType, ROLL_TYPES.DAMAGE, ROLL_TYPES.ATTACK]);\n    if (normalizedRollType === ROLL_TYPES.ATTACK || normalizedRollType === ROLL_TYPES.DAMAGE) {\n      LogUtil.log('DialogClass.initConfiguration A', [actor, normalizedRollType, rollKey, dialogOptions, config, dialog]);\n      return await DialogClass.initConfiguration([actor], normalizedRollType, rollKey, dialogOptions, config, dialog);\n    } else {\n      LogUtil.log('DialogClass.initConfiguration B', [actor, normalizedRollType, rollKey, dialogOptions, config, dialog]);\n      return await DialogClass.initConfiguration([actor], normalizedRollType, rollKey, dialogOptions, config, dialog);\n    }\n  }\n\n  /**\n   * Show GM configuration dialog before sending roll request\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} rollType \n   * @param {Object} config \n   * @param {Object} dialog \n   * @param {Object} message \n   */\n  static async _showGMConfigDialog(actor, owner, rollType, config, dialog, message) {\n    LogUtil.log('_showGMConfigDialog - config', [rollType, config]);\n    const SETTINGS = getSettings();\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const areSkipKeysPressed = GeneralUtil.areSkipKeysPressed(config.event);\n\n    try {\n      const normalizedRollType = rollType?.toLowerCase();\n      \n      if (normalizedRollType === ROLL_TYPES.INITIATIVE) {\n        const shouldContinue = await this._handleInitiativePreChecks(actor);\n        if (!shouldContinue) return;\n      }\n      \n      const DialogClass = this._getDialogClass(rollType);\n      const { rollKey, rollConfig } = this._extractRollConfiguration(rollType, config, dialog, actor);\n      const isOwnerActive = owner && owner?.active && !owner?.isGM;\n      \n      let result;\n      const shouldSkipDialog = areSkipKeysPressed || RollHelpers.shouldSkipRollDialog(isOwnerActive ? rollRequestsEnabled : false, {isPC: isOwnerActive, isNPC: !isOwnerActive});\n      LogUtil.log('_showGMConfigDialog - rollConfig', [rollConfig, rollKey, shouldSkipDialog, isOwnerActive, owner]);\n      // Check if dialog should be skipped - pass rollRequestsEnabled as the sendRequest context\n      if (shouldSkipDialog) {\n        result = {\n          sendRequest: isOwnerActive ? rollRequestsEnabled : false,\n          advantage: false,\n          disadvantage: false,\n          skipRollDialog: true,\n          situational: \"\",\n          rollMode: game.settings.get(\"core\", \"rollMode\")\n        };\n      } else {\n        result = await this._getDialogResult(\n          DialogClass,\n          actor,\n          rollType,\n          rollKey,\n          shouldSkipDialog,\n          rollRequestsEnabled,\n          config,\n          dialog\n        );\n        LogUtil.log('_showGMConfigDialog - _getDialogResult', [result]);\n      }\n      \n      if (!result) {\n        LogUtil.log('_showGMConfigDialog - Dialog cancelled');\n        return;\n      }\n      \n      // If sendRequest is false, execute local roll\n      if (!result.sendRequest || !rollRequestsEnabled) {\n        LogUtil.log('_showGMConfigDialog - triggering _executeInterceptedRoll', [rollType, config, result]);\n        await this._executeInterceptedRoll(actor, rollType, config, result);\n        return;\n      }\n      \n      // Send the roll request to the player with the configured settings\n      // const { event, ...configWithoutEvent } = config;\n      delete config.event;\n      // Preserve the original subject (activity) before spreading result\n      const originalSubject = config.subject;\n      const finalConfig = {\n        ...config,\n        ...result,\n        subject: originalSubject, // Restore the original subject (activity)\n        rolls: result.rolls,\n        requestedBy: game.user.name,\n        // For attack activity rolls, prevent the usage message from being created\n        ...(rollType === ROLL_TYPES.ATTACK && { chatMessage: false })\n      };\n      \n      LogUtil.log('_showGMConfigDialog - triggering _sendRollRequest', [rollType, finalConfig]);\n      this._sendRollRequest(actor, owner, rollType, finalConfig);\n      \n    } catch (error) {\n      LogUtil.error('RollInterceptor._showGMConfigDialog - Error', [error]);\n      // Fallback: send request without configuration\n      // this._sendRollRequest(actor, owner, rollType, config);\n    }\n  }\n  \n  /**\n   * Called when an intercepted roll should be executed \n   * locally on the GM side instead of sent to player\n   * @param {Actor} actor \n   * @param {string} rollType \n   * @param {Object} originalConfig\n   * @param {Object} dialogResult\n   */\n  static async _executeInterceptedRoll(actor, rollType, originalConfig, dialogResult) {\n    LogUtil.log('RollInterceptor._executeInterceptedRoll', [actor, rollType, originalConfig, dialogResult]);\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    // Ensure we have a proper roll configuration structure\n    const rollConfig = dialogResult.rolls?.[0] || {\n      parts: [],\n      data: {},\n      options: {}\n    };\n    const situational = rollConfig.data?.situational || dialogResult.situational || \"\";\n    \n    // Determine the correct rollKey based on the roll type\n    let rollKey;\n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        rollKey = originalConfig.skill;\n        break;\n      case ROLL_TYPES.TOOL:\n        rollKey = originalConfig.tool;\n        break;\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.SAVE:\n        rollKey = originalConfig.ability || originalConfig.subject?.ability;\n        break;\n      case ROLL_TYPES.HIT_DIE:\n        rollKey = originalConfig.denomination;\n        break;\n      default:\n        rollKey = originalConfig.ability || originalConfig.skill || originalConfig.tool || originalConfig.denomination;\n    }\n    \n    const requestData = {\n      rollKey: rollKey,\n      config: {\n        advantage: dialogResult.advantage || originalConfig.advantage,\n        disadvantage: dialogResult.disadvantage || originalConfig.disadvantage,\n        target: dialogResult.target || dialogResult.dc || originalConfig.target,\n        rollMode: dialogResult.rollMode || originalConfig.rollMode,\n        situational: situational,\n        isRollRequest: false,\n        skipRollDialog: dialogResult.skipRollDialog,\n        ability: originalConfig.ability\n      }\n    };\n    \n    if (normalizedRollType === ROLL_TYPES.SKILL && !requestData.config.ability) {\n      requestData.config.ability = actor.system.skills?.[requestData.rollKey]?.ability || \n                                   CONFIG.DND5E.skills?.[requestData.rollKey]?.ability;\n    } else if (normalizedRollType === ROLL_TYPES.TOOL && !requestData.config.ability) {\n      const toolConfig = actor.system.tools?.[requestData.rollKey];\n      requestData.config.ability = toolConfig?.ability || \n                                   CONFIG.DND5E.enrichmentLookup?.tools?.[requestData.rollKey]?.ability ||\n                                   'int';\n    } else if ((normalizedRollType === ROLL_TYPES.ABILITY || normalizedRollType === ROLL_TYPES.SAVE) && !requestData.config.ability) {\n      requestData.config.ability = requestData.rollKey;\n    }\n    \n    LogUtil.log('RollInterceptor._executeInterceptedRoll - requestData', [requestData, originalConfig, dialogResult]);\n    \n    const dialogConfig = {\n      configure: false, // Skip dialog\n      isRollRequest: false\n    };\n    \n    const messageConfig = {\n      rollMode: requestData.config.rollMode,\n      create: true,\n      isRollRequest: false\n    };\n    \n    try {\n      const handlerMap = ROLL_TYPES;\n      const handler = RollHandlers[normalizedRollType];\n      \n      if (handler) {\n        // Special handling for attack and damage rolls\n        if (normalizedRollType === ROLL_TYPES.ATTACK || normalizedRollType === ROLL_TYPES.DAMAGE || normalizedRollType === ROLL_TYPES.SAVE) {\n          requestData.rollKey = originalConfig.subject?.item?.id;\n          requestData.activityId = originalConfig.subject?.id;\n          requestData.config.skipRollDialog = true;\n        }\n        \n        await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n      } else {\n        LogUtil.warn(`No handler found for roll type: ${normalizedRollType}`);\n      }\n    } catch (error) {\n      LogUtil.error(\"RollInterceptor._executeInterceptedRoll\", [error]);\n    }\n  }\n  \n  /**\n   * Send a roll request to the player\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} rollType \n   * @param {BasicRollProcessConfiguration} config - The roll process configuration\n   */\n  static async _sendRollRequest(actor, owner, rollType, config) {\n    LogUtil.log('_sendRollRequest', [actor, owner, rollType, config]);\n    LogUtil.log('_sendRollRequest - config.rolls', [config.rolls]);\n    const SETTINGS = getSettings();\n    let normalizedRollType = rollType?.toLowerCase();\n    const isOwnerActive = owner && owner.active && owner.id !== game.user.id;\n    \n    // Convert INITIATIVE to INITIATIVE_DIALOG for player requests\n    if (normalizedRollType === ROLL_TYPES.INITIATIVE) {\n      normalizedRollType = ROLL_TYPES.INITIATIVE_DIALOG;\n    }\n    \n    // Extract the roll key based on roll type\n    let rollKey = null;\n    let activityId = null;\n    switch (normalizedRollType) {\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.SAVE:\n        rollKey = config.ability;\n        break;\n      case ROLL_TYPES.SKILL:\n        rollKey = config.skill;\n        break;\n      case ROLL_TYPES.TOOL:\n        rollKey = config.tool;\n        break;\n      case ROLL_TYPES.ATTACK:\n      case ROLL_TYPES.DAMAGE:\n        LogUtil.log('_sendRollRequest - Attack/Damage roll config', [rollType, config]);\n        // for activities, config.subject is the activity itself\n        rollKey = config.subject.item?.id;\n        activityId = config.subject.id;\n        LogUtil.log('_sendRollRequest - resolved rollKey and activityId', [rollKey, activityId]);\n        break;\n      case ROLL_TYPES.HIT_DIE:\n        rollKey = typeof config === 'string' ? config : config.denomination;\n        break;\n      case ROLL_TYPES.INITIATIVE_DIALOG:\n      case ROLL_TYPES.INITIATIVE:\n        rollKey = null;\n        break;\n      case ROLL_TYPES.DEATH_SAVE:\n        rollKey = null;\n        break;\n      default:\n        LogUtil.warn(`Unknown roll type: ${rollType}`);\n        return;\n    }\n    \n    // Build the request data with proper rollProcessConfig\n    // Filter out circular references that midi-qol adds\n    const cleanConfig = { ...config };\n\n    if(cleanConfig.midiOptions && cleanConfig.activity && cleanConfig.activity.type === ACTIVITY_TYPES.DAMAGE){\n      LogUtil.log('_sendRollRequest - Damage activity', [cleanConfig]);\n      cleanConfig.midiOptions = {\n        ...cleanConfig.midiOptions,\n        workflowOptions: {\n          ...cleanConfig.midiOptions.workflowOptions,\n          fastForward: false,\n          fastForwardAttack: false,\n          fastForwardDamage: false,\n        }\n      };\n    }\n    delete cleanConfig.subject;\n    delete cleanConfig.workflow;\n    delete cleanConfig.item;\n    delete cleanConfig.activity;\n\n    const requestData = {\n      type: \"rollRequest\",\n      requestId: foundry.utils.randomID(),\n      actorId: actor.id,\n      rollType: normalizedRollType,\n      rollKey,\n      activityId,\n      rollProcessConfig: {\n        ...cleanConfig,\n        _requestedBy: game.user.name  // Add who requested the roll\n      },\n      skipRollDialog: false, \n      targetTokenIds: Array.from(game.user.targets).map(t => t.id),\n      preserveTargets: SettingsUtil.get(SETTINGS.useGMTargetTokens.tag)\n    };\n\n    LogUtil.log('_sendRollRequest - requestData', [owner, requestData]);\n    \n    // Check if there's a valid active owner to send the request to\n    if (!isOwnerActive) {\n      LogUtil.log('_sendRollRequest - No valid active owner, executing locally', [owner?.name, owner?.active]);\n      // Execute roll locally since there's no player to send to\n      const defaultDialogResult = {\n        ...cleanConfig,\n        rollMode: config.rollMode || game.settings.get(\"core\", \"rollMode\"),\n        skipRollDialog: RollHelpers.shouldSkipRollDialog(false, {isPC: false, isNPC: true})\n      };\n      await this._executeInterceptedRoll(actor, rollType, config, defaultDialogResult);\n      return;\n    }\n    \n    // Use unified offline player handling\n    const wasOffline = await OfflinePlayerManager.handleOfflinePlayer(owner, actor, rollType, config, {\n      ...config,\n      sendRequest: false \n    });\n    \n    if (wasOffline) {\n      return; // Player was offline and roll was handled\n    }\n    \n    // Owner is active, send the request\n    SocketUtil.execForUser('handleRollRequest', owner.id, requestData);\n    ui.notifications.info(game.i18n.format('FLASH_ROLLS.notifications.rollRequestSent', { \n      player: owner?.name || 'Unknown',\n      actor: actor.name || 'Unknown' \n    }));\n    \n  }\n}","import { LogUtil } from '../../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { RollInterceptor } from '../../handlers/RollInterceptor.mjs';\nimport { RollHandlers } from '../../handlers/RollHandlers.mjs';\n\n/**\n * Handles offline player detection and roll execution\n */\nexport class OfflinePlayerManager {\n  \n  /**\n   * Check if a player owner is offline and handle the roll accordingly\n   * @param {User} owner - The player owner\n   * @param {Actor} actor - The actor to roll for\n   * @param {string} rollType - The type of roll\n   * @param {Object} originalConfig - Original roll configuration\n   * @param {Object} dialogResult - Dialog result configuration\n   * @returns {boolean} - Returns true if player is offline and roll was handled, false if player is online\n   */\n  static async handleOfflinePlayer(owner, actor, rollType, originalConfig, dialogResult = null) {\n    LogUtil.log('OfflinePlayerManager.handleOfflinePlayer', [owner?.name, actor?.name, rollType]);\n\n    if (!owner || !originalConfig) {\n      ui.notifications.warn('Flash Rolls: No owner found for actor ' + actor.name);\n      return true;\n    }\n    \n    if (!owner.active) {\n      const SETTINGS = getSettings();\n      if (SettingsUtil.get(SETTINGS.showOfflineNotifications.tag)) {\n        ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.playerOffline\", { \n          player: owner.name \n        }));\n      }\n      \n      // Execute the roll locally using the RollInterceptor's static method\n      const RollInterceptorClass = RollInterceptor;\n      await RollInterceptorClass._executeInterceptedRoll(actor, rollType, originalConfig, dialogResult || {\n        ...originalConfig,\n        sendRequest: false \n      });\n\n      \n      return true; // Player was offline and roll was handled\n    }\n    \n    return false; // Player is online, continue normal processing\n  }\n  \n  /**\n   * Categorize actors by their owner's online status\n   * @param {Array} pcActors - Array of {actor, owner} objects\n   * @returns {Object} - Object with onlinePlayerActors and offlinePlayerActors arrays\n   */\n  static categorizeActorsByOnlineStatus(pcActors) {\n    const onlinePlayerActors = [];\n    const offlinePlayerActors = [];\n    \n    // Group actors by ID to check all owners per actor\n    const actorMap = new Map();\n    for (const { actor, owner } of pcActors) {\n      if (!actorMap.has(actor.id)) {\n        actorMap.set(actor.id, { actor, owners: [] });\n      }\n      actorMap.get(actor.id).owners.push(owner);\n    }\n    \n    // Check each actor's owners\n    for (const { actor, owners } of actorMap.values()) {\n      const onlineNonGMOwner = owners.find(owner => owner.active && !owner.isGM);\n      \n      if (onlineNonGMOwner) {\n        onlinePlayerActors.push({ actor, owner: onlineNonGMOwner });\n      } else {\n        offlinePlayerActors.push(actor);\n      }\n    }\n    \n    return { onlinePlayerActors, offlinePlayerActors };\n  }\n  \n  /**\n   * Process offline actors using the unified offline handling\n   * @param {Actor[]} offlineActors - Array of actors whose owners are offline\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {Object} config - Roll configuration\n   */\n  static async processOfflineActors(offlineActors, rollMethodName, rollKey, config) {\n    LogUtil.log('OfflinePlayerManager.processOfflineActors', [\n      offlineActors.map(a => a.name), rollMethodName, rollKey\n    ]);\n    \n    for (const actor of offlineActors) {\n      const ownership = actor.ownership || {};\n      let owner = null;\n      \n      for (const [userId, level] of Object.entries(ownership)) {\n        if (level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER && userId !== \"default\") {\n          const potentialOwner = game.users.get(userId);\n          if (potentialOwner && !potentialOwner.isGM) {\n            owner = potentialOwner;\n            break;\n          }\n        }\n      }\n      \n      if (!owner) {\n        LogUtil.warn('OfflinePlayerManager.processOfflineActors - No owner found for actor', [actor.name]);\n        continue;\n      }\n      \n      // Prepare parameters for RollHandlers\n      const requestData = {\n        rollKey: rollKey,\n        groupRollId: config.groupRollId, // Add groupRollId at top level\n        config: {\n          ...config,\n          // Only set ability for ability checks and saving throws (where rollKey is the ability)\n          ...(rollMethodName === 'ability' || rollMethodName === 'abilitycheck' || \n              rollMethodName === 'save' || rollMethodName === 'savingthrow' ? { ability: rollKey } : {}),\n          sendRequest: false,\n          isGroupRoll: !!config.groupRollId\n        }\n      };\n      \n      const rollConfig = {\n        parts: [],\n        data: config.situational ? { situational: config.situational } : {},\n        options: config.dc ? { target: config.dc } : {}\n      };\n      \n      const dialogConfig = {\n        configure: false, // Skip dialog for offline rolls\n        isRollRequest: true\n      };\n      \n      const messageConfig = {\n        rollMode: config.rollMode || game.settings.get(\"core\", \"rollMode\"),\n        create: true,\n        isRollRequest: true,\n        groupRollId: config.groupRollId\n      };\n      \n      // Execute the roll\n      const handler = RollHandlers[rollMethodName.toLowerCase()];\n      if (handler) {\n        await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n      }\n      // Add delay between rolls to prevent overwhelming\n      await new Promise(resolve => setTimeout(resolve, 200));\n    }\n  }\n}","import { MODULE, ROLL_TYPES } from '../../../constants/General.mjs';\nimport { LogUtil } from '../../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { SocketUtil } from '../../utils/SocketUtil.mjs';\nimport { delay, NotificationManager, filterActorsForDeathSaves, categorizeActorsByOwnership, getActorData } from '../../helpers/Helpers.mjs';\nimport { RollHandlers } from '../../handlers/RollHandlers.mjs';\nimport { ensureCombatForInitiative, filterActorsForInitiative } from '../../helpers/RollValidationHelpers.mjs';\nimport { ChatMessageManager } from '../ChatMessageManager.mjs';\nimport { RollMenuConfig } from './RollMenuConfig.mjs';\nimport { OfflinePlayerManager } from './OfflinePlayerManager.mjs';\n\n/**\n * Utility class for orchestrating roll requests and execution\n */\nexport class RollMenuOrchestrator {\n  \n  /**\n   * Orchestrate rolls for selected actors, handling both player requests and GM rolls\n   * @param {Object} config - Roll configuration\n   * @param {Array} pcActors - PC actors with owners\n   * @param {Actor[]} npcActors - NPC actors\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {Array} actorsData - Array of actor entries with unique IDs\n   * @param {RollRequestsMenu} menu - Menu instance for accessing methods\n   */\n  static async orchestrateRollsForActors(config, pcActors, npcActors, rollMethodName, rollKey, actorsData, menu) {\n    const SETTINGS = getSettings();\n    const successfulRequests = [];\n    const offlinePlayerActors = [];\n    const onlinePlayerActors = [];\n    let groupRollId = foundry.utils.randomID();\n    \n    LogUtil.log('RollMenuOrchestrator.orchestrateRollsForActors', [\n      'config.sendRequest:', config.sendRequest,\n      'pcActors:', pcActors.map(p => `${p.actor.name}(${p.owner?.name})`),\n      'npcActors:', npcActors.map(n => n.name)\n    ]);\n    \n    const allActorEntries = [];\n    const allActors = [];\n\n    if (config.sendRequest) {\n      // Use unified offline player categorization\n      const { onlinePlayerActors: online, offlinePlayerActors: offline } = \n        OfflinePlayerManager.categorizeActorsByOnlineStatus(pcActors);\n      \n      onlinePlayerActors.push(...online);\n      offlinePlayerActors.push(...offline);\n      \n      // Show offline notifications\n      if (offline.length > 0) {\n        const SETTINGS = getSettings();\n        if (SettingsUtil.get(SETTINGS.showOfflineNotifications.tag)) {\n          offline.forEach(actor => {\n            const owner = pcActors.find(pc => pc.actor.id === actor.id)?.owner;\n            if (owner) {\n              NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.playerOffline\", { \n                player: owner.name \n              }));\n            }\n          });\n        }\n      }\n      \n      allActors.push(...onlinePlayerActors.map(({actor}) => actor));\n    } else {\n      npcActors.push(...pcActors.map(({ actor }) => actor));\n    }\n    \n    allActors.push(...offlinePlayerActors, ...npcActors);\n    const allActorIds = allActors.map(actor => actor.id);\n    \n    allActorEntries.push(...actorsData.filter(item => \n      item && item.actor && allActorIds.includes(item.actor.id)\n    ));\n\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    \n    // Create group message FIRST so individual rolls can update it\n    if (groupRollsMsgEnabled && allActors.length > 1) {\n      await ChatMessageManager.createGroupRollMessage(\n        allActorEntries,\n        rollMethodName,\n        rollKey,\n        config,\n        groupRollId\n      );\n      await delay(100);\n    }\n    \n    // Handle offline player actors AFTER creating group message\n    if (offlinePlayerActors.length > 0) {\n      config.skipRollDialog = true;\n      config.groupRollId = groupRollId; // Set group ID so rolls are included in group message\n      \n      await OfflinePlayerManager.processOfflineActors(offlinePlayerActors, rollMethodName, rollKey, config);\n    }\n\n    // Special handling for hit die rolls - check ALL actors upfront and refill if needed\n    if (rollMethodName === ROLL_TYPES.HIT_DIE) {\n      const allActorsForHitDie = [];\n      onlinePlayerActors.forEach(({actor}) => allActorsForHitDie.push(actor));\n      offlinePlayerActors.forEach(actor => allActorsForHitDie.push(actor));\n      npcActors.forEach(actor => allActorsForHitDie.push(actor));\n      \n      const refillCheckComplete = await this.handleHitDieRefill(allActorsForHitDie);\n      \n      if (!refillCheckComplete) {\n        return;\n      }\n    }\n\n    // Player Rolls: Actors owned by active players\n    for (const { actor, owner } of onlinePlayerActors) {\n      const useGroupId = groupRollsMsgEnabled && allActors.length > 1 ? groupRollId : null;\n      \n      let currentRollKey = rollKey;\n      if (rollMethodName === ROLL_TYPES.HIT_DIE) {\n        currentRollKey = actor.system.attributes.hd.largestAvailable;\n        if (!currentRollKey) {\n          continue;\n        }\n      }\n      \n      await this.sendRollRequestToPlayer(actor, owner, rollMethodName, currentRollKey, config, true, useGroupId);\n      successfulRequests.push({ actor, owner });\n      await delay(250);\n    }\n    if (successfulRequests.length > 0) {\n      this.showConsolidatedNotification(successfulRequests, rollMethodName, rollKey);\n    }\n    \n    // Handle NPC actors using traditional GM rolls\n    if (npcActors.length > 0) {\n      config.skipRollDialog = true;\n      config.groupRollId = groupRollsMsgEnabled && allActors.length > 1 ? groupRollId : null;\n      \n      const npcActorIds = npcActors.map(actor => actor.id);\n      const npcActorEntries = actorsData.filter(entry => \n        entry && entry.actor && npcActorIds.includes(entry.actor.id)\n      );\n      \n      await menu._handleGMRollsWithTokens(npcActorEntries, rollMethodName, rollKey, config);\n    }\n  }\n\n  /**\n   * Handle hit die refill dialog for actors with no available hit dice\n   * @param {Actor|Actor[]} actors - Single actor or array of actors to potentially refill hit dice for\n   * @returns {Promise<boolean>} True if refill succeeded or not needed, false if cancelled\n   */\n  static async handleHitDieRefill(actorsToRefill) {\n    const actors = Array.isArray(actorsToRefill) ? actorsToRefill : [actorsToRefill];\n    \n    const actorsNeedingRefill = actors.filter(actor => {\n      const hdData = actor.system.attributes.hd;\n      const needsRefill = hdData.value === 0;\n      return needsRefill;\n    });\n    \n    if (actorsNeedingRefill.length === 0) {\n      return true; // No refill needed\n    }\n    \n    const actorNames = actorsNeedingRefill.map(actor => actor.name).join(\", \");\n    \n    // Show dialog to GM\n    const dialogResult = await foundry.applications.api.DialogV2.confirm({\n      window: {\n        title: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillTitle\") || \"No Hit Dice Available\",\n        classes: [\"flash5e-hit-die-dialog\"]\n      },\n      position: {\n        width: 420\n      },\n      content: `<p>${game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refillMessage\", { \n        actors: actorNames \n      }) || \"\"}</p>`,\n      modal: true,\n      rejectClose: false,\n      yes: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend\") || \"Refill & Send\",\n        icon: \"\"\n      },\n      no: {\n        label: game.i18n.localize(\"Cancel\") || \"Cancel\",\n        icon: \"\"\n      }\n    });\n    \n    if (dialogResult) {\n      for (const actor of actorsNeedingRefill) {\n        try {\n          const hitDieResult = await RollHandlers.handleHitDieRecovery(actor);\n          \n          // If this is a token actor, also update the base actor to keep them in sync\n          if (actor.isToken && actor._actor) {\n            try {\n              await RollHandlers.handleHitDieRecovery(actor._actor);\n            } catch (baseActorError) {\n              LogUtil.error('Error updating base actor:', [baseActorError]);\n            }\n          }\n        } catch (error) {\n          LogUtil.error('Error calling handleHitDieRecovery:', [error]);\n        }\n      }\n      \n      NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refilled\", { \n        actor: actorNames \n      }) || `Hit dice refilled for ${actorNames}`);\n      \n      return true;\n    }\n    \n    return false;\n  }\n\n  /**\n   * Method called from menu items to trigger the roll for selected actors\n   * @param {string} requestType - The type of roll request (e.g., 'skill', 'ability')\n   * @param {string} rollKey - The specific roll key (e.g., 'acr' for Acrobatics)\n   * @param {RollRequestsMenu} menu - Menu instance for accessing properties and methods\n   * @param {Object} [config={}] - Optional configuration overrides\n   * @param {boolean} [config.skipRollDialog] - Override skip roll dialog setting\n   * @param {number} [config.dc] - Difficulty Class for the roll\n   * @param {string} [config.situationalBonus] - Situational bonus\n   * @param {boolean} [config.advantage] - Roll with advantage\n   * @param {boolean} [config.disadvantage] - Roll with disadvantage\n   */\n  static async triggerRoll(requestType, rollKey, menu, config = {}) {\n    const SETTINGS = getSettings();\n    const selectedUniqueIds = Array.from(menu.selectedActors);\n    const skipRollDialog = config.skipRollDialog !== undefined ? config.skipRollDialog : SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n    \n    let actorsData = selectedUniqueIds\n      .map(uniqueId => {\n        const actor = getActorData(uniqueId);\n        if (!actor) return null;\n        \n        let tokenId = null;\n        if (game.actors.get(uniqueId)) {\n          tokenId = null;\n        } else {\n          tokenId = uniqueId;\n        }\n        \n        return { actor, uniqueId, tokenId };\n      })\n      .filter(item => item);\n    \n    let actors = actorsData.map(item => item.actor);\n    \n    const rollOption = MODULE.ROLL_REQUEST_OPTIONS[requestType];\n    const rollMethodName = (rollOption?.name || requestType)?.toLowerCase();\n    \n    const originalRollKey = rollKey;\n    rollKey = await this.handleSpecialRollTypes(rollMethodName, rollKey, selectedUniqueIds, actorsData, actors, menu);\n    if (rollKey === null && originalRollKey !== null) {\n      return; // Operation cancelled or failed\n    }\n    \n    if (!actors.length) {\n      NotificationManager.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n      return;\n    }\n    \n    const { pcActors, npcActors } = categorizeActorsByOwnership(actors);\n    const rollConfig = await RollMenuConfig.getRollConfiguration(actors, rollMethodName, rollKey, skipRollDialog, pcActors, config);\n    \n    if (!rollConfig) return;\n    \n    await this.orchestrateRollsForActors(rollConfig, pcActors, npcActors, rollMethodName, rollKey, actorsData, menu);\n    \n    if (!menu.isLocked && typeof menu.close === 'function') {\n      setTimeout(() => menu.close(), 500);\n    }\n  }\n\n  /**\n   * Handle special roll types that require additional processing\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {Array} selectedUniqueIds - Selected actor unique IDs\n   * @param {Array} actorsData - Actor data array (modified by reference)\n   * @param {Array} actors - Actors array (modified by reference)\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {Promise<string|null>} Modified rollKey or null if cancelled\n   */\n  static async handleSpecialRollTypes(rollMethodName, rollKey, selectedUniqueIds, actorsData, actors, menu) {\n    const SETTINGS = getSettings();\n    \n    switch(rollMethodName) {\n      case ROLL_TYPES.CUSTOM:\n        rollKey = await RollMenuConfig.handleCustomRoll();\n        if (!rollKey) return null;\n        break;\n        \n      case ROLL_TYPES.INITIATIVE:\n      case ROLL_TYPES.INITIATIVE_DIALOG:\n        const result = await this.handleInitiativeRoll(selectedUniqueIds, actorsData, actors);\n        if (!result.success) return null;\n        // actorsData and actors are modified by reference\n        \n        const initiateCombat = SettingsUtil.get(SETTINGS.initiateCombatOnRequest.tag);\n        if (initiateCombat) {\n          game.combat.startCombat();\n        }\n        break;\n        \n      case ROLL_TYPES.DEATH_SAVE:\n        const filteredActors = await filterActorsForDeathSaves(actors);\n        actors.length = 0;\n        actors.push(...filteredActors);\n        actorsData = actorsData.filter(item => filteredActors.includes(item.actor));\n        break;\n        \n      case ROLL_TYPES.HIT_DIE:\n        const characterActors = actors.filter(actor => actor.type === 'character');\n        if (characterActors.length === 0) {\n          NotificationManager.notify('warn', game.i18n.localize(\"FLASH_ROLLS.notifications.noCharactersForHitDie\") || \n            \"Hit dice can only be rolled for player characters, not NPCs.\");\n          return null;\n        }\n        actors.length = 0;\n        actors.push(...characterActors);\n        actorsData = actorsData.filter(item => item.actor.type === 'character');\n        break;\n    }\n    \n    return rollKey;\n  }\n\n  /**\n   * Handle initiative roll processing\n   * @param {Array} selectedUniqueIds - Selected actor unique IDs\n   * @param {Array} actorsData - Actor data array (modified by reference)\n   * @param {Array} actors - Actors array (modified by reference)\n   * @returns {Promise<{success: boolean}>} Success status\n   */\n  static async handleInitiativeRoll(selectedUniqueIds, actorsData, actors) {\n    const combatReady = await ensureCombatForInitiative();\n    if (!combatReady) return { success: false };\n    \n    const actorsWithoutTokens = [];\n    const actorsWithTokens = [];\n    \n    for (const uniqueId of selectedUniqueIds) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n      \n      let tokenId = null;\n      \n      if (!game.actors.get(uniqueId)) {\n        tokenId = uniqueId;\n        actorsWithTokens.push(actor.name);\n      } else {\n        tokenId = actor.getActiveTokens()?.[0]?.id || null;\n        if (!tokenId) {\n          actorsWithoutTokens.push(actor.name);\n          continue;\n        }\n        actorsWithTokens.push(actor.name);\n        \n        const existingCombatant = game.combat.combatants.find(c => c.tokenId === tokenId);\n        if (!existingCombatant) {\n          await game.combat.createEmbeddedDocuments(\"Combatant\", [{\n            actorId: actor.id,\n            tokenId: tokenId\n          }]);\n        }\n      }\n    }\n    \n    if (actorsWithTokens.length === 0) {\n      // ui.notifications.warn(game.i18n.localize(\"FLASH_ROLLS.notifications.noTokensForInitiative\"));\n      return { success: false };\n    }\n    \n    if (actorsWithoutTokens.length > 0) {\n      ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.actorsSkippedInitiative\", {\n        actors: actorsWithoutTokens.join(\", \")\n      }) || `Initiative skipped for actors without tokens: ${actorsWithoutTokens.join(\", \")}`);\n    }\n    \n    const entriesWithTokens = actorsData.filter(entry => {\n      if (entry.tokenId) return true;\n      const hasToken = entry.actor.getActiveTokens()?.[0];\n      return !!hasToken;\n    });\n    \n    actorsData.length = 0;\n    actorsData.push(...entriesWithTokens);\n    \n    actors = entriesWithTokens.map(entry => entry.actor);\n    const uniqueActorIds = [...new Set(actors.map(actor => actor.id))];\n    const filteredActorIds = await filterActorsForInitiative(uniqueActorIds, game);\n\n    if (!filteredActorIds.length) return { success: false };\n\n    const filteredActorsData = actorsData.filter(item => \n      item && item.actor && filteredActorIds.includes(item.actor.id)\n    );\n    \n    actors.length = 0;\n    actors.push(...filteredActorIds.map(id => game.actors.get(id)).filter(actor => actor));\n    \n    actorsData.length = 0;\n    actorsData.push(...filteredActorsData);\n    \n    return { success: true };\n  }\n\n  /**\n   * Send a roll request to a player\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} config - Roll configuration from dialog\n   * @param {boolean} suppressNotification - If true, don't show individual notification\n   * @param {string} groupRollId - Optional group roll ID for multi-actor rolls\n   */\n  static async sendRollRequestToPlayer(actor, owner, requestType, rollKey, config, suppressNotification = false, groupRollId = null) {\n    const SETTINGS = getSettings();\n    \n    let rollType = requestType?.toLowerCase();\n    \n    // Mapping for compound types\n    if (rollType === ROLL_TYPES.ABILITY_CHECK) {\n      rollType = ROLL_TYPES.ABILITY;\n    } else if (rollType === ROLL_TYPES.SAVING_THROW) {\n      rollType = ROLL_TYPES.SAVE;\n    } else if (rollType === ROLL_TYPES.INITIATIVE_DIALOG) {\n      rollType = ROLL_TYPES.INITIATIVE;\n    }\n    \n    // For hit die rolls, get the largest available denomination\n    if (rollType === ROLL_TYPES.HIT_DIE) {\n      rollKey = actor.system.attributes.hd.largestAvailable;\n      if (!rollKey) {\n        LogUtil.warn(`No hit dice available for ${actor.name}.`);\n        return;\n      }\n    }\n    \n    // Build the request data with proper rollProcessConfig\n    const cleanConfig = { ...config };\n    delete cleanConfig.subject;\n    delete cleanConfig.workflow;\n    delete cleanConfig.item;\n    delete cleanConfig.activity;\n    \n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag) === true;\n    \n    if (isPublicRollsOn) {\n      cleanConfig.rollMode = CONST.DICE_ROLL_MODES.PUBLIC;\n    }\n    \n    const requestData = {\n      type: \"rollRequest\",\n      groupRollId: groupRollId || foundry.utils.randomID(),\n      actorId: actor.isToken ? actor.token.id : actor.id,\n      isTokenActor: actor.isToken, \n      baseActorId: actor.isToken ? actor._actor?.id : actor.id,\n      rollType,\n      rollKey,\n      activityId: null, \n      rollProcessConfig: {\n        ...cleanConfig,\n        _requestedBy: game.user.name\n      },\n      skipRollDialog: false,\n      targetTokenIds: Array.from(game.user.targets).map(t => t.id),\n      preserveTargets: SettingsUtil.get(SETTINGS.useGMTargetTokens.tag)\n    };\n    \n    LogUtil.log('RollMenuOrchestrator.sendRollRequestToPlayer - sending request', []);\n    SocketUtil.execForUser('handleRollRequest', owner.id, requestData);\n    \n    if (!suppressNotification) {\n      NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.rollRequestSent\", { \n        player: owner.name,\n        actor: actor.name \n      }));\n    }\n  }\n\n  /**\n   * Send a consolidated notification for multiple roll requests\n   * @param {Array} successfulRequests - Array of {actor, owner} objects\n   * @param {string} rollMethodName - The type of roll being requested\n   * @param {string} rollKey - The specific roll key (if applicable)\n   */\n  static showConsolidatedNotification(successfulRequests, rollMethodName, rollKey) {\n    const requestsByPlayer = {};\n    for (const { actor, owner } of successfulRequests) {\n      if (!requestsByPlayer[owner.id]) {\n        requestsByPlayer[owner.id] = {\n          player: owner,\n          actors: []\n        };\n      }\n      requestsByPlayer[owner.id].actors.push(actor);\n    }\n    \n    // Get roll type name for display\n    let rollTypeName = game.i18n.localize(`FLASH_ROLLS.rollTypes.${rollMethodName}`) || rollMethodName;\n    \n    if (rollKey) {\n      const normalizedRollTypeKey = rollMethodName.toLowerCase();\n      if (normalizedRollTypeKey === ROLL_TYPES.SKILL) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.skills[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.SAVING_THROW) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.ABILITY_CHECK) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.TOOL) {\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          rollTypeName = `${rollTypeName} (${toolItem?.name || rollKey})`;\n        } else {\n          rollTypeName = `${rollTypeName} (${rollKey})`;\n        }\n      } else if (normalizedRollTypeKey === ROLL_TYPES.CUSTOM) {\n        rollTypeName = `${rollTypeName}: ${rollKey}`;\n      }\n    }\n    \n    // Use NotificationManager for consolidated roll request notifications\n    NotificationManager.notifyRollRequestsSent(requestsByPlayer, rollTypeName);\n  }\n}","import { MODULE, ROLL_TYPES } from \"../../constants/General.mjs\";\nimport { RollMenuOrchestrator } from \"../managers/roll-menu/RollMenuOrchestrator.mjs\";\nimport RollRequestsMenu from \"../ui/RollRequestsMenu.mjs\";\nimport { getActorData, getFullRollName } from \"../helpers/Helpers.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { RollHelpers } from \"../helpers/RollHelpers.mjs\";\n\n/**\n * Public API for Flash Rolls 5e that can be used by other modules\n * Accessible via FlashRolls5e.requestRoll() or game.modules.get('flash-rolls-5e').api\n */\nexport class FlashRollsAPI {\n  \n  /**\n   * Request a roll for specified actors\n   * @param {Object} options - Roll request options\n   * @param {string} options.requestType - The type of roll request (lowercase from ROLL_TYPES, e.g., 'skill', 'ability', 'savingthrow')\n   * @param {string} [options.rollKey=null] - The specific roll key (e.g., 'acr' for Acrobatics, 'str' for Strength)\n   * @param {string[]} [options.actorIds=[]] - Array of actor IDs or token IDs to roll for\n   * @param {number} [options.dc] - Difficulty Class for the roll\n   * @param {string} [options.situationalBonus] - Situational bonus (e.g., '+2', '1d4')\n   * @param {boolean} [options.advantage] - Roll with advantage\n   * @param {boolean} [options.disadvantage] - Roll with disadvantage\n   * @param {boolean} [options.skipRollDialog] - Skip the roll dialog\n   * @param {boolean} [options.sendAsRequest] - Send to players instead of rolling locally\n   * @returns {Promise<void>}\n   */\n  static async requestRoll(options = {}) {\n    try {\n      // Validate input parameters\n      if (!options || typeof options !== 'object') {\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.invalidMacroData\"));\n        return;\n      }\n      \n      const { requestType, rollKey = null, actorIds = [], dc, situationalBonus, advantage, disadvantage, skipRollDialog, sendAsRequest = true } = options;\n      \n      if (!requestType) {\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.missingRequestType\"));\n        return;\n      }\n      \n      const config = { dc, situationalBonus, advantage, disadvantage, skipRollDialog, sendAsRequest };\n      \n      LogUtil.log('FlashRollsAPI.requestRoll', [requestType, rollKey, actorIds, config]);\n      \n      // Find roll option by either uppercase key or lowercase name\n      let rollOption = MODULE.ROLL_REQUEST_OPTIONS[requestType];\n      if (!rollOption) {\n        // Try finding by lowercase name if not found by key\n        const rollRequestOptions = Object.values(MODULE.ROLL_REQUEST_OPTIONS);\n        rollOption = rollRequestOptions.find(option => option.name === requestType);\n      }\n      \n      if (!rollOption) {\n        ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.notifications.unknownRequestType\", {\n          requestType: requestType\n        }));\n        return;\n      }\n      \n      const normalizedRequestType = rollOption.name;\n      \n      if (actorIds.length === 0) {\n        ui.notifications.warn(game.i18n.localize(\"FLASH_ROLLS.notifications.noActorsSelected\"));\n        return;\n      }\n      \n      // Validate actorIds array\n      if (!Array.isArray(actorIds)) {\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.invalidActorIdsFormat\"));\n        return;\n      }\n      \n      // Create actor data array and track invalid IDs\n      const invalidActorIds = [];\n      const actorsData = [];\n      \n      for (const uniqueId of actorIds) {\n        const actor = getActorData(uniqueId);\n        if (!actor) {\n          invalidActorIds.push(uniqueId);\n          continue;\n        }\n        \n        let tokenId = null;\n        if (!game.actors.get(uniqueId)) {\n          tokenId = uniqueId;\n        }\n        \n        actorsData.push({\n          actor,\n          uniqueId,\n          tokenId\n        });\n      }\n      \n      // Show notification for invalid actors but continue with valid ones\n      if (invalidActorIds.length > 0) {\n        const invalidIds = invalidActorIds.join(', ');\n        ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.invalidActorIds\", {\n          numIds: invalidActorIds.length,\n          invalidIds: invalidIds\n        }));\n      }\n      \n      if (actorsData.length === 0) {\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.noValidActorsSelected\"));\n        return;\n      }\n      \n      // Create a mock menu object with the necessary properties\n      const mockMenu = {\n        selectedActors: new Set(actorIds),\n        selectedRequestType: requestType,\n        isLocked: true, \n        close: () => {} \n      };\n      \n      // Use orchestrator to handle the roll request\n      return RollMenuOrchestrator.triggerRoll(normalizedRequestType, rollKey, mockMenu, config);\n    } catch (error) {\n      LogUtil.error('FlashRollsAPI.requestRoll - Execution error:', [error]);\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.macroExecutionFailed\"));\n      return;\n    }\n  }\n  \n  /**\n   * Get list of available roll types\n   * @returns {Object} Available roll request options with name and label only\n   */\n  static getAvailableRollTypes() {\n    const cleanedOptions = {};\n    \n    for (const [key, option] of Object.entries(MODULE.ROLL_REQUEST_OPTIONS)) {\n      cleanedOptions[key] = {\n        name: option.name,\n        label: option.label\n      };\n    }\n    \n    return cleanedOptions;\n  }\n  \n  /**\n   * Get currently selected actors from the roll requests menu\n   * @returns {string[]} Array of selected actor/token IDs\n   */\n  static getSelectedActors() {\n    const menu = RollRequestsMenu.getInstance();\n    if (menu && menu.selectedActors) {\n      return Array.from(menu.selectedActors);\n    }\n    return [];\n  }\n  \n  /**\n   * Check if the roll requests menu is currently open\n   * @returns {boolean} True if menu is rendered and visible\n   */\n  static isMenuOpen() {\n    const menu = RollRequestsMenu.getInstance();\n    return menu && menu.rendered;\n  }\n  \n  /**\n   * Create a macro for a specific roll type and configuration\n   * @param {Object} macroData - Macro configuration data\n   * @param {string} macroData.requestType - The type of roll request\n   * @param {string} macroData.rollKey - The specific roll key (null for non-nested rolls)\n   * @param {string[]} macroData.actorIds - Array of actor IDs to include in macro\n   * @param {Object} macroData.config - Roll configuration\n   * @returns {Promise<Macro>} Created macro document\n   */\n  static async createMacro(macroData) {\n    const SETTINGS = getSettings();\n    const addMacrosToFolder = SettingsUtil.get(SETTINGS.addMacrosToFolder.tag);\n    \n    LogUtil.log('FlashRollsAPI.createMacro', [macroData]);\n    \n    const { requestType, rollKey = null, actorIds = [], config = {} } = macroData;\n    \n    let rollOption = MODULE.ROLL_REQUEST_OPTIONS[requestType];\n    if (!rollOption) {\n      const rollRequestOptions = Object.values(MODULE.ROLL_REQUEST_OPTIONS);\n      rollOption = rollRequestOptions.find(option => option.name === requestType);\n    }\n    if (!rollOption) {\n      ui.notifications.warn(`Unknown request type: ${requestType}`);\n      return;\n    }\n    \n    // Generate macro name using label property\n    let macroName = rollOption.label;\n    LogUtil.log('FlashRollsAPI.createMacro', [macroName, rollOption.subList]);\n    if (rollKey && rollOption.subList && Array.isArray(rollOption.subList)) {\n      const subItem = rollOption.subList.find(item => item.id === rollKey);\n      if (subItem) {\n        macroName = subItem.name;\n      }\n    } else if (rollKey) {\n      const fullName = getFullRollName(rollOption.name, rollKey);\n      macroName = fullName;\n    }\n    \n    const requestOptions = {\n      requestType: rollOption.name,\n      ...(rollKey && { rollKey }),\n      ...(actorIds.length > 0 && { actorIds }),\n      ...config\n    };\n    \n    if (requestOptions.advantage === undefined) requestOptions.advantage = false;\n    if (requestOptions.disadvantage === undefined) requestOptions.disadvantage = false;\n    \n    const command = `// Flash Rolls: ${macroName} - ${rollKey || ''}\n    try {\n      FlashRolls5e.requestRoll(${JSON.stringify(requestOptions, null, 2)});\n    } catch (error) {\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.macroDataMalformed\"));\n    }`;\n    let folderId = null;\n    if (addMacrosToFolder) {\n      folderId = await this._ensureFlashRollsFolder();\n    }\n\n    // Create the macro\n    const macroDocumentData = {\n      name: `Flash Rolls: ${macroName}`,\n      type: \"script\",\n      command: command,\n      img: \"modules/flash-rolls-5e/assets/bolt-circle.svg\",\n      ...(folderId && { folder: folderId }),\n      flags: {\n        \"flash-rolls-5e\": {\n          requestType,\n          rollKey,\n          actorIds,\n          config\n        }\n      }\n    };\n    \n    const macro = await Macro.create(macroDocumentData);\n    ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.macroCreated\", {\n      macroName: macro.name\n    }));\n    \n    // Open the macro configuration sheet for editing\n    macro.sheet.render(true);\n    \n    return macro;\n  }\n  \n  /**\n   * Ensure 'Flash Rolls' folder exists, creating it if necessary\n   * @returns {Promise<string|null>} The folder ID or null if creation failed\n   * @private\n   */\n  static async _ensureFlashRollsFolder() {\n    const folderName = 'Flash Rolls';\n    let folder = game.folders.find(f => f.type === 'Macro' && f.name === folderName);\n    \n    if (!folder) {\n      try {\n        folder = await Folder.create({\n          name: folderName,\n          type: 'Macro',\n          color: '#302437',\n          sort: 0\n        });\n        LogUtil.log('Created Flash Rolls macro folder', [folder]);\n      } catch (error) {\n        LogUtil.error('Failed to create Flash Rolls macro folder:', [error]);\n        ui.notifications.warn('Failed to create Flash Rolls macro folder. Macro will be created without folder organization.');\n        return null;\n      }\n    }\n    \n    return folder?.id || null;\n  }\n  \n  /**\n   * Calculate group roll results using Flash Rolls 5e calculation methods\n   * @param {Object} options - Group roll calculation options\n   * @param {number|string} options.method - Calculation method: 1/\"Standard Rule\", 2/\"Group Average\", 3/\"Leader with Help\", 4/\"Weakest Link\"\n   * @param {Object[]} options.rollResults - Array of roll results with { actorId, total, actorName? }\n   * @param {number} options.dc - Difficulty Class to check against\n   * @param {Object[]} [options.actors] - Array of actor objects (auto-resolved from rollResults actorId if not provided)\n   * @param {string} [options.rollType] - Type of roll (required for methods 3 & 4, e.g., 'skill', 'ability')\n   * @param {string} [options.rollKey] - Specific roll key (required for methods 3 & 4, e.g., 'acr', 'str')\n   * @returns {Object} Calculation result with { success, result, details, method, actorResults }\n   * \n   * @example\n   * // Standard Rule example (accepts method as number or string)\n   * const result = FlashRolls5e.calculateGroupRoll({\n   *   method: \"Standard Rule\", // or method: 1\n   *   rollResults: [\n   *     { actorId: \"ABC\", total: 15 }, // actorName optional - will be looked up\n   *     { actorId: \"DEF\", total: 12, actorName: \"Rogue\" }, // or provided\n   *     { actorId: \"GHI\", total: 8 }\n   *   ],\n   *   dc: 12\n   * });\n   * // Returns: { \n   * //   success: true, \n   * //   result: 1, // 1=success, 0=failure for Standard Rule\n   * //   details: { finalResult: true, successes: 2, failures: 1, summary: \"...\" },\n   * //   method: 'Standard Rule',\n   * //   actorResults: [{ actorId: \"ABC\", actorName: \"Someone\", total: 15, passed: true }, ...]\n   * // }\n   */\n  static calculateGroupRoll(options = {}) {\n    const { rollResults, dc, rollType, rollKey } = options;\n    let { method, actors } = options;\n    \n    // Convert string method names to numbers\n    const methodMap = {\n      \"standard rule\": 1,\n      \"group average\": 2, \n      \"leader with help\": 3,\n      \"weakest link\": 4\n    };\n    \n    if (typeof method === 'string') {\n      const normalizedMethod = method.toLowerCase();\n      method = methodMap[normalizedMethod];\n      if (!method) {\n        ui.notifications.error(`Invalid method name: \"${options.method}\". Valid options: \"Standard Rule\", \"Group Average\", \"Leader with Help\", \"Weakest Link\", or numbers 1-4`);\n        return null;\n      }\n    }\n    \n    // Validate required parameters\n    if (!method || ![1, 2, 3, 4].includes(method)) {\n      ui.notifications.error(\"Method must be 1-4 or valid method name: 'Standard Rule', 'Group Average', 'Leader with Help', 'Weakest Link'\");\n      return null;\n    }\n    \n    if (!Array.isArray(rollResults) || rollResults.length === 0) {\n      ui.notifications.error(\"rollResults must be a non-empty array\");\n      return null;\n    }\n    \n    if (typeof dc !== 'number' || dc < 0) {\n      ui.notifications.error(\"dc must be a positive number\");\n      return null;\n    }\n    \n    // Validate rollResults format and enhance with actor names\n    const enhancedRollResults = [];\n    for (let i = 0; i < rollResults.length; i++) {\n      const roll = rollResults[i];\n      if (!roll.hasOwnProperty('total') || typeof roll.total !== 'number') {\n        ui.notifications.error(`rollResults[${i}] must have a 'total' property with a numeric value`);\n        return null;\n      }\n      if (!roll.actorId) {\n        ui.notifications.error(`rollResults[${i}] must have an 'actorId' property`);\n        return null;\n      }\n      \n      // Get actor name if not provided\n      let actorName = roll.actorName;\n      if (!actorName) {\n        const actorData = getActorData(roll.actorId);\n        actorName = actorData?.name || roll.actorId;\n      }\n      \n      enhancedRollResults.push({\n        ...roll,\n        actorName,\n        passed: roll.total >= dc\n      });\n    }\n    \n    // Methods 3 and 4 require additional parameters\n    if ([3, 4].includes(method)) {\n      if (!rollType) {\n        ui.notifications.error(\"rollType is required for Leader with Help and Weakest Link methods\");\n        return null;\n      }\n      if (!rollKey) {\n        ui.notifications.error(\"rollKey is required for Leader with Help and Weakest Link methods\");\n        return null;\n      }\n      \n      // Auto-resolve actors from rollResults if not provided\n      if (!Array.isArray(actors) || actors.length === 0) {\n        actors = [];\n        for (const roll of enhancedRollResults) {\n          const actor = getActorData(roll.actorId);\n          if (actor) {\n            actors.push(actor);\n          }\n        }\n        \n        if (actors.length === 0) {\n          ui.notifications.error(\"No valid actors could be resolved from the rollResults for Leader with Help and Weakest Link methods\");\n          return null;\n        }\n      }\n    }\n    \n    try {\n      let calculationResult;\n      let methodName;\n      \n      switch (method) {\n        case 1: // Standard Rule\n          calculationResult = RollHelpers.calculateStandardRule(rollResults, dc);\n          methodName = 'Standard Rule';\n          return {\n            success: calculationResult.finalResult,\n            result: calculationResult.finalResult ? 1 : 0, // 1=success, 0=failure\n            details: calculationResult,\n            method: methodName,\n            actorResults: enhancedRollResults\n          };\n          \n        case 2: // Group Average\n          calculationResult = RollHelpers.calculateGroupAverage(rollResults, dc);\n          methodName = 'Group Average';\n          return {\n            success: calculationResult.success,\n            result: calculationResult.finalResult, // Numeric average result\n            details: calculationResult,\n            method: methodName,\n            actorResults: enhancedRollResults\n          };\n          \n        case 3: // Leader with Help\n          calculationResult = RollHelpers.calculateLeaderWithHelp(rollResults, dc, actors, rollType, rollKey);\n          methodName = 'Leader with Help';\n          // Add isLeadRoll property to identify the leader\n          const enhancedResultsWithLeader = enhancedRollResults.map(result => ({\n            ...result,\n            isLeadRoll: result.actorId === calculationResult.leaderActorId\n          }));\n          return {\n            success: calculationResult.success,\n            result: calculationResult.finalResult, // Modified leader result\n            details: calculationResult,\n            method: methodName,\n            actorResults: enhancedResultsWithLeader\n          };\n          \n        case 4: // Weakest Link\n          calculationResult = RollHelpers.calculateWeakestLink(rollResults, dc, actors, rollType, rollKey);\n          methodName = 'Weakest Link';\n          // Add isLeadRoll property to identify the weakest link (the \"lead\" in this context)\n          const enhancedResultsWithWeakest = enhancedRollResults.map(result => ({\n            ...result,\n            isLeadRoll: result.actorId === calculationResult.weakestActorId\n          }));\n          return {\n            success: calculationResult.success,\n            result: calculationResult.finalResult, // Modified weakest result\n            details: calculationResult,\n            method: methodName,\n            actorResults: enhancedResultsWithWeakest\n          };\n          \n        default:\n          ui.notifications.error(`Invalid calculation method: ${method}`);\n          return null;\n      }\n    } catch (error) {\n      LogUtil.error('FlashRollsAPI.calculateGroupRoll - Error:', [error]);\n      ui.notifications.error(`Error calculating group roll: ${error.message}`);\n      return null;\n    }\n  }\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../../constants/General.mjs\";\nimport { HOOKS_CORE } from \"../../../../constants/Hooks.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { FlashRollsAPI } from \"../../../core/FlashRollsAPI.mjs\";\n\n// Check if required D&D5e classes exist\nHooks.once(HOOKS_CORE.READY, () => {\n  if (!dnd5e.applications.dice.DamageRollConfigurationDialog) {\n    LogUtil.warn(\"DamageRollConfigurationDialog not found in dnd5e.applications.dice\");\n  }\n});\n\n/**\n * Mixin that provides GM-specific functionality for roll configuration dialogs\n * @param {Class} Base - The base dialog class to extend\n * @returns {Class} The extended class with GM functionality\n */\nexport function GMRollConfigMixin(Base) {\n  return class extends Base {\n    constructor(config = {}, message = {}, options = {}) {\n      super(config, message, options);\n      \n      this.actors = options.actors || [];\n      this.sendRequest = options.sendRequest ?? options.isRollRequest ?? false;\n      this.showDC = options.showDC || false;\n      this.dcValue = options.dcValue || null;\n      \n      this.rollKey = options.rollKey || config.skill || config.ability || null;\n      this.rollTypeString = options.rollTypeString || null;\n      \n      this.windowTitle = options.window?.title || \"\";\n      this.windowSubtitle = options.window?.subtitle || \"\";\n    }\n    \n    /**\n     * Build a roll configuration from form data.\n     * Handles situational bonuses, ability selection, and DC values.\n     * @param {BasicRollConfiguration} config - Individual roll configuration from the rolls array\n     * @param {FormDataExtended} formData - Data from the dialog form\n     * @param {number} index - Index of this roll in the rolls array\n     * @returns {BasicRollConfiguration} The modified individual roll configuration\n     * @protected\n     * @override\n     */\n    _buildConfig(config, formData, index) {\n      const abilityFromForm = formData?.get(\"ability\");\n      const dcFromForm = formData?.get(\"dc\");\n      \n      const situational = formData?.get(`rolls.${index}.situational`);\n      LogUtil.log('_buildConfig', [situational, formData, config]);\n      if (situational) {\n        if (!config.parts) config.parts = [];\n        config.parts.push(\"@situational\");\n        if (!config.data) config.data = {};\n        config.data.situational = situational;\n      }else if (config.parts) {\n        const idx = config.parts.indexOf(\"@situational\");\n        if (idx !== -1) config.parts.splice(idx, 1);\n      }\n      \n      if (abilityFromForm) {\n        config.ability = abilityFromForm;\n        this.config.ability = abilityFromForm;\n      }\n      \n      const result = super._buildConfig(config, formData, index);\n      \n      if (dcFromForm) {\n        const dcValue = parseInt(dcFromForm);\n        if (!isNaN(dcValue)) {\n          result.options = result.options || {};\n          result.options.target = dcValue;\n        }\n      } else if (this.dcValue !== undefined && this.dcValue !== null) {\n        result.options = result.options || {};\n        result.options.target = this.dcValue;\n      }\n      \n      LogUtil.log(`${this.constructor.name}._buildConfig`, [this.config, formData, result]);\n      return result;\n    }\n    \n    /**\n     * Handle form changes to capture GM-specific fields.\n     * @param {Object} formConfig - The form configuration object\n     * @param {Event} event - The change event\n     * @protected\n     * @override\n     */\n    _onChangeForm(formConfig, event) {\n      LogUtil.log(`_onChangeForm`, [event.target.value]);\n      super._onChangeForm(formConfig, event);\n\n      const sendRequestCheckbox = this.element.querySelector('input[name=\"flash5e-send-request\"]');\n      if (sendRequestCheckbox) {\n        this.sendRequest = sendRequestCheckbox.checked;\n      }\n      \n      const dcInput = this.element.querySelector('input[name=\"dc\"]');\n      if (dcInput && dcInput.value) {\n        this.dcValue = parseInt(dcInput.value) || null;\n      }\n      \n    }\n    \n    /**\n     * Finalize rolls based on the action button clicked.\n     * @param {string} action - The action button that was clicked\n     * @returns {D20Roll[]} Array of finalized rolls ready for execution\n     * @protected\n     * @override\n     */\n    _finalizeRolls(action) {\n      const finalizedRolls = super._finalizeRolls(action);\n      LogUtil.log(`_finalizeRolls #1`, [finalizedRolls, this.sendRequest]);\n      \n      if (this.dcValue !== undefined && this.dcValue !== null) {\n        for (const roll of finalizedRolls) {\n          roll.options.target = this.dcValue;\n        }\n      }\n      \n      this.config.sendRequest = this.sendRequest;\n      this.config.skipRollDialog = this.sendRequest ? this.config.skipRollDialog || false : true;\n      \n      return finalizedRolls;\n    }\n    \n    /**\n     * Handle macro button click to create a macro with current dialog configuration\n     * @param {Event} event - The click event\n     * @protected\n     */\n    async _onCreateMacroClick(event) {\n      event.preventDefault();\n      event.stopPropagation();\n      \n      LogUtil.log('_onCreateMacroClick', [this]);\n      \n      if (!this.rollTypeString) {\n        ui.notifications.error(\"Cannot create macro: roll type not defined\");\n        return;\n      }\n      \n      const formData = new FormDataExtended(this.form);\n      const situational = formData.get('roll.0.situational') || formData.get('rolls.0.situational') || '';\n      const dc = formData.get('dc');\n      const sendRequest = formData.get('flash5e-send-request');\n      const rollMode = formData.get('rollMode') || game.settings.get(\"core\", \"rollMode\");\n      const ability = formData.get('ability'); \n      \n      const actorIds = this.actors?.map(actor => actor.id) || [];\n      const macroData = {\n        requestType: this.rollTypeString,\n        rollKey: this.rollKey,\n        actorIds: actorIds,\n        config: {\n          ...(situational && { situationalBonus: situational }),\n          ...(dc && { dc: parseInt(dc) }),\n          ...(rollMode !== game.settings.get(\"core\", \"rollMode\") && { rollMode }),\n          ...(ability && { ability }), // Include selected ability for skill/tool rolls\n          sendAsRequest: !!sendRequest,\n          skipRollDialog: true, // Always skip roll dialog for macros\n          advantage: false, // added for users to edit if needed\n          disadvantage: false // added for users to edit if needed\n        }\n      };\n      \n      try {\n        await FlashRollsAPI.createMacro(macroData);\n        \n        // Close the dialog after successful macro creation\n        this.close();\n      } catch (error) {\n        LogUtil.error('Failed to create macro:', [error]);\n        ui.notifications.error(`Failed to create macro: ${error.message}`);\n      }\n    }\n    \n    /**\n     * Handle post-render actions for the dialog.\n     * Triggers initial formula rebuild if there's a situational bonus.\n     * @param {ApplicationRenderContext} context - The render context.\n     * @param {HandlebarsRenderOptions} options - Rendering options.\n     * @returns {Promise<void>}\n     * @protected\n     * @override\n     */\n    async _onRender(context, options) {\n      await super._onRender(context, options);\n\n      // Apply flicker prevention if we need to rebuild\n      if (this.config.rolls?.[0]?.data?.situational || this.config.situational) {\n        LogUtil.log(`${this.constructor.name}._onRender`, ['Triggering rebuild for initial situational bonus']);\n\n        // Prevent flicker by keeping opacity during rebuild\n        if (this.element) {\n          this.element.style.transition = 'none';\n          this.element.style.opacity = '1';\n        }\n\n        // Defer rebuild to next frame\n        requestAnimationFrame(() => {\n          this.rebuild();\n\n          // Restore transitions after rebuild\n          if (this.element) {\n            requestAnimationFrame(() => {\n              this.element.style.transition = '';\n            });\n          }\n        });\n      }\n    }\n  };\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID, ROLL_TYPES } from \"../../../../constants/General.mjs\";\nimport { getSettings } from \"../../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\n\n/**\n * GM Roll Configuration Dialog\n * Extends the standard D&D5e roll configuration dialogs to add DC field and send request toggle\n */\nexport class GMRollConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.D20RollConfigurationDialog) {\n  /**\n   * Create a new GM Roll Configuration Dialog.\n   * @param {BasicRollProcessConfiguration} [config={}] - Process configuration containing rolls array of BasicRollConfiguration objects.\n   * @param {BasicRollMessageConfiguration} [message={}] - Message configuration for chat output.\n   * @param {BasicRollConfigurationDialogOptions} [options={}] - Dialog rendering options.\n   * @param {Actor[]} [options.actors] - Array of actors this roll is being made for.\n   * @param {boolean} [options.sendRequest] - Whether to send this as a roll request to players.\n   * @param {boolean} [options.showDC] - Whether to show the DC input field.\n   * @param {string} [options.rollKey] - The specific roll key (e.g., \"str\" for strength save).\n   * @param {typeof BasicRoll} [options.rollType] - The roll class to use (D20Roll, DamageRoll, etc.).\n   * @param {string} [options.rollTypeString] - The roll type as a string for identification.\n   * @param {object} [options.window] - Window configuration options.\n   * @param {string} [options.window.title] - The window title.\n   * @param {string} [options.window.subtitle] - The window subtitle.\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    options.rollType = options.rollType || CONFIG.Dice.D20Roll;\n    super(config, message, options);\n    \n    LogUtil.log('constructor - initializing GM Dialog', [config, message, options]);\n  }\n  \n  /**\n   * Default rendering options for the GM roll configuration dialog.\n   * Extends the parent's default options to add custom CSS classes.\n   * @returns {object} The default options object.\n   * @override\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Get the window title for the dialog.\n   * Uses the window title from options if provided, otherwise falls back to parent implementation.\n   * The parent class constructs the title from options.window.title or uses a default localized string.\n   * @returns {string} The localized window title\n   * @override\n   */\n  get title() {\n    return this.windowTitle || super.title;\n  }\n  \n  /**\n   * Prepare the configuration data for rendering the dialog.\n   * This method is called internally by the parent class during rendering.\n   * Extends parent to add DC and send request options. The parent method prepares\n   * advantage/disadvantage toggles, roll mode selector, and situational bonus field.\n   * @param {BasicRoll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration containing rolls array\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration with rendering options\n   * @param {BasicRollMessageConfiguration} message - Message configuration for chat output\n   * @returns {Object} The prepared configuration data for rendering with added fields:\n   *   - showDC: Whether to display the DC input field\n   *   - dcValue: The current DC value if set\n   *   - sendRequest: Whether rolls should be sent to players\n   *   - actorCount: Number of actors this roll applies to\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('_prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    data.showDC = this.showDC;\n    data.dcValue = this.dcValue;\n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare the rendering context for a specific dialog part.\n   * Adds GM-specific data like DC value and send request option to the configuration part.\n   * The parent method builds the base context for each part (\"configuration\", \"formulas\", \"buttons\").\n   * @param {string} partId - The ID of the part being prepared (\"configuration\", \"formulas\", \"buttons\")\n   * @param {ApplicationRenderContext} context - The rendering context to modify\n   * @param {HandlebarsRenderOptions} options - Options which configure application rendering behavior\n   * @returns {Promise<ApplicationRenderContext>} The modified context with GM-specific data added to configuration part:\n   *   - showDC: Whether to display the DC input field\n   *   - dcValue: The current DC value if set\n   *   - sendRequest: Whether rolls should be sent to players\n   *   - actorCount: Number of actors this roll applies to\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    LogUtil.log('_preparePartContext', [partId, context, options]);\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.showDC = this.showDC;\n      context.dcValue = this.dcValue;\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render actions for the dialog.\n   * Injects custom GM fields (DC input, send request checkbox) into the dialog after rendering.\n   * Also attaches event listeners and triggers initial formula rebuild if needed.\n   * @param {ApplicationRenderContext} context - The render context.\n   * @param {HandlebarsRenderOptions} options - Rendering options.\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    LogUtil.log('_onRender', [context, options]);\n    super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n    \n    if (configSection && (this.showDC || this.actors.length > 0)) {\n      const templateData = {\n        showDC: this.showDC,\n        dcValue: this.dcValue,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest,\n        showMacroButton: true\n      };\n      \n      // toggle and dc template\n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n\n    this._attachButtonListeners();\n  }\n  \n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', []);\n    \n    const macroButton = this.element.querySelector('.flash5e-macro-button');\n    if (macroButton) {\n      macroButton.addEventListener('click', this._onCreateMacroClick.bind(this));\n    }\n\n    // const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    // buttons.forEach(button => {\n    //   button.addEventListener('click', (event) => {\n    //     const action = event.currentTarget.dataset.action;\n    //   });\n    // });\n  }\n  \n  \n  /**\n   * Static method to create and display the GM roll configuration dialog.\n   * Creates a BasicRollProcessConfiguration and shows dialog for user configuration.\n   * @param {Actor[]|string[]} actors - Array of Actor documents or actor IDs to roll for\n   * @param {string} rollType - The type of roll (e.g., \"save\", \"ability\", \"skill\", \"tool\")\n   * @param {string} rollKey - The specific roll key (e.g., \"str\" for strength, \"athletics\" for skill)\n   * @param {Object} options - Additional options for dialog configuration\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {number} [options.dcValue] - Initial DC value\n   * @param {boolean} [options.advantage] - Whether to roll with advantage\n   * @param {boolean} [options.disadvantage] - Whether to roll with disadvantage\n   * @param {string} [options.rollMode] - Roll visibility mode\n   * @param {string} [options.situational] - Situational bonus formula\n   * @returns {Promise<BasicRollProcessConfiguration|null>} Process configuration with rolls array, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}) {\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMRollConfigDialog, initConfiguration', []);\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn);\n    \n    const showDC = RollHelpers.shouldShowDC(normalizedRollType);\n    const rollClass = RollHelpers.getRollClass(normalizedRollType);\n    const rollConfig = RollHelpers.createBaseRollConfig(actor, rollType, rollKey);\n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        showDC,\n        rollKey,\n        rollType: rollClass,  // Set the roll type class here\n        rollTypeString: normalizedRollType,  // Store the roll type string\n        window: {\n          title: GMRollConfigDialog._getRollTitle(normalizedRollType, rollKey, actor),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        position: {\n          width: 420,\n          height: \"auto\"\n        },\n        ...options\n      }\n    };\n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    \n    const rollProcessConfig = RollHelpers.processDialogResult(result, actors, rollType, rollKey, options);\n    if (!rollProcessConfig) return null;\n    \n    if (result.config?.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      const defaultAbility = actor.system.skills?.[rollKey]?.ability || CONFIG.DND5E.skills?.[rollKey]?.ability;\n      if (result.config.ability !== defaultAbility) {\n        rollProcessConfig.ability = result.config.ability;\n      }\n    }\n    \n    let finalTitle = dialogConfig.options.window.title;\n    if (result.config.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      const selectedAbilityLabel = CONFIG.DND5E.abilities[result.config.ability]?.label || result.config.ability;\n      if (normalizedRollType === ROLL_TYPES.SKILL) {\n        const skillLabel = CONFIG.DND5E.skills[rollKey]?.label || rollKey;\n        finalTitle = game.i18n.format(\"DND5E.SkillPromptTitle\", { \n          skill: skillLabel,\n          ability: selectedAbilityLabel \n        });\n      } else if (normalizedRollType === ROLL_TYPES.TOOL) {\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        let toolLabel = rollKey;\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          toolLabel = toolItem?.name || rollKey;\n        }\n        finalTitle = game.i18n.format(\"DND5E.ToolPromptTitle\", { \n          tool: toolLabel,\n          ability: selectedAbilityLabel \n        });\n      }\n    }\n    \n    rollProcessConfig.rollTitle = finalTitle;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    return rollProcessConfig;\n  }\n  \n  /**\n   * Get a formatted title for the roll type\n   * @private\n   * @param {string} rollType - The type of roll\n   * @param {string} rollKey - The specific roll key\n   * @param {Actor} actor - The actor (used to get default ability for skills)\n   * @returns {string} The formatted title\n   */\n  static _getRollTitle(rollType, rollKey, actor) {\n    let title = \"\";\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    if ([ROLL_TYPES.SAVE, ROLL_TYPES.ABILITY, ROLL_TYPES.ABILITY_CHECK].includes(normalizedRollType) && !rollKey) {\n      LogUtil.warn('Missing rollKey for roll type', [normalizedRollType, rollKey]);\n    }\n    \n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        const skillLabel = CONFIG.DND5E.skills[rollKey]?.label || rollKey;\n        const skill = actor?.system.skills?.[rollKey];\n        const defaultAbility = skill?.ability || CONFIG.DND5E.skills[rollKey]?.ability || 'int';\n        const abilityLabel = CONFIG.DND5E.abilities[defaultAbility]?.label || defaultAbility;\n        title = game.i18n.format(\"DND5E.SkillPromptTitle\", { \n          skill: skillLabel,\n          ability: abilityLabel \n        });\n        break;\n      case ROLL_TYPES.SAVE:\n      case ROLL_TYPES.SAVING_THROW:\n        const saveAbility = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        title = game.i18n.format(\"DND5E.SavePromptTitle\", { ability: saveAbility });\n        break;\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.ABILITY_CHECK:\n        const checkAbility = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        title = game.i18n.format(\"DND5E.AbilityPromptTitle\", { ability: checkAbility });\n        break;\n      case ROLL_TYPES.CONCENTRATION:\n        title = game.i18n.localize(\"DND5E.Concentration\");\n        break;\n      case ROLL_TYPES.TOOL:\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        let toolLabel = rollKey;\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          toolLabel = toolItem?.name || rollKey;\n        }\n        const tool = actor?.system.tools?.[rollKey];\n        const toolDefaultAbility = tool?.ability || CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey]?.ability || 'int';\n        const toolAbilityLabel = CONFIG.DND5E.abilities[toolDefaultAbility]?.label || toolDefaultAbility;\n        title = game.i18n.format(\"DND5E.ToolPromptTitle\", { \n          tool: toolLabel,\n          ability: toolAbilityLabel\n        });\n        break;\n      case ROLL_TYPES.DEATH_SAVE:\n        title = game.i18n.localize(\"DND5E.DeathSave\");\n        break;\n      case ROLL_TYPES.INITIATIVE: \n      case ROLL_TYPES.INITIATIVE_DIALOG: // Handle alternate case\n        title = game.i18n.localize(\"DND5E.Initiative\");\n        break;\n      default:\n        title = game.i18n.localize(\"DND5E.Roll\");\n    }\n    LogUtil.log('_getRollTitle', [normalizedRollType, title]);\n    \n    return title;\n  }\n\n  static _getSubtitle(actors = []) {\n    if (actors.length === 1) {\n      return actors[0].name;\n    } else if (actors.length > 1) {\n      return game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.multipleActors\");\n    } else {\n      return \"\";\n    }\n  }\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../../constants/General.mjs\";\nimport { getSettings } from \"../../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\n\n/**\n * GM Hit Die Configuration Dialog\n * Extends base RollConfigurationDialog for hit die rolls\n * @extends {dnd5e.applications.dice.RollConfigurationDialog}\n */\nexport class GMHitDieConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.RollConfigurationDialog) {\n  /**\n   * Creates an instance of GMHitDieConfigDialog.\n   * Configures the dialog for hit die rolls with GM-specific options.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration\n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    options.rollType = CONFIG.Dice.BasicRoll || Roll;\n    options.showDC = false;\n    \n    super(config, message, options);\n    \n    LogUtil.log('constructor', [config, message, options]);\n  }\n  \n  /**\n   * Get default options for the hit die dialog.\n   * Extends parent options to add hit die specific CSS classes.\n   * @returns {Object} Default dialog options with \"hit-die-config\" class added\n   * @static\n   * @override\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\", \"hit-die-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * Overrides the formula display to show \"Hit Die (varies by actor)\" since\n   * different actors may have different hit die sizes.\n   * @param {BasicRoll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with custom formula display\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    LogUtil.log('GMHitDieConfigDialog._prepareConfigurationData', [data]);\n    \n    data.formula = \"Hit Die (varies by actor)\";\n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare context for rendering specific dialog parts.\n   * Adds send request toggle and actor count to the configuration part.\n   * @param {string} partId - The part ID being rendered\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<ApplicationRenderContext>} Modified context\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n      context.formula = \"Hit Die (varies by actor)\";\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render tasks for the dialog.\n   * Injects the send request toggle field for GM control.\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n    \n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n    \n    if (configSection && this.actors.length > 0) {\n      const templateData = {\n        showDC: false,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest,\n        showMacroButton: true\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n\n    this._attachButtonListeners();\n  }\n  \n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', []);\n    \n    const macroButton = this.element.querySelector('.flash5e-macro-button');\n    if (macroButton) {\n      macroButton.addEventListener('click', this._onCreateMacroClick.bind(this));\n    }\n\n    // const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    // buttons.forEach(button => {\n    //   button.addEventListener('click', (event) => {\n    //     const action = event.currentTarget.dataset.action;\n    //   });\n    // });\n  }\n  /**\n   * Process form submission data.\n   * Extracts and stores send request preference from the form.\n   * @param {SubmitEvent} event - The submission event\n   * @param {HTMLFormElement} form - The form element\n   * @param {FormDataExtended} formData - Processed form data\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _processSubmitData(event, form, formData) {\n    await super._processSubmitData(event, form, formData);\n    this.sendRequest = formData.get(\"flash5e-send-request\") !== \"false\";\n    \n    LogUtil.log('_processSubmitData', [formData, this.config]);\n  }\n  \n  /**\n   * Finalize rolls based on the action button clicked.\n   * Stores the send request flag in the configuration.\n   * For hit die rolls, merge situational bonuses into the main formula.\n   * @param {string} action - The action button clicked\n   * @returns {BasicRoll[]} Array of finalized rolls\n   * @protected\n   * @override\n   */\n  _finalizeRolls(action) {\n    const finalizedRolls = super._finalizeRolls(action);\n    this.config.sendRequest = this.sendRequest;\n\n    return finalizedRolls;\n  }\n  \n  /**\n   * Static method to create and display the hit die configuration dialog.\n   * Creates appropriate hit die formulas based on each actor's available hit dice.\n   * @param {Actor[]} actors - Array of actors to roll hit dice for\n   * @param {string} rollType - The roll type (should be \"hitdie\")\n   * @param {string} rollKey - Not used for hit die rolls\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @returns {Promise<Object|null>} Configuration with rolls array and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}) {\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMHitDieConfigDialog, initConfiguration', []);\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn);\n    \n    const rollConfig = {\n      data: actor.getRollData(),\n      subject: actor,\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {\n          flavor: \"Hit Die Roll\"\n        }\n      }]\n    };\n    \n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        rollKey,\n        rollType: CONFIG.Dice.BasicRoll || Roll,\n        window: {\n          title: game.i18n.localize(\"DND5E.HitDice\"),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        position: {\n          width: 420,\n          height: \"auto\"\n        },\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    LogUtil.log('GMHitDieConfigDialog - dialog result', [result.rolls]);\n    \n    const rollProcessConfig = RollHelpers.processDialogResult(result, actors, rollType, rollKey, options);\n    if (!rollProcessConfig) return null;\n    \n    if (result.config?.ability) {\n      rollProcessConfig.ability = result.config.ability;\n    }\n    \n    return rollProcessConfig;\n  }\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID, ROLL_TYPES } from \"../../../../constants/General.mjs\";\nimport { getSettings } from \"../../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\n\n/**\n * GM Skill/Tool Configuration Dialog\n * Extends SkillToolRollConfigurationDialog for ability selection\n * @extends {dnd5e.applications.dice.SkillToolRollConfigurationDialog}\n */\nexport class GMSkillToolConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.SkillToolRollConfigurationDialog) {\n  /**\n   * Creates an instance of GMSkillToolConfigDialog.\n   * Forces ability selection and adds GM-specific options.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration  \n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   *   @param {boolean} [options.showDC=false] - Whether to show DC field\n   *   @param {number} [options.dcValue] - Initial DC value\n   *   @param {string} [options.rollKey] - The skill/tool key being rolled\n   *   @param {string} [options.rollTypeString] - Display name for the roll type\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    const skillConfig = foundry.utils.mergeObject(config, {\n      chooseAbility: true\n    });\n    options.rollType = options.rollType || CONFIG.Dice.D20Roll;\n    super(skillConfig, message, options);\n    \n    LogUtil.log('constructor', [config, message, options]);\n  }\n  \n  /**\n   * @inheritDoc\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * Extends parent to add DC and send request options.\n   * The parent handles ability selection UI for skills and tools.\n   * @param {D20Roll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with GM-specific fields added\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('_prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    // GM-specific data\n    data.showDC = this.showDC;\n    data.dcValue = this.dcValue;\n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare context for rendering specific dialog parts.\n   * Adds GM-specific context data to the configuration part.\n   * @param {string} partId - The part ID being rendered\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<ApplicationRenderContext>} Modified context\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    LogUtil.log('_preparePartContext', [partId, context, options]);\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.showDC = this.showDC;\n      context.dcValue = this.dcValue;\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render tasks for the dialog.\n   * Injects GM-specific form fields (DC and send request toggle).\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    LogUtil.log('_onRender', [context, options]);\n    super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n\n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n\n    if (configSection && (this.showDC || this.actors.length > 0)) {\n      const templateData = {\n        showDC: this.showDC,\n        dcValue: this.dcValue,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest,\n        showMacroButton: true\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n\n    this._attachButtonListeners();\n  }\n  \n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', []);\n    \n    const macroButton = this.element.querySelector('.flash5e-macro-button');\n    if (macroButton) {\n      macroButton.addEventListener('click', this._onCreateMacroClick.bind(this));\n    }\n\n    // const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    // buttons.forEach(button => {\n    //   button.addEventListener('click', (event) => {\n    //     const action = event.currentTarget.dataset.action;\n    //   });\n    // });\n  }\n  \n  /**\n   * Static method to create and display the skill/tool configuration dialog.\n   * Handles ability selection for skills and tools with GM-specific options.\n   * @param {Actor[]} actors - Array of actors to roll for\n   * @param {string} rollType - The roll type (\"skill\" or \"tool\")\n   * @param {string} rollKey - The specific skill/tool key (e.g., \"athletics\", \"thieves\")\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {number} [options.dcValue] - Initial DC value\n   * @param {string} [options.ability] - Override ability selection\n   * @returns {Promise<Object|null>} Configuration with rolls array, ability selection, and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}) {\n    // Validate and normalize actors\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMSkillToolConfigDialog, initConfiguration', []);\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn);\n    \n    const showDC = RollHelpers.shouldShowDC(normalizedRollType);\n    const rollClass = CONFIG.Dice.D20Roll;\n    \n    let defaultAbility = null;\n    if (normalizedRollType === ROLL_TYPES.SKILL) {\n      const skill = actor.system.skills[rollKey];\n      defaultAbility = skill?.ability || CONFIG.DND5E.skills[rollKey]?.ability || 'int';\n    } else if (normalizedRollType === ROLL_TYPES.TOOL) {\n      const tool = actor.system.tools?.[rollKey];\n      defaultAbility = tool?.ability || CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey]?.ability || 'int';\n    }\n    \n    const rollConfig = {\n      data: actor.getRollData(),\n      subject: actor,\n      ability: defaultAbility,\n      chooseAbility: true,\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n    \n    if (normalizedRollType === ROLL_TYPES.SKILL) {\n      rollConfig.skill = rollKey;\n    } else if (normalizedRollType === ROLL_TYPES.TOOL) {\n      rollConfig.tool = rollKey;\n    }\n    \n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        showDC,\n        rollKey,\n        rollType: rollClass,  // Set the roll type class here\n        rollTypeString: normalizedRollType,\n        window: {\n          title: GMRollConfigDialog._getRollTitle(normalizedRollType, rollKey, actor),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        position: {\n          width: 420,\n          height: \"auto\"\n        },\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    \n    const rollProcessConfig = RollHelpers.processDialogResult(result, actors, rollType, rollKey, options);\n    if (!rollProcessConfig) return null;\n    \n    if (result.config?.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      rollProcessConfig.ability = result.config.ability;\n    }\n    \n    rollProcessConfig.rollTitle = dialogConfig.options.window.title;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    return rollProcessConfig;\n  }\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../../constants/General.mjs\";\nimport { getSettings } from \"../../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\nimport { HooksManager } from \"../../../core/HooksManager.mjs\";\n/**\n * GM Damage Roll Configuration Dialog\n * Extends DamageRollConfigurationDialog to add send request toggle\n * @extends {dnd5e.applications.dice.DamageRollConfigurationDialog}\n */\nexport class GMDamageConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.DamageRollConfigurationDialog) {\n  /**\n   * Creates an instance of GMDamageConfigDialog.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration  \n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    // Ensure the dialog is configured to show\n    const dialogConfig = foundry.utils.mergeObject({\n      configure: true\n    }, config);\n    \n    super(dialogConfig, message, options);\n    \n    LogUtil.log('GMDamageConfigDialog.constructor', [dialogConfig, message, options]);\n  }\n  \n  /**\n   * @inheritDoc\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"damage-roll\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * @param {DamageRoll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with GM-specific fields added\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('GMDamageConfigDialog._prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  \n  /**\n   * Handle initial rendering of the dialog.\n   * @param {ApplicationRenderContext} context - The render context.\n   * @param {HandlebarsRenderOptions} options - Rendering options.\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    await super._onRender(context, options);\n    \n    // Prevent dialog flicker\n    GeneralUtil.preventDialogFlicker(this.element);\n\n    // Skip if already rendered\n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n\n    GeneralUtil.preventDialogFlicker(this.element);\n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n    \n    if (configSection && (this.showDC || this.actors.length > 0)) {\n      const templateData = {\n        showDC: false,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest,\n        showMacroButton: false\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n    \n    this._attachButtonListeners();\n  }\n  \n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', []);\n    \n    const macroButton = this.element.querySelector('.flash5e-macro-button');\n    if (macroButton) {\n      macroButton.addEventListener('click', this._onCreateMacroClick.bind(this));\n    }\n\n    // const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    // buttons.forEach(button => {\n    //   button.addEventListener('click', (event) => {\n    //     const action = event.currentTarget.dataset.action;\n    //   });\n    // });\n  }\n\n  /**\n   * Static method to create and display the attack configuration dialog.\n   * SIMPLIFIED VERSION: Matches ability check pattern without attack-specific configs\n   * @param {Actor[]} actors - Array of actors to roll for\n   * @param {string} rollType - The roll type (\"attack\")\n   * @param {string} rollKey - The item ID for the attack\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {Object} originalConfig - The original roll configuration from the intercepted roll\n   * @param {Object} originalDialog - The original dialog configuration from the intercepted roll\n   * @returns {Promise<Object|null>} Configuration with rolls array and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}, originalConfig = {}, originalDialog = {}) {\n    actors = RollHelpers.validateActors(actors);\n    LogUtil.log('GMDamageConfigDialog, initConfiguration', [actors, originalConfig, originalDialog]);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    \n    // Check for stored activity configuration in cache\n    const subjectItem = originalConfig.subject?.item;\n    const actorItem = actor.items.get(rollKey);\n    const itemId = actorItem?.id || subjectItem?.id;\n    \n    let storedActivityConfig = {};\n    if (itemId) {\n      // Use the new cache getter with automatic cleanup\n      storedActivityConfig = HooksManager.getActivityConfigFromCache(itemId) || {};\n    }\n\n    LogUtil.log('GMDamageConfigDialog - retrieved activity config from cache', [itemId, storedActivityConfig]);\n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn, originalConfig.rollMode);\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    const rollConfig = {\n      subject: originalConfig.subject || actor, \n      data: actor.getRollData(),\n      critical: originalConfig.critical || {},\n      rolls: originalConfig.rolls || [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n    LogUtil.log('GMDamageConfigDialog, initConfiguration #1', [rollConfig]);\n    \n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    LogUtil.log('GMDamageConfigDialog, initConfiguration #2', [messageConfig]);\n    \n    const { position, ...dialogOptions } = originalDialog?.options || {}; \n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        rollKey,\n        rollType: CONFIG.Dice.DamageRoll,\n        rollTypeString: normalizedRollType,\n        window: {\n          title: game.i18n.localize(\"DND5E.DamageRoll\"),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        ...dialogOptions,\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    \n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    const firstRoll = result.rolls[0];\n    \n    const situational = firstRoll?.data?.situational || \"\";\n    const target = firstRoll?.options?.target;\n    \n    const rollProcessConfig = {\n      rolls: [{\n        parts: [],\n        data: situational ? { situational } : {},\n        options: {\n          ...(target && { target }),\n          isCritical: firstRoll?.options?.isCritical || firstRoll?.isCritical || false\n        }\n      }],\n      subject: originalConfig.subject || actor,\n      target,\n      isCritical: firstRoll?.options?.isCritical || firstRoll?.isCritical || false,\n      sendRequest: result.sendRequest,\n      isRollRequest: result.sendRequest,\n      skipRollDialog: result.sendRequest ? options.skipRollDialog || false : true,\n      chatMessage: true,\n      // Preserve spell slot and scaling information from activity usage\n      spell: storedActivityConfig.spell || originalConfig.spell || {},\n      scaling: storedActivityConfig.scaling !== undefined ? storedActivityConfig.scaling : originalConfig.scaling,\n      consume: storedActivityConfig.consume || originalConfig.consume || {},\n      create: storedActivityConfig.create || originalConfig.create || {}\n    };\n    LogUtil.log('GMDamageConfigDialog, initConfiguration #6', [rollProcessConfig]); \n    // await item?.unsetFlag(MODULE_ID, 'tempActivityConfig');\n    \n    const finalRollMode = RollHelpers.determineRollMode(isPublicRollsOn, result.message?.rollMode);\n    rollProcessConfig.rollMode = finalRollMode;\n    \n    rollProcessConfig.rollTitle = dialogConfig.options.window.title;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    LogUtil.log('GMDamageConfigDialog, initConfiguration - result', [rollProcessConfig]);\n    \n    return rollProcessConfig;\n  }\n}","import { LogUtil } from \"../../../utils/LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../../constants/General.mjs\";\nimport { getSettings } from \"../../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\nimport { HooksManager } from \"../../../core/HooksManager.mjs\";\n\n/**\n * GM Attack Roll Configuration Dialog\n * Extends AttackRollConfigurationDialog to add send request toggle\n * @extends {dnd5e.applications.dice.AttackRollConfigurationDialog}\n */\nexport class GMAttackConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.AttackRollConfigurationDialog) {\n  /**\n   * Creates an instance of GMAttackConfigDialog.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration  \n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    super(config, message, options);\n    \n    LogUtil.log('GMAttackConfigDialog.constructor', [config, message, options]);\n  }\n  \n  /**\n   * @inheritDoc\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * @param {D20Roll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with GM-specific fields added\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('GMAttackConfigDialog._prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare context for rendering specific dialog parts.\n   * @param {string} partId - The part ID being rendered\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<ApplicationRenderContext>} Modified context\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render tasks for the dialog.\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    await super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n    \n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n    \n    if (configSection && this.actors.length > 0) {\n      const templateData = {\n        showDC: false,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest,\n        showMacroButton: false\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n    \n    this._attachButtonListeners();\n  }\n  \n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', []);\n    \n    const macroButton = this.element.querySelector('.flash5e-macro-button');\n    if (macroButton) {\n      macroButton.addEventListener('click', this._onCreateMacroClick.bind(this));\n    }\n\n    // const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    // buttons.forEach(button => {\n    //   button.addEventListener('click', (event) => {\n    //     const action = event.currentTarget.dataset.action;\n    //   });\n    // });\n  }\n  \n  /**\n   * Override _finalizeRolls to prevent re-rendering when sendRequest is toggled off\n   * @param {string} action - The action button clicked\n   * @returns {BasicRoll[]} Array of finalized rolls\n   * @protected\n   * @override\n   */\n  _finalizeRolls(action) {\n    this.config.sendRequest = this.sendRequest;\n    \n    if (!this.sendRequest && this.config.isRollRequest) {\n      this.config.isRollRequest = false;\n    }\n    \n    return super._finalizeRolls(action);\n  }\n  \n  /**\n   * Static method to create and display the attack configuration dialog.\n   * SIMPLIFIED VERSION: Matches ability check pattern without attack-specific configs\n   * @param {Actor[]} actors - Array of actors to roll for\n   * @param {string} rollType - The roll type (\"attack\")\n   * @param {string} rollKey - The item ID for the attack\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {Object} originalConfig - The original roll configuration from the intercepted roll\n   * @param {Object} originalDialog - The original dialog configuration from the intercepted roll\n   * @returns {Promise<Object|null>} Configuration with rolls array and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}, originalConfig = {}, originalDialog = {}) {\n    // Validate and normalize actors\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMAttackConfigDialog, initConfiguration', []);\n    \n    // Check for stored activity configuration in cache\n    const subjectItem = originalConfig.subject?.item;\n    const actorItem = actor.items.get(rollKey);\n    const itemId = actorItem?.id || subjectItem?.id;\n    \n    let storedActivityConfig = {};\n    if (itemId) {\n      // Use the new cache getter with automatic cleanup\n      storedActivityConfig = HooksManager.getActivityConfigFromCache(itemId) || {};\n    }\n\n    LogUtil.log('GMAttackConfigDialog - retrieved activity config from cache', [itemId, storedActivityConfig]);\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    const rollConfig = {\n      subject: originalConfig.subject || actor,\n      data: actor.getRollData(),\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn);\n    \n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    \n    const { position, ...dialogOptions } = originalDialog?.options || {};\n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        rollKey,\n        rollType: CONFIG.Dice.D20Roll,\n        rollTypeString: normalizedRollType,\n        window: {\n          title: game.i18n.localize(\"DND5E.Attack\"),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        ...dialogOptions,\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    LogUtil.log('GMAttackConfigDialog, initConfiguration', [result?.sendRequest]);\n    \n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    const firstRoll = result.rolls[0];\n    let advantage = false;\n    let disadvantage = false;\n    \n    if (firstRoll?.options?.advantageMode !== undefined) {\n      advantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE;\n      disadvantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE;\n    }\n    \n    const situational = firstRoll?.data?.situational || \"\";\n    const target = firstRoll?.options?.target;\n    \n    const rollProcessConfig = {\n      rolls: [{\n        parts: [],\n        data: situational ? { situational } : {},\n        options: {\n          ...(target && { target }),\n          // Include attack-specific options from the roll\n          ...(firstRoll?.options?.ammunition && { ammunition: firstRoll.options.ammunition }),\n          ...(firstRoll?.options?.attackMode && { attackMode: firstRoll.options.attackMode }),\n          ...(firstRoll?.options?.mastery !== undefined && { mastery: firstRoll.options.mastery })\n        }\n      }],\n      subject: originalConfig.subject || actor,\n      advantage,\n      disadvantage,\n      target,\n      sendRequest: result.sendRequest,\n      isRollRequest: result.sendRequest,\n      skipRollDialog: result.sendRequest ? options.skipRollDialog || false : true,\n      chatMessage: !GeneralUtil.isModuleOn('midi-qol') || true,\n      // Preserve spell slot and scaling information from activity usage\n      spell: storedActivityConfig?.spell || originalConfig?.spell || {},\n      scaling: storedActivityConfig?.scaling !== undefined ? storedActivityConfig?.scaling : originalConfig?.scaling,\n      consume: storedActivityConfig?.consume || originalConfig?.consume || {},\n      create: storedActivityConfig?.create || originalConfig?.create || {}\n    };\n    // await item?.unsetFlag(MODULE_ID, 'tempActivityConfig');\n    \n    const finalRollMode = RollHelpers.determineRollMode(isPublicRollsOn, result.message?.rollMode);\n    rollProcessConfig.rollMode = finalRollMode;\n    \n    rollProcessConfig.rollTitle = dialogConfig.options.window.title;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    LogUtil.log('GMAttackConfigDialog, initConfiguration - SIMPLIFIED result', [rollProcessConfig]);\n    \n    return rollProcessConfig;\n  }\n}","import { ROLL_TYPES } from '../../../constants/General.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { LogUtil } from '../../utils/LogUtil.mjs';\nimport { GMRollConfigDialog, GMSkillToolConfigDialog, GMHitDieConfigDialog } from '../../ui/dialogs/gm-dialogs/index.mjs';\nimport { CustomRollDialog } from '../../ui/dialogs/CustomRollDialog.mjs';\nimport { RollHelpers } from '../../helpers/RollHelpers.mjs';\n\n/**\n * Utility class for roll configuration operations in the Roll Requests Menu\n */\nexport class RollMenuConfig {\n  /**\n   * Get roll configuration from dialog or create default\n   * @param {Actor[]} actors - Actors being rolled for\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {boolean} skipRollDialog - Whether to skip dialogs\n   * @param {Array} pcActors - PC actors with owners\n   * @returns {Promise<BasicRollProcessConfiguration|null>} Process configuration or null if cancelled\n   */\n  static async getRollConfiguration(actors, rollMethodName, rollKey, skipRollDialog, pcActors, configOverrides = {}) {\n    const SETTINGS = getSettings();\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const sendAsRequest = configOverrides.hasOwnProperty('sendAsRequest') ? configOverrides.sendAsRequest : undefined;\n    const npcActors = actors.filter(actor => pcActors.includes(actor.id));\n    const confirmedSkipDialog = RollHelpers.shouldSkipRollDialog(skipRollDialog, {isPC: pcActors.length > 0, isNPC: npcActors.length > 0});\n\n    LogUtil.log('RollMenuConfig.getRollConfiguration', [\n      'sendAsRequest:', sendAsRequest,\n      'rollRequestsEnabled:', rollRequestsEnabled,\n      'skipRollDialog:', skipRollDialog,\n      'confirmedSkipDialog:', confirmedSkipDialog,\n      'pcActors.length:', pcActors,\n      'npcActors.length:', npcActors,\n      'actors:', actors\n    ]);\n    \n    // Show GM configuration dialog (unless skip dialogs is enabled or it's a custom roll)\n    if (!confirmedSkipDialog && rollMethodName !== ROLL_TYPES.CUSTOM) {\n      // Use appropriate dialog based on roll type\n      let DialogClass;\n      if ([ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(rollMethodName)) {\n        DialogClass = GMSkillToolConfigDialog;\n      } else if (rollMethodName === ROLL_TYPES.HIT_DIE) {\n        DialogClass = GMHitDieConfigDialog;\n      } else {\n        DialogClass = GMRollConfigDialog;\n      }\n      const config = await DialogClass.initConfiguration(actors, rollMethodName, rollKey, { \n        confirmedSkipDialog,\n        sendRequest: sendAsRequest===true || (sendAsRequest===undefined && rollRequestsEnabled) || false \n      });\n      LogUtil.log('getRollConfiguration', [config]);\n      \n      return config; // Will be null if cancelled\n    } else {\n      // Use default BasicRollProcessConfiguration when skipping dialogs\n      const config = {\n        rolls: [{\n          parts: [],\n          // parts: configOverrides.situationalBonus ? [\"@situational\"] : [],\n          data: configOverrides.situationalBonus ? { situational: configOverrides.situationalBonus } : {},\n          options: configOverrides.dc ? { target: configOverrides.dc } : {}\n        }],\n        advantage: configOverrides.advantage || false,\n        disadvantage: configOverrides.disadvantage || false,\n        rollMode: configOverrides.rollMode || game.settings.get(\"core\", \"rollMode\"),\n        chatMessage: true,\n        isRollRequest: false,\n        skipRollDialog: true,\n        sendRequest: configOverrides.hasOwnProperty('sendAsRequest') ? configOverrides.sendAsRequest : (rollRequestsEnabled && pcActors.length > 0)\n      };\n      \n      // Death saves always have DC 10\n      if (rollMethodName === ROLL_TYPES.DEATH_SAVE) {\n        config.target = 10;\n      }\n      \n      return config;\n    }\n  }\n\n  /**\n   * Handle custom roll dialog\n   * @returns {Promise<string|null>} The roll formula or null if cancelled\n   */\n  static async handleCustomRoll() {\n    const formula = await this.showCustomRollDialog();\n    return formula; // Will be null if cancelled\n  }\n\n  /**\n   * Show custom roll dialog\n   * @returns {Promise<string|null>} The roll formula or null if cancelled\n   */\n  static async showCustomRollDialog() {\n    LogUtil.log('showCustomRollDialog');\n    return CustomRollDialog.prompt({\n      formula: \"\",\n      readonly: false\n    });\n  }\n}","import { MODULE } from '../../../constants/General.mjs';\nimport { LogUtil } from '../../utils/LogUtil.mjs';\nimport { adjustMenuOffset } from '../../helpers/Helpers.mjs';\nimport { GeneralUtil } from '../../utils/GeneralUtil.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\n\n/**\n * Handles drag and positioning of the Roll Requests Menu\n */\nexport class RollMenuDragManager {\n  static SNAP_DISTANCE = 30; // pixels\n  static DRAG_HANDLE_SELECTOR = '.drag-handle';\n  static LIGHTNING_BOLT_SELECTOR = '#flash-rolls-icon';\n  \n  /**\n   * Initialize drag functionality for the menu\n   * @param {RollRequestsMenu} menu - The menu instance\n   * @deprecated Use direct event listener attachment in _onRender instead\n   */\n  static initializeDrag(menu) {\n    const dragHandle = menu.element.querySelector(this.DRAG_HANDLE_SELECTOR);\n    \n    if (!dragHandle) {\n      LogUtil.error('RollMenuDragManager.initializeDrag - No drag handle found!');\n      return;\n    }\n    \n    dragHandle.addEventListener('mousedown', (e) => {\n      this.handleDragStart(e, menu);\n    });\n  }\n  \n  /**\n   * Handle drag start\n   * @param {MouseEvent} event \n   * @param {RollRequestsMenu} menu \n   */\n  static async handleDragStart(event, menu) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    menu.isDragging = true;\n    if(!menu.element){return}\n    menu.element.classList.add('dragging');\n    \n    const startX = event.clientX;\n    const startY = event.clientY;\n    \n    // Check if we're dragging from bottom dock before making any changes\n    const isDockedBottom = menu.element.classList.contains('docked-bottom');\n    const isDraggedFromBottomDock = menu.element.parentElement?.id === 'ui-bottom';\n    \n    // Remove docked classes when starting drag\n    menu.element.classList.remove('docked-right', 'docked-bottom', 'faded-ui');\n    \n    // Force layout recalculation by accessing offsetHeight\n    menu.element.offsetHeight;\n    \n    const menuRect = menu.element.getBoundingClientRect();\n    let initialLeft = menuRect.left;\n    let initialTop = startY;//menuRect.top;\n    \n    // If dragging from bottom dock, adjust position to keep cursor over drag handle\n    if (isDraggedFromBottomDock) {\n      const dragHandle = menu.element.querySelector(this.DRAG_HANDLE_SELECTOR);\n      if (dragHandle) {\n        const handleRect = dragHandle.getBoundingClientRect();\n        const handleCenterOffset = (handleRect.left - menuRect.left) + (handleRect.width / 2);\n        initialLeft = startX - handleCenterOffset;\n      } else {\n        initialLeft = startX - (menuRect.width / 2);\n      }\n      initialTop = startY; //menuRect.top;\n    }\n    \n    const parent = menu.element.parentElement;\n    document.body.appendChild(menu.element);\n    menu.element.style.position = 'fixed';\n    menu.element.style.inset = '';  // Clear inset first\n    menu.element.style.transform = ''; // Clear any transform from docked-bottom\n    menu.element.style.top = `${initialTop}px`;\n    menu.element.style.left = `${initialLeft}px`;\n    menu.element.style.right = 'auto';\n    menu.element.style.bottom = 'auto';\n    menu.element.style.zIndex = 'var(--z-index-app)'; // Ensure it's on top while dragging\n    \n    menu.element.offsetHeight;\n    \n    const dragData = {\n      startX,\n      startY,\n      initialLeft,\n      initialTop,\n      currentLeft: initialLeft,\n      currentTop: initialTop\n    };\n    \n    const handleMove = (e) => this.handleDragMove(e, menu, dragData);\n    const handleUp = (e) => this.handleDragEnd(e, menu, dragData, handleMove, handleUp);\n    \n    document.addEventListener('mousemove', handleMove);\n    document.addEventListener('mouseup', handleUp);\n  }\n  \n  /**\n   * Handle drag move\n   * @param {MouseEvent} event \n   * @param {RollRequestsMenu} menu \n   * @param {Object} dragData \n   */\n  static handleDragMove(event, menu, dragData) {\n    if (!menu.isDragging || !menu.element) return;\n    const deltaX = event.clientX - dragData.startX;\n    const deltaY = event.clientY - dragData.startY;\n    \n    dragData.currentLeft = dragData.initialLeft + deltaX;\n    dragData.currentTop = dragData.initialTop + deltaY;\n    \n    menu.element.style.inset = '';\n    menu.element.style.right = 'auto';\n    menu.element.style.bottom = 'auto';\n    \n    menu.element.style.position = 'fixed';\n    menu.element.style.top = `${dragData.currentTop}px`;\n    menu.element.style.left = `${dragData.currentLeft}px`;\n    \n    const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize) * 15;\n    if (dragData.currentLeft < remInPixels) {\n      menu.element.classList.add('left-edge');\n    } else {\n      menu.element.classList.remove('left-edge');\n    }\n    \n    // Handle top-edge for horizontal layout\n    const isHorizontalLayout = menu.element.hasAttribute('data-layout') && \n                              menu.element.getAttribute('data-layout') === 'horizontal';\n    if (isHorizontalLayout) {\n      if (dragData.currentTop < 400) {\n        menu.element.classList.add('top-edge');\n      } else {\n        menu.element.classList.remove('top-edge');\n      }\n    } else {\n      // Remove top-edge class if not in horizontal layout\n      menu.element.classList.remove('top-edge');\n    }\n    \n    const computed = window.getComputedStyle(menu.element);\n\n    const snapInfo = this.calculateSnapDistance(menu);\n    \n    // Only update classes if the snap type has changed\n    const currentSnapType = menu.element.classList.contains('near-snap-both') ? 'both-edges' :\n                           menu.element.classList.contains('near-snap-right') ? 'right-edge' :\n                           menu.element.classList.contains('near-snap-bottom') ? 'bottom-edge' : 'none';\n    \n    if (currentSnapType !== snapInfo.type) {\n      // Remove all near-snap classes first\n      menu.element.classList.remove('near-snap', 'near-snap-right', 'near-snap-bottom', 'near-snap-both');\n      \n      // Add specific near-snap class based on snap type\n      if (snapInfo.type === 'both-edges') {\n        menu.element.classList.add('near-snap', 'near-snap-both');\n      } else if (snapInfo.type === 'right-edge') {\n        menu.element.classList.add('near-snap', 'near-snap-right');\n      } else if (snapInfo.type === 'bottom-edge') {\n        menu.element.classList.add('near-snap', 'near-snap-bottom');\n      }\n    }\n  }\n  \n  /**\n   * Handle drag end\n   * @param {MouseEvent} event \n   * @param {RollRequestsMenu} menu \n   * @param {Object} dragData \n   * @param {Function} moveHandler \n   * @param {Function} upHandler \n   */\n  static async handleDragEnd(event, menu, dragData, moveHandler, upHandler) {\n    LogUtil.log('RollMenuDragManager.handleDragEnd');\n    \n    document.removeEventListener('mousemove', moveHandler);\n    document.removeEventListener('mouseup', upHandler);\n    \n    menu.isDragging = false;\n    menu.element.classList.remove('dragging');\n    menu.element.classList.remove('near-snap', 'near-snap-right', 'near-snap-bottom', 'near-snap-both');\n    \n    menu.element.style.zIndex = '';\n    \n    const snapInfo = this.calculateSnapDistance(menu);\n    \n    if (snapInfo.type === 'both-edges') {\n      const chatNotifications = document.querySelector('#chat-notifications');\n      if (chatNotifications) {\n        chatNotifications.insertBefore(menu.element, chatNotifications.firstChild);\n      }\n      await this.snapToDefault(menu);\n    } else if (snapInfo.type === 'bottom-edge') {\n      await this.snapToBottomEdge(menu);\n    } else if (snapInfo.type === 'right-edge') {\n      const chatNotifications = document.querySelector('#chat-notifications');\n      if (chatNotifications) {\n        chatNotifications.insertBefore(menu.element, chatNotifications.firstChild);\n      }\n      await this.snapToRightEdge(menu, dragData.currentTop);\n    } else {\n      menu.isCustomPosition = true;\n      menu.customPosition = {\n        x: dragData.currentLeft,\n        y: dragData.currentTop,\n        isCustom: true,\n        dockedRight: false,\n        dockedBottom: false\n      };\n      const isCrlngnUIOn = document.querySelector('body.crlngn-tabs') ? true : false;\n      GeneralUtil.addCSSVars('--flash-rolls-menu-offset', isCrlngnUIOn ? '0px' : '16px');\n      \n      await this.saveCustomPosition(menu.customPosition);\n      menu.element.classList.add('custom-position');\n      \n      const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize) * 15;\n      if (dragData.currentLeft < remInPixels) {\n        menu.element.classList.add('left-edge');\n      }\n      \n      // Handle top-edge for horizontal layout\n      const isHorizontalLayout = menu.element.hasAttribute('data-layout') && \n                                menu.element.getAttribute('data-layout') === 'horizontal';\n      if (isHorizontalLayout && dragData.currentTop < 400) {\n        menu.element.classList.add('top-edge');\n      }\n    }\n  }\n  \n  /**\n   * Check if menu should snap and determine snap type\n   * @param {RollRequestsMenu} menu \n   * @returns {{type: string, distance: number}} Snap information\n   */\n  static calculateSnapDistance(menu) {\n    const lightningBolt = document.querySelector(this.LIGHTNING_BOLT_SELECTOR);\n    const hotbar = document.querySelector('#hotbar');\n    \n    if (!lightningBolt && !hotbar) return { type: 'none', distance: Infinity };\n    \n    const menuRect = menu.element.getBoundingClientRect();\n    \n    // Check for bottom dock (priority over right dock)\n    if (hotbar) {\n      const hotbarRect = hotbar.getBoundingClientRect();\n      const bottomDistance = Math.abs(hotbarRect.top - menuRect.bottom);\n      const menuLeft = menuRect.left;\n      const menuRight = menuRect.right;\n      const hotbarLeft = hotbarRect.left;\n      const hotbarRight = hotbarRect.right;\n      \n      // Check if menu overlaps horizontally with hotbar and is within snap distance vertically\n      const horizontalOverlap = (menuLeft < hotbarRight && menuRight > hotbarLeft);\n      \n      if (horizontalOverlap && bottomDistance <= this.SNAP_DISTANCE) {\n        return { type: 'bottom-edge', distance: 0 };\n      }\n    }\n    \n    // Check for right dock (existing logic)\n    if (lightningBolt) {\n      const boltRect = lightningBolt.getBoundingClientRect();\n      const horizontalDistance = Math.abs(boltRect.left - menuRect.right);\n      const verticalDistance = window.innerHeight - menuRect.bottom;\n      \n      if (horizontalDistance <= this.SNAP_DISTANCE) {\n        if (verticalDistance <= this.SNAP_DISTANCE) {\n          return { type: 'both-edges', distance: 0 };\n        }\n        return { type: 'right-edge', distance: 0 };\n      }\n    }\n    \n    return { type: 'none', distance: Infinity };\n  }\n  \n  /**\n   * Snap menu to right edge with custom vertical position\n   * @param {RollRequestsMenu} menu \n   * @param {number} currentTop - The vertical position to maintain\n   */\n  static async snapToRightEdge(menu, currentTop) {\n    LogUtil.log('RollMenuDragManager.snapToRightEdge', [currentTop]);\n    \n    menu.isCustomPosition = true;\n    menu.customPosition = {\n      y: currentTop,\n      isCustom: true,\n      dockedRight: true\n    };\n    \n    menu.element.classList.remove('custom-position', 'left-edge', 'top-edge', 'docked-bottom', 'faded-ui', 'offset');\n    menu.element.classList.add('docked-right', 'snapping');\n    \n    // Handle top-edge for horizontal layout in docked position\n    const isHorizontalLayout = menu.element.hasAttribute('data-layout') && \n                              menu.element.getAttribute('data-layout') === 'horizontal';\n    if (isHorizontalLayout && currentTop < 400) {\n      menu.element.classList.add('top-edge');\n    } else {\n      menu.element.classList.remove('top-edge');\n    }\n    \n    menu.element.style.position = 'fixed';\n    menu.element.style.inset = '';\n    menu.element.style.left = '';\n    menu.element.style.right = '';\n    menu.element.style.bottom = '';\n    menu.element.style.top = `${currentTop}px`;\n    menu.element.style.zIndex = '';\n    \n    adjustMenuOffset();\n    \n    await this.saveCustomPosition(menu.customPosition);\n    \n    setTimeout(() => {\n      menu.element.classList.remove('snapping');\n    }, 300);\n  }\n  \n  /**\n   * Snap menu to bottom edge (docked to hotbar)\n   * @param {RollRequestsMenu} menu \n   */\n  static async snapToBottomEdge(menu) {\n    LogUtil.log('RollMenuDragManager.snapToBottomEdge');\n    \n    menu.isCustomPosition = true;\n    menu.customPosition = {\n      isCustom: true,\n      dockedBottom: true\n    };\n    \n    menu.element.classList.remove('custom-position', 'left-edge', 'top-edge', 'docked-right', 'offset');\n    menu.element.classList.add('docked-bottom', 'snapping');\n    \n    // Move to #ui-bottom container\n    const uiBottom = document.querySelector('#ui-bottom');\n    if (uiBottom && !uiBottom.contains(menu.element)) {\n      uiBottom.prepend(menu.element);\n    }\n    \n    // Check if hotbar has faded-ui class and apply to menu\n    const hotbar = document.querySelector('#ui-bottom #hotbar');\n    if (hotbar && hotbar.classList.contains('faded-ui')) {\n      menu.element.classList.add('faded-ui');\n    }\n    \n    // Check if hotbar has offset class and apply to menu\n    this.syncOffsetClass(menu);\n    \n    adjustMenuOffset();\n    \n    await this.saveCustomPosition(menu.customPosition);\n    \n    setTimeout(() => {\n      menu.element.classList.remove('snapping');\n    }, 300);\n  }\n  \n  /**\n   * Synchronize offset class from hotbar to menu when docked to bottom\n   * @param {RollRequestsMenu} menu \n   */\n  static syncOffsetClass(menu) {\n    const hotbar = document.querySelector('#hotbar');\n    if (hotbar && hotbar.classList.contains('offset')) {\n      menu.element.classList.add('offset');\n      // Also copy the --offset CSS variable if it exists\n      const offsetValue = hotbar.style.getPropertyValue('--offset');\n      if (offsetValue) {\n        menu.element.style.setProperty('--offset', offsetValue);\n      }\n    } else {\n      menu.element.classList.remove('offset');\n      menu.element.style.removeProperty('--offset');\n    }\n  }\n\n  /**\n   * Synchronize faded-ui class from hotbar to menu when docked to bottom\n   * @param {RollRequestsMenu|Object} menu - Menu instance or proxy object with element property\n   */\n  static syncFadedUIClass(menu) {\n    // Only sync if menu is docked to bottom\n    if (!menu.element.classList.contains('docked-bottom')) {\n      // If not docked to bottom, ensure faded-ui is removed\n      menu.element.classList.remove('faded-ui');\n      return;\n    }\n\n    const hotbar = document.querySelector('#ui-bottom #hotbar');\n    if (hotbar && hotbar.classList.contains('faded-ui')) {\n      menu.element.classList.add('faded-ui');\n    } else {\n      menu.element.classList.remove('faded-ui');\n    }\n  }\n\n  /**\n   * Snap menu back to default position\n   * @param {RollRequestsMenu} menu \n   */\n  static async snapToDefault(menu) {\n    LogUtil.log('RollMenuDragManager.snapToDefault');\n    \n    menu.isCustomPosition = false;\n    menu.customPosition = null;\n    \n    const SETTINGS = getSettings();\n    const originalLayout = SettingsUtil.get(SETTINGS.menuLayout.tag);\n    \n    menu.element.classList.remove('custom-position', 'left-edge', 'top-edge', 'docked-bottom', 'docked-right', 'faded-ui', 'offset');\n    menu.element.classList.add('snapping');\n    \n    menu.element.style.position = '';\n    menu.element.style.inset = '';\n    menu.element.style.left = '';\n    menu.element.style.top = '';\n    menu.element.style.right = '';\n    menu.element.style.bottom = '';\n    menu.element.style.zIndex = '';\n    menu.element.style.removeProperty('--offset');  \n    \n    adjustMenuOffset();\n    \n    await this.saveCustomPosition(null);\n    \n    setTimeout(() => {\n      menu.element.classList.remove('snapping');\n    }, 300);\n  }\n  \n  /**\n   * Apply custom position to menu\n   * @param {RollRequestsMenu} menu \n   * @param {Object} position \n   */\n  static applyCustomPosition(menu, position) {\n    if (!position || !position.isCustom) return;\n\n    const menuSize = menu.element.getBoundingClientRect();\n    \n    LogUtil.log('RollMenuDragManager.applyCustomPosition', [position]);\n    if(position.x < 0){\n      position.x = 0;\n    }else if (position.x > window.innerWidth - menuSize.width){\n      position.x = window.innerWidth - menuSize.width;\n    }\n    \n    if(position.y < 0){\n      position.y = 0;\n    }else if (position.y > window.innerHeight - menuSize.height){\n      position.y = window.innerHeight - menuSize.height;\n    }\n    \n    menu.isCustomPosition = true;\n    menu.customPosition = position;\n    \n    if (position.dockedRight) {\n      const chatNotifications = document.querySelector('#chat-notifications');\n      if (chatNotifications) {\n        chatNotifications.insertBefore(menu.element, chatNotifications.firstChild);\n      }\n      \n      menu.element.style.position = 'fixed';\n      menu.element.style.inset = '';\n      menu.element.style.top = `${position.y}px`;\n      menu.element.style.left = '';\n      menu.element.style.right = '';\n      menu.element.style.bottom = '';\n      \n      menu.element.classList.add('docked-right');\n      menu.element.classList.remove('custom-position', 'left-edge', 'faded-ui', 'offset');\n      \n      // Handle top-edge for horizontal layout in docked position\n      const isHorizontalLayout = menu.element.hasAttribute('data-layout') && \n                                menu.element.getAttribute('data-layout') === 'horizontal';\n      if (isHorizontalLayout && position.y < 400) {\n        menu.element.classList.add('top-edge');\n      } else {\n        menu.element.classList.remove('top-edge');\n      }\n      \n      adjustMenuOffset();\n    } else if (position.dockedBottom) {\n      // Move to hotbar container\n      const uiBottom = document.querySelector('#ui-bottom');\n      if (uiBottom && !uiBottom.contains(menu.element)) {\n        uiBottom.prepend(menu.element);\n      }\n      \n      menu.element.classList.add('docked-bottom');\n      menu.element.classList.remove('custom-position', 'left-edge', 'top-edge', 'docked-right', 'faded-ui', 'offset');\n      \n      // Check if hotbar has faded-ui class and apply to menu\n      const hotbar = document.querySelector('#ui-bottom #hotbar');\n      if (hotbar && hotbar.classList.contains('faded-ui')) {\n        menu.element.classList.add('faded-ui');\n      }\n      \n      // Check if hotbar has offset class and apply to menu\n      this.syncOffsetClass(menu);\n      \n      adjustMenuOffset();\n    } else {\n      document.body.appendChild(menu.element);\n      \n      menu.element.style.position = 'fixed';\n      menu.element.style.inset = '';\n      menu.element.style.top = `${position.y}px`;\n      menu.element.style.left = `${position.x}px`;\n      menu.element.style.right = 'auto';\n      menu.element.style.bottom = 'auto';\n      \n      const isCrlngnUIOn = document.querySelector('body.crlngn-tabs') ? true : false;\n      GeneralUtil.addCSSVars('--flash-rolls-menu-offset', isCrlngnUIOn ? '0px' : '16px');\n      \n      menu.element.classList.add('custom-position');\n      menu.element.classList.remove('docked-right', 'faded-ui', 'offset');\n      \n      const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize) * 15;\n      if (position.x < remInPixels) {\n        menu.element.classList.add('left-edge');\n      }\n      \n      // Handle top-edge for horizontal layout\n      const isHorizontalLayout = menu.element.hasAttribute('data-layout') && \n                                menu.element.getAttribute('data-layout') === 'horizontal';\n      if (isHorizontalLayout && position.y < 400) {\n        menu.element.classList.add('top-edge');\n      }\n    }\n  }\n  \n  /**\n   * Save custom position to user flag\n   * @param {Object|null} position \n   */\n  static async saveCustomPosition(position) {\n    if (!position) {\n      await game.user.setFlag(MODULE.ID, 'menuCustomPosition', null);\n      return;\n    }\n\n    const menu = document.querySelector('.flash-rolls-menu');\n    if (menu) {\n      const menuSize = menu.getBoundingClientRect();\n\n      if(position.x < 0){\n        position.x = 0;\n      }else if (position.x > window.innerWidth - menuSize.width){\n        position.x = window.innerWidth - menuSize.width;\n      }\n      \n      if(position.y < 0){\n        position.y = 0;\n      }else if (position.y > window.innerHeight - menuSize.height){\n        position.y = window.innerHeight - menuSize.height;\n      }\n    }\n    \n    await game.user.setFlag(MODULE.ID, 'menuCustomPosition', position);\n  }\n  \n  /**\n   * Load custom position from user flag\n   * @returns {Object|null} Position object or null\n   */\n  static loadCustomPosition() {\n    return game.user.getFlag(MODULE.ID, 'menuCustomPosition') || null;\n  }\n  \n  /**\n   * Reset menu to default position\n   * @param {RollRequestsMenu} menu \n   */\n  static async resetPosition(menu) {\n    await this.snapToDefault(menu);\n  }\n}","import { MODULE_ID } from '../../constants/General.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport RollRequestsMenu from '../ui/RollRequestsMenu.mjs';\n\n/**\n * Utility class for managing actor status (favorites, blocked) using actor flags\n */\nexport class ActorStatusManager {\n  /**\n   * Actor status flag keys\n   */\n  static FLAGS = {\n    FAVORITE: 'isFavorite',\n    BLOCKED: 'isBlocked'\n  };\n\n  /**\n   * Check if an actor is favorited\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {boolean} Whether the actor is favorited\n   */\n  static isFavorite(actor) {\n    try {\n      const actorDoc = typeof actor === 'string' ? game.actors.get(actor) : actor;\n      if (!actorDoc || !actorDoc.getFlag) return false;\n      return actorDoc.getFlag(MODULE_ID, this.FLAGS.FAVORITE) === true;\n    } catch (error) {\n      LogUtil.error('Error checking favorite status', [error, actor]);\n      return false;\n    }\n  }\n\n  /**\n   * Check if an actor is blocked\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {boolean} Whether the actor is blocked\n   */\n  static isBlocked(actor) {\n    const actorDoc = typeof actor === 'string' ? game.actors.get(actor) : actor;\n    if (!actorDoc) return false;\n    return actorDoc.getFlag(MODULE_ID, this.FLAGS.BLOCKED) === true;\n  }\n\n  /**\n   * Set favorite status for an actor\n   * @param {Actor|string} actor - The actor or actor ID\n   * @param {boolean} isFavorite - Whether to favorite the actor\n   * @returns {Promise<void>}\n   */\n  static async setFavorite(actor, isFavorite) {\n    const actorDoc = typeof actor === 'string' ? game.actors.get(actor) : actor;\n    if (!actorDoc) {\n      LogUtil.error('Actor not found', [actor]);\n      return;\n    }\n\n    LogUtil.log('ActorStatusManager.setFavorite', [actorDoc.name, isFavorite]);\n\n    if (isFavorite) {\n      // If favoriting, remove blocked status\n      await actorDoc.setFlag(MODULE_ID, this.FLAGS.FAVORITE, true);\n      await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.BLOCKED);\n      \n      // ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.actorAddedToFavorites\", {\n      //   actor: actorDoc.name\n      // }) || `${actorDoc.name} added to Flash Rolls favorites`);\n    } else {\n      await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.FAVORITE);\n      \n      // ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.actorRemovedFromFavorites\", {\n      //   actor: actorDoc.name\n      // }) || `${actorDoc.name} removed from Flash Rolls favorites`);\n    }\n\n    this._refreshMenu();\n  }\n\n  /**\n   * Set blocked status for an actor\n   * @param {Actor|string} actor - The actor or actor ID\n   * @param {boolean} isBlocked - Whether to block the actor\n   * @returns {Promise<void>}\n   */\n  static async setBlocked(actor, isBlocked) {\n    const actorDoc = typeof actor === 'string' ? game.actors.get(actor) : actor;\n    if (!actorDoc) {\n      LogUtil.error('Actor not found', [actor]);\n      return;\n    }\n\n    if (isBlocked) {\n      await actorDoc.setFlag(MODULE_ID, this.FLAGS.BLOCKED, true);\n      await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.FAVORITE);\n    } else {\n      await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.BLOCKED);\n    }\n\n    this._refreshMenu();\n  }\n\n  /**\n   * Toggle favorite status for an actor\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {Promise<void>}\n   */\n  static async toggleFavorite(actor, makeFavorite) {\n    const isFavorite = makeFavorite ? true : !this.isFavorite(actor);\n    await this.setFavorite(actor, isFavorite);\n  }\n\n  /**\n   * Toggle blocked status for an actor\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {Promise<void>}\n   */\n  static async toggleBlocked(actor, makeBlocked) {\n    const isBlocked = makeBlocked ? true : !this.isBlocked(actor);\n    await this.setBlocked(actor, isBlocked);\n  }\n\n  /**\n   * Block an actor (for drag-to-remove functionality)\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {Promise<void>}\n   */\n  static async blockActor(actor) {\n    await this.setBlocked(actor, true);\n  }\n\n  /**\n   * Get all favorite actors\n   * @returns {Actor[]} Array of favorite actors\n   */\n  static getFavoriteActors() {\n    return game.actors.filter(actor => this.isFavorite(actor));\n  }\n\n  /**\n   * Get all blocked actors\n   * @returns {Actor[]} Array of blocked actors\n   */\n  static getBlockedActors() {\n    return game.actors.filter(actor => this.isBlocked(actor));\n  }\n\n  /**\n   * Filter actors by removing blocked ones\n   * @param {Actor[]} actors - Array of actors to filter\n   * @returns {Actor[]} Filtered array without blocked actors\n   */\n  static filterBlocked(actors) {\n    return actors.filter(actor => !this.isBlocked(actor));\n  }\n\n  /**\n   * Get actor status object\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {Object} Status object with favorite and blocked properties\n   */\n  static getActorStatus(actor) {\n    return {\n      isFavorite: this.isFavorite(actor),\n      isBlocked: this.isBlocked(actor)\n    };\n  }\n\n  /**\n   * Clear all status flags for an actor\n   * @param {Actor|string} actor - The actor or actor ID\n   * @returns {Promise<void>}\n   */\n  static async clearActorStatus(actor) {\n    const actorDoc = typeof actor === 'string' ? game.actors.get(actor) : actor;\n    if (!actorDoc) return;\n\n    await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.FAVORITE);\n    await actorDoc.unsetFlag(MODULE_ID, this.FLAGS.BLOCKED);\n    \n    this._refreshMenu();\n  }\n\n  /**\n   * Refresh the Roll Requests Menu if it's open\n   * @private\n   */\n  static _refreshMenu() {\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Get context menu options for actor management\n   * @param {HTMLElement} html - The HTML element\n   * @param {Array} options - Existing context menu options\n   * @returns {Array} Updated context menu options\n   */\n  static getContextMenuOptions(html, options) {\n    if (!game.user.isGM) return options;\n\n    options.push({\n      name: \"FLASH_ROLLS.contextMenu.toggleFavorite\",\n      icon: '<i class=\"fas fa-bolt\"></i>',\n      callback: li => {\n        const actorId = li.data('documentId') || li.dataset.entryId;\n        if (actorId) {\n          this.toggleFavorite(actorId);\n        }\n      },\n      condition: li => game.user.isGM\n    });\n\n    options.push({\n      name: \"FLASH_ROLLS.contextMenu.toggleBlocked\",\n      icon: '<i class=\"fas fa-ban\"></i>',\n      callback: li => {\n        const actorId = li.data('documentId') || li.dataset.entryId;\n        if (actorId) {\n          this.toggleBlocked(actorId);\n        }\n      },\n      condition: li => game.user.isGM\n    });\n\n    return options;\n  }\n}","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { ActorStatusManager } from '../managers/ActorStatusManager.mjs';\n\n/**\n * Handles drag-to-remove functionality for actors in the Roll Requests Menu\n */\nexport class ActorDragUtil {\n  /**\n   * Initialize drag functionality for actor list items\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static initializeActorDrag(menu) {\n    const actorElements = menu.element.querySelectorAll('.actor-list .actor.drag-wrapper[draggable=\"true\"]');\n    \n    actorElements.forEach(actorElement => {\n      actorElement.addEventListener('dragstart', (e) => this.handleDragStart(e, menu));\n      actorElement.addEventListener('dragend', (e) => this.handleDragEnd(e, menu));\n    });\n    \n    const menuContainer = menu.element;\n    menuContainer.addEventListener('dragover', (e) => this.handleDragOver(e));\n    menuContainer.addEventListener('drop', (e) => this.handleDrop(e, menu));\n    \n    document.addEventListener('dragover', (e) => this.handleGlobalDragOver(e, menu));\n    document.addEventListener('drop', (e) => this.handleGlobalDrop(e, menu));\n  }\n  \n  /**\n   * Handle drag start event\n   * @param {DragEvent} event \n   * @param {RollRequestsMenu} menu \n   */\n  static handleDragStart(event, menu) {\n    const actorElement = event.currentTarget;\n    const actorId = actorElement.dataset.actorId;\n    const actor = game.actors.get(actorId);\n    \n    if (!actor) {\n      event.preventDefault();\n      return;\n    }\n    \n    LogUtil.log('ActorDragUtil.handleDragStart', [actor.name, actorId]);\n    \n    event.dataTransfer.setData('text/plain', actorId);\n    event.dataTransfer.setData('application/json', JSON.stringify({\n      actorId: actorId,\n      actorName: actor.name,\n      uniqueId: actorElement.dataset.id,\n      tokenId: actorElement.dataset.tokenId || null\n    }));\n    \n    event.dataTransfer.effectAllowed = 'move';\n    actorElement.classList.add('dragging');\n    \n    const rect = actorElement.getBoundingClientRect();\n    const dragImage = actorElement.cloneNode(true);\n    dragImage.style.opacity = '0.6';\n    dragImage.style.position = 'absolute';\n    dragImage.style.top = '-1000px';\n    dragImage.style.left = '-1000px';\n    dragImage.style.width = rect.width + 'px';\n    dragImage.style.pointerEvents = 'none';\n    document.body.appendChild(dragImage);\n    \n    event.dataTransfer.setDragImage(dragImage, rect.width / 2, rect.height / 2);\n    \n    setTimeout(() => {\n      if (dragImage.parentNode) {\n        dragImage.parentNode.removeChild(dragImage);\n      }\n    }, 0);\n    \n    menu._currentDragData = {\n      actorId: actorId,\n      actorElement: actorElement,\n      startTime: Date.now()\n    };\n  }\n  \n  /**\n   * Handle drag over event within the menu\n   * @param {DragEvent} event \n   */\n  static handleDragOver(event) {\n    event.preventDefault();\n    event.dataTransfer.dropEffect = 'none';\n  }\n  \n  /**\n   * Handle drop event within the menu\n   * @param {DragEvent} event \n   * @param {RollRequestsMenu} menu \n   */\n  static handleDrop(event, menu) {\n    event.preventDefault();\n    LogUtil.log('ActorDragUtil.handleDrop - dropped within menu, canceling remove');\n    \n    this.cleanupDrag(menu);\n  }\n  \n  /**\n   * Handle global drag over (outside the menu)\n   * @param {DragEvent} event \n   * @param {RollRequestsMenu} menu \n   */\n  static handleGlobalDragOver(event, menu) {\n    if (!menu._currentDragData) return;\n    \n    const menuRect = menu.element.getBoundingClientRect();\n    const isOverMenu = (\n      event.clientX >= menuRect.left &&\n      event.clientX <= menuRect.right &&\n      event.clientY >= menuRect.top &&\n      event.clientY <= menuRect.bottom\n    );\n    \n    if (!isOverMenu) {\n      event.preventDefault();\n      event.dataTransfer.dropEffect = 'move';\n      \n      if (menu._currentDragData.actorElement) {\n        menu._currentDragData.actorElement.classList.add('drag-remove-zone');\n      }\n    } else {\n      if (menu._currentDragData.actorElement) {\n        menu._currentDragData.actorElement.classList.remove('drag-remove-zone');\n      }\n    }\n  }\n  \n  /**\n   * Handle global drop (outside the menu)\n   * @param {DragEvent} event \n   * @param {RollRequestsMenu} menu \n   */\n  static handleGlobalDrop(event, menu) {\n    if (!menu._currentDragData) return;\n    \n    const menuRect = menu.element.getBoundingClientRect();\n    const isOverMenu = (\n      event.clientX >= menuRect.left &&\n      event.clientX <= menuRect.right &&\n      event.clientY >= menuRect.top &&\n      event.clientY <= menuRect.bottom\n    );\n    \n    if (!isOverMenu) {\n      event.preventDefault();\n      \n      const dragData = JSON.parse(event.dataTransfer.getData('application/json'));\n      LogUtil.log('ActorDragUtil.handleGlobalDrop - blocking actor', [dragData.actorName]);\n      \n      this.blockActor(dragData.actorId, menu);\n    }\n    \n    this.cleanupDrag(menu);\n  }\n  \n  /**\n   * Handle drag end event\n   * @param {DragEvent} event \n   * @param {RollRequestsMenu} menu \n   */\n  static handleDragEnd(event, menu) {\n    LogUtil.log('ActorDragUtil.handleDragEnd');\n    \n    setTimeout(() => {\n      this.cleanupDrag(menu);\n    }, 100);\n  }\n  \n  /**\n   * Block an actor by setting the blocked flag\n   * @param {string} actorId - The actor ID to block\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async blockActor(actorId, menu) {\n    try {\n      await ActorStatusManager.blockActor(actorId);\n      \n      const actorElement = menu.element.querySelector(`[data-actor-id=\"${actorId}\"]`);\n      if (actorElement) {\n        const uniqueId = actorElement.dataset.id;\n        menu.selectedActors.delete(uniqueId);\n      }\n      \n      // Let the ActorStatusManager._refreshMenu() handle the re-render automatically\n      \n    } catch (error) {\n      LogUtil.error('Error blocking actor', [error]);\n      ui.notifications.error(`Failed to block actor: ${error.message}`);\n    }\n  }\n  \n  /**\n   * Clean up drag-related state and visual feedback\n   * @param {RollRequestsMenu} menu \n   */\n  static cleanupDrag(menu) {\n    if (menu._currentDragData?.actorElement) {\n      menu._currentDragData.actorElement.classList.remove('dragging', 'drag-remove-zone');\n    }\n    \n    menu._currentDragData = null;\n  }\n  \n  /**\n   * Remove drag event listeners (for cleanup)\n   * @param {RollRequestsMenu} menu \n   */\n  static removeDragListeners(menu) {\n    document.removeEventListener('dragover', this.handleGlobalDragOver);\n    document.removeEventListener('drop', this.handleGlobalDrop);\n  }\n}","import { LogUtil } from '../utils/LogUtil.mjs';\nimport { isPlayerOwned } from '../helpers/Helpers.mjs';\nimport { ActorStatusManager } from '../managers/ActorStatusManager.mjs';\n\n/**\n * Handles drag and drop of actors from the directory into the Flash Rolls menu\n */\nexport class ActorDropUtil {\n  /**\n   * Check if the current user can drop actors into the menu\n   * @param {string} selector - The drop target selector\n   * @returns {boolean} Whether the drop is allowed\n   */\n  static canDrop(selector) {\n    LogUtil.log('ActorDropUtil.canDrop', [selector]);\n    return game.user.isGM;\n  }\n\n  /**\n   * Handle the drag over event for visual feedback\n   * @param {DragEvent} event - The drag over event\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static handleDragOver(event, menu) {\n    LogUtil.log('ActorDropUtil.handleDragOver', [event, event.currentTarget, event.target]);\n    \n    event.preventDefault();\n    event.stopPropagation();\n    \n    if (event.dataTransfer) {\n      event.dataTransfer.dropEffect = 'copy';\n      LogUtil.log('ActorDropUtil.handleDragOver - dataTransfer types:', [event.dataTransfer.types]);\n    }\n    \n    const dropZone = event.currentTarget.closest('.actor-list, .actors');\n    if (dropZone) {\n      dropZone.classList.add('drag-over');\n      LogUtil.log('ActorDropUtil.handleDragOver - added drag-over class');\n    }\n    \n    return false;\n  }\n\n  /**\n   * Handle the drag leave event to remove visual feedback\n   * @param {DragEvent} event - The drag leave event\n   */\n  static handleDragLeave(event) {\n    LogUtil.log('ActorDropUtil.handleDragLeave', [event, event.currentTarget, event.target]);\n    \n    const rect = event.currentTarget.getBoundingClientRect();\n    const isActuallyLeaving = (\n      event.clientX < rect.left ||\n      event.clientX > rect.right ||\n      event.clientY < rect.top ||\n      event.clientY > rect.bottom\n    );\n    \n    if (isActuallyLeaving) {\n      const dropZone = event.currentTarget.closest('.actor-list, .actors');\n      if (dropZone) {\n        dropZone.classList.remove('drag-over');\n        LogUtil.log('ActorDropUtil.handleDragLeave - removed drag-over class');\n      }\n    }\n  }\n\n  /**\n   * Handle the drop event when an actor is dropped into the menu\n   * @param {DragEvent} event - The drop event\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async handleDrop(event, menu) {\n    event.preventDefault();\n    event.stopPropagation(); // Prevent bubbling to parent elements\n    \n    for (let i = 0; i < event.dataTransfer.types.length; i++) {\n      const type = event.dataTransfer.types[i];\n      const data = event.dataTransfer.getData(type);\n      LogUtil.log(`ActorDropUtil.handleDrop - ${type}:`, [data]);\n    }\n\n    const allDragOverElements = menu.element.querySelectorAll('.drag-over');\n    allDragOverElements.forEach(element => {\n      element.classList.remove('drag-over');\n    });\n    LogUtil.log('ActorDropUtil.handleDrop - removed drag-over class from all elements');\n\n    try {\n      const dragData = this.parseDragData(event);\n      if (!dragData || dragData.type !== 'Actor') {\n        LogUtil.log('ActorDropUtil.handleDrop - Invalid drag data', [dragData]);\n        return;\n      }\n\n      const actor = await this.getActorFromDragData(dragData);\n      if (!actor) {\n        ui.notifications.warn(game.i18n.localize(\"FLASH_ROLLS.notifications.actorNotFound\") || \"Actor not found\");\n        return;\n      }\n      \n      const isPC = isPlayerOwned(actor);\n      const targetTab = isPC ? 'pc' : 'npc';\n\n      if (menu.currentTab !== targetTab) {\n        menu.currentTab = targetTab;\n      }\n      await this.addActorToMenu(actor, menu);\n\n      // ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.actorAdded\", { \n      //   actor: actor.name \n      // }) || `Added ${actor.name} to Flash Rolls menu`);\n\n    } catch (error) {\n      LogUtil.error('ActorDropUtil.handleDrop - Error processing drop', [error]);\n      ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.dropError\") || \"Error adding actor to menu\");\n    }\n  }\n\n  /**\n   * Parse drag data from the drag event\n   * @param {DragEvent} event - The drag event\n   * @returns {Object|null} The parsed drag data or null if invalid\n   */\n  static parseDragData(event) {\n    try {\n      const jsonData = event.dataTransfer.getData('application/json');\n      if (jsonData) {\n        const parsed = JSON.parse(jsonData);\n        return parsed;\n      }\n\n      const textData = event.dataTransfer.getData('text/plain');\n      \n      if (textData) {\n        if (textData.startsWith('Actor.')) {\n          const dragData = {\n            type: 'Actor',\n            uuid: textData\n          };\n          return dragData;\n        }\n        \n        try {\n          const parsed = JSON.parse(textData);\n          return parsed;\n        } catch (e) {\n          LogUtil.log('ActorDropUtil.parseDragData - Text is not JSON');\n        }\n      }\n\n      return null;\n    } catch (error) {\n      LogUtil.error('ActorDropUtil.parseDragData - Error parsing drag data', [error]);\n      return null;\n    }\n  }\n\n  /**\n   * Get the actor document from drag data\n   * @param {Object} dragData - The drag data object\n   * @returns {Promise<Actor|null>} The actor document or null if not found\n   */\n  static async getActorFromDragData(dragData) {\n    try {\n      if (dragData.uuid) {\n        return await fromUuid(dragData.uuid);\n      } else if (dragData.id) {\n        return game.actors.get(dragData.id);\n      }\n      return null;\n    } catch (error) {\n      LogUtil.error('ActorDropUtil.getActorFromDragData - Error getting actor', [error]);\n      return null;\n    }\n  }\n\n  /**\n   * Add an actor to the menu as a favorite\n   * @param {Actor} actor - The actor to add\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async addActorToMenu(actor, menu) {\n    const isBlocked = ActorStatusManager.isBlocked(actor);\n    const isFavorite = ActorStatusManager.isFavorite(actor);\n    \n    if (isFavorite && !isBlocked) {\n      ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.actorAlreadyAdded\", { \n        actor: actor.name \n      }) || `${actor.name} is already in the menu`);\n      return;\n    }\n\n    await ActorStatusManager.setFavorite(actor, true);\n  }\n}","import { LogUtil } from '../../utils/LogUtil.mjs';\nimport { RollMenuDragManager } from './RollMenuDragManager.mjs';\nimport { delay, getActorData, updateCanvasTokenSelection } from '../../helpers/Helpers.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { MODULE_ID } from '../../../constants/General.mjs';\n\n/**\n * Handles Roll Requests Menu event listeners\n */\nexport class RollMenuEventManager {\n  \n  /**\n   * Set to track tokens that were temporarily selected on hover\n   * @type {Set<Token>}\n   */\n  static _hoveredTokens = new Set();\n  \n  /**\n   * Attach all event listeners to the menu\n   * @param {RollRequestsMenu} menu - The menu instance\n   * @param {HTMLElement} html - The menu HTML element\n   */\n  static attachListeners(menu, html) {\n    LogUtil.log('RollMenuEventManager.attachListeners');\n    \n    // Check if there are no actors and clean up tooltips\n    const actors = html.querySelectorAll('.actor');\n    if (actors.length === 0) {\n      this.cleanupActorTooltips();\n      html.classList.add('no-actors');\n    } else {\n      html.classList.remove('no-actors');\n    }\n    \n    this.attachToggleHandlers(menu, html);\n    this.attachDragHandlers(menu, html);\n    this.attachTabHandlers(menu, html);\n    this.attachActorHandlers(menu, html);\n    this.attachActionIconHandlers(menu, html);\n    this.attachCompactTooltipHandlers(menu, html);\n    this.attachSearchHandlers(menu, html);\n    this.attachAccordionHandlers(menu, html);\n    this.attachSubmenuHandlers(menu, html);\n    this.attachStatusEffectHandlers(menu, html);\n    this.attachGroupHandlers(menu, html);\n    this.attachOutsideClickHandler(menu);\n  }\n  \n  /**\n   * Attach toggle switch handlers\n   */\n  static attachToggleHandlers(menu, html) {\n    html.querySelector('#flash-rolls-toggle')?.addEventListener('change', menu._onToggleRollRequests.bind(menu));\n    html.querySelector('#flash5e-skip-dialogs')?.addEventListener('change', menu._onToggleSkipDialogs.bind(menu));\n    html.querySelector('#flash5e-group-rolls-msg')?.addEventListener('change', menu._onToggleGroupRollsMsg.bind(menu));\n    html.querySelector('#flash5e-actors-all')?.addEventListener('change', menu._onToggleSelectAll.bind(menu));\n    html.querySelector('#flash5e-filter-actors')?.addEventListener('click', menu._onToggleActorFilter.bind(menu));\n    html.querySelector('#flash5e-actors-lock')?.addEventListener('click', menu._onToggleLock.bind(menu));\n    html.querySelector('.options-toggle-btn')?.addEventListener('click', menu._onToggleOptions.bind(menu));\n    html.querySelector('#flash5e-open-settings')?.addEventListener('click', menu._onOpenSettings.bind(menu));\n  }\n  \n  /**\n   * Attach drag handle handlers\n   */\n  static attachDragHandlers(menu, html) {\n    const dragHandle = html.querySelector(RollMenuDragManager.DRAG_HANDLE_SELECTOR);\n    if (dragHandle && !dragHandle.hasAttribute('data-drag-initialized')) {\n      dragHandle.setAttribute('data-drag-initialized', 'true');\n      dragHandle.addEventListener('mousedown', (e) => {\n        RollMenuDragManager.handleDragStart(e, menu);\n      });\n    }\n  }\n  \n  /**\n   * Attach tab click handlers\n   */\n  static attachTabHandlers(menu, html) {\n    const tabs = html.querySelectorAll('.actor-tab');\n    LogUtil.log('RollMenuEventManager.attachTabHandlers - found tabs:', [tabs.length]);\n    tabs.forEach(tab => {\n      LogUtil.log('RollMenuEventManager.attachTabHandlers - attaching to tab:', [tab.dataset.tab]);\n      tab.addEventListener('click', menu._onTabClick.bind(menu));\n      tab.addEventListener('dblclick', menu._onTabDoubleClick.bind(menu));\n    });\n  }\n  \n  /**\n   * Attach action icon handlers for bulk operations\n   */\n  static attachActionIconHandlers(menu, html) {\n    html.querySelector('#flash5e-targets')?.addEventListener('click', () => {\n      this.toggleTargetsForSelected(menu);\n    });\n    \n    html.querySelector('#flash5e-heal-selected')?.addEventListener('click', () => {\n      this.healSelectedActors(menu);\n    });\n    \n    html.querySelector('#flash5e-kill-selected')?.addEventListener('click', () => {\n      this.killSelectedActors(menu);\n    });\n    \n    html.querySelector('#flash5e-sheets')?.addEventListener('click', () => {\n      this.openSheetsForSelected(menu);\n    });\n    \n    html.querySelector('#flash5e-toggle-list')?.addEventListener('change', () => {\n      this.toggleOptionsListOnHover(menu);\n    });\n    \n    html.querySelector('#flash5e-remove-effects')?.addEventListener('click', () => {\n      this.removeAllStatusEffectsFromSelected(menu);\n    });\n\n    html.querySelector('#flash5e-group-selected')?.addEventListener('click', () => {\n      this.createGroupFromSelected(menu);\n    });\n  }\n\n  /**\n   * Attach actor selection handlers\n   */\n  static attachActorHandlers(menu, html) {\n    html.querySelectorAll('.actor.drag-wrapper').forEach(wrapper => {\n      wrapper.addEventListener('click', (event) => {\n        // Check if this actor is non-selectable (expanded group)\n        if (wrapper.hasAttribute('data-non-selectable')) {\n          return; // Skip selection for expanded groups\n        }\n        menu._onActorClick.call(menu, event);\n      });\n      \n      // Add click handler for character sheet icon\n      const sheetIcon = wrapper.querySelector('.icon-sheet');\n      if (sheetIcon) {\n        sheetIcon.addEventListener('click', (event) => {\n          event.preventDefault();\n          event.stopPropagation();\n          \n          const actorId = wrapper.dataset.actorId;\n          const tokenId = wrapper.dataset.tokenId;\n          \n          this.openActorSheetById(actorId, tokenId);\n        });\n      }\n\n      // Add click handler for target icon\n      const targetIcon = wrapper.querySelector('.icon-target');\n      if (targetIcon) {\n        targetIcon.addEventListener('click', (event) => {\n          event.preventDefault();\n          event.stopPropagation();\n          \n          const actorId = wrapper.dataset.actorId;\n          const tokenId = wrapper.dataset.tokenId;\n          \n          this.toggleActorTargetById(actorId, tokenId);\n        });\n      }\n\n      // Add right-click handler for actor image to center token on screen\n      const actorImg = wrapper.querySelector('.actor-img');\n      if (actorImg) {\n        actorImg.addEventListener('contextmenu', (event) => {\n          event.preventDefault();\n          event.stopPropagation();\n          \n          const tokenId = wrapper.dataset.tokenId;\n          const actorId = wrapper.dataset.actorId;\n          \n          let token = tokenId ? canvas.tokens.get(tokenId) : null;\n          if (!token && actorId) {\n            token = canvas.tokens.placeables.find(t => t.actor?.id === actorId);\n          }\n          \n          if (token) {\n            canvas.animatePan({ x: token.x, y: token.y, duration: 250 });\n          }\n        });\n\n        // Add hover handlers for temporary token selection preview\n        actorImg.addEventListener('mouseenter', (event) => {\n          this.showTokenSelectionPreview(wrapper, menu);\n        });\n\n        actorImg.addEventListener('mouseleave', (event) => {\n          this.hideTokenSelectionPreview(wrapper, menu);\n        });\n      }\n    });\n  }\n  \n  /**\n   * Clean up any existing actor data tooltips\n   */\n  static cleanupActorTooltips() {\n    const existingTooltips = document.querySelectorAll('.actor-data-tooltip');\n    existingTooltips.forEach(tooltip => tooltip.remove());\n  }\n\n  /**\n   * Attach tooltip handlers for compact mode\n   */\n  static attachCompactTooltipHandlers(menu, html) {\n    // Always clean up existing tooltips first\n    this.cleanupActorTooltips();\n    \n    if (!html.classList.contains('compact')) return;\n    \n    const actors = html.querySelectorAll('#flash-rolls-menu.compact .actor');\n    \n    actors.forEach(actor => {\n      const actorData = actor.querySelector('.actor-data');\n      if (!actorData) return;\n      \n      let tooltipCopy = null;\n      \n      const showTooltip = async (event) => {\n        \n        const existingTooltip = document.querySelector('.actor-data-tooltip');\n        if (existingTooltip) {\n          existingTooltip.remove();\n        }\n        \n        tooltipCopy = actorData.cloneNode(true);\n        \n        const actorRect = actor.getBoundingClientRect();\n        const menuRect = html.getBoundingClientRect();\n        const isLeftEdge = html.classList.contains('left-edge');\n        const isHorizontalLayout = html.hasAttribute('data-layout') && html.getAttribute('data-layout') === 'horizontal';\n        \n        if (isHorizontalLayout) {\n          // Position above and centered on the actor image in horizontal layout\n          const actorImg = actor.querySelector('.actor-img');\n          const imgRect = actorImg ? actorImg.getBoundingClientRect() : actorRect;\n          \n          // Calculate the center of the image relative to the menu\n          const imgCenterX = imgRect.left + (imgRect.width / 2) - menuRect.left - 16;\n          \n          tooltipCopy.style.left = `${imgCenterX}px`;\n          tooltipCopy.style.transform = 'translateX(-50%)';\n          tooltipCopy.style.bottom = `${menuRect.bottom - actorRect.top + 8}px`;\n          tooltipCopy.style.top = 'auto';\n          tooltipCopy.style.right = 'auto';\n        } else {\n          // Original vertical layout positioning\n          if (isLeftEdge) {\n            tooltipCopy.style.left = `${actorRect.right - menuRect.left - 8}px`;\n          } else {\n            tooltipCopy.style.right = `${menuRect.right - actorRect.left - 8}px`;\n          }\n          tooltipCopy.style.top = `${actorRect.top - menuRect.top}px`;\n        }\n        tooltipCopy.className = 'actor-data-tooltip';\n        \n        document.querySelector('#flash-rolls-menu').appendChild(tooltipCopy);\n        \n        setTimeout(()=>{\n          tooltipCopy?.classList.add('visible');\n        }, menu.selectedActors.size > 0 ? 300 : 0);\n      };\n      \n      const hideTooltip = () => {\n        if (tooltipCopy) {\n          tooltipCopy.remove();\n          tooltipCopy = null;\n        }\n      };\n      \n      actor.addEventListener('mouseenter', showTooltip);\n      actor.addEventListener('mouseleave', hideTooltip);\n      \n      // Clean up on scroll to prevent misaligned tooltips\n      const scrollContainer = actor.closest('ul');\n      if (scrollContainer) {\n        scrollContainer.addEventListener('scroll', hideTooltip);\n      }\n    });\n  }\n  \n  /**\n   * Attach search input handlers\n   */\n  static attachSearchHandlers(menu, html) {\n    const searchInput = html.querySelector('.search-input');\n    if (searchInput) {\n      searchInput.addEventListener('input', menu._onSearchInput.bind(menu));\n      \n      // Select all text on click for quick deletion\n      searchInput.addEventListener('click', (event) => {\n        event.target.select();\n      });\n      \n      // Also select all on focus (useful for keyboard navigation)\n      searchInput.addEventListener('focus', (event) => {\n        event.target.select();\n        menu.isSearchFocused = true;\n        game.user.setFlag(MODULE_ID, 'searchFocused', true);\n      });\n      \n      // Hide accordion when search loses focus (if not hovering over menu)\n      searchInput.addEventListener('blur', () => {\n        menu.isSearchFocused = false;\n        game.user.setFlag(MODULE_ID, 'searchFocused', false);\n        const accordion = html.querySelector('.request-types-accordion');\n        if (accordion && !html.matches(':hover')) {\n          accordion.classList.remove('hover-visible');\n        }\n      });\n    }\n  }\n  \n  /**\n   * Attach accordion and request type handlers\n   */\n  static attachAccordionHandlers(menu, html) {    \n    const SETTINGS = getSettings();\n    const showOnHover = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag);\n    \n    const accordion = html.querySelector('.request-types-accordion');\n    if (accordion) {\n      // Always create the handlers but store them so we can add/remove them dynamically\n      const mouseEnterHandler = () => {\n        const showOptionsListOnHover = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag);\n        LogUtil.log('Accordion mouseEnter', [menu.isSearchFocused]);\n        if (menu.selectedActors.size > 0 && showOptionsListOnHover) {\n          accordion?.classList.add('hover-visible');\n        }\n      };\n      \n      const mouseLeaveHandler = () => {\n        LogUtil.log('Accordion mouseLeave', [menu.isSearchFocused]);\n        if (!menu.isSearchFocused) {\n          accordion?.classList.remove('hover-visible');\n        }\n      };\n      \n      // Store handlers on the menu for dynamic management\n      menu._accordionMouseEnter = mouseEnterHandler;\n      menu._accordionMouseLeave = mouseLeaveHandler;\n      \n      // Only attach if setting is enabled\n      if (showOnHover) {\n        html.addEventListener('mouseenter', mouseEnterHandler);\n        html.addEventListener('mouseleave', mouseLeaveHandler);\n        menu._accordionListenersAttached = true;\n      } else {\n        menu._accordionListenersAttached = false;\n      }\n    }\n    \n    const requestTypesContainer = html.querySelector('.request-types');\n    LogUtil.log('RollMenuEventManager.attachAccordionHandlers', [requestTypesContainer]);\n    if (requestTypesContainer) {\n      requestTypesContainer.addEventListener('click', (event) => {\n        // Handle macro button clicks FIRST - check target directly\n\n        LogUtil.log('requestTypes click', [event.target]);\n        if (event.target.classList.contains('btn-macro')) {\n          event.preventDefault();\n          event.stopPropagation();\n          event.stopImmediatePropagation();\n\n          \n          const parentItem = event.target.closest('.sub-item') || event.target.closest('.request-type-item');\n          if (parentItem) {\n            const customEvent = {\n              ...event,\n              currentTarget: parentItem\n            };\n            menu._onMacroButtonClick(customEvent);\n          }\n          return;\n        }\n        \n        // Also check if clicked element is inside a macro button\n        const macroBtn = event.target.closest('.btn-macro');\n        if (macroBtn) {\n          event.preventDefault();\n          event.stopPropagation();\n          event.stopImmediatePropagation();\n          \n          const parentItem = macroBtn.closest('.sub-item') || macroBtn.closest('.request-type-item');\n          if (parentItem) {\n            const customEvent = {\n              ...event,\n              currentTarget: parentItem\n            };\n            menu._onMacroButtonClick(customEvent);\n          }\n          return;\n        }\n        \n        const requestHeader = event.target.closest('.request-type-header');\n        \n        if (requestHeader) {\n          const requestItem = requestHeader.closest('.request-type-item');\n          \n          if (requestHeader.classList.contains('accordion-header')) {\n            menu._onAccordionToggle(event);\n            return;\n          }\n          \n          if (requestHeader.classList.contains('toggle') && requestItem && requestItem.classList.contains('rollable')) {\n            const customEvent = {\n              ...event,\n              currentTarget: requestItem\n            };\n            menu._onRequestTypeClick(customEvent);\n            return;\n          }\n        }\n        \n        const subItem = event.target.closest('.sub-item');\n        if (subItem && subItem.dataset.id) {\n          const customEvent = {\n            ...event,\n            currentTarget: subItem\n          };\n          menu._onRollTypeClick(customEvent);\n        }\n      });\n    }\n  }\n\n  /**\n   * Attach submenu tab handlers\n   */\n  static attachSubmenuHandlers(menu, html) {\n    try {\n      const submenuTabs = html.querySelectorAll('.submenu-tabs li[data-tab]');\n      LogUtil.log('RollMenuEventManager.attachSubmenuHandlers - found tabs:', [submenuTabs.length]);\n      submenuTabs.forEach(tab => {\n        tab.addEventListener('click', menu._onSubmenuTabClick.bind(menu));\n      });\n    } catch (error) {\n      LogUtil.error('RollMenuEventManager.attachSubmenuHandlers error:', [error]);\n    }\n  }\n\n  /**\n   * Attach status effect handlers\n   */\n  static attachStatusEffectHandlers(menu, html) {\n    try {\n      const statusEffects = html.querySelectorAll('.status-effects .status-effect');\n      LogUtil.log('RollMenuEventManager.attachStatusEffectHandlers - found effects:', [statusEffects.length]);\n      statusEffects.forEach(statusElement => {\n        // Check if listener already attached to prevent duplicates\n        if (!statusElement.dataset.listenerAttached) {\n          statusElement.dataset.listenerAttached = 'true';\n          statusElement.addEventListener('click', menu._onStatusEffectClick.bind(menu));\n        }\n      });\n    } catch (error) {\n      LogUtil.error('RollMenuEventManager.attachStatusEffectHandlers error:', [error]);\n    }\n  }\n  \n  /**\n   * Attach group expansion/collapse handlers\n   */\n  static attachGroupHandlers(menu, html) {\n    const groupExpandButtons = html.querySelectorAll('.group-expand-btn');\n    groupExpandButtons.forEach(button => {\n      button.addEventListener('click', async (event) => {\n        event.preventDefault();\n        event.stopPropagation();\n        \n        const groupId = button.dataset.groupId;\n        const isExpanded = menu.groupExpansionStates[groupId] ?? false;\n        \n        menu.groupExpansionStates[groupId] = !isExpanded;\n        await game.user.setFlag(MODULE_ID, 'groupExpansionStates', menu.groupExpansionStates);\n        menu.render();\n      });\n    });\n  }\n\n  /**\n   * Attach outside click handler with delay to prevent immediate closure\n   */\n  static attachOutsideClickHandler(menu) {\n    setTimeout(() => {\n      document.addEventListener('click', menu._onClickOutside, true);\n    }, 100);\n  }\n\n  /**\n   * Toggle targeting for all selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static toggleTargetsForSelected(menu) {\n    menu.selectedActors.forEach(uniqueId => {\n      const actor = getActorData(uniqueId);\n      if (!actor) return;\n      \n      const actorId = actor.id;\n      const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n      \n      this.toggleActorTargetById(actorId, tokenId);\n    });\n  }\n\n  /**\n   * Open character sheets for all selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static openSheetsForSelected(menu) {\n    // If we're on the Groups tab, open group sheets instead of individual member sheets\n    if (menu.currentTab === 'group') {\n      this.openGroupSheetsForSelected(menu);\n    } else {\n      // Regular behavior for PC/NPC tabs\n      menu.selectedActors.forEach(uniqueId => {\n        const actor = getActorData(uniqueId);\n        if (!actor) return;\n        \n        const actorId = actor.id;\n        const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n        \n        this.openActorSheetById(actorId, tokenId);\n      });\n    }\n  }\n\n  /**\n   * Open group sheets for groups that contain selected members\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static openGroupSheetsForSelected(menu) {\n    const context = menu._lastPreparedContext || {};\n    const groupActors = context.actors || [];\n    const openedGroups = new Set();\n    \n    // Find which groups contain selected members\n    groupActors.forEach(groupData => {\n      if (groupData.isGroup && groupData.members) {\n        // Check if any members of this group are selected\n        const hasSelectedMembers = groupData.members.some(member => \n          menu.selectedActors.has(member.uniqueId)\n        );\n        \n        if (hasSelectedMembers && !openedGroups.has(groupData.id)) {\n          // Open the group sheet\n          this.openActorSheetById(groupData.id, groupData.tokenId);\n          openedGroups.add(groupData.id);\n        }\n      }\n    });\n  }\n\n  /**\n   * Heal all selected actors to full HP\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static healSelectedActors(menu) {\n    menu.selectedActors.forEach(uniqueId => {\n      const actor = getActorData(uniqueId);\n      if (!actor) return;\n      \n      const actorId = actor.id;\n      const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n      \n      this.healActorById(actorId, tokenId);\n    });\n  }\n\n  /**\n   * Set HP to 0 for all selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static killSelectedActors(menu) {\n    menu.selectedActors.forEach(uniqueId => {\n      const actor = getActorData(uniqueId);\n      if (!actor) return;\n      \n      const actorId = actor.id;\n      const tokenId = game.actors.get(uniqueId) ? null : uniqueId;\n      \n      this.killActorById(actorId, tokenId);\n    });\n  }\n\n  /**\n   * Remove all status effects from selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async removeAllStatusEffectsFromSelected(menu) {\n    if (menu.selectedActors.size === 0) {\n      ui.notifications.warn(\"No actors selected\");\n      return;\n    }\n\n    let totalRemoved = 0;\n    let totalActors = 0;\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n      \n      totalActors++;\n      \n      // Get all status effects on the actor\n      const statusEffects = actor.effects.filter(effect => \n        effect.statuses?.size > 0 || effect.flags?.core?.statusId\n      );\n      \n      if (statusEffects.length > 0) {\n        // Remove all status effects\n        for (const effect of statusEffects) {\n          try {\n            await effect.delete();\n            totalRemoved++;\n          } catch (error) {\n            LogUtil.error(`Failed to remove status effect from ${actor.name}`, [error]);\n          }\n        }\n      }\n    }\n    \n    if (totalRemoved > 0) {\n      ui.notifications.info(`Removed ${totalRemoved} status effects from ${totalActors} actor(s)`);\n    } else {\n      ui.notifications.info(`No status effects to remove from selected actors`);\n    }\n  }\n\n  /**\n   * Toggle target state for a single actor\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   */\n  static toggleActorTarget(wrapper) {\n    const tokenId = wrapper.dataset.tokenId;\n    const actorId = wrapper.dataset.actorId;\n    \n    let token = tokenId ? canvas.tokens.get(tokenId) : null;\n    if (!token && actorId) {\n      token = canvas.tokens.placeables.find(t => t.actor?.id === actorId);\n    }\n    \n    if (token) {\n      const isTargeted = game.user.targets.has(token);\n      token.setTarget(!isTargeted, { releaseOthers: false });\n    }\n  }\n\n  /**\n   * Open character sheet for a single actor\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   */\n  static openActorSheet(wrapper) {\n    const actorId = wrapper.dataset.actorId;\n    const tokenId = wrapper.dataset.tokenId;\n    \n    if (actorId) {\n      let actor;\n      if (tokenId) {\n        const token = canvas.tokens.get(tokenId);\n        actor = token?.actor || game.actors.get(actorId);\n      } else {\n        actor = game.actors.get(actorId);\n      }\n      actor?.sheet.render(true);\n    }\n  }\n\n  /**\n   * Heal actor to full HP\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   */\n  static healActor(wrapper) {\n    const actorId = wrapper.dataset.actorId;\n    const tokenId = wrapper.dataset.tokenId;\n    \n    let actor;\n    if (tokenId) {\n      const token = canvas.tokens.get(tokenId);\n      actor = token?.actor || game.actors.get(actorId);\n    } else {\n      actor = game.actors.get(actorId);\n    }\n    \n    if (actor && actor.system?.attributes?.hp) {\n      const maxHP = actor.system.attributes.hp.max;\n      actor.update({ 'system.attributes.hp.value': maxHP });\n    }\n  }\n\n  /**\n   * Set actor HP to 0\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   */\n  static killActor(wrapper) {\n    const actorId = wrapper.dataset.actorId;\n    const tokenId = wrapper.dataset.tokenId;\n    \n    let actor;\n    if (tokenId) {\n      const token = canvas.tokens.get(tokenId);\n      actor = token?.actor || game.actors.get(actorId);\n    } else {\n      actor = game.actors.get(actorId);\n    }\n    \n    if (actor && actor.system?.attributes?.hp) {\n      actor.update({ 'system.attributes.hp.value': 0 });\n    }\n  }\n\n  /**\n   * Toggle target state for a single actor by ID\n   * @param {string} actorId - The actor ID\n   * @param {string} tokenId - The token ID (optional)\n   */\n  static toggleActorTargetById(actorId, tokenId) {\n    let token = tokenId ? canvas.tokens.get(tokenId) : null;\n    if (!token && actorId) {\n      token = canvas.tokens.placeables.find(t => t.actor?.id === actorId);\n    }\n    \n    if (token) {\n      const isTargeted = game.user.targets.has(token);\n      token.setTarget(!isTargeted, { releaseOthers: false });\n    }\n  }\n\n  /**\n   * Open character sheet for a single actor by ID\n   * @param {string} actorId - The actor ID\n   * @param {string} tokenId - The token ID (optional)\n   */\n  static openActorSheetById(actorId, tokenId) {\n    if (actorId) {\n      let actor;\n      if (tokenId) {\n        const token = canvas.tokens.get(tokenId);\n        actor = token?.actor || game.actors.get(actorId);\n      } else {\n        actor = game.actors.get(actorId);\n      }\n      actor?.sheet.render(true);\n    }\n  }\n\n  /**\n   * Heal actor to full HP by ID\n   * @param {string} actorId - The actor ID\n   * @param {string} tokenId - The token ID (optional)\n   */\n  static healActorById(actorId, tokenId) {\n    let actor;\n    if (tokenId) {\n      const token = canvas.tokens.get(tokenId);\n      actor = token?.actor || game.actors.get(actorId);\n    } else {\n      actor = game.actors.get(actorId);\n    }\n    \n    if (actor && actor.system?.attributes?.hp) {\n      const maxHP = actor.system.attributes.hp.max;\n      actor.update({ 'system.attributes.hp.value': maxHP });\n    }\n  }\n\n  /**\n   * Set actor HP to 0 by ID\n   * @param {string} actorId - The actor ID\n   * @param {string} tokenId - The token ID (optional)\n   */\n  static killActorById(actorId, tokenId) {\n    let actor;\n    if (tokenId) {\n      const token = canvas.tokens.get(tokenId);\n      actor = token?.actor || game.actors.get(actorId);\n    } else {\n      actor = game.actors.get(actorId);\n    }\n    \n    if (actor && actor.system?.attributes?.hp) {\n      actor.update({ 'system.attributes.hp.value': 0 });\n    }\n  }\n\n  /**\n   * Show temporary token selection preview on hover\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static showTokenSelectionPreview(wrapper, menu) {\n    const tokenId = wrapper.dataset.tokenId;\n    const actorId = wrapper.dataset.actorId;\n    const uniqueId = wrapper.dataset.id;\n    \n    let token = tokenId ? canvas.tokens.get(tokenId) : null;\n    if (!token && actorId) {\n      token = canvas.tokens.placeables.find(t => t.actor?.id === actorId);\n    }\n    \n    if (token) {\n      const wasAlreadySelected = menu.selectedActors.has(uniqueId);\n      const wasAlreadyControlled = token._controlled;\n      \n      // Only control if not already controlled\n      if (!wasAlreadyControlled) {\n        // Temporarily ignore token control changes to prevent menu selection updates\n        menu._ignoreTokenControl = true;\n        \n        token.control({ releaseOthers: false });\n        \n        // Restore token control listening after a brief delay\n        setTimeout(() => {\n          menu._ignoreTokenControl = false;\n        }, 50);\n        \n        // Track this token as temporarily controlled by hover\n        this._hoveredTokens.add(token);\n        token._flashRollsWasSelected = wasAlreadySelected;\n      }\n    }\n  }\n\n  /**\n   * Toggle the show options list on hover setting\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async toggleOptionsListOnHover(menu) {    \n    const SETTINGS = getSettings();\n    const currentValue = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag);\n    const accordion = menu.element.querySelector('.request-types-accordion');\n    const accordionVisible = accordion?.classList.contains('hover-visible');\n    \n    const newValue = !currentValue;\n    await SettingsUtil.set(SETTINGS.showOptionsListOnHover.tag, newValue);\n\n    RollMenuEventManager.updateAccordionHoverBehaviorNoRender(menu, newValue);\n\n    if(newValue===false || menu.selectedActors.size === 0){\n      accordion?.classList.remove('hover-visible');\n    }else if(newValue===true && menu.selectedActors.size > 0){\n      accordion?.classList.add('hover-visible');\n    }\n  }\n\n  /**\n   * Update accordion hover behavior based on setting\n   * @param {RollRequestsMenu} menu - The menu instance\n   * @param {boolean} showOnHover - Whether to show accordion on hover\n   */\n  static updateAccordionHoverBehavior(menu, showOnHover) {\n    // Re-render the menu to update event listeners based on new setting\n    menu.render();\n  }\n\n  /**\n   * Update accordion hover behavior without re-rendering\n   * @param {RollRequestsMenu} menu - The menu instance\n   * @param {boolean} showOnHover - Whether to show accordion on hover\n   */\n  static updateAccordionHoverBehaviorNoRender(menu, showOnHover) {\n    const html = menu.element;\n    const accordion = html.querySelector('.request-types-accordion');\n    if (!accordion || !menu._accordionMouseEnter) return;\n\n    html.removeEventListener('mouseenter', menu._accordionMouseEnter);\n    html.removeEventListener('mouseleave', menu._accordionMouseLeave);\n    // menu._accordionListenersAttached = false;\n    accordion.classList.remove('hover-visible');\n\n    if(showOnHover) {\n      // Add the stored handlers\n      html.addEventListener('mouseenter', menu._accordionMouseEnter);\n      html.addEventListener('mouseleave', menu._accordionMouseLeave);\n      // menu._accordionListenersAttached = true;\n    }\n  }\n\n  /**\n   * Hide temporary token selection preview on mouse leave\n   * @param {HTMLElement} wrapper - The actor wrapper element\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static hideTokenSelectionPreview(wrapper, menu) {\n    const tokenId = wrapper.dataset.tokenId;\n    const actorId = wrapper.dataset.actorId;\n    const uniqueId = wrapper.dataset.id;\n    \n    let token = tokenId ? canvas.tokens.get(tokenId) : null;\n    if (!token && actorId) {\n      token = canvas.tokens.placeables.find(t => t.actor?.id === actorId);\n    }\n    \n    if (token && this._hoveredTokens.has(token)) {\n      const isActuallySelected = menu.selectedActors.has(uniqueId);\n      const wasSelected = token._flashRollsWasSelected;\n      \n      // Only release if the actor is not actually selected in the menu\n      if (!isActuallySelected && !wasSelected) {\n        // Temporarily ignore token control changes to prevent menu selection updates\n        menu._ignoreTokenControl = true;\n        \n        token.release();\n        \n        // Restore token control listening after a brief delay\n        setTimeout(() => {\n          menu._ignoreTokenControl = false;\n        }, 50);\n      }\n      \n      // Clean up tracking\n      this._hoveredTokens.delete(token);\n      delete token._flashRollsWasSelected;\n    }\n  }\n\n  /**\n   * Create a new group or encounter actor from selected actors\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async createGroupFromSelected(menu) {\n    if (menu.selectedActors.size === 0) {\n      ui.notifications.warn(\"No actors selected\");\n      return;\n    }\n\n    // Get actor data and group by base actor while tracking token associations\n    const actorGroups = new Map(); // Map of base actor ID to { actor, count, tokenUuids }\n    const tokenAssociations = {}; // Map of base actor ID to array of token UUIDs\n    let playerOwnedCount = 0;\n    let totalSelectedCount = 0;\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n\n      totalSelectedCount++;\n\n      // Get the base actor ID\n      const baseActorId = actor.id;\n\n      if (actorGroups.has(baseActorId)) {\n        // Increment quantity and add token ID for existing actor\n        const group = actorGroups.get(baseActorId);\n        group.count++;\n        if (actor.tokenId) {\n          group.tokenIds.push(actor.tokenId);\n        }\n      } else {\n        // Add new actor to the map\n        actorGroups.set(baseActorId, {\n          actor: actor,\n          count: 1,\n          tokenIds: actor.tokenId ? [actor.tokenId] : []\n        });\n\n        // Check ownership only once per unique actor\n        const hasPlayerOwnership = Object.entries(actor.ownership || {}).some(([userId, level]) => {\n          if (userId === 'default') return false;\n          const user = game.users.get(userId);\n          return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER;\n        });\n\n        if (hasPlayerOwnership) {\n          playerOwnedCount++;\n        }\n      }\n\n      // Build token associations for flags (store only token IDs)\n      if (!tokenAssociations[baseActorId]) {\n        tokenAssociations[baseActorId] = [];\n      }\n\n      // If uniqueId is different from actor.id, it means this is a token selection\n      if (uniqueId !== actor.id) {\n        // uniqueId is the token ID\n        tokenAssociations[baseActorId].push(uniqueId);\n      }\n    }\n\n    if (actorGroups.size === 0) {\n      ui.notifications.warn(\"No valid actors found\");\n      return;\n    }\n\n    // Determine actor type based on player ownership ratio\n    const playerOwnedRatio = playerOwnedCount / actorGroups.size;\n    const actorType = playerOwnedRatio >= 0.5 ? \"group\" : \"encounter\";\n\n    // Generate a default name\n    const defaultName = actorType === \"group\" ? \"New Group\" : \"New Encounter\";\n\n    // Prepare members array based on actor type\n    const members = [];\n    if (actorType === \"group\") {\n      // Group type: store direct actor references with quantities\n      for (const [baseActorId, { actor, count }] of actorGroups) {\n        // Get the base actor (not the token actor)\n        const baseActor = game.actors.get(baseActorId);\n        if (baseActor) {\n          members.push({\n            actor: baseActor, // Direct base actor reference for group type\n            quantity: count\n          });\n        }\n      }\n    } else {\n      // Encounter type: store base actor UUIDs with proper quantity structure\n      for (const [baseActorId, { actor, count }] of actorGroups) {\n        members.push({\n          uuid: `Actor.${baseActorId}`, // Base actor UUID\n          quantity: {\n            value: count,\n            formula: \"\"\n          }\n        });\n      }\n    }\n\n    // Create the new actor with members and token associations flag\n    try {\n      const newActor = await Actor.create({\n        name: defaultName,\n        type: actorType,\n        img: \"icons/svg/mystery-man.svg\", // Default icon\n        system: {\n          members: members\n        },\n        flags: {\n          \"flash-rolls-5e\": {\n            tokenAssociations: tokenAssociations\n          }\n        },\n        ownership: {\n          default: CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER,\n          [game.user.id]: CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER\n        }\n      });\n\n      if (newActor) {\n        // Open the newly created actor sheet\n        newActor.sheet.render(true);\n\n        // Show success notification\n        const memberSummary = Array.from(actorGroups.values()).map(({ actor, count }) =>\n          count > 1 ? `${actor.name} (x${count})` : actor.name\n        ).join(\", \");\n        ui.notifications.info(`Created ${actorType} \"${newActor.name}\" (${totalSelectedCount} tokens, ${actorGroups.size} unique: ${memberSummary})`);\n\n        LogUtil.log(`createGroupFromSelected - Created ${actorType}:`, {\n          newActor,\n          totalSelectedCount,\n          uniqueActorCount: actorGroups.size,\n          playerOwnedCount,\n          playerOwnedRatio,\n          tokenAssociations,\n          members: Array.from(actorGroups.entries()).map(([id, { actor, count, tokenUuids }]) => ({\n            id,\n            name: actor.name,\n            quantity: count,\n            tokenUuids\n          }))\n        });\n      }\n    } catch (error) {\n      LogUtil.error(\"Failed to create group/encounter actor:\", error);\n      ui.notifications.warn(`Failed to create ${actorType}: ${error.message}`);\n    }\n  }\n}","import { LogUtil } from '../../utils/LogUtil.mjs';\nimport { getActorData } from '../../helpers/Helpers.mjs';\n\n/**\n * Handles status effects in the Roll Requests Menu\n */\nexport class RollMenuStatusManager {\n\n  /**\n   * Apply a status effect to selected actors\n   * @param {string} statusEffectId - The ID of the status effect to apply\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async applyStatusToSelected(statusEffectId, menu) {\n    const statusEffect = CONFIG.statusEffects.find(effect => effect.id === statusEffectId);\n    if (!statusEffect) {\n      ui.notifications.warn(`Status effect \"${statusEffectId}\" not found`);\n      return;\n    }\n\n    if (menu.selectedActors.size === 0) {\n      ui.notifications.warn(\"No actors selected\");\n      return;\n    }\n\n    let successCount = 0;\n    let totalCount = 0;\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n      \n      totalCount++;\n      const success = await this.applyStatusToActor(statusEffect, actor);\n      if (success) successCount++;\n    }\n\n    if (successCount > 0) {\n      const statusName = statusEffect.name || statusEffect.label || statusEffect.id;\n      ui.notifications.info(`Applied \"${statusName}\" to ${successCount}/${totalCount} actors`);\n    }\n  }\n\n  /**\n   * Apply a status effect to a single actor\n   * @param {Object} statusEffect - The status effect configuration\n   * @param {Actor} actor - The actor to apply the effect to\n   * @returns {Promise<boolean>} Success state\n   */\n  static async applyStatusToActor(statusEffect, actor) {\n    try {\n      // Check if actor already has this status effect\n      const existingEffect = actor.effects.find(effect => \n        effect.statuses?.has(statusEffect.id) || \n        effect.flags?.core?.statusId === statusEffect.id\n      );\n\n      if (existingEffect) {\n        LogUtil.log(`RollMenuStatusManager: Actor ${actor.name} already has status effect ${statusEffect.id}`);\n        return false;\n      }\n\n      // Use the actor's toggleStatusEffect method if available (Foundry v10+)\n      if (actor.toggleStatusEffect) {\n        const hasEffect = actor.effects.some(e => e.statuses?.has(statusEffect.id));\n        if (!hasEffect) {\n          await actor.toggleStatusEffect(statusEffect.id, { active: true });\n          LogUtil.log(`RollMenuStatusManager: Applied ${statusEffect.id} to ${actor.name}`);\n          return true;\n        }\n        return false;\n      }\n      \n      // Fallback to manual creation for older versions\n      const effectData = {\n        name: statusEffect.name || statusEffect.label || statusEffect.id,\n        icon: statusEffect.icon || statusEffect.img,\n        statuses: [statusEffect.id],\n        flags: {\n          core: {\n            statusId: statusEffect.id\n          }\n        }\n      };\n\n      // Apply additional effect properties if they exist\n      if (statusEffect.changes) {\n        effectData.changes = statusEffect.changes;\n      }\n\n      await actor.createEmbeddedDocuments('ActiveEffect', [effectData]);\n      LogUtil.log(`RollMenuStatusManager: Applied ${statusEffect.id} to ${actor.name}`);\n      return true;\n\n    } catch (error) {\n      LogUtil.error(`RollMenuStatusManager: Failed to apply status effect to ${actor.name}`, [error]);\n      return false;\n    }\n  }\n\n  /**\n   * Remove a status effect from selected actors\n   * @param {string} statusEffectId - The ID of the status effect to remove\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async removeStatusFromSelected(statusEffectId, menu) {\n    const statusEffect = CONFIG.statusEffects.find(effect => effect.id === statusEffectId);\n    if (!statusEffect) {\n      ui.notifications.warn(`Status effect \"${statusEffectId}\" not found`);\n      return;\n    }\n\n    if (menu.selectedActors.size === 0) {\n      ui.notifications.warn(\"No actors selected\");\n      return;\n    }\n\n    let successCount = 0;\n    let totalCount = 0;\n\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n      \n      totalCount++;\n      const success = await this.removeStatusFromActor(statusEffect, actor);\n      if (success) successCount++;\n    }\n\n    if (successCount > 0) {\n      const statusName = statusEffect.name || statusEffect.label || statusEffect.id;\n      ui.notifications.info(`Removed \"${statusName}\" from ${successCount}/${totalCount} actors`);\n    }\n  }\n\n  /**\n   * Remove a status effect from a single actor\n   * @param {Object} statusEffect - The status effect configuration\n   * @param {Actor} actor - The actor to remove the effect from\n   * @returns {Promise<boolean>} Success state\n   */\n  static async removeStatusFromActor(statusEffect, actor) {\n    try {\n      // Use the actor's toggleStatusEffect method if available (Foundry v10+)\n      if (actor.toggleStatusEffect) {\n        const hasEffect = actor.effects.some(e => e.statuses?.has(statusEffect.id));\n        if (hasEffect) {\n          await actor.toggleStatusEffect(statusEffect.id, { active: false });\n          LogUtil.log(`RollMenuStatusManager: Removed ${statusEffect.id} from ${actor.name}`);\n          return true;\n        }\n        return false;\n      }\n      \n      // Fallback to manual deletion for older versions\n      const existingEffect = actor.effects.find(effect => \n        effect.statuses?.has(statusEffect.id) || \n        effect.flags?.core?.statusId === statusEffect.id\n      );\n\n      if (!existingEffect) {\n        LogUtil.log(`RollMenuStatusManager: Actor ${actor.name} does not have status effect ${statusEffect.id}`);\n        return false;\n      }\n\n      await existingEffect.delete();\n      LogUtil.log(`RollMenuStatusManager: Removed ${statusEffect.id} from ${actor.name}`);\n      return true;\n\n    } catch (error) {\n      LogUtil.error(`RollMenuStatusManager: Failed to remove status effect from ${actor.name}`, [error]);\n      return false;\n    }\n  }\n\n  /**\n   * Toggle a status effect on selected actors\n   * @param {string} statusEffectId - The ID of the status effect to toggle\n   * @param {RollRequestsMenu} menu - The menu instance\n   */\n  static async toggleStatusOnSelected(statusEffectId, menu) {\n    const statusEffect = CONFIG.statusEffects.find(effect => effect.id === statusEffectId);\n    if (!statusEffect) {\n      ui.notifications.warn(`Status effect \"${statusEffectId}\" not found`);\n      return;\n    }\n\n    if (menu.selectedActors.size === 0) {\n      ui.notifications.warn(\"No actors selected\");\n      return;\n    }\n\n    // Check if any selected actor has the status effect\n    let hasEffect = false;\n    for (const uniqueId of menu.selectedActors) {\n      const actor = getActorData(uniqueId);\n      if (!actor) continue;\n      \n      const existingEffect = actor.effects.find(effect => \n        effect.statuses?.has(statusEffect.id) || \n        effect.flags?.core?.statusId === statusEffect.id\n      );\n\n      if (existingEffect) {\n        hasEffect = true;\n        break;\n      }\n    }\n\n    // If any actor has the effect, remove it from all. Otherwise, add it to all.\n    if (hasEffect) {\n      await this.removeStatusFromSelected(statusEffectId, menu);\n    } else {\n      await this.applyStatusToSelected(statusEffectId, menu);\n    }\n  }\n\n  /**\n   * Get status effects data for template context\n   * @returns {Array} Array of status effects with additional UI data\n   */\n  static getStatusEffectsForTemplate() {\n    try {\n      if (!CONFIG.statusEffects || !Array.isArray(CONFIG.statusEffects)) {\n        LogUtil.warn('RollMenuStatusManager: CONFIG.statusEffects not available or not an array');\n        return [];\n      }\n      \n      return CONFIG.statusEffects\n        .map(effect => ({\n          ...effect,\n          displayName: effect.name || effect.label || effect.id,\n          iconPath: effect.icon || effect.img || 'icons/svg/aura.svg'\n        }))\n        .sort((a, b) => {\n          // Sort alphabetically by display name\n          return a.displayName.localeCompare(b.displayName, undefined, { sensitivity: 'base' });\n        });\n    } catch (error) {\n      LogUtil.error('RollMenuStatusManager: Error getting status effects for template', [error]);\n      return [];\n    }\n  }\n}","import { LogUtil } from '../../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { MODULE } from '../../../constants/General.mjs';\nimport { SidebarController } from '../SidebarController.mjs';\nimport { updateCanvasTokenSelection, getActorData } from '../../helpers/Helpers.mjs';\n\n/**\n * Handles UI state management in the Roll Requests Menu\n */\nexport class RollMenuStateManager {\n  \n  /**\n   * Handle roll requests toggle\n   * @param {Event} event - Toggle event\n   */\n  static async handleToggleRollRequests(event) {\n    const SETTINGS = getSettings();\n    const enabled = event.target.checked;\n    await SettingsUtil.set(SETTINGS.rollRequestsEnabled.tag, enabled);\n    \n    SidebarController.updateRollRequestsIcon(enabled);\n  }\n\n  /**\n   * Handle skip dialogs toggle\n   * @param {Event} event - Toggle event\n   */\n  static async handleToggleSkipDialogs(event) {\n    const SETTINGS = getSettings();\n    const skip = event.target.checked;\n    await SettingsUtil.set(SETTINGS.skipRollDialog.tag, skip);\n  }\n\n  /**\n   * Handle group rolls message toggle\n   * @param {Event} event - Toggle event\n   */\n  static async handleToggleGroupRollsMsg(event) {\n    const SETTINGS = getSettings();\n    const isEnabled = event.target.checked;\n    await SettingsUtil.set(SETTINGS.groupRollsMsgEnabled.tag, isEnabled);\n  }\n\n  /**\n   * Handle select all toggle\n   * @param {Event} event - Toggle event\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static handleToggleSelectAll(event, menu) {\n    const SETTINGS = getSettings();\n    const selectAll = event.target.checked;\n    menu._ignoreTokenControl = true;\n    \n    const context = menu._lastPreparedContext || {};\n    // In Groups tab, data is in context.groups, otherwise in context.actors\n    const currentActors = menu.currentTab === 'group' ? (context.groups || []) : (context.actors || []);\n    \n    currentActors.forEach(actorData => {\n      // Handle group actors by selecting/deselecting their members (always, regardless of tab)\n      if (actorData.isGroup && actorData.members) {\n        actorData.members.forEach(member => {\n          const memberUniqueId = member.uniqueId;\n          if (selectAll) {\n            menu.selectedActors.add(memberUniqueId);\n            if (member.tokenId) {\n              updateCanvasTokenSelection(member.id, true, member.tokenId);\n            } else {\n              updateCanvasTokenSelection(member.id, true);\n            }\n          } else {\n            menu.selectedActors.delete(memberUniqueId);\n            if (member.tokenId) {\n              updateCanvasTokenSelection(member.id, false, member.tokenId);\n            } else {\n              updateCanvasTokenSelection(member.id, false);\n            }\n          }\n        });\n      } else {\n        // Handle regular actors\n        const uniqueId = actorData.uniqueId;\n        if (selectAll) {\n          menu.selectedActors.add(uniqueId);\n          if (actorData.tokenId) {\n            updateCanvasTokenSelection(actorData.id, true, actorData.tokenId);\n          } else {\n            updateCanvasTokenSelection(actorData.id, true);\n          }\n        } else {\n          menu.selectedActors.delete(uniqueId);\n          if (actorData.tokenId) {\n            updateCanvasTokenSelection(actorData.id, false, actorData.tokenId);\n          } else {\n            updateCanvasTokenSelection(actorData.id, false);\n          }\n        }\n      }\n    });\n    \n    setTimeout(() => {\n      menu._ignoreTokenControl = false;\n    }, 200);\n    \n    // Update group selection visual state\n    menu._updateGroupSelectionUI();\n    \n    // Update select all state before rendering\n    this.updateSelectAllState(menu);\n    \n    menu.render();\n    this.updateRequestTypesVisibility(menu);\n    const showOptionsListOnHover = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag);\n    \n    // Show/hide request types accordion based on selection\n    const accordion = menu.element.querySelector('.request-types-accordion');\n    if (accordion) {\n      if (menu.selectedActors.size > 0 && showOptionsListOnHover) {\n        accordion.classList.add('hover-visible');\n      } else {\n        accordion.classList.remove('hover-visible');\n      }\n    }\n  }\n\n  /**\n   * Handle lock toggle\n   * @param {Event} event - Toggle event\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static handleToggleLock(event, menu) {\n    event.preventDefault();\n    menu.isLocked = !menu.isLocked;\n\n    const lockIcon = event.currentTarget;\n    lockIcon.classList.remove('fa-lock-keyhole', 'fa-lock-keyhole-open');\n    lockIcon.classList.add(menu.isLocked ? 'fa-lock-keyhole' : 'fa-lock-keyhole-open');\n  }\n\n  /**\n   * Handle actor filter toggle\n   * @param {Event} event - Toggle event\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static async handleToggleActorFilter(event, menu) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const button = event.currentTarget;\n    const existing = menu.element.querySelector('.actor-filter-tooltip');\n\n    if (existing) {\n      existing.remove();\n      return;\n    }\n\n    const tooltip = await RollMenuStateManager.createActorFilterTooltip(menu);\n\n    // Position tooltip relative to the menu element, not the button\n    menu.element.appendChild(tooltip);\n\n    // Get positions after tooltip is in DOM\n    const buttonRect = button.getBoundingClientRect();\n    const menuRect = menu.element.getBoundingClientRect();\n    const menuLayout = menu.element.dataset.layout;\n\n    // Force layout calculation\n    const tooltipRect = tooltip.getBoundingClientRect();\n\n    // Calculate position relative to menu - center tooltip above button\n    const relativeTop = buttonRect.top - menuRect.top;\n    const buttonCenterX = buttonRect.left - menuRect.left + (buttonRect.width / 2);\n    const tooltipLeft = buttonCenterX - (tooltipRect.width / 2);\n\n    if (menuLayout === 'horizontal') {\n      tooltip.style.top = `${relativeTop - tooltipRect.height - 8}px`;\n      tooltip.style.left = `${tooltipLeft}px`;\n    } else {\n      // Vertical layout - position tooltip to the left or right of the button\n      const isLeftEdge = menu.element.classList.contains('left-edge');\n      const relativeLeft = buttonRect.left - menuRect.left;\n      const buttonCenterY = relativeTop + (buttonRect.height / 2);\n      const tooltipTop = buttonCenterY - (tooltipRect.height / 2);\n\n      if (isLeftEdge) {\n        // Left edge - tooltip appears to the right of the button\n        tooltip.style.top = `${tooltipTop}px`;\n        tooltip.style.left = `${relativeLeft + buttonRect.width + 20}px`;\n      } else {\n        // Normal vertical - tooltip appears to the left of the button\n        tooltip.style.top = `${tooltipTop}px`;\n        tooltip.style.left = `${relativeLeft - tooltipRect.width - 20}px`;\n      }\n    }\n  }\n\n  /**\n   * Handle options toggle\n   * @param {Event} event - Toggle event\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static async handleToggleOptions(event, menu) {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    menu.optionsExpanded = !menu.optionsExpanded;\n    await game.user.setFlag(MODULE.ID, 'menuOptionsExpanded', menu.optionsExpanded);\n    \n    const optionsToggleContainer = menu.element.querySelector('.options-toggle');\n    if (optionsToggleContainer) {\n      optionsToggleContainer.classList.toggle('expanded', menu.optionsExpanded);\n    }\n    \n    const optionsElement = menu.element.querySelector('li.options');\n    if (optionsElement) {\n      optionsElement.classList.toggle('expanded', menu.optionsExpanded);\n    }\n  }\n\n  /**\n   * Toggle actor selection state\n   * @param {string} uniqueId - Unique ID of the actor/token\n   * @param {string} actorId - Actor ID\n   * @param {string} tokenId - Token ID (if applicable)\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static toggleActorSelection(uniqueId, actorId, tokenId, menu) {\n    const SETTINGS = getSettings();\n    menu._ignoreTokenControl = true;\n    \n    if (menu.selectedActors.has(uniqueId)) {\n      menu.selectedActors.delete(uniqueId);\n      if (tokenId) {\n        updateCanvasTokenSelection(actorId, false, tokenId);\n      } else {\n        updateCanvasTokenSelection(actorId, false);\n      }\n    } else {\n      menu.selectedActors.add(uniqueId);\n      if (tokenId) {\n        updateCanvasTokenSelection(actorId, true, tokenId);\n      } else {\n        updateCanvasTokenSelection(actorId, true);\n      }\n    }\n    \n    setTimeout(() => {\n      menu._ignoreTokenControl = false;\n    }, 100);\n    \n    this.updateActorSelectionUI(uniqueId, menu);\n    this.updateSelectAllState(menu);\n    this.updateRequestTypesVisibilityNoRender(menu);\n    const showOptionsListOnHover = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag);\n    \n    // Show request types accordion if we have selected actors\n    const accordion = menu.element.querySelector('.request-types-accordion');\n    if (accordion) {\n      if (menu.selectedActors.size > 0 && showOptionsListOnHover) {\n        accordion.classList.add('hover-visible');\n      } else {\n        accordion.classList.remove('hover-visible');\n      }\n    }\n  }\n\n  /**\n   * Update the visual state of an actor element without re-rendering\n   * @param {string} actorId - Actor ID to update\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static updateActorSelectionUI(actorId, menu) {\n    const wrapperElement = menu.element.querySelector(`.actor.drag-wrapper[data-id=\"${actorId}\"]`);\n    if (!wrapperElement) return;\n    \n    const actorElement = wrapperElement.closest('.actor');\n    if (!actorElement) return;\n    \n    const checkbox = actorElement.querySelector('.actor-select');\n    const isSelected = menu.selectedActors.has(actorId);\n    \n    if (checkbox) {\n      checkbox.checked = isSelected;\n    }\n    \n    wrapperElement.classList.toggle('selected', isSelected);\n    wrapperElement.dataset.selected = isSelected.toString();\n  }\n\n  /**\n   * Update request types visibility based on actor selection\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static updateRequestTypesVisibility(menu) {\n    menu.render();\n  }\n\n  /**\n   * Update request types visibility without re-rendering\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static updateRequestTypesVisibilityNoRender(menu) {\n    const hasSelection = menu.selectedActors.size > 0;\n    const requestTypesContainer = menu.element.querySelector('.request-types');\n    \n    if (requestTypesContainer) {\n      // Only disable individual request items, not the container\n      const requestItems = requestTypesContainer.querySelectorAll('.request-type-item');\n      requestItems.forEach(item => {\n        item.classList.toggle('disabled', !hasSelection);\n      });\n      \n      const hasPlayerCharacter = Array.from(menu.selectedActors).some(uniqueId => {\n        const actor = getActorData(uniqueId);\n        return actor?.type === 'character';\n      });\n      \n      const hitDieItem = requestTypesContainer.querySelector('[data-id=\"HIT_DIE\"]');\n      if (hitDieItem) {\n        hitDieItem.style.display = hasPlayerCharacter ? '' : 'none';\n      }\n    }\n  }\n\n  /**\n   * Update select all checkbox state\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static updateSelectAllState(menu) {\n    const selectAllCheckbox = menu.element.querySelector('#flash5e-actors-all');\n    let selectedCount = 0;\n    let totalCount = 0;\n    \n    if (menu.currentTab === 'group') {\n      // For groups tab, count selected group members using the same logic as template preparation\n      const context = menu._lastPreparedContext || {};\n      const currentActors = context.groups || [];\n      const allMembers = [];\n      currentActors.forEach(groupActor => {\n        if (groupActor.isGroup && groupActor.members) {\n          allMembers.push(...groupActor.members);\n        }\n      });\n      totalCount = allMembers.length;\n      selectedCount = allMembers.filter(member => \n        menu.selectedActors.has(member.uniqueId)\n      ).length;\n    } else {\n      // For PC/NPC tabs, use the existing checkbox logic\n      const currentActors = menu.currentTab === 'pc' ? 'pc' : 'npc';\n      const checkboxes = menu.element.querySelectorAll(`.${currentActors}-actors .actor-item input[type=\"checkbox\"]`);\n      totalCount = checkboxes.length;\n      selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;\n    }\n    \n    selectAllCheckbox.checked = selectedCount > 0 && selectedCount === totalCount;\n    selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCount;\n  }\n\n  /**\n   * Create actor filter tooltip with filter options\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {HTMLElement} Tooltip element\n   */\n  static async createActorFilterTooltip(menu) {\n    // Load saved filter state from user flags\n    const savedFilters = game.user.getFlag(MODULE.ID, 'actorFilters') || {\n      inCombat: false,\n      visible: false,\n      removeDead: false\n    };\n\n    // Apply saved filters to menu\n    menu.actorFilters = savedFilters;\n\n    // Render template with filter data\n    const templatePath = 'modules/flash-rolls-5e/templates/actor-filter-tooltip.hbs';\n    const html = await renderTemplate(templatePath, {\n      filters: savedFilters\n    });\n\n    // Create tooltip element\n    const tooltipContainer = document.createElement('div');\n    tooltipContainer.innerHTML = html;\n    const tooltip = tooltipContainer.firstElementChild;\n\n    // Add event listeners for filter changes\n    tooltip.querySelectorAll('input[type=\"checkbox\"]').forEach(checkbox => {\n      checkbox.addEventListener('change', (event) => {\n        RollMenuStateManager.applyActorFilters(menu);\n      });\n    });\n\n    return tooltip;\n  }\n\n  /**\n   * Apply actor filters based on current filter settings\n   * @param {RollRequestsMenu} menu - Menu instance\n   */\n  static async applyActorFilters(menu) {\n    const tooltip = menu.element.querySelector('.actor-filter-tooltip');\n    if (!tooltip) return;\n\n    const filters = {\n      inCombat: tooltip.querySelector('[data-filter=\"inCombat\"]').checked,\n      visible: tooltip.querySelector('[data-filter=\"visible\"]').checked,\n      removeDead: tooltip.querySelector('[data-filter=\"removeDead\"]').checked\n    };\n    menu.actorFilters = filters;\n    await game.user.setFlag(MODULE.ID, 'actorFilters', filters);\n    menu.render();\n  }\n\n  /**\n   * Check if an actor meets the specified filter criteria\n   * @param {Actor} actor - The actor to check\n   * @param {Object} filters - Filter criteria\n   * @param {boolean} filters.inCombat - Show only actors in combat\n   * @param {boolean} filters.visible - Show only visible actors\n   * @param {boolean} filters.removeDead - Remove dead actors from the list\n   * @param {TokenDocument} [token] - Optional token document for token-specific checks\n   * @returns {boolean} True if actor meets all active filter criteria\n   */\n  static doesActorPassFilters(actor, filters, token = null) {\n    // If no filters are active, show all actors\n    if (!filters.inCombat && !filters.visible && !filters.removeDead) {\n      return true;\n    }\n\n    // Check each active filter - ALL must pass for actor to be included\n    if (filters.inCombat) {\n      const inCombat = token ? token.inCombat : actor.inCombat;\n      if (!inCombat) return false;\n    }\n\n    if (filters.visible) {\n      if (token) {\n        if (token.hidden) return false;\n      } else {\n        const tokens = actor.getActiveTokens();\n        const hasVisibleToken = tokens.some(token => !token.document.hidden);\n        if (!hasVisibleToken) return false;\n      }\n    }\n\n    if (filters.removeDead) {\n      // The actor passed in is already the correct one (token actor if available)\n      const hasDead = actor.effects.some(effect =>\n        effect.statuses?.has('dead') ||\n        effect.flags?.core?.statusId === 'dead'\n      );\n      if (hasDead) return false;\n    }\n\n    return true;\n  }\n}","import { MODULE, MODULE_ID } from '../../../constants/General.mjs';\nimport { LogUtil } from '../../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { buildRollTypes } from '../../helpers/Helpers.mjs';\nimport { RollMenuActorUtil } from '../../utils/RollMenuActorUtil.mjs';\nimport { ActorStatusManager } from '../ActorStatusManager.mjs';\nimport { RollMenuStatusManager } from './RollMenuStatusManager.mjs';\nimport { RollMenuStateManager } from './RollMenuStateManager.mjs';\n\n/**\n * Utility class for processing actors for the Roll Requests Menu\n */\nexport class RollMenuActorProcessor {\n\n  /**\n   * Process all actors and build context data for template rendering\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @param {Object} baseContext - Base context from ApplicationV2\n   * @returns {Object} Complete context object for template\n   */\n  static async prepareActorContext(menu, baseContext) {\n    const SETTINGS = getSettings();\n    const actors = game.actors.contents;\n    const pcActors = [];\n    const npcActors = [];\n    const groupActors = [];\n    const currentScene = game.scenes.active;\n    \n    for (const actor of actors) {\n      // Process group and encounter actors separately\n      if (actor.type === 'group' || actor.type === 'encounter') {\n        const groupEntries = await this.processGroupActor(actor, currentScene, menu);\n        groupActors.push(...groupEntries);\n        continue;\n      }\n      \n      if (actor.type !== 'character' && actor.type !== 'npc') continue;\n      \n      const isPlayerOwned = this.isPlayerOwnedActor(actor);\n      const actorEntries = await this.processActor(actor, currentScene, menu, isPlayerOwned);\n      \n      if (isPlayerOwned) {\n        pcActors.push(...actorEntries);\n      } else {\n        npcActors.push(...actorEntries);\n      }\n    }\n\n    // Apply actor filters if any are active\n    const actorFilters = menu.actorFilters || {};\n    if (actorFilters.inCombat || actorFilters.visible || actorFilters.removeDead) {\n      const filteredPCActors = pcActors.filter(actorData => {\n        const token = actorData.tokenId ? currentScene?.tokens.get(actorData.tokenId) : null;\n        const actor = token?.actor || game.actors.get(actorData.id);\n        if (!actor) return false;\n\n        return RollMenuStateManager.doesActorPassFilters(actor, actorFilters, token);\n      });\n      pcActors.length = 0;\n      pcActors.push(...filteredPCActors);\n\n      const filteredNPCActors = npcActors.filter(actorData => {\n        const token = actorData.tokenId ? currentScene?.tokens.get(actorData.tokenId) : null;\n        // Use token actor if available, otherwise base actor\n        const actor = token?.actor || game.actors.get(actorData.id);\n        if (!actor) return false;\n\n        return RollMenuStateManager.doesActorPassFilters(actor, actorFilters, token);\n      });\n      npcActors.length = 0;\n      npcActors.push(...filteredNPCActors);\n\n      const filteredGroupActors = groupActors.filter(groupData => {\n        if (groupData.isGroup) {\n          // Status-based filters (like removeDead) don't apply to group containers\n          const groupActor = game.actors.get(groupData.id);\n          const groupToken = groupData.tokenId ? currentScene?.tokens.get(groupData.tokenId) : null;\n\n          // Create a filter object without status-based filters for the group container\n          const groupFilters = {\n            inCombat: actorFilters.inCombat,\n            visible: actorFilters.visible,\n            removeDead: false // Groups don't have death status\n          };\n\n          const groupPasses = groupActor && RollMenuStateManager.doesActorPassFilters(groupActor, groupFilters, groupToken);\n\n          return groupPasses || (groupData.members && groupData.members.length > 0);\n        } else {\n          // Regular actor processing for non-group entries\n          const actor = game.actors.get(groupData.id);\n          if (!actor) return false;\n\n          // Get token document if this is a token-based entry\n          const token = groupData.tokenId ? currentScene?.tokens.get(groupData.tokenId) : null;\n          return RollMenuStateManager.doesActorPassFilters(actor, actorFilters, token);\n        }\n      });\n      groupActors.length = 0;\n      groupActors.push(...filteredGroupActors);\n    }\n\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const skipRollDialog = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    const showOnlyPCsWithToken = SettingsUtil.get(SETTINGS.showOnlyPCsWithToken.tag);\n    const showOptionsListOnHover = SettingsUtil.get(SETTINGS.showOptionsListOnHover.tag) ?? SETTINGS.showOptionsListOnHover.default;\n    LogUtil.log('Template context showOptionsListOnHover:', [showOptionsListOnHover, typeof showOptionsListOnHover, 'tag:', SETTINGS.showOptionsListOnHover.tag]);\n    \n    const currentActors = menu.currentTab === 'pc' ? pcActors : \n                          menu.currentTab === 'npc' ? npcActors : \n                          groupActors;\n    let selectAllOn = false;\n    if (currentActors.length > 0) {\n      if (menu.currentTab === 'group') {\n        // For groups tab, check if all visible group members are selected\n        const allMembers = [];\n        currentActors.forEach(groupActor => {\n          if (groupActor.isGroup && groupActor.members) {\n            allMembers.push(...groupActor.members);\n          }\n        });\n        selectAllOn = allMembers.length > 0 && \n          allMembers.every(member => menu.selectedActors.has(member.uniqueId));\n      } else {\n        // For PC/NPC tabs, use the original logic\n        selectAllOn = currentActors.every(actor => menu.selectedActors.has(actor.uniqueId));\n      }\n    }\n    \n    const requestTypes = this.buildRequestTypes(menu);\n    const rollTypes = buildRollTypes(menu.selectedRequestType, menu.selectedActors);\n    const statusEffects = RollMenuStatusManager.getStatusEffectsForTemplate();\n    \n    return {\n      ...baseContext,\n      actors: menu.currentTab === 'group' ? [] : currentActors,\n      groups: menu.currentTab === 'group' ? currentActors : [],\n      currentTab: menu.currentTab,\n      isPCTab: menu.currentTab === 'pc',\n      isNPCTab: menu.currentTab === 'npc',\n      isGroupTab: menu.currentTab === 'group',\n      selectedTab: menu.currentTab,\n      selectedSubmenu: menu.selectedSubmenu,\n      rollRequestsEnabled,\n      skipRollDialog,\n      groupRollsMsgEnabled,\n      showOptionsListOnHover,\n      selectAllOn,\n      hasSelectedActors: menu.selectedActors.size > 0,\n      requestTypes,\n      rollTypes,\n      statusEffects,\n      showNames: true,\n      actorsLocked: menu.isLocked,\n      optionsExpanded: menu.optionsExpanded,\n      isGM: game.user.isGM,\n      isCompact: SettingsUtil.get(SETTINGS.compactMode.tag)\n    };\n  }\n\n  /**\n   * Check if an actor is player-owned\n   * @param {Actor} actor - The actor to check\n   * @returns {boolean} True if player-owned\n   */\n  static isPlayerOwnedActor(actor) {\n    return Object.entries(actor.ownership)\n      .some(([userId, level]) => {\n        const user = game.users.get(userId);\n        return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n      });\n  }\n\n  /**\n   * Process a single actor and return array of actor entries (including tokens)\n   * @param {Actor} actor - The actor to process\n   * @param {Scene} currentScene - Current active scene\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @param {boolean} isPlayerOwned - Whether the actor is player-owned\n   * @returns {Array} Array of actor data entries\n   */\n  static async processActor(actor, currentScene, menu, isPlayerOwned) {\n    if (ActorStatusManager.isBlocked(actor)) {\n      return [];\n    }\n\n    const SETTINGS = getSettings();\n    const showOnlyPCsWithToken = SettingsUtil.get(SETTINGS.showOnlyPCsWithToken?.tag);\n    const isFavorite = ActorStatusManager.isFavorite(actor);\n    const tokensInScene = currentScene?.tokens.filter(token => token.actorId === actor.id) || [];\n    \n    const actorEntries = [];\n\n    if (isPlayerOwned) {\n      if (isFavorite) {\n        actorEntries.push(...this.processFavoriteActor(actor, tokensInScene, menu));\n      } else if (showOnlyPCsWithToken) {\n        actorEntries.push(...this.processTokenOnlyActor(actor, tokensInScene, menu));\n      } else {\n        actorEntries.push(...this.processRegularActor(actor, tokensInScene, menu));\n      }\n    } else {\n      if (isFavorite) {\n        actorEntries.push(...this.processFavoriteActor(actor, tokensInScene, menu));\n      } else {\n        actorEntries.push(...this.processTokenOnlyActor(actor, tokensInScene, menu));\n      }\n    }\n\n    return actorEntries;\n  }\n\n  /**\n   * Process a favorite actor (always show, with or without tokens)\n   * @param {Actor} actor - The actor\n   * @param {TokenDocument[]} tokensInScene - Tokens for this actor in current scene\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {Array} Array of actor data entries\n   */\n  static processFavoriteActor(actor, tokensInScene, menu) {\n    const actorEntries = [];\n    \n    if (tokensInScene.length > 0) {\n      tokensInScene.forEach(tokenDoc => {\n        const actorData = this.createActorData(actor, tokenDoc, menu);\n        actorData.isFavorite = true;\n        actorEntries.push(actorData);\n      });\n    } else {\n      const actorData = this.createActorData(actor, null, menu);\n      actorData.isFavorite = true;\n      actorEntries.push(actorData);\n    }\n    \n    return actorEntries;\n  }\n\n  /**\n   * Process an actor that only shows if it has tokens\n   * @param {Actor} actor - The actor\n   * @param {TokenDocument[]} tokensInScene - Tokens for this actor in current scene\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {Array} Array of actor data entries\n   */\n  static processTokenOnlyActor(actor, tokensInScene, menu) {\n    const actorEntries = [];\n    \n    if (tokensInScene.length > 0) {\n      tokensInScene.forEach(tokenDoc => {\n        const actorData = this.createActorData(actor, tokenDoc, menu);\n        actorEntries.push(actorData);\n      });\n    }\n    \n    return actorEntries;\n  }\n\n  /**\n   * Process a regular actor (show both with and without tokens)\n   * @param {Actor} actor - The actor\n   * @param {TokenDocument[]} tokensInScene - Tokens for this actor in current scene\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {Array} Array of actor data entries\n   */\n  static processRegularActor(actor, tokensInScene, menu) {\n    const actorEntries = [];\n    \n    if (tokensInScene.length > 0) {\n      tokensInScene.forEach(tokenDoc => {\n        const actorData = this.createActorData(actor, tokenDoc, menu);\n        actorEntries.push(actorData);\n      });\n    } else {\n      const actorData = this.createActorData(actor, null, menu);\n      actorEntries.push(actorData);\n    }\n    \n    return actorEntries;\n  }\n\n  /**\n   * Create actor data object for template rendering\n   * @param {Actor} actor - The actor\n   * @param {TokenDocument|null} token - The token document, if any\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {Object} Actor data object\n   */\n  static createActorData(actor, token, menu) {\n    // TokenDocument.actor gives us the synthetic token actor with its own HP/effects\n    const actorForStats = token?.actor || actor;\n    const hpData = RollMenuActorUtil.getActorHPData(actorForStats);\n\n    return {\n      id: actor.id,\n      uuid: actor.uuid,\n      name: token ? token.name : actor.name,\n      img: actor.img,\n      selected: menu.selectedActors.has(token?.id || actor.id),\n      crlngnStats: RollMenuActorUtil.getActorStats(actorForStats),\n      hpPercent: hpData.hpPercent,\n      hpColor: hpData.hpColor,\n      tokenId: token?.id || null,\n      isToken: !!token,\n      uniqueId: token?.id || actor.id\n    };\n  }\n\n  /**\n   * Process a group or encounter actor for display in the Flash Rolls menu.\n   *\n   * This method converts a D&D 5e group/encounter actor into Flash Rolls menu data.\n   * The result is an array of group data objects that can be displayed in the Flash Rolls menu,\n   * with each group containing its member actors properly associated with specific tokens.\n   *\n   * @param {Actor} actor - The group/encounter actor to process\n   * @param {Scene} currentScene - Current active scene\n   * @param {RollRequestsMenu} menu - Menu instance for state and settings\n   * @returns {Array} Array of group actor data objects with members for menu display\n   */\n  static async processGroupActor(actor, currentScene, menu) {\n    if (ActorStatusManager.isBlocked(actor)) {\n      return [];\n    }\n\n    const SETTINGS = getSettings();\n    const showOnlyPCsWithToken = SettingsUtil.get(SETTINGS.showOnlyPCsWithToken?.tag);\n    \n    const tokensInScene = currentScene?.tokens.filter(token => token.actorId === actor.id) || [];\n    const groupEntries = [];\n\n    const members = [];\n    let hasAnyMemberTokens = false;\n    const actorFilters = menu.actorFilters || {};\n    const hasActiveFilters = actorFilters.inCombat || actorFilters.visible || actorFilters.removeDead;\n\n    if (actor.type === 'group') {\n      // Group type: members have direct actor references\n      // Check if we have stored token associations\n      const tokenAssociations = actor.getFlag(MODULE_ID, 'tokenAssociations') || {};\n\n      for (const member of actor.system.members || []) {\n        if (member.actor && !ActorStatusManager.isBlocked(member.actor)) {\n          const memberActorId = member.actor.id;\n          const associatedTokenIds = tokenAssociations[memberActorId] || [];\n\n          if (associatedTokenIds.length > 0) {\n            // Use specific tokens from associations by finding them in current scene\n            for (const tokenId of associatedTokenIds) {\n              const tokenDoc = currentScene?.tokens.get(tokenId);\n              if (tokenDoc && tokenDoc.actorId === member.actor.id) {\n                // Apply filters if active\n                if (hasActiveFilters) {\n                  const actorToCheck = tokenDoc.actor || member.actor;\n                  if (!RollMenuStateManager.doesActorPassFilters(actorToCheck, actorFilters, tokenDoc)) {\n                    continue; // Skip this member if it doesn't pass filters\n                  }\n                }\n                hasAnyMemberTokens = true;\n                const memberData = this.createActorData(member.actor, tokenDoc, menu);\n                members.push(memberData);\n              } else {\n                // Token not found in current scene, use base actor\n                // Apply filters if active\n                if (hasActiveFilters) {\n                  if (!RollMenuStateManager.doesActorPassFilters(member.actor, actorFilters, null)) {\n                    continue; // Skip this member if it doesn't pass filters\n                  }\n                }\n                const memberData = this.createActorData(member.actor, null, menu);\n                members.push(memberData);\n              }\n            }\n          } else {\n            // No token associations, fall back to original behavior\n            const memberTokens = currentScene?.tokens.filter(token => token.actorId === member.actor.id) || [];\n\n            if (memberTokens.length > 0) {\n              hasAnyMemberTokens = true;\n              memberTokens.forEach(tokenDoc => {\n                // Apply filters if active\n                if (hasActiveFilters) {\n                  const actorToCheck = tokenDoc.actor || member.actor;\n                  if (!RollMenuStateManager.doesActorPassFilters(actorToCheck, actorFilters, tokenDoc)) {\n                    return; // Skip this member if it doesn't pass filters\n                  }\n                }\n                const memberData = this.createActorData(member.actor, tokenDoc, menu);\n                members.push(memberData);\n              });\n            } else {\n              // Apply filters if active\n              if (hasActiveFilters) {\n                if (!RollMenuStateManager.doesActorPassFilters(member.actor, actorFilters, null)) {\n                  continue; // Skip this member if it doesn't pass filters\n                }\n              }\n              const memberData = this.createActorData(member.actor, null, menu);\n              members.push(memberData);\n            }\n          }\n        }\n      }\n    } else if (actor.type === 'encounter') {\n      // Encounter type: members have UUIDs and quantities\n      // Check if we have stored token associations\n      const tokenAssociations = actor.getFlag(MODULE_ID, 'tokenAssociations') || {};\n\n      for (const member of actor.system.members || []) {\n        try {\n          const memberActor = await fromUuid(member.uuid);\n          if (memberActor && !ActorStatusManager.isBlocked(memberActor)) {\n            const memberActorId = memberActor.id;\n            const associatedTokenIds = tokenAssociations[memberActorId] || [];\n\n            if (associatedTokenIds.length > 0) {\n              // Use specific tokens from associations by finding them in current scene\n              for (const tokenId of associatedTokenIds) {\n                const tokenDoc = currentScene?.tokens.get(tokenId);\n                if (tokenDoc && tokenDoc.actorId === memberActor.id) {\n                  if (hasActiveFilters) {\n                    const actorToCheck = tokenDoc.actor || memberActor;\n                    if (!RollMenuStateManager.doesActorPassFilters(actorToCheck, actorFilters, tokenDoc)) {\n                      continue; \n                    }\n                  }\n                  hasAnyMemberTokens = true;\n                  const memberData = this.createActorData(memberActor, tokenDoc, menu);\n                  memberData.quantity = 1; // Each specific token has quantity 1\n                  members.push(memberData);\n                } else {\n                  // Token not found in current scene, use base actor\n                  if (hasActiveFilters) {\n                    if (!RollMenuStateManager.doesActorPassFilters(memberActor, actorFilters, null)) {\n                      continue; \n                    }\n                  }\n                  const memberData = this.createActorData(memberActor, null, menu);\n                  memberData.quantity = 1;\n                  members.push(memberData);\n                }\n              }\n            } else {\n              // No token associations, fall back to original behavior\n              const memberTokens = currentScene?.tokens.filter(token => token.actorId === memberActor.id) || [];\n\n              if (memberTokens.length > 0) {\n                hasAnyMemberTokens = true;\n                // Create entries for each token\n                memberTokens.forEach(tokenDoc => {\n                  // Apply filters if active\n                  if (hasActiveFilters) {\n                    const actorToCheck = tokenDoc.actor || memberActor;\n                    if (!RollMenuStateManager.doesActorPassFilters(actorToCheck, actorFilters, tokenDoc)) {\n                      return; // Skip this member if it doesn't pass filters\n                    }\n                  }\n                  const memberData = this.createActorData(memberActor, tokenDoc, menu);\n                  memberData.quantity = member.quantity?.value || 1;\n                  members.push(memberData);\n                });\n              } else {\n                // No tokens, create base actor entry\n                // Apply filters if active\n                if (hasActiveFilters) {\n                  if (!RollMenuStateManager.doesActorPassFilters(memberActor, actorFilters, null)) {\n                    continue; // Skip this member if it doesn't pass filters\n                  }\n                }\n                const memberData = this.createActorData(memberActor, null, menu);\n                memberData.quantity = member.quantity?.value || 1;\n                members.push(memberData);\n              }\n            }\n          }\n        } catch (error) {\n          LogUtil.log(`Failed to resolve member UUID: ${member.uuid}`, [error]);\n        }\n      }\n    }\n    \n    // Check if group should be filtered out based on showOnlyPCsWithToken setting\n    if (showOnlyPCsWithToken) {\n      const groupHasTokens = tokensInScene.length > 0;\n      if (!groupHasTokens && !hasAnyMemberTokens) {\n        // Group has no tokens and no members have tokens, filter it out\n        return [];\n      }\n    }\n    \n    // Process group similar to regular actors - create entries for tokens if they exist\n    if (tokensInScene.length > 0) {\n      tokensInScene.forEach(tokenDoc => {\n        const groupData = this.createActorData(actor, tokenDoc, menu);\n        groupData.members = members;\n        groupData.isGroup = true;\n        groupData.isExpanded = menu.groupExpansionStates?.[actor.id] ?? false;\n        groupData.memberImages = members.slice(0, 4).map(m => m.img);\n        \n        // Calculate group selection state: true (all), false (none), partial (some)\n        const selectedMembers = members.filter(member => menu.selectedActors.has(member.uniqueId));\n        if (selectedMembers.length === 0) {\n          groupData.selected = 'false';\n        } else if (selectedMembers.length === members.length) {\n          groupData.selected = 'true';\n        } else {\n          groupData.selected = 'partial';\n        }\n        \n        groupEntries.push(groupData);\n      });\n    } else {\n      // No tokens in scene, create base group entry\n      const groupData = this.createActorData(actor, null, menu);\n      groupData.members = members;\n      groupData.isGroup = true;\n      groupData.isExpanded = menu.groupExpansionStates?.[actor.id] ?? false;\n      groupData.memberImages = members.slice(0, 4).map(m => m.img);\n      \n      // Calculate group selection state: true (all), false (none), partial (some)\n      const selectedMembers = members.filter(member => menu.selectedActors.has(member.uniqueId));\n      if (selectedMembers.length === 0) {\n        groupData.selected = 'false';\n      } else if (selectedMembers.length === members.length) {\n        groupData.selected = 'true';\n      } else {\n        groupData.selected = 'partial';\n      }\n      \n      groupEntries.push(groupData);\n    }\n    \n    return groupEntries;\n  }\n\n  /**\n   * Build request types for the accordion\n   * @param {RollRequestsMenu} menu - Menu instance\n   * @returns {Array} Array of request type objects\n   */\n  static buildRequestTypes(menu) {\n    const requestTypes = [];\n    \n    for (const [key, option] of Object.entries(MODULE.ROLL_REQUEST_OPTIONS)) {\n      const requestType = {\n        id: key,\n        name: game.i18n.localize(`FLASH_ROLLS.rollTypes.${option.name}`) || option.label,\n        rollable: option.subList == null,\n        hasSubList: !!option.subList,\n        selected: menu.selectedRequestType === key, \n        expanded: menu.accordionStates[key] ?? false,\n        subItems: []\n      };\n      \n      if (option.subList) {\n        requestType.subItems = buildRollTypes(key, menu.selectedActors);\n      }\n      \n      requestTypes.push(requestType);\n    }\n    \n    return requestTypes;\n  }\n}","import { ROLL_TYPES } from '../../../constants/General.mjs';\nimport { getSettings } from '../../../constants/Settings.mjs';\nimport { LogUtil } from '../../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../../utils/SettingsUtil.mjs';\nimport { delay, NotificationManager } from '../../helpers/Helpers.mjs';\nimport { RollHandlers } from '../../handlers/RollHandlers.mjs';\nimport { RollHelpers } from '../../helpers/RollHelpers.mjs';\n\n/**\n * Utility class for executing GM rolls and local roll handling\n */\nexport class RollMenuExecutor {\n\n  /**\n   * Handle rolling for NPC actors locally\n   * @param {Actor[]} actors \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  static async handleGMRolls(actors, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('RollMenuExecutor.handleGMRolls', [actors, requestType, rollKey, rollProcessConfig]);\n    \n    for (const actor of actors) {\n      await this.initiateRoll(actor, requestType, rollKey, rollProcessConfig);\n      await delay(100);\n    }\n  }\n\n  /**\n   * Handle GM rolls with token information preserved\n   * @param {Array} actorEntries - Array of actor entries with unique IDs\n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig \n   */\n  static async handleGMRollsWithTokens(actorEntries, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('RollMenuExecutor.handleGMRollsWithTokens', [actorEntries, requestType, rollKey, rollProcessConfig]);\n    \n    for (const entry of actorEntries) {\n      if (entry.tokenId) {\n        const token = canvas.tokens?.get(entry.tokenId) || game.scenes.active?.tokens.get(entry.tokenId);\n        if (token) {\n          await this.initiateRollForToken(entry.actor, token, requestType, rollKey, rollProcessConfig);\n        } else {\n          await this.initiateRoll(entry.actor, requestType, rollKey, rollProcessConfig);\n        }\n      } else {\n        await this.initiateRoll(entry.actor, requestType, rollKey, rollProcessConfig);\n      }\n      await delay(100);\n    }\n  }\n\n  /**\n   * Execute local roll for a GM actor with token context\n   * @param {Actor} actor \n   * @param {Token} token \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  static async initiateRollForToken(actor, token, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('RollMenuExecutor.initiateRollForToken', [actor.name, token.name, requestType, rollKey, rollProcessConfig]);\n    \n    const wasControlled = token.controlled;\n    if (!wasControlled) {\n      token.control({ releaseOthers: false });\n    }\n    \n    try {\n      await this.initiateRoll(actor, requestType, rollKey, rollProcessConfig);\n    } finally {\n      // Restore original control state\n      if (!wasControlled) {\n        token.release();\n      }\n    }\n  }\n\n  /**\n   * Execute local roll for a GM actor\n   * @param {Actor} actor \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  static async initiateRoll(actor, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('RollMenuExecutor.initiateRoll', [actor, requestType, rollKey, rollProcessConfig]);\n    \n    try {\n      const normalizedType = requestType.toLowerCase();\n      let actualRollKey = rollKey;\n      \n      if (normalizedType === ROLL_TYPES.HIT_DIE) {\n        const hdData = actor.system.attributes.hd;\n        if(hdData.value > 0){\n          actualRollKey = hdData.largestAvailable;\n        }\n        if (!actualRollKey) {\n          LogUtil.warn('RollMenuExecutor.initiateRoll - No hit dice available after orchestration refill', [actor.name]);\n          NotificationManager.notify('warn', game.i18n.format(\"FLASH_ROLLS.notifications.noHitDice\", { \n            actor: actor.name \n          }) || `No hit dice available for ${actor.name}`);\n          return;\n        }\n      }\n      \n      const requestData = {\n        rollKey: actualRollKey,\n        groupRollId: rollProcessConfig.groupRollId,\n        config: {\n          ...rollProcessConfig,\n          rollMode: rollProcessConfig.rollMode || game.settings.get(\"core\", \"rollMode\"),\n          advantage: rollProcessConfig.advantage || false,\n          disadvantage: rollProcessConfig.disadvantage || false,\n          target: rollProcessConfig.target\n        }\n      };\n      \n      const dialogConfig = {\n        configure: !rollProcessConfig.fastForward && !rollProcessConfig.skipRollDialog,\n        isRollRequest: true\n      };\n      \n      // Determine roll mode based on actor ownership and settings\n      let finalRollMode = rollProcessConfig.rollMode || game.settings.get(\"core\", \"rollMode\");\n      \n      // Check if we should use public roll mode for player-owned actors\n      const SETTINGS = getSettings();\n      const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n      const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag) === true;\n      \n      // Only adjust roll mode for individual messages (not group rolls)\n      if ((!groupRollsMsgEnabled || !rollProcessConfig.groupRollId) && !rollProcessConfig.rollMode) {\n        if (isPublicRollsOn && actor && RollHelpers.isPlayerOwned(actor)) {\n          finalRollMode = CONST.DICE_ROLL_MODES.PUBLIC;\n        }\n      }\n      \n      const messageConfig = {\n        rollMode: finalRollMode,\n        create: rollProcessConfig.chatMessage !== false,\n        isRollRequest: true  // Mark this as a roll request to prevent re-interception\n      };\n      \n      const rollConfig = rollProcessConfig.rolls?.[0] || {};\n      \n      LogUtil.log('RollMenuExecutor.initiateRoll - rollConfig before handler', [\n        'parts:', rollConfig.parts,\n        'data:', rollConfig.data,\n        'rollProcessConfig:', rollProcessConfig\n      ]);\n      \n      const handler = RollHandlers[normalizedType];\n      if (handler) {\n        await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n      } else {\n        NotificationManager.notify('warn', `Unknown roll type: ${requestType}`);\n      }\n    } catch (error) {\n      LogUtil.error('RollMenuExecutor.initiateRoll error', [error]);\n      NotificationManager.notify('error', game.i18n.format(\"FLASH_ROLLS.notifications.rollError\", { \n        actor: actor.name \n      }));\n    }\n  }\n}","import { MODULE, MODULE_ID, ROLL_TYPES } from '../../constants/General.mjs';\nimport { HOOKS_CORE } from '../../constants/Hooks.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SocketUtil } from '../utils/SocketUtil.mjs';\nimport { ActivityManager } from '../managers/ActivityManager.mjs';\nimport { SidebarController } from '../managers/SidebarController.mjs';\nimport { getPlayerOwner, isPlayerOwned, hasTokenInScene, updateCanvasTokenSelection, delay, buildRollTypes, NotificationManager, filterActorsForDeathSaves, categorizeActorsByOwnership, adjustMenuOffset, getActorData } from '../helpers/Helpers.mjs';\nimport { RollHandlers } from '../handlers/RollHandlers.mjs';\nimport { RollHelpers } from '../helpers/RollHelpers.mjs';\nimport { ensureCombatForInitiative, filterActorsForInitiative } from '../helpers/RollValidationHelpers.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { ModuleHelpers } from '../helpers/ModuleHelpers.mjs';\nimport { ChatMessageManager } from '../managers/ChatMessageManager.mjs';\nimport { RollMenuActorUtil } from '../utils/RollMenuActorUtil.mjs';\nimport { RollMenuConfig } from '../managers/roll-menu/RollMenuConfig.mjs';\nimport { RollMenuDragManager } from '../managers/roll-menu/RollMenuDragManager.mjs';\nimport { ActorStatusManager } from '../managers/ActorStatusManager.mjs';\nimport { ActorDragUtil } from '../utils/ActorDragUtil.mjs';\nimport { ActorDropUtil } from '../utils/ActorDropUtil.mjs';\nimport { RollMenuEventManager } from '../managers/roll-menu/RollMenuEventManager.mjs';\nimport { RollMenuOrchestrator } from '../managers/roll-menu/RollMenuOrchestrator.mjs';\nimport { RollMenuActorProcessor } from '../managers/roll-menu/RollMenuActorProcessor.mjs';\nimport { RollMenuExecutor } from '../managers/roll-menu/RollMenuExecutor.mjs';\nimport { RollMenuStateManager } from '../managers/roll-menu/RollMenuStateManager.mjs';\nimport { RollMenuStatusManager } from '../managers/roll-menu/RollMenuStatusManager.mjs';\nimport { ModuleSettingsMenu } from '../ui/dialogs/ModuleSettingsMenu.mjs';\nimport { IconLayoutUtil } from '../utils/IconLayoutUtil.mjs';\n    \n\n/**\n * Roll Requests Menu Application\n * Extends Foundry's ApplicationV2 with Handlebars support to provide a menu interface for GMs to request rolls from players\n */\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\nexport default class RollRequestsMenu extends HandlebarsApplicationMixin(ApplicationV2) {\n  /**\n   * Singleton instance of the menu\n   * @type {RollRequestsMenu|null}\n   */\n  static #instance = null;\n\n  /**\n   * Debounce timer for refresh operations\n   * @type {number|null}\n   */\n  static #refreshDebounceTimer = null;\n\n  /**\n   * Debounce delay in milliseconds\n   * @type {number}\n   */\n  static #REFRESH_DEBOUNCE_DELAY = 250;\n\n  constructor(options = {}) {\n    LogUtil.log('RollRequestsMenu.constructor', [options]);\n    super(options);\n    \n    this.selectedActors = new Set();\n    this.currentTab = 'pc';\n    this.selectedSubmenu = 'request-types';\n    this.selectedRequestType = null;\n    this.isLocked = false; \n    this.optionsExpanded = game.user.getFlag(MODULE.ID, 'menuOptionsExpanded') ?? false;\n    this.accordionStates = game.user.getFlag(MODULE.ID, 'menuAccordionStates') ?? {};\n    this.groupExpansionStates = game.user.getFlag(MODULE.ID, 'groupExpansionStates') ?? {};\n    this.isSearchFocused = game.user.getFlag('flash-rolls-5e', 'searchFocused') ?? false;\n    this.actorFilters = game.user.getFlag(MODULE.ID, 'actorFilters') ?? {\n      inCombat: false,\n      visible: false,\n      removeDead: false\n    };\n    \n    this.isDragging = false;\n    this.isCustomPosition = false;\n    this.customPosition = RollMenuDragManager.loadCustomPosition();\n    \n    this._initializeFromSelectedTokens();\n  }\n\n  static get DEFAULT_OPTIONS() {\n    SettingsUtil.updateColorScheme();\n    const classes = ['flash-rolls-menu', 'themed'];\n    if (SettingsUtil.coreColorScheme) {\n      classes.push(`theme-${SettingsUtil.coreColorScheme}`);\n    }\n    return {\n      id: 'flash-rolls-menu',\n      classes,\n      tag: 'div',\n      window: {\n        frame: false,\n        resizable: false,\n        minimizable: false\n      },\n      position: {},\n      dragDrop: [\n        {\n          dropSelector: '.actor-list'\n        }\n      ]\n    };\n  }\n\n  static PARTS = {\n    main: {\n      template: `modules/${MODULE.ID}/templates/requests-menus.hbs`\n    }\n  };  \n  \n  async _prepareContext(options) {\n    const context = await super._prepareContext(options);\n    const preparedContext = await RollMenuActorProcessor.prepareActorContext(this, context);\n\n    // Add layout information to context\n    const SETTINGS = getSettings();\n    preparedContext.menuLayout = SettingsUtil.get(SETTINGS.menuLayout.tag);\n\n    // Add icon data for dynamic rendering\n    preparedContext.enabledModuleIcons = IconLayoutUtil.getEnabledIcons('moduleActions');\n    preparedContext.enabledActorIcons = IconLayoutUtil.getEnabledIcons('actorActions');\n    preparedContext.iconConfigs = IconLayoutUtil.getIconConfigurations();\n\n    this._lastPreparedContext = preparedContext;\n    return preparedContext;\n  }\n\n\n  /**\n   * Override _renderFrame to control where the element is inserted in the DOM\n   * @override\n   */\n  async _renderFrame(options) {\n    const frame = await super._renderFrame(options);\n    \n    const customPosition = this.customPosition || RollMenuDragManager.loadCustomPosition();\n    if (customPosition?.isCustom) {\n      this.isCustomPosition = true;\n      this.customPosition = customPosition;\n    }\n    \n    const chatNotifications = document.querySelector('#chat-notifications');\n    if (chatNotifications && frame) {\n      chatNotifications.insertBefore(frame, chatNotifications.firstChild);\n    }\n    \n    return frame;\n  }\n\n  /**\n   * Called after the application is rendered\n   * Verifies if roll controls are visible and adjusts the offset of the menu\n   */\n  _onRender(context, options) {\n    super._onRender(context, options);\n\n    const menu = document.querySelector(\"#flash-rolls-menu\");\n    if(menu){\n      const SETTINGS = getSettings();\n      const isCompactMode = SettingsUtil.get(SETTINGS.compactMode.tag);\n      if(isCompactMode){\n        menu.classList.add(\"compact\");\n      }else{\n        menu.classList.remove(\"compact\");\n      }\n      \n      const menuLayout = SettingsUtil.get(SETTINGS.menuLayout.tag);\n      menu.setAttribute(\"data-layout\", menuLayout);\n    }\n    \n    RollMenuDragManager.applyCustomPosition(this, this.customPosition);\n    if (this._dragDrop && this._dragDrop.length > 0) {\n      this._dragDrop.forEach((handler, index) => {\n        LogUtil.log(`_onRender - DragDrop handler ${index}:`, [handler, handler.dropSelector, handler.callbacks]);\n      });\n    }\n    \n    const dropZones = this.element.querySelectorAll('.actor-list');\n    \n    dropZones.forEach((zone, index) => {      \n      zone.removeEventListener('dragover', this._boundDragOver);\n      zone.removeEventListener('drop', this._boundDrop);\n      zone.removeEventListener('dragenter', this._boundDragEnter);\n      zone.removeEventListener('dragleave', this._boundDragLeave);\n      \n      this._boundDragOver = (e) => {\n        this._onDragOver(e);\n      };\n      \n      this._boundDrop = (e) => {\n        this._onDrop(e);\n      };\n      \n      this._boundDragEnter = (e) => {\n        e.preventDefault();\n      };\n      \n      this._boundDragLeave = (e) => {\n        ActorDropUtil.handleDragLeave(e);\n      };\n      \n      zone.addEventListener('dragover', this._boundDragOver);\n      zone.addEventListener('drop', this._boundDrop);\n      zone.addEventListener('dragenter', this._boundDragEnter);\n      zone.addEventListener('dragleave', this._boundDragLeave);\n    });\n\n    adjustMenuOffset();\n    \n    if (this.optionsExpanded) {\n      const optionsToggle = this.element.querySelector('.options-toggle');\n      const optionsElement = this.element.querySelector('li.options');\n      const toggleBtn = this.element.querySelector('.options-toggle-btn');\n      \n      optionsToggle?.classList.add('expanded');\n      optionsElement?.classList.add('expanded');\n    }\n    \n    this._tokenControlHook = Hooks.on(HOOKS_CORE.CONTROL_TOKEN, this._onTokenControlChange.bind(this));\n    this._updateItemHook = Hooks.on(HOOKS_CORE.UPDATE_ITEM, this._onItemUpdate.bind(this));\n    this._createItemHook = Hooks.on(HOOKS_CORE.CREATE_ITEM, this._onItemUpdate.bind(this));\n    this._deleteItemHook = Hooks.on(HOOKS_CORE.DELETE_ITEM, this._onItemUpdate.bind(this));\n    \n    ActorDragUtil.initializeActorDrag(this);\n    this._updateRequestTypesVisibilityNoRender();\n\n    RollMenuEventManager.attachListeners(this, this.element);\n  }\n\n  /**\n   * Handle token control changes\n   */\n  _onTokenControlChange(token, controlled) {\n    if (!this.rendered) return;\n    \n    if (this._ignoreTokenControl) return;\n    if (this._tokenUpdateTimeout) {\n      clearTimeout(this._tokenUpdateTimeout);\n    }\n    \n    this._tokenUpdateTimeout = setTimeout(() => {\n      const previousSelection = new Set(this.selectedActors);\n      \n      this._initializeFromSelectedTokens();\n      \n      const allActorIds = new Set([...previousSelection, ...this.selectedActors]);\n      for (const actorId of allActorIds) {\n        this._updateActorSelectionUI(actorId);\n      }\n      \n      // Update group selection UI when token selection changes\n      this._updateGroupSelectionUI();\n      \n      this._updateSelectAllState();\n      this._updateRequestTypesVisibilityNoRender();\n      \n      this._tokenUpdateTimeout = null;\n    }, 100);\n  }\n  \n  /**\n   * Handle item updates on actors\n   * Re-renders the menu if the item affects character AC\n   */\n  _onItemUpdate(item, changes, options, userId) {\n    if (!this.rendered) return;\n    \n    const affectsAC = item.type === 'equipment' || \n                      changes.system?.equipped !== undefined ||\n                      changes.system?.attunement !== undefined;\n    if (!affectsAC) return;\n\n    const actor = item.parent;\n    if (!actor || actor.documentName !== 'Actor') return;\n    \n    const currentTab = this.currentTab;\n    const isPlayerOwned = Object.entries(actor.ownership)\n      .some(([uid, level]) => {\n        const user = game.users.get(uid);\n        return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n      });\n    \n    const shouldUpdate = (currentTab === 'pc' && isPlayerOwned) || \n                         (currentTab === 'npc' && !isPlayerOwned && hasTokenInScene(actor)) ||\n                         (currentTab === 'group');\n    \n    if (shouldUpdate) {\n      if (this._itemUpdateTimeout) {\n        clearTimeout(this._itemUpdateTimeout);\n      }\n      \n      this._itemUpdateTimeout = setTimeout(() => {\n        this.render();\n        this._itemUpdateTimeout = null;\n      }, 500);\n    }\n  }\n\n  /**\n   * Handle clicks outside the menu\n   */\n  _onClickOutside = (event) => {\n    const menu = this.element;\n    if (!menu) return;\n\n    // Check if click is on filter tooltip - if outside tooltip, close it (even when locked)\n    const filterTooltip = menu.querySelector('.actor-filter-tooltip');\n    if (filterTooltip && !event.target.closest('.actor-filter-tooltip') && !event.target.closest('#flash5e-filter-actors')) {\n      filterTooltip.remove();\n      return;\n    }\n\n    // Only proceed with menu closing logic if not locked\n    if (this.isLocked) return;\n\n    if (event.target.closest('.flash-rolls-menu')) return;\n    if (menu.contains(event.target)) return;\n    // if (event.target.closest('#flash-rolls-icon')) return;\n    // if (event.target.closest('.dialog, .app, .notification, .application')) return;\n    // if (event.target.closest('.actor-tab')) return;\n    this.close();\n  }\n\n\n  /**\n   * Handle roll requests toggle\n   */\n  async _onToggleRollRequests(event) {\n    return RollMenuStateManager.handleToggleRollRequests(event);\n  }\n\n  /**\n   * Handle skip dialogs toggle\n   */\n  async _onToggleSkipDialogs(event) {\n    return RollMenuStateManager.handleToggleSkipDialogs(event);\n  }\n\n  /**\n   * Handle skip dialogs toggle\n   */\n  async _onToggleGroupRollsMsg(event) {\n    return RollMenuStateManager.handleToggleGroupRollsMsg(event);\n  }\n\n  /**\n   * Handle select all toggle\n   */\n  _onToggleSelectAll(event) {\n    return RollMenuStateManager.handleToggleSelectAll(event, this);\n  }\n\n  /**\n   * Handle actor filter toggle\n   */\n  _onToggleActorFilter(event) {\n    return RollMenuStateManager.handleToggleActorFilter(event, this);\n  }\n\n  /**\n   * Handle lock toggle\n   */\n  _onToggleLock(event) {\n    return RollMenuStateManager.handleToggleLock(event, this);\n  }\n  \n  /**\n   * Handle options toggle\n   */\n  async _onToggleOptions(event) {\n    return RollMenuStateManager.handleToggleOptions(event, this);\n  }\n\n  /**\n   * Handle open settings button click\n   */\n  async _onOpenSettings(event) {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    new ModuleSettingsMenu().render(true);\n  }\n  \n  /**\n   * Check if the current user can drop actors into the menu\n   * @param {string} selector - The drop target selector\n   * @returns {boolean} Whether the drop is allowed\n   */\n  _canDragDrop(selector) {\n    const canDrop = ActorDropUtil.canDrop(selector);\n    return canDrop;\n  }\n\n  /**\n   * Handle drag over events for visual feedback\n   * @param {DragEvent} event - The drag over event\n   */\n  _onDragOver(event) {\n    ActorDropUtil.handleDragOver(event, this);\n  }\n\n  /**\n   * Handle drop events when actors are dropped into the menu\n   * @param {DragEvent} event - The drop event\n   */\n  async _onDrop(event) {\n    await ActorDropUtil.handleDrop(event, this);\n  }\n  \n  /**\n   * Initialize selected actors from currently selected tokens\n   */\n  _initializeFromSelectedTokens() {\n    LogUtil.log(\"_initializeFromSelectedTokens called\", {\n      _ignoreTokenControl: this._ignoreTokenControl,\n      currentSelectedActors: Array.from(this.selectedActors),\n      controlledTokensCount: canvas.tokens?.controlled?.length || 0\n    });\n\n    const controlledTokens = canvas.tokens?.controlled || [];\n    this.selectedActors.clear();\n\n    for (const token of controlledTokens) {\n      if (token.actor) {\n        const uniqueId = token.id;\n        this.selectedActors.add(uniqueId);\n      }\n    }\n  }\n  \n  /**\n   * Handle tab click\n   */\n  async _onTabClick(event) {\n    const tab = event.currentTarget.dataset.tab;\n    LogUtil.log('_onTabClick #0', [tab]);\n    // if (tab === this.currentTab) return;\n    \n    this.selectedRequestType = null;\n    \n    this.currentTab = tab;\n    await this.render();\n  }\n\n  /**\n   * Handle tab double-click to clear all selections\n   */\n  async _onTabDoubleClick(event) {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    this._ignoreTokenControl = true;\n    this.selectedActors.clear();\n    canvas.tokens?.releaseAll();\n    this.selectedRequestType = null;\n    \n    setTimeout(() => {\n      this._ignoreTokenControl = false;\n    }, 200);\n    \n    await this.render();\n    this._updateRequestTypesVisibility();\n  }\n\n  /**\n   * Handle submenu tab click (rolls vs status effects)\n   */\n  async _onSubmenuTabClick(event) {\n    const tab = event.currentTarget.dataset.tab;\n    LogUtil.log('_onSubmenuTabClick', [tab]);\n    \n    if (tab === this.selectedSubmenu) return;\n    \n    this.selectedSubmenu = tab;\n    await this.render();\n    \n    // Re-apply hover-visible class after render since mouse is still over the menu\n    const accordion = this.element.querySelector('.request-types-accordion');\n    if (accordion && this.selectedActors.size > 0) {\n      accordion.classList.add('hover-visible');\n    }\n  }\n\n  /**\n   * Handle status effect click to apply to selected actors\n   */\n  async _onStatusEffectClick(event) {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const statusEffectId = event.currentTarget.dataset.id;\n    LogUtil.log('_onStatusEffectClick', [statusEffectId]);\n    \n    await RollMenuStatusManager.toggleStatusOnSelected(statusEffectId, this);\n  }\n\n  /**\n   * Handle click on actor row\n   */\n  _onActorClick(event) {\n    if (event.target.closest('.actor-select')) return;\n    \n    const wrapperElement = event.currentTarget;\n    \n    const uniqueId = wrapperElement.dataset.id;\n    const actorId = wrapperElement.dataset.actorId;\n    const tokenId = wrapperElement.dataset.tokenId;\n    \n    // Check if this is a group actor\n    if (wrapperElement.classList.contains('actor-group')) {\n      this._toggleGroupSelection(actorId);\n    } else {\n      this._toggleActorSelection(uniqueId, actorId, tokenId);\n    }\n  }\n  \n  /**\n   * Toggle actor selection state\n   */\n  _toggleActorSelection(uniqueId, actorId, tokenId) {\n    return RollMenuStateManager.toggleActorSelection(uniqueId, actorId, tokenId, this);\n  }\n\n  /**\n   * Toggle group selection - selects/deselects members using stored token associations\n   */\n  async _toggleGroupSelection(groupActorId) {\n    const groupActor = game.actors.get(groupActorId);\n    if (!groupActor || (groupActor.type !== 'group' && groupActor.type !== 'encounter')) {\n      return;\n    }\n\n    // Get stored token associations from flags\n    const tokenAssociations = groupActor.getFlag(MODULE_ID, 'tokenAssociations') || {};\n    const members = [];\n    const currentScene = game.scenes.active;\n\n\n    if (groupActor.type === 'group') {\n      for (const member of groupActor.system.members || []) {\n        if (member.actor) {\n          const memberActorId = member.actor.id;\n          const associatedTokenIds = tokenAssociations[memberActorId] || [];\n\n          if (associatedTokenIds.length > 0) {\n            // Use specific tokens from associations\n            for (const tokenId of associatedTokenIds) {\n              const tokenDoc = currentScene?.tokens.get(tokenId);\n              if (tokenDoc && tokenDoc.actorId === member.actor.id) {\n                members.push({ actor: member.actor, uniqueId: tokenId });\n              } else {\n                // Token not found in current scene, use base actor\n                members.push({ actor: member.actor, uniqueId: member.actor.id });\n              }\n            }\n          } else {\n            // No token associations, fall back to all tokens or base actor\n            const memberTokens = currentScene?.tokens.filter(token => token.actorId === member.actor.id) || [];\n            if (memberTokens.length > 0) {\n              memberTokens.forEach(tokenDoc => {\n                members.push({ actor: member.actor, uniqueId: tokenDoc.id });\n              });\n            } else {\n              members.push({ actor: member.actor, uniqueId: member.actor.id });\n            }\n          }\n        }\n      }\n    } else if (groupActor.type === 'encounter') {\n      for (const member of groupActor.system.members || []) {\n        try {\n          const memberActor = await fromUuid(member.uuid);\n          if (memberActor) {\n            const memberActorId = memberActor.id;\n            const associatedTokenIds = tokenAssociations[memberActorId] || [];\n\n            if (associatedTokenIds.length > 0) {\n              // Use specific tokens from associations\n              for (const tokenId of associatedTokenIds) {\n                const tokenDoc = currentScene?.tokens.get(tokenId);\n                if (tokenDoc && tokenDoc.actorId === memberActor.id) {\n                  members.push({ actor: memberActor, uniqueId: tokenId });\n                } else {\n                  // Token not found in current scene, use base actor\n                  members.push({ actor: memberActor, uniqueId: memberActor.id });\n                }\n              }\n            } else {\n              // No token associations, fall back to all tokens or base actor\n              const memberTokens = currentScene?.tokens.filter(token => token.actorId === memberActor.id) || [];\n              if (memberTokens.length > 0) {\n                memberTokens.forEach(tokenDoc => {\n                  members.push({ actor: memberActor, uniqueId: tokenDoc.id });\n                });\n              } else {\n                members.push({ actor: memberActor, uniqueId: memberActor.id });\n              }\n            }\n          }\n        } catch (error) {\n          console.warn(`Failed to resolve member UUID: ${member.uuid}`, error);\n        }\n      }\n    }\n\n    if (members.length === 0) return;\n\n    // Check if all members are currently selected\n    const allMembersSelected = members.every(member => \n      this.selectedActors.has(member.uniqueId)\n    );\n\n    // Toggle selection for all members\n    for (const member of members) {\n      // If uniqueId is different from actor.id, it's a token ID\n      const tokenId = member.uniqueId !== member.actor.id ? member.uniqueId : null;\n\n      if (allMembersSelected) {\n        // Deselect all members\n        if (this.selectedActors.has(member.uniqueId)) {\n          this._toggleActorSelection(member.uniqueId, member.actor.id, tokenId);\n        }\n      } else {\n        // Select all members\n        if (!this.selectedActors.has(member.uniqueId)) {\n          this._toggleActorSelection(member.uniqueId, member.actor.id, tokenId);\n        }\n      }\n    }\n\n    // Update the group's visual selection state\n    this._updateGroupSelectionUI(groupActorId, members);\n  }\n  \n  /**\n   * Update the visual state of an actor element without re-rendering\n   */\n  _updateActorSelectionUI(actorId) {\n    return RollMenuStateManager.updateActorSelectionUI(actorId, this);\n  }\n\n  /**\n   * Update the visual selection state of group elements\n   * @param {string} [groupActorId] - Optional: specific group actor ID to update\n   * @param {Array} [members] - Optional: group members array\n   */\n  _updateGroupSelectionUI(groupActorId = null, members = null) {\n    if (groupActorId && members) {\n      // Update specific group\n      this._updateSingleGroupSelection(groupActorId, members);\n    } else {\n      // Update all groups - get data from context\n      const context = this._lastPreparedContext || {};\n      const groups = context.groups || [];\n      \n      groups.forEach(groupData => {\n        if (groupData.isGroup && groupData.members) {\n          this._updateSingleGroupSelection(groupData.id, groupData.members);\n        }\n      });\n    }\n  }\n\n  /**\n   * Update selection state for a single group\n   * @param {string} groupActorId - Group actor ID\n   * @param {Array} members - Group members array\n   */\n  _updateSingleGroupSelection(groupActorId, members) {\n    // Find all group elements for this actor (there might be multiple if group has tokens)\n    const groupElements = this.element.querySelectorAll(`[data-actor-id=\"${groupActorId}\"].actor-group`);\n    \n    groupElements.forEach(groupElement => {\n      // Calculate three-state selection value using the members parameter\n      const selectedMembersCount = members.filter(member => \n        this.selectedActors.has(member.uniqueId)\n      ).length;\n      \n      let selectionState;\n      if (selectedMembersCount === 0) {\n        selectionState = 'false';\n      } else if (selectedMembersCount === members.length) {\n        selectionState = 'true';\n      } else {\n        selectionState = 'partial';\n      }\n      \n      // Update data-group-selected attribute with three-state value\n      groupElement.setAttribute('data-group-selected', selectionState);\n      \n      // Remove selected class since we're using data attribute for styling\n      groupElement.classList.remove('selected');\n    });\n  }\n\n  /**\n   * Update request types visibility based on actor selection\n   */\n  _updateRequestTypesVisibility() {\n    return RollMenuStateManager.updateRequestTypesVisibility(this);\n  }\n  \n  /**\n   * Update request types visibility without re-rendering\n   */\n  _updateRequestTypesVisibilityNoRender() {\n    return RollMenuStateManager.updateRequestTypesVisibilityNoRender(this);\n  }\n\n  /**\n   * Update select all checkbox state\n   */\n  _updateSelectAllState() {\n    return RollMenuStateManager.updateSelectAllState(this);\n  }\n\n  /**\n   * Handle search input\n   */\n  _onSearchInput(event) {\n    const searchTerm = event.target.value.toLowerCase().trim();\n    \n    // Handle request-types tab\n    if (this.selectedSubmenu === 'request-types') {\n      const requestTypesContainer = this.element.querySelector('.request-types');\n      if (!requestTypesContainer) return;\n      \n      const requestItems = requestTypesContainer.querySelectorAll('.request-type-item');\n      \n      requestItems.forEach(requestItem => {\n        const requestName = requestItem.querySelector('.request-type-name')?.textContent.toLowerCase() || '';\n        const subItems = requestItem.querySelectorAll('.sub-item');\n        let hasVisibleSubItems = false;\n        \n        if (subItems.length > 0) {\n          subItems.forEach(subItem => {\n            const subItemName = subItem.querySelector('.sub-item-name')?.textContent.toLowerCase() || '';\n            const isVisible = subItemName.includes(searchTerm);\n            subItem.classList.toggle('hidden', !isVisible);\n            if (isVisible) hasVisibleSubItems = true;\n          });\n          \n          const categoryMatches = requestName.includes(searchTerm);\n          const shouldShowCategory = searchTerm === '' || categoryMatches || hasVisibleSubItems;\n          requestItem.classList.toggle('hidden', !shouldShowCategory);\n          \n          if (searchTerm && hasVisibleSubItems) {\n            const nestedList = requestItem.querySelector('.roll-types-nested');\n            const accordionToggle = requestItem.querySelector('.accordion-toggle');\n            if (nestedList && accordionToggle) {\n              nestedList.style.display = 'block';\n              accordionToggle.classList.add('expanded');\n            }\n          }\n        } else {\n          const isVisible = searchTerm === '' || requestName.includes(searchTerm);\n          requestItem.classList.toggle('hidden', !isVisible);\n        }\n      });\n    }\n    // Handle status-effects tab\n    else if (this.selectedSubmenu === 'status-effects') {\n      const statusEffectsContainer = this.element.querySelector('.status-effects');\n      if (!statusEffectsContainer) return;\n      \n      const statusItems = statusEffectsContainer.querySelectorAll('.status-effect');\n      \n      statusItems.forEach(statusItem => {\n        const statusName = statusItem.querySelector('.status-effect-name')?.textContent.toLowerCase() || '';\n        const statusId = statusItem.dataset.id?.toLowerCase() || '';\n        const isVisible = searchTerm === '' || statusName.includes(searchTerm) || statusId.includes(searchTerm);\n        statusItem.classList.toggle('hidden', !isVisible);\n      });\n    }\n  }\n\n  /**\n   * Handle accordion toggle\n   */\n  async _onAccordionToggle(event) {\n    event.stopPropagation();\n    \n    const requestHeader = event.target.closest('.request-type-header');\n    const requestItem = requestHeader.closest('.request-type-item');\n    const requestId = requestItem.dataset.id;\n    const accordionToggle = requestItem.querySelector('.accordion-toggle');\n    const nestedList = requestItem.querySelector('.roll-types-nested');\n    \n    if (!nestedList) return;\n    \n    const isExpanded = accordionToggle.classList.contains('expanded');\n    accordionToggle.classList.toggle('expanded', !isExpanded);\n    nestedList.style.display = isExpanded ? 'none' : 'flex';\n    this.accordionStates[requestId] = !isExpanded;\n    await game.user.setFlag(MODULE.ID, 'menuAccordionStates', this.accordionStates);\n  }\n\n  /**\n   * Handle request type click\n   */\n  async _onRequestTypeClick(event) {\n    const requestItem = event.currentTarget;\n    const requestType = requestItem.dataset.id;\n    const rollOption = MODULE.ROLL_REQUEST_OPTIONS[requestType];\n    \n    if (!rollOption) {\n      LogUtil.error('Unknown request type:', [requestType]);\n      return;\n    }\n    \n    if (this.selectedRequestType === requestType) {\n      this.selectedRequestType = null;\n    } else {\n      this.selectedRequestType = requestType;\n    }\n    \n    if (rollOption.subList) {\n      await this.render();\n    } else if (this.selectedRequestType) {\n      this._triggerRoll(requestType, null);\n    }\n  }\n\n  /**\n   * Handle roll type click (sub-item in accordion)\n   */\n  _onRollTypeClick(event) {\n    LogUtil.log('_onRollTypeClick');\n    const rollKey = event.currentTarget.dataset.id;\n    const parentType = event.currentTarget.dataset.parent;\n    const requestType = parentType || this.selectedRequestType;\n    this._triggerRoll(requestType, rollKey);\n  }\n\n  /**\n   * Handle macro button click\n   */\n  async _onMacroButtonClick(event) {\n    LogUtil.log('_onMacroButtonClick');\n    \n    const element = event.currentTarget;\n    const elementId = element.dataset.id || null;\n    const parentType = element.dataset.parent;\n    \n    // For top-level request types (no parent), the requestType is the element's dataset.id\n    // For sub-items, the requestType is the parentType and rollKey is the element's dataset.id\n    let requestType, rollKey;\n    if (parentType) {\n      // This is a sub-item (like \"Acrobatics\" under \"Skill Check\")\n      requestType = parentType;\n      rollKey = elementId;\n    } else {\n      // This is a top-level item (like \"Intelligence\" ability check)\n      requestType = elementId;\n      rollKey = null; // Top-level items don't have a specific rollKey\n    }\n    \n    if (!requestType) {\n      ui.notifications.warn(\"No roll type selected for macro creation\");\n      return;\n    }\n    \n    // Get currently selected actors\n    const selectedActorIds = Array.from(this.selectedActors);\n    if (selectedActorIds.length === 0) {\n      ui.notifications.warn(\"No actors selected for macro creation\");\n      return;\n    }\n    \n    // Create macro data object\n    const macroData = {\n      requestType,\n      rollKey,\n      actorIds: selectedActorIds,\n      config: {}\n    };\n    \n    try {\n      // Use the API to create the macro\n      await FlashRolls5e.createMacro(macroData);\n    } catch (error) {\n      LogUtil.error(\"Failed to create macro\", [error]);\n      ui.notifications.error(\"Failed to create macro: \" + error.message);\n    }\n  }\n\n  /**\n   * Defines who rolls for each selected actor (GM or player)\n   * Orchestrates the roll actions accordingly\n   * @param {Object} config - Roll configuration\n   * @param {Array} pcActors - PC actors with owners\n   * @param {Actor[]} npcActors - NPC actors\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {Array} actorsData - Array of actor entries with unique IDs\n   */\n  async _orchestrateRollsForActors(config, pcActors, npcActors, rollMethodName, rollKey, actorsData) {\n    return RollMenuOrchestrator.orchestrateRollsForActors(config, pcActors, npcActors, rollMethodName, rollKey, actorsData, this);\n  }\n\n  /**\n   * Handle hit die refill dialog for actors with no available hit dice\n   * @param {Actor|Actor[]} actors - Single actor or array of actors to potentially refill hit dice for\n   * @returns {Promise<boolean>} True if refill succeeded or not needed, false if cancelled\n   */\n  async _handleHitDieRefill(actorsToRefill) {\n    return RollMenuOrchestrator.handleHitDieRefill(actorsToRefill);\n  }\n\n  /**\n   * Method called from menu items to trigger the roll for selected actors\n   * @param {string} requestType - The type of roll request (e.g., 'skill', 'ability')\n   * @param {string} rollKey - The specific roll key (e.g., 'acr' for Acrobatics)\n   */\n  async _triggerRoll(requestType, rollKey) {\n    return RollMenuOrchestrator.triggerRoll(requestType, rollKey, this);\n  }\n  \n  /**\n   * Send a roll request to a player\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} config - Roll configuration from dialog\n   * @param {boolean} suppressNotification - If true, don't show individual notification\n   * @param {string} groupRollId - Optional group roll ID for multi-actor rolls\n   */\n  async _sendRollRequestToPlayer(actor, owner, requestType, rollKey, config, suppressNotification = false, groupRollId = null) {\n    return RollMenuOrchestrator.sendRollRequestToPlayer(actor, owner, requestType, rollKey, config, suppressNotification, groupRollId);\n  }\n  \n  /**\n   * Send a consolidated notification for multiple roll requests\n   * @param {Array} successfulRequests - Array of {actor, owner} objects\n   * @param {string} rollMethodName - The type of roll being requested\n   * @param {string} rollKey - The specific roll key (if applicable)\n   */\n  _showConsolidatedNotification(successfulRequests, rollMethodName, rollKey) {\n    return RollMenuOrchestrator.showConsolidatedNotification(successfulRequests, rollMethodName, rollKey);\n  }\n  \n  /**\n   * Handle rolling for NPC actors locally\n   * @param {Actor[]} actors \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  async _handleGMRolls(actors, requestType, rollKey, rollProcessConfig) {\n    return RollMenuExecutor.handleGMRolls(actors, requestType, rollKey, rollProcessConfig);\n  }\n\n  /**\n   * Handle GM rolls with token information preserved\n   * @param {Array} actorEntries - Array of actor entries with unique IDs\n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig \n   */\n  async _handleGMRollsWithTokens(actorEntries, requestType, rollKey, rollProcessConfig) {\n    return RollMenuExecutor.handleGMRollsWithTokens(actorEntries, requestType, rollKey, rollProcessConfig);\n  }\n  \n  /**\n   * Execute local roll for a GM actor with token context\n   * @param {Actor} actor \n   * @param {Token} token \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  async _initiateRollForToken(actor, token, requestType, rollKey, rollProcessConfig) {\n    return RollMenuExecutor.initiateRollForToken(actor, token, requestType, rollKey, rollProcessConfig);\n  }\n\n  /**\n   * Execute local roll for a GM actor\n   * @param {Actor} actor \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} rollProcessConfig - Process configuration from GM dialog\n   */\n  async _initiateRoll(actor, requestType, rollKey, rollProcessConfig) {\n    return RollMenuExecutor.initiateRoll(actor, requestType, rollKey, rollProcessConfig);\n  }\n\n  /**\n   * Clean up when closing\n   */\n  async _onClose(options) {\n    LogUtil.log('_onClose',[options]);\n\n    if(!this.element) { return; }\n    \n    if (this.isCustomPosition && this.element.parentElement === document.body) {\n      const chatNotifications = document.querySelector('#chat-notifications');\n      if (chatNotifications) {\n        chatNotifications.insertBefore(this.element, chatNotifications.firstChild);\n      }\n      this.element.style.position = '';\n      this.element.style.inset = '';\n      this.element.style.top = '';\n      this.element.style.left = '';\n      this.element.style.right = '';\n      this.element.style.bottom = '';\n      this.element.classList.remove('custom-position');\n    }\n    \n    await super._onClose(options);\n    \n    this.selectedActors.clear();\n    this.selectedRequestType = null;\n    document.removeEventListener('click', this._onClickOutside, true);\n    \n    // Clean up search focus flag\n    game.user.setFlag(MODULE_ID, 'searchFocused', false);\n    \n    this._cleanupHooks();\n    this._cleanupTimeouts();\n    \n    if (RollRequestsMenu.#instance === this) {\n      RollRequestsMenu.#instance = null;\n    }\n  }\n\n  /**\n   * Override render positioning to use CSS instead of inline styles\n   */\n  setPosition(position={}) {\n    LogUtil.log('setPosition');\n    // Don't set any inline position styles - let CSS handle it\n    return this;\n  }\n  \n  /**\n   * Clean up hook listeners\n   * @private\n   */\n  _cleanupHooks() {\n    const hooks = [\n      { hook: HOOKS_CORE.CONTROL_TOKEN, property: '_tokenControlHook' },\n      { hook: HOOKS_CORE.UPDATE_ITEM, property: '_updateItemHook' },\n      { hook: HOOKS_CORE.CREATE_ITEM, property: '_createItemHook' },\n      { hook: HOOKS_CORE.DELETE_ITEM, property: '_deleteItemHook' }\n    ];\n    \n    hooks.forEach(({ hook, property }) => {\n      if (this[property]) {\n        Hooks.off(hook, this[property]);\n        this[property] = null;\n      }\n    });\n  }\n  \n  /**\n   * Clean up timeout references\n   * @private\n   */\n  _cleanupTimeouts() {\n    const timeouts = [\n      '_tokenUpdateTimeout',\n      '_actorUpdateTimeout', \n      '_itemUpdateTimeout'\n    ];\n    \n    timeouts.forEach(property => {\n      if (this[property]) {\n        clearTimeout(this[property]);\n        this[property] = null;\n      }\n    });\n  }\n  \n\n  /**\n   * Toggle the roll requests menu open/closed\n   * @static\n   */\n  static toggle() {\n    \n    // Clean up orphaned menu, if present\n    const existingMenus = document.querySelectorAll('#flash-rolls-menu');\n    existingMenus.forEach(menu => {\n      menu.remove();\n    });\n    \n    if (!this.#instance) {\n      this.#instance = new RollRequestsMenu();\n      this.#instance.render(true);\n    } else {\n      if (this.#instance.rendered) {\n        this.#instance.close();\n      } else {\n        this.#instance._initializeFromSelectedTokens();\n        this.#instance.render(true);\n      }\n    }\n  }\n\n  /**\n   * Refresh the menu if it's currently open (debounced)\n   * @static\n   * @param {boolean} immediate - If true, refresh immediately without debouncing\n   */\n  static refreshIfOpen(immediate = false) {\n    if (!this.#instance || !this.#instance.rendered) {\n      return;\n    }\n\n    if (immediate) {\n      this._performRefresh();\n      return;\n    }\n\n    if (this.#refreshDebounceTimer) {\n      clearTimeout(this.#refreshDebounceTimer);\n    }\n\n    this.#refreshDebounceTimer = setTimeout(() => {\n      this._performRefresh();\n      this.#refreshDebounceTimer = null;\n    }, this.#REFRESH_DEBOUNCE_DELAY);\n  }\n\n  /**\n   * Perform the actual refresh operation\n   * @static\n   * @private\n   */\n  static _performRefresh() {\n    if (!this.#instance || !this.#instance.rendered) {\n      return;\n    }\n\n    this.#instance.render();\n  }\n\n  /**\n   * Get the current menu instance\n   * @returns {RollRequestsMenu|null} The current instance or null if not created\n   */\n  static getInstance() {\n    return this.#instance;\n  }\n\n  /**\n   * Get DOM elements for currently selected actors\n   * @returns {HTMLElement[]} Array of actor wrapper elements for selected actors\n   */\n  getSelectedActorElements() {\n    if (!this.element) return [];\n    \n    return Array.from(this.element.querySelectorAll('.actor.drag-wrapper.selected'));\n  }\n\n  /**\n   * Show the menu automatically if setting is enabled\n   * Called during module initialization\n   * @static\n   */\n  static showOnLoadIfEnabled() {\n    const SETTINGS = getSettings();\n    const showOnLoad = SettingsUtil.get(SETTINGS.showMenuOnLoad.tag);\n    \n    if (showOnLoad && game.user.isGM) {\n      const existingMenus = document.querySelectorAll('#flash-rolls-menu');\n      existingMenus.forEach(menu => {\n        menu.remove();\n      });\n      \n      if (!this.#instance) {\n        this.#instance = new RollRequestsMenu();\n      } else if (!this.#instance.rendered) {\n        this.#instance._initializeFromSelectedTokens();\n      }\n\n      this.#instance?.render(true);\n      if (this.#instance) {\n        this.#instance.isLocked = true;\n      }\n    }\n  }\n}\n","import { MODULE_ID } from \"../../constants/General.mjs\";\nimport { getSettings, SETTING_SCOPE } from \"../../constants/Settings.mjs\";\nimport { getSettingMenus } from \"../../constants/SettingMenus.mjs\";\nimport { getDefaultIconLayout } from \"../../constants/IconMappings.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport RollRequestsMenu from \"../ui/RollRequestsMenu.mjs\";\nimport { GeneralUtil } from \"./GeneralUtil.mjs\";\n\n/**\n * Utility class for managing module settings\n */\nexport class SettingsUtil {\n  static coreColorScheme = \"dark\";\n  \n  /**\n   * Register all module settings\n   * @static\n   */\n  static registerSettings() {\n    const SETTINGS = getSettings();\n    var isDebugOn = SettingsUtil.get(SETTINGS.debugMode.tag);\n    if(isDebugOn){CONFIG.debug.hooks = true};\n\n    /* Register each of the settings defined in the SETTINGS constant */\n    const settingsList = Object.entries(SETTINGS);\n    settingsList.forEach((entry) => {\n      const setting = entry[1]; \n\n      const settingObj = { \n        name: setting.label,\n        hint: setting.hint,\n        default: setting.default,\n        type: setting.propType,\n        scope: setting.scope,\n        config: setting.config,\n        requiresReload: setting.requiresReload || false,\n        restricted: setting.scope === SETTING_SCOPE.world,\n        onChange: value => SettingsUtil.apply(setting.tag, value)\n      }\n      if(setting.choices){\n        settingObj.choices = setting.choices;\n      }\n\n      LogUtil.log('registerSettings', [settingObj, settingObj.scope]);\n\n      try {\n        game.settings.register(MODULE_ID, setting.tag, settingObj);\n      } catch (error) {\n        LogUtil.log(`Setting ${setting.tag} already registered or error:`, error);\n      }\n    });\n    \n  }\n\n  /**\n   * Register the settings menu - should be called during ready hook\n   * @static\n   */\n  static registerSettingsMenu() {\n    const settingMenus = Object.entries(getSettingMenus());\n\n    for (const [menuKey, menuData] of settingMenus) {\n      if ((menuData.restricted && game.user?.isGM) || !menuData.restricted) {\n        const menuObj = {\n          name: menuData.tag,\n          label: menuData.label,\n          hint: menuData.hint,\n          icon: menuData.icon,\n          type: menuData.propType,\n          restricted: menuData.restricted\n        };\n        game.settings.registerMenu(MODULE_ID, menuData.tag, menuObj);\n      }\n    }\n\n    SettingsUtil.updateColorScheme();\n    SettingsUtil.validateAndUpdateIconLayout();\n    SettingsUtil.checkMidiQol();\n  }\n\n  /**\n   * Verify if Midi-QoL is installed and active\n   * Disable incompatible settings if true\n   */\n  static checkMidiQol(){\n    const SETTINGS = getSettings();\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n    const isRollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n    \n    LogUtil.log('checkMidiQol', [isMidiActive, isRollInterceptionEnabled]);\n    \n    // if(game.user?.isGM && isMidiActive && isRollInterceptionEnabled){\n    //   // SettingsUtil.set(SETTINGS.rollInterceptionEnabled.tag, false);\n    //   // ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.notifications.midiQolActive\"), {permanent: true});\n    // }\n  }\n\n  static updateColorScheme(){\n    // const uiConfig = SettingsUtil.get(\"uiConfig\", \"core\"); \n    const foundryUiConfig = game.settings.get('core','uiConfig'); \n    let interfaceTheme = foundryUiConfig?.colorScheme?.interface;\n    \n    // If Browser Default, detect browser preference\n    if (!interfaceTheme) {\n      if (matchMedia(\"(prefers-color-scheme: dark)\").matches) {\n        interfaceTheme = \"dark\";\n      } else if (matchMedia(\"(prefers-color-scheme: light)\").matches) {\n        interfaceTheme = \"light\";\n      }\n    }\n    \n    SettingsUtil.coreColorScheme = interfaceTheme;\n    LogUtil.log('SettingsUtil.updateColorScheme', [foundryUiConfig, SettingsUtil.coreColorScheme]);\n  }\n  \n  /**\n   * Retrieves the value of a module setting\n   * @param {string} settingName - Name of the setting to retrieve\n   * @param {string} [moduleName=MODULE_ID] - ID of the module the setting belongs to\n   * @returns {*} Current value of the setting\n   */\n  static get(settingName, moduleName=MODULE_ID){\n    if(!settingName){ return null; }\n\n    let setting = false;\n\n    try {\n      if(moduleName===MODULE_ID){\n        setting = game.settings.get(moduleName, settingName);\n      }else{\n        const client = game.settings.storage.get(\"client\");\n        let selectedSetting = client[`${moduleName}.${settingName}`];\n        //\n        if(selectedSetting===undefined){\n          const world = game.settings.storage.get(\"world\");\n          selectedSetting = world.getSetting(`${moduleName}.${settingName}`);\n          setting = selectedSetting?.value;\n        }\n      }\n    } catch (error) {\n      // Setting not registered yet, return default\n      LogUtil.log(`Setting ${moduleName}.${settingName} not found, returning false`);\n      return false;\n    }\n\n    return setting;\n  }\n  \n  /**\n   * Updates the value of a module setting\n   * @param {string} settingName - Name of the setting to update\n   * @param {*} newValue - New value to set\n   * @param {string} [moduleName=MODULE_ID] - ID of the module the setting belongs to\n   * @returns {boolean} True if setting was updated successfully\n   */\n  static set(settingName, newValue, moduleName=MODULE_ID){ \n    if(!settingName){ return false; }\n\n    let selectedSetting = game.settings.storage.get(\"client\")[`${moduleName}.${settingName}`];\n\n    if(!selectedSetting){\n      const world = game.settings.storage.get(\"world\");\n      selectedSetting = world.getSetting(`${moduleName}.${settingName}`);\n      LogUtil.log('SettingsUtil.set - world Setting?', [selectedSetting]);\n    } \n\n    try{\n      game.settings.set(moduleName, settingName, newValue);\n      LogUtil.log('SettingsUtil.set - success', [moduleName, settingName, newValue]);\n    }catch(e){\n      LogUtil.error('SettingsUtil.set - error', [e]);\n    }\n\n    return true;\n  }\n\n  static apply(settingName, newValue){\n    const SETTINGS = getSettings();\n    switch(settingName){\n      case SETTINGS.rollRequestsEnabled.tag:\n        SettingsUtil.applyRollRequestsEnabled(newValue);\n        break;\n      case SETTINGS.rollInterceptionEnabled.tag:\n        SettingsUtil.applyRollInterceptionEnabled(newValue);\n        break;\n      case SETTINGS.compactMode.tag:\n        SettingsUtil.applyCompactMode(newValue);\n        break;\n      case SETTINGS.menuLayout.tag:\n        SettingsUtil.applyMenuLayout(newValue);\n        break;\n      case SETTINGS.menuIconsLayout.tag:\n        SettingsUtil.applyMenuIconsLayout(newValue);\n        break;\n      default:\n        break;\n    }\n  }\n\n  static applyRollInterceptionEnabled(newValue){\n    SettingsUtil.checkMidiQol();\n  }\n\n  static applyRollRequestsEnabled(newValue){\n    const requestsIcon = document.querySelector(\".chat-controls .flash-rolls-icon\");\n    if(!requestsIcon){ return; }\n    \n    if(newValue){\n      requestsIcon.classList.add(\"active\");\n    }else{\n      requestsIcon.classList.remove(\"active\");\n    }\n  }\n\n  static applyCompactMode(newValue){\n    const SETTINGS = getSettings();\n    const isCompactMode = newValue || SettingsUtil.get(SETTINGS.compactMode.tag);\n\n    LogUtil.log('applyCompactMode', [isCompactMode]);\n    \n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  static applyMenuLayout(newValue){\n    const SETTINGS = getSettings();\n    const menuLayout = newValue || SettingsUtil.get(SETTINGS.menuLayout.tag);\n\n    LogUtil.log('applyMenuLayout', [menuLayout]);\n\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  static applyMenuIconsLayout(newValue){\n    const SETTINGS = getSettings();\n    const menuIconsLayout = newValue || SettingsUtil.get(SETTINGS.menuIconsLayout.tag);\n\n    LogUtil.log('applyMenuIconsLayout', [menuIconsLayout]);\n\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Validate and update the menuIconsLayout setting to include any missing icons\n   * and remove any obsolete icons that no longer exist in IconMappings\n   * @static\n   */\n  static validateAndUpdateIconLayout() {\n    const SETTINGS = getSettings();\n    const currentLayout = SettingsUtil.get(SETTINGS.menuIconsLayout.tag);\n    const defaultLayout = getDefaultIconLayout();\n\n    if (!currentLayout) {\n      LogUtil.log('validateAndUpdateIconLayout - no current layout found, using default');\n      return;\n    }\n\n    let updated = false;\n    const updatedLayout = foundry.utils.deepClone(currentLayout);\n\n    // Check each icon type (moduleActions, actorActions)\n    for (const [iconType, defaultIcons] of Object.entries(defaultLayout)) {\n      if (!updatedLayout[iconType]) {\n        updatedLayout[iconType] = [];\n      }\n\n      // Get valid icon IDs from the default layout (these are the ones that should exist)\n      const validIds = new Set(defaultIcons.map(icon => icon.id));\n\n      // Remove icons that are no longer in the IconMappings\n      const originalLength = updatedLayout[iconType].length;\n      updatedLayout[iconType] = updatedLayout[iconType].filter(icon => {\n        if (!validIds.has(icon.id)) {\n          LogUtil.log(`validateAndUpdateIconLayout - removed obsolete icon: ${icon.id} from ${iconType}`);\n          updated = true;\n          return false;\n        }\n        return true;\n      });\n\n      // Get existing icon IDs after filtering\n      const existingIds = new Set(updatedLayout[iconType].map(icon => icon.id));\n\n      // Find the highest order number in existing icons\n      let maxOrder = Math.max(\n        ...updatedLayout[iconType].map(icon => icon.order || 0),\n        -1\n      );\n\n      // Add any missing icons from the default layout\n      for (const defaultIcon of defaultIcons) {\n        if (!existingIds.has(defaultIcon.id)) {\n          maxOrder++;\n          updatedLayout[iconType].push({\n            ...defaultIcon,\n            order: maxOrder\n          });\n          updated = true;\n          LogUtil.log(`validateAndUpdateIconLayout - added missing icon: ${defaultIcon.id} to ${iconType}`);\n        }\n      }\n    }\n\n    // Save the updated layout if changes were made\n    if (updated) {\n      SettingsUtil.set(SETTINGS.menuIconsLayout.tag, updatedLayout);\n      LogUtil.log('validateAndUpdateIconLayout - updated layout', updatedLayout);\n    } else {\n      LogUtil.log('validateAndUpdateIconLayout - no changes needed');\n    }\n  }\n}\n","import { ActorStatusManager } from '../managers/ActorStatusManager.mjs';\nimport { LogUtil } from './LogUtil.mjs';\nimport { HOOKS_CORE } from '../../constants/Hooks.mjs';\n\n/**\n * Utility class for managing Flash Rolls status icons in the Actor Directory\n */\nexport class ActorDirectoryIconUtil {\n  /**\n   * Initialize the Actor Directory icon system\n   */\n  static initialize() {\n    LogUtil.log('ActorDirectoryIconUtil.initialize');\n    \n    // Hook into Actor Directory renders\n    Hooks.on(HOOKS_CORE.RENDER_ACTOR_DIRECTORY, this.onRenderActorDirectory.bind(this));\n    \n    // Hook into actor flag changes to update icons\n    Hooks.on(HOOKS_CORE.UPDATE_ACTOR, this.onUpdateActor.bind(this));\n    \n    // Update any already-rendered Actor Directory\n    this.updateExistingDirectory();\n  }\n\n  /**\n   * Update icons in an already-rendered Actor Directory\n   */\n  static updateExistingDirectory() {\n    // Find any existing Actor Directory\n    const actorDirectory = ui.actors;\n    if (actorDirectory && actorDirectory.rendered && actorDirectory.element) {\n      LogUtil.log('ActorDirectoryIconUtil.updateExistingDirectory - Found rendered directory, adding icons');\n      this.onRenderActorDirectory(actorDirectory, actorDirectory.element);\n    } else {\n      LogUtil.log('ActorDirectoryIconUtil.updateExistingDirectory - No rendered directory found');\n    }\n  }\n\n  /**\n   * Handle Actor Directory render to add status icons\n   * @param {ActorDirectory} app - The Actor Directory application\n   * @param {HTMLElement} html - The rendered HTML\n   */\n  static onRenderActorDirectory(app, html) {\n    const actorItems = html.querySelectorAll('.directory-item.actor');\n    actorItems.forEach((element) => {\n      const actorId = element.dataset.entryId || element.dataset.documentId;\n      if (actorId) {\n        this.updateActorIcon(element, actorId);\n      }\n    });\n  }\n\n  /**\n   * Handle actor updates to refresh icons when status changes\n   * @param {Actor} actor - The updated actor\n   * @param {Object} changes - The changes made to the actor\n   */\n  static onUpdateActor(actor, changes) {\n    const flagChanges = changes.flags?.['flash-rolls-5e'];\n    if (flagChanges) {\n      LogUtil.log('ActorDirectoryIconUtil.onUpdateActor - Flash Rolls flags changed', [actor.name, flagChanges]);\n      this.refreshActorIcon(actor.id);\n    }\n  }\n\n  /**\n   * Update the Flash Rolls status icon for a specific actor element\n   * @param {HTMLElement} actorElement - The actor directory item element\n   * @param {string} actorId - The actor ID\n   */\n  static updateActorIcon(actorElement, actorId) {\n    const existingIcon = actorElement.querySelector('span.fas.fa-bolt, span.fas.fa-bolt-slash');\n    if (existingIcon) {\n      existingIcon.remove();\n    }\n\n    const actor = game.actors.get(actorId);\n    if (!actor) return;\n\n    const isFavorite = ActorStatusManager.isFavorite(actor);\n    const isBlocked = ActorStatusManager.isBlocked(actor);\n\n    if (!isFavorite && !isBlocked) return;\n    const icon = document.createElement('span');\n    \n    if (isBlocked) {\n      icon.className = 'fas fa-bolt-slash';\n      icon.dataset.tooltip = game.i18n.localize(\"FLASH_ROLLS.contextMenu.unblockFromMenu\");\n      icon.dataset.tooltipDirection = 'LEFT';\n      // Add click handler to unblock\n      icon.addEventListener('click', (event) => {\n        event.preventDefault();\n        event.stopPropagation();\n        ActorStatusManager.toggleBlocked(actorId, false);\n      });\n    } else if (isFavorite) {\n      icon.className = 'fas fa-bolt';\n      icon.dataset.tooltip = game.i18n.localize(\"FLASH_ROLLS.contextMenu.blockFromMenu\");\n      icon.dataset.tooltipDirection = 'LEFT';\n      // Add click handler to remove from favorites (same as unblock action)\n      icon.addEventListener('click', (event) => {\n        event.preventDefault();\n        event.stopPropagation();\n        ActorStatusManager.toggleFavorite(actorId, false);\n      });\n    }\n    \n    // Add cursor pointer style to indicate clickability\n    icon.style.cursor = 'pointer';\n    actorElement.appendChild(icon);\n  }\n\n  /**\n   * Refresh the icon for a specific actor by ID\n   * @param {string} actorId - The actor ID\n   */\n  static refreshActorIcon(actorId) {\n    const actorElement = document.querySelector(`.directory-item.actor[data-entry-id=\"${actorId}\"], .directory-item.actor[data-document-id=\"${actorId}\"]`);\n    if (actorElement) {\n      this.updateActorIcon(actorElement, actorId);\n    }\n  }\n\n  /**\n   * Refresh all actor icons in the directory\n   */\n  static refreshAllIcons() {\n    LogUtil.log('ActorDirectoryIconUtil.refreshAllIcons');\n    \n    const actorItems = document.querySelectorAll('.directory-item.actor');\n    actorItems.forEach(element => {\n      const actorId = element.dataset.entryId || element.dataset.documentId;\n      if (actorId) {\n        this.updateActorIcon(element, actorId);\n      }\n    });\n  }\n}","import { HOOKS_DND5E } from '../../constants/Hooks.mjs';\nimport { MODULE_ID, ACTIVITY_TYPES } from '../../constants/General.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SettingsUtil } from '../utils/SettingsUtil.mjs';\nimport { LogUtil } from '../utils/LogUtil.mjs';\nimport { GeneralUtil } from '../utils/GeneralUtil.mjs';\nimport { RollHelpers } from '../helpers/RollHelpers.mjs';\nimport { HooksManager } from '../core/HooksManager.mjs';\n\n/**\n * Handles roll-specific hooks\n * Contains only hook handler methods - registration is handled by HooksManager\n */\nexport class RollHooksHandler {\n\n  // ========================================\n  // GM-ONLY METHODS\n  // ========================================\n\n  /**\n   * Handle pre-roll hook on GM side to check for skip dialog conditions\n   * Only applies skip dialog logic to GM-side local rolls, never to roll requests sent to players\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialogOptions - Dialog display options\n   * @param {Object} messageOptions - Chat message options\n   */\n  static onPreRollGM(config, dialogOptions, messageOptions) {\n    LogUtil.log(\"RollHooksHandler.onPreRollGM\", [config, dialogOptions, messageOptions]);\n\n    config.rolls = RollHelpers.consolidateRolls(config.rolls);\n\n    if (config.subject?.item) {\n      const areSkipKeysPressed = GeneralUtil.areSkipKeysPressed(config.event);\n      const stored = config.subject.item.getFlag(MODULE_ID, 'tempAttackConfig') || config.subject.item.getFlag(MODULE_ID, 'tempDamageConfig') || config.subject.item.getFlag(MODULE_ID, 'tempSaveConfig');\n      LogUtil.log(\"RollHooksHandler.onPreRollGM - flag\", [stored]);\n      if (stored?.skipRollDialog === true || areSkipKeysPressed) {\n        dialogOptions.configure = false;\n        LogUtil.log(\"RollHooksHandler.onPreRollGM - Local GM roll, skipping dialog via stored flag\");\n      }\n    }\n  }\n\n  // ========================================\n  // PLAYER-ONLY METHODS\n  // ========================================\n\n  /**\n   * Handle pre-roll initiative dialog to apply stored configuration from GM request\n   * Always forces dialog to show on player side regardless of GM's skip dialog settings\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialogOptions - Dialog display options\n   * @param {Object} messageOptions - Chat message options\n   */\n  static onPreRollInitiativeDialog(config, dialogOptions, messageOptions) {\n    const actor = config.subject;\n    const storedConfig = actor.getFlag(MODULE_ID, 'tempInitiativeConfig');\n\n    LogUtil.log(\"RollHooksHandler.onPreRollInitiativeDialog triggered\", [config, storedConfig, dialogOptions, messageOptions]);\n\n    // For player-side roll requests, always show the dialog regardless of GM's skip setting\n    if (storedConfig) {\n      dialogOptions.configure = true;\n      LogUtil.log(\"RollHooksHandler.onPreRollInitiativeDialog - Player roll request, always showing dialog\");\n    }\n\n    config.advantage = storedConfig?.advantage || config.advantage || false;\n    config.disadvantage = storedConfig?.disadvantage || config.disadvantage || false;\n\n    config.rollMode = storedConfig?.rollMode || config.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n    messageOptions.rollMode = storedConfig?.rollMode || messageOptions.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n\n    if (storedConfig?.rolls?.[0]?.data?.situational && config.rolls?.[0]?.data) {\n      config.rolls[0].data.situational = storedConfig.rolls[0].data.situational;\n    }\n  }\n\n  /**\n   * Handle pre-roll attack hook to apply stored configuration from GM request\n   * Always forces dialog to show on player side regardless of GM's skip dialog settings\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialogOptions - Dialog display options\n   * @param {Object} messageOptions - Chat message options\n   */\n  static onPreRollAttackV2(config, dialogOptions, messageOptions) {\n    LogUtil.log(\"RollHooksHandler.onPreRollAttackV2 triggered\", [config, dialogOptions, messageOptions]);\n\n    const stored = config.subject?.item?.getFlag(MODULE_ID, 'tempAttackConfig');\n    if (stored) {\n      LogUtil.log(\"RollHooksHandler.onPreRollAttackV2 - flag\", [stored]);\n\n      dialogOptions.configure = true;\n      LogUtil.log(\"RollHooksHandler.onPreRollAttackV2 - Player roll request, always showing dialog\");\n\n      if (stored.attackMode) config.attackMode = stored.attackMode;\n      if (stored.ammunition) config.ammunition = stored.ammunition;\n      if (stored.mastery !== undefined) config.mastery = stored.mastery;\n      config.advantage = stored.advantage || false;\n      config.disadvantage = stored.disadvantage || false;\n      messageOptions.rollMode = stored.rollMode || messageOptions.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n\n      if (stored.situational) {\n        if (!config.rolls || config.rolls.length === 0) {\n          config.rolls = [{\n            parts: [],\n            data: {},\n            options: {}\n          }];\n        }\n\n        if (!config.rolls[0].data) {\n          config.rolls[0].data = {};\n        }\n        config.rolls[0].data.situational = stored.situational;\n      }\n      LogUtil.log(\"RollHooksHandler.onPreRollAttackV2 - Applied stored configuration to attack roll\", [config, messageOptions]);\n    }\n  }\n\n  /**\n   * Handle pre-roll damage hook to apply stored configuration from GM request\n   * Always forces dialog to show on player side regardless of GM's skip dialog settings\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialogOptions - Dialog display options\n   * @param {Object} messageOptions - Chat message options\n   */\n  static onPreRollDamageV2(config, dialogOptions, messageOptions) {\n    const stored = config.subject?.item?.getFlag(MODULE_ID, 'tempDamageConfig');\n    LogUtil.log(\"RollHooksHandler.onPreRollDamageV2 triggered\", [config, dialogOptions, messageOptions]);\n    const isMidiActive = GeneralUtil.isModuleOn('midi-qol');\n\n    config.rolls = RollHelpers.consolidateRolls(config.rolls);\n\n    if (stored) {\n      dialogOptions.configure = true;\n      LogUtil.log(\"RollHooksHandler.onPreRollDamageV2 - Player roll request, forcing dialog to show\");\n    }\n\n    if(config.midiOptions && !game.user.isGM && isMidiActive &&\n      config.subject?.type === ACTIVITY_TYPES.DAMAGE){\n\n      dialogOptions.configure = true;\n\n      const existingWorkflowOptions = config.midiOptions.workflowOptions || {};\n      config.midiOptions = {\n        ...config.midiOptions,\n        fastForwardDamage: false,\n        workflowOptions: {\n          ...existingWorkflowOptions,\n          fastForwardDamage: false,\n          autoRollAttack: false,\n          autoRollDamage: false,\n          forceCompletion: false\n        }\n      }\n\n      LogUtil.log(\"RollHooksHandler.onPreRollDamageV2 - configured midiOptions for Flash Rolls compatibility\", [config.midiOptions]);\n    }\n\n    if (stored) {\n      LogUtil.log(\"RollHooksHandler.onPreRollDamageV2 - Found stored request config from flag\", [stored, stored.situational]);\n\n      if (stored.critical) config.critical = stored.critical;\n      messageOptions.rollMode = stored.rollMode || messageOptions.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n\n      LogUtil.log(\"RollHooksHandler.onPreRollDamageV2 triggered #1\", [config, dialogOptions, messageOptions]);\n\n      if (stored.situational) {\n        if (!config.rolls || config.rolls.length === 0) {\n          config.rolls = [{\n            parts: [],\n            data: {},\n            options: {}\n          }];\n        }\n\n        if (!config.rolls[0].data) {\n          config.rolls[0].data = {};\n        }\n        config.rolls[0].data.situational = stored.situational;\n        config._flashRollsSituational = stored.situational;\n      }\n      LogUtil.log(\"RollHooksHandler.onPreRollDamageV2 - Applied stored configuration to damage roll\", [config, messageOptions]);\n    }\n  }\n\n  /**\n   * Handle pre-roll ability check hook to force configuration dialog for roll requests\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialog - Dialog options\n   * @param {Object} message - Message options\n   */\n  static onPreRollAbilityCheck(config, dialog, message) {\n    LogUtil.log(\"RollHooksHandler.onPreRollAbilityCheck\", [config, dialog, message]);\n    if (config.isRollRequest) {\n      dialog.configure = true;\n    }\n  }\n\n  // ========================================\n  // COMMON METHODS (BOTH GM AND PLAYERS)\n  // ========================================\n\n  /**\n   * Handle pre-roll hit die to fix situational bonus concatenation issue\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialogOptions - Dialog display options\n   * @param {Object} messageOptions - Chat message options\n   */\n  static onPreRollHitDieV2(config, dialogOptions, messageOptions) {\n    LogUtil.log(\"RollHooksHandler.onPreRollHitDieV2 triggered\", [config, dialogOptions, messageOptions]);\n\n    if (config.rolls && config.rolls.length > 1) {\n      const allSituationalBonuses = [];\n\n      for(let i = 0; i < config.rolls.length; i++){\n        const roll = config.rolls[i];\n        if (roll && roll.data && roll.data.situational) {\n          allSituationalBonuses.push(roll.data.situational);\n        }\n      }\n\n      if (allSituationalBonuses.length > 0) {\n        if (!config.rolls[0].data) {\n          config.rolls[0].data = {};\n        }\n\n        const uniqueBonuses = [...new Set(allSituationalBonuses)];\n\n        config.rolls[0].data.situational = uniqueBonuses.map(bonus => {\n          const trimmedBonus = bonus.toString().trim();\n          if (trimmedBonus.startsWith('-')) {\n            return `(${trimmedBonus})`;\n          } else if (trimmedBonus.startsWith('+')) {\n            return `${trimmedBonus.substring(1)}`;\n          } else {\n            return `${trimmedBonus}`;\n          }\n        }).join(' + ');\n\n        if(game.user.isGM && !config.rolls[0].parts.find(p => p.includes(\"@situational\"))){\n          config.rolls[0].parts.push(\"@situational\");\n        }\n      }\n\n      config.rolls = config.rolls.slice(0, 1);\n      LogUtil.log(\"RollHooksHandler.onPreRollHitDieV2 - Cleaned up hit die rolls\", config.rolls);\n    }\n  }\n\n  /**\n   * Handle post-roll configuration to add requested-by information to message\n   * @param {Array} rolls - The rolls that were made\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialog - Dialog that was shown\n   * @param {Object} message - Message configuration\n   */\n  static onPostRollConfig(rolls, config, dialog, message) {\n    if (config._showRequestedBy && rolls.length > 0) {\n      message.data = message.data || {};\n      message.data._showRequestedBy = true;\n      message.data._requestedBy = config._requestedBy;\n    }\n  }\n\n  /**\n   * Handle rollDamageV2 hook to schedule template removal after damage is rolled\n   * @param {Array} rolls - The damage rolls\n   * @param {Object} config - Roll configuration\n   * @param {Object} dialog - Dialog options\n   * @param {Object} message - Message options\n   */\n  static onRollDamageV2(rolls, config, dialog, message) {\n    const item = config.subject?.item;\n    LogUtil.log(\"RollHooksHandler.onRollDamageV2 - scheduled template removal\", [item?.name, item?.uuid]);\n\n    if (!item) return;\n\n    if (HooksManager.templateRemovalTimers.has(item.uuid)) {\n      LogUtil.log(\"RollHooksHandler.onRollDamageV2 - template removal already scheduled for item\", [item.uuid]);\n      return;\n    }\n\n    HooksManager.templateRemovalTimers.add(item.uuid);\n\n    const SETTINGS = getSettings();\n    const timeoutSeconds = SettingsUtil.get(SETTINGS.templateRemovalTimeout.tag);\n    const timeoutMs = timeoutSeconds * 1000;\n\n    setTimeout(() => {\n      GeneralUtil.removeTemplateForItem(item);\n      HooksManager.templateRemovalTimers.delete(item.uuid);\n    }, timeoutMs);\n  }\n}","import { HOOKS_CORE, HOOKS_DND5E, HOOKS_MIDI_QOL, HOOKS_MODULE } from \"../../constants/Hooks.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { DiceConfigUtil } from \"../utils/DiceConfigUtil.mjs\";\nimport { RollInterceptor } from \"../handlers/RollInterceptor.mjs\";\nimport { updateSidebarClass, isSidebarExpanded } from \"../helpers/Helpers.mjs\";\nimport { SidebarController } from \"../managers/SidebarController.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { MODULE_ID } from \"../../constants/General.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\nimport { ModuleHelpers } from \"../helpers/ModuleHelpers.mjs\";\nimport { ChatMessageManager } from \"../managers/ChatMessageManager.mjs\";\nimport RollRequestsMenu from \"../ui/RollRequestsMenu.mjs\";\nimport { ActorStatusManager } from \"../managers/ActorStatusManager.mjs\";\nimport { ActorDirectoryIconUtil } from \"../utils/ActorDirectoryIconUtil.mjs\";\nimport { FlashRollsAPI } from \"./FlashRollsAPI.mjs\";\nimport { RollMenuDragManager } from \"../managers/roll-menu/RollMenuDragManager.mjs\";\nimport { RollHooksHandler } from \"../handlers/RollHooksHandler.mjs\";\nimport { ActivityManager } from \"../managers/ActivityManager.mjs\";\n\n/**\n * Utility class for managing all module hooks in one place\n */\nexport class HooksManager {\n  static registeredHooks = new Map();\n  static midiTimeout = null;\n  static throttleTimers = {};\n  static activityConfigCache = new Map(); // In-memory cache for activity configs\n  static CACHE_EXPIRY_MS = 30000; // 30 seconds expiry for cache entries\n  static templateRemovalTimers = new Set(); // Track items that already have template removal scheduled\n\n  /**\n   * Get activity config from cache with automatic cleanup of expired entries\n   * @param {string} key - The cache key to retrieve\n   * @returns {object|null} The cached config or null if not found/expired\n   */\n  static getActivityConfigFromCache(key) {\n    const entry = HooksManager.activityConfigCache.get(key);\n    if (!entry) return null;\n\n    // Check if entry has expired\n    const now = Date.now();\n    if (now - entry.timestamp > HooksManager.CACHE_EXPIRY_MS) {\n      HooksManager.activityConfigCache.delete(key);\n      LogUtil.log('getActivityConfigFromCache - deleted expired entry', [key]);\n      return null;\n    }\n\n    return entry.config;\n  }\n\n  /**\n   * Initialize main module hooks\n   */\n  static initialize() {\n    Hooks.once(HOOKS_CORE.INIT, this._onInit.bind(this));\n    Hooks.once(HOOKS_CORE.READY, this._onReady.bind(this));\n    Hooks.on(HOOKS_MODULE.READY, ()=>{\n      LogUtil.log(\"flash-rolls-5e.ready hook\", []);\n    })\n    Hooks.on(HOOKS_CORE.GET_CHAT_MESSAGE_CONTEXT_OPTIONS, (document, contextOptions) => {\n      LogUtil.log(\"getChatMessageContextOptions hook\", [document, contextOptions]);\n      if (!game.user.isGM) return;\n      \n      this._addGroupRollContextOptions(document, contextOptions);\n    });\n    \n    Hooks.on(HOOKS_CORE.CLIENT_SETTING_CHANGED, this._onClientSettingChanged.bind(this));\n    \n    Hooks.once(HOOKS_CORE.GET_ACTOR_CONTEXT_OPTIONS, (html, contextOptions) => {\n      LogUtil.log(\"getActorContextOptions hook\", [html, contextOptions]);\n      \n      if (!game.user.isGM) return;\n\n      contextOptions.push({\n        name: game.i18n.localize(\"FLASH_ROLLS.contextMenu.unblockFromMenu\"),\n        icon: '<i class=\"fas fa-bolt\"></i>',\n        callback: li => {\n          const actorId = li.dataset.entryId;\n          if (actorId) {\n            ActorStatusManager.toggleBlocked(actorId, false);\n          }\n          return actorId;\n        },\n        condition: li => {\n          const actorId = li?.dataset?.entryId;\n          const isBlocked = ActorStatusManager.isBlocked(actorId);\n          return isBlocked;\n        }\n      });\n\n      contextOptions.push({\n        name: game.i18n.localize(\"FLASH_ROLLS.contextMenu.blockFromMenu\"),\n        icon: '<i class=\"fas fa-bolt-slash\"></i>',\n        callback: li => {\n          const actorId = li.dataset.entryId;\n          if (actorId) {\n            ActorStatusManager.toggleBlocked(actorId, true);\n          }\n          return actorId;\n        },\n        condition: li => {\n          const actorId = li?.dataset?.entryId;\n          const isBlocked = ActorStatusManager.isBlocked(actorId);\n          return !isBlocked;\n        }\n      });\n    });\n  }\n\n  /**\n   * Add context menu options for group roll messages\n   * @param {ChatMessage} message - The chat message document\n   * @param {Array} contextOptions - Array of context menu options\n   */\n  static _addGroupRollContextOptions(chatLog, contextOptions) {\n    LogUtil.log(\"_addGroupRollContextOptions\", [chatLog, contextOptions]);\n    \n    // Add \"Hide NPCs from Players\" option\n    contextOptions.push({\n      name: game.i18n.localize(\"FLASH_ROLLS.contextMenu.hideNPCsFromPlayers\"),\n      icon: '<i class=\"fas fa-eye-slash\"></i>',\n      callback: li => {\n        const messageId = li.dataset.messageId;\n        const message = game.messages.get(messageId);\n        if (message) {\n          message.setFlag(MODULE_ID, 'npcHiddenOverride', true);\n          ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.notifications.npcHiddenFromPlayers\"));\n        }\n      },\n      condition: li => {\n        const messageId = li.dataset.messageId;\n        if (!messageId) return false;\n        const message = game.messages.get(messageId);\n        if (!message || !message.getFlag(MODULE_ID, 'isGroupRoll')) return false;\n        \n        const SETTINGS = getSettings();\n        const globalHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n        const messageHidden = message.getFlag(MODULE_ID, 'npcHiddenOverride');\n        const currentlyHidden = messageHidden !== undefined ? messageHidden : globalHidden;\n        \n        return !currentlyHidden;\n      }\n    });\n\n    // Add \"Show NPCs to Players\" option  \n    contextOptions.push({\n      name: game.i18n.localize(\"FLASH_ROLLS.contextMenu.showNPCsToPlayers\"),\n      icon: '<i class=\"fas fa-eye\"></i>',\n      callback: li => {\n        const messageId = li.dataset.messageId;\n        const message = game.messages.get(messageId);\n        if (message) {\n          const SETTINGS = getSettings();\n          const globalHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n          \n          if (globalHidden) {\n            message.setFlag(MODULE_ID, 'npcHiddenOverride', false);\n          } else {\n            message.unsetFlag(MODULE_ID, 'npcHiddenOverride');\n          }\n          ui.notifications.info(game.i18n.localize(\"FLASH_ROLLS.notifications.npcVisibleToPlayers\"));\n        }\n      },\n      condition: li => {\n        const messageId = li.dataset.messageId;\n        if (!messageId) return false;\n        const message = game.messages.get(messageId);\n        if (!message || !message.getFlag(MODULE_ID, 'isGroupRoll')) return false;\n        \n        const SETTINGS = getSettings();\n        const globalHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n        const messageHidden = message.getFlag(MODULE_ID, 'npcHiddenOverride');\n        const currentlyHidden = messageHidden !== undefined ? messageHidden : globalHidden;\n        \n        return currentlyHidden;\n      }\n    });\n  }\n  \n  /**\n   * Triggered when Foundry initializes\n   */\n  static _onInit() {\n    const SETTINGS = getSettings();\n    document.body.classList.add(\"flash5e\");\n    SettingsUtil.registerSettings();\n    DiceConfigUtil.initialize();\n  }\n  \n  /**\n   * Triggered when Foundry is ready (fully loaded)\n   */\n  static _onReady() {\n    SettingsUtil.registerSettingsMenu();\n    ActorDirectoryIconUtil.initialize();\n    SidebarController.addSidebarControls(ui.sidebar, ui.sidebar?.element);\n    \n    // Listen for browser color scheme changes\n    if (matchMedia) {\n      matchMedia(\"(prefers-color-scheme: dark)\").addEventListener(\"change\", this._onBrowserColorSchemeChanged.bind(this));\n    }\n    \n    if(GeneralUtil.isModuleOn(\"midi-qol\")){\n      Hooks.once(HOOKS_MIDI_QOL.READY, this._initModule.bind(this));\n    }else{\n      this._initModule();\n    }\n    LogUtil.log(\"HooksManager.ready\", [CONFIG.statusEffects]);\n  }\n\n  static async _initModule() {\n    const SETTINGS = getSettings();\n    const isDebugOn = SettingsUtil.get(SETTINGS.debugMode.tag);\n    if (isDebugOn) {\n      CONFIG.debug.hooks = true;\n    }\n    \n    await ChatMessageManager.initialize();\n\n    // Register all hooks after determining user role\n    this._registerHooks();\n\n    if (game.user.isGM) {\n      RollInterceptor.initialize();\n      RollRequestsMenu.showOnLoadIfEnabled();\n      // Initialize user connections for dice config\n      game.users.forEach(user => {\n        this._onUserConnected(user);\n      });\n    } else {\n      DiceConfigUtil.getDiceConfig();\n    }\n    updateSidebarClass(isSidebarExpanded());\n\n    // Initialize public API for other modules\n    const module = game.modules.get(\"flash-rolls-5e\");\n    if (module) {\n      module.api = FlashRollsAPI;\n    }\n    \n    // Create global alias for easier access\n    globalThis.FlashRolls5e = FlashRollsAPI;\n\n    // Notify other modules that Flash Rolls 5e is ready\n    Hooks.call(\"flash-rolls-5e.ready\");\n  \n  }\n  \n  /**\n   * Register all hooks based on user role\n   */\n  static _registerHooks() {\n    this._registerCommonHooks();\n\n    if (game.user.isGM) {\n      this._registerGMOnlyHooks();\n    } else {\n      this._registerPlayerOnlyHooks();\n    }\n  }\n\n  /**\n   * Register hooks common to both GM and players\n   */\n  static _registerCommonHooks() {\n    // UI and Sidebar hooks\n    this._registerHook(HOOKS_CORE.RENDER_SIDEBAR, this._onRenderSidebar.bind(this));\n    this._registerHook(HOOKS_CORE.CHANGE_SIDEBAR_TAB, this._onSidebarUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.COLLAPSE_SIDE_BAR, this._onSidebarUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.REFRESH_MEASURED_TEMPLATE, this.onRefreshTemplate.bind(this));\n\n    // Chat message hooks (delegated to ChatMessageManager)\n    this._registerHook(HOOKS_CORE.CREATE_CHAT_MESSAGE, ChatMessageManager.onCreateChatMessage.bind(ChatMessageManager));\n    this._registerHook(HOOKS_CORE.PRE_CREATE_CHAT_MESSAGE, ChatMessageManager.onPreCreateChatMessage.bind(ChatMessageManager));\n    this._registerHook(HOOKS_CORE.RENDER_CHAT_MESSAGE, ChatMessageManager.onRenderChatMessage.bind(ChatMessageManager));\n    this._registerHook(HOOKS_CORE.RENDER_CHAT_LOG, ChatMessageManager.onRenderChatLog.bind(ChatMessageManager));\n\n\n    // Roll configuration hooks\n    this._registerHook(HOOKS_DND5E.RENDER_ROLL_CONFIGURATION_DIALOG, this._onRenderRollConfigDialog.bind(this));\n    this._registerHook(HOOKS_DND5E.RENDER_SKILL_TOOL_ROLL_DIALOG, this._onRenderSkillToolDialog.bind(this));\n\n    // Roll hooks (delegated to RollHooksHandler)\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_HIT_DIE_V2, RollHooksHandler.onPreRollHitDieV2.bind(RollHooksHandler));\n    this._registerHook(HOOKS_DND5E.POST_ROLL_CONFIG, RollHooksHandler.onPostRollConfig.bind(RollHooksHandler));\n    this._registerHook(HOOKS_DND5E.ROLL_DAMAGE_V2, RollHooksHandler.onRollDamageV2.bind(RollHooksHandler));\n  }\n\n  /**\n   * Register GM-only hooks\n   */\n  static _registerGMOnlyHooks() {\n    // User connection\n    this._registerHook(HOOKS_CORE.USER_CONNECTED, this._onUserConnected.bind(this));\n\n    // Roll interception (delegated to RollHooksHandler)\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_V2, RollHooksHandler.onPreRollGM.bind(RollHooksHandler));\n\n    // Activity hooks - GM side (delegated to ActivityManager)\n    this._registerHook(HOOKS_DND5E.PRE_USE_ACTIVITY, ActivityManager.onPreUseActivityGM.bind(ActivityManager));\n    this._registerHook(HOOKS_DND5E.POST_USE_ACTIVITY, ActivityManager.onPostUseActivityGM.bind(ActivityManager));\n\n    // Combat hooks for tracking status changes\n    this._registerHook(HOOKS_CORE.CREATE_COMBATANT, this._onCombatChange.bind(this));\n    this._registerHook(HOOKS_CORE.DELETE_COMBATANT, this._onCombatChange.bind(this));\n    this._registerHook(HOOKS_CORE.UPDATE_COMBAT, this._onCombatChange.bind(this));\n    this._registerHook(HOOKS_CORE.DELETE_COMBAT, this._onCombatChange.bind(this));\n\n    // ActiveEffect hooks for tracking status effect changes\n    this._registerHook(HOOKS_CORE.CREATE_ACTIVE_EFFECT, this._onActiveEffectChange.bind(this));\n    this._registerHook(HOOKS_CORE.DELETE_ACTIVE_EFFECT, this._onActiveEffectChange.bind(this));\n    this._registerHook(HOOKS_CORE.UPDATE_ACTIVE_EFFECT, this._onActiveEffectChange.bind(this));\n\n    // Updates for roll requests menu refresh\n    this._registerHook(HOOKS_CORE.UPDATE_SETTING, this._onSettingUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.UPDATE_SCENE, this._onSceneUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.UPDATE_ACTOR, this._onActorUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.UPDATE_TOKEN, this._onTokenUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.RENDER_CHAT_INPUT, this._onRenderChatInput.bind(this));\n  }\n\n  /**\n   * Register player-only hooks\n   */\n  static _registerPlayerOnlyHooks() {\n    // Player-specific roll hooks (delegated to RollHooksHandler)\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_INITIATIVE_DIALOG, RollHooksHandler.onPreRollInitiativeDialog.bind(RollHooksHandler));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_ATTACK_V2, RollHooksHandler.onPreRollAttackV2.bind(RollHooksHandler));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_DAMAGE_V2, RollHooksHandler.onPreRollDamageV2.bind(RollHooksHandler));\n    Hooks.on(HOOKS_DND5E.PRE_ROLL_ABILITY_CHECK, RollHooksHandler.onPreRollAbilityCheck.bind(RollHooksHandler));\n\n    // Activity hooks - Player side (delegated to ActivityManager)\n    this._registerHook(HOOKS_DND5E.PRE_USE_ACTIVITY, ActivityManager.onPreUseActivityPlayer.bind(ActivityManager));\n    this._registerHook(HOOKS_DND5E.POST_USE_ACTIVITY, ActivityManager.onPostUseActivityPlayer.bind(ActivityManager));\n  }\n\n  static _onSidebarUpdate(tab) {\n    LogUtil.log(\"_onSidebarUpdate\", [tab]);\n    updateSidebarClass(isSidebarExpanded());\n  }\n  \n  /**\n   * Handle chat input rendering to sync hotbar offset class with menu\n   */\n  static _onRenderChatInput() {\n    LogUtil.log(\"_onRenderChatInput - syncing offset and faded-ui classes\");\n    // Find the menu element directly since we can't access the private instance\n    const menuElement = document.querySelector('#flash-rolls-menu');\n    if (menuElement && menuElement.classList.contains('docked-bottom')) {\n      // Use setTimeout to ensure hotbar class changes have been applied\n      setTimeout(async () => {\n        // Create a minimal menu-like object with the element\n        const menuProxy = { element: menuElement };\n        RollMenuDragManager.syncOffsetClass(menuProxy);\n        RollMenuDragManager.syncFadedUIClass(menuProxy);\n      }, 50);\n    }\n  }\n  \n\n  \n  /**\n   * Triggered whenever roll configuration dialog is rendered. \n   * Used to add custom situational bonus from data, since the default DnD5e dialog does not seem to handle that\n   */\n  static _onRenderRollConfigDialog(app, html, data) {\n    LogUtil.log(\"_onRenderRollConfigDialog #0\", [ app, data ]);\n    if (app._flashRollsApplied) return;\n    \n    // const isDamageRoll = app instanceof dnd5e.applications.dice.DamageRollConfigurationDialog;\n    // LogUtil.log(\"_onRenderRollConfigDialog - isDamageRoll?\", [isDamageRoll, app.constructor.name]);\n    \n    const isInitiativeRoll = app.config?.hookNames?.includes('initiativeDialog') || \n                           app.element?.id?.includes('initiative');\n    \n    if (isInitiativeRoll) {\n      const actor = app.config?.subject;\n      if (!actor) return;\n      \n      if (!app._flashRollsTitleApplied) {\n        html.querySelector('.window-title').textContent = game.i18n.localize(\"DND5E.Initiative\");\n        html.querySelector('.window-subtitle').textContent = actor.name;\n        app._flashRollsTitleApplied = true;\n      }\n      \n      const storedConfig = actor.getFlag(MODULE_ID, 'tempInitiativeConfig');      \n      if (storedConfig) {\n        app._flashRollsApplied = true;\n        const situationalInput = html.querySelector('input[name*=\"situational\"]');\n        setTimeout(() => {\n          situationalInput.dispatchEvent(new Event('change', {\n            bubbles: true,\n            cancelable: false\n          }));\n        }, 50);\n      }\n      \n      return;\n    }else{\n      const situationalInputs = html.querySelectorAll('input[name*=\"situational\"]');\n      \n      situationalInputs.forEach((input, index) => { \n        LogUtil.log(\"_onRenderRollConfigDialog - processing input\", [index, input.name, input.value]);\n        if (!input.value && app.config?.rolls?.[0]?.data?.situational) {\n          input.value = app.config.rolls[0].data.situational;\n        }\n        \n        app.config.scaling = true;\n        if (input.value) {\n          app._flashRollsApplied = true;\n\n          if (app.config?.rolls?.[0]?.data) {\n            delete app.config.rolls[0].data.situational;\n          }\n          \n          setTimeout(() => {\n\n            input.dispatchEvent(new Event('change', {\n              bubbles: true,\n              cancelable: false\n            }));\n          }, 150);\n        }\n      });\n    }\n    \n  }\n  \n  /**\n   * Intercept group roll message creation (GM only) - currently unused\n   */\n  static _onPreCreateChatMessageGM(message, data, options, userId) {\n    LogUtil.log(\"_onPreCreateChatMessageGM\", [message, data, options, userId]);\n  }\n  \n  /**\n   * Intercept rendered chat messages to handle group rolls\n   */\n  static _onRenderChatMessageHTML(message, html, context) {\n    // Check if we should hide challenge visibility for Flash Rolls messages\n    // This handles the case where the player is the message author but shouldn't see DCs\n    LogUtil.log(\"_onRenderChatMessageHTML #0\", [message, html, context]);\n\n    ChatMessageManager.interceptRollMessage(message, html, context);\n    \n    // Handle group roll messages\n    if (message.getFlag(MODULE_ID, 'isGroupRoll')) {\n      // Handle NPC hiding\n      const SETTINGS = getSettings();\n      const globalHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n      const messageHidden = message.getFlag(MODULE_ID, 'npcHiddenOverride');\n      const isGM = game.user.isGM;\n      \n      // Hide NPCs based on global setting and message override\n      // If override exists, use it; otherwise use global setting\n      const shouldHideNPCs = (messageHidden !== undefined ? messageHidden : globalHidden) && !isGM;\n      \n      if (shouldHideNPCs) {\n        const flagData = message.getFlag(MODULE_ID, 'rollData');\n        if (flagData && flagData.results) {\n          const actorResults = html.querySelectorAll('.actor-result');\n          actorResults.forEach((element, index) => {\n            const result = flagData.results[index];\n            if (result) {\n              const actor = game.actors.get(result.actorId);\n              const shouldHide = actor && !actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER);\n              \n              if (shouldHide) {\n                element.classList.add('npc-hidden');\n              }\n            }\n          });\n        }\n      }\n      \n      // Attach group roll event listeners\n      ChatMessageManager._attachGroupRollListeners(html, message);\n    }\n    \n    this._addSelectTargetsButton(message, html);\n\n    if(game.user.isGM){\n      // Try to get item from context first, then from message flags\n      let item = context.subject?.item;\n      if (!item && message.flags?.dnd5e?.item?.uuid) {\n        item = fromUuidSync(message.flags.dnd5e.item.uuid);\n      }\n      \n      LogUtil.log(\"_onRenderChatMessageHTML - item\", [item, context, message.flags?.dnd5e?.item]);\n      if (item) {\n        // Clear the activity config cache for this item after the message is rendered\n        setTimeout(() => {\n          HooksManager.activityConfigCache.delete(item.id);\n          LogUtil.log(\"_onRenderChatMessageHTML - cleared activity config cache\", [item.id]);\n        }, 1000); \n      }\n    }\n\n    LogUtil.log(\"_onRenderChatMessageHTML\", [message, html, context]);\n\n    if (!game.user.isGM) {\n      // Check if this is a Flash Rolls request by looking for our flags\n      const hasFlashRollsFlag = message.flags?.[MODULE_ID]?.isFlashRollRequest || \n                               message.flags?.[MODULE_ID]?.groupRollId ||\n                               message.getFlag('dnd5e', 'roll')?._requestedBy;\n      \n      LogUtil.log(\"_onRenderChatMessageHTML #1\", [hasFlashRollsFlag]);\n      if (hasFlashRollsFlag) {\n        const challengeVisibility = game.settings.get(\"dnd5e\", \"challengeVisibility\");\n        LogUtil.log(\"_onRenderChatMessageHTML #2\", [challengeVisibility]);\n        \n        let showDC = true;\n        switch(challengeVisibility) {\n          case \"none\":\n            showDC = false;\n            break;\n          case \"all\":\n            showDC = true;\n            break;\n          case \"player\":\n            showDC = message.author.id === game.user.id || !message.author.isGM;\n            LogUtil.log(\"_onRenderChatMessageHTML #3\", [message.author.id, game.user.id, showDC]);\n            break;\n          default:\n            showDC = true;\n            break;\n        }\n        \n        if (showDC===false) {\n          setTimeout(() => {\n            const chatCard = html.querySelectorAll(\"[data-display-challenge]\");\n            chatCard.forEach((el) => delete el.dataset.displayChallenge);\n            \n            const diceTotals = html.querySelectorAll(\".success, .failure, .critical, .fumble\");\n            LogUtil.log(\"_onRenderChatMessageHTML #4\", [html, diceTotals]);\n            diceTotals?.forEach((el) => {\n              LogUtil.log(\"_onRenderChatMessageHTML #4b\", [el]);\n              el.classList.remove(\"success\", \"failure\", \"critical\", \"fumble\");\n            });\n              \n            // Remove the success/failure icons\n            diceTotals?.forEach((el) => el.querySelector(\".icons\")?.remove());\n            LogUtil.log(\"_onRenderChatMessageHTML #5\", [html]);\n            \n            // Optionally hide DC values in the message content\n            html.querySelectorAll(\".save-dc, .dc, .target-dc\").forEach((el) => {\n              const text = el.textContent;\n              if (text && text.includes(\"DC\")) {\n                el.textContent = text.replace(/DC\\s*\\d+/gi, \"\");\n              }\n            });\n          }, 50);\n        }\n      }\n    }\n    return false\n    \n  }\n  \n  /**\n   * Add \"Select Targeted\" button to damage roll messages with saves\n   * @param {ChatMessage} message - The chat message\n   * @param {jQuery} html - The rendered HTML\n   */\n  static _addSelectTargetsButton(message, html) {\n    if(!game.user.isGM) return;\n    LogUtil.log(\"_addSelectTargetsButton #0\", [message, html, html.querySelector('.message-content')]);\n    if (message.flags?.dnd5e?.roll?.type !== 'damage' || html.querySelector('.select-targeted')) return;\n    \n    const button = document.createElement('button');\n    button.className = 'select-targeted';\n    button.type = 'button';\n    button.setAttribute(\"data-tooltip-direction\", \"LEFT\");\n    button.setAttribute(\"data-tooltip\", \"Select Targeted\");\n    button.innerHTML = '<i class=\"fas fa-crosshairs\"></i>';\n    \n    button.addEventListener('click', (event) => {\n      event.preventDefault();\n      this._selectTargetedTokens(event);\n    });\n    \n    html.querySelector('.message-content').appendChild(button);\n    message.update({\n      content: html\n    });\n  }\n  \n  /**\n   * Select all currently targeted tokens as damage targets\n   * @param {ChatMessage} message - The chat message\n   */\n  static _selectTargetedTokens(event) {\n    const message = event.currentTarget.closest('.chat-message');\n    const targets = message.querySelectorAll(\"[data-target-uuid]\");\n    \n    if (targets.length === 0) {\n      ui.notifications.warn(game.i18n.localize(\"FLASH_ROLLS.notifications.noTargetedTokens\"));\n      return;\n    }\n\n    for ( let i=0; i < targets.length; i++ ) {\n      const target = targets[i];\n      const actorId = target.dataset.targetUuid.split('Actor.')[1];\n      const tokens = canvas.tokens.placeables.filter(t => {\n        return t.document.actor?.id === actorId || t.document.baseActor?.id === actorId;\n      });\n      tokens.forEach((token, jQuerj) => {\n        if(token && token.control){\n          token.control({ releaseOthers: i===0 });\n        }\n      });\n    }\n  }\n  \n  /**\n   * Request dice configuration from the connected user\n   */\n  static _onUserConnected(user) {\n    if (user.active && user.id !== game.user.id) {\n      DiceConfigUtil.requestDiceConfigFromUser(user.id);\n    }\n  }\n\n  /**\n   * Handle token create/delete events to refresh roll requests menu\n   * @param {Token} token - The token document\n   * @param {Object} options - Creation/deletion options  \n   * @param {string} userId - The user ID who performed the action\n   */\n  static _onTokenChange(token, options, userId) {\n    LogUtil.log('HooksManager._onTokenChange - Re-rendering roll requests menu due to token create/delete');\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  static _onSettingUpdate(setting, value, options, userId) {\n    const SETTINGS = getSettings();\n    const MODULE = { ID: 'flash-rolls-5e' };\n    \n    if (setting.key === `${MODULE.ID}.${SETTINGS.showOnlyPCsWithToken.tag}` ||\n        setting.key === `${MODULE.ID}.${SETTINGS.compactMode.tag}` ||\n        setting.key === `${MODULE.ID}.${SETTINGS.menuLayout.tag}`) {\n      \n      LogUtil.log('HooksManager._onSettingUpdate - Re-rendering roll requests menu due to setting change', [setting.key]);\n      RollRequestsMenu.refreshIfOpen();\n    }else if(setting.key === `core.uiConfig`){\n      SettingsUtil.updateColorScheme();\n      RollRequestsMenu.refreshIfOpen();\n    }\n  }\n\n  static _onSceneUpdate(scene, changes, options, userId) {\n    if (changes.active === true) {\n      LogUtil.log('HooksManager._onSceneUpdate - Re-rendering roll requests menu due to active scene change');\n      RollRequestsMenu.refreshIfOpen();\n    }\n  }\n\n  static _onActorUpdate(actor, changes, options, userId) {\n    LogUtil.log(\"HooksManager._onActorUpdate\", [actor, changes]);\n    LogUtil.log(\"HooksManager._onActorUpdate - changes.effects:\", [changes.effects]);\n\n    const ownershipChanged = changes['==ownership'] !== undefined;\n    const statsChanged = changes.system?.attributes?.hp ||\n                        changes.system?.attributes?.ac ||\n                        changes.system?.attributes?.spell?.dc ||\n                        changes.system?.skills?.prc ||\n                        changes.system?.abilities ||\n                        changes.system?.attributes?.prof;\n\n    // Check for effects changes (including death status)\n    const effectsChanged = changes.effects !== undefined;\n\n    LogUtil.log(\"HooksManager._onActorUpdate - triggers:\", [\n      'statsChanged:', statsChanged,\n      'ownershipChanged:', ownershipChanged,\n      'effectsChanged:', effectsChanged\n    ]);\n\n    if (!statsChanged && !ownershipChanged && !effectsChanged) return;\n\n    LogUtil.log(\"HooksManager._onActorUpdate - Re-rendering roll requests menu due to actor update\", [actor, changes]);\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Handle token updates that affect filtering (visibility, status effects)\n   * @param {TokenDocument} tokenDoc - Token document that was updated\n   * @param {object} changes - Changed data\n   * @param {object} options - Update options\n   * @param {string} userId - User ID who made the change\n   */\n  static _onTokenUpdate(tokenDoc, changes, options, userId) {\n    LogUtil.log(\"HooksManager._onTokenUpdate\", [tokenDoc, changes]);\n\n    const visibilityChanged = changes.hidden !== undefined;\n    const effectsChanged = changes.effects !== undefined;\n\n    if (!visibilityChanged && !effectsChanged) return;\n\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Handle combat-related changes (for combat status)\n   * @param {...any} args - Hook arguments\n   */\n  static _onCombatChange(...args) {\n    LogUtil.log(\"HooksManager._onCombatChange\", args);\n    LogUtil.log(\"HooksManager._onCombatChange - Re-rendering roll requests menu due to combat status change\");\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Handle ActiveEffect changes (for status effects like death)\n   * @param {ActiveEffect} effect - The active effect\n   * @param {Object} changes - Changes object (for updates)\n   * @param {Object} options - Update options\n   * @param {string} userId - ID of updating user\n   */\n  static _onActiveEffectChange(effect, changes, options, userId) {\n    LogUtil.log(\"HooksManager._onActiveEffectChange\", [effect, changes, options, userId]);\n\n    // Only refresh if the effect is on an actor (not an item or other document)\n    if (!effect.parent || effect.parent.documentName !== 'Actor') {\n      LogUtil.log(\"HooksManager._onActiveEffectChange - Effect not on actor, skipping\");\n      return;\n    }\n\n    LogUtil.log(\"HooksManager._onActiveEffectChange - Re-rendering roll requests menu due to status effect change\");\n    LogUtil.log(\"HooksManager._onActiveEffectChange - Effect statuses:\", effect.statuses);\n    RollRequestsMenu.refreshIfOpen();\n  }\n\n  /**\n   * Handle render ApplicationV2\n   */\n  static _onRenderApplicationV2(app, html, options) {\n    LogUtil.log(\"_onRenderApplicationV2\", [app, html, options]);\n  }\n  \n  /**\n   * Handle render chat log to attach listeners to existing group roll messages and schedule template removal\n   */\n  static _onRenderChatLog(app, html) {\n    const groupRollElements = html.querySelectorAll('.flash5e-group-roll');\n    groupRollElements.forEach(element => {\n      const messageElement = element.closest('.chat-message');\n      if (messageElement) {\n        const messageId = messageElement.dataset.messageId;\n        const message = game.messages.get(messageId);\n        if (message && message.getFlag(MODULE_ID, 'isGroupRoll')) {\n          \n          // Handle NPC hiding\n          const SETTINGS = getSettings();\n          const globalHidden = SettingsUtil.get(SETTINGS.groupRollNPCHidden.tag);\n          const messageHidden = message.getFlag(MODULE_ID, 'npcHiddenOverride');\n          const isGM = game.user.isGM;\n          \n          // Hide NPCs based on global setting and message override\n          // If override exists, use it; otherwise use global setting\n          const shouldHideNPCs = (messageHidden !== undefined ? messageHidden : globalHidden) && !isGM;\n          \n          if (shouldHideNPCs) {\n            const flagData = message.getFlag(MODULE_ID, 'rollData');\n            if (flagData && flagData.results) {\n              const actorResults = element.querySelectorAll('.actor-result');\n              actorResults.forEach((actorElement, index) => {\n                const result = flagData.results[index];\n                if (result) {\n                  const actor = game.actors.get(result.actorId);\n                  const shouldHide = actor && !actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER);\n                  \n                  if (shouldHide) {\n                    actorElement.classList.add('npc-hidden');\n                  }\n                }\n              });\n            }\n          }\n          \n          // Attach group roll listeners\n          ChatMessageManager._attachGroupRollListeners(element, message);\n        }\n      }\n    });\n\n    // Handle template removal for damage messages when chat log renders\n    const damageMessages = html.querySelectorAll('.chat-message');\n    damageMessages.forEach(messageElement => {\n      const messageId = messageElement.dataset.messageId;\n      const message = game.messages.get(messageId);\n      \n      if (message?.flags?.dnd5e?.roll?.type === 'damage' && message.flags?.dnd5e?.item?.uuid) {\n        const itemUuid = message.flags.dnd5e.item.uuid;\n        const item = fromUuidSync(itemUuid);\n        \n        if (item && !HooksManager.templateRemovalTimers.has(itemUuid)) {\n          LogUtil.log(\"_onRenderChatLog - scheduling template removal for rendered damage message\", [item.name, itemUuid]);\n          \n          // Mark this item as having scheduled removal\n          HooksManager.templateRemovalTimers.add(itemUuid);\n          \n          const SETTINGS = getSettings();\n          const timeoutSeconds = SettingsUtil.get(SETTINGS.templateRemovalTimeout.tag);\n          const timeoutMs = timeoutSeconds * 1000;\n          \n          setTimeout(() => {\n            GeneralUtil.removeTemplateForItem(item);\n            HooksManager.templateRemovalTimers.delete(itemUuid);\n          }, timeoutMs);\n        }\n      }\n    });\n  }\n  \n  /**\n   * Handle render Sidebar\n   */\n  static _onRenderSidebar(app, html, options) {\n    LogUtil.log(\"_onRenderSidebar\", [app, html]);\n    if(game.ready){\n      SidebarController.addSidebarControls(app, html);\n    }\n  }\n  \n  /**\n   * Register a hook and track it\n   * @param {string} hookName - The hook name\n   * @param {Function} handler - The handler function\n   * @private\n   */\n  static _registerHook(hookName, handler) {\n    const hookId = Hooks.on(hookName, handler);\n    this.registeredHooks.set(`${hookName}_${hookId}`, hookId);\n    return hookId;\n  }\n  \n  /**\n   * Unregister all hooks (for cleanup)\n   */\n  static unregisterAll() {\n    this.registeredHooks.forEach((hookId, key) => {\n      const hookName = key.split('_')[0];\n      Hooks.off(hookName, hookId);\n    });\n    this.registeredHooks.clear();\n  }\n  \n  /**\n   * Check if a hook is registered\n   * @param {string} hookName - The hook name to check\n   * @returns {boolean}\n   */\n  static isRegistered(hookName) {\n    for (const key of this.registeredHooks.keys()) {\n      if (key.startsWith(`${hookName}_`)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Triggered before a roll is made\n   * @param {*} config \n   * @param {*} dialogOptions \n   * @param {*} messageOptions \n   */\n  static _onPreRoll(config, dialogOptions, messageOptions, d) {\n    LogUtil.log(\"_onPreRoll #0\", [config, dialogOptions, messageOptions, d]);\n    // const isMidiRequest = GeneralUtil.isModuleOn('midi-qol')\n    // if(isMidiRequest){\n    //   return\n    // }\n    \n    // For attack rolls, check if there's a stored flag indicating this should skip the dialog\n    if (config.subject?.item) {\n      const areSkipKeysPressed = GeneralUtil.areSkipKeysPressed(config.event);\n      const stored = config.subject.item.getFlag(MODULE_ID, 'tempAttackConfig');\n      LogUtil.log(\"_onPreRoll - flag\", [stored]);\n      if (stored?.skipRollDialog === true || areSkipKeysPressed) {\n        dialogOptions.configure = false;\n        LogUtil.log(\"_onPreRoll - Local GM roll, skipping dialog via stored flag\");\n      }\n    }\n  }\n  \n  /**\n   * Actor5e.rollHitDie concatenates our roll data with its own roll data, creating two rolls.\n   * We fix this behavior here so situational bonus is added correctly without duplicating rolls\n   */\n  static _onPreRollHitDieV2(config, dialogOptions, messageOptions) {\n    LogUtil.log(\"_onPreRollHitDieV2 triggered\", [config, dialogOptions, messageOptions]);\n    \n    if (config.rolls && config.rolls.length > 1) {\n      const allSituationalBonuses = [];\n      \n      for(let i = 0; i < config.rolls.length; i++){\n        const roll = config.rolls[i];\n        if (roll && roll.data && roll.data.situational) {\n          allSituationalBonuses.push(roll.data.situational);\n        }\n      }\n      \n      if (allSituationalBonuses.length > 0) {\n        if (!config.rolls[0].data) {\n          config.rolls[0].data = {};\n        }\n        \n        const uniqueBonuses = [...new Set(allSituationalBonuses)];\n        \n        config.rolls[0].data.situational = uniqueBonuses.map(bonus => {\n          const trimmedBonus = bonus.toString().trim();\n          if (trimmedBonus.startsWith('-')) {\n            return `(${trimmedBonus})`;\n          } else if (trimmedBonus.startsWith('+')) {\n            return `${trimmedBonus.substring(1)}`;\n          } else {\n            return `${trimmedBonus}`;\n          }\n        }).join(' + ');\n        \n        if(game.user.isGM && !config.rolls[0].parts.find(p => p.includes(\"@situational\"))){\n          config.rolls[0].parts.push(\"@situational\");\n        }\n      }\n      \n      config.rolls = config.rolls.slice(0, 1);\n      LogUtil.log(\"Cleaned up hit die rolls\", config.rolls);\n    }\n  }\n  \n  /**\n   * Handle pre-roll initiative dialog hook to add situational bonus\n   */\n  static _onPreRollInitiativeDialog(config, dialogOptions, messageOptions) {\n    const actor = config.subject;\n    const storedConfig = actor.getFlag(MODULE_ID, 'tempInitiativeConfig');\n\n    LogUtil.log(\"_onPreRollInitiativeDialog triggered\", [config, storedConfig, dialogOptions, messageOptions]);\n    config.advantage = storedConfig?.advantage || config.advantage || false;\n    config.disadvantage = storedConfig?.disadvantage || config.disadvantage || false;\n    \n    config.rollMode = storedConfig?.rollMode || config.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n    messageOptions.rollMode = storedConfig?.rollMode || messageOptions.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n    \n    if (storedConfig.rolls?.[0]?.data?.situational && config.rolls?.[0]?.data) {\n      config.rolls[0].data.situational = storedConfig.rolls[0].data.situational;\n    }\n  \n  }\n  \n  /**\n   * Handle pre-roll attack hook to restore GM-configured options\n   */\n  static _onPreRollAttackV2(config, dialogOptions, messageOptions) {\n    LogUtil.log(\"_onPreRollAttackV2 triggered\", [config, dialogOptions, messageOptions]);\n    // const isMidiRequest = GeneralUtil.isModuleOn(MODULE_ID, 'midi-qol')\n    // if(isMidiRequest){\n    //   return\n    // }\n    \n    const stored = config.subject?.item?.getFlag(MODULE_ID, 'tempAttackConfig');\n    if (stored) {\n      LogUtil.log(\"_onPreRollAttackV2 - flag\", [stored]);\n      \n      // Always apply the stored configuration\n      if (stored.attackMode) config.attackMode = stored.attackMode;\n      if (stored.ammunition) config.ammunition = stored.ammunition;\n      if (stored.mastery !== undefined) config.mastery = stored.mastery;\n      config.advantage = stored.advantage || false;\n      config.disadvantage = stored.disadvantage || false;\n      messageOptions.rollMode = stored.rollMode || messageOptions.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n      \n      // If skipRollDialog is true, this is a local GM roll that should skip the dialog\n      if(stored.skipRollDialog === true) {\n        dialogOptions.configure = false;\n        LogUtil.log(\"_onPreRollAttackV2 - Local GM roll, skipping dialog\", [stored]);\n        // Don't return early - we still need to apply situational bonus below\n      }\n      \n      if (stored.situational) {\n        if (!config.rolls || config.rolls.length === 0) {\n          config.rolls = [{\n            parts: [],\n            data: {},\n            options: {}\n          }];\n        }\n        \n        if (!config.rolls[0].data) {\n          config.rolls[0].data = {};\n        }\n        config.rolls[0].data.situational = stored.situational;\n      }\n      LogUtil.log(\"_onPreRollAttackV2 - Applied stored configuration to attack roll\", [config, messageOptions]);\n    }\n  }\n\n\n  /**\n   * Handle rollDamageV2 hook to schedule template removal\n   */\n  static _onRollDamageV2(rolls, config, dialog, message) {\n    const item = config.subject?.item;\n    LogUtil.log(\"_onRollDamageV2 - scheduled template removal\", [item?.name, item?.uuid]);\n    \n    if (!item) return;\n    \n    // Check if we already scheduled removal for this item to prevent duplicates\n    if (HooksManager.templateRemovalTimers.has(item.uuid)) {\n      LogUtil.log(\"_onRollDamageV2 - template removal already scheduled for item\", [item.uuid]);\n      return;\n    }\n    \n    // Mark this item as having scheduled removal\n    HooksManager.templateRemovalTimers.add(item.uuid);\n    \n    const SETTINGS = getSettings();\n    const timeoutSeconds = SettingsUtil.get(SETTINGS.templateRemovalTimeout.tag);\n    const timeoutMs = timeoutSeconds * 1000;\n    \n    setTimeout(() => {\n      GeneralUtil.removeTemplateForItem(item);\n      HooksManager.templateRemovalTimers.delete(item.uuid);\n    }, timeoutMs);\n  }\n  \n\n  \n  /**\n   * Handle rendering of skill/tool configuration dialog to fix message flavor\n   */\n  static _onRenderSkillToolDialog(app, html, data) {\n    LogUtil.log(\"_onRenderSkillToolDialog triggered\", [app]);\n    if (app._abilityFlavorFixed) return;\n    \n    const abilitySelect = html.querySelector('select[name=\"ability\"]');\n    if (!abilitySelect) return;\n    \n    if (app.config?.isRollRequest && app.config?.ability) {\n      const selectedAbility = abilitySelect.value;\n      const configAbility = app.config.ability;\n\n      if (selectedAbility === configAbility) {\n        app._abilityFlavorFixed = true;\n        \n        setTimeout(() => {\n          const changeEvent = new Event('change', {\n            bubbles: true,\n            cancelable: true\n          });\n          abilitySelect.dispatchEvent(changeEvent);\n        }, 50);\n      }\n    }\n  }\n\n  /**\n   * TEMPLATES\n   */\n  static onRefreshTemplate(template, options) {\n    if(!template.isOwner){ return; }\n    const throttleKey = `refresh-template-${template.id}`;\n    const SETTINGS = getSettings();\n    const targettingSetting = SettingsUtil.get(SETTINGS.templateAutoTarget.tag);\n    \n    if (HooksManager.throttleTimers[throttleKey]) {\n      clearTimeout(HooksManager.throttleTimers[throttleKey]);\n    }\n\n    HooksManager.throttleTimers[throttleKey] = setTimeout(() => {\n      let maxDisposition = 3;\n\n      switch(targettingSetting){\n        case 1:\n          maxDisposition = 3; break;\n        case 2: \n          maxDisposition = 0; break;\n        default: \n          return;\n      }\n\n      game.user.targets.forEach(t => t.setTarget(false, { releaseOthers: false }));\n      \n      const tokensToTarget = [];\n      for(let token of canvas.tokens.placeables){\n        if(token.document.disposition <= maxDisposition && template.shape.contains(token.center.x-template.x,token.center.y-template.y)){\n          tokensToTarget.push(token);\n        }\n      }\n      \n      tokensToTarget.forEach((token, i) => {\n        token.setTarget(true, { \n          releaseOthers: i === 0,  // Only release others on first token\n          groupSelection: true \n        });\n      });\n      \n      if (tokensToTarget.length > 0) {\n        game.user.broadcastActivity({ targets: game.user.targets.ids });\n      }\n      \n      delete HooksManager.throttleTimers[throttleKey];\n    }, 50);\n  }\n\n  /**\n   * Handle client setting changes (including core.uiConfig)\n   * @param {string} key - The setting key that changed\n   * @param {*} value - The new value\n   * @param {Object} options - Additional options\n   */\n  static _onClientSettingChanged(key, value, options) {\n    LogUtil.log('HooksManager._onClientSettingChanged', [key, value, options]);\n    \n    // Check if the UI config changed (includes color scheme)\n    if (key === \"core.uiConfig\") {\n      this._updateMenuColorScheme();\n    }\n  }\n\n  /**\n   * Handle browser color scheme changes\n   */\n  static _onBrowserColorSchemeChanged() {\n    LogUtil.log('HooksManager._onBrowserColorSchemeChanged - Browser color scheme changed');\n    \n    // Only update if we're using browser default (interface theme is undefined)\n    const foundryUiConfig = game.settings.get('core','uiConfig');\n    if (!foundryUiConfig?.colorScheme?.interface) {\n      this._updateMenuColorScheme();\n    }\n  }\n\n  /**\n   * Update the menu's color scheme classes\n   */\n  static _updateMenuColorScheme() {\n    const oldColorScheme = SettingsUtil.coreColorScheme;\n    SettingsUtil.updateColorScheme();\n    const newColorScheme = SettingsUtil.coreColorScheme;\n    \n    // Update the menu if it's open and color scheme changed\n    const menuInstance = RollRequestsMenu.getInstance();\n    if (menuInstance?.rendered && menuInstance.classList) {\n      // Remove old theme class\n      if (oldColorScheme) {\n        menuInstance.classList.remove(`theme-${oldColorScheme}`);\n      }\n      // Add new theme class\n      if (newColorScheme) {\n        menuInstance.classList.add(`theme-${newColorScheme}`);\n      }\n    }\n  }\n}","import { MODULE_ID, ROLL_TYPES } from \"../../constants/General.mjs\";\nimport { getRollTypeDisplay, applyTargetTokens, NotificationManager } from \"../helpers/Helpers.mjs\";\nimport { RollHandlers } from \"../handlers/RollHandlers.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../helpers/RollHelpers.mjs\";\n\n/**\n * @typedef {Object} RollRequestData\n * @property {string} type - \"rollRequest\"\n * @property {string} requestId - Unique identifier for this request\n * @property {string} actorId - ID of the actor to roll for\n * @property {string} rollType - Type of roll (ability, save, skill, etc.) from ROLL_TYPES\n * @property {string} rollKey - Specific roll key (e.g., \"str\", \"acr\", \"perception\")\n * @property {string|null} activityId - Activity ID for item-based rolls\n * @property {BasicRollProcessConfiguration} rollProcessConfig - D&D5e roll process configuration\n * @property {boolean} skipRollDialog - Whether to skip the roll configuration dialog\n * @property {string[]} targetTokenIds - Array of targeted token IDs\n * @property {boolean} preserveTargets - Whether to apply GM's targets to the player\n */\n\n/**\n * Handles roll requests from GM to players\n */\nexport class RollRequestManager {\n  /**\n   * Queue for managing roll requests per user\n   * @type {Array<{actor: Actor, requestData: RollRequestData}>}\n   */\n  static rollQueue = [];\n  \n  /**\n   * Flag indicating if a roll dialog is currently active\n   * @type {boolean}\n   */\n  static isProcessingRoll = false;\n  \n  /**\n   * Handle roll request from GM on player side\n   * @param {RollRequestData} requestData - The roll request data\n   */\n  static async handleRequest(requestData) {\n    const isMidiRequest = GeneralUtil.isModuleOn('midi-qol');\n    LogUtil.log('handleRequest', [requestData]);\n    if (game.user.isGM) return;\n    \n    let actor;\n    if (requestData.isTokenActor) {\n      const tokenDoc = game.scenes.active?.tokens.get(requestData.actorId);\n      actor = tokenDoc?.actor;\n      if (!actor) {\n        LogUtil.warn('Token actor not found:', requestData.actorId);\n        return;\n      }\n    } else {\n      actor = game.actors.get(requestData.actorId);\n    }\n    \n    if (!actor || !actor.isOwner) {\n      return;\n    }\n    \n    if (requestData.preserveTargets && \n      requestData.targetTokenIds?.length > 0 \n      // && game.user.targets.size === 0\n    ) {\n      LogUtil.log('handleRequest - applyTargetTokens', [requestData]);\n      applyTargetTokens(requestData.targetTokenIds);\n    }\n\n    if(isMidiRequest && requestData.rollProcessConfig.midiOptions){\n      requestData.rollProcessConfig.midiOptions = {\n        ...requestData.rollProcessConfig.midiOptions,\n        fastForward: false,\n        fastForwardAttack: false,\n        dialogOptions: {\n          ...requestData.rollProcessConfig.midiOptions.dialogOptions,\n          fastForward: false,\n          fastForwardAttack: false,\n        },\n        workflowOptions: {\n          ...requestData.rollProcessConfig.midiOptions.workflowOptions,\n          fastForward: false,\n          fastForwardAttack: false,\n        }\n      };\n    }\n    \n    NotificationManager.notify('info', '', {\n      batch: true,\n      batchData: {\n        actor: actor.name,\n        rollType: requestData.rollType,\n        rollKey: requestData.rollKey,\n        gm: requestData.rollProcessConfig._requestedBy || 'GM'\n      }\n    });\n    \n    this.rollQueue.push({ actor, requestData });\n    LogUtil.log('handleRequest - Added to queue', [this.rollQueue.length, this.isProcessingRoll]);\n    \n    if (!this.isProcessingRoll) {\n      this.processNextRoll();\n    }\n  }\n  \n  /**\n   * Process the next roll in the queue to be executed on the player side\n   */\n  static async processNextRoll() {\n    if (this.rollQueue.length === 0) {\n      this.isProcessingRoll = false;\n      return;\n    }\n    \n    this.isProcessingRoll = true;\n    const { actor, requestData } = this.rollQueue.shift();\n    \n    LogUtil.log('processNextRoll - Processing', [actor.name, this.rollQueue.length, 'remaining']);\n    \n    try {\n      await this.executePlayerRollRequest(actor, requestData);\n    } catch (error) {\n      LogUtil.error('Error processing roll request:', [error]);\n    }\n    \n    setTimeout(() => {\n      this.processNextRoll();\n    }, 500);\n  }\n  \n  /**\n   * Execute a roll request received by a player\n   * @param {Actor} actor - The actor performing the roll\n   * @param {RollRequestData} requestData - The roll request data from GM\n   */\n  static async executePlayerRollRequest(actor, requestData) {\n    const SETTINGS = getSettings();\n    const publicPlayerRolls = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag);\n\n    LogUtil.log('executePlayerRollRequest', [actor, requestData]);\n    LogUtil.log('executePlayerRollRequest - groupRollId check', [requestData.groupRollId, typeof requestData.groupRollId]);\n    \n    try {\n      const normalizedRollType = requestData.rollType?.toLowerCase();\n      const rollConfig = requestData.rollProcessConfig.rolls?.[0] || {\n        parts: [],\n        data: {},\n        options: {}\n      };\n      \n      \n      const shouldSkipDialog = game.user.isGM ? requestData.skipRollDialog : false;\n      const dialogConfig = {\n        configure: !shouldSkipDialog\n      };\n      \n      const rollModeFromGM = requestData.rollProcessConfig.rollMode;\n      const defaultRollMode = game.settings.get(\"core\", \"rollMode\");\n      const finalRollMode = rollModeFromGM || defaultRollMode;\n      \n      const messageConfig = {\n        rollMode: finalRollMode,\n        create: requestData.rollProcessConfig.chatMessage !== false,\n        flags: {\n          [MODULE_ID]: {\n            isFlashRollRequest: true\n          }\n        }\n      };\n      \n      const handlerRequestData = {\n        rollKey: requestData.rollKey,\n        activityId: requestData.activityId, \n        config: requestData.rollProcessConfig,\n        groupRollId: requestData.groupRollId \n      };\n\n      const handler = RollHandlers[normalizedRollType];\n      if (handler) {\n        await handler(actor, handlerRequestData, rollConfig, dialogConfig, messageConfig);\n      } else {\n        LogUtil.warn(`No handler found for roll type: ${normalizedRollType}`);\n        NotificationManager.notify('warn', game.i18n.format('FLASH_ROLLS.notifications.rollError', { \n          actor: actor.name || 'Unknown Actor'\n        }));\n      }\n    } catch (error) {\n      LogUtil.error('Error executing roll request:', [error]);\n      NotificationManager.notify('error', game.i18n.format('FLASH_ROLLS.notifications.rollError', { \n        actor: actor.name || 'Unknown Actor'\n      }));\n    }\n  }\n}","import { getSettings } from \"../../constants/Settings.mjs\";\nimport { SOCKET_CALLS } from \"../../constants/General.mjs\";\nimport { SocketUtil } from \"../utils/SocketUtil.mjs\";\nimport { DiceConfigUtil } from \"../utils/DiceConfigUtil.mjs\";\nimport { HooksManager } from \"./HooksManager.mjs\";\nimport { SettingsUtil } from \"../utils/SettingsUtil.mjs\";\nimport { RollRequestManager } from \"../managers/RollRequestManager.mjs\";\nimport { LogUtil } from \"../utils/LogUtil.mjs\";\nimport { HOOKS_CORE } from \"../../constants/Hooks.mjs\";\nimport { ActorDirectoryIconUtil } from \"../utils/ActorDirectoryIconUtil.mjs\";\nimport { GeneralUtil } from \"../utils/GeneralUtil.mjs\";\n\n/**\n * @typedef {import(\"./RollRequestManager.mjs\").RollRequestData} RollRequestData\n */\n\n/**\n * Main class handling core module initialization and setup\n * Manages module lifecycle, hooks, and core functionality\n */\nexport class Main {\n  /**\n   * Initialize the module and set up core hooks\n   * @static\n   */\n  static init(){\n    SocketUtil.initialize(Main.registerSocketCalls);\n    HooksManager.initialize();\n  }\n\n  // Wrapper methods for socket calls to DiceConfigUtil\n  static getDiceConfig() {\n    return DiceConfigUtil.getDiceConfig();\n  }\n  \n  static receiveDiceConfig(userId, diceConfig) {\n    DiceConfigUtil.receiveDiceConfig(userId, diceConfig);\n  }\n\n  /**\n   * Handle roll request from GM on player side\n   * @param {RollRequestData} requestData - The roll request data\n   */\n  static async handleRollRequest(requestData) {\n    LogUtil.log('Main.handleRollRequest', requestData);\n    return RollRequestManager.handleRequest(requestData);\n  }\n\n  /**\n   * Register methods with socketlib for remote execution\n   */\n  static registerSocketCalls() {\n    SocketUtil.registerCall(SOCKET_CALLS.getDiceConfig, Main.getDiceConfig);\n    SocketUtil.registerCall(SOCKET_CALLS.receiveDiceConfig, Main.receiveDiceConfig);\n    SocketUtil.registerCall(SOCKET_CALLS.handleRollRequest, Main.handleRollRequest);\n    SocketUtil.registerCall(SOCKET_CALLS.removeTemplate, GeneralUtil.removeTemplate);\n  }\n}\n","import \"./styles/vars.css\";\nimport \"./styles/main.css\";\nimport \"./styles/chat-messages.css\";\n\nimport { Main } from \"./components/core/Main.mjs\";\n\n// Initialize the module\nMain.init();\n"],"names":["ICON_TYPES","MODULE_ACTION_ICONS","ACTOR_ACTION_ICONS","getIconConfigurations","type","getIconConfiguration","iconId","getDefaultIconLayout","SETTING_INPUT","SETTING_SCOPE","iconsMenuDefault","getSettings","MODULE_ID","DEBUG_TAG","SOCKET_CALLS","ACTIVITY_TYPES","ROLL_TYPES","ROLL_REQUEST_OPTIONS","MODULE","HOOKS_CORE","HOOKS_SOCKET","HOOKS_MIDI_QOL","HOOKS_DND5E","HOOKS_MODULE","_LogUtil","ref","data","bypassSettings","debugSetting","dataArray","strRef","options","_a","__publicField","LogUtil","_SocketUtil","hasRolls","r","result","rolls","roll","callbackFunc","e","name","func","value","callback","handler","parameters","userId","executionKey","resp","error","SocketUtil","DiceConfigUtil","clientSettings","diceConfig","_b","user","_GeneralUtil_static","parseCSS_fn","_GeneralUtil","moduleName","module","parent","selector","element","delay","varName","varValue","bodyStyle","body","existingStyle","cssText","ruleStart","ruleEnd","declarations","decl","varsMap","parts","newRuleContent","newCss","offsetTop","elementHeight","foundryFonts","customFontsObj","customFonts","fontFamily","cssImportedFonts","f","a","b","content","id","checkForDuplicates","customStyle","importRegex","imports","contentWithoutImports","match","currentContent","existingImports","currentMatch","currentContentWithoutImports","newImports","imp","allImports","to","direction","duration","onComplete","animationId","isHorizontal","start","change","startTime","animateScroll","currentTime","elapsedTime","progress","easeProgress","newAnimationId","title","dialogConfig","templatePath","templatePaths","cssString","trimmedCSS","style","testCSS","isValid","cssRules","targetSelectors","parsedCSS","__privateMethod","mainStyle","processedRules","rulesByContent","rule","pseudoSelector","combinedSelectors","s","selectors","targetList","nestedSelector","targetSelector","actor","ownership","level","item","SETTINGS","removeTemplateSettingOn","SettingsUtil","templates","mt","templateIds","t","existingTemplates","itemUuid","event","areKeysPressed","css","baseProperties","nestedRules","lines","currentNested","braceCount","i","line","openBraces","closeBraces","contentAfterBrace","__privateAdd","fontName","cleanName","GeneralUtil","IconLayoutUtil","container","list","toggle","placeholder","draggingItem","draggedIconType","targetIconType","afterElement","rect","y","closest","child","box","offset","iconItem","isEnabled","iconType","updatedIcons","index","updatedLayout","config","icon","defaultLayout","FormDataExtended","ApplicationV2","HandlebarsApplicationMixin","_element","_activeTab","_requireReload","_ModuleSettingsMenu_instances","setupRangeInputs_fn","handleRangeInputs_fn","_ModuleSettingsMenu_static","onSubmit_fn","onReset_fn","getTabs_fn","_ModuleSettingsMenu","context","__privateSet","__privateGet","p","iconContainer","select","currentValue","option","restrictedTabs","tab","partId","_c","partContext","getSettingMenus","partKey","menuContext","configs","defaultIconsLayout","savedSettings","buildIconList","iconConfigs","defaultIcons","savedIcons","defaultIconsMap","savedIconsMap","defaultIcon","savedIcon","menuKey","fieldNames","fields","fieldValues","fieldDefaults","fieldName","entry","formData","confirmReload","activeTab","settings","currSetting","group","rangeInput","valueInput","min","max","currentValueString","form","activeContent","defaults","inputField","tabList","key","ModuleSettingsMenu","PatreonSupport","args","ModuleHelpers","moduleId","getRollTypeDisplay","rollType","rollKey","_d","_e","display","normalizedRollType","toolData","toolItem","getFullRollName","showBatchedNotifications","pendingNotifications","getRollTypeDisplayFn","notificationsByType","notif","entries","messages","rollTypeDisplay","actorNames","getPlayerOwner","applyTargetTokens","tokenIds","token","isPlayerOwned","hasTokenInScene","currentScene","updateCanvasTokenSelection","actorId","selected","tokenId","tokens","specificToken","ms","resolve","isSidebarExpanded","updateSidebarClass","isExpanded","adjustMenuOffset","buildRollTypes","selectedRequestType","selectedActors","rollTypes","selectedOption","configData","label","_NotificationManager","message","requestsByPlayer","rollTypeName","successfulRequests","playerData","playerSummaries","playerId","NotificationManager","filterActorsForDeathSaves","actors","actorsNeedingDeathSaves","actorsSkippingDeathSaves","hp","deathSaves","successes","failures","categorizeActorsByOwnership","pcActors","npcActors","owner","rollPrivacyVertical","controlsWidth","isCrlngnUIOn","getActorData","uniqueId","tokenDoc","showConsumptionConfig","getConsumptionConfig","consume","isLocalRoll","response","getCreateConfig","createConfig","placeTemplateForPlayer","withTemplate","promptForTemplate","RollHelpers","situational","existingConfig","newConfig","requestData","rollConfig","additionalConfig","normalizedType","rollMode","DialogClass","messageConfig","dialogOptions","app","_f","_g","firstRoll","advantage","disadvantage","target","rollProcessConfig","isPublicRollsOn","messageRollMode","playerOwner","rollResults","dc","halfThreshold","sum","acc","average","highestModifier","leaderIndex","leaderActorId","leaderModifier","modifier","leaderResult","otherResults","adjustedResult","summaryKey","summaryData","lowestModifier","weakestActorId","weakestModifierValue","weakestResult","successWord","tool","resultMode","calculationResult","consolidatedRoll","requestedBy","u","sendRequest","isPC","isNPC","skipRollDialogOption","rollRequestsEnabled","ActivityManager","activity","dialog","requestsEnabled","rollInterceptionEnabled","isMidiOn","actorOwner","showConsumptionDialog","results","isOwnerActive","skipRollDialog","activityConfig","cacheKey","cacheEntry","HooksManager","shouldShowDialog","isMidiActive","hasTemplate","templateNotPlaced","isEmanation","activities","attackActivities","damageAttackActivities","damageActivities","saveActivities","itemSaveActivities","activityType","itemId","activityId","damageConfig","rollRequestConfig","formulas","part","MidiQOL","defaultOptions","SidebarController","html","chatControls","rollRequestIcon","firstChatControlIcon","RollRequestsMenu","enabled","CustomRollDialog","baseTitle","htmlElement","formulaInput","validationMessage","messageElement","die","currentFormula","diceRegex","diceMap","remainingFormula","count","dieType","newDieType","diceParts","formula","_ChatMessageManager","_h","_i","_j","_k","_l","requestedText","currentFlavor","speaker","baseActorId","checkIds","groupRollId","pendingData","actorEntries","storedGroupRollId","baseActor","storedInitConfig","rollData","globalHidden","messageHidden","isGM","flagData","challengeVisibility","showDC","el","diceTotals","text","messageId","actorElement","timeoutMs","button","targets","j","actorResult","diceBtn","dataset","RollHandlers","rollMethod","dcControl","dcInput","showToPlayers","groupFooterDetails","debounceTimer","handleDCChange","newDC","targetMessage","validEntries","flavor","supportsDC","showDCToPlayers","groupRollNPCHidden","abilityLabel","saveLabel","skillLabel","skillAbility","skillAbilityLabel","toolLabel","toolAbility","toolAbilityLabel","messageData","msg","m","resultIndex","speakerActorId","tokenActorId","rollBreakdown","groupResult","newContent","groupMessage","msgId","requestId","groupRollsMsgEnabled","fiveMinutesAgo","ChatMessageManager","defaultAbility","toolConfig","tokenActor","initiativeConfig","tempConfig","rollOptions","processConfig","confirmedFormula","updateResult","itemUpdateResult","ensureCombatForInitiative","filterActorsForInitiative","actorIds","game","actorsNamesWithInitiative","actorIdsWithInitiative","c","combatants","filteredIds","RollMenuActorUtil","system","stats","spellDC","hpPercent","hpColor","selectedActorIds","currentTab","RollInterceptor","hookName","hookId","areSkipKeysPressed","hookNames","isInitiativeRoll","moduleFlags","GMSkillToolConfigDialog","GMHitDieConfigDialog","GMAttackConfigDialog","GMDamageConfigDialog","GMRollConfigDialog","shouldSkipDialog","originalSubject","finalConfig","originalConfig","dialogResult","_m","_n","handlerMap","cleanConfig","defaultDialogResult","OfflinePlayerManager","onlinePlayerActors","offlinePlayerActors","actorMap","owners","onlineNonGMOwner","offlineActors","rollMethodName","potentialOwner","RollMenuOrchestrator","actorsData","menu","n","allActorEntries","allActors","online","offline","pc","allActorIds","allActorsForHitDie","useGroupId","currentRollKey","npcActorIds","npcActorEntries","actorsToRefill","actorsNeedingRefill","hitDieResult","baseActorError","requestType","selectedUniqueIds","rollOption","originalRollKey","RollMenuConfig","filteredActors","characterActors","actorsWithoutTokens","actorsWithTokens","entriesWithTokens","uniqueActorIds","filteredActorIds","filteredActorsData","suppressNotification","normalizedRollTypeKey","FlashRollsAPI","situationalBonus","sendAsRequest","normalizedRequestType","invalidActorIds","invalidIds","mockMenu","cleanedOptions","macroData","addMacrosToFolder","macroName","subItem","requestOptions","command","folderId","macroDocumentData","macro","folderName","folder","method","methodMap","normalizedMethod","enhancedRollResults","actorName","actorData","methodName","enhancedResultsWithLeader","enhancedResultsWithWeakest","GMRollConfigMixin","Base","abilityFromForm","dcFromForm","idx","dcValue","formConfig","sendRequestCheckbox","action","finalizedRolls","ability","configSection","templateData","template","wrapper","macroButton","rollClass","finalTitle","selectedAbilityLabel","skill","saveAbility","checkAbility","toolDefaultAbility","skillConfig","originalDialog","subjectItem","actorItem","storedActivityConfig","position","finalRollMode","configOverrides","confirmedSkipDialog","RollMenuDragManager","dragHandle","startX","startY","isDraggedFromBottomDock","menuRect","initialLeft","initialTop","handleRect","handleCenterOffset","dragData","handleMove","handleUp","deltaX","deltaY","remInPixels","snapInfo","moveHandler","upHandler","chatNotifications","lightningBolt","hotbar","hotbarRect","bottomDistance","menuLeft","menuRight","hotbarLeft","hotbarRight","boltRect","horizontalDistance","verticalDistance","currentTop","uiBottom","offsetValue","menuSize","ActorStatusManager","actorDoc","isFavorite","isBlocked","makeFavorite","makeBlocked","li","ActorDragUtil","menuContainer","dragImage","ActorDropUtil","dropZone","targetTab","jsonData","textData","_RollMenuEventManager","tabs","sheetIcon","targetIcon","actorImg","tooltip","tooltipCopy","showTooltip","existingTooltip","actorRect","isLeftEdge","imgRect","imgCenterX","hideTooltip","scrollContainer","searchInput","accordion","showOnHover","mouseEnterHandler","showOptionsListOnHover","mouseLeaveHandler","requestTypesContainer","parentItem","customEvent","macroBtn","requestHeader","requestItem","submenuTabs","statusEffects","statusElement","groupId","groupActors","openedGroups","groupData","member","totalRemoved","totalActors","effect","isTargeted","maxHP","wasAlreadySelected","newValue","isActuallySelected","wasSelected","actorGroups","tokenAssociations","playerOwnedCount","totalSelectedCount","playerOwnedRatio","actorType","defaultName","members","newActor","memberSummary","tokenUuids","RollMenuEventManager","RollMenuStatusManager","statusEffectId","statusEffect","successCount","totalCount","statusName","effectData","existingEffect","hasEffect","RollMenuStateManager","skip","selectAll","memberUniqueId","lockIcon","existing","buttonRect","menuLayout","tooltipRect","relativeTop","tooltipLeft","relativeLeft","tooltipTop","optionsToggleContainer","optionsElement","wrapperElement","checkbox","isSelected","hasSelection","hasPlayerCharacter","hitDieItem","selectAllCheckbox","selectedCount","currentActors","allMembers","groupActor","checkboxes","cb","savedFilters","tooltipContainer","filters","RollMenuActorProcessor","baseContext","groupEntries","actorFilters","filteredPCActors","filteredNPCActors","filteredGroupActors","groupToken","groupFilters","selectAllOn","requestTypes","showOnlyPCsWithToken","tokensInScene","actorForStats","hpData","hasAnyMemberTokens","hasActiveFilters","memberActorId","associatedTokenIds","actorToCheck","memberData","memberTokens","memberActor","selectedMembers","RollMenuExecutor","wasControlled","actualRollKey","hdData","_instance","_refreshDebounceTimer","_REFRESH_DEBOUNCE_DELAY","_RollRequestsMenu","filterTooltip","classes","preparedContext","frame","customPosition","zone","optionsToggle","controlled","previousSelection","changes","uid","controlledTokens","groupActorId","allMembersSelected","groupElement","selectedMembersCount","selectionState","searchTerm","requestName","subItems","hasVisibleSubItems","isVisible","categoryMatches","shouldShowCategory","nestedList","accordionToggle","statusEffectsContainer","statusItem","statusId","elementId","parentType","hook","property","immediate","_SettingsUtil","isDebugOn","setting","settingObj","settingMenus","menuData","menuObj","isRollInterceptionEnabled","foundryUiConfig","interfaceTheme","settingName","selectedSetting","requestsIcon","isCompactMode","menuIconsLayout","currentLayout","updated","validIds","existingIds","maxOrder","ActorDirectoryIconUtil","actorDirectory","flagChanges","existingIcon","RollHooksHandler","messageOptions","stored","storedConfig","existingWorkflowOptions","allSituationalBonuses","uniqueBonuses","bonus","trimmedBonus","_HooksManager","document","contextOptions","chatLog","menuElement","menuProxy","situationalInput","input","hasFlashRollsFlag","jQuerj","scene","ownershipChanged","statsChanged","effectsChanged","visibilityChanged","d","abilitySelect","selectedAbility","configAbility","changeEvent","throttleKey","targettingSetting","maxDisposition","tokensToTarget","oldColorScheme","newColorScheme","menuInstance","RollRequestManager","isMidiRequest","rollModeFromGM","defaultRollMode","handlerRequestData","Main"],"mappings":"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"}